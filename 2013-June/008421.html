<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [X2Go-Commits] x2goserver.git - release/4.0.1.x (branch) updated:	3.0.99-1
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/x2go-commits/2013-June/index.html" >
   <LINK REL="made" HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2Go-Commits%5D%20x2goserver.git%20-%20release/4.0.1.x%20%28branch%29%20updated%3A%0A%093.0.99-1&In-Reply-To=%3C20130606113420.AE58D5DB26%40ymir%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008408.html">
   <LINK REL="Next"  HREF="008400.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[X2Go-Commits] x2goserver.git - release/4.0.1.x (branch) updated:	3.0.99-1</H1>
    <B>X2Go dev team</B> 
    <A HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2Go-Commits%5D%20x2goserver.git%20-%20release/4.0.1.x%20%28branch%29%20updated%3A%0A%093.0.99-1&In-Reply-To=%3C20130606113420.AE58D5DB26%40ymir%3E"
       TITLE="[X2Go-Commits] x2goserver.git - release/4.0.1.x (branch) updated:	3.0.99-1">git-admin at x2go.org
       </A><BR>
    <I>Thu Jun  6 13:34:20 CEST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="008408.html">[X2Go-Commits] x2goserver.git - release/4.0.1.x (branch) updated:	3.0.99-2-2-g69ac55d
</A></li>
        <LI>Next message: <A HREF="008400.html">[X2Go-Commits] x2goserver.git - release/4.0.1.x (branch) updated:	3.0.99-2-3-g17f0a8f
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8421">[ date ]</a>
              <a href="thread.html#8421">[ thread ]</a>
              <a href="subject.html#8421">[ subject ]</a>
              <a href="author.html#8421">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch, release/4.0.1.x has been updated
       via  643997dc42f0d3c41b99393bd989d315febe6cd9 (commit)
      from  9d54d62536cb70a10e9f6705182688fc66c0f82b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
-----------------------------------------------------------------------

Summary of changes:
 INSTALL                          |   38 ---
 debian/docs =&gt; cd                |    0
 debian/changelog                 |    7 +
 debian/control                   |    2 +-
 debian/copyright                 |    6 +-
 debian/dirs                      |    2 +
 debian/{postinst.ex =&gt; postinst} |    3 +
 debian/{preinst =&gt; preinst.bc}   |   15 +-
 debian/rules                     |   23 +-
 sql                              |   10 +-
 x2gochangestatus                 |   11 +
 x2gocleansessions                |    4 +-
 x2gocreatebase.sh                |   42 ---
 x2gocreatesession                |   17 ++
 x2godbadmin                      |  472 ++++++++++++++++++++++++++++++++
 x2godbwrapper.pm                 |  553 ++++++++++++++++++++++++++++++++++++++
 x2gogetagent                     |    8 +
 x2gogetdisplays                  |    9 +
 x2gogetports                     |    9 +
 x2gogetservers                   |    8 +-
 x2goinsertport                   |   14 +
 x2goinsertsession                |   13 +
 x2golistsessions                 |   15 +-
 x2golistsessions_root            |    2 +-
 x2golistsessions_sql             |   21 +-
 x2gomountdirs                    |   10 +-
 x2gopgwrapper                    |   37 ---
 x2gopgwrapper_local              |  175 ------------
 x2gopgwrapper_net                |  183 -------------
 x2gopgwrapper_sqlite             |  201 --------------
 x2goresume                       |   11 +
 x2goresume-session               |    8 +-
 x2goruncommand                   |    2 +-
 x2goshowblocks                   |   13 +-
 x2gosqlite.sh                    |   54 ----
 x2gosqlitewrapper                |  321 ++++++++++++++++++++++
 x2gostartagent                   |   24 +-
 x2gosuspend-session              |    7 +-
 x2goterminate-session            |    4 +-
 x2goumount                       |    5 +-
 x2goumount_session               |   14 +-
 41 files changed, 1558 insertions(+), 815 deletions(-)
 delete mode 100644 INSTALL
 copy debian/docs =&gt; cd (100%)
 copy debian/{postinst.ex =&gt; postinst} (87%)
 mode change 100644 =&gt; 100755
 rename debian/{preinst =&gt; preinst.bc} (84%)
 create mode 100755 x2gochangestatus
 delete mode 100755 x2gocreatebase.sh
 create mode 100755 x2gocreatesession
 create mode 100755 x2godbadmin
 create mode 100644 x2godbwrapper.pm
 create mode 100755 x2gogetagent
 create mode 100755 x2gogetdisplays
 create mode 100755 x2gogetports
 create mode 100755 x2goinsertport
 create mode 100755 x2goinsertsession
 delete mode 100755 x2gopgwrapper
 delete mode 100755 x2gopgwrapper_local
 delete mode 100755 x2gopgwrapper_net
 delete mode 100755 x2gopgwrapper_sqlite
 create mode 100755 x2goresume
 delete mode 100755 x2gosqlite.sh
 create mode 100755 x2gosqlitewrapper

The diff of changes is:
diff --git a/INSTALL b/INSTALL
deleted file mode 100644
index 15df0dc..0000000
--- a/INSTALL
+++ /dev/null
@@ -1,38 +0,0 @@
-install sudo,fuse,sshfs
-
-use visudo and add string in sudoers:
-%users ALL=(ALL) NOPASSWD: /usr/bin/x2gopgwrapper
-
-if you  want to allow only users from group x2gousers use X2GO system, 
-#add group &quot;x2gousers&quot;
-and change in sudoers  %users to %x2gousers
-
-INSTALL server scripts:
-
-mkdir /etc/x2go
-cp sql /etc/x2go/
-copy x2go* in any directory in $PATH
-daemon x2gocleansessions - clean all finished sessions, enable it by system start
-
-IF YOU WANT TO USE LOCAL DATABASE:
-you need to install postgresql
-
-echo -n local &gt; /etc/x2go/sql
-
-use x2gocreatebase.sh to create database for x2go
-
-IF YOU WANT TO USE REMOTE DATABASE:
-echo -n &quot;sqlserver address&quot; &gt; /etc/x2go/sql
-
-you need to creata DSA key for ssh connection with database server
-mkdirhier /root/.x2go/ssh/.pg/
-ssh-keygen -t dsa -f /root/.x2go/ssh/.pg/id_dsa
-press &quot;Enter&quot; for empty passphrase
-
-copy public part &quot;/root/.x2go/ssh/.pg/id_dsa.pub&quot; on computer with running sql server
-(for example with scp)
-and add it to ~postgres/.ssh/authorized_keys
-cat id_dsa.pub &gt;&gt; ~postgres/.ssh/authorized_keys
-
-IF YOU WANT TO USE SQLITE
-echo -n sqlite &gt; /etc/x2go/sql
diff --git a/debian/docs b/cd
similarity index 100%
copy from debian/docs
copy to cd
diff --git a/debian/changelog b/debian/changelog
index 7e4db68..fdb9d32 100644
--- a/debian/changelog
+++ b/debian/changelog
@@ -1,3 +1,10 @@
+x2goserver (3.0.99-1) unstable; urgency=low
+
+  * not use sudo with postgresql, wrappers in perl instead of bash
+  * use unprivileged user x2gouser with sqlite
+
+ -- Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;  Tue, 25 Jan 2011 17:09:01 +0100
+
 x2goserver (3.0.1-9) unstable; urgency=low
 
   * changes in x2gomountdir to use with plasmoid
diff --git a/debian/control b/debian/control
index b0e9cce..db467de 100644
--- a/debian/control
+++ b/debian/control
@@ -7,7 +7,7 @@ Standards-Version: 3.7.2
 
 Package: x2goserver
 Architecture: all
-Depends: x2goagent, sudo, lsof, openssh-client, openssh-server, libconfig-simple-perl
+Depends: x2goagent, sudo, lsof, openssh-client, openssh-server, libconfig-simple-perl, makepasswd, libdbd-pg-perl, libdbd-sqlite3-perl
 Recommends: sshfs
 Description: x2goserver (daemon and tools)
  x2go is a serverbased computing environment with
diff --git a/debian/copyright b/debian/copyright
index 4a7fdf6..487b08b 100644
--- a/debian/copyright
+++ b/debian/copyright
@@ -5,7 +5,7 @@ It was downloaded from www.obviously-nice.de
 
 Upstream Author: Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
 
-Copyright (C) 2007  obviously nice - <A HREF="http://www.obviouslynice.de">http://www.obviouslynice.de</A>
+Copyright (C) 2007-2011  obviously nice - <A HREF="http://www.obviouslynice.de">http://www.obviouslynice.de</A>
 
 This program is free software; you can redistribute it and/or modify  
 it under the terms of the GNU General Public License as published by  
@@ -22,7 +22,7 @@ along with this program; if not, write to the
 Free Software Foundation, Inc.,                                       
 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.             
 
-Copyright (C) 2007  Oleksandr Shneyder
+Copyright (C) 2007-2011  Oleksandr Shneyder
 <A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>
 
 On Debian systems, the complete text of the GNU General
@@ -30,6 +30,6 @@ Public License can be found in `/usr/share/common-licenses/GPL'.
 
 
 
-The Debian packaging is (C) 2007, Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt; and
+The Debian packaging is (C) 2007-2011, Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt; and
 is licensed under the GPL, see above.
 
diff --git a/debian/dirs b/debian/dirs
index f2b2ebc..8d37723 100644
--- a/debian/dirs
+++ b/debian/dirs
@@ -1,5 +1,7 @@
 usr/bin
 usr/sbin
 etc/x2go
+etc/x2go/x2gosql
+etc/x2go/x2gosql/passwords
 usr/lib/x2go/script
 var/db/x2go
\ No newline at end of file
diff --git a/debian/postinst.ex b/debian/postinst
old mode 100644
new mode 100755
similarity index 87%
copy from debian/postinst.ex
copy to debian/postinst
index 5a6a780..67086e0
--- a/debian/postinst.ex
+++ b/debian/postinst
@@ -20,6 +20,9 @@ set -e
 
 case &quot;$1&quot; in
     configure)
+    chmod 700 /etc/x2go/x2gosql/passwords
+    touch /etc/x2go/x2gosql/passwords/pgadmin
+    chmod 600 /etc/x2go/x2gosql/passwords/pgadmin
     ;;
 
     abort-upgrade|abort-remove|abort-deconfigure)
diff --git a/debian/preinst b/debian/preinst.bc
similarity index 84%
rename from debian/preinst
rename to debian/preinst.bc
index 1f73c6b..054e1f1 100755
--- a/debian/preinst
+++ b/debian/preinst.bc
@@ -66,16 +66,13 @@ Press Enter to continue
          addgroup --system x2gousers
     fi
     
-    SUDOCONF=`cat /etc/sudoers | grep x2gopgwrapper | grep x2gousers`
-    if [ &quot;$SUDOCONF&quot; == &quot;&quot; ]
-    then
-          echo &quot;
-#### X2GO section
-%x2gousers ALL=(ALL) NOPASSWD: /usr/bin/x2gopgwrapper
-&quot; &gt;&gt; /etc/sudoers       
+    X2GOUSR=`getent passwd | grep x2gouser`
+    
+    if [ &quot;$X2GOUSR&quot; == &quot;&quot; ]
+    then 
+         useradd -r -d /var/db/x2go/ x2gouser
     fi
-
-    echo &quot;Attention: If you want to allow users to log into the x2go system, you'll need to add them to the \&quot;x2gousers\&quot; group&quot;
+    
     ;;
 
     abort-upgrade)
diff --git a/debian/rules b/debian/rules
index 983e78f..ac4ff98 100755
--- a/debian/rules
+++ b/debian/rules
@@ -54,20 +54,25 @@ install: build
 	dh_installdirs
 
 	# Add here commands to install the package into debian/x2goserver.
+	install  x2gochangestatus  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2gocmdexitmessage  $(CURDIR)/debian/x2goserver/usr/bin/
+	install  x2gocreatesession  $(CURDIR)/debian/x2goserver/usr/bin/
+	install  x2gogetagent  $(CURDIR)/debian/x2goserver/usr/bin/
+	install  x2gogetdisplays  $(CURDIR)/debian/x2goserver/usr/bin/
+	install  x2gogetports  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2gogetservers  $(CURDIR)/debian/x2goserver/usr/bin/
+	install  x2goinsertport  $(CURDIR)/debian/x2goserver/usr/bin/
+	install  x2goinsertsession  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2golistsessions  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2golistdesktops  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2golistsessions_root  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2golistsessions_sql  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2gomountdirs  $(CURDIR)/debian/x2goserver/usr/bin/
-	install  x2gopgwrapper  $(CURDIR)/debian/x2goserver/usr/bin/
-	install  x2gopgwrapper_local  $(CURDIR)/debian/x2goserver/usr/bin/
-	install  x2gopgwrapper_sqlite  $(CURDIR)/debian/x2goserver/usr/bin/
-	install  x2gopgwrapper_net  $(CURDIR)/debian/x2goserver/usr/bin/
+	install  x2goresume  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2goresume-session  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2goruncommand  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2goshowblocks  $(CURDIR)/debian/x2goserver/usr/bin/
+	install  x2gosqlitewrapper  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2gostartagent  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2gosuspend-session  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2gosuspend-agent  $(CURDIR)/debian/x2goserver/usr/bin/
@@ -76,11 +81,15 @@ install: build
 	install  x2goumount  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2goumount_session  $(CURDIR)/debian/x2goserver/usr/bin/
 	install  x2gosessionlimit  $(CURDIR)/debian/x2goserver/usr/bin/
-	cp  sql  $(CURDIR)/debian/x2goserver/etc/x2go/
+
+
+
+
+	cp  sql  $(CURDIR)/debian/x2goserver/etc/x2go/x2gosql/
 	cp  x2goserver.conf  $(CURDIR)/debian/x2goserver/etc/x2go/
+	cp x2godbwrapper.pm $(CURDIR)/debian/x2goserver/usr/lib/x2go/
 	install  x2gocleansessions  $(CURDIR)/debian/x2goserver/usr/sbin/
-	install  x2gocreatebase.sh  $(CURDIR)/debian/x2goserver/usr/lib/x2go/script
-	install  x2gosqlite.sh  $(CURDIR)/debian/x2goserver/usr/lib/x2go/script
+	install  x2godbadmin  $(CURDIR)/debian/x2goserver/usr/lib/x2go/script
 
 
 
diff --git a/sql b/sql
index c2c027f..dfbfca0 100644
--- a/sql
+++ b/sql
@@ -1 +1,9 @@
-local
\ No newline at end of file
+#postgres or sqlite
+backend=postgres
+
+[postgres]
+host=localhost
+port=5432
+#database admin (must have permissions to create databases and users)
+dbadmin=postgres
+
diff --git a/x2gochangestatus b/x2gochangestatus
new file mode 100755
index 0000000..f7ecfe9
--- /dev/null
+++ b/x2gochangestatus
@@ -0,0 +1,11 @@
+#!/usr/bin/perl
+use strict;
+
+
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+my $status=shift or die;
+my $sid=shift or die;
+
+db_changestatus($status, $sid);
diff --git a/x2gocleansessions b/x2gocleansessions
index 52ee57d..373326d 100755
--- a/x2gocleansessions
+++ b/x2gocleansessions
@@ -82,7 +82,7 @@ elsif ($pid == 0 )
      }       
      elsif(! check_pid (@sinfo[0]<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at sinfo</A>[1]<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at sinfo</A>[12]))
      {
-         system(&quot;su @sinfo[11] -c \&quot;sudo x2gopgwrapper changestatus 'F' @sinfo[1] \&quot; &gt; /dev/null&quot;);
+         system(&quot;su @sinfo[11] -c \&quot;x2gochangestatus 'F' @sinfo[1] \&quot; &gt; /dev/null&quot;);
 	 #print &quot;@sinfo[1], pid @sinfo[0] not exist, changing status from @sinfo[4] to F\n&quot;;
 	 #print &quot;(@sinfo[1])Unmounting all shares\n&quot;;	 
 	 system( &quot;su @sinfo[11] -c \&quot;export HOSTNAME &amp;&amp; x2goumount_session @sinfo[1]\&quot; 2&gt; /dev/null&quot;);
@@ -93,7 +93,7 @@ elsif ($pid == 0 )
        {
            if(!check_stat(@sinfo[1]<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at sinfo</A>[11]))
 	   {
-               system(&quot;su @sinfo[11] -c  \&quot;sudo x2gopgwrapper changestatus 'S' @sinfo[1] \&quot; &gt; /dev/null&quot;);
+               system(&quot;su @sinfo[11] -c  \&quot;x2gochangestatus 'S' @sinfo[1] \&quot; &gt; /dev/null&quot;);
 	       #print &quot;@sinfo[1], is suspended, changing status from @sinfo[4] to S\n&quot;;
 	       #print &quot;(@sinfo[1])Unmounting all shares\n&quot;;	        
 	       system( &quot;su @sinfo[11] -c \&quot;export HOSTNAME &amp;&amp; x2goumount_session @sinfo[1]\&quot; 2&gt; /dev/null&quot;);
diff --git a/x2gocreatebase.sh b/x2gocreatebase.sh
deleted file mode 100755
index 6bb025d..0000000
--- a/x2gocreatebase.sh
+++ /dev/null
@@ -1,42 +0,0 @@
-#!/bin/bash
-
-su postgres -c &quot;dropdb x2go_sessions&quot;
-su postgres -c &quot;createdb x2go_sessions&quot;
-su postgres -c &quot;echo \&quot;create table sessions(
-		session_id varchar(500) primary key, 
-                display integer not null, 
-		uname varchar(100) not null, 
-		server varchar(100) not null,
-		client inet,
-		status char(1) not null default 'R',
-		init_time timestamp not null default now(),
-		last_time timestamp not null default now(),
-		cookie char(33),
-		agent_pid int,
-		gr_port int,
-		sound_port int,
-		fs_port int,
-		unique(display)
-		)\&quot; | psql x2go_sessions&quot;
-
-su postgres -c &quot;echo \&quot;create table messages(mess_id varchar(20) primary key, message text)\&quot; | psql x2go_sessions&quot;
-
-su postgres -c &quot;echo \&quot;create table user_messages(
-                mess_id varchar(20) not null, 
-		uname varchar(100) not null
-		)\&quot; | psql x2go_sessions&quot;
-
-su postgres -c &quot;echo \&quot;create table used_ports(
-                server varchar(100) not null,
-		session_id varchar(500) references sessions on delete cascade, 
-		port integer primary key
-		)\&quot; | psql x2go_sessions&quot;
-
-su postgres -c &quot;echo \&quot;create table mounts(
-                session_id varchar(500) references sessions on delete restrict,
-		path varchar(512) not null, 
-		client inet not null, 
-		primary key(path,client)
-		)\&quot; | psql x2go_sessions&quot;
-
-
diff --git a/x2gocreatesession b/x2gocreatesession
new file mode 100755
index 0000000..7776e6e
--- /dev/null
+++ b/x2gocreatesession
@@ -0,0 +1,17 @@
+#!/usr/bin/perl
+use strict;
+
+
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+
+my $cookie=shift or die;
+my $pid=shift or die;
+my $client=shift or die;
+my $gr_port=shift or die;
+my $snd_port=shift or die;
+my $fs_port=shift or die;
+my $sid=shift or die;
+
+db_createsession($cookie,$pid,$client,$gr_port, $snd_port, $fs_port, $sid);
diff --git a/x2godbadmin b/x2godbadmin
new file mode 100755
index 0000000..6a93e05
--- /dev/null
+++ b/x2godbadmin
@@ -0,0 +1,472 @@
+#!/usr/bin/perl
+
+use strict;
+
+use Getopt::Long;
+use Config::Simple;   
+use DBI;                                                                                                                                       
+                                                       
+                                                                                                   
+sub show_usage()
+{
+      print &quot;X2Go SQL admin interface. Use it to create x2go database and insert or remove users or groups in x2go database\n&quot;.
+            &quot;Usage:\nx2godbadmin --createdb\n&quot;.
+            &quot;x2godbadmin --listusers\n&quot;.
+            &quot;x2godbadmin --adduser|rmuser &lt;UNIX user&gt;\n&quot;.
+            &quot;x2godbadmin --addgroup|rmgroup &lt;UNIX group&gt;\n&quot;;
+}
+
+my $help='';
+my $createdb='';
+my $adduser='';
+my $rmuser='';
+my $addgroup='';
+my $rmgroup='';
+my $listusers='';
+
+GetOptions('listusers' =&gt; \$listusers, 'createdb' =&gt; \$createdb, 'help' =&gt; \$help, 'adduser=s' =&gt; \$adduser, 
+           'addgroup=s' =&gt; \$addgroup, 'rmuser=s' =&gt; \$rmuser, 'rmgroup=s' =&gt; \$rmgroup);
+
+if ($help  || ! ( $createdb || $adduser || $rmuser || $addgroup || $rmgroup || $listusers))
+{
+      show_usage();
+      exit(0);
+}
+
+
+my $Config = new Config::Simple(syntax=&gt;'ini');
+$Config-&gt;read('/etc/x2go/x2gosql/sql' ) or die &quot;Can't read config file /etc/x2go/x2gosql/sql&quot;;
+if($Config-&gt;param(&quot;backend&quot;) eq 'sqlite')
+{
+      my $user=&quot;x2gouser&quot;;
+      my  ($name, $pass, $uid, $pgid, $quota, $comment, $gcos, $dir, $shell, $expire) = getpwnam($user);
+      my $dbfile=&quot;$dir/x2go_sessions&quot;;
+      
+      if(! $uid)
+      {	
+	print &quot;Can not find user ($user)\n&quot;;
+	exit(-1);
+      }
+
+    
+    
+    if($listusers|| $adduser||$addgroup||$rmuser||$rmgroup)
+    {
+      print &quot;Only \&quot;--createdb\&quot; option is available with sqlite backend\n&quot;;
+      exit(0);
+    }
+    if($createdb)
+    {
+	  if (! -d &quot;$dir&quot; )
+	  {
+		mkdir(&quot;$dir&quot;);
+	  }
+          if( -e $dbfile)
+	  {
+	    unlink($dbfile);
+	  }
+	  my $dbh=DBI-&gt;connect(
+	  &quot;dbi:SQLite:dbname=$dbfile&quot;,&quot;&quot;,&quot;&quot;,{AutoCommit =&gt; 1}) or die $_;
+
+	  my $sth=$dbh-&gt;prepare(&quot;create table sessions(
+				  session_id varchar(500) primary key,
+				  display integer not null,
+				  uname varchar(100) not null,
+				  server varchar(100) not null,
+				  client inet,
+				  status char(1) not null default 'R',
+				  init_time timestamp not null default CURRENT_TIMESTAMP,
+				  last_time timestamp not null default CURRENT_TIMESTAMP,
+				  cookie char(33),
+				  agent_pid int,
+				  gr_port int,
+				  sound_port int,
+				  fs_port int,
+				  unique(display))&quot;);
+          $sth-&gt;execute() or die;
+	  
+          my $sth=$dbh-&gt;prepare(&quot;create table messages(mess_id varchar(20) primary key, message text)&quot;);
+          $sth-&gt;execute() or die;
+	  
+          my $sth=$dbh-&gt;prepare(&quot;create table user_messages(
+                mess_id varchar(20) not null,
+                uname varchar(100) not null)&quot;);
+          $sth-&gt;execute() or die;
+	  
+          my $sth=$dbh-&gt;prepare(&quot;create table used_ports(
+                server varchar(100) not null,
+                session_id varchar(500) references sessions on delete cascade,
+                port integer primary key)&quot;);
+          $sth-&gt;execute() or die;
+	  
+          my $sth=$dbh-&gt;prepare(&quot;create table mounts(
+                session_id varchar(500) references sessions on delete restrict,
+                path varchar(512) not null,
+                client inet not null,
+                primary key(path,client))&quot;);
+          $sth-&gt;execute() or die;
+	  
+          my $sth=$dbh-&gt;prepare(&quot;CREATE TRIGGER fkd_mounts_session_id
+				  BEFORE DELETE ON sessions
+				  FOR EACH ROW BEGIN
+				    SELECT CASE
+				      WHEN ((SELECT session_id FROM mounts WHERE session_id = OLD.session_id) IS NOT NULL)
+				      THEN RAISE(ABORT, 'delete on table \&quot;sessions\&quot; violates foreign key on table \&quot;mounts\&quot;')
+				    END;
+				  END;&quot;);
+          $sth-&gt;execute() or die; 
+	  
+          my $sth=$dbh-&gt;prepare(&quot;CREATE TRIGGER fkd_ports_session_id
+				  BEFORE DELETE ON sessions
+				  FOR EACH ROW 
+                                    BEGIN
+				       DELETE  FROM used_ports WHERE session_id = OLD.session_id;
+				    END;
+				  END;&quot;);
+          $sth-&gt;execute() or die; 
+	  
+	  $sth-&gt;finish();	  
+	  $dbh-&gt;disconnect();
+	  chmod(0700,&quot;$dir&quot;);
+	  chown($uid,$pgid,&quot;$dir&quot;);
+	  chmod(0600,&quot;$dbfile&quot;);
+	  chown($uid,$pgid,&quot;$dbfile&quot;);
+
+	  exit(0);
+    }
+}
+
+    my $host=$Config-&gt;param(&quot;postgres.host&quot;);
+    my $port=$Config-&gt;param(&quot;postgres.port&quot;);
+    my $dbadmin=$Config-&gt;param(&quot;postgres.dbadmin&quot;);
+    my $x2goadmin=&quot;x2godbuser&quot;;
+    my $x2goadminpass=`makepasswd`;
+    chomp($x2goadminpass);
+    my $db=&quot;x2go_sessions&quot;;
+
+    if(!$host)
+    {
+      $host='localhost';
+    }
+    if(!$port)
+    {
+      $port='5432';
+    }
+    if(!$dbadmin)
+    {
+      $dbadmin='postgres';
+    }
+
+    open (FL,&quot;&lt; /etc/x2go/x2gosql/passwords/pgadmin &quot;) or die &quot;Can't read password file /etc/x2go/x2gosql/passwords/pgadmin&quot;;
+    my $dbadminpass=&lt;FL&gt;;
+    close(FL);
+    chomp($dbadminpass);
+
+    my $dbh;
+    if($createdb)
+    {
+	  $dbh=DBI-&gt;connect(&quot;dbi:Pg:;host=$host;port=$port;&quot;, &quot;$dbadmin&quot;, &quot;$dbadminpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	  create_database();
+	  $dbh-&gt;disconnect();
+	  $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbadmin&quot;, &quot;$dbadminpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	  create_tables();
+	  $dbh-&gt;disconnect();      
+	  exit(0);
+    }
+
+    if($listusers)
+    {
+	  $dbh=DBI-&gt;connect(&quot;dbi:Pg:;host=$host;port=$port;&quot;, &quot;$dbadmin&quot;, &quot;$dbadminpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	  list_users();
+	  $dbh-&gt;disconnect();
+	  exit(0);
+    }
+
+    $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbadmin&quot;, &quot;$dbadminpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+    if($adduser)
+    {
+	add_user($adduser);
+    }
+
+    if($addgroup)
+    {
+      my ($name, $passwd, $gid, $members)  = getgrnam( $addgroup); 
+      my @grp_members=split(' ',$members);
+      foreach (@grp_members)
+      {
+	chomp($_);
+	add_user($_);
+      }
+    }
+
+    if($rmuser)
+    {
+      rm_user($rmuser);
+    }
+
+    if($rmgroup)
+    {
+      my ($name, $passwd, $gid, $members)  = getgrnam( $rmgroup); 
+      my @grp_members=split(' ',$members);
+      foreach (@grp_members)
+      {
+	chomp($_);
+	rm_user($_);
+      }
+    }
+    $dbh-&gt;disconnect();      
+
+sub list_users()
+{
+      my $sth=$dbh-&gt;prepare(&quot;select rolname from pg_roles where rolname like 'x2gouser_%'&quot;);
+      $sth-&gt;execute()or die;
+      printf (&quot;%-20s DB user\n&quot;,&quot;UNIX user&quot;);
+      print &quot;---------------------------------------\n&quot;;
+      my @data;
+      while (@data = $sth-&gt;fetchrow_array) 
+      {
+	  @data[0]=~s/x2gouser_//;
+          printf (&quot;%-20s <A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">x2gouser_ at data</A>[0]\n&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at data</A>[0]);
+      }
+      $sth-&gt;finish();
+}
+
+sub rm_user()
+{
+      my $user=shift;
+      
+      print (&quot;rm DB user x2gouser_$user\n&quot;); 
+      
+      my $sth=$dbh-&gt;prepare(&quot;DROP OWNED BY x2gouser_$user&quot;);
+      $sth-&gt;execute();      
+      
+      my $sth=$dbh-&gt;prepare(&quot;drop USER if exists x2gouser_$user&quot;);
+      $sth-&gt;execute();
+      $sth-&gt;finish();
+
+      my ($name, $pass, $uid, $pgid, $quota, $comment, $gcos, $dir, $shell, $expire) = getpwnam($user);
+      if(! $uid)
+      {	
+	return;
+      }
+      if ( -e &quot;$dir/.x2go/sqlpass&quot; )
+      {
+	unlink(&quot;$dir/.x2go/sqlpass&quot;);
+      }
+}
+
+
+sub add_user()
+{
+      my $user=shift;
+      my ($name, $pass, $uid, $pgid, $quota, $comment, $gcos, $dir, $shell, $expire) = getpwnam($user);
+      if(! $uid)
+      {	
+	print &quot;Can not find user ($user)\n&quot;;
+	return;
+      }
+      $pass=`makepasswd`;
+      chomp($pass);
+      
+      my $sth=$dbh-&gt;prepare(&quot;DROP OWNED BY x2gouser_$user&quot;);
+      $sth-&gt;{Warn}=0;
+      $sth-&gt;{PrintError}=0;          
+      $sth-&gt;execute();      
+      
+      $sth=$dbh-&gt;prepare(&quot;drop USER if exists x2gouser_$user&quot;);
+      $sth-&gt;{Warn}=0;
+      $sth-&gt;{PrintError}=0;          
+      $sth-&gt;execute();
+
+      print (&quot;create DB user x2gouser_$user\n&quot;); 
+      $sth=$dbh-&gt;prepare(&quot;create USER x2gouser_$user WITH ENCRYPTED PASSWORD '$pass'&quot;);
+      $sth-&gt;execute();
+
+      $sth=$dbh-&gt;prepare(&quot;GRANT INSERT, UPDATE, DELETE ON sessions, used_ports, mounts TO x2gouser_$user&quot;);
+      $sth-&gt;execute();
+  
+      $sth=$dbh-&gt;prepare(&quot;GRANT SELECT, UPDATE, DELETE ON sessions_view, mounts_view, servers_view, ports_view TO x2gouser_$user&quot;);
+      $sth-&gt;execute();
+      $sth-&gt;finish();
+
+      if (! -d &quot;$dir/.x2go&quot; )
+      {
+	mkdir(&quot;$dir/.x2go&quot;);
+      }
+      #save user password
+      open (FL,&quot;&gt; $dir/.x2go/sqlpass&quot;) or die &quot;Can't open password file $dir/.x2go/sqlpass&quot;;
+      print FL $pass;
+      close(FL);
+      chmod(0700,&quot;$dir/.x2go&quot;);
+      chown($uid,$pgid,&quot;$dir/.x2go&quot;);
+      chmod(0600,&quot;$dir/.x2go/sqlpass&quot;);
+      chown($uid,$pgid,&quot;$dir/.x2go/sqlpass&quot;);
+}
+
+sub create_tables()
+{
+          my $sth=$dbh-&gt;prepare(&quot;
+                create table sessions(
+                session_id text primary key,
+                display integer not null,
+                uname text not null,
+                server text not null,
+                client inet,
+                status char(1) not null default 'R',
+                init_time timestamp not null default now(),
+                last_time timestamp not null default now(),
+                cookie char(33),
+                agent_pid int,
+                gr_port int,
+                sound_port int,
+                fs_port int,
+                creator_id text NOT NULL default current_user,
+                unique(display))
+                &quot;);
+          $sth-&gt;execute() or die;
+	  
+	  $sth=$dbh-&gt;prepare(&quot;
+                create VIEW sessions_view as 
+                SELECT 
+                agent_pid, session_id, display, server, status, init_time, cookie, client, gr_port,
+				     sound_port, last_time, uname, fs_port from  sessions 
+				     where creator_id = current_user&quot;);
+          $sth-&gt;execute() or die;
+	  
+	  $sth=$dbh-&gt;prepare(&quot;
+                create VIEW servers_view as 
+                SELECT 
+                server, display, status from  sessions&quot;);
+          $sth-&gt;execute() or die;
+	  
+	  
+          
+          $sth=$dbh-&gt;prepare(&quot;create or replace RULE update_sess_priv AS ON UPDATE
+                TO sessions where (OLD.creator_id &lt;&gt; current_user or OLD.creator_id &lt;&gt; NEW.creator_id) and current_user &lt;&gt; '$x2goadmin'
+                DO INSTEAD NOTHING&quot;);
+          $sth-&gt;execute() or die;
+          
+          $sth=$dbh-&gt;prepare(&quot;create or replace RULE insert_sess_priv AS ON INSERT
+                TO sessions where NEW.creator_id &lt;&gt; current_user and current_user &lt;&gt; '$x2goadmin'
+                DO INSTEAD NOTHING&quot;);
+          $sth-&gt;execute() or die;
+	  
+          $sth=$dbh-&gt;prepare(&quot;create or replace RULE delete_sess_priv AS ON DELETE
+                TO sessions where OLD.creator_id &lt;&gt; current_user and current_user &lt;&gt; '$x2goadmin'
+                DO INSTEAD NOTHING&quot;);
+          $sth-&gt;execute() or die;
+	  
+          $sth=$dbh-&gt;prepare(&quot;create or replace RULE update_sess_view AS ON UPDATE
+                TO sessions_view DO INSTEAD 
+                update sessions set 
+                status=NEW.status,
+		last_time=NEW.last_time,
+		cookie=NEW.cookie,
+		agent_pid=NEW.agent_pid,
+		client=NEW.client,
+		gr_port=NEW.gr_port,
+		sound_port=NEW.sound_port,
+		fs_port=NEW.fs_port
+	        where session_id=OLD.session_id and creator_id=current_user&quot;);
+          $sth-&gt;execute() or die;	  
+
+          $sth=$dbh-&gt;prepare(&quot;create table messages(mess_id varchar(20) primary key, message text)&quot;);
+          $sth-&gt;execute() or die;
+
+          $sth=$dbh-&gt;prepare(&quot;create table user_messages(
+                mess_id text not null,
+                uname text not null)&quot;);
+          $sth-&gt;execute() or die;
+
+          $sth=$dbh-&gt;prepare(&quot;create table used_ports(
+                server text not null,
+                session_id text references sessions on delete cascade,
+                creator_id text NOT NULL default current_user,
+                port integer primary key)&quot;);
+          $sth-&gt;execute() or die;
+	  
+	  $sth=$dbh-&gt;prepare(&quot;
+                create VIEW ports_view as 
+                SELECT 
+                server, port from used_ports&quot;);
+          $sth-&gt;execute() or die;
+	  
+
+          $sth=$dbh-&gt;prepare(&quot;create or replace RULE insert_port_priv AS ON INSERT
+                TO used_ports where NEW.creator_id &lt;&gt; current_user and current_user &lt;&gt; '$x2goadmin'
+                DO INSTEAD NOTHING&quot;);
+          $sth-&gt;execute() or die;
+
+          $sth=$dbh-&gt;prepare(&quot;create or replace RULE update_port_priv AS ON UPDATE
+                TO used_ports where (NEW.creator_id &lt;&gt; current_user or OLD.creator_id &lt;&gt; current_user) and current_user &lt;&gt; '$x2goadmin'
+                DO INSTEAD NOTHING&quot;);
+          $sth-&gt;execute() or die;
+
+          $sth=$dbh-&gt;prepare(&quot;create or replace RULE delete_port_priv AS ON DELETE
+                TO used_ports where OLD.creator_id &lt;&gt; current_user and current_user &lt;&gt; '$x2goadmin'
+                DO INSTEAD NOTHING &quot;);
+          $sth-&gt;execute() or die;
+
+          $sth=$dbh-&gt;prepare(&quot;create table mounts(
+                session_id text references sessions on delete restrict,
+                path text not null,
+                client inet not null,
+                creator_id text NOT NULL default current_user,
+                primary key(path,client))&quot;);
+          $sth-&gt;execute() or die;
+
+	  
+  	  $sth=$dbh-&gt;prepare(&quot;
+                create VIEW mounts_view as 
+                SELECT 
+                client,path, session_id from mounts
+				     where creator_id = current_user&quot;);
+          $sth-&gt;execute() or die;
+	  
+          $sth=$dbh-&gt;prepare(&quot;create or replace RULE delete_mounts_view AS ON DELETE
+                TO mounts_view DO INSTEAD 
+                delete from mounts
+	        where session_id=OLD.session_id and creator_id=current_user and path=OLD.path&quot;);
+          $sth-&gt;execute() or die;	  
+	  	  
+	  
+          $sth=$dbh-&gt;prepare(&quot;create or replace RULE insert_mount_priv AS ON INSERT
+                TO mounts where NEW.creator_id &lt;&gt; current_user and current_user &lt;&gt; '$x2goadmin'
+                DO INSTEAD NOTHING&quot;);
+          $sth-&gt;execute() or die;
+
+          $sth=$dbh-&gt;prepare(&quot; create or replace RULE update_mount_priv AS ON UPDATE
+                TO mounts where (NEW.creator_id &lt;&gt; current_user or OLD.creator_id &lt;&gt; current_user) and current_user &lt;&gt; '$x2goadmin'
+                DO INSTEAD NOTHING&quot;);
+          $sth-&gt;execute() or die;
+
+          $sth=$dbh-&gt;prepare(&quot; create or replace RULE delete_mount_priv AS ON DELETE
+                TO mounts where OLD.creator_id &lt;&gt; current_user and current_user &lt;&gt; '$x2goadmin'
+                DO INSTEAD NOTHING&quot;);
+          $sth-&gt;execute() or die;
+
+          $sth=$dbh-&gt;prepare(&quot;GRANT ALL PRIVILEGES ON sessions, messages, user_messages, used_ports, mounts TO $x2goadmin&quot;);
+          $sth-&gt;execute() or die;
+	  $sth-&gt;finish();
+}
+
+sub create_database
+{
+         #drop db if exists
+         my $sth=$dbh-&gt;prepare(&quot;drop database if exists x2go_sessions&quot;);
+         $sth-&gt;execute();
+         #drop x2goadmin
+         $sth=$dbh-&gt;prepare(&quot;drop user if exists $x2goadmin&quot;);
+         $sth-&gt;execute();
+         #create db
+         $sth=$dbh-&gt;prepare(&quot;create database $db&quot;);
+         $sth-&gt;execute() or die;
+         #create x2goadmin
+         $sth=$dbh-&gt;prepare(&quot;create USER $x2goadmin WITH ENCRYPTED PASSWORD '$x2goadminpass'&quot;);
+         $sth-&gt;execute() or die;
+         #save x2goadmin password
+         open (FL,&quot;&gt; /etc/x2go/x2gosql/passwords/x2goadmin &quot;) or die &quot;Can't write password file /etc/x2go/x2gosql/passwords/x2goadmin&quot;;
+         print FL $x2goadminpass;
+         close(FL);       
+	 $sth-&gt;finish();
+}
\ No newline at end of file
diff --git a/x2godbwrapper.pm b/x2godbwrapper.pm
new file mode 100644
index 0000000..3d78b4b
--- /dev/null
+++ b/x2godbwrapper.pm
@@ -0,0 +1,553 @@
+package x2godbwrapper;
+
+use strict;
+use Config::Simple;   
+use DBI;   
+
+use POSIX;
+
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+my ($uname, $pass, $uid, $pgid, $quota, $comment, $gcos, $homedir, $shell, $expire) = getpwuid(getuid());
+
+my $Config = new Config::Simple(syntax=&gt;'ini');
+$Config-&gt;read('/etc/x2go/x2gosql/sql' ) or die &quot;Can't read config file /etc/x2go/x2gosql/sql&quot;;
+my $backend=$Config-&gt;param(&quot;backend&quot;);
+
+my $host;
+my $port;
+my $db=&quot;x2go_sessions&quot;;
+my $dbpass;
+my $dbuser;
+
+
+if($backend ne 'postgres' &amp;&amp; $backend ne 'sqlite')
+{
+  die &quot;unknown backend $backend&quot;;
+}
+
+if($backend eq 'postgres')
+{
+  $host=$Config-&gt;param(&quot;postgres.host&quot;);
+  $port=$Config-&gt;param(&quot;postgres.port&quot;);
+  if(!$host)
+  {
+    $host='localhost';
+  }
+  if(!$port)
+  {
+    $port='5432';
+  }
+  my $passfile;
+  if($uname eq 'root')
+  {
+    $dbuser='x2godbuser';
+    $passfile=&quot;/etc/x2go/x2gosql/passwords/x2goadmin&quot;;
+  }
+  else
+  {
+    $dbuser=&quot;x2gouser_$uname&quot;;
+    $passfile=&quot;$homedir/.x2go/sqlpass&quot;;
+  }
+
+  open (FL,&quot;&lt; $passfile&quot;) or die &quot;Can't read password file $passfile&lt;br&gt;&lt;b&gt;Use x2godbadmin on server to configure database access for user $uname&lt;/b&gt;&lt;br&gt;&quot;;
+  $dbpass=&lt;FL&gt;;
+  close(FL);
+  chomp($dbpass);
+}
+
+use base 'Exporter';
+
+our @EXPORT=('db_listsessions','db_listsessions_all', 'db_getservers', 'db_getagent', 'db_resume', 'db_changestatus', 
+	     'db_getdisplays', 'db_insertsession', 'db_getports', 'db_insertport', 'db_createsession', 'db_insertmount', 
+	     'db_getmounts', 'db_deletemount', 'db_getdisplay', 'dbsys_getmounts', 'dbsys_listsessionsroot', 
+	     'dbsys_listsessionsroot_all', 'dbsys_rmsessionsroot');
+
+	     
+	     
+	     
+ 
+sub dbsys_rmsessionsroot
+{
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       if($backend eq 'postgres')
+       {
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	       
+	       my $sth=$dbh-&gt;prepare(&quot;delete from sessions  where session_id='$sid'&quot;);
+               $sth-&gt;execute()or die;
+       }
+       if($backend eq 'sqlite')
+       {
+	   `sudo -u x2gouser x2gosqlitewrapper rmsessionsroot $sid`;
+       }
+}
+
+sub dbsys_listsessionsroot
+{
+       my $server=shift or die &quot;argument \&quot;server\&quot; missed&quot;;
+       if($backend eq 'postgres')
+       {
+       my @strings;
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	       
+	       my $sth=$dbh-&gt;prepare(&quot;select agent_pid, session_id, display, server, status,
+				     to_char(init_time,'DD.MM.YY*HH24:MI:SS'),cookie,client,gr_port,
+				     sound_port,to_char(last_time,'DD.MM.YY*HH24:MI:SS'),uname,
+				     to_char(now()-init_time,'SSSS'),fs_port  from  sessions
+				     where server='$server'  order by status desc&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]=join('|'<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at data</A>);
+               }
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       return @strings;
+       }
+       if($backend eq 'sqlite')
+       {
+	   return split(&quot;\n&quot;,`sudo -u x2gouser x2gosqlitewrapper listsessionsroot $server`);
+       }
+}
+
+sub dbsys_listsessionsroot_all
+{
+       if($backend eq 'postgres')
+       {
+       my @strings;
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	       
+	       my $sth=$dbh-&gt;prepare(&quot;select agent_pid, session_id, display, server, status,
+				     to_char(init_time,'DD.MM.YY*HH24:MI:SS'),cookie,client,gr_port,
+				     sound_port,to_char(last_time,'DD.MM.YY*HH24:MI:SS'),uname,
+				     to_char(now()-init_time,'SSSS'),fs_port  from  sessions
+				     order by status desc&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]=join('|'<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at data</A>);
+               }
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       return @strings;
+       }
+       if($backend eq 'sqlite')
+       {
+	   return split(&quot;\n&quot;,`sudo -u x2gouser x2gosqlitewrapper listsessionsroot_all`);
+       }
+}
+
+	     
+sub dbsys_getmounts
+{
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       if($backend eq 'postgres')
+       {
+       my @strings;
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	       my $sth=$dbh-&gt;prepare(&quot;select client, path from mounts where session_id='$sid'&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]=join(&quot;|&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at data</A>);
+               }
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       return @strings;
+       }
+       if($backend eq 'sqlite')
+       {
+	   return split(&quot;\n&quot;,`sudo -u x2gouser x2gosqlitewrapper getmounts $sid`);
+       }
+
+}
+
+sub db_getmounts
+{
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       if($backend eq 'postgres')
+       {
+       my @strings;
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	       my $sth=$dbh-&gt;prepare(&quot;select client, path from mounts_view where session_id='$sid'&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]=join(&quot;|&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at data</A>);
+               }
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       return @strings;
+       }
+       if($backend eq 'sqlite')
+       {
+	   return split(&quot;\n&quot;,`sudo -u x2gouser x2gosqlitewrapper getmounts $sid`);
+       }
+}
+	     
+sub db_deletemount
+{
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       my $path=shift or die &quot;argument \&quot;path\&quot; missed&quot;;
+       if($backend eq 'postgres')
+       {
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;	       
+	       my $sth=$dbh-&gt;prepare(&quot;delete from mounts_view where session_id='$sid' and path='$path'&quot;);
+               $sth-&gt;execute();
+               $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       }
+       if($backend eq 'sqlite')
+       {
+	   `sudo -u x2gouser x2gosqlitewrapper deletemount $sid \&quot;$path\&quot;`;
+       }
+
+}
+
+sub db_insertmount
+{
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       my $path=shift or die &quot;argument \&quot;path\&quot; missed&quot;;
+       my $client=shift or die &quot;argument \&quot;client\&quot; missed&quot;;
+       my $res_ok=1;
+       if($backend eq 'postgres')
+       {
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;	       
+	       my $sth=$dbh-&gt;prepare(&quot;insert into mounts (session_id,path,client) values  ('$sid','$path','$client')&quot;);
+               $sth-&gt;execute();
+	       if(!$sth-&gt;err())
+	       {
+		 $res_ok=1;
+	       }
+               $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       }
+       if($backend eq 'sqlite')
+       {
+	   if( `sudo -u x2gouser x2gosqlitewrapper insertmount $sid \&quot;$path\&quot; $client` eq &quot;ok&quot;)
+	   {
+	     $res_ok=1;
+	   }
+       }
+       return $res_ok;
+}
+
+	     
+sub db_insertsession
+{
+	my $display=shift or die &quot;argument \&quot;display\&quot; missed&quot;;
+	my $server=shift or die &quot;argument \&quot;server\&quot; missed&quot;;
+        my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       if($backend eq 'postgres')
+       {
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;	       
+	       my $sth=$dbh-&gt;prepare(&quot;insert into sessions (display,server,uname,session_id) values ('$display','$server','$uname','$sid')&quot;);
+               $sth-&gt;execute()or die $_;
+               $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       }
+       if($backend eq 'sqlite')
+       {
+	   my $err=`sudo -u x2gouser x2gosqlitewrapper insertsession $display $server $sid`;
+	   if($err ne &quot;ok&quot;)
+	   {
+	     die &quot;$err: x2gosqlitewrapper insertsession $display $server $sid&quot;;
+	   }
+       }
+
+}
+
+sub db_createsession
+{
+       my $cookie=shift or die&quot;argument \&quot;cookie\&quot; missed&quot;;
+       my $pid=shift or die&quot;argument \&quot;pid\&quot; missed&quot;;
+       my $client=shift or die&quot;argument \&quot;client\&quot; missed&quot;;
+       my $gr_port=shift or die&quot;argument \&quot;gr_port\&quot; missed&quot;;
+       my $snd_port=shift or die&quot;argument \&quot;snd_port\&quot; missed&quot;;
+       my $fs_port=shift or die&quot;argument \&quot;fs_port\&quot; missed&quot;;
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       if($backend eq 'postgres')
+       {
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;	       
+	       my $sth=$dbh-&gt;prepare(&quot;update sessions_view set status='R',last_time=now(),
+				     cookie='$cookie',agent_pid='$pid',client='$client',gr_port='$gr_port',
+				     sound_port='$snd_port',fs_port='$fs_port' where session_id='$sid'&quot;);
+               $sth-&gt;execute()or die;
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       }
+       if($backend eq 'sqlite')
+       {
+	   my $err= `sudo -u x2gouser x2gosqlitewrapper createsession $cookie $pid $client $gr_port $snd_port $fs_port $sid`;
+	   if($err ne &quot;ok&quot;)
+	   {
+	     die $err;
+	   }
+       }
+
+}
+
+sub db_insertport
+{
+	my $server=shift or die &quot;argument \&quot;server\&quot; missed&quot;;
+	my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+	my $sshport=shift or die &quot;argument \&quot;port\&quot; missed&quot;;
+       if($backend eq 'postgres')
+       {
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;	       
+	       my $sth=$dbh-&gt;prepare(&quot;insert into used_ports (server,session_id,port) values  ('$server','$sid','$sshport')&quot;);
+               $sth-&gt;execute()or die;
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       }
+       if($backend eq 'sqlite')
+       {
+	   `sudo -u x2gouser x2gosqlitewrapper insertport $server $sid $sshport`;
+       }
+
+}
+
+	     
+sub db_resume
+{
+       my $client=shift or die &quot;argument \&quot;client\&quot; missed&quot;;
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;       
+       if($backend eq 'postgres')
+       {
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;	       
+	       my $sth=$dbh-&gt;prepare(&quot;update sessions_view set last_time=now(),status='R',client='$client' where session_id = '$sid'&quot;);
+               $sth-&gt;execute()or die;
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       }
+       if($backend eq 'sqlite')
+       {
+	   `sudo -u x2gouser x2gosqlitewrapper resume $client $sid`;
+       }
+
+}
+
+sub db_changestatus
+{
+       my $status=shift or die &quot;argument \&quot;status\&quot; missed&quot;;
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;       
+       if($backend eq 'postgres')
+       {
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;	       
+	       my $sth=$dbh-&gt;prepare(&quot;update sessions_view set last_time=now(),status='$status' where session_id = '$sid'&quot;);
+               $sth-&gt;execute()or die;
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       }
+       if($backend eq 'sqlite')
+       {
+	   `sudo -u x2gouser x2gosqlitewrapper changestatus $status $sid`;
+       }
+
+}
+
+sub db_getdisplays
+{
+       #ignore $server
+       my $server=shift or die &quot;argument \&quot;server\&quot; missed&quot;;         
+       if($backend eq 'postgres')
+       {
+       my @strings;
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	       my $sth=$dbh-&gt;prepare(&quot;select display from servers_view&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]='|'<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">. at data</A>[0].'|';
+               }
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       return @strings;
+       }
+       if($backend eq 'sqlite')
+       {
+	   return split(&quot;\n&quot;,`sudo -u x2gouser x2gosqlitewrapper getdisplays $server`);
+       }
+
+}
+
+sub db_getports
+{
+       #ignore $server
+       my $server=shift or die &quot;argument \&quot;server\&quot; missed&quot;;         
+       if($backend eq 'postgres')
+       {
+       my @strings;
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	       my $sth=$dbh-&gt;prepare(&quot;select port from ports_view&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]='|'<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">. at data</A>[0].'|';
+               }
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       return @strings;
+       }
+       if($backend eq 'sqlite')
+       {
+	   return split(&quot;\n&quot;,`sudo -u x2gouser x2gosqlitewrapper getports $server`);
+       }
+
+}
+
+sub db_getservers
+{
+       if($backend eq 'postgres')
+       {
+       my @strings;
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	       
+	       my $sth=$dbh-&gt;prepare(&quot;select server,count(*) from servers_view where status != 'F' group by server&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]=@data[0];
+               }
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       return @strings;
+       }
+              if($backend eq 'sqlite')
+       {
+	   return split(&quot;\n&quot;,`sudo -u x2gouser x2gosqlitewrapper getservers`);
+       }
+
+}
+
+sub db_getagent
+{
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       my $agent;
+       if($backend eq 'postgres')
+       {
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	       
+	       my $sth=$dbh-&gt;prepare(&quot;select agent_pid from sessions_view
+				      where session_id ='$sid'&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               if(@data = $sth-&gt;fetchrow_array) 
+               {
+		   $agent=@data[0];
+               }
+               $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       }
+       if($backend eq 'sqlite')
+       {
+	   $agent=`sudo -u x2gouser x2gosqlitewrapper getagent $sid`;
+       }
+       return $agent;
+}
+
+sub db_getdisplay
+{
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       my $display;
+       if($backend eq 'postgres')
+       {
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	       
+	       my $sth=$dbh-&gt;prepare(&quot;select display from sessions_view
+				      where session_id ='$sid'&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               if(@data = $sth-&gt;fetchrow_array) 
+               {
+		   $display=@data[0];
+               }
+               $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+       }
+       if($backend eq 'sqlite')
+       {
+	   $display=`sudo -u x2gouser x2gosqlitewrapper getdisplay $sid`;
+       }
+       return $display;
+}
+sub db_listsessions
+{
+       my $server=shift or die &quot;argument \&quot;server\&quot; missed&quot;;
+       if($backend eq 'postgres')
+       {
+	       my @strings;
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	       
+	       my $sth=$dbh-&gt;prepare(&quot;select agent_pid, session_id, display, server, status,
+				     to_char(init_time,'DD.MM.YY*HH24:MI:SS'), cookie, client, gr_port,
+				     sound_port, to_char( last_time, 'DD.MM.YY*HH24:MI:SS'), uname,
+				     to_char(now()- init_time,'SSSS'), fs_port from  sessions_view
+				      where status !='F' and server='$server' and  
+				      (  session_id not like '%XSHAD%') order by status desc&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]=join('|'<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at data</A>);
+               }
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+               return @strings;
+       }
+       if($backend eq 'sqlite')
+       {
+	   return split(&quot;\n&quot;,`sudo -u x2gouser x2gosqlitewrapper listsessions $server`);
+       }
+
+}
+
+sub db_listsessions_all
+{
+       if($backend eq 'postgres')
+       {
+	       my @strings;
+	       my $dbh=DBI-&gt;connect(&quot;dbi:Pg:dbname=$db;host=$host;port=$port;&quot;, &quot;$dbuser&quot;, &quot;$dbpass&quot;,{AutoCommit =&gt; 1}) or die $_;
+	       
+	       my $sth=$dbh-&gt;prepare(&quot;select agent_pid, session_id, display, server, status,
+				     to_char(init_time,'DD.MM.YY*HH24:MI:SS'), cookie, client, gr_port,
+				     sound_port, to_char( last_time, 'DD.MM.YY*HH24:MI:SS'), uname,
+				     to_char(now()- init_time,'SSSS'), fs_port from  sessions_view
+				      where status !='F'  and  
+				      (  session_id not like '%XSHAD%') order by status desc&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]=join('|'<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at data</A>);
+               }
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+	       return @strings;
+       }
+       if($backend eq 'sqlite')
+       {
+	   return split(&quot;\n&quot;,`sudo -u x2gouser x2gosqlitewrapper listsessions_all`);
+       }
+
+}
diff --git a/x2gogetagent b/x2gogetagent
new file mode 100755
index 0000000..cf0b265
--- /dev/null
+++ b/x2gogetagent
@@ -0,0 +1,8 @@
+#!/usr/bin/perl
+use strict;
+
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+my $sid=shift or die;
+print db_getagent $sid;
diff --git a/x2gogetdisplays b/x2gogetdisplays
new file mode 100755
index 0000000..3e153e7
--- /dev/null
+++ b/x2gogetdisplays
@@ -0,0 +1,9 @@
+#!/usr/bin/perl
+use strict;
+
+
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+my $host=shift or die;
+print join(&quot;\n&quot;, db_getdisplays($host));
diff --git a/x2gogetports b/x2gogetports
new file mode 100755
index 0000000..0a1ec60
--- /dev/null
+++ b/x2gogetports
@@ -0,0 +1,9 @@
+#!/usr/bin/perl
+use strict;
+
+
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+my $host=shift or die;
+print join(&quot;\n&quot;, db_getports($host));
diff --git a/x2gogetservers b/x2gogetservers
index 02bf621..f81ed27 100755
--- a/x2gogetservers
+++ b/x2gogetservers
@@ -1,6 +1,8 @@
 #!/usr/bin/perl
 use strict;
 
-my $outp=`sudo x2gopgwrapper getservers`;
-$outp=~s/\|//g;
-print &quot;$outp&quot;;
+
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+print join(&quot;\n&quot;, db_getservers);
diff --git a/x2goinsertport b/x2goinsertport
new file mode 100755
index 0000000..128ac5e
--- /dev/null
+++ b/x2goinsertport
@@ -0,0 +1,14 @@
+#!/usr/bin/perl
+use strict;
+
+
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+my $server=shift or die;
+my $sid=shift or die;
+my $port=shift or die;
+
+db_insertport($server,$sid,$port);
+print &quot;inserted&quot;;
+
diff --git a/x2goinsertsession b/x2goinsertsession
new file mode 100755
index 0000000..fc616d5
--- /dev/null
+++ b/x2goinsertsession
@@ -0,0 +1,13 @@
+#!/usr/bin/perl
+use strict;
+
+
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+my $display=shift or die;
+my $server=shift or die;
+my $sid=shift or die;
+
+db_insertsession($display, $server, $sid);
+print &quot;inserted&quot;;
diff --git a/x2golistsessions b/x2golistsessions
index 7d53683..88fc44e 100755
--- a/x2golistsessions
+++ b/x2golistsessions
@@ -3,6 +3,10 @@ use Sys::Hostname;
 use strict;
 
 
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+
 sub check_stat
 {
    my $sess=shift;
@@ -20,18 +24,17 @@ if( ! $serv)
 {
    $serv=hostname;
 }
-my $uname=$ENV{'USER'};
-my $outp;
+
+my @outp;
 if($serv eq &quot;--all-servers&quot;)
 {
- $outp=`sudo x2gopgwrapper listsessions_all`;
+ @outp=db_listsessions_all();
 }
 else
 {
- $outp=`sudo x2gopgwrapper listsessions $serv`;
+ @outp=db_listsessions($serv);
 }
 
-my @outp=split(&quot;\n&quot;,&quot;$outp&quot;);
 for(my $i=0;$i&lt;@outp;$i++)
 {
      @outp[$i] =~ s/ //g;
@@ -47,7 +50,7 @@ for(my $i=0;$i&lt;@outp;$i++)
        {
            if(!check_stat(@sinfo[1]))
 	   {
-               system(&quot;sudo x2gopgwrapper changestatus 'S' @sinfo[1] &gt; /dev/null&quot;);
+               db_changestatus( 'S', @sinfo[1] );
 	       @outp[$i] =~ s/\|R\|/\|S\|/;
                system( &quot;x2goumount_session @sinfo[1]&quot;);
 
diff --git a/x2golistsessions_root b/x2golistsessions_root
index efb71f3..c74cbfd 100755
--- a/x2golistsessions_root
+++ b/x2golistsessions_root
@@ -43,7 +43,7 @@ for(my $i=0;$i&lt;@outp;$i++)
        {
            if(!check_stat(@sinfo[1]<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at sinfo</A>[11]))
 	   {
-               system(&quot;su - @sinfo[11] -c \&quot;sudo x2gopgwrapper changestatus 'S' @sinfo[1]\&quot; &gt; /dev/null&quot;);
+               system(&quot;su - @sinfo[11] -c \&quot;x2gochangestatus 'S' @sinfo[1]\&quot; &gt; /dev/null&quot;);
                @outp[$i] =~ s/\|R\|/\|S\|/;
            }
        }       
diff --git a/x2golistsessions_sql b/x2golistsessions_sql
index aa44679..071fac8 100755
--- a/x2golistsessions_sql
+++ b/x2golistsessions_sql
@@ -1,27 +1,30 @@
 #!/usr/bin/perl
 use strict;
+
+
+
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+
+
 my $serv=shift;
-my $outp;
+my @array;
 if($serv eq &quot;--all-servers&quot;)
 {
- $outp=`sudo x2gopgwrapper listsessionsroot_all`;
+    @array=dbsys_listsessionsroot_all();
 }
 else
 {
- $outp=`sudo x2gopgwrapper listsessionsroot $serv`;
+    @array=dbsys_listsessionsroot ($serv);
 }
-$outp =~ s/ //g;
-$outp =~ s/\*/ /g;
-
-
-my @array=split(&quot;\n&quot;,$outp);
 my $i;
 for ( $i=0;$i&lt;@array;$i++) 
 {
        my @ln=split('\|'<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at array</A>[$i]);
        if(@ln[4] eq &quot;F&quot;)
        {
-          system(&quot;sudo x2gopgwrapper rmsessionsroot @ln[1]&quot;);
+          dbsys_rmsessionsroot( @ln[1]);
        }
        print &quot;@array[$i]\n&quot;;
 }
diff --git a/x2gomountdirs b/x2gomountdirs
index 0a5bbb3..71c277a 100755
--- a/x2gomountdirs
+++ b/x2gomountdirs
@@ -1,6 +1,9 @@
 #!/usr/bin/perl
 use strict;
 
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
 my $type=shift;
 my $session=shift;
 my $user=shift;
@@ -170,10 +173,7 @@ for(my $i=0;$i&lt;@dirs;$i++)
             $mntpath=&quot;$mdir/$p&quot;;
        }
 
-       print &quot;starting:sudo x2gopgwrapper insertmount $session \&quot;$mntpath\&quot; $host\n&quot;;
-       my $outp=`sudo x2gopgwrapper insertmount $session \&quot;$mntpath\&quot; $host`;
-       print &quot;result: $outp&quot;;
-       if($outp =~ m/INSERT/)
+       if(db_insertmount( $session, $mntpath, $host))
        {
              my $code_conv=$ENV{'X2GO_ICONV'};
              if($code_conv ne &quot;&quot;)
@@ -229,7 +229,7 @@ for(my $i=0;$i&lt;@dirs;$i++)
     	    else
     	    {
                print &quot;mount @dirs[$i] failed\n&quot;;
-               `sudo x2gopgwrapper deletemount $session \&quot;$mntpath\&quot;`;
+               db_deletemount( $session, $mntpath);
 	       rmdir($mntpath);
     	    }
        }
diff --git a/x2gopgwrapper b/x2gopgwrapper
deleted file mode 100755
index bfad849..0000000
--- a/x2gopgwrapper
+++ /dev/null
@@ -1,37 +0,0 @@
-#!/bin/bash
-
-if [ &quot;$1&quot; == &quot;startshadowagent&quot; ]
-then
-    
-    CLIENT=$2
-    
-    SHADOW_SET=${11}
-    
-    SHADOW_MODE=`echo &quot;$SHADOW_SET&quot;|awk '{split($0,a,&quot;XSHAD&quot;); print a[1]}'`
-    SHADOW_USER=`echo &quot;$SHADOW_SET&quot;|awk '{split($0,a,&quot;XSHAD&quot;); print a[2]}'`
-    SHADOW_DESKTOP=`echo &quot;$SHADOW_SET&quot;|awk '{split($0,a,&quot;XSHAD&quot;); print a[3]}'`
-
-    ANSWER=`su $SHADOW_USER -c &quot;DISPLAY=$SHADOW_DESKTOP x2godesktopsharing client ACCESS $SUDO_USER $CLIENT&quot;`
-    
-    if [ &quot;$ANSWER&quot; != &quot;GRANT&quot; ]
-    then
-        echo &quot;DEN&quot;
-        exit 
-    fi
-    OUTPUT=`su $SHADOW_USER -c &quot;SSH_CLIENT=$CLIENT x2gostartagent $3 $4 $5 $6 $7 $8 $9 ${10} ${11}&quot;`
-    echo $OUTPUT
-    PID=`echo $OUTPUT | awk '{print $3}'`
-    ANSWER=`su $SHADOW_USER -c &quot;DISPLAY=$SHADOW_DESKTOP x2godesktopsharing client AGENT $PID $SUDO_USER $CLIENT&quot;`
-    exit
-fi
-
-SQLHOST=`cat /etc/x2go/sql`
-if [ &quot;$SQLHOST&quot; ==  &quot;local&quot; ]
-then
-  x2gopgwrapper_local $@ 2&gt; /dev/null
-elif [ &quot;$SQLHOST&quot; ==  &quot;sqlite&quot; ]
-then
-  x2gopgwrapper_sqlite $@ 2&gt; /dev/null
-else
-  x2gopgwrapper_net $SQLHOST $@
-fi
\ No newline at end of file
diff --git a/x2gopgwrapper_local b/x2gopgwrapper_local
deleted file mode 100755
index 5f9abb1..0000000
--- a/x2gopgwrapper_local
+++ /dev/null
@@ -1,175 +0,0 @@
-#!/bin/su postgres  
-cd ~
-#use only with sudo !!
-
-UNAME=$SUDO_USER
-
-case &quot;$1&quot; in
-
-getdisplays)
-  echo &quot;select '|'||display||'|' from sessions;&quot;|psql -t x2go_sessions
-  ;;
-
-getports)
-  echo &quot;select '|'||port||'|' from used_ports;&quot;|psql -t x2go_sessions
-  ;;
-
-getservers)
-  echo &quot;select server,count(*) from sessions where status != 'F' group by server;&quot;|psql -t x2go_sessions
-  ;;
-
-listsessions)
-  echo &quot;select agent_pid, session_id, display, server, status,\
-   to_char(init_time,'DD.MM.YY*HH24:MI:SS'),cookie,client,gr_port,\
-   sound_port,to_char(last_time,'DD.MM.YY*HH24:MI:SS'),uname,\
-   to_char(now()-init_time,'SSSS'),fs_port from  sessions  \
-   where status !='F' and server='$2' and uname='$UNAME'  and  (  session_id not like '%XSHAD%') order by status desc;&quot;|psql -t x2go_sessions
-  ;;
-
-listsessions_all)
-  echo &quot;select agent_pid, session_id, display, server, status,\
-   to_char(init_time,'DD.MM.YY*HH24:MI:SS'),cookie,client,gr_port,\
-   sound_port,to_char(last_time,'DD.MM.YY*HH24:MI:SS'),uname,\
-   to_char(now()-init_time,'SSSS'),fs_port  from  sessions  \
-   where status !='F' and uname='$UNAME' and  (  session_id not like '%XSHAD%') order by status desc;&quot;|psql -t x2go_sessions
-  ;;
-
-listsessionsroot)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;select agent_pid, session_id, display, server, status,\
-   to_char(init_time,'DD.MM.YY*HH24:MI:SS'),cookie,client,gr_port,\
-   sound_port,to_char(last_time,'DD.MM.YY*HH24:MI:SS'),uname,\
-   to_char(now()-init_time,'SSSS'),fs_port  from  sessions  \
-   where server='$2'  order by status desc;&quot;|psql -t x2go_sessions
-  ;;
-
-listsessionsroot_all)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;select agent_pid, session_id, display, server, status,\
-   to_char(init_time,'DD.MM.YY*HH24:MI:SS'),cookie,client,gr_port,\
-   sound_port,to_char(last_time,'DD.MM.YY*HH24:MI:SS'),uname,\
-   to_char(now()-init_time,'SSSS'),fs_port  from  sessions  \
-   order by status desc;&quot;|psql -t x2go_sessions
-  ;;
-
-listsusp)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;select session_id, display, uname, server,extract( day from now()-last_time)*24*60+extract(hour from now()-last_time)*60+extract(minute from now()-last_time)\
-   from sessions where server='$2' and status='S';&quot;|psql -t x2go_sessions
-  ;;
-
-listallrunning)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;select agent_pid, session_id, display, server, status,\
-   to_char(init_time,'DD.MM.YY*HH24:MI:SS'),cookie,client,gr_port,\
-   sound_port,to_char(last_time,'DD.MM.YY*HH24:MI:SS'),uname,\
-   to_char(now()-init_time,'SSSS'),fs_port  from  sessions  \
-   where status='R';&quot;|psql -t x2go_sessions
-  ;;
-
-listmails)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;select user_messages.mess_id,sessions.session_id,\
-      sessions.uname,sessions.display from sessions,user_messages,\
-      messages where sessions.uname=user_messages.uname and sessions.status!='F'\
-      and messages.mess_id=user_messages.mess_id and sessions.server='$2';&quot;|psql -t x2go_sessions
-  ;;
-
-getmail)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;select message from messages where mess_id='$2';&quot;|psql -t x2go_sessions
-  ;;
-
-rmmail)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;delete from user_messages where mess_id='$2' and uname='$3';&quot;|psql -t x2go_sessions
-  ;;
-
-rmsessionsroot)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;delete from  sessions  \
-   where session_id='$2';&quot;|psql -t x2go_sessions
-  ;;
-
-getagent)
-  echo &quot;select agent_pid from sessions  where session_id = '$2';&quot;|psql -t x2go_sessions
-  ;;
-
-getdisplay)
-  echo &quot;select display from sessions  where session_id = '$2';&quot;|psql -t x2go_sessions
-  ;;
-
-changestatus)
-  echo &quot;update sessions set last_time=now(),status='$2' where session_id = '$3' and uname='$UNAME';&quot;|psql -t x2go_sessions
-  ;;
-
-resume)
-  echo &quot;update sessions set last_time=now(),status='R',client='$2' where session_id = '$3' and uname='$UNAME';&quot;|psql -t x2go_sessions
-  ;;
-
-insertsession)
-  echo &quot;insert into sessions (display,server,uname,session_id) values \
-  ('$2','$3','$UNAME','$4');&quot;|psql x2go_sessions
-  ;;
-
-createsession)
-  echo &quot;update sessions set status='R',last_time=now(),cookie='$2',agent_pid='$3',\
-   client='$4',gr_port='$5',sound_port='$6',fs_port='$7' where session_id='$8' and uname='$UNAME';&quot;|psql x2go_sessions
-  ;;
-
-insertport)
-  echo &quot;insert into used_ports (server,session_id,port) values \
-  ('$2','$3','$4');&quot;|psql x2go_sessions
-  ;;
-
-insertmount)
-  echo &quot;insert into mounts (session_id,path,client) values \
-  ('$2','$3','$4');&quot;|psql x2go_sessions
-  ;;
-
-deletemount)
-  echo &quot;delete from mounts where session_id='$2' and path='$3';&quot;|psql x2go_sessions
-  ;;
-
-getmounts)
-  echo &quot;select client,path from mounts where session_id = '$2';&quot;|psql -t x2go_sessions
-  ;;
-
-*)
-  echo &quot;$1: wrong argument&quot;
-  ;;
-
-esac
-
diff --git a/x2gopgwrapper_net b/x2gopgwrapper_net
deleted file mode 100755
index c779836..0000000
--- a/x2gopgwrapper_net
+++ /dev/null
@@ -1,183 +0,0 @@
-#!/bin/bash
-
-cd ~
-#use only with sudo !!
-
-SERVER=$1
-UNAME=$SUDO_USER
-
-case &quot;$2&quot; in
-
-getdisplays)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select '|'||display||'|' from sessions;\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-getports)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select '|'||port||'|' from used_ports;\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-getservers)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select server,count(*) from sessions where status != 'F' group by server;\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-listsessions)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select agent_pid, session_id, display, server, status,\
-   to_char(init_time,'DD.MM.YY*HH24:MI:SS'),cookie,client,gr_port,\
-   sound_port,to_char(last_time,'DD.MM.YY*HH24:MI:SS'),uname,\
-   to_char(now()-init_time,'SSSS'),fs_port from  sessions  \
-   where status !='F' and server='$3' and uname='$UNAME' and  (  session_id not like '%XSHAD%') order by status desc;\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-listsessions_all)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select agent_pid, session_id, display, server, status,\
-   to_char(init_time,'DD.MM.YY*HH24:MI:SS'),cookie,client,gr_port,\
-   sound_port,to_char(last_time,'DD.MM.YY*HH24:MI:SS'),uname,\
-   to_char(now()-init_time,'SSSS'),fs_port  from  sessions  \
-   where status !='F' and uname='$UNAME' and  (  session_id not like '%XSHAD%') order by status desc;\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-listsessionsroot)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select agent_pid, session_id, display, server, status,\
-   to_char(init_time,'DD.MM.YY*HH24:MI:SS'),cookie,client,gr_port,\
-   sound_port,to_char(last_time,'DD.MM.YY*HH24:MI:SS'),uname,\
-   to_char(now()-init_time,'SSSS'),fs_port  from  sessions  \
-   where server='$3'  order by status desc;\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-listsessionsroot_all)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select agent_pid, session_id, display, server, status,\
-   to_char(init_time,'DD.MM.YY*HH24:MI:SS'),cookie,client,gr_port,\
-   sound_port,to_char(last_time,'DD.MM.YY*HH24:MI:SS'),uname,\
-   to_char(now()-init_time,'SSSS'),fs_port  from  sessions  \
-   order by status desc;\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-listsusp)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select session_id, display, uname, server,extract( day from now()-last_time)*24*60+extract(hour from now()-last_time)*60+extract(minute from now()-last_time)\
-  from sessions where server='$3' and status='S';\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-
-listallrunning)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select agent_pid, session_id, display, server, status,\
-   to_char(init_time,'DD.MM.YY*HH24:MI:SS'),cookie,client,gr_port,\
-   sound_port,to_char(last_time,'DD.MM.YY*HH24:MI:SS'),uname,\
-   to_char(now()-init_time,'SSSS'),fs_port  from  sessions  \
-   where status='R';\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-listmails)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select user_messages.mess_id,sessions.session_id,\
-      sessions.uname,sessions.display from sessions,user_messages,\
-      messages where sessions.uname=user_messages.uname and sessions.status!='F'\
-      and messages.mess_id=user_messages.mess_id and sessions.server='$3';\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-getmail)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select message\
-      from messages where mess_id='$3';\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-
-rmmail)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;delete from \
-  user_messages where mess_id='$3' and uname='$4';\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-
-rmsessionsroot)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;delete from  sessions  \
-   where session_id='$3' ;\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-
-getagent)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select agent_pid from sessions  where session_id = '$3';\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-getdisplay)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select display from sessions  where session_id = '$3';\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-changestatus)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;update sessions set last_time=now(),status='$3' where session_id = '$4' and uname='$UNAME';\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-resume)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;update sessions set last_time=now(),status='R',client='$3' where session_id = '$4' and uname='$UNAME';\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-insertsession)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;insert into sessions (display,server,uname,session_id) values \
-  ('$3','$4','$UNAME','$5');\&quot;|psql x2go_sessions&quot;
-  ;;
-
-createsession)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;update sessions set status='R',last_time=now(),cookie='$3',agent_pid='$4',\
-   client='$5',gr_port='$6',sound_port='$7',fs_port='$8' where session_id='$9' and uname='$UNAME';\&quot;|psql x2go_sessions&quot;
-  ;;
-
-insertport)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;insert into used_ports (server,session_id,port) values \
-  ('$3','$4','$5');\&quot;|psql x2go_sessions&quot;
-  ;;
-
-insertmount)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;insert into mounts (session_id,path,client) values \
-  ('$3','$4','$5');\&quot;|psql x2go_sessions&quot;
-  ;;
-
-deletemount)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;delete from mounts where session_id='$3' and path='$4';\&quot;|psql x2go_sessions&quot;
-  ;;
-
-getmounts)
-  ssh -i /root/.x2go/ssh/.pg/id_dsa postgres@$SERVER &quot;echo \&quot;select client,path from mounts where session_id = '$3';\&quot;|psql -t x2go_sessions&quot;
-  ;;
-
-*)
-  echo &quot;$2: wrong argument&quot;
-  ;;
-
-esac
-
diff --git a/x2gopgwrapper_sqlite b/x2gopgwrapper_sqlite
deleted file mode 100755
index 4c0bb32..0000000
--- a/x2gopgwrapper_sqlite
+++ /dev/null
@@ -1,201 +0,0 @@
-#!/bin/bash
-#use only with sudo !!
-
-UNAME=$SUDO_USER
-
-DATABASE=/var/db/x2go/x2go_sessions
-
-
-case &quot;$1&quot; in
-
-getdisplays)
-  echo &quot;select '|'||display||'|' from sessions;&quot;|sqlite $DATABASE
-  ;;
-
-getports)
-  echo &quot;select '|'||port||'|' from used_ports;&quot;|sqlite $DATABASE
-  ;;
-
-getservers)
-  echo &quot;select server,count(*) from sessions where status != 'F' group by server;&quot;|sqlite $DATABASE
-  ;;
-
-listsessions)
-  echo &quot;select agent_pid, session_id, display, server, status,\
-   substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),9,11),\
-   cookie,client,gr_port,sound_port,\
-   substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),9,11),\
-   uname,\
-   strftime('%s','now','localtime') - strftime('%s',init_time),fs_port from  sessions  \
-   where status !='F' and server='$2' and uname='$UNAME' and  (  session_id not like '%XSHAD%')  order by status desc;&quot;|sqlite $DATABASE
-  ;;
-
-listsessions_all)
-  echo &quot;select agent_pid, session_id, display, server, status,\
-   substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),9,11),\
-   cookie,client,gr_port,sound_port,\
-   substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),9,11),\
-   uname,\
-   strftime('%s','now','localtime') - strftime('%s',init_time),fs_port from  sessions  \
-   where status !='F' and uname='$UNAME' and  (  session_id not like '%XSHAD%') order by status desc;&quot;|sqlite $DATABASE
-  ;;
-
-listsessionsroot)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;select agent_pid, session_id, display, server, status,\
-   substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),9,11),\
-   cookie,client,gr_port,sound_port,\
-   substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),9,11),\
-   uname,\
-   strftime('%s','now','localtime') - strftime('%s',init_time),fs_port from  sessions  \
-   where server='$2'  order by status desc;&quot;|sqlite $DATABASE
-  ;;
-
-listsessionsroot_all)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;select agent_pid, session_id, display, server, status,\
-   substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),9,11),\
-   cookie,client,gr_port,sound_port,\
-   substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),9,11),\
-   uname,\
-   strftime('%s','now','localtime') - strftime('%s',init_time),fs_port from  sessions  \
-   order by status desc;&quot;|sqlite $DATABASE
-  ;;
-
-listsusp)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;select session_id, display, uname, server,round((strftime('%s','now','localtime') - strftime('%s',last_time))/60)\
-   from sessions where server='$2' and status='S';&quot;|sqlite $DATABASE
-  ;;
-
-listallrunning)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;select agent_pid, session_id, display, server, status,\
-   substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),9,11),\
-   cookie,client,gr_port,sound_port,\
-   substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),9,11),\
-   uname,\
-   strftime('%s','now','localtime') - strftime('%s',init_time),fs_port from  sessions  \
-   where status='R';&quot;|sqlite $DATABASE
-  ;;
-
-listmails)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;select user_messages.mess_id,sessions.session_id,\
-      sessions.uname,sessions.display from sessions,user_messages,\
-      messages where sessions.uname=user_messages.uname and sessions.status!='F'\
-      and messages.mess_id=user_messages.mess_id and sessions.server='$2';&quot;|sqlite $DATABASE
-  ;;
-
-getmail)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;select message from messages where mess_id='$2';&quot;|sqlite $DATABASE
-  ;;
-
-rmmail)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;delete from user_messages where mess_id='$2' and uname='$3';&quot;|sqlite $DATABASE
-  ;;
-
-rmsessionsroot)
-  if [ &quot;$UNAME&quot; != &quot;root&quot; ]
-  then
-    echo &quot;$UNAME, You have not permission to do this job!&quot;
-    exit  
-  fi
-  echo &quot;delete from  sessions  \
-   where session_id='$2';&quot;|sqlite $DATABASE
-  echo &quot;delete from  used_ports  \
-   where session_id='$2';&quot;|sqlite $DATABASE
-  ;;
-
-getagent)
-  echo &quot;select agent_pid from sessions  where session_id = '$2';&quot;|sqlite $DATABASE
-  ;;
-
-getdisplay)
-  echo &quot;select display from sessions  where session_id = '$2';&quot;|sqlite $DATABASE
-  ;;
-
-changestatus)
-  echo &quot;update sessions set last_time=datetime('now','localtime'),status='$2' where session_id = '$3' and uname='$UNAME';&quot;|sqlite $DATABASE
-  ;;
-
-resume)
-  echo &quot;update sessions set last_time=datetime('now','localtime'),status='R',client='$2' where session_id = '$3' and uname='$UNAME';&quot;|sqlite $DATABASE
-  ;;
-
-insertsession)
-  OUTP=`echo &quot;insert into sessions (display,server,uname,session_id, init_time, last_time) values \
-  ('$2','$3','$UNAME','$4', datetime('now','localtime'), datetime('now','localtime'));&quot;|sqlite $DATABASE`
-  if [ &quot;$OUTP&quot; == &quot;&quot; ]
-  then
-    echo &quot;INSERT 0 1&quot;
-  fi
-  ;;
-
-createsession)
-  echo &quot;update sessions set status='R',last_time=datetime('now','localtime'),cookie='$2',agent_pid='$3',\
-   client='$4',gr_port='$5',sound_port='$6',fs_port='$7' where session_id='$8' and uname='$UNAME';&quot;|sqlite $DATABASE
-  ;;
-
-insertport)
-   OUTP=`echo &quot;insert into used_ports (server,session_id,port) values \
-  ('$2','$3','$4');&quot;|sqlite $DATABASE`
-  if [ &quot;$OUTP&quot; == &quot;&quot; ]
-  then
-    echo &quot;INSERT 0 1&quot;
-  fi
-  ;;
-
-insertmount)
-   OUTP=`echo &quot;insert into mounts (session_id,path,client) values \
-  ('$2','$3','$4');&quot;|sqlite $DATABASE`
-  if [ &quot;$OUTP&quot; == &quot;&quot; ]
-  then
-    echo &quot;INSERT 0 1&quot;
-  fi
-  ;;
-
-deletemount)
-  echo &quot;delete from mounts where session_id='$2' and path='$3';&quot;|sqlite $DATABASE
-  ;;
-
-getmounts)
-  echo &quot;select client,path from mounts where session_id = '$2';&quot;|sqlite $DATABASE
-  ;;
-
-*)
-  echo &quot;$1: wrong argument&quot;
-  ;;
-
-esac
-
diff --git a/x2goresume b/x2goresume
new file mode 100755
index 0000000..251fb5e
--- /dev/null
+++ b/x2goresume
@@ -0,0 +1,11 @@
+#!/usr/bin/perl
+use strict;
+
+
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+my $client=shift or die;
+my $sid=shift or die;
+
+db_resume($client, $sid);
diff --git a/x2goresume-session b/x2goresume-session
index bd14495..c9ca10a 100755
--- a/x2goresume-session
+++ b/x2goresume-session
@@ -10,9 +10,7 @@ X2GO_SET_KBD=$7
 
 
 
-X2GO_AGENT_PID=`sudo x2gopgwrapper getagent $SESSION_NAME` 
-X2GO_AGENT_PID=`echo &quot;$X2GO_AGENT_PID&quot;| awk {'print $1'}`
-
+X2GO_AGENT_PID=`x2gogetagent $SESSION_NAME`
 
 
 X2GO_ROOT=${HOME}/.x2go
@@ -68,8 +66,6 @@ fi
 
 echo &quot;$NEWOPTIONS&quot; &gt;${SESSION_DIR}/options
 
-
-sudo x2gopgwrapper resume  $X2GO_CLIENT $SESSION_NAME  &gt; /dev/null
-
+x2goresume  $X2GO_CLIENT $SESSION_NAME  &gt; /dev/null
 
 kill -HUP $X2GO_AGENT_PID
diff --git a/x2goruncommand b/x2goruncommand
index 7c0ac30..4c44833 100755
--- a/x2goruncommand
+++ b/x2goruncommand
@@ -112,6 +112,6 @@ else
 fi 
 
 kill -TERM  $X2GO_AGENT_PID
-sudo x2gopgwrapper changestatus 'F' $X2GO_SESSION  &gt; /dev/null
+x2gochangestatus 'F' $X2GO_SESSION  &gt; /dev/null
 export HOSTNAME
 x2goumount_session $X2GO_SESSION
diff --git a/x2goshowblocks b/x2goshowblocks
index e84dcc2..911ef48 100755
--- a/x2goshowblocks
+++ b/x2goshowblocks
@@ -1,16 +1,17 @@
 #!/usr/bin/perl
 use strict;
+
+
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+
 my $uname=shift;
 my $id=shift;
 my $tbl=&quot;mounts&quot;;
-my $outp=`sudo x2gopgwrapper getmounts '$id'`;
-#print $outp;
-$outp =~ s/ //g;
-
-my @outp=split(&quot;\n&quot;,&quot;$outp&quot;);
+my @outp=dbsys_getmounts( $id);
 for(my $i=0;$i&lt;@outp;$i++)
 {
     my $path=(split(&quot;\\|&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at outp</A>[$i]))[1];
-#    print $path;
     print `su $uname -c &quot;lsof 2&gt;/dev/null | grep $path&quot;`;
 }
diff --git a/x2gosqlite.sh b/x2gosqlite.sh
deleted file mode 100755
index a42ecc1..0000000
--- a/x2gosqlite.sh
+++ /dev/null
@@ -1,54 +0,0 @@
-#!/bin/bash
-
-DATABASE=/var/db/x2go/x2go_sessions
-
-#rm $DATABASE
-
-echo &quot;create table sessions(
-		session_id varchar(500) primary key,
-                display integer not null, 
-		uname varchar(100) not null, 
-		server varchar(100) not null,
-		client inet,
-		status char(1) not null default 'R',
-		init_time timestamp not null default CURRENT_TIMESTAMP,
-		last_time timestamp not null default CURRENT_TIMESTAMP,
-		cookie char(33),
-		agent_pid int,
-		gr_port int,
-		sound_port int,
-		fs_port int,
-		unique(display)
-		);&quot; | sqlite $DATABASE
-
-
-echo &quot;create table messages(mess_id varchar(20) primary key, message text);&quot; | sqlite $DATABASE
-
-echo &quot;create table user_messages(
-                mess_id varchar(20) not null, 
-		uname varchar(100) not null
-		);&quot; | sqlite $DATABASE
-
-
-echo &quot;create table used_ports(
-                server varchar(100) not null,
-		session_id varchar(500) references sessions on delete cascade, 
-		port integer primary key
-		);&quot; | sqlite $DATABASE
-
-echo &quot;create table mounts(
-                session_id varchar(500) references sessions on delete restrict,
-		path varchar(512) not null, 
-		client inet not null, 
-		primary key(path,client)
-		);&quot; | sqlite $DATABASE
-
-echo &quot;CREATE TRIGGER fkd_mounts_session_id
-BEFORE DELETE ON sessions
-FOR EACH ROW BEGIN 
-  SELECT CASE
-    WHEN ((SELECT session_id FROM mounts WHERE session_id = OLD.session_id) IS NOT NULL)
-    THEN RAISE(ABORT, 'delete on table \&quot;sessions\&quot; violates foreign key on table \&quot;mounts\&quot;')
-  END;
-END;&quot; | sqlite $DATABASE
-            
diff --git a/x2gosqlitewrapper b/x2gosqlitewrapper
new file mode 100755
index 0000000..70d1ac0
--- /dev/null
+++ b/x2gosqlitewrapper
@@ -0,0 +1,321 @@
+#!/usr/bin/perl
+use strict;
+
+use DBI;          
+use POSIX;                                                                                                                             
+
+my $realuser=$ENV{SUDO_USER};
+my ($uname, $pass, $uid, $pgid, $quota, $comment, $gcos, $homedir, $shell, $expire) = getpwuid(getuid());
+
+if($uname ne &quot;x2gouser&quot;)
+{
+  die &quot;Use \&quot;sudo -u x2gouser\&quot; to run this programm&quot;;
+}
+
+my $cmd=shift or die &quot;command not specified&quot;;
+
+
+my $user=&quot;x2gouser&quot;;
+my  ($name, $pass, $uid, $pgid, $quota, $comment, $gcos, $dir, $shell, $expire) = getpwnam($user);
+my $dbfile=&quot;$dir/x2go_sessions&quot;;
+my $dbfile=&quot;/var/db/x2go/x2go_sessions&quot;;
+      
+my $dbh=DBI-&gt;connect(&quot;dbi:SQLite:dbname=$dbfile&quot;,&quot;&quot;,&quot;&quot;,{AutoCommit =&gt; 1}) or die $_;
+
+
+if($cmd eq  &quot;rmsessionsroot&quot;)
+{
+  checkroot();
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       my $sth=$dbh-&gt;prepare(&quot;delete from sessions  where session_id='$sid'&quot;);
+       $sth-&gt;execute()or die;
+       $sth-&gt;finish();
+}
+
+elsif($cmd eq  &quot;listsessionsroot&quot;)
+{
+  checkroot();
+       my $server=shift or die &quot;argument \&quot;server\&quot; missed&quot;;
+       my @strings;	       
+	       my $sth=$dbh-&gt;prepare(&quot;select agent_pid, session_id, display, server, status,
+                                      substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),9,11),
+                                      cookie,client,gr_port,sound_port,
+                                      substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),9,11),
+                                      uname,
+                                      strftime('%s','now','localtime') - strftime('%s',init_time),fs_port from  sessions 
+                                      where server='$server'  order by status desc&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]=join('|'<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at data</A>);
+               }
+	       $sth-&gt;finish();
+	       print join(&quot;\n&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at strings</A>);
+}
+
+elsif($cmd eq  &quot;listsessionsroot_all&quot;)
+{
+  checkroot();
+       my @strings;	       
+	       my $sth=$dbh-&gt;prepare(&quot;select agent_pid, session_id, display, server, status,
+                                      substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),9,11),
+                                      cookie,client,gr_port,sound_port,
+                                      substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),9,11),
+                                      uname,
+                                      strftime('%s','now','localtime') - strftime('%s',init_time),fs_port from  sessions 
+                                      order by status desc&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]=join('|'<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at data</A>);
+               }
+	       $sth-&gt;finish();
+	       print join(&quot;\n&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at strings</A>);
+}
+
+	     
+elsif($cmd eq  &quot;getmounts&quot;)
+{
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       my @strings;
+	       my $sth=$dbh-&gt;prepare(&quot;select client, path from mounts where session_id='$sid'&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]=join(&quot;|&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at data</A>);
+               }
+	       $sth-&gt;finish();
+	       $dbh-&gt;disconnect();
+	       print join(&quot;\n&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at strings</A>);
+}
+
+elsif($cmd eq  &quot;deletemount&quot;)
+{
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       my $path=shift or die &quot;argument \&quot;path\&quot; missed&quot;;
+       my $sth=$dbh-&gt;prepare(&quot;delete from mounts where session_id='$sid' and path='$path'&quot;);
+       $sth-&gt;execute();
+       $sth-&gt;finish();
+}
+
+elsif($cmd eq  &quot;insertmount&quot;)
+{
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       my $path=shift or die &quot;argument \&quot;path\&quot; missed&quot;;
+       my $client=shift or die &quot;argument \&quot;client\&quot; missed&quot;;
+       my $sth=$dbh-&gt;prepare(&quot;insert into mounts (session_id,path,client) values  ('$sid','$path','$client')&quot;);
+       $sth-&gt;execute();
+       if(!$sth-&gt;err())
+       {
+	 print &quot;ok&quot;;
+       }
+       $sth-&gt;finish();
+}
+
+elsif($cmd eq  &quot;insertsession&quot;)
+{
+	my $display=shift or die &quot;argument \&quot;display\&quot; missed&quot;;
+	my $server=shift or die &quot;argument \&quot;server\&quot; missed&quot;;
+        my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+        my $sth=$dbh-&gt;prepare(&quot;insert into sessions (display,server,uname,session_id, init_time, last_time) values 
+                              ('$display','$server','$realuser','$sid', datetime('now','localtime'), datetime('now','localtime'))&quot;);
+        $sth-&gt;execute()or die $_;
+        $sth-&gt;finish();
+        print &quot;ok&quot;;
+}
+
+elsif($cmd eq  &quot;createsession&quot;)
+{
+       my $cookie=shift or die&quot;argument \&quot;cookie\&quot; missed&quot;;
+       my $pid=shift or die&quot;argument \&quot;pid\&quot; missed&quot;;
+       my $client=shift or die&quot;argument \&quot;client\&quot; missed&quot;;
+       my $gr_port=shift or die&quot;argument \&quot;gr_port\&quot; missed&quot;;
+       my $snd_port=shift or die&quot;argument \&quot;snd_port\&quot; missed&quot;;
+       my $fs_port=shift or die&quot;argument \&quot;fs_port\&quot; missed&quot;;
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       my $sth=$dbh-&gt;prepare(&quot;update sessions set status='R',last_time=datetime('now','localtime'),cookie='$cookie',agent_pid='$pid',
+                             client='$client',gr_port='$gr_port',sound_port='$snd_port',fs_port='$fs_port' where session_id='$sid' and uname='$realuser'&quot;);
+       $sth-&gt;execute()or die;
+       $sth-&gt;finish();
+       print &quot;ok&quot;;
+}
+
+elsif($cmd eq  &quot;insertport&quot;)
+{
+	my $server=shift or die &quot;argument \&quot;server\&quot; missed&quot;;
+	my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+	my $sshport=shift or die &quot;argument \&quot;port\&quot; missed&quot;;
+        my $sth=$dbh-&gt;prepare(&quot;insert into used_ports (server,session_id,port) values  ('$server','$sid','$sshport')&quot;);
+        $sth-&gt;execute()or die;
+        $sth-&gt;finish();
+
+}
+
+	     
+elsif($cmd eq  &quot;resume&quot;)
+{
+       my $client=shift or die &quot;argument \&quot;client\&quot; missed&quot;;
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;       
+	       my $sth=$dbh-&gt;prepare(&quot;update sessions set last_time=datetime('now','localtime'),status='R',
+                                      client='$client' where session_id = '$sid' and uname='$realuser'&quot;);
+               $sth-&gt;execute()or die;
+	       $sth-&gt;finish();
+}
+
+elsif($cmd eq  &quot;changestatus&quot;)
+{
+       my $status=shift or die &quot;argument \&quot;status\&quot; missed&quot;;
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;       
+	       my $sth=$dbh-&gt;prepare(&quot;update sessions set last_time=datetime('now','localtime'),
+                             status='$status' where session_id = '$sid' and uname='$realuser'&quot;);
+               $sth-&gt;execute()or die;
+	       $sth-&gt;finish();
+}
+
+elsif($cmd eq  &quot;getdisplays&quot;)
+{
+       #ignore $server
+       my @strings;
+	       my $sth=$dbh-&gt;prepare(&quot;select display from sessions&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]='|'<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">. at data</A>[0].'|';
+               }
+	       $sth-&gt;finish();
+	       print join(&quot;\n&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at strings</A>);
+}
+
+elsif($cmd eq  &quot;getports&quot;)
+{
+       #ignore $server
+       my $server=shift or die &quot;argument \&quot;server\&quot; missed&quot;;         
+       my @strings;
+	       my $sth=$dbh-&gt;prepare(&quot;select port from used_ports&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]='|'<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">. at data</A>[0].'|';
+               }
+	       $sth-&gt;finish();
+	       print join(&quot;\n&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at strings</A>);
+}
+
+elsif($cmd eq  &quot;getservers&quot;)
+{
+       my @strings;
+	       my $sth=$dbh-&gt;prepare(&quot;select server,count(*) from sessions where status != 'F' group by server&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]=@data[0];
+               }
+	       $sth-&gt;finish();
+	       print join(&quot;\n&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at strings</A>);
+}
+
+elsif($cmd eq  &quot;getagent&quot;)
+{
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       my $agent;
+	       my $sth=$dbh-&gt;prepare(&quot;select agent_pid from sessions
+				      where session_id ='$sid'&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               if(@data = $sth-&gt;fetchrow_array) 
+               {
+		   $agent=@data[0];
+               }
+               $sth-&gt;finish();
+       print $agent;
+}
+
+elsif($cmd eq  &quot;getdisplay&quot;)
+{
+       my $sid=shift or die &quot;argument \&quot;session_id\&quot; missed&quot;;
+       my $display;
+	       my $sth=$dbh-&gt;prepare(&quot;select display from sessions
+				      where session_id ='$sid'&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               if(@data = $sth-&gt;fetchrow_array) 
+               {
+		   $display=@data[0];
+               }
+               $sth-&gt;finish();
+       print $display;
+}
+
+elsif($cmd eq  &quot;listsessions&quot;)
+{
+       my $server=shift or die &quot;argument \&quot;server\&quot; missed&quot;;
+	       my @strings;
+	       my $sth=$dbh-&gt;prepare(&quot;select agent_pid, session_id, display, server, status,
+                                      substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),9,11),
+                                      cookie,client,gr_port,sound_port,
+                                      substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),9,11),
+                                      uname,
+                                      strftime('%s','now','localtime') - strftime('%s',init_time),fs_port from  sessions 
+                                      where status !='F' and server='$server' and uname='$realuser' 
+                                      and  (  session_id not like '%XSHAD%')  order by status desc&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]=join('|'<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at data</A>);
+               }
+	       $sth-&gt;finish();
+	       print join(&quot;\n&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at strings</A>);
+}
+
+elsif($cmd eq  &quot;listsessions_all&quot;)
+{
+	       my @strings;
+	       my $sth=$dbh-&gt;prepare(&quot;select agent_pid, session_id, display, server, status,
+                                      substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',init_time),9,11),
+                                      cookie,client,gr_port,sound_port,
+                                      substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),0,6)||substr(strftime('%d.%m.%Y*%H:%M:%S',last_time),9,11),
+                                      uname,
+                                      strftime('%s','now','localtime') - strftime('%s',init_time),fs_port from  sessions 
+                                      where status !='F' and uname='$realuser' and  (  session_id not like '%XSHAD%')  order by status desc&quot;);
+               $sth-&gt;execute()or die;
+               my @data;
+	       my $i=0;
+               while (@data = $sth-&gt;fetchrow_array) 
+               {
+		   @strings[$i++]=join('|'<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at data</A>);
+               }
+	       $sth-&gt;finish();
+	       print join(&quot;\n&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at strings</A>);
+}
+else
+{
+      print &quot;unknown command $cmd\n&quot;;
+}
+
+$dbh-&gt;disconnect();
+
+
+
+sub checkroot
+{
+  if ($realuser ne &quot;root&quot;)
+  {
+    die &quot;$realuser, you can not do this job&quot;;
+  }
+}
\ No newline at end of file
diff --git a/x2gostartagent b/x2gostartagent
index 0dea745..75a5cc4 100755
--- a/x2gostartagent
+++ b/x2gostartagent
@@ -29,10 +29,11 @@ then
     
     if [ &quot;$SHADOW_USER&quot; != &quot;$USER&quot; ]
     then
-	OUTPUT=`sudo x2gopgwrapper startshadowagent $X2GO_CLIENT $@`
-	if [ &quot;$OUTPUT&quot; == &quot;DEN&quot; ]
+        
+        OUTPUT=`x2godesktopsharing client $X2GO_CLIENT $@`
+        if [ &quot;$OUTPUT&quot; == &quot;DENY&quot; ]
 	then
-            echo &quot;ACCESS DENIED&quot;
+            echo &quot;ACCESS DENIED&quot; 1&gt;&amp;2
             exit -1
 	fi
 	X2GO_COOKIE=`echo $OUTPUT | awk '{print $2}'`
@@ -56,7 +57,7 @@ LWORD=`echo $LIMIT | awk '{print $1}'`
 
 if [ &quot;$LWORD&quot; == &quot;LIMIT&quot; ]
 then
-   echo  $LIMIT
+   echo  $LIMIT 1&gt;&amp;2
    exit -1
 fi
 
@@ -80,10 +81,10 @@ then
 fi
 
 
-USED_DISPLAYS=`sudo x2gopgwrapper getdisplays $HOSTNAME`
+USED_DISPLAYS=`x2gogetdisplays $HOSTNAME`
 
 
-while [ &quot;`echo \&quot;$OUTPUT\&quot; | awk '{print $1,$3}'`&quot; != &quot;INSERT 1&quot; ]
+while [ &quot;$OUTPUT&quot;  != &quot;inserted&quot; ]
 do
  X2GO_PORT=$(($X2GO_PORT + 1))
  X2GO_PORT=`echo &quot;for(\\$i=$X2GO_PORT;\\$br ne \&quot;true\&quot;;\\$i++){ if(\&quot;$USED_DISPLAYS\&quot; =~ m/\\|\\$i\\|/){\\$br=\&quot;false\&quot;;}else{\\$br=\&quot;true\&quot;;print \\$i;}}&quot;|perl`
@@ -98,18 +99,18 @@ do
        SESSION_NAME=&quot;$SESSION_NAME&quot;_st${SESSION_TYPE}${X2GO_CMD}_dp${COLORDEPTH}
        SESSION_NAME=`echo &quot;$SESSION_NAME&quot; | sed  -e  &quot;s/:/PP/g&quot;`
    fi
-   OUTPUT=`sudo x2gopgwrapper insertsession $X2GO_PORT $HOSTNAME $SESSION_NAME`
+   OUTPUT=`x2goinsertsession $X2GO_PORT $HOSTNAME $SESSION_NAME`
  fi 
 done
 
 
-USED_PORTS=`sudo x2gopgwrapper getports $HOSTNAME`
+USED_PORTS=`x2gogetports $HOSTNAME`
 
 
 while [ &quot;$GR_PORT&quot; == &quot;&quot; ] || [ &quot;$SOUND_PORT&quot; == &quot;&quot; ] || [ &quot;$FS_PORT&quot; == &quot;&quot; ]
 do
   OUTPUT=&quot;&quot;
-  while [ &quot;`echo \&quot;$OUTPUT\&quot; | awk '{print $1,$3}'`&quot; != &quot;INSERT 1&quot; ]
+  while [ &quot;$OUTPUT&quot;  != &quot;inserted&quot; ]
   do
     SSH_PORT=$(($SSH_PORT + 1))
 
@@ -124,7 +125,7 @@ do
                                   Proto =&gt; 'tcp',Listen =&gt; 1,Reuse =&gt;1 ) or die ;print \&quot;OK\&quot;;close(\\$sock);&quot;|perl 2&gt;/dev/null`
       if [ &quot;$CR&quot; == &quot;OK&quot; ]
       then
-         OUTPUT=`sudo x2gopgwrapper insertport $HOSTNAME $SESSION_NAME $SSH_PORT`
+         OUTPUT=`x2goinsertport $HOSTNAME $SESSION_NAME $SSH_PORT`
       fi
     fi
   done
@@ -243,7 +244,8 @@ fi
 X2GO_AGENT_PID=$!
 
 X2GO_SND_PORT=1024
-sudo x2gopgwrapper createsession $X2GO_COOKIE $X2GO_AGENT_PID $X2GO_CLIENT $GR_PORT $SOUND_PORT $FS_PORT $SESSION_NAME &gt; /dev/null
+
+x2gocreatesession $X2GO_COOKIE $X2GO_AGENT_PID $X2GO_CLIENT $GR_PORT $SOUND_PORT $FS_PORT $SESSION_NAME &gt; /dev/null
 
 echo $X2GO_PORT
 echo $X2GO_COOKIE
diff --git a/x2gosuspend-session b/x2gosuspend-session
index db819f3..c79d490 100755
--- a/x2gosuspend-session
+++ b/x2gosuspend-session
@@ -3,17 +3,14 @@
 SESSION_NAME=$1
 
 
-X2GO_AGENT_PID=`sudo x2gopgwrapper getagent $SESSION_NAME` 
-echo &quot;agent: $X2GO_AGENT_PID&quot;
+X2GO_AGENT_PID=`x2gogetagent $SESSION_NAME` 
 X2GO_AGENT_PID=`echo &quot;$X2GO_AGENT_PID&quot;| awk {'print $1'}`
 
-echo &quot;agent: $X2GO_AGENT_PID&quot;
-
 
 #workaround for knotify
 killall -HUP knotify
 
-sudo x2gopgwrapper changestatus 'S' $SESSION_NAME  &gt; /dev/null
+x2gochangestatus 'S' $SESSION_NAME  &gt; /dev/null
 
 
 kill -HUP $X2GO_AGENT_PID
diff --git a/x2goterminate-session b/x2goterminate-session
index 59560d4..5d31543 100755
--- a/x2goterminate-session
+++ b/x2goterminate-session
@@ -1,10 +1,10 @@
 #!/bin/bash
 
 SESSION_NAME=$1
-X2GO_AGENT_PID=`sudo x2gopgwrapper getagent $SESSION_NAME` 
+X2GO_AGENT_PID=`x2gogetagent $SESSION_NAME` 
 X2GO_AGENT_PID=`echo &quot;$X2GO_AGENT_PID&quot;| awk {'print $1'}`
 
-sudo x2gopgwrapper changestatus 'F' $SESSION_NAME  &gt; /dev/null
+x2gochangestatus 'F' $SESSION_NAME  &gt; /dev/null
 
 kill -TERM $X2GO_AGENT_PID
 export HOSTNAME
diff --git a/x2goumount b/x2goumount
index 928c3c1..c24fbeb 100755
--- a/x2goumount
+++ b/x2goumount
@@ -1,6 +1,9 @@
 #!/usr/bin/perl
 use strict;
 
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
 my $fname=shift;
 open(F,&quot;&lt;$fname&quot;) or die &quot;can't open $fname&quot;;
 my $dir=&lt;F&gt;;
@@ -22,7 +25,7 @@ if($ENV{'GNOME_DESKTOP_SESSION_ID'} ne &quot;&quot;)
 if(system( &quot;fusermount -u $dir&quot; ) == 0)
 {
      unlink($fname);
-     system(&quot;sudo x2gopgwrapper deletemount $session \&quot;$dir\&quot;&quot;);
+     db_deletemount( $session, $dir);
      rmdir ($dir);
 }
 else
diff --git a/x2goumount_session b/x2goumount_session
index 5e3da84..3b73702 100755
--- a/x2goumount_session
+++ b/x2goumount_session
@@ -2,6 +2,10 @@
 use Sys::Hostname;
 use strict;
 
+use lib &quot;/usr/lib/x2go&quot;;
+use x2godbwrapper; 
+
+
 my $session=shift;
 my $only_path=shift;
 
@@ -18,14 +22,12 @@ if($only_path)
 }
 
 
-my $outp=`sudo x2gopgwrapper getdisplay $session`;
+my $display=db_getdisplay($session);
 
-$outp=~s/ //g;
 
-my $display=$outp;
+print &quot;DISPLAY=$display\n&quot;;
 
-$outp=`sudo x2gopgwrapper getmounts $session`;
-my @outp=split(&quot;\n&quot;,&quot;$outp&quot;);
+my @outp=db_getmounts($session);
 my $i;
 
 
@@ -108,7 +110,7 @@ break:
 	   unlink(&quot;$remote(sshfs-cdrom)&quot;);
 	}
         #print &quot;$session \&quot;@line[1]\&quot;\n&quot;; 
-	system(&quot;sudo x2gopgwrapper deletemount $session \&quot;@line[1]\&quot;&gt; /dev/null&quot;);
+	db_deletemount ($session, @line[1]);
         rmdir (@line[1]);
     }
 cont:    


hooks/post-receive
-- 
x2goserver.git (X2Go Server)

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;x2goserver.git&quot; (X2Go Server).

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008408.html">[X2Go-Commits] x2goserver.git - release/4.0.1.x (branch) updated:	3.0.99-2-2-g69ac55d
</A></li>
	<LI>Next message: <A HREF="008400.html">[X2Go-Commits] x2goserver.git - release/4.0.1.x (branch) updated:	3.0.99-2-3-g17f0a8f
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8421">[ date ]</a>
              <a href="thread.html#8421">[ thread ]</a>
              <a href="subject.html#8421">[ subject ]</a>
              <a href="author.html#8421">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/x2go-commits">More information about the X2Go-commits
mailing list</a><br>
</body></html>
