<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [X2Go-Commits] x2godesktopsharing.git - build-main (branch)	updated: 3.0.1-2
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/x2go-commits/2013-June/index.html" >
   <LINK REL="made" HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2Go-Commits%5D%20x2godesktopsharing.git%20-%20build-main%20%28branch%29%0A%09updated%3A%203.0.1-2&In-Reply-To=%3C20130607231317.F0FC75DB26%40ymir%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009182.html">
   <LINK REL="Next"  HREF="009184.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[X2Go-Commits] x2godesktopsharing.git - build-main (branch)	updated: 3.0.1-2</H1>
    <B>X2Go dev team</B> 
    <A HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2Go-Commits%5D%20x2godesktopsharing.git%20-%20build-main%20%28branch%29%0A%09updated%3A%203.0.1-2&In-Reply-To=%3C20130607231317.F0FC75DB26%40ymir%3E"
       TITLE="[X2Go-Commits] x2godesktopsharing.git - build-main (branch)	updated: 3.0.1-2">git-admin at x2go.org
       </A><BR>
    <I>Sat Jun  8 01:13:17 CEST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="009182.html">[X2Go-Commits] x2godesktopsharing.git - build-main (branch)	created: 3.0.1-1
</A></li>
        <LI>Next message: <A HREF="009184.html">[X2Go-Commits] x2godesktopsharing.git - build-main (branch)	updated: 3.0.1-2-2-g7c19ae5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9183">[ date ]</a>
              <a href="thread.html#9183">[ thread ]</a>
              <a href="subject.html#9183">[ subject ]</a>
              <a href="author.html#9183">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch, build-main has been updated
       via  ca0b017bcc352c2e30b8dd08df6076e515be1d53 (commit)
      from  6211d8271a11719550dec13cc6254aab4db5c94d (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
-----------------------------------------------------------------------

Summary of changes:
 .kdev4/x2godesktopsharing-3.0.1.kdev4 |    2 +
 debian/changelog                      |    6 +
 debian/control                        |    2 +-
 debian/{postinst.ex =&gt; postinst}      |    6 +-
 listdialog.o                          |  Bin 9624 -&gt; 0 bytes
 main.cpp                              |   61 ++++--
 moc_listdialog.o                      |  Bin 9480 -&gt; 0 bytes
 sharetray.cpp                         |  375 ++++++++++++++++++---------------
 x2godesktopsharing-3.0.1.kdev4        |    3 +
 x2godesktopsharing.kdevelop.pcs       |  Bin 42767 -&gt; 43380 bytes
 x2godesktopsharing.kdevses            |   16 +-
 11 files changed, 264 insertions(+), 207 deletions(-)
 create mode 100644 .kdev4/x2godesktopsharing-3.0.1.kdev4
 copy debian/{postinst.ex =&gt; postinst} (88%)
 mode change 100644 =&gt; 100755
 delete mode 100644 listdialog.o
 delete mode 100644 moc_listdialog.o
 create mode 100644 x2godesktopsharing-3.0.1.kdev4

The diff of changes is:
diff --git a/.kdev4/x2godesktopsharing-3.0.1.kdev4 b/.kdev4/x2godesktopsharing-3.0.1.kdev4
new file mode 100644
index 0000000..df7eacc
--- /dev/null
+++ b/.kdev4/x2godesktopsharing-3.0.1.kdev4
@@ -0,0 +1,2 @@
+[Buildset]
+BuildItems=@Variant(\x00\x00\x00\t\x00\x00\x00\x00\x01\x00\x00\x00\x0b\x00\x00\x00\x00\x01\x00\x00\x000\x00x\x002\x00g\x00o\x00d\x00e\x00s\x00k\x00t\x00o\x00p\x00s\x00h\x00a\x00r\x00i\x00n\x00g\x00-\x003\x00.\x000\x00.\x001)
diff --git a/debian/changelog b/debian/changelog
index 0bf8011..48c9103 100644
--- a/debian/changelog
+++ b/debian/changelog
@@ -1,3 +1,9 @@
+x2godesktopsharing (3.0.1-2) unstable; urgency=low
+
+  * adapted to work with x2goserver-3.1
+
+ -- Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;  Tue, 25 Jan 2011 16:43:58 +0100
+
 x2godesktopsharing (3.0.1-1) unstable; urgency=low
 
   * Initial release (Closes: #nnnn)  &lt;nnnn is the bug number of your ITP&gt;
diff --git a/debian/control b/debian/control
index 58c1fb6..3ce86a1 100644
--- a/debian/control
+++ b/debian/control
@@ -7,7 +7,7 @@ Standards-Version: 3.7.2
 
 Package: x2godesktopsharing
 Architecture: any
-Depends: ${misc:Depends}, x2goserver, libqt4-gui
+Depends: ${misc:Depends}, x2goserver (&gt;= 3.0.99), libqt4-gui
 Recommends:
 Description: x2godesktopsharing
  x2go is a serverbased computing environment with
diff --git a/debian/postinst.ex b/debian/postinst
old mode 100644
new mode 100755
similarity index 88%
copy from debian/postinst.ex
copy to debian/postinst
index 01310e0..dd56409
--- a/debian/postinst.ex
+++ b/debian/postinst
@@ -3,7 +3,6 @@
 #
 # see: dh_installdeb(1)
 
-set -e
 
 # summary of how this script can be called:
 #        * &lt;postinst&gt; `configure' &lt;most-recently-configured-version&gt;
@@ -20,6 +19,11 @@ set -e
 
 case &quot;$1&quot; in
     configure)
+    X2GOGRP=`getent group | grep x2gousers`
+    if [ &quot;$X2GOGRP&quot; == &quot;&quot; ]
+    then 
+         addgroup --system x2gousers
+    fi
     ;;
 
     abort-upgrade|abort-remove|abort-deconfigure)
diff --git a/listdialog.o b/listdialog.o
deleted file mode 100644
index 0f6a01d..0000000
Binary files a/listdialog.o and /dev/null differ
diff --git a/main.cpp b/main.cpp
index eeed122..636c43c 100644
--- a/main.cpp
+++ b/main.cpp
@@ -30,37 +30,52 @@
 
 using namespace std;
 
-void  client(QString cmd)
+void  client ( const QStringList &amp; cmd )
 {
-    cerr&lt;&lt;&quot;starting in client mode, cmd: &quot;&lt;&lt;
-    cmd.toAscii().data()&lt;&lt;std::endl;
-    QString dispname=getenv(&quot;DISPLAY&quot;);
-    QString socketName=QDir::tempPath()+&quot;/x2godesktopsharing_@&quot;+
-                getenv(&quot;LOGNAME&quot;)+&quot;@&quot;+dispname;
-    
+
+    if ( cmd.size() !=10 )
+    {
+        cerr&lt;&lt;&quot;wrong parameters&quot;&lt;&lt;endl;
+        cout&lt;&lt;&quot;DEN&quot;;
+	return;
+    }
+    QStringList params=cmd[9].split ( &quot;XSHAD&quot; );
+    if ( params.size() !=3 )
+    {
+        cerr&lt;&lt;&quot;wrong parameters&quot;&lt;&lt;endl;
+        cout&lt;&lt;&quot;DEN&quot;;
+	return;
+    }
+
+    cerr&lt;&lt;&quot;starting x2godesktopsharing in client mode, cmd: &quot;&lt;&lt;
+        cmd.join(&quot; &quot;).toAscii().data() &lt;&lt;std::endl;
+
+    QString dispname=params[2];
+    QString socketName=QDir::tempPath() +&quot;/x2godesktopsharing_@&quot;+
+                       params[1]+&quot;@&quot;+dispname;
     QLocalSocket sock;
     sock.connectToServer ( socketName );
     if ( !sock.waitForConnected ( 3000 ) )
     {
         QString message=&quot;Unable to connect: &quot; +socketName;
-        cout&lt;&lt;message.toAscii().data() &lt;&lt;endl;
+        cout&lt;&lt;&quot;DEN&quot;;
         cerr&lt;&lt;message.toAscii().data() &lt;&lt;endl;
-        exit ( -1 );
+	return;
     }
-    sock.write ( cmd.toAscii().data(),cmd.toAscii().length() );
+    sock.write ( cmd.join(&quot; &quot;).toAscii().data(),cmd.join(&quot; &quot;).toAscii().length() );
     if ( !sock.waitForReadyRead() )
     {
-        cout&lt;&lt;&quot;Cannot write to socket: &quot; &lt;&lt;socketName.toAscii().data()&lt;&lt;endl;
-        cerr&lt;&lt;&quot;Cannot write to socket: &quot;&lt;&lt;socketName.toAscii().data()&lt;&lt;endl;
-        exit ( -1 );
+        cout&lt;&lt;&quot;DEN&quot;;
+        cerr&lt;&lt;&quot;Cannot write to socket: &quot;&lt;&lt;socketName.toAscii().data() &lt;&lt;endl;
+        return;;
     }
     char buffer[256];
     int read=sock.read ( buffer,255 );
     if ( read&lt;=0 )
     {
-        cout&lt;&lt;&quot;Cannot read from socket: &quot; &lt;&lt;socketName.toAscii().data()&lt;&lt;endl;
-        cerr&lt;&lt;&quot;Cannot read from socket: &quot; &lt;&lt;socketName.toAscii().data()&lt;&lt;endl;
-        exit ( -1 );
+        cout&lt;&lt;&quot;DEN&quot;;
+        cerr&lt;&lt;&quot;Cannot read from socket: &quot; &lt;&lt;socketName.toAscii().data() &lt;&lt;endl;
+        return;    
     }
     buffer[read]=0;
     cout&lt;&lt;buffer&lt;&lt;endl;
@@ -68,19 +83,19 @@ void  client(QString cmd)
 
 int main ( int argc, char *argv[] )
 {
-    if (argc&gt;2)
+    if ( argc&gt;2 )
     {
         QString par=argv[1];
-        if (par == &quot;client&quot;)
+        if ( par == &quot;client&quot; )
         {
             QStringList cmdl;
-            for (int i=2; i&lt;argc;++i)
+            for ( int i=2; i&lt;argc;++i )
                 cmdl&lt;&lt;argv[i];
-            client(cmdl.join(&quot; &quot;));
+            client ( cmdl );
             return 0;
         }
     }
-    
+
     QApplication app ( argc,argv );
     QTranslator translator;
     QString filename=QString ( &quot;:/x2godesktopsharing_%1&quot; ).arg (
@@ -106,7 +121,7 @@ int main ( int argc, char *argv[] )
         app.installTranslator ( &amp;qtTranslator );
     ShareTray* tray=new ShareTray;
     tray-&gt;hide();
-    
-    
+
+
     return app.exec();
 }
diff --git a/moc_listdialog.o b/moc_listdialog.o
deleted file mode 100644
index 0e7d9ee..0000000
Binary files a/moc_listdialog.o and /dev/null differ
diff --git a/sharetray.cpp b/sharetray.cpp
index 5ed3626..541b50c 100644
--- a/sharetray.cpp
+++ b/sharetray.cpp
@@ -29,7 +29,8 @@
 #include &lt;QSystemTrayIcon&gt;
 #include &lt;QCloseEvent&gt;
 #include &lt;QDateTime&gt;
-
+#include &lt;grp.h&gt;
+#include &lt;QProcess&gt;
 #define STAT_ACT_COUNT 10
 
 #define VERSION &quot;3.0.1-1&quot;
@@ -41,96 +42,96 @@ ShareTray::ShareTray()
     menuClose=false;
     current_list=BLACK;
 
-    ui.setupUi(this);
-    ui.box-&gt;setSelectionMode(QAbstractItemView::ExtendedSelection);
+    ui.setupUi ( this );
+    ui.box-&gt;setSelectionMode ( QAbstractItemView::ExtendedSelection );
 
-    connect(ui.close_box,SIGNAL(clicked(QAbstractButton*)),
-            SLOT(slotMsgClose(QAbstractButton*)));
+    connect ( ui.close_box,SIGNAL ( clicked ( QAbstractButton* ) ),
+              SLOT ( slotMsgClose ( QAbstractButton* ) ) );
 
-    connect(ui.ok_cancel_box,SIGNAL(clicked(QAbstractButton*)),
-            SLOT(slotMsgOkCancel(QAbstractButton*)));
+    connect ( ui.ok_cancel_box,SIGNAL ( clicked ( QAbstractButton* ) ),
+              SLOT ( slotMsgOkCancel ( QAbstractButton* ) ) );
 
-    connect(ui.del,SIGNAL(clicked()),
-            SLOT(slotDelListItem()));
+    connect ( ui.del,SIGNAL ( clicked() ),
+              SLOT ( slotDelListItem() ) );
 
-    ui.icon-&gt;setPixmap(QPixmap(&quot;:icons/128x128/x2godesktopsharing.png&quot;));
+    ui.icon-&gt;setPixmap ( QPixmap ( &quot;:icons/128x128/x2godesktopsharing.png&quot; ) );
 
-    ui.text-&gt;setText(tr ( &quot;&lt;b&gt;X2GO DesktopSharing V. &quot; ) +VERSION+
-                     &quot; &lt;/b &gt;(Qt - &quot;+qVersion() +&quot;)&quot;+
-                     ui.text-&gt;text());
+    ui.text-&gt;setText ( tr ( &quot;&lt;b&gt;X2GO DesktopSharing V. &quot; ) +VERSION+
+                       &quot; &lt;/b &gt;(Qt - &quot;+qVersion() +&quot;)&quot;+
+                       ui.text-&gt;text() );
 
-    setWindowFlags(Qt::Dialog);
+    setWindowFlags ( Qt::Dialog );
     Qt::WindowFlags flags=windowFlags();
     flags&amp;= ~Qt::WindowTitleHint;
-    setWindowFlags(flags);
-
-    QString dispname=getenv(&quot;DISPLAY&quot;);
-    socketFname=QDir::tempPath()+&quot;/x2godesktopsharing_@&quot;+
-                getenv(&quot;LOGNAME&quot;)+&quot;@&quot;+dispname;
-    lockFname=QDir::tempPath()+&quot;/x2godesktopsharing.lock_&quot;+
-              getenv(&quot;LOGNAME&quot;)+&quot;@&quot;+dispname;
-    if (QFile::exists(lockFname))
+    setWindowFlags ( flags );
+
+    QString dispname=getenv ( &quot;DISPLAY&quot; );
+    socketFname=QDir::tempPath() +&quot;/x2godesktopsharing_@&quot;+
+                getenv ( &quot;LOGNAME&quot; ) +&quot;@&quot;+dispname;
+    lockFname=QDir::tempPath() +&quot;/x2godesktopsharing.lock_&quot;+
+              getenv ( &quot;LOGNAME&quot; ) +&quot;@&quot;+dispname;
+    if ( QFile::exists ( lockFname ) )
     {
-        QFile file(lockFname);
-        if (file.open(QIODevice::ReadOnly | QIODevice::Text))
+        QFile file ( lockFname );
+        if ( file.open ( QIODevice::ReadOnly | QIODevice::Text ) )
         {
-            QTextStream in(&amp;file);
-            if (!in.atEnd())
+            QTextStream in ( &amp;file );
+            if ( !in.atEnd() )
             {
                 QString line = in.readLine();
                 file.close();
-                if (abs(line.toUInt() -
-                        QDateTime::currentDateTime().toTime_t())&lt;5)
+                if ( abs ( line.toUInt() -
+                           QDateTime::currentDateTime().toTime_t() ) &lt;5 )
                 {
 
-                    QString message=QString(
-                                        tr(
+                    QString message=QString (
+                                        tr (
                                             &quot;X2Go desktop sharing application &quot;
                                             &quot;is already active for this &quot;
                                             &quot;display \n&quot;
                                             &quot;if this application is no longer &quot;
                                             &quot;running, remove %1\n&quot;
-                                            &quot;and start again&quot;)).arg(lockFname);
+                                            &quot;and start again&quot; ) ).arg ( lockFname );
                     QMessageBox::critical ( 0l,tr (
                                                 &quot;Error&quot; ),message,
                                             QMessageBox::Ok,
                                             QMessageBox::NoButton );
-                    exit (-1);
+                    exit ( -1 );
                 }
             }
         }
-        QFile::remove(lockFname);
+        QFile::remove ( lockFname );
     }
-    if (QFile::exists(socketFname))
-        QFile::remove(socketFname);
-
-    QTimer *lockTimer = new QTimer(this);
-    connect(lockTimer, SIGNAL(timeout()), this, SLOT(slotUpdateLockFile()));
-    lockTimer-&gt;start(3000);
-    trayIcon=new QSystemTrayIcon(this);
-    setWindowIcon(QIcon(&quot;:icons/22x22/x2godesktopsharing.png&quot;));
-    menu = new QMenu(this);
-    trayIcon-&gt;setContextMenu(menu);
-    trayIcon-&gt;setToolTip(tr(&quot;X2Go desktop sharing application&quot;));
+    if ( QFile::exists ( socketFname ) )
+        QFile::remove ( socketFname );
+
+    QTimer *lockTimer = new QTimer ( this );
+    connect ( lockTimer, SIGNAL ( timeout() ), this, SLOT ( slotUpdateLockFile() ) );
+    lockTimer-&gt;start ( 3000 );
+    trayIcon=new QSystemTrayIcon ( this );
+    setWindowIcon ( QIcon ( &quot;:icons/22x22/x2godesktopsharing.png&quot; ) );
+    menu = new QMenu ( this );
+    trayIcon-&gt;setContextMenu ( menu );
+    trayIcon-&gt;setToolTip ( tr ( &quot;X2Go desktop sharing application&quot; ) );
 
     menu-&gt;addSeparator();
 
-    actWhite = menu-&gt;addAction(QIcon (&quot;:icons/32x32/wlist.png&quot; ) ,
-                               tr(&quot;Granted users...&quot;));
-    actBlack = menu-&gt;addAction(QIcon (&quot;:icons/32x32/blist.png&quot; ) ,
-                               tr(&quot;Banned users...&quot;));
+    actWhite = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/wlist.png&quot; ) ,
+                                 tr ( &quot;Granted users...&quot; ) );
+    actBlack = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/blist.png&quot; ) ,
+                                 tr ( &quot;Banned users...&quot; ) );
     menu-&gt;addSeparator();
 
-    actStart = menu-&gt;addAction(QIcon (&quot;:icons/32x32/share.png&quot; ) ,
-                               tr(&quot;Activate desktop sharing&quot;));
+    actStart = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/share.png&quot; ) ,
+                                 tr ( &quot;Activate desktop sharing&quot; ) );
 
-    actStop = menu-&gt;addAction(QIcon (&quot;:icons/32x32/stop.png&quot; ) ,
-                              tr(&quot;Deactivate desktop sharing&quot;));
+    actStop = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/stop.png&quot; ) ,
+                                tr ( &quot;Deactivate desktop sharing&quot; ) );
 
     menu-&gt;addSeparator();
-    QAction* actAbout=menu-&gt;addAction(
-                          QIcon (&quot;:icons/32x32/x2godesktopsharing.png&quot; ),
-                          tr(&quot;About X2GO Sharing&quot;));
+    QAction* actAbout=menu-&gt;addAction (
+                          QIcon ( &quot;:icons/32x32/x2godesktopsharing.png&quot; ),
+                          tr ( &quot;About X2GO Sharing&quot; ) );
 //
 //     QAction* actAboutQt=menu-&gt;addAction(
 //                              tr(&quot;About Qt&quot;));
@@ -142,8 +143,8 @@ ShareTray::ShareTray()
 
 
     menu-&gt;addSeparator();
-    QAction* actExit = menu-&gt;addAction(QIcon (&quot;:icons/32x32/exit.png&quot; ) ,
-                                       tr(&quot;&amp;Quit&quot;));
+    QAction* actExit = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/exit.png&quot; ) ,
+                                         tr ( &quot;&amp;Quit&quot; ) );
 
     connect ( actWhite,SIGNAL ( triggered ( bool ) ),this,
               SLOT ( slotWhiteList() ) );
@@ -162,11 +163,11 @@ ShareTray::ShareTray()
 
 
 
-    actStop-&gt;setEnabled(false);
+    actStop-&gt;setEnabled ( false );
 
-    QTimer *timer = new QTimer(this);
-    connect(timer, SIGNAL(timeout()), this, SLOT(slotTimer()));
-    timer-&gt;start(5000);
+    QTimer *timer = new QTimer ( this );
+    connect ( timer, SIGNAL ( timeout() ), this, SLOT ( slotTimer() ) );
+    timer-&gt;start ( 5000 );
     loadSettings();
     setTrayIcon();
     trayIcon-&gt;show();
@@ -176,45 +177,47 @@ ShareTray::ShareTray()
 ShareTray::~ShareTray()
 {
     slotStopSharing();
-    if (QFile::exists(lockFname))
-        QFile::remove(lockFname);
+    if ( QFile::exists ( lockFname ) )
+        QFile::remove ( lockFname );
     saveSettings();
 }
 
 
 void ShareTray::slotStopSharing()
 {
-    if (serverSocket)
+    if ( serverSocket )
     {
         serverSocket-&gt;close();
         delete serverSocket;
         serverSocket=0l;
     }
-    if (QFile::exists(socketFname))
-        QFile::remove(socketFname);
-    for (int i=menu-&gt;actions().count()-STAT_ACT_COUNT-1;i&gt;=0;--i)
+    if ( QFile::exists ( socketFname ) )
+        QFile::remove ( socketFname );
+    for ( int i=menu-&gt;actions().count()-STAT_ACT_COUNT-1;i&gt;=0;--i )
     {
-        slotCloseConnection((AccessAction*)(menu-&gt;actions()[i]));
+        slotCloseConnection ( ( AccessAction* ) ( menu-&gt;actions() [i] ) );
     }
-    actStop-&gt;setEnabled(false);
-    actStart-&gt;setEnabled(true);
+    actStop-&gt;setEnabled ( false );
+    actStart-&gt;setEnabled ( true );
     setTrayIcon();
 }
 
 
 void ShareTray::slotStartSharing()
 {
-    actStop-&gt;setEnabled(true);
-    actStart-&gt;setEnabled(false);
-    if (serverSocket)
+    actStop-&gt;setEnabled ( true );
+    actStart-&gt;setEnabled ( false );
+    if ( serverSocket )
         delete serverSocket;
-    if (QFile::exists(socketFname))
-        QFile::remove(socketFname);
-    serverSocket=new QLocalServer(this);
-    if ( serverSocket-&gt;listen ( socketFname) )
+    if ( QFile::exists ( socketFname ) )
+        QFile::remove ( socketFname );
+    serverSocket=new QLocalServer ( this );
+    if ( serverSocket-&gt;listen ( socketFname ) )
     {
-        QFile::setPermissions (socketFname,
-                               QFile::ReadOwner|QFile::WriteOwner );
+
+        chown ( socketFname.toAscii(),getuid(),getgrnam ( &quot;x2gousers&quot; )-&gt;gr_gid );
+        QFile::setPermissions ( socketFname,
+                                QFile::ReadOwner|QFile::WriteOwner|QFile::ReadGroup|QFile::WriteGroup );
         connect ( serverSocket,SIGNAL ( newConnection() ),
                   this,SLOT ( slotServerConnection() ) );
     }
@@ -237,133 +240,157 @@ bool ShareTray::acceptConnections()
     return actStop-&gt;isEnabled();
 }
 
-QString ShareTray::getSocketAnswer(QString message)
+QString ShareTray::getSocketAnswer ( QString message )
 {
-    QStringList lst=message.split(' ');
-    if (lst[0] == &quot;ACCESS&quot;)
+    qDebug() &lt;&lt;&quot;message: &quot;&lt;&lt;message;
+    QStringList lst=message.split ( ' ' );
+    if ( lst.size() !=10 )
     {
-        if (getAccess(lst[1],lst[2])==QMessageBox::Yes)
-        {
-            trayMessage(tr(&quot;Access granted&quot;),QString(
-                            tr(
-                                &quot;%1(%2): access granted&quot;)).arg(
-                            lst[1]).arg(lst[2]));
-            return &quot;GRANT&quot;;
-        }
-        trayMessage(tr(&quot;Access denied&quot;),QString(
-                        tr(&quot;%1(%2): access denied&quot;)).arg(lst[1]).arg(lst[2]));
+        qDebug() &lt;&lt;&quot;wrong parameters&quot;;
+        return &quot;DENY&quot;;
+    }
+    QStringList params=lst[9].split ( &quot;XSHAD&quot; );
+    if ( params.size() !=3 )
+    {
+        qDebug() &lt;&lt;&quot;wrong parameters&quot;;
         return &quot;DENY&quot;;
     }
-    if (lst[0] == &quot;AGENT&quot;)
+    QString client=lst[0];
+    QString user=params[1];
+    if ( getAccess ( user,client ) ==QMessageBox::Yes )
     {
-        AccessAction *act=new AccessAction(
-            lst[1],lst[2],lst[3],
-            QString(tr(&quot;Disconnect %1(%2)&quot;)).arg(lst[2]).arg(lst[3]),
-            this);
-        menu-&gt;insertAction(menu-&gt;actions()[0],act);
-        connect(act,SIGNAL(actionActivated( AccessAction* )),this,
-                SLOT(slotCloseConnection( AccessAction* )));
-        trayMessage(tr(&quot;Remote connection&quot;),
-                    QString(
-                        tr(&quot;%1(%2) connected&quot;)).arg(lst[2]).arg(lst[3]));
-        setTrayIcon();
-        return &quot;OK&quot;;
+        trayMessage ( tr ( &quot;Access granted&quot; ),QString (
+                          tr (
+                              &quot;%1(%2): access granted&quot; ) ).arg (
+                          user ).arg ( client ) );
+        //start agent
+        QProcess proc ( this );
+        lst.removeAt ( 0 );;
+        proc.start ( &quot;x2gostartagent&quot;,lst );
+        if ( !proc.waitForFinished ( 5000 ) )
+        {
+            return &quot;DENY&quot;;
+        }
+        else
+        {
+            QString output=proc.readAllStandardOutput();
+            qDebug() &lt;&lt;&quot;agent out: &quot;&lt;&lt;output;
+            QStringList lines=output.split ( &quot;\n&quot; );
+            QString pid=&quot;pid&quot;;
+            if ( lines.size() &gt;3 )
+                pid=lines[2];
+            qDebug() &lt;&lt;&quot;agent pid: &quot;&lt;&lt;pid;
+            AccessAction *act=new AccessAction (
+                pid,user,client,
+                QString ( tr ( &quot;Disconnect %1(%2)&quot; ) ).arg ( user ).arg ( client ),
+                this );
+            menu-&gt;insertAction ( menu-&gt;actions() [0],act );
+            connect ( act,SIGNAL ( actionActivated ( AccessAction* ) ),this,
+                      SLOT ( slotCloseConnection ( AccessAction* ) ) );
+            trayMessage ( tr ( &quot;Remote connection&quot; ),
+                          QString (
+                              tr ( &quot;%1(%2) connected&quot; ) ).arg ( user ).arg ( client ) );
+            setTrayIcon();
+            return output;
+        }
     }
-    return &quot;ERROR&quot;;
+    trayMessage ( tr ( &quot;Access denied&quot; ),QString (
+                      tr ( &quot;%1(%2): access denied&quot; ) ).arg ( params[1] ).arg ( client ) );
+    return &quot;DENY&quot;;
 }
 
-void ShareTray::closeSocket(SimpleLocalSocket* sock)
+void ShareTray::closeSocket ( SimpleLocalSocket* sock )
 {
-    qDebug()&lt;&lt;&quot;closing null socket&quot;;
-    if (sock)
+    qDebug() &lt;&lt;&quot;closing null socket&quot;;
+    if ( sock )
     {
-        qDebug()&lt;&lt;&quot;closing socket&quot;;
+        qDebug() &lt;&lt;&quot;closing socket&quot;;
         delete sock;
-        qDebug()&lt;&lt;&quot;done&quot;;
+        qDebug() &lt;&lt;&quot;done&quot;;
     }
 }
 
 void ShareTray::slotServerConnection()
 {
-    new SimpleLocalSocket(this,serverSocket-&gt;nextPendingConnection());
+    new SimpleLocalSocket ( this,serverSocket-&gt;nextPendingConnection() );
 }
 
-void ShareTray::slotCloseConnection(AccessAction* action)
+void ShareTray::slotCloseConnection ( AccessAction* action )
 {
-    kill(action-&gt;pid().toUInt(),15);
-    menu-&gt;removeAction(action);
+    kill ( action-&gt;pid().toUInt(),15 );
+    menu-&gt;removeAction ( action );
     delete action;
     setTrayIcon();
 }
 
 
-int ShareTray::getAccess(QString user, QString host)
+int ShareTray::getAccess ( QString user, QString host )
 {
-    if (whiteList.contains(user))
+    if ( whiteList.contains ( user ) )
         return QMessageBox::Yes;
-    if (blackList.contains(user))
+    if ( blackList.contains ( user ) )
         return QMessageBox::No;
 
-    MessageBox m(user,host, this);
+    MessageBox m ( user,host, this );
     m.activateWindow();
     m.raise();
     int res=m.exec();
-    if (m.isChecked()&amp;&amp;res==QMessageBox::Yes)
+    if ( m.isChecked() &amp;&amp;res==QMessageBox::Yes )
         whiteList&lt;&lt;user;
-    if (m.isChecked()&amp;&amp;res==QMessageBox::No)
+    if ( m.isChecked() &amp;&amp;res==QMessageBox::No )
         blackList&lt;&lt;user;
-    actBlack-&gt;setEnabled(blackList.size()&gt;0);
-    actWhite-&gt;setEnabled(whiteList.size()&gt;0);
+    actBlack-&gt;setEnabled ( blackList.size() &gt;0 );
+    actWhite-&gt;setEnabled ( whiteList.size() &gt;0 );
     return res;
 }
 
-void ShareTray::closeEvent ( QCloseEvent*  ev)
+void ShareTray::closeEvent ( QCloseEvent*  ev )
 {
-    if (!menuClose)
+    if ( !menuClose )
     {
         ev-&gt;ignore();
         hide();
         return;
     }
     slotStopSharing();
-    if (QFile::exists(lockFname))
-        QFile::remove(lockFname);
+    if ( QFile::exists ( lockFname ) )
+        QFile::remove ( lockFname );
     saveSettings();
 }
 
 void ShareTray::slotTimer()
 {
-    for (int i=menu-&gt;actions().count()-STAT_ACT_COUNT-1;i&gt;=0;--i)
+    for ( int i=menu-&gt;actions().count()-STAT_ACT_COUNT-1;i&gt;=0;--i )
     {
-        AccessAction* action=(AccessAction*)(menu-&gt;actions()[i]);
-        if (!isProcessRunning(action-&gt;pid()))
+        AccessAction* action= ( AccessAction* ) ( menu-&gt;actions() [i] );
+        if ( !isProcessRunning ( action-&gt;pid() ) )
         {
-            trayMessage(tr(&quot;User disconnected&quot;),
-                        QString(
-                            tr(&quot;%1(%2) disconnected&quot;)).arg(
-                            action-&gt;user()).arg(action-&gt;host()));
-            menu-&gt;removeAction(action);
+            trayMessage ( tr ( &quot;User disconnected&quot; ),
+                          QString (
+                              tr ( &quot;%1(%2) disconnected&quot; ) ).arg (
+                              action-&gt;user() ).arg ( action-&gt;host() ) );
+            menu-&gt;removeAction ( action );
             delete action;
         }
     }
     setTrayIcon();
 }
 
-void ShareTray::trayMessage(QString title, QString text)
+void ShareTray::trayMessage ( QString title, QString text )
 {
-    if (!QSystemTrayIcon::supportsMessages ())
-        QToolTip::showText(geometry().topLeft(),
-                           text);
+    if ( !QSystemTrayIcon::supportsMessages () )
+        QToolTip::showText ( geometry().topLeft(),
+                             text );
     else
-        trayIcon-&gt;showMessage(title,text);
+        trayIcon-&gt;showMessage ( title,text );
 }
 
 
-bool ShareTray::isProcessRunning(QString pid)
+bool ShareTray::isProcessRunning ( QString pid )
 {
-    if (kill(pid.toInt(),SIGCONT)==-1)
+    if ( kill ( pid.toInt(),SIGCONT ) ==-1 )
     {
-        if (errno==ESRCH)
+        if ( errno==ESRCH )
         {
             return false;
         }
@@ -376,7 +403,7 @@ void ShareTray::slotBlackList()
 {
     current_list=BLACK;
     showList();
-    setWindowTitle(tr(&quot;Banned users&quot;));
+    setWindowTitle ( tr ( &quot;Banned users&quot; ) );
 
 }
 
@@ -384,7 +411,7 @@ void ShareTray::slotWhiteList()
 {
     current_list=WHITE;
     showList();
-    setWindowTitle(tr(&quot;Granted users&quot;));
+    setWindowTitle ( tr ( &quot;Granted users&quot; ) );
 
 }
 
@@ -400,13 +427,13 @@ void ShareTray::showList()
     ui.text-&gt;hide();
 
     QStringList* lst;
-    if (current_list==BLACK)
+    if ( current_list==BLACK )
         lst=&blackList;
     else
         lst=&whiteList;
     lst-&gt;sort();
     ui.box-&gt;clear();
-    ui.box-&gt;insertItems(0,*lst);
+    ui.box-&gt;insertItems ( 0,*lst );
 }
 
 void ShareTray::loadSettings()
@@ -414,11 +441,11 @@ void ShareTray::loadSettings()
     QSettings st ( QDir::homePath() +&quot;/.x2godesktopshare/settings&quot;,
                    QSettings::NativeFormat );
 
-    blackList= st.value(&quot;blacklist&quot;).toStringList();
-    whiteList= st.value(&quot;whitelist&quot;).toStringList();
+    blackList= st.value ( &quot;blacklist&quot; ).toStringList();
+    whiteList= st.value ( &quot;whitelist&quot; ).toStringList();
 
-    actBlack-&gt;setEnabled(blackList.size()&gt;0);
-    actWhite-&gt;setEnabled(whiteList.size()&gt;0);
+    actBlack-&gt;setEnabled ( blackList.size() &gt;0 );
+    actWhite-&gt;setEnabled ( whiteList.size() &gt;0 );
 }
 
 void ShareTray::saveSettings()
@@ -426,31 +453,31 @@ void ShareTray::saveSettings()
     QSettings st ( QDir::homePath() +&quot;/.x2godesktopshare/settings&quot;,
                    QSettings::NativeFormat );
 
-    st.setValue(&quot;blacklist&quot;,blackList);
-    st.setValue(&quot;whitelist&quot;,whiteList);
+    st.setValue ( &quot;blacklist&quot;,blackList );
+    st.setValue ( &quot;whitelist&quot;,whiteList );
 }
 
 
 void ShareTray::setTrayIcon()
 {
-    if (!acceptConnections())
+    if ( !acceptConnections() )
     {
-        trayIcon-&gt;setIcon(QIcon(&quot;:icons/22x22/discard.png&quot;));
+        trayIcon-&gt;setIcon ( QIcon ( &quot;:icons/22x22/discard.png&quot; ) );
         return;
     }
-    if (menu-&gt;actions().count()&gt;STAT_ACT_COUNT)
+    if ( menu-&gt;actions().count() &gt;STAT_ACT_COUNT )
     {
-        trayIcon-&gt;setIcon(QIcon(&quot;:icons/22x22/view.png&quot;));
+        trayIcon-&gt;setIcon ( QIcon ( &quot;:icons/22x22/view.png&quot; ) );
         return;
     }
-    trayIcon-&gt;setIcon(QIcon(&quot;:icons/22x22/accept.png&quot;));
+    trayIcon-&gt;setIcon ( QIcon ( &quot;:icons/22x22/accept.png&quot; ) );
 }
 
 
 
 void ShareTray::slotAbout()
 {
-    setWindowTitle(tr(&quot;X2Go Desktop Sharing&quot;));
+    setWindowTitle ( tr ( &quot;X2Go Desktop Sharing&quot; ) );
 
     show();
     ui.ok_cancel_box-&gt;hide();
@@ -468,39 +495,39 @@ void ShareTray::slotAboutQt()
     QMessageBox::aboutQt ( 0 );
 }
 
-void ShareTray::slotMsgOkCancel(QAbstractButton* button)
+void ShareTray::slotMsgOkCancel ( QAbstractButton* button )
 {
-    if (ui.ok_cancel_box-&gt;buttonRole(button)==QDialogButtonBox::AcceptRole)
+    if ( ui.ok_cancel_box-&gt;buttonRole ( button ) ==QDialogButtonBox::AcceptRole )
     {
         QStringList* lst;
-        if (current_list==BLACK)
+        if ( current_list==BLACK )
             lst=&blackList;
         else
             lst=&whiteList;
         lst-&gt;clear();
-        for (int i=ui.box-&gt;count()-1;i&gt;=0;--i)
+        for ( int i=ui.box-&gt;count()-1;i&gt;=0;--i )
         {
-            *lst&lt;&lt;ui.box-&gt;item(i)-&gt;text();
+            *lst&lt;&lt;ui.box-&gt;item ( i )-&gt;text();
         }
     }
-    actBlack-&gt;setEnabled(blackList.size()&gt;0);
-    actWhite-&gt;setEnabled(whiteList.size()&gt;0);
+    actBlack-&gt;setEnabled ( blackList.size() &gt;0 );
+    actWhite-&gt;setEnabled ( whiteList.size() &gt;0 );
     hide();
 }
 
-void ShareTray::slotMsgClose(QAbstractButton*)
+void ShareTray::slotMsgClose ( QAbstractButton* )
 {
     hide();
 }
 
 void ShareTray::slotDelListItem()
 {
-    for (int i=ui.box-&gt;count()-1;i&gt;=0;--i)
+    for ( int i=ui.box-&gt;count()-1;i&gt;=0;--i )
     {
-        QListWidgetItem* it=ui.box-&gt;item(i);
-        if (it-&gt;isSelected())
+        QListWidgetItem* it=ui.box-&gt;item ( i );
+        if ( it-&gt;isSelected() )
         {
-            ui.box-&gt;takeItem(i);
+            ui.box-&gt;takeItem ( i );
             delete it;
         }
     }
@@ -516,10 +543,10 @@ void ShareTray::slotMenuClose()
 
 void ShareTray::slotUpdateLockFile()
 {
-    QFile file(lockFname);
-    if (file.open(QIODevice::WriteOnly | QIODevice::Text))
+    QFile file ( lockFname );
+    if ( file.open ( QIODevice::WriteOnly | QIODevice::Text ) )
     {
-        QTextStream out(&amp;file);
+        QTextStream out ( &amp;file );
         out&lt;&lt;QDateTime::currentDateTime().toTime_t();
     }
 }
diff --git a/x2godesktopsharing-3.0.1.kdev4 b/x2godesktopsharing-3.0.1.kdev4
new file mode 100644
index 0000000..70f84e2
--- /dev/null
+++ b/x2godesktopsharing-3.0.1.kdev4
@@ -0,0 +1,3 @@
+[Project]
+Manager=KDevCustomMakeManager
+Name=x2godesktopsharing-3.0.1
diff --git a/x2godesktopsharing.kdevelop.pcs b/x2godesktopsharing.kdevelop.pcs
index c4ebe00..a6fd93a 100644
Binary files a/x2godesktopsharing.kdevelop.pcs and b/x2godesktopsharing.kdevelop.pcs differ
diff --git a/x2godesktopsharing.kdevses b/x2godesktopsharing.kdevses
index a6aab76..0dddff4 100644
--- a/x2godesktopsharing.kdevses
+++ b/x2godesktopsharing.kdevses
@@ -3,21 +3,21 @@
 &lt;KDevPrjSession&gt;
  &lt;DocsAndViews NumberOfDocuments=&quot;6&quot; &gt;
   &lt;Doc0 NumberOfViews=&quot;1&quot; URL=&quot;<A HREF="file:///usr/src.cur/db-builds/x2godesktopsharing/x2godesktopsharing-3.0.1/sharetray.cpp">file:///usr/src.cur/db-builds/x2godesktopsharing/x2godesktopsharing-3.0.1/sharetray.cpp</A>&quot; &gt;
-   &lt;View0 Encoding=&quot;&quot; line=&quot;427&quot; Type=&quot;Source&quot; /&gt;
+   &lt;View0 Encoding=&quot;&quot; Type=&quot;Source&quot; /&gt;
   &lt;/Doc0&gt;
-  &lt;Doc1 NumberOfViews=&quot;1&quot; URL=&quot;<A HREF="file:///usr/share/doc/qt3-doc/html/qaxserver-example-simple.html">file:///usr/share/doc/qt3-doc/html/qaxserver-example-simple.html</A>&quot; &gt;
+  &lt;Doc1 NumberOfViews=&quot;1&quot; URL=&quot;<A HREF="file:///usr/share/doc/qt4-doc/html/qtimer.html">file:///usr/share/doc/qt4-doc/html/qtimer.html</A>&quot; &gt;
    &lt;View0 Type=&quot;Documentation&quot; /&gt;
   &lt;/Doc1&gt;
-  &lt;Doc2 NumberOfViews=&quot;1&quot; URL=&quot;<A HREF="file:///usr/share/doc/qt4-doc/html/qdialogbuttonbox.html#ButtonRole-enum">file:///usr/share/doc/qt4-doc/html/qdialogbuttonbox.html#ButtonRole-enum</A>&quot; &gt;
-   &lt;View0 Type=&quot;Documentation&quot; /&gt;
-  &lt;/Doc2&gt;
-  &lt;Doc3 NumberOfViews=&quot;1&quot; URL=&quot;<A HREF="file:///usr/src.cur/db-builds/x2godesktopsharing/x2godesktopsharing-3.0.1/sharetray.h">file:///usr/src.cur/db-builds/x2godesktopsharing/x2godesktopsharing-3.0.1/sharetray.h</A>&quot; &gt;
+  &lt;Doc2 NumberOfViews=&quot;1&quot; URL=&quot;<A HREF="file:///usr/src.cur/db-builds/x2godesktopsharing/x2godesktopsharing-3.0.1/sharetray.h">file:///usr/src.cur/db-builds/x2godesktopsharing/x2godesktopsharing-3.0.1/sharetray.h</A>&quot; &gt;
    &lt;View0 Encoding=&quot;&quot; Type=&quot;Source&quot; /&gt;
+  &lt;/Doc2&gt;
+  &lt;Doc3 NumberOfViews=&quot;1&quot; URL=&quot;<A HREF="file:///usr/share/doc/qt4-doc/html/qgraphicslayout.html">file:///usr/share/doc/qt4-doc/html/qgraphicslayout.html</A>&quot; &gt;
+   &lt;View0 Type=&quot;Documentation&quot; /&gt;
   &lt;/Doc3&gt;
-  &lt;Doc4 NumberOfViews=&quot;1&quot; URL=&quot;<A HREF="file:///usr/share/doc/qt4-doc/html/qt.html#WindowType-enum">file:///usr/share/doc/qt4-doc/html/qt.html#WindowType-enum</A>&quot; &gt;
+  &lt;Doc4 NumberOfViews=&quot;1&quot; URL=&quot;<A HREF="file:///usr/share/doc/qt4-doc/html/qgraphicslinearlayout.html#addStretch">file:///usr/share/doc/qt4-doc/html/qgraphicslinearlayout.html#addStretch</A>&quot; &gt;
    &lt;View0 Type=&quot;Documentation&quot; /&gt;
   &lt;/Doc4&gt;
-  &lt;Doc5 NumberOfViews=&quot;1&quot; URL=&quot;<A HREF="file:///usr/share/doc/qt4-doc/html/examples.html#activeqt">file:///usr/share/doc/qt4-doc/html/examples.html#activeqt</A>&quot; &gt;
+  &lt;Doc5 NumberOfViews=&quot;1&quot; URL=&quot;<A HREF="file:///usr/share/doc/qt4-doc/html/qstring.html">file:///usr/share/doc/qt4-doc/html/qstring.html</A>&quot; &gt;
    &lt;View0 Type=&quot;Documentation&quot; /&gt;
   &lt;/Doc5&gt;
  &lt;/DocsAndViews&gt;


hooks/post-receive
-- 
x2godesktopsharing.git (Desktop Sharing for X2Go)

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;x2godesktopsharing.git&quot; (Desktop Sharing for X2Go).

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009182.html">[X2Go-Commits] x2godesktopsharing.git - build-main (branch)	created: 3.0.1-1
</A></li>
	<LI>Next message: <A HREF="009184.html">[X2Go-Commits] x2godesktopsharing.git - build-main (branch)	updated: 3.0.1-2-2-g7c19ae5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9183">[ date ]</a>
              <a href="thread.html#9183">[ thread ]</a>
              <a href="subject.html#9183">[ subject ]</a>
              <a href="author.html#9183">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/x2go-commits">More information about the X2Go-commits
mailing list</a><br>
</body></html>
