<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [X2go-Commits] x2goserver.git - master (branch) updated:	3.1.0.1-28-g2747cda
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/x2go-commits/2012-March/index.html" >
   <LINK REL="made" HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2go-Commits%5D%20x2goserver.git%20-%20master%20%28branch%29%20updated%3A%0A%093.1.0.1-28-g2747cda&In-Reply-To=%3C20120315230631.717EC5DB35%40ymir%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002507.html">
   <LINK REL="Next"  HREF="002509.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[X2go-Commits] x2goserver.git - master (branch) updated:	3.1.0.1-28-g2747cda</H1>
    <B>X2Go dev team</B> 
    <A HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2go-Commits%5D%20x2goserver.git%20-%20master%20%28branch%29%20updated%3A%0A%093.1.0.1-28-g2747cda&In-Reply-To=%3C20120315230631.717EC5DB35%40ymir%3E"
       TITLE="[X2go-Commits] x2goserver.git - master (branch) updated:	3.1.0.1-28-g2747cda">git-admin at x2go.org
       </A><BR>
    <I>Fri Mar 16 00:06:31 CET 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="002507.html">[X2go-Commits] x2goserver.git - master (branch) updated:	3.1.0.1-22-gbdf58be
</A></li>
        <LI>Next message: <A HREF="002509.html">[X2go-Commits] x2goserver.git - master (branch) updated:	3.1.0.1-29-g0cc560c
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2508">[ date ]</a>
              <a href="thread.html#2508">[ thread ]</a>
              <a href="subject.html#2508">[ subject ]</a>
              <a href="author.html#2508">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch, master has been updated
       via  2747cda3acda1531fccbd52092e08837866d60ab (commit)
       via  83df64accdfbae7225d3894b49b6c0cde3124847 (commit)
       via  239588d6ced18485c821c81ce305d9c8d2a2eb2f (commit)
       via  d285cbef38ba3d3346c7aaf09b1d06ff9e592fbb (commit)
       via  f1c987d5219aabd1253b9f7d20ad2a98cddd313d (commit)
       via  104db977ff52500d132973cb9481373ba6e367bf (commit)
      from  bdf58be37831c772c5f888e267e807c87d13f3d3 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 2747cda3acda1531fccbd52092e08837866d60ab
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Fri Mar 16 00:05:57 2012 +0100

    Improve concurrent database access with session db backend SQLite.

commit 83df64accdfbae7225d3894b49b6c0cde3124847
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Fri Mar 16 00:04:53 2012 +0100

    Silence error messages if the agent's session.log file is not accessible (e.g. on NFSv4+Krb5-mounted homes).

commit 239588d6ced18485c821c81ce305d9c8d2a2eb2f
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Fri Mar 16 00:00:37 2012 +0100

    Add/enable debugging of x2gocleansessions.

commit d285cbef38ba3d3346c7aaf09b1d06ff9e592fbb
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Thu Mar 15 23:58:22 2012 +0100

    Fix race condition between session.log of x2goagent and x2gocleansessions. If x2goagent is now fast enough with appending the new session state to the session.log file, the x2gocleansessions script will mark the session as suspended during the session resuming process.

commit f1c987d5219aabd1253b9f7d20ad2a98cddd313d
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Thu Mar 15 23:55:11 2012 +0100

    no newline when printing the status

commit 104db977ff52500d132973cb9481373ba6e367bf
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Thu Mar 15 23:54:35 2012 +0100

    correct changelog

-----------------------------------------------------------------------

Summary of changes:
 debian/changelog                      |   14 ++++++++++----
 x2goserver/bin/x2goresume-session     |   30 +++++++++++++++++-------------
 x2goserver/lib/x2gogetstatus          |    2 +-
 x2goserver/lib/x2gosqlitewrapper.pl   |    3 ++-
 x2goserver/sbin/x2gocleansessions     |   16 ++++++++--------
 x2goserver/sbin/x2golistsessions_root |    2 +-
 6 files changed, 39 insertions(+), 28 deletions(-)

The diff of changes is:
diff --git a/debian/changelog b/debian/changelog
index f8a24d5..e5c3971 100644
--- a/debian/changelog
+++ b/debian/changelog
@@ -11,10 +11,16 @@ x2goserver (3.1.1.0-0~x2go1) UNRELEASED; urgency=low
       by X2Go client applications to retrieve a list of server-side
       supported X2Go features.
     - Update date and version number in man pages.
-    - Add syslogging to SQLite3 session DB backend for occuring
-      DB failures.
-    - If setting a session state to 'R' fails in x2goresume-session,
-      simly try again.
+    - Fix race condition between session.log of x2goagent and
+      x2gocleansessions. If x2goagent is now fast enough with appending
+      the new session state to the session.log file, the x2gocleansessions
+      script will mark the session as suspended during the session
+      resuming process.
+    - Add X2Go server script x2gogetstatus.
+    - Add/enable debugging of x2gocleansessions.
+    - Silence error messages if the agent's session.log file is not accessible
+      (e.g. on NFSv4+Krb5-mounted homes).
+    - Improve concurrent database access with session db backend SQLite.
   * Remove /etc/x2go/applications on package removal if it is a
     symlink, keep it, if it is a directory. Remove /etc/x2go
     (if empty after purge) on package purge.
diff --git a/x2goserver/bin/x2goresume-session b/x2goserver/bin/x2goresume-session
index baf639a..04d2eea 100755
--- a/x2goserver/bin/x2goresume-session
+++ b/x2goserver/bin/x2goresume-session
@@ -149,25 +149,28 @@ fi
 
 echo &quot;$NEWOPTIONS&quot; &gt;&quot;${SESSION_DIR}/options&quot;
 
-# we really have to make sure the session database got this write operation
-# this may just be an SQLite issue so...
-# FIXME: probably migrate this piece of code to the SQLite db backend...
-while True; do 
-	$X2GO_LIB_PATH/x2goresume  &quot;$X2GO_CLIENT&quot; &quot;$SESSION_NAME&quot;  &quot;$GR_PORT&quot; &quot;$SOUND_PORT&quot; &quot;$FS_PORT&quot; &gt; /dev/null
-	if [ $($X2GO_LIB_PATH/x2gogetstatus &quot;$SESSION_NAME&quot;) == &quot;R&quot; ]; then
-		break;
-	else
-		$X2GO_LIB_PATH/x2gosyslog &quot;$0&quot; &quot;warning&quot; &quot;failed to write to X2Go db, will try again...&quot;
-		sleep 1;
-	fi
-done
-
 # run x2goserver-extensions for pre-resume
 x2gofeature X2GO_RUN_EXTENSIONS &amp;&gt;/dev/null &amp;&amp; x2goserver-run-extensions &quot;$SESSION_NAME&quot; pre-resume || true
 
 kill -HUP $X2GO_AGENT_PID &amp;&gt;/dev/null &amp;&amp; {
 	$X2GO_LIB_PATH/x2gosyslog &quot;$0&quot; &quot;notice&quot; &quot;client $X2GO_CLIENT has successfully resumed session with ID $SESSION_NAME&quot;
 
+	# FIXME: the below code may not be necessary as we fixed a race condition between x2gocleansessions and x2goagent
+
+	# we really have to make sure the session database gets this write operation
+	# this may just be an SQLite issue so...
+	# FIXME: probably migrate this piece of code to the SQLite db backend...
+	#while true; do
+	#	$X2GO_LIB_PATH/x2goresume  &quot;$X2GO_CLIENT&quot; &quot;$SESSION_NAME&quot;  &quot;$GR_PORT&quot; &quot;$SOUND_PORT&quot; &quot;$FS_PORT&quot; &gt; /dev/null
+	#	if [ $($X2GO_LIB_PATH/x2gogetstatus &quot;$SESSION_NAME&quot;) == &quot;R&quot; ]; then
+	#		break;
+	#	else
+	#		$X2GO_LIB_PATH/x2gosyslog &quot;$0&quot; &quot;warning&quot; &quot;failed to write to X2Go db, will try again...&quot;
+	#		sleep 1;
+	#	fi
+	#done
+	$X2GO_LIB_PATH/x2goresume  &quot;$X2GO_CLIENT&quot; &quot;$SESSION_NAME&quot;  &quot;$GR_PORT&quot; &quot;$SOUND_PORT&quot; &quot;$FS_PORT&quot; &gt; /dev/null
+
 	# resume x2godesktopsharing, if it has been in use before the session got suspended
 	x2gofeature X2GO_DESKTOPSHARING &amp;&gt;/dev/null &amp;&amp; x2goresume-desktopsharing &quot;$SESSION_NAME&quot; || true
 
@@ -191,3 +194,4 @@ kill -HUP $X2GO_AGENT_PID &amp;&gt;/dev/null &amp;&amp; {
 echo &quot;gr_port=$GR_PORT&quot;
 echo &quot;sound_port=$SOUND_PORT&quot;
 echo &quot;fs_port=$FS_PORT&quot;
+
diff --git a/x2goserver/lib/x2gogetstatus b/x2goserver/lib/x2gogetstatus
index a245352..d2271a4 100755
--- a/x2goserver/lib/x2gogetstatus
+++ b/x2goserver/lib/x2gogetstatus
@@ -34,7 +34,7 @@ my $status;
 my $sid=shift or die;
 
 $status = db_getstatus($sid);
-print &quot;$status\n&quot;;
+print &quot;$status&quot;;
 
 # closing syslog 
 closelog;
diff --git a/x2goserver/lib/x2gosqlitewrapper.pl b/x2goserver/lib/x2gosqlitewrapper.pl
index 1d8923a..bb0e621 100755
--- a/x2goserver/lib/x2gosqlitewrapper.pl
+++ b/x2goserver/lib/x2gosqlitewrapper.pl
@@ -63,7 +63,8 @@ my $dbfile=&quot;$homedir/x2go_sessions&quot;;
 my ($uname, $pass, $uid, $pgid, $quota, $comment, $gcos, $homedir, $shell, $expire) = getpwuid($&lt;);
 my $realuser=$uname;
 
-my $dbh=DBI-&gt;connect(&quot;dbi:SQLite:dbname=$dbfile&quot;,&quot;&quot;,&quot;&quot;,{AutoCommit =&gt; 1}) or die $_;
+my $dbh=DBI-&gt;connect(&quot;dbi:SQLite:dbname=$dbfile&quot;,&quot;&quot;,&quot;&quot;,{sqlite_use_immediate_transaction =&gt; 1, AutoCommit =&gt; 1, }) or die $_;
+$dbh-&gt;sqlite_busy_timeout( 2000 );
 
 my $cmd=shift or die &quot;command not specified&quot;;
 my $rc=0;
diff --git a/x2goserver/sbin/x2gocleansessions b/x2goserver/sbin/x2gocleansessions
index b3f65db..6e21482 100755
--- a/x2goserver/sbin/x2gocleansessions
+++ b/x2goserver/sbin/x2gocleansessions
@@ -56,12 +56,12 @@ sub check_stat
 	my $sess=shift;
 	my $user=shift;
 	my $log=&quot;~$user/.x2go/C-$sess/session.log&quot;;
-	my $text=`tail -1 $log`;
+	my $text=`tail -1 $log 2&gt;/dev/null`;
 	if ($text =~ m/Session suspended/)
 	{
 		return 0;
 	}
-		return 1;
+	return 1;
 }
 
 sub catch_term
@@ -101,15 +101,15 @@ elsif ($pid == 0 )
 			my @sinfo=split('\\|',&quot;@outp[$i]&quot;);
 			if (@sinfo[4]eq 'F')
 			{
-				#print &quot;@sinfo[1], is blocked\n&quot;;
-				#print &quot;(@sinfo[1])Unmounting all shares\n&quot;;	        
+				syslog('debug', &quot;@sinfo[1] is blocked&quot;);
+				syslog('debug', &quot;@sinfo[1]: unmounting all shares&quot;);
 				system( &quot;su @sinfo[11] -c \&quot;export HOSTNAME &amp;&amp; x2goumount-session @sinfo[1]\&quot; 2&gt; /dev/null&quot;);
 			}
 			elsif (! check_pid (@sinfo[0]<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at sinfo</A>[1]<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at sinfo</A>[12]))
 			{
 				system(&quot;su @sinfo[11] -c \&quot;$x2go_lib_path/x2gochangestatus 'F' @sinfo[1] \&quot; &gt; /dev/null&quot;);
-				#print &quot;@sinfo[1], pid @sinfo[0] not exist, changing status from @sinfo[4] to F\n&quot;;
-				#print &quot;(@sinfo[1])Unmounting all shares\n&quot;;	 
+				syslog('debug', &quot;@sinfo[1], pid @sinfo[0] does not exist, changing status from @sinfo[4] to F&quot;);
+				syslog('debug', &quot;@sinfo[1]: unmounting all shares&quot;);
 				system( &quot;su @sinfo[11] -c \&quot;export HOSTNAME &amp;&amp; x2goumount-session @sinfo[1]\&quot; 2&gt; /dev/null&quot;);
 			}
 			else
@@ -119,8 +119,8 @@ elsif ($pid == 0 )
 					if (!check_stat(@sinfo[1]<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at sinfo</A>[11]))
 					{
 						system(&quot;su @sinfo[11] -c  \&quot;$x2go_lib_path/x2gochangestatus 'S' @sinfo[1] \&quot; &gt; /dev/null&quot;);
-						#print &quot;@sinfo[1], is suspended, changing status from @sinfo[4] to S\n&quot;;
-						#print &quot;(@sinfo[1])Unmounting all shares\n&quot;;	        
+						syslog(&quot;@sinfo[1] is suspended, changing status from @sinfo[4] to S&quot;);
+						syslog(&quot;@sinfo[1]: unmounting all shares&quot;);
 						system( &quot;su @sinfo[11] -c \&quot;export HOSTNAME &amp;&amp; x2goumount-session @sinfo[1]\&quot; 2&gt; /dev/null&quot;);
 					}
 				}
diff --git a/x2goserver/sbin/x2golistsessions_root b/x2goserver/sbin/x2golistsessions_root
index c1f0567..dddcae3 100755
--- a/x2goserver/sbin/x2golistsessions_root
+++ b/x2goserver/sbin/x2golistsessions_root
@@ -35,7 +35,7 @@ sub check_stat
 	my $sess=shift;
 	my $user=shift;
 	my $log=&quot;~$user/.x2go/C-$sess/session.log&quot;;
-	my $text=`tail -1 $log`;
+	my $text=`tail -1 $log 2&gt;/dev/null`;
 	if ($text =~ m/Session suspended/)
 	{
 		return 0;


hooks/post-receive
-- 
x2goserver.git (X2Go Server)

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;x2goserver.git&quot; (X2Go Server).

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002507.html">[X2go-Commits] x2goserver.git - master (branch) updated:	3.1.0.1-22-gbdf58be
</A></li>
	<LI>Next message: <A HREF="002509.html">[X2go-Commits] x2goserver.git - master (branch) updated:	3.1.0.1-29-g0cc560c
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2508">[ date ]</a>
              <a href="thread.html#2508">[ thread ]</a>
              <a href="subject.html#2508">[ subject ]</a>
              <a href="author.html#2508">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/x2go-commits">More information about the X2go-commits
mailing list</a><br>
</body></html>
