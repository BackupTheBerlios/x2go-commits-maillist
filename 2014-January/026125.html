<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [X2Go-Commits] [x2goclient] 01/02: Revrite SSH Classes to support	libssh fix
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/x2go-commits/2014-January/index.html" >
   <LINK REL="made" HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2Go-Commits%5D%20%5Bx2goclient%5D%2001/02%3A%20Revrite%20SSH%20Classes%20to%20support%0A%09libssh%20fix&In-Reply-To=%3C20140124100738.B3B935DB20%40ymir%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026124.html">
   <LINK REL="Next"  HREF="026126.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[X2Go-Commits] [x2goclient] 01/02: Revrite SSH Classes to support	libssh fix</H1>
    <B>git-admin at x2go.org</B> 
    <A HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2Go-Commits%5D%20%5Bx2goclient%5D%2001/02%3A%20Revrite%20SSH%20Classes%20to%20support%0A%09libssh%20fix&In-Reply-To=%3C20140124100738.B3B935DB20%40ymir%3E"
       TITLE="[X2Go-Commits] [x2goclient] 01/02: Revrite SSH Classes to support	libssh fix">git-admin at x2go.org
       </A><BR>
    <I>Fri Jan 24 11:07:38 CET 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="026124.html">[X2Go-Commits] [x2goclient] 02/02: move SSH classes rewrite to new release series 4.0.2.x
</A></li>
        <LI>Next message: <A HREF="026126.html">[X2Go-Commits] [x2goclient] 02/03: set mod map from client to server on Mac, hide keyboard settings on Mac
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26125">[ date ]</a>
              <a href="thread.html#26125">[ thread ]</a>
              <a href="subject.html#26125">[ subject ]</a>
              <a href="author.html#26125">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an automated email from the git hooks/post-receive script.

x2go pushed a commit to branch master
in repository x2goclient.

commit d94f5d87e67d81b9b3db4a3059db48edfa4dfaf1
Author: Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">o.shneyder at phoca-gmbh.de</A>&gt;
Date:   Fri Jan 17 15:06:45 2014 +0100

    Revrite SSH Classes to support libssh fix
---
 debian/changelog        |    1 +
 onmainwindow.cpp        |   28 +--
 sshmasterconnection.cpp |  344 ++++++++++++---------------
 sshmasterconnection.h   |   32 ++-
 sshprocess.cpp          |   23 +-
 sshprocess.cpp.bc       |  598 -----------------------------------------------
 sshprocess.h            |    1 +
 sshprocess.h.bc         |   92 --------
 8 files changed, 190 insertions(+), 929 deletions(-)

diff --git a/debian/changelog b/debian/changelog
index 95164b9..556fd0a 100644
--- a/debian/changelog
+++ b/debian/changelog
@@ -19,6 +19,7 @@ x2goclient (4.0.1.3-0x2go1) unstable; urgency=low
     - Enables forwarding (delegation) of GSSAPI credentials to the server. 
     - Make GSSAPI delegation configurable.
     - Update Russian translation file.
+    - Revrite SSH Classes to support libssh fix
 
   [ Orion Poplawski ]
   * New upstream version (4.0.1.3):
diff --git a/onmainwindow.cpp b/onmainwindow.cpp
index 4efd91f..ae3eefa 100644
--- a/onmainwindow.cpp
+++ b/onmainwindow.cpp
@@ -5033,25 +5033,25 @@ void ONMainWindow::slotRetResumeSess ( bool result,
                 scmd=&quot;echo \&quot;default-server=`echo &quot;
                      &quot;$SSH_CLIENT | awk '{print $1}'`:&quot;+
                      sndPort+
-                     &quot;\&quot;&gt; ~/.x2go/C-&quot;+
+                     &quot;\&quot;&gt; $HOME/.x2go/C-&quot;+
                      resumingSession.sessionId+
                      &quot;/.pulse-client.conf&quot;
                      &quot;;echo \&quot;cookie-file=.x2go/C-&quot;+
                      resumingSession.sessionId+
                      &quot;/.pulse-cookie&quot;+
-                     &quot;\&quot;&gt;&gt; ~/.x2go/C-&quot;+
+                     &quot;\&quot;&gt;&gt; $HOME/.x2go/C-&quot;+
                      resumingSession.sessionId+
                      &quot;/.pulse-client.conf&quot;;
             else
                 scmd=&quot;echo \&quot;default-server=localhost:&quot;+
                      resumingSession.sndPort+
-                     &quot;\&quot;&gt; ~/.x2go/C-&quot;+
+                     &quot;\&quot;&gt; $HOME/.x2go/C-&quot;+
                      resumingSession.sessionId+
                      &quot;/.pulse-client.conf&quot;
                      &quot;;echo \&quot;cookie-file=.x2go/C-&quot;+
                      resumingSession.sessionId+
                      &quot;/.pulse-cookie&quot;+
-                     &quot;\&quot;&gt;&gt; ~/.x2go/C-&quot;+
+                     &quot;\&quot;&gt;&gt; $HOME/.x2go/C-&quot;+
                      resumingSession.sessionId+
                      &quot;/.pulse-client.conf&quot;;
 
@@ -5105,7 +5105,7 @@ void ONMainWindow::slotRetResumeSess ( bool result,
                 {
                     sshConnection-&gt;copyFile(
                         pulsecookie_filename,
-                        &quot;~/.x2go/C-&quot;+
+                        &quot;$HOME/.x2go/C-&quot;+
                         resumingSession.sessionId+
                         &quot;/.pulse-cookie&quot;, this, SLOT ( slotPCookieReady ( bool, QString,int )));
                 }
@@ -5122,7 +5122,7 @@ void ONMainWindow::slotRetResumeSess ( bool result,
                 if ( pulsecookie_filename.length() &gt; 0 )
                 {
                     sshConnection-&gt;copyFile(pulsecookie_filename,
-                                            &quot;~/.x2go/C-&quot;+
+                                            &quot;$HOME/.x2go/C-&quot;+
                                             resumingSession.sessionId+
                                             &quot;/.pulse-cookie&quot;, this, SLOT ( slotPCookieReady ( bool, QString,int )));
                 }
@@ -5130,7 +5130,7 @@ void ONMainWindow::slotRetResumeSess ( bool result,
                 QString cooFile=
                     wapiShortFileName ( homeDir )  +
                     &quot;/.x2go/pulse/.pulse-cookie&quot;;
-                QString destFile=&quot;~/.x2go/C-&quot;+
+                QString destFile=&quot;$HOME/.x2go/C-&quot;+
                                  resumingSession.sessionId+
                                  &quot;/.pulse-cookie&quot;;
                 sshConnection-&gt;copyFile(cooFile,
@@ -5143,12 +5143,12 @@ void ONMainWindow::slotRetResumeSess ( bool result,
         {
 #ifndef Q_OS_WIN
             sshConnection-&gt;copyFile(homeDir+&quot;/.esd_auth&quot;,
-                                    &quot;~/.esd_auth&quot; );
+                                    &quot;$HOME/.esd_auth&quot; );
 #else
             QString cooFile=
                 wapiShortFileName ( homeDir )  +
                 &quot;/.x2go/pulse/.esd_auth&quot;;
-            QString destFile=&quot;~/.esd_auth&quot;;
+            QString destFile=&quot;$HOME/.esd_auth&quot;;
             sshConnection-&gt;copyFile(cooFile,
                                     destFile );
 
@@ -6202,7 +6202,7 @@ void ONMainWindow::runCommand()
     if(sshConnection-&gt;useKerberos() &amp;&amp; sshConnection-&gt;get_kerberosDelegation())
     {
         krbFwString=&quot;KRB5CCNAME=`echo $KRB5CCNAME |sed 's/<A HREF="FILE://g">FILE://g</A>'` \
-        KRBFL=~/.x2go/C-&quot;+resumingSession.sessionId+&quot;/krb5cc ;\
+        KRBFL=$HOME/.x2go/C-&quot;+resumingSession.sessionId+&quot;/krb5cc ;\
         cp -a $KRB5CCNAME $KRBFL;KRB5CCNAME=$KRBFL &quot;;
     }
 
@@ -6215,9 +6215,9 @@ void ONMainWindow::runCommand()
             sessionType +&quot; 1&gt; /dev/null 2&gt;/dev/null &amp; exit&quot;;
         if ( startSessSndSystem ==PULSE )
         {
-            cmd=&quot;PULSE_CLIENTCONFIG=~/.x2go/C-&quot;+
+            cmd=&quot;export PULSE_CLIENTCONFIG=$HOME/.x2go/C-&quot;+
                 resumingSession.sessionId+
-                &quot;/.pulse-client.conf &quot;+cmd;
+                &quot;/.pulse-client.conf;&quot;+cmd;
         }
     }
     else
@@ -6261,7 +6261,7 @@ void ONMainWindow::runCommand()
 
 void ONMainWindow::runApplication(QString exec)
 {
-    sshConnection-&gt;executeCommand (&quot;PULSE_CLIENTCONFIG=~/.x2go/C-&quot;+
+    sshConnection-&gt;executeCommand (&quot;PULSE_CLIENTCONFIG=$HOME/.x2go/C-&quot;+
                                    resumingSession.sessionId+&quot;/.pulse-client.conf DISPLAY=:&quot;+
                                    resumingSession.display+
                                    &quot; setsid &quot;+exec+&quot; 1&gt; /dev/null 2&gt;/dev/null &amp; exit&quot;);
@@ -9891,7 +9891,7 @@ void ONMainWindow::slotConfigXinerama()
         foreach (QRect disp, xineramaScreens)
         screens&lt;&lt;QString::number(disp.x())+&quot; &quot;+QString::number(disp.y())+&quot; &quot;+QString::number(disp.width())+
                &quot; &quot;+QString::number(disp.height());
-        QString cmd=&quot;export DISPLAY=:&quot;+resumingSession.display+&quot;;printf '&quot;+screens.join(&quot;\\\\n&quot;)+&quot;' &gt;  ~/.x2go/C-&quot;+
+        QString cmd=&quot;export DISPLAY=:&quot;+resumingSession.display+&quot;;printf '&quot;+screens.join(&quot;\\\\n&quot;)+&quot;' &gt;  $HOME/.x2go/C-&quot;+
                     resumingSession.sessionId+&quot;/xinerama.conf&quot;;
 
         sshConnection-&gt;executeCommand(cmd, this, SLOT(slotXineramaConfigured()));
diff --git a/sshmasterconnection.cpp b/sshmasterconnection.cpp
index 8355611..c161ab3 100755
--- a/sshmasterconnection.cpp
+++ b/sshmasterconnection.cpp
@@ -182,7 +182,6 @@ SshMasterConnection::SshMasterConnection (QObject* parent, QString host, int por
     this-&gt;proxylogin=proxylogin;
     this-&gt;proxypassword=proxypassword;
     this-&gt;proxyKrbLogin=proxyKrbLogin;
-    reverseTunnel=false;
     mainWnd=(ONMainWindow*) parent;
     kerberos=krblogin;
     challengeAuthVerificationCode=QString::null;
@@ -209,49 +208,6 @@ SshMasterConnection::SshMasterConnection (QObject* parent, QString host, int por
 #endif
 }
 
-SshMasterConnection::SshMasterConnection (QObject* parent, ONMainWindow* mwd, QString host, int port, bool acceptUnknownServers,
-        QString user, QString pass, QString key,bool autologin,
-        int remotePort, QString localHost, int localPort, SshProcess* creator,
-        bool useproxy, ProxyType type, QString proxyserver, quint16 proxyport,
-        QString proxylogin, QString proxypassword, QString proxykey,
-        bool proxyautologin, bool proxyKrbLogin, int localProxyPort) : QThread ( parent )
-{
-#if defined ( Q_OS_DARWIN )
-    setStackSize (sizeof (char) * 1024 * 1024 * 2);
-#endif
-    tcpProxySocket = NULL;
-    tcpNetworkProxy = NULL;
-    sshProxy= NULL;
-    sshProxyReady=false;
-    kerberosDelegation=false;
-    breakLoop=false;
-    this-&gt;host=host;
-    this-&gt;port=port;
-    this-&gt;user=user;
-    this-&gt;pass=pass;
-    this-&gt;key=key;
-    this-&gt;autologin=autologin;
-    this-&gt;acceptUnknownServers=acceptUnknownServers;
-    this-&gt;useproxy=useproxy;
-    this-&gt;proxyserver=proxyserver;
-    this-&gt;proxyport=proxyport;
-    this-&gt;proxylogin=proxylogin;
-    this-&gt;proxypassword=proxypassword;
-    this-&gt;proxytype=type;
-    this-&gt;proxyautologin=proxyautologin;
-    this-&gt;proxyKrbLogin=proxyKrbLogin;
-    this-&gt;proxykey=proxykey;
-    this-&gt;localProxyPort=localProxyPort;
-    reverseTunnelLocalHost=localHost;
-    reverseTunnelLocalPort=localPort;
-    reverseTunnelCreator=creator;
-    reverseTunnel=true;
-    reverseTunnelRemotePort=remotePort;
-    mainWnd=mwd;
-#ifdef DEBUG
-    x2goDebug&lt;&lt;&quot;SshMasterConnection, instance &quot;&lt;&lt;this&lt;&lt;&quot; created (reverse tunnel)&quot;;
-#endif
-}
 
 void SshMasterConnection::slotSshProxyConnectionOk()
 {
@@ -306,6 +262,106 @@ QString SshMasterConnection::getSourceFile(int pid)
 }
 
 
+void SshMasterConnection::addReverseTunnelConnections()
+{
+    reverseTunnelRequestMutex.lock();
+    for(int i=0; i&lt;reverseTunnelRequest.count(); ++i)
+    {
+        if(!reverseTunnelRequest[i].listen)
+        {
+            reverseTunnelRequest[i].listen=true;
+            int rc=ssh_forward_listen(my_ssh_session, NULL, reverseTunnelRequest[i].forwardPort, NULL);
+            if(rc==SSH_OK)
+            {
+                emit reverseTunnelOk(reverseTunnelRequest[i].creator);
+#ifdef DEBUG
+                x2goDebug&lt;&lt;&quot;Listening for TCP/IP connections on &quot;&lt;&lt;reverseTunnelRequest[i].forwardPort;
+#endif
+            }
+            if(rc==SSH_ERROR)
+            {
+                QString err=ssh_get_error(my_ssh_session);
+#ifdef DEBUG
+                x2goDebug&lt;&lt;&quot;Forward port &quot;&lt;&lt;reverseTunnelRequest[i].forwardPort&lt;&lt;&quot; failed:&quot;&lt;&lt;err;
+#endif
+                emit reverseTunnelFailed(reverseTunnelRequest[i].creator, err);
+            }
+        }
+    }
+    reverseTunnelRequestMutex.unlock();
+}
+
+void SshMasterConnection::checkReverseTunnelConnections()
+{
+    int port;
+    ssh_channel chan=ssh_channel_accept_forward(my_ssh_session, 0, &amp;port);
+    if(chan)
+    {
+#ifdef DEBUG
+        x2goDebug&lt;&lt;&quot;New reverse connection on port &quot;&lt;&lt;port;
+#endif
+
+        reverseTunnelRequestMutex.lock();
+        for(int i=0; i&lt;reverseTunnelRequest.count(); ++i)
+        {
+            ReverseTunnelRequest req=reverseTunnelRequest[i];
+            if(req.forwardPort==port)
+            {
+#ifdef DEBUG
+                x2goDebug&lt;&lt;&quot;Creating new channel for reverse tunnel &quot;&lt;&lt;port;
+#endif
+                int sock=socket ( AF_INET, SOCK_STREAM,0 );
+#ifndef Q_OS_WIN
+                const int y=1;
+#else
+                const char y=1;
+#endif
+                setsockopt(sock, IPPROTO_TCP, TCP_NODELAY,&amp;y, sizeof(int));
+
+                struct sockaddr_in address;
+                address.sin_family=AF_INET;
+                address.sin_port=htons ( req.localPort );
+#ifdef DEBUG
+                x2goDebug&lt;&lt;&quot;connecting to &quot;&lt;&lt;req.localHost&lt;&lt;&quot;:&quot;&lt;&lt;req.localPort&lt;&lt;endl;
+#endif
+#ifndef Q_OS_WIN
+                inet_aton ( req.localHost.toAscii(), &amp;address.sin_addr );
+#else
+                address.sin_addr.s_addr=inet_addr (
+                                            req.localHost.toAscii() );
+#endif
+
+                if ( ::connect ( sock, ( struct sockaddr * ) &amp;address,sizeof ( address ) ) !=0 )
+                {
+                    QString errMsg=tr ( &quot;can not connect to &quot; ) +
+                                   req.localHost+&quot;:&quot;+QString::number ( req.localPort );
+#ifdef DEBUG
+                    x2goDebug&lt;&lt;errMsg&lt;&lt;endl;
+#endif
+                    emit ioErr ( req.creator, errMsg, &quot;&quot; );
+                    break;
+                }
+
+                ChannelConnection con;
+                con.channel=chan;
+                con.sock=sock;
+                con.creator=req.creator;
+                channelConnectionsMutex.lock();
+                channelConnections&lt;&lt;con;
+                channelConnectionsMutex.unlock();
+#ifdef DEBUG
+                x2goDebug&lt;&lt;&quot;New channel created&quot;;
+#endif
+                break;
+            }
+        }
+        reverseTunnelRequestMutex.unlock();
+
+
+    }
+}
+
+
 int SshMasterConnection::startTunnel(const QString&amp; forwardHost, uint forwardPort, const QString&amp; localHost, uint localPort, bool reverse,
                                      QObject* receiver, const char* slotTunnelOk, const char* slotFinished)
 {
@@ -319,6 +375,23 @@ int SshMasterConnection::startTunnel(const QString&amp; forwardHost, uint forwardPor
         connect(proc, SIGNAL(sshTunnelOk(int)), receiver, slotTunnelOk);
     }
     proc-&gt;startTunnel(forwardHost, forwardPort, localHost, localPort, reverse);
+    if(reverse &amp;&amp; !kerberos)
+    {
+        connect(this, SIGNAL(reverseTunnelOk(SshProcess*)), proc, SLOT(slotReverseTunnelOk(SshProcess*)));
+        connect(this, SIGNAL(reverseTunnelFailed(SshProcess*,QString)), proc, SLOT(slotReverseTunnelFailed(SshProcess*,QString)));
+        ReverseTunnelRequest req;
+        req.creator=proc;
+        req.localPort=localPort;
+        req.localHost=localHost;
+        req.forwardPort=forwardPort;
+        req.listen=false;
+#ifdef DEBUG
+        x2goDebug&lt;&lt;&quot;Requesting reverse tunnel from port &quot;&lt;&lt;forwardPort&lt;&lt; &quot; to &quot;&lt;&lt;localPort;
+#endif
+        reverseTunnelRequestMutex.lock();
+        reverseTunnelRequest&lt;&lt;req;
+        reverseTunnelRequestMutex.unlock();
+    }
     processes&lt;&lt;proc;
     return proc-&gt;pid;
 }
@@ -358,30 +431,6 @@ void SshMasterConnection::slotSshProxyTunnelFailed(bool ,  QString output,
 }
 
 
-SshMasterConnection* SshMasterConnection::reverseTunnelConnection ( SshProcess* creator,
-        int remotePort, QString localHost, int localPort )
-{
-    SshMasterConnection* con=new SshMasterConnection (this, mainWnd, host,port,acceptUnknownServers,user,pass,
-            key,autologin, remotePort,localHost,
-            localPort,creator, useproxy, proxytype, proxyserver, proxyport, proxylogin,
-            proxypassword, proxykey, proxyautologin, proxyKrbLogin, localProxyPort );
-    con-&gt;kerberos=kerberos;
-
-    con-&gt;setVerficationCode(challengeAuthVerificationCode);
-
-    connect ( con,SIGNAL ( ioErr ( SshProcess*,QString,QString ) ),this,SIGNAL ( ioErr ( SshProcess*,QString,QString ) ) );
-    connect ( con,SIGNAL ( stdErr ( SshProcess*,QByteArray ) ),this,SIGNAL ( stdErr ( SshProcess*,QByteArray ) ) );
-    connect ( con,SIGNAL ( reverseListenOk ( SshProcess* ) ), this, SIGNAL ( reverseListenOk ( SshProcess* ) ) );
-    connect ( con,SIGNAL ( needPassPhrase(SshMasterConnection*, bool)), this, SIGNAL (needPassPhrase(SshMasterConnection*, bool)));
-
-    con-&gt;keyPhrase=keyPhrase;
-    con-&gt;keyPhraseReady=true;
-    con-&gt;start();
-    reverseTunnelConnectionsMutex.lock();
-    reverseTunnelConnections.append ( con );
-    reverseTunnelConnectionsMutex.unlock();
-    return con;
-}
 
 void SshMasterConnection::slotSshProxyServerAuthAborted()
 {
@@ -393,7 +442,7 @@ void SshMasterConnection::run()
 #ifdef DEBUG
     x2goDebug&lt;&lt;&quot;SshMasterConnection, instance &quot;&lt;&lt;this&lt;&lt;&quot; entering thread&quot;;
 #endif
-    if(useproxy &amp;&amp; proxytype==PROXYSSH &amp;&amp; !reverseTunnel)
+    if(useproxy &amp;&amp; proxytype==PROXYSSH)
     {
 
         sshProxy=new SshMasterConnection (0, proxyserver, proxyport,acceptUnknownServers,
@@ -464,8 +513,6 @@ void SshMasterConnection::run()
         x2goDebug&lt;&lt;err&lt;&lt;endl;
 #endif
         emit connectionError ( err,&quot;&quot; );
-        if ( reverseTunnel )
-            emit ioErr ( reverseTunnelCreator,err,&quot;&quot; );
         quit();
         return;
     }
@@ -529,8 +576,6 @@ void SshMasterConnection::run()
         x2goDebug&lt;&lt;message&lt;&lt;&quot; - &quot;&lt;&lt;err;
 #endif
         emit connectionError ( message, err );
-        if ( reverseTunnel )
-            emit ioErr ( reverseTunnelCreator,message,err );
         ssh_free ( my_ssh_session );
         quit();
         return;
@@ -626,8 +671,6 @@ void SshMasterConnection::run()
         x2goDebug&lt;&lt;message&lt;&lt;&quot; - &quot;&lt;&lt;err;
 #endif
         emit userAuthError ( authErrors.join ( &quot;\n&quot; ) );
-        if ( reverseTunnel )
-            emit ioErr ( reverseTunnelCreator,message,err );
         ssh_disconnect ( my_ssh_session );
         ssh_free ( my_ssh_session );
         quit();
@@ -644,34 +687,6 @@ void SshMasterConnection::run()
     setsockopt(session_sock, IPPROTO_TCP, TCP_NODELAY,&amp;y, sizeof(int));
 
 
-    if ( reverseTunnel )
-    {
-        if ( channel_forward_listen ( my_ssh_session, NULL, reverseTunnelRemotePort,  NULL ) !=SSH_OK )
-        {
-            if(disconnectSessionFlag)
-            {
-#ifdef DEBUG
-                x2goDebug&lt;&lt;&quot;session already disconnected, exiting&quot;&lt;&lt;endl;
-#endif
-                return;
-            }
-            QString err=ssh_get_error ( my_ssh_session );
-            QString message=tr ( &quot;channel_forward_listen failed&quot; );
-#ifdef DEBUG
-            x2goDebug&lt;&lt;message&lt;&lt;&quot; - &quot;&lt;&lt;err;
-#endif
-            emit ioErr ( reverseTunnelCreator, message, err );
-            ssh_disconnect ( my_ssh_session );
-            ssh_free ( my_ssh_session );
-            quit();
-            return;
-        }
-        emit reverseListenOk ( reverseTunnelCreator );
-
-#ifdef DEBUG
-        x2goDebug&lt;&lt;&quot;channel_forward_listen ok\n &quot;;
-#endif
-    }
     channelLoop();
 }
 
@@ -685,10 +700,7 @@ SshMasterConnection::~SshMasterConnection()
 #ifdef DEBUG
     x2goDebug&lt;&lt;&quot;SshMasterConnection, instance &quot;&lt;&lt;this&lt;&lt;&quot; waiting for thread to finish&quot;;
 #endif
-    if(!reverseTunnel)
-        wait(15000);
-    else
-        wait(5000);
+    wait(15000);
 #ifdef DEBUG
     x2goDebug&lt;&lt;&quot;SshMasterConnection, instance &quot;&lt;&lt;this&lt;&lt;&quot; thread finished&quot;;
 #endif
@@ -963,21 +975,18 @@ bool SshMasterConnection::userAuthAuto()
     int i=0;
     while(rc != SSH_AUTH_SUCCESS)
     {
-        if(!reverseTunnel)
+        keyPhraseReady=false;
+        emit needPassPhrase(this, false);
+        for(;;)
         {
-            keyPhraseReady=false;
-            emit needPassPhrase(this, false);
-            for(;;)
-            {
-                bool ready=false;
-                this-&gt;usleep(200);
-                keyPhraseMutex.lock();
-                if(keyPhraseReady)
-                    ready=true;
-                keyPhraseMutex.unlock();
-                if(ready)
-                    break;
-            }
+            bool ready=false;
+            this-&gt;usleep(200);
+            keyPhraseMutex.lock();
+            if(keyPhraseReady)
+                ready=true;
+            keyPhraseMutex.unlock();
+            if(ready)
+                break;
         }
         if(keyPhrase==QString::null)
             break;
@@ -1038,21 +1047,18 @@ bool SshMasterConnection::userAuthWithKey()
     int i=0;
     while(!prkey)
     {
-        if(!reverseTunnel)
+        keyPhraseReady=false;
+        emit needPassPhrase(this, false);
+        for(;;)
         {
-            keyPhraseReady=false;
-            emit needPassPhrase(this, false);
-            for(;;)
-            {
-                bool ready=false;
-                this-&gt;usleep(200);
-                keyPhraseMutex.lock();
-                if(keyPhraseReady)
-                    ready=true;
-                keyPhraseMutex.unlock();
-                if(ready)
-                    break;
-            }
+            bool ready=false;
+            this-&gt;usleep(200);
+            keyPhraseMutex.lock();
+            if(keyPhraseReady)
+                ready=true;
+            keyPhraseMutex.unlock();
+            if(ready)
+                break;
         }
         if(keyPhrase==QString::null)
             break;
@@ -1254,7 +1260,7 @@ void SshMasterConnection::copy()
         lst.removeLast();
         QString dstPath=lst.join ( &quot;/&quot; );
 #ifdef DEBUG
-        x2goDebug&lt;&lt;&quot;dst path:&quot;&lt;&lt;dstPath&lt;&lt;&quot; file:&quot;&lt;&lt;dstFile&lt;&lt;endl;
+        x2goDebug&lt;&lt;&quot;SSH Master Connection copy - dst path:&quot;&lt;&lt;dstPath&lt;&lt;&quot; file:&quot;&lt;&lt;dstFile&lt;&lt;endl;
 #endif
         ssh_scp scp=ssh_scp_new ( my_ssh_session, SSH_SCP_WRITE|SSH_SCP_RECURSIVE, dstPath.toAscii() );
         if ( scp == NULL )
@@ -1343,16 +1349,6 @@ void SshMasterConnection::channelLoop()
                 sshProxy=0;
             }
 
-            reverseTunnelConnectionsMutex.lock();
-#ifdef DEBUG
-            x2goDebug&lt;&lt;&quot;Deleting reverse tunnel connections&quot;&lt;&lt;endl;
-#endif
-            for ( int i=reverseTunnelConnections.size()-1; i&gt;=0; --i)
-            {
-                delete reverseTunnelConnections[i];
-            }
-            reverseTunnelConnectionsMutex.unlock();
-
             channelConnectionsMutex.lock();
 #ifdef DEBUG
             x2goDebug&lt;&lt;&quot;Deleting channel connections&quot;&lt;&lt;endl;
@@ -1376,67 +1372,17 @@ void SshMasterConnection::channelLoop()
             if (tcpNetworkProxy != NULL)
                 delete tcpNetworkProxy;
 #ifdef DEBUG
-            if ( !reverseTunnel )
-                x2goDebug&lt;&lt;&quot;All channels closed, session disconnected, quiting session loop&quot;&lt;&lt;endl;
+            x2goDebug&lt;&lt;&quot;All channels closed, session disconnected, quiting session loop&quot;&lt;&lt;endl;
 #endif
             quit();
             return;
         }
+        addReverseTunnelConnections();
+        checkReverseTunnelConnections();
         copyRequestMutex.lock();
         if ( copyRequests.size() &gt;0 )
             copy();
         copyRequestMutex.unlock();
-        if ( reverseTunnel )
-        {
-            ssh_channel newChan=channel_forward_accept ( my_ssh_session,0 );
-            if ( newChan )
-            {
-#ifdef DEBUG
-                x2goDebug&lt;&lt;&quot;new forward connection&quot;&lt;&lt;endl;
-#endif
-                int sock=socket ( AF_INET, SOCK_STREAM,0 );
-#ifndef Q_OS_WIN
-                const int y=1;
-#else
-                const char y=1;
-#endif
-                setsockopt(sock, IPPROTO_TCP, TCP_NODELAY,&amp;y, sizeof(int));
-
-                struct sockaddr_in address;
-                address.sin_family=AF_INET;
-                address.sin_port=htons ( reverseTunnelLocalPort );
-#ifdef DEBUG
-                x2goDebug&lt;&lt;&quot;connecting to &quot;&lt;&lt;reverseTunnelLocalHost&lt;&lt;&quot;:&quot;&lt;&lt;reverseTunnelLocalPort&lt;&lt;endl;
-#endif
-#ifndef Q_OS_WIN
-                inet_aton ( reverseTunnelLocalHost.toAscii(), &amp;address.sin_addr );
-#else
-                address.sin_addr.s_addr=inet_addr (
-                                            reverseTunnelLocalHost.toAscii() );
-#endif
-
-                if ( ::connect ( sock, ( struct sockaddr * ) &amp;address,sizeof ( address ) ) !=0 )
-                {
-                    QString errMsg=tr ( &quot;can not connect to &quot; ) +
-                                   reverseTunnelLocalHost+&quot;:&quot;+QString::number ( reverseTunnelLocalPort );
-#ifdef DEBUG
-                    x2goDebug&lt;&lt;errMsg&lt;&lt;endl;
-#endif
-                    emit ioErr ( reverseTunnelCreator, errMsg, &quot;&quot; );
-                    continue;
-                }
-#ifdef DEBUG
-                x2goDebug&lt;&lt;&quot;creating new channel connection&quot;&lt;&lt;endl;
-#endif
-                ChannelConnection con;
-                con.channel=newChan;
-                con.sock=sock;
-                con.creator=reverseTunnelCreator;
-                channelConnectionsMutex.lock();
-                channelConnections&lt;&lt;con;
-                channelConnectionsMutex.unlock();
-            }
-        }
 
         char buffer[1024*512]; //512K buffer
         int nbytes;
diff --git a/sshmasterconnection.h b/sshmasterconnection.h
index f05825f..1f8c4ea 100644
--- a/sshmasterconnection.h
+++ b/sshmasterconnection.h
@@ -52,6 +52,15 @@ struct ChannelConnection
     }
 };
 
+struct ReverseTunnelRequest
+{
+    uint localPort;
+    uint forwardPort;
+    QString localHost;
+    SshProcess* creator;
+    bool listen;
+};
+
 struct CopyRequest
 {
     SshProcess* creator;
@@ -90,8 +99,6 @@ public:
     {
         acceptUnknownServers=accept;
     }
-    SshMasterConnection* reverseTunnelConnection(SshProcess* creator, int remotePort,
-            QString localHost, int localPort);
     QString getHost()
     {
         return host;
@@ -110,12 +117,6 @@ public:
     };
 
 private:
-    SshMasterConnection(QObject* parent, ONMainWindow* parWnd, QString host, int port, bool acceptUnknownServers,
-                        QString user, QString pass, QString key,bool autologin,
-                        int remotePort, QString localHost, int localPort, SshProcess* creator,
-                        bool useproxy=false, ProxyType type=PROXYSSH, QString proxyserver=QString::null, quint16 proxyport=0,
-                        QString proxylogin=QString::null, QString proxypassword=QString::null, QString proxyKey=QString::null,
-                        bool proxyAutologin=false, bool proxyKrbLogin=false, int localProxyPort=0);
     bool sshConnect();
     bool userAuthWithPass();
     bool userAuthAuto();
@@ -128,6 +129,8 @@ private:
     void copy();
     int serverAuth(QString&amp; errorMsg);
     void setVerficationCode(QString code);
+    void checkReverseTunnelConnections();
+    void addReverseTunnelConnections();
 #ifdef Q_OS_WIN
     void parseKnownHosts();
 #endif
@@ -149,12 +152,12 @@ private:
     ssh_session my_ssh_session;
     QList&lt;ChannelConnection&gt; channelConnections;
     QList&lt;CopyRequest&gt; copyRequests;
-    QList&lt;SshMasterConnection*&gt; reverseTunnelConnections;
+    QList&lt;ReverseTunnelRequest&gt; reverseTunnelRequest;
     QMutex channelConnectionsMutex;
     QMutex copyRequestMutex;
     QMutex disconnectFlagMutex;
-    QMutex reverseTunnelConnectionsMutex;
     QMutex writeHostKeyMutex;
+    QMutex reverseTunnelRequestMutex;
     bool writeHostKey;
     bool writeHostKeyReady;
     int nextPid;
@@ -181,13 +184,8 @@ private:
     QStringList authErrors;
     bool autologin;
     bool disconnectSessionFlag;
-    bool reverseTunnel;
-    int reverseTunnelRemotePort;
     int localProxyPort;
-    int reverseTunnelLocalPort;
     bool acceptUnknownServers;
-    QString reverseTunnelLocalHost;
-    SshProcess* reverseTunnelCreator;
     ONMainWindow* mainWnd;
     bool kerberos;
     QString sshProcErrString;
@@ -207,14 +205,14 @@ signals:
     void copyErr(SshProcess* caller, QString error, QString lastSessionError);
     void copyOk(SshProcess* caller);
     void channelClosed(SshProcess* caller, QString uuid);
+    void reverseTunnelOk(SshProcess* caller);
+    void reverseTunnelFailed(SshProcess* caller, QString error);
 
     void connectionError(QString message, QString lastSessionError);
     void serverAuthError(int errCode, QString lastSessionError, SshMasterConnection*);
     void serverAuthAborted();
     void userAuthError(QString error);
 
-    void newReverceTunnelConnection(SshProcess* creator, void* newChannel);
-    void reverseListenOk(SshProcess* creator);
     void connectionOk( QString host);
 
     void needPassPhrase(SshMasterConnection*, bool verificationCode);
diff --git a/sshprocess.cpp b/sshprocess.cpp
index dca196d..93a388c 100755
--- a/sshprocess.cpp
+++ b/sshprocess.cpp
@@ -227,7 +227,7 @@ void SshProcess::startNormal(const QString&amp; cmd)
         procUuid=uuidStr;
         proc-&gt;start(sshString);
 
-        if (!proc-&gt;waitForStarted(5000))
+        if (!proc-&gt;waitForStarted(15000))
         {
             stdErrString=proc-&gt;errorString();
 #ifdef DEBUG
@@ -274,7 +274,7 @@ void SshProcess::start_cp(QString src, QString dst)
 #endif
         proc-&gt;start(sshString);
 
-        if (!proc-&gt;waitForStarted(5000))
+        if (!proc-&gt;waitForStarted(15000))
         {
             stdErrString=proc-&gt;errorString();
 #ifdef DEBUG
@@ -304,11 +304,6 @@ void SshProcess::startTunnel(const QString&amp; forwardHost, uint forwardPort, const
         this-&gt;localPort=localPort;
         if (!reverse)
             tunnelLoop();
-        else
-        {
-            connect(masterCon, SIGNAL(reverseListenOk(SshProcess*)), this, SLOT(slotReverseTunnelOk(SshProcess*)));
-            tunnelConnection=masterCon-&gt;reverseTunnelConnection(this, forwardPort, localHost, localPort);
-        }
     }
     else
     {
@@ -327,7 +322,7 @@ void SshProcess::startTunnel(const QString&amp; forwardHost, uint forwardPort, const
             sshString+=&quot; -R &quot;+ QString::number(forwardPort)+&quot;:&quot;+forwardHost+&quot;:&quot;+QString::number(localPort);
 
 #ifdef DEBUG
-        x2goDebug&lt;&lt;&quot;running ssh:&quot; &lt;&lt;sshString&lt;&lt;endl;
+        x2goDebug&lt;&lt;&quot;TUNNEL: running ssh:&quot; &lt;&lt;sshString&lt;&lt;endl;
 #endif
         proc-&gt;start(sshString);
 
@@ -352,7 +347,7 @@ void SshProcess::slotStdErr(SshProcess* creator, QByteArray data)
     if (creator!=this)
         return;
 #ifdef DEBUG
-    x2goDebug&lt;&lt;&quot;new err data:&quot;&lt;&lt;data&lt;&lt;endl;
+//     x2goDebug&lt;&lt;&quot;new err data:&quot;&lt;&lt;data&lt;&lt;endl;
 #endif
     stdErrString+=data;
 
@@ -365,6 +360,9 @@ void SshProcess::slotStdErr(SshProcess* creator, QByteArray data)
 #endif
         {
             tunnelOkEmited=true;
+#ifdef DEBUG
+            x2goDebug&lt;&lt;&quot;Tunnel OK&quot;&lt;&lt;endl;
+#endif
             emit sshTunnelOk(pid);
         }
     }
@@ -409,6 +407,13 @@ void SshProcess::slotReverseTunnelOk(SshProcess* creator)
         emit sshTunnelOk(pid);
 }
 
+void SshProcess::slotReverseTunnelFailed(SshProcess* creator, QString error)
+{
+    if (creator==this)
+        emit sshFinished(false,error,pid);
+
+}
+
 
 void SshProcess::slotChannelClosed(SshProcess* creator, QString uuid)
 {
diff --git a/sshprocess.cpp.bc b/sshprocess.cpp.bc
deleted file mode 100644
index 9f5fa56..0000000
--- a/sshprocess.cpp.bc
+++ /dev/null
@@ -1,598 +0,0 @@
-//
-// C++ Implementation: sshprocess
-//
-// Description:
-//
-//
-// Author: Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;, (C) 2006
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-#include &quot;x2goclientconfig.h&quot;
-#include &quot;sshprocess.h&quot;
-#include &lt;QDir&gt;
-#include &quot;x2gologdebug.h&quot;
-#include &lt;QMessageBox&gt;
-#include &lt;QTemporaryFile&gt;
-#include &lt;QApplication&gt;
-#include &lt;QLocalServer&gt;
-#include &lt;QLocalSocket&gt;
-#include &lt;QTimer&gt;
-#ifdef Q_OS_WIN
-#include &quot;wapi.h&quot;
-#endif
-#include &quot;onmainwindow.h&quot;
-sshProcess::sshProcess ( QObject* parent,
-                         const SshProxy* proxy,
-                         const QString&amp; user,
-                         const QString&amp; host,const QString&amp; pt,
-                         const QString&amp; cmd,const QString&amp; pass,
-                         const QString&amp; key, bool acc )
-		: QProcess ( parent )
-{
-	sudoErr=false;
-	QString root=((ONMainWindow*)parent)-&gt;getHomeDirectory() +&quot;/.x2go&quot;;
-	isTunnel=false;
-	isCopy=false;
-	fwX=false;
-	sshPort=pt;
-	localSocket=0l;
-	serverSocket=0l;
-	this-&gt;user=user;
-	this-&gt;host=host;
-	command=cmd;
-	this-&gt;pass=pass;
-	this-&gt;key=key;
-	autoAccept=acc;
-	env = QProcess::systemEnvironment();
-	cleanEnv ( true );
-#ifdef Q_OS_DARWIN
-	//run x2goclient from bundle
-	QDir dir ( QApplication::applicationDirPath() );
-	dir.cdUp();
-	dir.cd ( &quot;MacOS&quot; );
-	QString askpass_var=&quot;SSH_ASKPASS=&quot;;
-	askpass_var+=dir.absolutePath() +&quot;/x2goclient&quot;;
-	env.insert ( 0, askpass_var );
-#else
-	env.insert ( 0, &quot;SSH_ASKPASS=x2goclient&quot; );
-#endif
-	askpass=root+&quot;/ssh&quot;;
-	QDir dr ( askpass );
-	if ( !dr.exists() )
-		if ( !dr.mkpath ( askpass ) )
-		{
-			QString message=tr ( &quot;Unable to create: &quot; );
-			message+=askpass;
-			throw message;
-		}
-#ifdef Q_OS_WIN
-	env.insert ( 0, &quot;DISPLAY=localhost:0&quot; );
-	//don't care if real display is not 0
-	//we need it only to start askpass
-	//which is not X application
-	askpass=wapiShortFileName ( askpass );
-	extraOptions=&quot; -o UserKnownHostsFile=\&quot;&quot;+
-	             askpass +&quot;/known_hosts\&quot; -o ServerAliveInterval=300 &quot;;
-#else
-	extraOptions=&quot; -o ServerAliveInterval=300 &quot;;
-#endif
-	if ( proxy-&gt;use )
-	{
-		extraOptions+=&quot; -o ProxyCommand=\&quot;&quot;+proxy-&gt;bin+&quot; &quot;+
-		              user+&quot;@&quot;+proxy-&gt;host+&quot; -p &quot;+proxy-&gt;port+&quot;\&quot; &quot;;
-	}
-	askpass+=&quot;/socaskpass-XXXXXX&quot;;
-	QTemporaryFile fl ( askpass );
-	if ( !fl.open() )
-	{
-		QMessageBox::critical ( 0l,tr ( &quot;Error&quot; ),
-		                        tr ( &quot;Cannot create temporary file&quot; ) );
-	}
-	askpass=fl.fileName();
-	fl.setAutoRemove ( false );
-	fl.close();
-	QFile::remove ( askpass );
-	env.insert ( 0, &quot;X2GO_PSOCKET=&quot;+askpass );
-	setEnvironment ( env );
-}
-
-
-sshProcess::~sshProcess()
-{
-	QFile::remove
-	( askpass );
-	QFile::remove
-	( askpass+&quot;.log&quot; );
-	if ( state() ==QProcess::Running )
-		kill();
-	if ( serverSocket )
-	{
-		serverSocket-&gt;close();
-		delete serverSocket;
-	}
-}
-
-
-void sshProcess::slot_error ( QProcess::ProcessError )
-{}
-
-
-void sshProcess::slot_finished ( int exitCode, QProcess::ExitStatus status )
-{
-	hidePass();
-/*	x2goDebug&lt;&lt;outputString&lt;&lt;endl;
-	x2goDebug&lt;&lt;errorString&lt;&lt;endl;
-	x2goDebug&lt;&lt;&quot;exitCode: &quot;&lt;&lt;exitCode&lt;&lt;&quot; status:&quot;&lt;&lt;status&lt;&lt;endl;*/
-	if ( ( exitCode!=0&amp;&amp;exitCode!=1 ) || status !=0 )
-	{
-		QString resp=getResponce();
-
-		if ( (errorString.indexOf (
-		            &quot;POSSIBLE DNS SPOOFING DETECTED&quot; ) !=-1 )||
-		   ((errorString.indexOf (
-		            &quot;REMOTE HOST IDENTIFICATION HAS CHANGED&quot; ) !=-1 )))
-		{
-			emit sshFinished ( false,host+&quot;:\n&quot;+
-			                   errorString+&quot;\n&quot;+
-			                   outputString,this );
-			return;
-		}
-		if ( errorString.indexOf (
-		            &quot;Host key verification failed&quot; ) !=-1 )
-		{
-			int res;
-			if ( !autoAccept )
-				res=QMessageBox::warning (
-				        0l,
-				        tr ( &quot;Host key verification failed&quot; ),
-				        resp,
-				        tr ( &quot;Yes&quot; ),
-				        tr ( &quot;No&quot; ) );
-			else
-				res=0;
-			if ( res==0 )
-			{
-				if ( isTunnel )
-					startTunnel ( tunnelHost,localPort,
-					              remotePort,reverse,true );
-				else if ( isCopy )
-					start_cp ( source,destination,true );
-				else
-					startNormal ( true );
-			}
-			else
-				emit sshFinished ( false,host+&quot;:\n&quot;+
-				                   errorString+&quot;\n&quot;+
-				                   outputString,this );
-		}
-		else
-		{
-			if ( isTunnel )
-			{
-				x2goDebug&lt;&lt;&quot;stdout:&quot;&lt;&lt;outputString&lt;&lt;endl;
-				x2goDebug&lt;&lt;&quot;stderr:&quot;&lt;&lt;errorString&lt;&lt;endl;
-				errorString=&quot;Can't start ssh tunnel&quot;;
-				outputString=QString::null;
-			}
-			emit sshFinished ( false,host+&quot;:\n&quot;+
-			                   errorString+&quot;\n&quot;+
-			                   outputString,this );
-		}
-	}
-	else
-		emit sshFinished ( true,outputString,this );
-}
-
-
-void sshProcess::slot_stderr()
-{
-	QString reserr ( readAllStandardError() );
-	errorString+=reserr;
-//     	x2goDebug&lt;&lt;reserr&lt;&lt;endl;
-	if ( reserr.indexOf (
-	            &quot;Permission denied (publickey,keyboard-interactive)&quot; ) !=-1
-	   )
-	{
-		needPass=true;
-		kill();
-	}
-	if ( reserr.indexOf ( &quot;Authentication succeeded&quot; ) !=-1 )
-	{
-		hidePass();
-		emit sshTunnelOk();
-	}
-	if ( ( reserr.indexOf ( &quot;Password:&quot; ) !=-1 ) ||
-	        ( reserr.indexOf ( &quot;[sudo] password for&quot; ) !=-1 ) )
-	{
-		sudoErr=true;
-		emit sudoConfigError ( errorString, this );
-	}
-}
-
-
-void sshProcess::slot_stdout()
-{
-	if ( isTunnel )
-	{
-		QString resout ( readAllStandardOutput() );
-	}
-	else
-	{
-		QString reserr ( readAllStandardOutput() );
-		outputString+=reserr;
-//     		x2goDebug&lt;&lt;reserr&lt;&lt;endl;
-
-	}
-}
-
-void sshProcess::startNormal ( bool accept )
-{
-	/*		x2goDebug&lt;&lt;&quot;normal&quot;&lt;&lt;endl;
-			x2goDebug&lt;&lt;command&lt;&lt;endl;
-			x2goDebug&lt;&lt;&quot;host:&quot;&lt;&lt;host&lt;&lt;endl;*/
-	errorString=&quot;&quot;;
-	needPass=false;
-	disconnect ( this,SIGNAL ( error ( QProcess::ProcessError ) ),this,
-	             SLOT ( slot_error ( QProcess::ProcessError ) ) );
-	disconnect ( this,SIGNAL ( finished ( int,QProcess::ExitStatus ) ),this,
-	             SLOT ( slot_finished ( int,QProcess::ExitStatus ) ) );
-	disconnect ( this,SIGNAL ( readyReadStandardError() ),this,
-	             SLOT ( slot_stderr() ) );
-	disconnect ( this,SIGNAL ( readyReadStandardOutput() ),this,
-	             SLOT ( slot_stdout() ) );
-
-	connect ( this,SIGNAL ( error ( QProcess::ProcessError ) ),this,
-	          SLOT ( slot_error ( QProcess::ProcessError ) ) );
-	connect ( this,SIGNAL ( finished ( int,QProcess::ExitStatus ) ),this,
-	          SLOT ( slot_finished ( int,QProcess::ExitStatus ) ) );
-	connect ( this,SIGNAL ( readyReadStandardError() ),this,
-	          SLOT ( slot_stderr() ) );
-	connect ( this,SIGNAL ( readyReadStandardOutput() ),this,
-	          SLOT ( slot_stdout() ) );
-
-	QString cmX;
-	if ( fwX )
-	{
-		cmX=&quot; -X &quot;;
-	}
-	if ( key!=QString::null &amp;&amp; key!=&quot;&quot; )
-	{
-		printKey ( accept );
-#ifndef  Q_OS_WIN
-
-		start ( setsid() +&quot; ssh &quot;+cmX+&quot;-i \&quot;&quot;+key+&quot;\&quot; -p &quot;+
-		        sshPort+extraOptions+&quot; &quot;+
-		        user+&quot;@&quot;+host+&quot; \&quot;&quot;+command+&quot;\&quot;&quot; );
-#else
-		start ( &quot;ssh &quot;+cmX+&quot;-i \&quot;&quot;+key+&quot;\&quot; -p &quot;+sshPort+
-		        extraOptions+&quot; &quot;+user+&quot;@&quot;+
-		        host+&quot; \&quot;&quot;+command+&quot;\&quot;&quot; );
-#endif
-	}
-	else
-	{
-		printPass ( accept );
-#ifndef  Q_OS_WIN
-
-		start ( setsid() +&quot; ssh &quot; +cmX+&quot; -p &quot;+sshPort+
-		        extraOptions+&quot; &quot;+user+&quot;@&quot;+host+
-		        &quot; \&quot;&quot;+command+&quot;\&quot;&quot; );
-#else
-
-		start ( &quot;ssh &quot;+cmX+&quot;-p &quot;+sshPort+
-		        extraOptions+&quot; &quot;+user+&quot;@&quot;+host+&quot; \&quot;&quot;+
-		        command+&quot;\&quot;&quot; );
-#endif
-
-	}
-}
-
-
-void sshProcess::printPass ( bool accept )
-{
-	if ( serverSocket )
-		delete serverSocket;
-	serverSocket=new QLocalServer();
-	QFile::remove ( askpass );
-	if ( serverSocket-&gt;listen ( askpass ) )
-	{
-		QFile fl ( askpass );
-		fl.setPermissions (
-		    QFile::ReadOwner|QFile::WriteOwner );
-		cleanEnv();
-		passcookie=cookie();
-		env.insert ( 0, &quot;X2GO_PCOOKIE=&quot;+passcookie );
-		if ( accept )
-			env.insert ( 0, &quot;X2GO_PACCEPT=yes&quot; );
-		else
-			env.insert ( 0, &quot;X2GO_PACCEPT=no&quot; );
-		setEnvironment ( env );
-		connect ( serverSocket,SIGNAL ( newConnection() ),
-		          this,SLOT ( slot_pass_connection() ) );
-	}
-	else
-	{
-		x2goDebug&lt;&lt;&quot;listen server socket error!!: &quot;&lt;&lt;askpass&lt;&lt;endl;
-	}
-}
-
-void sshProcess::printKey ( bool accept )
-{
-	if ( pass!=&quot;&quot; &amp;&amp; pass!=QString::null )
-	{
-		printPass ( accept );
-		return;
-	}
-	cleanEnv();
-	env.insert ( 0, &quot;X2GO_PCOOKIE=X2GO_RSA_DSA_KEY_USED&quot; );
-	if ( accept )
-		env.insert ( 0, &quot;X2GO_PACCEPT=yes&quot; );
-	else
-		env.insert ( 0, &quot;X2GO_PACCEPT=no&quot; );
-	setEnvironment ( env );
-}
-
-QString sshProcess::getResponce()
-{
-	QFile fl ( askpass+&quot;.log&quot; );
-	if ( !fl.open ( QIODevice::ReadOnly | QIODevice::Text ) )
-	{
-		return QString::null;
-	}
-	QTextStream in ( &amp;fl );
-	return in.readAll();
-}
-
-void sshProcess::hidePass()
-{
-	if ( serverSocket )
-	{
-		serverSocket-&gt;close();
-		delete serverSocket;
-		serverSocket=0l;
-	}
-	if ( QFile::exists ( askpass ) )
-		QFile::remove ( askpass );
-}
-
-void sshProcess::startTunnel ( QString h,QString lp,
-                               QString rp,bool rev,bool accept )
-{
-	if(!rev)
-	   x2goDebug&lt;&lt;&quot;tunnel :&quot;&lt;&lt;h&lt;&lt;&quot;:&quot;&lt;&lt;lp&lt;&lt;&quot;:&quot;&lt;&lt;rp&lt;&lt;endl;
-	else
-	   x2goDebug&lt;&lt;&quot;reverse tunnel :&quot;&lt;&lt;h&lt;&lt;&quot;:&quot;&lt;&lt;lp&lt;&lt;&quot;:&quot;&lt;&lt;rp&lt;&lt;endl;
-	isTunnel=true;
-	errorString=&quot;&quot;;
-	needPass=false;
-
-	tunnelHost=h;
-	localPort=lp;
-	remotePort=rp;
-	reverse=rev;
-
-	disconnect ( this,SIGNAL ( error ( QProcess::ProcessError ) ),this,
-	             SLOT ( slot_error ( QProcess::ProcessError ) ) );
-	disconnect ( this,SIGNAL ( finished ( int,QProcess::ExitStatus ) ),this,
-	             SLOT ( slot_finished ( int,QProcess::ExitStatus ) ) );
-	disconnect ( this,SIGNAL ( readyReadStandardError() ),this,
-	             SLOT ( slot_stderr() ) );
-	disconnect ( this,SIGNAL ( readyReadStandardOutput() ),this,
-	             SLOT ( slot_stdout() ) );
-
-	connect ( this,SIGNAL ( error ( QProcess::ProcessError ) ),this,
-	          SLOT ( slot_error ( QProcess::ProcessError ) ) );
-	connect ( this,SIGNAL ( finished ( int,QProcess::ExitStatus ) ),this,
-	          SLOT ( slot_finished ( int,QProcess::ExitStatus ) ) );
-	connect ( this,SIGNAL ( readyReadStandardError() ),this,
-	          SLOT ( slot_stderr() ) );
-	connect ( this,SIGNAL ( readyReadStandardOutput() ),this,
-	          SLOT ( slot_stdout() ) );
-
-	QString params=&quot; -N &quot;;
-	if ( reverse )
-		params+=&quot; -R &quot;;
-	else
-		params+=&quot; -L &quot;;
-	params+=localPort+&quot;:&quot;+tunnelHost+&quot;:&quot;+remotePort;
-	if ( key!=QString::null &amp;&amp; key!=&quot;&quot; )
-	{
-		printKey ( accept );
-#ifndef  Q_OS_WIN
-
-		start ( setsid() +&quot; ssh -c blowfish -v -i \&quot;&quot;+key+&quot;\&quot; -p &quot;+
-		        sshPort+extraOptions+&quot; &quot;+user+&quot;@&quot;+host+params );
-#else
-
-		start ( &quot;ssh -c blowfish -v -i \&quot;&quot;+key+&quot;\&quot; -p &quot;+sshPort+
-		        extraOptions+&quot; &quot;+
-		        user+&quot;@&quot;+host+params );
-#endif
-
-	}
-	else
-	{
-		printPass ( accept );
-#ifndef  Q_OS_WIN
-
-		/*		x2goDebug&lt;&lt;setsid() +&quot; ssh -c blowfish -v &quot;+user+&quot;@&quot;+host+params+
-				        &quot; -p &quot;+sshPort+
-				        extraOptions;*/
-		start ( setsid() +&quot; ssh -c blowfish -v &quot;+user+&quot;@&quot;+host+params+
-		        &quot; -p &quot;+sshPort+
-		        extraOptions );
-#else
-
-		start ( &quot;ssh -c blowfish -v &quot;+user+&quot;@&quot;+host+params+&quot; -p &quot;+
-		        sshPort+
-		        extraOptions );
-#endif
-
-	}
-}
-
-void sshProcess::start_cp ( QString src, QString dst, bool accept )
-{
-// 	x2goDebug&lt;&lt;&quot;copy&quot;&lt;&lt;endl;
-	isCopy=true;
-	errorString=&quot;&quot;;
-	needPass=false;
-	source=src;
-	destination=dst;
-	disconnect ( this,SIGNAL ( error ( QProcess::ProcessError ) ),this,
-	             SLOT ( slot_error ( QProcess::ProcessError ) ) );
-	disconnect ( this,SIGNAL ( finished ( int,QProcess::ExitStatus ) ),this,
-	             SLOT ( slot_finished ( int,QProcess::ExitStatus ) ) );
-	disconnect ( this,SIGNAL ( readyReadStandardError() ),this,
-	             SLOT ( slot_stderr() ) );
-	disconnect ( this,SIGNAL ( readyReadStandardOutput() ),this,
-	             SLOT ( slot_stdout() ) );
-
-	connect ( this,SIGNAL ( error ( QProcess::ProcessError ) ),this,
-	          SLOT ( slot_error ( QProcess::ProcessError ) ) );
-	connect ( this,SIGNAL ( finished ( int,QProcess::ExitStatus ) ),this,
-	          SLOT ( slot_finished ( int,QProcess::ExitStatus ) ) );
-	connect ( this,SIGNAL ( readyReadStandardError() ),this,
-	          SLOT ( slot_stderr() ) );
-	connect ( this,SIGNAL ( readyReadStandardOutput() ),this,
-	          SLOT ( slot_stdout() ) );
-
-	if ( key!=QString::null &amp;&amp; key!=&quot;&quot; )
-	{
-		printKey ( accept );
-#ifndef  Q_OS_WIN
-
-		start ( setsid() +&quot; scp -i \&quot;&quot;+key+&quot;\&quot; -P &quot;+sshPort+
-		        extraOptions+&quot; &quot;+&quot; \&quot;&quot;+
-		        src+&quot;\&quot; &quot;+user+&quot;@&quot;+host+&quot;:&quot;+dst );
-#else
-
-		start ( &quot;scp -i \&quot;&quot;+key+&quot;\&quot; -P &quot;+sshPort+
-		        extraOptions+&quot; &quot;+&quot; \&quot;&quot;+
-		        ONMainWindow::cygwinPath ( src ) +&quot;\&quot; &quot;+
-		        user+&quot;@&quot;+host+&quot;:&quot;+dst );
-
-#endif
-
-	}
-	else
-	{
-		printPass ( accept );
-#ifndef  Q_OS_WIN
-
-		start ( setsid() +&quot; scp -P &quot;+sshPort+extraOptions+&quot; \&quot;&quot;+
-		        src+&quot;\&quot; &quot;+user+&quot;@&quot;+
-		        host+&quot;:&quot;+dst );
-#else
-
-		start ( &quot;scp -P &quot;+sshPort+extraOptions+&quot; \&quot;&quot;+
-		        ONMainWindow::cygwinPath ( src ) +&quot;\&quot; &quot;+
-		        user+&quot;@&quot;+host+
-		        &quot;:&quot;+dst );
-#endif
-	}
-}
-
-
-QString sshProcess::setsid()
-{
-#ifdef Q_OS_DARWIN
-	//run setsid from bundle
-	QDir dir ( QApplication::applicationDirPath() );
-	dir.cdUp();
-	dir.cd ( &quot;exe&quot; );
-	return &quot;\&quot;&quot;+dir.absolutePath() +&quot;/setsid\&quot;&quot;;
-#else
-#ifdef Q_WS_HILDON
-	return &quot;/usr/lib/x2go/setsid&quot;;
-#endif
-	return &quot;setsid&quot;;
-#endif
-}
-
-void sshProcess::setErrorString ( const QString&amp; str )
-{
-	if ( sudoErr )
-		errorString=str;
-}
-
-QString sshProcess::cookie()
-{
-	QString res;
-	for ( uint i=0;i&lt;16;++i )
-	{
-		QString hex;
-		hex.sprintf ( &quot;%02X&quot;,qrand() );
-		res+=hex;
-	}
-	return res;
-}
-
-
-void sshProcess::cleanEnv ( bool all )
-{
-	for ( int i=env.count()-1;i&gt;=0;--i )
-	{
-		if ( all )
-		{
-			if ( ( env[i].indexOf ( &quot;X2GO_PCOOKIE&quot; ) !=-1 ) ||
-			        ( env[i].indexOf ( &quot;X2GO_PACCEPT&quot; ) !=-1 ) ||
-			        ( env[i].indexOf ( &quot;GPG_AGENT_INFO&quot; ) !=-1 ) ||
-			        ( env[i].indexOf ( &quot;SSH_AUTH_SOCK&quot; ) !=-1 ) ||
-			        ( env[i].indexOf ( &quot;SSH_AGENT_PID&quot; ) !=-1 ) )
-			{
-				env.removeAt ( i );
-			}
-		}
-		else
-		{
-			if ( ( env[i].indexOf ( &quot;X2GO_PCOOKIE&quot; ) !=-1 ) ||
-			        ( env[i].indexOf ( &quot;X2GO_PACCEPT&quot; ) !=-1 ) )
-			{
-				env.removeAt ( i );
-			}
-		}
-	}
-}
-
-void sshProcess::slot_pass_connection()
-{
-	if ( localSocket )
-		delete localSocket;
-	localSocket=serverSocket-&gt;nextPendingConnection ();
-	if ( localSocket )
-	{
-		connect ( localSocket,SIGNAL ( readyRead() ),this,
-		          SLOT ( slot_read_cookie_from_socket() ) );
-	}
-}
-
-void sshProcess::slot_read_cookie_from_socket()
-{
-	char buffer[140];
-	int read=localSocket-&gt;read ( buffer,139 );
-	if ( read&lt;=0 )
-	{
-		QString message=&quot;Cannot get cookie from askpass program&quot;;
-		throw message;
-	}
-	buffer[read]=0;
-	QString cookie ( buffer );
-	if ( cookie!=passcookie )
-	{
-		QString message=&quot;Got wrong cookie from askpass program&quot;;
-		throw message;
-	}
-	localSocket-&gt;write ( pass.toAscii().data(),pass.toAscii().length() );
-	QTimer::singleShot ( 100, this, SLOT ( hidePass() ) );
-}
-
-
-
-void sshProcess::setEnvironment ( QStringList newEnv )
-{
-	env+=newEnv;
-	QProcess::setEnvironment ( env );
-}
diff --git a/sshprocess.h b/sshprocess.h
index 2bc4238..09acd71 100644
--- a/sshprocess.h
+++ b/sshprocess.h
@@ -86,6 +86,7 @@ private slots:
     void slotIOerr(SshProcess* creator,QString message, QString sshSessionErr);
     void slotChannelClosed(SshProcess* creator, QString uuid);
     void slotReverseTunnelOk(SshProcess* creator);
+    void slotReverseTunnelFailed(SshProcess* creator, QString error);
     void slotCopyOk(SshProcess* creator);
     void slotCopyErr(SshProcess* creator,QString message, QString sshSessionErr);
     //krb stuff
diff --git a/sshprocess.h.bc b/sshprocess.h.bc
deleted file mode 100644
index 3f12bae..0000000
--- a/sshprocess.h.bc
+++ /dev/null
@@ -1,92 +0,0 @@
-//
-// C++ Interface: sshprocess
-//
-// Description:
-//
-//
-// Author: Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;, (C) 2006
-//
-// Copyright: See COPYING file that comes with this distribution
-//
-//
-#include &quot;x2goclientconfig.h&quot;
-#ifndef SSHPROCESS_H
-#define SSHPROCESS_H
-
-#include &lt;QProcess&gt;
-
-/**
-	@author Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
-*/
-class QLocalServer;
-class QLocalSocket;
-struct SshProxy;
-class sshProcess : public QProcess
-{
-		Q_OBJECT
-	public:
-		sshProcess ( QObject* parent, const SshProxy* proxy,
-		             const QString&amp; user,
-		             const QString&amp; host,const QString&amp; pt,
-		             const QString&amp; cmd, const QString&amp; pass,
-		             const QString&amp; key=QString::null,
-		             bool acc=false );
-		virtual ~sshProcess();
-		void startNormal ( bool accept=false );
-		QString getResponce();
-		void startTunnel ( QString host,QString localPort,QString remotePort,
-		                   bool reverse=false,bool accept=false );
-		void start_cp ( QString src, QString dst, bool accept=false );
-		QString getSource() {return source;}
-		QString setsid();
-		void setErrorString ( const QString&amp; str );
-		void setFwX ( bool s ) {fwX=s;}
-		virtual void setEnvironment ( QStringList newEnv );
-	private:
-		QString askpass;
-		QString user;
-		QString host;
-		QString command;
-		QString pass;
-		QString key;
-		QString errorString;
-		QString outputString;
-		QString passcookie;
-		QLocalServer* serverSocket;
-		QLocalSocket* localSocket;
-		bool needPass;
-		bool autoAccept;
-		bool isTunnel;
-		bool isCopy;
-		QString sshPort;
-		QString tunnelHost;
-		QString localPort;
-		QString source;
-		QString destination;
-		QString remotePort;
-		QStringList env;
-		bool reverse;
-		bool fwX;
-		bool sudoErr;
-		QString extraOptions;
-
-	private slots:
-		void slot_error ( QProcess::ProcessError );
-		void slot_finished ( int, QProcess::ExitStatus );
-		void slot_stderr();
-		void slot_stdout();
-		void hidePass();
-		void slot_pass_connection();
-		void slot_read_cookie_from_socket();
-	private:
-		void printPass ( bool accept=false );
-		void printKey ( bool accept=false );
-		QString cookie();
-		void cleanEnv ( bool all=false );
-	signals:
-		void sshFinished ( bool,QString,sshProcess* );
-		void sudoConfigError ( QString,sshProcess* );
-		void sshTunnelOk();
-};
-
-#endif

--
Alioth's /srv/git/_hooks_/post-receive-email on /srv/git/code.x2go.org/x2goclient.git
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026124.html">[X2Go-Commits] [x2goclient] 02/02: move SSH classes rewrite to new release series 4.0.2.x
</A></li>
	<LI>Next message: <A HREF="026126.html">[X2Go-Commits] [x2goclient] 02/03: set mod map from client to server on Mac, hide keyboard settings on Mac
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26125">[ date ]</a>
              <a href="thread.html#26125">[ thread ]</a>
              <a href="subject.html#26125">[ subject ]</a>
              <a href="author.html#26125">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/x2go-commits">More information about the X2Go-commits
mailing list</a><br>
</body></html>
