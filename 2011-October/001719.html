<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [X2go-Commits] x2godesktopsharing.git - build-main (branch)	updated: 3.0.1.3
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/x2go-commits/2011-October/index.html" >
   <LINK REL="made" HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2go-Commits%5D%20x2godesktopsharing.git%20-%20build-main%20%28branch%29%0A%09updated%3A%203.0.1.3&In-Reply-To=%3C20111012092003.37D765DD11%40ymir%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001718.html">
   <LINK REL="Next"  HREF="001720.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[X2go-Commits] x2godesktopsharing.git - build-main (branch)	updated: 3.0.1.3</H1>
    <B>X2go dev team</B> 
    <A HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2go-Commits%5D%20x2godesktopsharing.git%20-%20build-main%20%28branch%29%0A%09updated%3A%203.0.1.3&In-Reply-To=%3C20111012092003.37D765DD11%40ymir%3E"
       TITLE="[X2go-Commits] x2godesktopsharing.git - build-main (branch)	updated: 3.0.1.3">git-admin at x2go.org
       </A><BR>
    <I>Wed Oct 12 11:20:02 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="001718.html">[X2go-Commits] x2godesktopsharing.git - master (branch) updated:	3.0.1.2-34-g0d8c6ad
</A></li>
        <LI>Next message: <A HREF="001720.html">[X2go-Commits] nx-x11.git - master (branch) created:	80ba46ddaa9769ae0008ea3a791239764235c305
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1719">[ date ]</a>
              <a href="thread.html#1719">[ thread ]</a>
              <a href="subject.html#1719">[ subject ]</a>
              <a href="author.html#1719">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch, build-main has been updated
       via  0d8c6ada8efc63d78d114cd49cff08cbe281257e (commit)
       via  f1c63f7ce96103df55065dd2eccd399ef62e865f (commit)
       via  0d4198a2a0e28e1984995ad8b60c132303d61c61 (commit)
       via  65513d1ac3a1d04eb168d14745edd49e2927f737 (commit)
       via  d7dfa95bf6f99174a9a88adae3b3de68b57aa7d8 (commit)
       via  a9be575d798f9cf7674f232becd9abddc63ec0ab (commit)
       via  090e7aff4281c5fa3bbc441962bbdc6056cb73c8 (commit)
       via  dc2af16a85f83b4b1ebe9ce9079d6f00c8ab5c3e (commit)
       via  7d7533aa07b347e105a6b02557d7732183579a48 (commit)
       via  4802e527534545c7ecb17d977d193e5cc246d57d (commit)
       via  caf8fd6bfb2f094a64effac706a7cb0202c2124b (commit)
       via  0d49dfdde6ee62e21c709de027a6f80576d88727 (commit)
       via  ae952c3ad02ebd5231b425cfcc13c8a6515c01d8 (commit)
       via  afbd6ea63298d948d3543143e13ed12db7b3fddd (commit)
       via  10d8ce59c44d6fdc17ff4823efb307a36cbfa79d (commit)
       via  d1674883c091c3a532011a31bb2c17d35cb7b725 (commit)
       via  91df9e9278ea7dcb4bc17d1f8a934af0dfdd909d (commit)
       via  3c4601b7ec0af5717bdd9e6983e451efd1c4b67f (commit)
       via  0720d15908712b9f3c3390e46515bdd3fcd8b550 (commit)
       via  cf356157e83da59220ab7af3c8bb71f722b3e754 (commit)
       via  619fa9d40858791b1bf98754ed110c606c634005 (commit)
       via  a17eb04222eac5aee009924f004df2ad6342eb34 (commit)
       via  37b57f64cab0f715aae80056a5c0053eafb3390d (commit)
       via  05b2d0b00809da05a1e9f30ea4b1fdb71612a861 (commit)
       via  3f8822957798a3b61415f9bf358fd08266144854 (commit)
       via  e9168f26a14d6d2c5215285966a534b73b974118 (commit)
       via  4b8c2abb58aa34828aed15d5d7b336a785ca8bc9 (commit)
       via  91e0971284d686e42f444e312cf3220ea22ea6f9 (commit)
       via  4cf4a0b2dad35e92ddaac712c9d2b6f513cd4a46 (commit)
       via  ecfddd98ebfd7f844942ebba155240ba7a388e22 (commit)
       via  b84f97efa59e4643b32927f752332ad30a98c160 (commit)
       via  68851b594c736924659ee40696317b8c0bc9c27d (commit)
       via  308d4207bf44963ce7c31984531d175b238de42d (commit)
       via  80ba9339306dd2c7283be72389dca892df4bf85d (commit)
      from  8aaf4bd12b80f30767983f299c9581d5d73916c0 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
-----------------------------------------------------------------------

Summary of changes:
 Doxyfile                                        |    6 +-
 VERSION                                         |    1 -
 VERSION.x2godesktopsharing                      |    1 +
 bin/x2goresume-desktopsharing                   |   39 +
 bin/x2gosuspend-desktopsharing                  |   34 +
 bin/x2goterminate-desktopsharing                |   46 ++
 debian/changelog                                |   23 +
 debian/control                                  |    7 +-
 debian/rules                                    |    2 +-
 debian/x2godesktopsharing.dirs                  |   12 +-
 debian/x2godesktopsharing.install               |    3 +
 debian/x2godesktopsharing.manpages              |    3 +-
 debian/x2godesktopsharing.postinst              |    4 +-
 main.cpp                                        |  215 ++++---
 man/{ =&gt; man1}/x2godesktopsharing.1             |    6 +-
 man/man8/x2goresume-desktopsharing.8            |   28 +
 man/man8/x2gosuspend-desktopsharing.8           |   37 +
 man/man8/x2goterminate-desktopsharing.8         |   30 +
 share/x2gofeature.d/x2godesktopsharing.features |   36 +
 sharetray.cpp                                   |  871 +++++++++++++----------
 sharetray.h                                     |  111 ++--
 21 files changed, 980 insertions(+), 535 deletions(-)
 delete mode 100644 VERSION
 create mode 100644 VERSION.x2godesktopsharing
 create mode 100755 bin/x2goresume-desktopsharing
 create mode 100755 bin/x2gosuspend-desktopsharing
 create mode 100755 bin/x2goterminate-desktopsharing
 create mode 100644 debian/x2godesktopsharing.install
 rename man/{ =&gt; man1}/x2godesktopsharing.1 (77%)
 create mode 100644 man/man8/x2goresume-desktopsharing.8
 create mode 100644 man/man8/x2gosuspend-desktopsharing.8
 create mode 100644 man/man8/x2goterminate-desktopsharing.8
 create mode 100755 share/x2gofeature.d/x2godesktopsharing.features

The diff of changes is:
diff --git a/Doxyfile b/Doxyfile
index 03042a9..fc8159f 100644
--- a/Doxyfile
+++ b/Doxyfile
@@ -4,7 +4,7 @@
 # Project related configuration options
 #---------------------------------------------------------------------------
 DOXYFILE_ENCODING      = UTF-8
-PROJECT_NAME           = x2godesktopshare
+PROJECT_NAME           = x2godesktopsharing
 PROJECT_NUMBER         = 1
 OUTPUT_DIRECTORY       = 
 CREATE_SUBDIRS         = NO
@@ -93,7 +93,7 @@ WARN_LOGFILE           =
 #---------------------------------------------------------------------------
 # configuration options related to the input files
 #---------------------------------------------------------------------------
-INPUT                  = /usr/src.cur/db-builds/x2godesktopshare/x2godesktopshare-3.0.1
+INPUT                  = /usr/src.cur/db-builds/x2godesktopsharing/x2godesktopsharing-3.0.1.3
 INPUT_ENCODING         = UTF-8
 FILE_PATTERNS          = *.c \
                          *.cc \
@@ -272,7 +272,7 @@ SKIP_FUNCTION_MACROS   = YES
 # Configuration::additions related to external references   
 #---------------------------------------------------------------------------
 TAGFILES               = 
-GENERATE_TAGFILE       = x2godesktopshare.tag
+GENERATE_TAGFILE       = x2godesktopsharing.tag
 ALLEXTERNALS           = NO
 EXTERNAL_GROUPS        = YES
 PERL_PATH              = /usr/bin/perl
diff --git a/VERSION b/VERSION
deleted file mode 100644
index cd0a3b6..0000000
--- a/VERSION
+++ /dev/null
@@ -1 +0,0 @@
-3.0.1.2
diff --git a/VERSION.x2godesktopsharing b/VERSION.x2godesktopsharing
new file mode 100644
index 0000000..e9aef23
--- /dev/null
+++ b/VERSION.x2godesktopsharing
@@ -0,0 +1 @@
+3.0.1.3
diff --git a/bin/x2goresume-desktopsharing b/bin/x2goresume-desktopsharing
new file mode 100755
index 0000000..aaa2c25
--- /dev/null
+++ b/bin/x2goresume-desktopsharing
@@ -0,0 +1,39 @@
+#!/bin/bash
+
+# Copyright (C) 2007-2011 X2go Project - <A HREF="http://wiki.x2go.org">http://wiki.x2go.org</A>
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the
+# Free Software Foundation, Inc.,
+# 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA.
+#
+# Copyright (C) 2011  Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
+# Copyright (C) 2011  Heinz-Markus Graesing &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">heinz-m.graesing at obviously-nice.de</A>&gt;
+# Copyright (C) 2011  Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
+
+if [ $# -eq 1   ]; then
+	SESSION_NAME=$1
+else 
+	SESSION_NAME=$X2GO_SESSION
+fi
+
+X2GO_LIB_PATH=`echo -n \$(x2gobasepath)/lib/x2go`
+
+$X2GO_LIB_PATH/x2gosyslog &quot;$0&quot; &quot;info&quot; &quot;$(basename $0) called with options: $@&quot;
+
+X2GO_DISPLAY=$(echo $SESSION_NAME | cut -d&quot;-&quot; -f2)
+
+test -e $HOME/.x2go/C-$SESSION_NAME/resume-desktopsharing &amp;&amp; {
+	rm -f $HOME/.x2go/C-$SESSION_NAME/resume-desktopsharing
+	DISPLAY=:$X2GO_DISPLAY.0 x2godesktopsharing &amp;&gt;/dev/null &amp;
+}
diff --git a/bin/x2gosuspend-desktopsharing b/bin/x2gosuspend-desktopsharing
new file mode 100755
index 0000000..676cab1
--- /dev/null
+++ b/bin/x2gosuspend-desktopsharing
@@ -0,0 +1,34 @@
+#!/bin/bash
+
+# Copyright (C) 2007-2011 X2go Project - <A HREF="http://wiki.x2go.org">http://wiki.x2go.org</A>
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the
+# Free Software Foundation, Inc.,
+# 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA.
+#
+# Copyright (C) 2011  Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
+# Copyright (C) 2011  Heinz-Markus Graesing &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">heinz-m.graesing at obviously-nice.de</A>&gt;
+# Copyright (C) 2011  Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
+
+if [ $# -eq 1   ]; then
+	SESSION_NAME=$1
+else 
+	SESSION_NAME=$X2GO_SESSION
+fi
+
+X2GO_LIB_PATH=`echo -n \$(x2gobasepath)/lib/x2go`
+
+$X2GO_LIB_PATH/x2gosyslog &quot;$0&quot; &quot;info&quot; &quot;$(basename $0) called with options: $@&quot;
+
+x2goterminate-desktopsharing $SESSION_NAME &amp;&amp; touch $HOME/.x2go/C-$SESSION_NAME/resume-desktopsharing
diff --git a/bin/x2goterminate-desktopsharing b/bin/x2goterminate-desktopsharing
new file mode 100755
index 0000000..bbf7675
--- /dev/null
+++ b/bin/x2goterminate-desktopsharing
@@ -0,0 +1,46 @@
+#!/bin/bash
+
+# Copyright (C) 2007-2011 X2go Project - <A HREF="http://wiki.x2go.org">http://wiki.x2go.org</A>
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the
+# Free Software Foundation, Inc.,
+# 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA.
+#
+# Copyright (C) 2011  Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
+# Copyright (C) 2011  Heinz-Markus Graesing &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">heinz-m.graesing at obviously-nice.de</A>&gt;
+# Copyright (C) 2011  Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
+
+if [ $# -eq 1   ]; then
+	SESSION_NAME=$1
+else 
+	SESSION_NAME=$X2GO_SESSION
+fi
+
+X2GO_LIB_PATH=`echo -n \$(x2gobasepath)/lib/x2go`
+
+$X2GO_LIB_PATH/x2gosyslog &quot;$0&quot; &quot;info&quot; &quot;$(basename $0) called with options: $@&quot;
+
+
+X2GO_DISPLAY=$(echo $SESSION_NAME | cut -d&quot;-&quot; -f2)
+for process_id in `pidof x2godesktopsharing`; do
+	env_of_process=$(cat -A /proc/$process_id/environ)
+	env_of_process=${env_of_process//^@/\\n}
+	display=$(echo -e $env_of_process | egrep &quot;^DISPLAY=.*$&quot; | cut -d&quot;=&quot; -f2)
+	if echo $display | grep &quot;:$X2GO_DISPLAY&quot; &amp;&gt;/dev/null; then
+		kill -SIGTERM $process_id
+		exit 0
+	fi
+done
+
+exit -1
diff --git a/debian/changelog b/debian/changelog
index c4bd217..97f169f 100644
--- a/debian/changelog
+++ b/debian/changelog
@@ -1,3 +1,26 @@
+x2godesktopsharing (3.0.1.3-0~x2go1) unstable; urgency=low
+
+  * New upstream version (3.0.1.3):
+    - Fix incomplete DENY statement in main.cpp.
+    - System group for x2godesktopsharing changed from x2gousers -&gt;
+      x2godesktopsharing.
+    - Differentiate between local and remote user, fixes display of wrong
+      user name for remote user.
+    - Add signal handler so that unix signals can be handled within Qt.
+    - Add script x2godesktopsharing-terminate: detect x2godesktopsharing process
+      of a given session and terminate that process.
+    - Save settings and tidy up lock and socket file on X-Server crash.
+    - Provide feature for suspending/resuming x2godesktopsharing
+      (x2godesktopsharing will be terminated on x2gosuspend-session and
+      operations will be resumed on x2goresume-session).
+    - Add man pages for x2go&lt;action&gt;-desktopsharing commands, re-arrange man
+      page folders in source project.
+  * Depend on x2goserver (&gt;=3.0.99.6).
+  * Make sure postinst script does not fail when checking for existence
+    of group x2godesktopsharing.
+
+ -- Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;  Wed, 12 Oct 2011 11:17:38 +0200
+
 x2godesktopsharing (3.0.1.2-0~x2go1) unstable; urgency=low
 
   * change of version numbering scheme
diff --git a/debian/control b/debian/control
index 7c7b9c3..94119f0 100644
--- a/debian/control
+++ b/debian/control
@@ -6,14 +6,17 @@ Uploaders: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
 Build-Depends:
  debhelper (&gt;= 7),
  libqt4-dev
-Standards-Version: 3.9.1
+Standards-Version: 3.9.2
+Homepage: <A HREF="http://code.x2go.org/releases/source/x2godesktopsharing">http://code.x2go.org/releases/source/x2godesktopsharing</A>
+Vcs-Git: <A HREF="git://code.x2go.org/x2godesktopsharing.git">git://code.x2go.org/x2godesktopsharing.git</A>
+Vcs-Browser: <A HREF="http://code.x2go.org/gitweb?p=x2godesktopsharing.git;a=summary">http://code.x2go.org/gitweb?p=x2godesktopsharing.git;a=summary</A>
 
 Package: x2godesktopsharing
 Architecture: any
 Depends:
  ${misc:Depends},
  ${shlibs:Depends},
- x2goserver (&gt;= 3.0.99),
+ x2goserver (&gt;= 3.0.99.6-0~),
  libqt4-gui,
 Recommends:
 Description: share X2go desktops with other users (via shadow sessions)
diff --git a/debian/rules b/debian/rules
index 57f35f4..6add866 100755
--- a/debian/rules
+++ b/debian/rules
@@ -78,7 +78,7 @@ binary-arch: build install
 	dh_installchangelogs 
 	dh_installdocs
 	dh_installexamples
-#	dh_install
+	dh_install
 	dh_installmenu
 #	dh_installdebconf	
 #	dh_installlogrotate
diff --git a/debian/x2godesktopsharing.dirs b/debian/x2godesktopsharing.dirs
index bd2db4c..7e4dcd7 100644
--- a/debian/x2godesktopsharing.dirs
+++ b/debian/x2godesktopsharing.dirs
@@ -1,8 +1,10 @@
 usr/bin
-usr/share/applications/
+usr/share/applications
 usr/share/x2godesktopsharing
 usr/share/x2godesktopsharing/icons
-usr/share/icons/hicolor/128x128/apps/
-usr/share/icons/hicolor/16x16/apps/
-usr/share/icons/hicolor/64x64/apps/
-usr/share/icons/hicolor/32x32/apps/
+usr/share/icons/hicolor/128x128/apps
+usr/share/icons/hicolor/16x16/apps
+usr/share/icons/hicolor/64x64/apps
+usr/share/icons/hicolor/32x32/apps
+usr/share/x2go
+usr/share/x2go/versions
diff --git a/debian/x2godesktopsharing.install b/debian/x2godesktopsharing.install
new file mode 100644
index 0000000..1e51109
--- /dev/null
+++ b/debian/x2godesktopsharing.install
@@ -0,0 +1,3 @@
+VERSION.x2godesktopsharing      usr/share/x2go/versions
+bin/*                           usr/bin/
+share/*                         usr/share/x2go/
\ No newline at end of file
diff --git a/debian/x2godesktopsharing.manpages b/debian/x2godesktopsharing.manpages
index 7aee1a9..ad46900 100644
--- a/debian/x2godesktopsharing.manpages
+++ b/debian/x2godesktopsharing.manpages
@@ -1 +1,2 @@
-man/x2godesktopsharing.1
\ No newline at end of file
+man/man1/x2godesktopsharing.1
+man/man8/x2go*-desktopsharing.8
diff --git a/debian/x2godesktopsharing.postinst b/debian/x2godesktopsharing.postinst
index 2f7b721..6fd8a1a 100755
--- a/debian/x2godesktopsharing.postinst
+++ b/debian/x2godesktopsharing.postinst
@@ -22,10 +22,10 @@ set -e
 
 case &quot;$1&quot; in
     configure)
-    X2GOGRP=`getent group | grep x2gousers`
+    X2GOGRP=`getent group | grep x2godesktopsharing || true`
     if [ &quot;x$X2GOGRP&quot;=&quot;x&quot; ]
     then 
-         addgroup --system x2gousers
+         addgroup --system x2godesktopsharing
     fi
     ;;
 
diff --git a/main.cpp b/main.cpp
index 636c43c..d3733b5 100644
--- a/main.cpp
+++ b/main.cpp
@@ -26,102 +26,141 @@
 #include &lt;QLocalSocket&gt;
 #include &lt;iostream&gt;
 #include &lt;QDir&gt;
-
+#include &lt;csignal&gt;
 
 using namespace std;
 
 void  client ( const QStringList &amp; cmd )
 {
 
-    if ( cmd.size() !=10 )
-    {
-        cerr&lt;&lt;&quot;wrong parameters&quot;&lt;&lt;endl;
-        cout&lt;&lt;&quot;DEN&quot;;
-	return;
-    }
-    QStringList params=cmd[9].split ( &quot;XSHAD&quot; );
-    if ( params.size() !=3 )
-    {
-        cerr&lt;&lt;&quot;wrong parameters&quot;&lt;&lt;endl;
-        cout&lt;&lt;&quot;DEN&quot;;
-	return;
-    }
-
-    cerr&lt;&lt;&quot;starting x2godesktopsharing in client mode, cmd: &quot;&lt;&lt;
-        cmd.join(&quot; &quot;).toAscii().data() &lt;&lt;std::endl;
-
-    QString dispname=params[2];
-    QString socketName=QDir::tempPath() +&quot;/x2godesktopsharing_@&quot;+
-                       params[1]+&quot;@&quot;+dispname;
-    QLocalSocket sock;
-    sock.connectToServer ( socketName );
-    if ( !sock.waitForConnected ( 3000 ) )
-    {
-        QString message=&quot;Unable to connect: &quot; +socketName;
-        cout&lt;&lt;&quot;DEN&quot;;
-        cerr&lt;&lt;message.toAscii().data() &lt;&lt;endl;
-	return;
-    }
-    sock.write ( cmd.join(&quot; &quot;).toAscii().data(),cmd.join(&quot; &quot;).toAscii().length() );
-    if ( !sock.waitForReadyRead() )
-    {
-        cout&lt;&lt;&quot;DEN&quot;;
-        cerr&lt;&lt;&quot;Cannot write to socket: &quot;&lt;&lt;socketName.toAscii().data() &lt;&lt;endl;
-        return;;
-    }
-    char buffer[256];
-    int read=sock.read ( buffer,255 );
-    if ( read&lt;=0 )
-    {
-        cout&lt;&lt;&quot;DEN&quot;;
-        cerr&lt;&lt;&quot;Cannot read from socket: &quot; &lt;&lt;socketName.toAscii().data() &lt;&lt;endl;
-        return;    
-    }
-    buffer[read]=0;
-    cout&lt;&lt;buffer&lt;&lt;endl;
+	if ( cmd.size() !=11 )
+	{
+		cerr&lt;&lt;&quot;wrong parameters&quot;&lt;&lt;endl;
+		cout&lt;&lt;&quot;DENY&quot;;
+		return;
+	}
+	QStringList params=cmd[9].split ( &quot;XSHAD&quot; );
+	if ( params.size() !=3 )
+	{
+		cerr&lt;&lt;&quot;wrong parameters&quot;&lt;&lt;endl;
+		cout&lt;&lt;&quot;DENY&quot;;
+		return;
+	}
+
+	cerr&lt;&lt;&quot;starting x2godesktopsharing in client mode, cmd: &quot;&lt;&lt;
+	cmd.join(&quot; &quot;).toAscii().data() &lt;&lt;std::endl;
+
+	QString dispname=params[2];
+	QString socketName=QDir::tempPath() +&quot;/x2godesktopsharing_@&quot;+
+	                   params[1]+&quot;@&quot;+dispname;
+	QLocalSocket sock;
+	sock.connectToServer ( socketName );
+	if ( !sock.waitForConnected ( 3000 ) )
+	{
+		QString message=&quot;Unable to connect: &quot; +socketName;
+		cout&lt;&lt;&quot;DENY&quot;;
+		cerr&lt;&lt;message.toAscii().data() &lt;&lt;endl;
+		return;
+	}
+	sock.write ( cmd.join(&quot; &quot;).toAscii().data(),cmd.join(&quot; &quot;).toAscii().length() );
+	if ( !sock.waitForReadyRead() )
+	{
+		cout&lt;&lt;&quot;DENY&quot;;
+		cerr&lt;&lt;&quot;Cannot write to socket: &quot;&lt;&lt;socketName.toAscii().data() &lt;&lt;endl;
+		return;;
+	}
+	char buffer[256];
+	int read=sock.read ( buffer,255 );
+	if ( read&lt;=0 )
+	{
+		cout&lt;&lt;&quot;DENY&quot;;
+		cerr&lt;&lt;&quot;Cannot read from socket: &quot; &lt;&lt;socketName.toAscii().data() &lt;&lt;endl;
+		return;
+	}
+	buffer[read]=0;
+	cout&lt;&lt;buffer&lt;&lt;endl;
+}
+
+static int setup_unix_signal_handlers()
+{
+	struct sigaction keybint, term, abort, hup;
+
+	keybint.sa_handler = ShareTray::keybintSignalHandler;
+	sigemptyset(&amp;keybint.sa_mask);
+	keybint.sa_flags = 0;
+	keybint.sa_flags |= SA_RESTART;
+
+	if (sigaction(SIGINT, &amp;keybint, 0) &gt; 0)
+		return 1;
+
+	term.sa_handler = ShareTray::termSignalHandler;
+	sigemptyset(&amp;term.sa_mask);
+	term.sa_flags |= SA_RESTART;
+
+	if (sigaction(SIGTERM, &amp;term, 0) &gt; 0)
+	return 2;
+
+	abort.sa_handler = ShareTray::abortSignalHandler;
+	sigemptyset(&amp;abort.sa_mask);
+	abort.sa_flags |= SA_RESTART;
+
+	if (sigaction(SIGABRT, &amp;abort, 0) &gt; 0)
+	return 3;
+
+	hup.sa_handler = ShareTray::hupSignalHandler;
+	sigemptyset(&amp;hup.sa_mask);
+	hup.sa_flags |= SA_RESTART;
+
+	if (sigaction(SIGHUP, &amp;hup, 0) &gt; 0)
+	return 4;
+
+	return 0;
 }
 
 int main ( int argc, char *argv[] )
 {
-    if ( argc&gt;2 )
-    {
-        QString par=argv[1];
-        if ( par == &quot;client&quot; )
-        {
-            QStringList cmdl;
-            for ( int i=2; i&lt;argc;++i )
-                cmdl&lt;&lt;argv[i];
-            client ( cmdl );
-            return 0;
-        }
-    }
-
-    QApplication app ( argc,argv );
-    QTranslator translator;
-    QString filename=QString ( &quot;:/x2godesktopsharing_%1&quot; ).arg (
-                         QLocale::system().name() );
-    filename=filename.toLower();
-    if ( !translator.load ( filename ) )
-    {
-        qDebug ( &quot;Can't load translator (%s) !\n&quot;,
-                 filename.toLocal8Bit().data() );
-    }
-    else
-        app.installTranslator ( &amp;translator );
-
-
-    QTranslator qtTranslator;
-    filename=QString ( &quot;:/qt_%1&quot; ).arg ( QLocale::system().name() );
-    if ( !qtTranslator.load ( filename ) )
-    {
-        qDebug ( &quot;Can't load translator (%s) !\n&quot;,
-                 filename.toLocal8Bit().data() );
-    }
-    else
-        app.installTranslator ( &amp;qtTranslator );
-    ShareTray* tray=new ShareTray;
-    tray-&gt;hide();
-
-
-    return app.exec();
+	if ( argc&gt;2 )
+	{
+		QString par=argv[1];
+		if ( par == &quot;client&quot; )
+		{
+			QStringList cmdl;
+			for ( int i=2; i&lt;argc;++i )
+			cmdl&lt;&lt;argv[i];
+			client ( cmdl );
+			return 0;
+		}
+	}
+
+	QApplication app ( argc,argv );
+	QTranslator translator;
+	QString filename=QString ( &quot;:/x2godesktopsharing_%1&quot; ).arg (
+	                 QLocale::system().name() );
+	filename=filename.toLower();
+	if ( !translator.load ( filename ) )
+	{
+		qDebug ( &quot;Can't load translator (%s) !\n&quot;,
+		         filename.toLocal8Bit().data() );
+	}
+	else
+		app.installTranslator ( &amp;translator );
+
+	QTranslator qtTranslator;
+	filename=QString ( &quot;:/qt_%1&quot; ).arg ( QLocale::system().name() );
+	if ( !qtTranslator.load ( filename ) )
+	{
+		qDebug ( &quot;Can't load translator (%s) !\n&quot;,
+		         filename.toLocal8Bit().data() );
+	}
+	else
+		app.installTranslator ( &amp;qtTranslator );
+
+	ShareTray* tray=new ShareTray;
+	tray-&gt;hide();
+	setup_unix_signal_handlers();
+	try {
+		return app.exec();
+	} catch (const std::bad_alloc &amp;) {
+		tray-&gt;slotMenuClose();
+	}
 }
diff --git a/man/x2godesktopsharing.1 b/man/man1/x2godesktopsharing.1
similarity index 77%
rename from man/x2godesktopsharing.1
rename to man/man1/x2godesktopsharing.1
index 2fba34c..eb154a1 100644
--- a/man/x2godesktopsharing.1
+++ b/man/man1/x2godesktopsharing.1
@@ -5,7 +5,7 @@
 \\$2 \(la\\$1\(ra\\$3
 ..
 .if \n(.g .mso www.tmac
-.TH x2godesktopsharing 1 &quot;14 Apr 2011&quot; &quot;Version 3.0.1.2&quot; &quot;X2go Application&quot;
+.TH x2godesktopsharing 1 &quot;14 Apr 2011&quot; &quot;Version 3.0.1.x&quot; &quot;X2go Application&quot;
 .SH NAME
 x2godesktopsharing \- Share an X2go desktop with other clients and users.
 .SH SYNOPSIS
@@ -15,8 +15,8 @@ x2godesktopsharing \- Share an X2go desktop with other clients and users.
 \fBx2godesktopsharing\fR 
 
 .SH DESCRIPTION
-\fBx2godesktopsharing\fR is a system tray tool that allows a user to control access his/her X2go
-session (via shadow sessions).
+\fBx2godesktopsharing\fR is a system tray tool that allows a user to give/control access to his/her X/X2go
+session (via shadow session support in NX libraries).
 .PP
 .SH OPTIONS
 \fBx2godesktopsharing\fR has no known options.
diff --git a/man/man8/x2goresume-desktopsharing.8 b/man/man8/x2goresume-desktopsharing.8
new file mode 100644
index 0000000..dc6fd28
--- /dev/null
+++ b/man/man8/x2goresume-desktopsharing.8
@@ -0,0 +1,28 @@
+'\&quot; -*- coding: utf-8 -*-
+.if \n(.g .ds T&lt; \\FC
+.if \n(.g .ds T&gt; \\F[\n[.fam]]
+.de URL
+\\$2 \(la\\$1\(ra\\$3
+..
+.if \n(.g .mso www.tmac
+.TH x2goresume-desktopsharing 8 &quot;Sep 2011&quot; &quot;Version 3.0.99.x&quot; &quot;X2go Server Tool&quot;
+.SH NAME
+x2goresume-desktopsharing \- Resume Desktop Sharing Applet for a given X2go Session
+.SH SYNOPSIS
+'nh
+.fi
+.ad l
+x2goresume-desktopsharing &lt;session_id&gt;
+
+.SH DESCRIPTION
+\fBx2goresume-desktopsharing\fR launches the \fBx2godesktopsharing\fR applet for X2go session &lt;session_id&gt;.
+.PP
+\fBx2goresume-desktopsharing\fR is run with normal user privileges and it is used from within X2go Server.
+There normally is no need to execute this command manually.
+.SH RETURN VALUES
+As exitcode \fBx2goresume-desktopsharing\fR always returns 0.
+.SH SEE ALSO
+x2godesktopsharing(1), x2goresume-session(8), x2gosuspend-desktopsharing(8), x2goterminate-desktopsharing(8)
+.SH AUTHOR
+This manual has been written by Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt; for the X2go project
+(<A HREF="http://www.x2go.org">http://www.x2go.org</A>).
diff --git a/man/man8/x2gosuspend-desktopsharing.8 b/man/man8/x2gosuspend-desktopsharing.8
new file mode 100644
index 0000000..6f7b6b4
--- /dev/null
+++ b/man/man8/x2gosuspend-desktopsharing.8
@@ -0,0 +1,37 @@
+'\&quot; -*- coding: utf-8 -*-
+.if \n(.g .ds T&lt; \\FC
+.if \n(.g .ds T&gt; \\F[\n[.fam]]
+.de URL
+\\$2 \(la\\$1\(ra\\$3
+..
+.if \n(.g .mso www.tmac
+.TH x2gosuspend-desktopsharing 8 &quot;Sep 2011&quot; &quot;Version 3.0.99.x&quot; &quot;X2go Server Tool&quot;
+.SH NAME
+x2gosuspend-desktopsharing \- Suspend Desktop Sharing for a given X2go Session
+.SH SYNOPSIS
+'nh
+.fi
+.ad l
+x2gosuspend-desktopsharing &lt;session_id&gt;
+
+.SH DESCRIPTION
+\fBx2gosuspend-desktopsharing\fR executes \fBx2goterminate-desktopsharing\fR and places a reminder file
+.PP
+    ,,resume-desktopsharing''
+.PP
+into
+.PP
+    $HOME/.x2go/C-&lt;session_id&gt;/
+.PP
+so that \fBx2godesktopsharing\fR can be resumed
+on session resume.
+.PP
+\fBx2gosuspend-desktopsharing\fR is run with normal user privileges and it is used from within X2go Server.
+There normally is no need to execute this command manually.
+.SH RETURN VALUES
+As exitcode \fBx2gosuspend-desktopsharing\fR always returns 0.
+.SH SEE ALSO
+x2godesktopsharing(1), x2gosuspend-session(8), x2goterminate-desktopsharing(8), x2goresume-desktopsharing(8)
+.SH AUTHOR
+This manual has been written by Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt; for the X2go project
+(<A HREF="http://www.x2go.org">http://www.x2go.org</A>).
diff --git a/man/man8/x2goterminate-desktopsharing.8 b/man/man8/x2goterminate-desktopsharing.8
new file mode 100644
index 0000000..b970b16
--- /dev/null
+++ b/man/man8/x2goterminate-desktopsharing.8
@@ -0,0 +1,30 @@
+'\&quot; -*- coding: utf-8 -*-
+.if \n(.g .ds T&lt; \\FC
+.if \n(.g .ds T&gt; \\F[\n[.fam]]
+.de URL
+\\$2 \(la\\$1\(ra\\$3
+..
+.if \n(.g .mso www.tmac
+.TH x2goterminate-desktopsharing 8 &quot;Sep 2011&quot; &quot;Version 3.0.99.x&quot; &quot;X2go Server Tool&quot;
+.SH NAME
+x2goterminate-desktopsharing \- Cleanly Terminate Desktop Sharing for a given X2go Session
+.SH SYNOPSIS
+'nh
+.fi
+.ad l
+x2goterminate-desktopsharing &lt;session_id&gt;
+
+.SH DESCRIPTION
+\fBx2goterminate-desktopsharing\fR allows to detect a running and associated \fBx2godesktopsharing\fR
+applet and to cleanly terminate this applet.
+.PP
+\fBx2goterminate-desktopsharing\fR is run with normal user privileges and it is used from within X2go Server.
+There normally is no need to execute this command manually.
+.SH RETURN VALUES
+As exitcode \fBx2goterminate-desktopsharing\fR returns 0 if a \fBx2godesktopsharing\fR process could be identified
+and terminated. If not, the exit code is -1.
+.SH SEE ALSO
+x2godesktopsharing(1), x2goteminate-session(8), x2gosuspend-desktopsharing(8), x2goresume-desktopsharing(8)
+.SH AUTHOR
+This manual has been written by Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt; for the X2go project
+(<A HREF="http://www.x2go.org">http://www.x2go.org</A>).
diff --git a/share/x2gofeature.d/x2godesktopsharing.features b/share/x2gofeature.d/x2godesktopsharing.features
new file mode 100755
index 0000000..2f29612
--- /dev/null
+++ b/share/x2gofeature.d/x2godesktopsharing.features
@@ -0,0 +1,36 @@
+#!/bin/bash
+
+# Copyright (C) 2007-2011 X2go Project - <A HREF="http://wiki.x2go.org">http://wiki.x2go.org</A>
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the
+# Free Software Foundation, Inc.,
+# 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA.
+#
+# Copyright (C) 2011  Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
+# Copyright (C) 2011  Heinz-Markus Graesing &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">heinz-m.graesing at obviously-nice.de</A>&gt;
+
+X2GO_LIB_PATH=`echo -n \$(x2gobasepath)/lib/x2go`
+
+$X2GO_LIB_PATH/x2gosyslog &quot;$0&quot; &quot;info&quot; &quot;$(basename $0) called with options: $@&quot;
+
+X2GO_FEATURE=$1
+
+# check for X2go server core features
+case &quot;$X2GO_FEATURE&quot; in
+
+    &quot;X2GO_DESKTOPSHARING&quot;) echo &quot;ok&quot;; exit 0;;
+    *) exit -1;;
+
+esac
+
diff --git a/sharetray.cpp b/sharetray.cpp
index 541b50c..2bf7dee 100644
--- a/sharetray.cpp
+++ b/sharetray.cpp
@@ -17,10 +17,12 @@
 #include &lt;QDir&gt;
 #include &lt;QtDebug&gt;
 #include &lt;QMessageBox&gt;
+#include &lt;QSocketNotifier&gt;
+#include &lt;sys/socket.h&gt;
 #include &quot;simplelocalsocket.h&quot;
 #include &quot;accessaction.h&quot;
 #include &lt;sys/types.h&gt;
-#include &lt;signal.h&gt;
+#include &lt;csignal&gt;
 #include &lt;errno.h&gt;
 #include &lt;QToolTip&gt;
 #include &lt;QTimer&gt;
@@ -33,520 +35,619 @@
 #include &lt;QProcess&gt;
 #define STAT_ACT_COUNT 10
 
-#define VERSION &quot;3.0.1-1&quot;
+#define VERSION &quot;3.0.1.3&quot;
+
+//needed to not get an undefined reference to static members
+int ShareTray::sigkeybintFd[2];
+int ShareTray::sigtermFd[2];
+int ShareTray::sigabortFd[2];
+int ShareTray::sighupFd[2];
 
 ShareTray::ShareTray()
         : QMainWindow()
 {
-    serverSocket=0l;
-    menuClose=false;
-    current_list=BLACK;
-
-    ui.setupUi ( this );
-    ui.box-&gt;setSelectionMode ( QAbstractItemView::ExtendedSelection );
-
-    connect ( ui.close_box,SIGNAL ( clicked ( QAbstractButton* ) ),
-              SLOT ( slotMsgClose ( QAbstractButton* ) ) );
-
-    connect ( ui.ok_cancel_box,SIGNAL ( clicked ( QAbstractButton* ) ),
-              SLOT ( slotMsgOkCancel ( QAbstractButton* ) ) );
-
-    connect ( ui.del,SIGNAL ( clicked() ),
-              SLOT ( slotDelListItem() ) );
-
-    ui.icon-&gt;setPixmap ( QPixmap ( &quot;:icons/128x128/x2godesktopsharing.png&quot; ) );
-
-    ui.text-&gt;setText ( tr ( &quot;&lt;b&gt;X2GO DesktopSharing V. &quot; ) +VERSION+
-                       &quot; &lt;/b &gt;(Qt - &quot;+qVersion() +&quot;)&quot;+
-                       ui.text-&gt;text() );
-
-    setWindowFlags ( Qt::Dialog );
-    Qt::WindowFlags flags=windowFlags();
-    flags&amp;= ~Qt::WindowTitleHint;
-    setWindowFlags ( flags );
-
-    QString dispname=getenv ( &quot;DISPLAY&quot; );
-    socketFname=QDir::tempPath() +&quot;/x2godesktopsharing_@&quot;+
-                getenv ( &quot;LOGNAME&quot; ) +&quot;@&quot;+dispname;
-    lockFname=QDir::tempPath() +&quot;/x2godesktopsharing.lock_&quot;+
-              getenv ( &quot;LOGNAME&quot; ) +&quot;@&quot;+dispname;
-    if ( QFile::exists ( lockFname ) )
-    {
-        QFile file ( lockFname );
-        if ( file.open ( QIODevice::ReadOnly | QIODevice::Text ) )
-        {
-            QTextStream in ( &amp;file );
-            if ( !in.atEnd() )
-            {
-                QString line = in.readLine();
-                file.close();
-                if ( abs ( line.toUInt() -
-                           QDateTime::currentDateTime().toTime_t() ) &lt;5 )
-                {
-
-                    QString message=QString (
-                                        tr (
-                                            &quot;X2Go desktop sharing application &quot;
-                                            &quot;is already active for this &quot;
-                                            &quot;display \n&quot;
-                                            &quot;if this application is no longer &quot;
-                                            &quot;running, remove %1\n&quot;
-                                            &quot;and start again&quot; ) ).arg ( lockFname );
-                    QMessageBox::critical ( 0l,tr (
-                                                &quot;Error&quot; ),message,
-                                            QMessageBox::Ok,
-                                            QMessageBox::NoButton );
-                    exit ( -1 );
-                }
-            }
-        }
-        QFile::remove ( lockFname );
-    }
-    if ( QFile::exists ( socketFname ) )
-        QFile::remove ( socketFname );
-
-    QTimer *lockTimer = new QTimer ( this );
-    connect ( lockTimer, SIGNAL ( timeout() ), this, SLOT ( slotUpdateLockFile() ) );
-    lockTimer-&gt;start ( 3000 );
-    trayIcon=new QSystemTrayIcon ( this );
-    setWindowIcon ( QIcon ( &quot;:icons/22x22/x2godesktopsharing.png&quot; ) );
-    menu = new QMenu ( this );
-    trayIcon-&gt;setContextMenu ( menu );
-    trayIcon-&gt;setToolTip ( tr ( &quot;X2Go desktop sharing application&quot; ) );
-
-    menu-&gt;addSeparator();
-
-    actWhite = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/wlist.png&quot; ) ,
-                                 tr ( &quot;Granted users...&quot; ) );
-    actBlack = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/blist.png&quot; ) ,
-                                 tr ( &quot;Banned users...&quot; ) );
-    menu-&gt;addSeparator();
-
-    actStart = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/share.png&quot; ) ,
-                                 tr ( &quot;Activate desktop sharing&quot; ) );
-
-    actStop = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/stop.png&quot; ) ,
-                                tr ( &quot;Deactivate desktop sharing&quot; ) );
-
-    menu-&gt;addSeparator();
-    QAction* actAbout=menu-&gt;addAction (
-                          QIcon ( &quot;:icons/32x32/x2godesktopsharing.png&quot; ),
-                          tr ( &quot;About X2GO Sharing&quot; ) );
-//
-//     QAction* actAboutQt=menu-&gt;addAction(
-//                              tr(&quot;About Qt&quot;));
-//     connect ( actAboutQt,SIGNAL ( triggered ( bool ) ),this,
-//          SLOT ( slotAboutQt() ) );
-//
-    connect ( actAbout,SIGNAL ( triggered ( bool ) ),this,
-              SLOT ( slotAbout() ) );
+	serverSocket=0l;
+	menuClose=false;
+	current_list=BLACK;
+
+	ui.setupUi ( this );
+	ui.box-&gt;setSelectionMode ( QAbstractItemView::ExtendedSelection );
+
+	connect ( ui.close_box,SIGNAL ( clicked ( QAbstractButton* ) ),
+	          SLOT ( slotMsgClose ( QAbstractButton* ) ) );
+
+	connect ( ui.ok_cancel_box,SIGNAL ( clicked ( QAbstractButton* ) ),
+	          SLOT ( slotMsgOkCancel ( QAbstractButton* ) ) );
+
+	connect ( ui.del,SIGNAL ( clicked() ),
+	          SLOT ( slotDelListItem() ) );
+
+	ui.icon-&gt;setPixmap ( QPixmap ( &quot;:icons/128x128/x2godesktopsharing.png&quot; ) );
+
+	ui.text-&gt;setText ( tr ( &quot;&lt;b&gt;X2GO DesktopSharing v&quot; ) +VERSION+
+	                   &quot; &lt;/b &gt;(Qt - &quot;+qVersion() +&quot;)&quot;+
+	                   ui.text-&gt;text() );
+
+	setWindowFlags ( Qt::Dialog );
+	Qt::WindowFlags flags=windowFlags();
+	flags&amp;= ~Qt::WindowTitleHint;
+	setWindowFlags ( flags );
+
+	QString dispname=getenv ( &quot;DISPLAY&quot; );
+	socketFname=QDir::tempPath() +&quot;/x2godesktopsharing_@&quot;+
+	            getenv ( &quot;LOGNAME&quot; ) +&quot;@&quot;+dispname;
+	lockFname=QDir::tempPath() +&quot;/x2godesktopsharing.lock_&quot;+
+	          getenv ( &quot;LOGNAME&quot; ) +&quot;@&quot;+dispname;
+	if ( QFile::exists ( lockFname ) )
+	{
+		QFile file ( lockFname );
+		if ( file.open ( QIODevice::ReadOnly | QIODevice::Text ) )
+		{
+			QTextStream in ( &amp;file );
+			if ( !in.atEnd() )
+			{
+				QString line = in.readLine();
+				file.close();
+				if ( abs ( line.toUInt() -
+					QDateTime::currentDateTime().toTime_t() ) &lt;5 )
+					{
+
+					QString message=QString (
+					                tr (
+					                    &quot;X2Go desktop sharing application &quot;
+					                    &quot;is already active for this &quot;
+					                    &quot;display \n&quot;
+					                    &quot;if this application is no longer &quot;
+					                    &quot;running, remove %1\n&quot;
+					                    &quot;and start again&quot; ) ).arg ( lockFname );
+					QMessageBox::critical ( 0l,tr (
+					                                &quot;Error&quot; ),message,
+					                                QMessageBox::Ok,
+					                                QMessageBox::NoButton );
+					exit ( -1 );
+				}
+			}
+		}
+		QFile::remove ( lockFname );
+	}
+	if ( QFile::exists ( socketFname ) )
+		QFile::remove ( socketFname );
+
+	QTimer *lockTimer = new QTimer ( this );
+	connect ( lockTimer, SIGNAL ( timeout() ), this, SLOT ( slotUpdateLockFile() ) );
+	lockTimer-&gt;start ( 3000 );
+	trayIcon=new QSystemTrayIcon ( this );
+	setWindowIcon ( QIcon ( &quot;:icons/22x22/x2godesktopsharing.png&quot; ) );
+	menu = new QMenu ( this );
+	trayIcon-&gt;setContextMenu ( menu );
+	trayIcon-&gt;setToolTip ( tr ( &quot;X2Go desktop sharing application&quot; ) );
+
+	menu-&gt;addSeparator();
+
+	actWhite = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/wlist.png&quot; ) ,
+	                             tr ( &quot;Granted users...&quot; ) );
+	actBlack = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/blist.png&quot; ) ,
+	                             tr ( &quot;Banned users...&quot; ) );
+	menu-&gt;addSeparator();
+
+	actStart = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/share.png&quot; ) ,
+	                             tr ( &quot;Activate desktop sharing&quot; ) );
+
+	actStop = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/stop.png&quot; ) ,
+	                            tr ( &quot;Deactivate desktop sharing&quot; ) );
+
+	menu-&gt;addSeparator();
+	QAction* actAbout=menu-&gt;addAction (
+	                                    QIcon ( &quot;:icons/32x32/x2godesktopsharing.png&quot; ),
+	                                    tr ( &quot;About X2GO Sharing&quot; ) );
+	//
+	//     QAction* actAboutQt=menu-&gt;addAction(
+	//                              tr(&quot;About Qt&quot;));
+	//     connect ( actAboutQt,SIGNAL ( triggered ( bool ) ),this,
+	//          SLOT ( slotAboutQt() ) );
+	//
+	connect ( actAbout,SIGNAL ( triggered ( bool ) ),this,
+	          SLOT ( slotAbout() ) );
+
+
+	menu-&gt;addSeparator();
+	QAction* actExit = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/exit.png&quot; ) ,
+	                                     tr ( &quot;&amp;Quit&quot; ) );
+
+	connect ( actWhite,SIGNAL ( triggered ( bool ) ),this,
+	          SLOT ( slotWhiteList() ) );
+	connect ( actBlack,SIGNAL ( triggered ( bool ) ),this,
+	          SLOT ( slotBlackList() ) );
+
+	connect ( actExit,SIGNAL ( triggered ( bool ) ),this,
+	          SLOT ( slotMenuClose() ) );
+
+	connect ( actStart,SIGNAL ( triggered ( bool ) ),this,
+	          SLOT ( slotStartSharing() ) );
+
+	connect ( actStop,SIGNAL ( triggered ( bool ) ),this,
+	          SLOT ( slotStopSharing() ) );
+
+
+
+	actStop-&gt;setEnabled ( false );
+
+	// unix signals (TERM, INT) are piped into a unix socket and will raise Qt events
+	if (::socketpair(AF_UNIX, SOCK_STREAM, 0, sigkeybintFd))
+		qFatal(&quot;Couldn't create keyboard INT socketpair&quot;);
+
+	if (::socketpair(AF_UNIX, SOCK_STREAM, 0, sigtermFd))
+		qFatal(&quot;Couldn't create TERM socketpair&quot;);
+
+	if (::socketpair(AF_UNIX, SOCK_STREAM, 0, sigabortFd))
+		qFatal(&quot;Couldn't create ABRT socketpair&quot;);
+
+	if (::socketpair(AF_UNIX, SOCK_STREAM, 0, sighupFd))
+		qFatal(&quot;Couldn't create HANGUP socketpair&quot;);
+
+	snKeybInt = new QSocketNotifier(sigkeybintFd[1], QSocketNotifier::Read, this);
+	connect(snKeybInt, SIGNAL(activated(int)), this, SLOT(handleSigKeybInt()));
+	snTerm = new QSocketNotifier(sigtermFd[1], QSocketNotifier::Read, this);
+	connect(snTerm, SIGNAL(activated(int)), this, SLOT(handleSigTerm()));
+	snAbort = new QSocketNotifier(sigabortFd[1], QSocketNotifier::Read, this);
+	connect(snAbort, SIGNAL(activated(int)), this, SLOT(handleSigAbort()));
+	snHup = new QSocketNotifier(sighupFd[1], QSocketNotifier::Read, this);
+	connect(snHup, SIGNAL(activated(int)), this, SLOT(handleSigHup()));
+
+	QTimer *timer = new QTimer ( this );
+	connect ( timer, SIGNAL ( timeout() ), this, SLOT ( slotTimer() ) );
+	timer-&gt;start ( 5000 );
+	loadSettings();
+	setTrayIcon();
+	trayIcon-&gt;show();
+}
 
 
-    menu-&gt;addSeparator();
-    QAction* actExit = menu-&gt;addAction ( QIcon ( &quot;:icons/32x32/exit.png&quot; ) ,
-                                         tr ( &quot;&amp;Quit&quot; ) );
+ShareTray::~ShareTray()
+{
+	qDebug() &lt;&lt;&quot;stopping desktop sharing&quot;;
+	slotStopSharing();
+	if ( QFile::exists ( lockFname ) )
+		QFile::remove ( lockFname );
+		qDebug() &lt;&lt;&quot;lock file removed&quot;;
+	saveSettings();
+	qDebug() &lt;&lt;&quot;settings saved&quot;;
+}
 
-    connect ( actWhite,SIGNAL ( triggered ( bool ) ),this,
-              SLOT ( slotWhiteList() ) );
-    connect ( actBlack,SIGNAL ( triggered ( bool ) ),this,
-              SLOT ( slotBlackList() ) );
+void ShareTray::handleSigKeybInt()
+{
+	snKeybInt-&gt;setEnabled(false);
+	char tmp;
+	::read(sigkeybintFd[1], &amp;tmp, sizeof(tmp));
 
+	// do Qt stuff here
+	slotMenuClose();
 
-    connect ( actExit,SIGNAL ( triggered ( bool ) ),this,
-              SLOT ( slotMenuClose() ) );
+	snKeybInt-&gt;setEnabled(true);
+}
 
-    connect ( actStart,SIGNAL ( triggered ( bool ) ),this,
-              SLOT ( slotStartSharing() ) );
+void ShareTray::handleSigTerm()
+{
+	snTerm-&gt;setEnabled(false);
+	char tmp;
+	::read(sigtermFd[1], &amp;tmp, sizeof(tmp));
 
-    connect ( actStop,SIGNAL ( triggered ( bool ) ),this,
-              SLOT ( slotStopSharing() ) );
+	// do Qt stuff here
+	slotMenuClose();
 
+	snTerm-&gt;setEnabled(true);
+}
 
+void ShareTray::handleSigAbort()
+{
+	snAbort-&gt;setEnabled(false);
+	char tmp;
+	::read(sigabortFd[1], &amp;tmp, sizeof(tmp));
 
-    actStop-&gt;setEnabled ( false );
+	// do Qt stuff here
+	slotMenuClose();
 
-    QTimer *timer = new QTimer ( this );
-    connect ( timer, SIGNAL ( timeout() ), this, SLOT ( slotTimer() ) );
-    timer-&gt;start ( 5000 );
-    loadSettings();
-    setTrayIcon();
-    trayIcon-&gt;show();
+	snAbort-&gt;setEnabled(true);
 }
 
+void ShareTray::handleSigHup()
+{
+	snHup-&gt;setEnabled(false);
+	char tmp;
+	::read(sighupFd[1], &amp;tmp, sizeof(tmp));
 
-ShareTray::~ShareTray()
+	// do Qt stuff here
+	slotMenuClose();
+
+	snHup-&gt;setEnabled(true);
+}
+
+void ShareTray::keybintSignalHandler(int)
+{
+	char a = 1;
+	::write(sigkeybintFd[0], &amp;a, sizeof(a));
+}
+
+void ShareTray::termSignalHandler(int)
 {
-    slotStopSharing();
-    if ( QFile::exists ( lockFname ) )
-        QFile::remove ( lockFname );
-    saveSettings();
+	char a = 1;
+	::write(sigtermFd[0], &amp;a, sizeof(a));
 }
 
+void ShareTray::abortSignalHandler(int)
+{
+	char a = 1;
+	::write(sigabortFd[0], &amp;a, sizeof(a));
+}
+
+void ShareTray::hupSignalHandler(int)
+{
+	char a = 1;
+	::write(sighupFd[0], &amp;a, sizeof(a));
+}
 
 void ShareTray::slotStopSharing()
 {
-    if ( serverSocket )
-    {
-        serverSocket-&gt;close();
-        delete serverSocket;
-        serverSocket=0l;
-    }
-    if ( QFile::exists ( socketFname ) )
-        QFile::remove ( socketFname );
-    for ( int i=menu-&gt;actions().count()-STAT_ACT_COUNT-1;i&gt;=0;--i )
-    {
-        slotCloseConnection ( ( AccessAction* ) ( menu-&gt;actions() [i] ) );
-    }
-    actStop-&gt;setEnabled ( false );
-    actStart-&gt;setEnabled ( true );
-    setTrayIcon();
+	if ( serverSocket )
+	{
+		serverSocket-&gt;close();
+		delete serverSocket;
+		serverSocket=0l;
+	}
+	if ( QFile::exists ( socketFname ) )
+		QFile::remove ( socketFname );
+	for ( int i=menu-&gt;actions().count()-STAT_ACT_COUNT-1;i&gt;=0;--i )
+	{
+		slotCloseConnection ( ( AccessAction* ) ( menu-&gt;actions() [i] ) );
+	}
+	actStop-&gt;setEnabled ( false );
+	actStart-&gt;setEnabled ( true );
+	setTrayIcon();
 }
 
 
 void ShareTray::slotStartSharing()
 {
-    actStop-&gt;setEnabled ( true );
-    actStart-&gt;setEnabled ( false );
-    if ( serverSocket )
-        delete serverSocket;
-    if ( QFile::exists ( socketFname ) )
-        QFile::remove ( socketFname );
-    serverSocket=new QLocalServer ( this );
-    if ( serverSocket-&gt;listen ( socketFname ) )
-    {
-
-        chown ( socketFname.toAscii(),getuid(),getgrnam ( &quot;x2gousers&quot; )-&gt;gr_gid );
-        QFile::setPermissions ( socketFname,
-                                QFile::ReadOwner|QFile::WriteOwner|QFile::ReadGroup|QFile::WriteGroup );
-        connect ( serverSocket,SIGNAL ( newConnection() ),
-                  this,SLOT ( slotServerConnection() ) );
-    }
-    else
-    {
-        QString message=
-            tr (
-                &quot;Can't listen on socket:&quot; ) + socketFname;
-        QMessageBox::critical ( 0l,tr (
-                                    &quot;Error&quot; ),message,
-                                QMessageBox::Ok,
-                                QMessageBox::NoButton );
-        close();
-    }
-    setTrayIcon();
+	actStop-&gt;setEnabled ( true );
+	actStart-&gt;setEnabled ( false );
+	if ( serverSocket )
+		delete serverSocket;
+	if ( QFile::exists ( socketFname ) )
+		QFile::remove ( socketFname );
+	serverSocket=new QLocalServer ( this );
+	if ( serverSocket-&gt;listen ( socketFname ) )
+	{
+
+		chown ( socketFname.toAscii(),getuid(),getgrnam ( &quot;x2godesktopsharing&quot; )-&gt;gr_gid );
+		QFile::setPermissions ( socketFname,
+		                        QFile::ReadOwner|QFile::WriteOwner|QFile::ReadGroup|QFile::WriteGroup );
+		connect ( serverSocket,SIGNAL ( newConnection() ),
+		          this,SLOT ( slotServerConnection() ) );
+	}
+	else
+	{
+		QString message=
+		    tr (
+		        &quot;Can't listen on socket:&quot; ) + socketFname;
+		QMessageBox::critical ( 0l,tr (
+		                            &quot;Error&quot; ),message,
+		                        QMessageBox::Ok,
+		                        QMessageBox::NoButton );
+		close();
+	}
+	setTrayIcon();
 }
 
 bool ShareTray::acceptConnections()
 {
-    return actStop-&gt;isEnabled();
+	return actStop-&gt;isEnabled();
 }
 
 QString ShareTray::getSocketAnswer ( QString message )
 {
-    qDebug() &lt;&lt;&quot;message: &quot;&lt;&lt;message;
-    QStringList lst=message.split ( ' ' );
-    if ( lst.size() !=10 )
-    {
-        qDebug() &lt;&lt;&quot;wrong parameters&quot;;
-        return &quot;DENY&quot;;
-    }
-    QStringList params=lst[9].split ( &quot;XSHAD&quot; );
-    if ( params.size() !=3 )
-    {
-        qDebug() &lt;&lt;&quot;wrong parameters&quot;;
-        return &quot;DENY&quot;;
-    }
-    QString client=lst[0];
-    QString user=params[1];
-    if ( getAccess ( user,client ) ==QMessageBox::Yes )
-    {
-        trayMessage ( tr ( &quot;Access granted&quot; ),QString (
-                          tr (
-                              &quot;%1(%2): access granted&quot; ) ).arg (
-                          user ).arg ( client ) );
-        //start agent
-        QProcess proc ( this );
-        lst.removeAt ( 0 );;
-        proc.start ( &quot;x2gostartagent&quot;,lst );
-        if ( !proc.waitForFinished ( 5000 ) )
-        {
-            return &quot;DENY&quot;;
-        }
-        else
-        {
-            QString output=proc.readAllStandardOutput();
-            qDebug() &lt;&lt;&quot;agent out: &quot;&lt;&lt;output;
-            QStringList lines=output.split ( &quot;\n&quot; );
-            QString pid=&quot;pid&quot;;
-            if ( lines.size() &gt;3 )
-                pid=lines[2];
-            qDebug() &lt;&lt;&quot;agent pid: &quot;&lt;&lt;pid;
-            AccessAction *act=new AccessAction (
-                pid,user,client,
-                QString ( tr ( &quot;Disconnect %1(%2)&quot; ) ).arg ( user ).arg ( client ),
-                this );
-            menu-&gt;insertAction ( menu-&gt;actions() [0],act );
-            connect ( act,SIGNAL ( actionActivated ( AccessAction* ) ),this,
-                      SLOT ( slotCloseConnection ( AccessAction* ) ) );
-            trayMessage ( tr ( &quot;Remote connection&quot; ),
-                          QString (
-                              tr ( &quot;%1(%2) connected&quot; ) ).arg ( user ).arg ( client ) );
-            setTrayIcon();
-            return output;
-        }
-    }
-    trayMessage ( tr ( &quot;Access denied&quot; ),QString (
-                      tr ( &quot;%1(%2): access denied&quot; ) ).arg ( params[1] ).arg ( client ) );
-    return &quot;DENY&quot;;
+	qDebug() &lt;&lt;&quot;message: &quot;&lt;&lt;message;
+	QStringList lst=message.split ( ' ' );
+	if ( lst.size() !=11 )
+	{
+		qDebug() &lt;&lt;&quot;wrong parameters&quot;;
+		return &quot;DENY&quot;;
+	}
+	QStringList params=lst[9].split ( &quot;XSHAD&quot; );
+	if ( params.size() !=3 )
+	{
+		qDebug() &lt;&lt;&quot;wrong parameters&quot;;
+		return &quot;DENY&quot;;
+	}
+	QString client=lst[0];
+	QString user=params[1];
+	QString remote_user=lst[10];
+	if ( getAccess ( remote_user, client ) ==QMessageBox::Yes )
+	{
+		trayMessage ( tr ( &quot;Access granted&quot; ),QString ( tr ( &quot;%1(%2): access granted&quot; ) ).arg (remote_user ).arg ( client ) );
+		//start agent
+		QProcess proc ( this );
+		lst.removeAt ( 10 );;
+		lst.removeAt ( 0 );;
+		proc.start ( &quot;x2gostartagent&quot;,lst );
+		if ( !proc.waitForFinished ( 5000 ) )
+		{
+			return &quot;DENY&quot;;
+		}
+		else
+		{
+			QString output=proc.readAllStandardOutput();
+			qDebug() &lt;&lt;&quot;agent out: &quot;&lt;&lt;output;
+			QStringList lines=output.split ( &quot;\n&quot; );
+			QString pid=&quot;pid&quot;;
+			if ( lines.size() &gt;3 )
+				pid=lines[2];
+			qDebug() &lt;&lt;&quot;agent pid: &quot;&lt;&lt;pid;
+			AccessAction *act=new AccessAction (
+			    pid,remote_user,client,
+			    QString ( tr ( &quot;Disconnect %1(%2)&quot; ) ).arg ( remote_user ).arg ( client ),
+			    this );
+			menu-&gt;insertAction ( menu-&gt;actions() [0],act );
+			connect ( act,SIGNAL ( actionActivated ( AccessAction* ) ),this,
+			          SLOT ( slotCloseConnection ( AccessAction* ) ) );
+			trayMessage ( tr ( &quot;Remote connection&quot; ),
+			              QString (
+			                  tr ( &quot;%1(%2) connected&quot; ) ).arg ( remote_user ).arg ( client ) );
+			setTrayIcon();
+			return output;
+		}
+	}
+	trayMessage ( tr ( &quot;Access denied&quot; ),QString (
+	              tr ( &quot;%1(%2): access denied&quot; ) ).arg ( remote_user ).arg ( client ) );
+	return &quot;DENY&quot;;
 }
 
 void ShareTray::closeSocket ( SimpleLocalSocket* sock )
 {
-    qDebug() &lt;&lt;&quot;closing null socket&quot;;
-    if ( sock )
-    {
-        qDebug() &lt;&lt;&quot;closing socket&quot;;
-        delete sock;
-        qDebug() &lt;&lt;&quot;done&quot;;
-    }
+	qDebug() &lt;&lt;&quot;closing null socket&quot;;
+	if ( sock )
+	{
+		qDebug() &lt;&lt;&quot;closing socket&quot;;
+		delete sock;
+		qDebug() &lt;&lt;&quot;done&quot;;
+	}
 }
 
 void ShareTray::slotServerConnection()
 {
-    new SimpleLocalSocket ( this,serverSocket-&gt;nextPendingConnection() );
+	new SimpleLocalSocket ( this,serverSocket-&gt;nextPendingConnection() );
 }
 
 void ShareTray::slotCloseConnection ( AccessAction* action )
 {
-    kill ( action-&gt;pid().toUInt(),15 );
-    menu-&gt;removeAction ( action );
-    delete action;
-    setTrayIcon();
+	kill ( action-&gt;pid().toUInt(),15 );
+	menu-&gt;removeAction ( action );
+	delete action;
+	setTrayIcon();
 }
 
 
-int ShareTray::getAccess ( QString user, QString host )
+int ShareTray::getAccess ( QString remote_user, QString host )
 {
-    if ( whiteList.contains ( user ) )
-        return QMessageBox::Yes;
-    if ( blackList.contains ( user ) )
-        return QMessageBox::No;
-
-    MessageBox m ( user,host, this );
-    m.activateWindow();
-    m.raise();
-    int res=m.exec();
-    if ( m.isChecked() &amp;&amp;res==QMessageBox::Yes )
-        whiteList&lt;&lt;user;
-    if ( m.isChecked() &amp;&amp;res==QMessageBox::No )
-        blackList&lt;&lt;user;
-    actBlack-&gt;setEnabled ( blackList.size() &gt;0 );
-    actWhite-&gt;setEnabled ( whiteList.size() &gt;0 );
-    return res;
+	if ( whiteList.contains ( remote_user ) )
+		return QMessageBox::Yes;
+	if ( blackList.contains ( remote_user ) )
+		return QMessageBox::No;
+
+	MessageBox m ( remote_user, host, this );
+	m.activateWindow();
+	m.raise();
+	int res=m.exec();
+	if ( m.isChecked() &amp;&amp;res==QMessageBox::Yes )
+		whiteList&lt;&lt;remote_user;
+	if ( m.isChecked() &amp;&amp;res==QMessageBox::No )
+		blackList&lt;&lt;remote_user;
+	actBlack-&gt;setEnabled ( blackList.size() &gt;0 );
+	actWhite-&gt;setEnabled ( whiteList.size() &gt;0 );
+	return res;
 }
 
 void ShareTray::closeEvent ( QCloseEvent*  ev )
 {
-    if ( !menuClose )
-    {
-        ev-&gt;ignore();
-        hide();
-        return;
-    }
-    slotStopSharing();
-    if ( QFile::exists ( lockFname ) )
-        QFile::remove ( lockFname );
-    saveSettings();
+	if ( !menuClose )
+	{
+		ev-&gt;ignore();
+		hide();
+		return;
+	}
+	qDebug() &lt;&lt;&quot;stopping desktop sharing&quot;;
+	slotStopSharing();
+	if ( QFile::exists ( lockFname ) )
+		QFile::remove ( lockFname );
+		qDebug() &lt;&lt;&quot;lock file removed&quot;;
+	saveSettings();
+	qDebug() &lt;&lt;&quot;settings saved&quot;;
 }
 
 void ShareTray::slotTimer()
 {
-    for ( int i=menu-&gt;actions().count()-STAT_ACT_COUNT-1;i&gt;=0;--i )
-    {
-        AccessAction* action= ( AccessAction* ) ( menu-&gt;actions() [i] );
-        if ( !isProcessRunning ( action-&gt;pid() ) )
-        {
-            trayMessage ( tr ( &quot;User disconnected&quot; ),
-                          QString (
-                              tr ( &quot;%1(%2) disconnected&quot; ) ).arg (
-                              action-&gt;user() ).arg ( action-&gt;host() ) );
-            menu-&gt;removeAction ( action );
-            delete action;
-        }
-    }
-    setTrayIcon();
+	for ( int i=menu-&gt;actions().count()-STAT_ACT_COUNT-1;i&gt;=0;--i )
+	{
+		AccessAction* action= ( AccessAction* ) ( menu-&gt;actions() [i] );
+		if ( !isProcessRunning ( action-&gt;pid() ) )
+		{
+			trayMessage ( tr ( &quot;User disconnected&quot; ),
+			              QString (
+			                  tr ( &quot;%1(%2) disconnected&quot; ) ).arg (
+			                  action-&gt;user() ).arg ( action-&gt;host() ) );
+			menu-&gt;removeAction ( action );
+			delete action;
+		}
+	}
+	setTrayIcon();
 }
 
 void ShareTray::trayMessage ( QString title, QString text )
 {
-    if ( !QSystemTrayIcon::supportsMessages () )
-        QToolTip::showText ( geometry().topLeft(),
-                             text );
-    else
-        trayIcon-&gt;showMessage ( title,text );
+	if ( !QSystemTrayIcon::supportsMessages () )
+		QToolTip::showText ( geometry().topLeft(),
+		                     text );
+	else
+		trayIcon-&gt;showMessage ( title,text );
 }
 
 
 bool ShareTray::isProcessRunning ( QString pid )
 {
-    if ( kill ( pid.toInt(),SIGCONT ) ==-1 )
-    {
-        if ( errno==ESRCH )
-        {
-            return false;
-        }
-    }
-    return true;
+	if ( kill ( pid.toInt(),SIGCONT ) ==-1 )
+	{
+		if ( errno==ESRCH )
+		{
+			return false;
+		}
+	}
+	return true;
 }
 
 
 void ShareTray::slotBlackList()
 {
-    current_list=BLACK;
-    showList();
-    setWindowTitle ( tr ( &quot;Banned users&quot; ) );
-
+	current_list=BLACK;
+	showList();
+	setWindowTitle ( tr ( &quot;Banned users&quot; ) );
 }
 
 void ShareTray::slotWhiteList()
 {
-    current_list=WHITE;
-    showList();
-    setWindowTitle ( tr ( &quot;Granted users&quot; ) );
-
+	current_list=WHITE;
+	showList();
+	setWindowTitle ( tr ( &quot;Granted users&quot; ) );
 }
 
 void ShareTray::showList()
 {
-    show();
-    ui.ok_cancel_box-&gt;show();
-    ui.box-&gt;show();
-    ui.del-&gt;show();
-
-    ui.close_box-&gt;hide();
-    ui.icon-&gt;hide();
-    ui.text-&gt;hide();
-
-    QStringList* lst;
-    if ( current_list==BLACK )
-        lst=&blackList;
-    else
-        lst=&whiteList;
-    lst-&gt;sort();
-    ui.box-&gt;clear();
-    ui.box-&gt;insertItems ( 0,*lst );
+	show();
+	ui.ok_cancel_box-&gt;show();
+	ui.box-&gt;show();
+	ui.del-&gt;show();
+
+	ui.close_box-&gt;hide();
+	ui.icon-&gt;hide();
+	ui.text-&gt;hide();
+
+	QStringList* lst;
+	if ( current_list==BLACK )
+		lst=&blackList;
+	else
+		lst=&whiteList;
+	lst-&gt;sort();
+	ui.box-&gt;clear();
+	ui.box-&gt;insertItems ( 0,*lst );
 }
 
 void ShareTray::loadSettings()
 {
-    QSettings st ( QDir::homePath() +&quot;/.x2godesktopshare/settings&quot;,
-                   QSettings::NativeFormat );
+	QSettings st ( QDir::homePath() +&quot;/.x2godesktopsharing/settings&quot;,
+	               QSettings::NativeFormat );
 
-    blackList= st.value ( &quot;blacklist&quot; ).toStringList();
-    whiteList= st.value ( &quot;whitelist&quot; ).toStringList();
+	blackList= st.value ( &quot;blacklist&quot; ).toStringList();
+	whiteList= st.value ( &quot;whitelist&quot; ).toStringList();
 
-    actBlack-&gt;setEnabled ( blackList.size() &gt;0 );
-    actWhite-&gt;setEnabled ( whiteList.size() &gt;0 );
+	actBlack-&gt;setEnabled ( blackList.size() &gt;0 );
+	actWhite-&gt;setEnabled ( whiteList.size() &gt;0 );
 }
 
 void ShareTray::saveSettings()
 {
-    QSettings st ( QDir::homePath() +&quot;/.x2godesktopshare/settings&quot;,
-                   QSettings::NativeFormat );
+	QSettings st ( QDir::homePath() +&quot;/.x2godesktopsharing/settings&quot;,
+	               QSettings::NativeFormat );
 
-    st.setValue ( &quot;blacklist&quot;,blackList );
-    st.setValue ( &quot;whitelist&quot;,whiteList );
+	st.setValue ( &quot;blacklist&quot;,blackList );
+	st.setValue ( &quot;whitelist&quot;,whiteList );
 }
 
 
 void ShareTray::setTrayIcon()
 {
-    if ( !acceptConnections() )
-    {
-        trayIcon-&gt;setIcon ( QIcon ( &quot;:icons/22x22/discard.png&quot; ) );
-        return;
-    }
-    if ( menu-&gt;actions().count() &gt;STAT_ACT_COUNT )
-    {
-        trayIcon-&gt;setIcon ( QIcon ( &quot;:icons/22x22/view.png&quot; ) );
-        return;
-    }
-    trayIcon-&gt;setIcon ( QIcon ( &quot;:icons/22x22/accept.png&quot; ) );
+	if ( !acceptConnections() )
+	{
+		trayIcon-&gt;setIcon ( QIcon ( &quot;:icons/22x22/discard.png&quot; ) );
+		return;
+	}
+	if ( menu-&gt;actions().count() &gt;STAT_ACT_COUNT )
+	{
+		trayIcon-&gt;setIcon ( QIcon ( &quot;:icons/22x22/view.png&quot; ) );
+		return;
+	}
+	trayIcon-&gt;setIcon ( QIcon ( &quot;:icons/22x22/accept.png&quot; ) );
 }
 
 
 
 void ShareTray::slotAbout()
 {
-    setWindowTitle ( tr ( &quot;X2Go Desktop Sharing&quot; ) );
+	setWindowTitle ( tr ( &quot;X2Go Desktop Sharing&quot; ) );
 
-    show();
-    ui.ok_cancel_box-&gt;hide();
-    ui.box-&gt;hide();
-    ui.del-&gt;hide();
+	show();
+	ui.ok_cancel_box-&gt;hide();
+	ui.box-&gt;hide();
+	ui.del-&gt;hide();
 
-    ui.close_box-&gt;show();
-    ui.icon-&gt;show();
-    ui.text-&gt;show();
+	ui.close_box-&gt;show();
+	ui.icon-&gt;show();
+	ui.text-&gt;show();
 }
 
 
 void ShareTray::slotAboutQt()
 {
-    QMessageBox::aboutQt ( 0 );
+	QMessageBox::aboutQt ( 0 );
 }
 
 void ShareTray::slotMsgOkCancel ( QAbstractButton* button )
 {
-    if ( ui.ok_cancel_box-&gt;buttonRole ( button ) ==QDialogButtonBox::AcceptRole )
-    {
-        QStringList* lst;
-        if ( current_list==BLACK )
-            lst=&blackList;
-        else
-            lst=&whiteList;
-        lst-&gt;clear();
-        for ( int i=ui.box-&gt;count()-1;i&gt;=0;--i )
-        {
-            *lst&lt;&lt;ui.box-&gt;item ( i )-&gt;text();
-        }
-    }
-    actBlack-&gt;setEnabled ( blackList.size() &gt;0 );
-    actWhite-&gt;setEnabled ( whiteList.size() &gt;0 );
-    hide();
+	if ( ui.ok_cancel_box-&gt;buttonRole ( button ) ==QDialogButtonBox::AcceptRole )
+	{
+		QStringList* lst;
+		if ( current_list==BLACK )
+			lst=&blackList;
+		else
+			lst=&whiteList;
+		lst-&gt;clear();
+		for ( int i=ui.box-&gt;count()-1;i&gt;=0;--i )
+		{
+			*lst&lt;&lt;ui.box-&gt;item ( i )-&gt;text();
+		}
+	}
+	actBlack-&gt;setEnabled ( blackList.size() &gt;0 );
+	actWhite-&gt;setEnabled ( whiteList.size() &gt;0 );
+	hide();
 }
 
 void ShareTray::slotMsgClose ( QAbstractButton* )
 {
-    hide();
+	hide();
 }
 
 void ShareTray::slotDelListItem()
 {
-    for ( int i=ui.box-&gt;count()-1;i&gt;=0;--i )
-    {
-        QListWidgetItem* it=ui.box-&gt;item ( i );
-        if ( it-&gt;isSelected() )
-        {
-            ui.box-&gt;takeItem ( i );
-            delete it;
-        }
-    }
+	for ( int i=ui.box-&gt;count()-1;i&gt;=0;--i )
+	{
+		QListWidgetItem* it=ui.box-&gt;item ( i );
+		if ( it-&gt;isSelected() )
+		{
+			ui.box-&gt;takeItem ( i );
+			delete it;
+		}
+	}
 }
 
 void ShareTray::slotMenuClose()
 {
-    menuClose=true;
-    close();
+	menuClose=true;
+	close();
 }
 
-
-
 void ShareTray::slotUpdateLockFile()
 {
-    QFile file ( lockFname );
-    if ( file.open ( QIODevice::WriteOnly | QIODevice::Text ) )
-    {
-        QTextStream out ( &amp;file );
-        out&lt;&lt;QDateTime::currentDateTime().toTime_t();
-    }
+	QFile file ( lockFname );
+	if ( file.open ( QIODevice::WriteOnly | QIODevice::Text ) )
+	{
+		QTextStream out ( &amp;file );
+		out&lt;&lt;QDateTime::currentDateTime().toTime_t();
+	}
 }
diff --git a/sharetray.h b/sharetray.h
index 137ba61..71c792a 100644
--- a/sharetray.h
+++ b/sharetray.h
@@ -22,62 +22,85 @@ class AccessAction;
 class QSystemTrayIcon;
 class MessageBox;
 class QAction;
+class QSocketNotifier;
 
 /**
 	@author Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
 */
 class ShareTray : public QMainWindow
 {
-    Q_OBJECT
+	Q_OBJECT
 public:
-    ShareTray();
-    ~ShareTray();
-    QString getSocketAnswer(QString message);
-    void closeSocket(SimpleLocalSocket* sock);
-    bool acceptConnections();
+	ShareTray();
+	~ShareTray();
+	// Unix signal handlers.
+	static void keybintSignalHandler(int unused);
+	static void termSignalHandler(int unused);
+	static void abortSignalHandler(int unused);
+	static void hupSignalHandler(int unused);
+	// desktop sharing socket
+	QString getSocketAnswer(QString message);
+	void closeSocket(SimpleLocalSocket* sock);
+	// entry point for incoming connections
+	bool acceptConnections();
 private:
-    enum {BLACK,WHITE} current_list;
-    QMenu* menu;
-    QWidget* mainWnd;
-    QAction* actStart;
-    QAction* actStop;
-    QAction* actWhite;
-    QAction* actBlack;
-    QSystemTrayIcon* trayIcon;
-    QLocalServer* serverSocket;
-    QString socketFname;
-    QString lockFname;
-    MessageBox* mbox;
-    QStringList whiteList;
-    QStringList blackList;
-    Ui::mwnd ui;
-    bool menuClose;
+	enum {BLACK,WHITE} current_list;
+	QMenu* menu;
+	QWidget* mainWnd;
+	QAction* actStart;
+	QAction* actStop;
+	QAction* actWhite;
+	QAction* actBlack;
+	QSystemTrayIcon* trayIcon;
+	QLocalServer* serverSocket;
+	QString socketFname;
+	QString lockFname;
+	MessageBox* mbox;
+	QStringList whiteList;
+	QStringList blackList;
+	Ui::mwnd ui;
+	bool menuClose;
 protected:
-    void closeEvent ( QCloseEvent* event );
+	void closeEvent ( QCloseEvent* event );
 
+public slots:
+	// Qt signal handlers.
+	void handleSigKeybInt();
+	void handleSigTerm();
+	void handleSigAbort();
+	void handleSigHup();
+	void slotMenuClose();
 private slots:
-    void slotStopSharing();
-    void slotStartSharing();
-    void slotServerConnection();
-    void slotCloseConnection(AccessAction* action);
-    void slotTimer();
-    void slotWhiteList();
-    void slotBlackList();
-    void slotAboutQt();
-    void slotAbout();
-    void slotMsgClose(QAbstractButton*);
-    void slotMsgOkCancel(QAbstractButton* button);
-    void slotDelListItem();
-    void slotMenuClose();
-    void slotUpdateLockFile();
+	void slotStopSharing();
+	void slotStartSharing();
+	void slotServerConnection();
+	void slotCloseConnection(AccessAction* action);
+	void slotTimer();
+	void slotWhiteList();
+	void slotBlackList();
+	void slotAboutQt();
+	void slotAbout();
+	void slotMsgClose(QAbstractButton*);
+	void slotMsgOkCancel(QAbstractButton* button);
+	void slotDelListItem();
+	void slotUpdateLockFile();
 private:
-    int getAccess(QString user, QString host);
-    void trayMessage(QString title, QString text);
-    bool isProcessRunning(QString pid);
-    void loadSettings();
-    void saveSettings();
-    void setTrayIcon();
-    void showList();
+	int getAccess(QString user, QString host);
+	void trayMessage(QString title, QString text);
+	bool isProcessRunning(QString pid);
+	void loadSettings();
+	void saveSettings();
+	void setTrayIcon();
+	void showList();
+	// unix file sockets for signal handler communication (unix &lt;-&gt; Qt)
+	static int sigkeybintFd[2];
+	static int sigtermFd[2];
+	static int sigabortFd[2];
+	static int sighupFd[2];
+	QSocketNotifier *snKeybInt;
+	QSocketNotifier *snTerm;
+	QSocketNotifier *snAbort;
+	QSocketNotifier *snHup;
 };
 
 #endif


hooks/post-receive
-- 
x2godesktopsharing.git (Desktop Sharing for X2go)

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;x2godesktopsharing.git&quot; (Desktop Sharing for X2go).


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001718.html">[X2go-Commits] x2godesktopsharing.git - master (branch) updated:	3.0.1.2-34-g0d8c6ad
</A></li>
	<LI>Next message: <A HREF="001720.html">[X2go-Commits] nx-x11.git - master (branch) created:	80ba46ddaa9769ae0008ea3a791239764235c305
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1719">[ date ]</a>
              <a href="thread.html#1719">[ thread ]</a>
              <a href="subject.html#1719">[ subject ]</a>
              <a href="author.html#1719">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/x2go-commits">More information about the X2go-commits
mailing list</a><br>
</body></html>
