<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [X2go-Commits] x2gobroker.git - master (branch) updated:	57030875e10c269c360ac2b1c1623b9f427d6714
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/x2go-commits/2012-November/index.html" >
   <LINK REL="made" HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2go-Commits%5D%20x2gobroker.git%20-%20master%20%28branch%29%20updated%3A%0A%0957030875e10c269c360ac2b1c1623b9f427d6714&In-Reply-To=%3C20121121160458.0F6185DB1A%40ymir%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003700.html">
   <LINK REL="Next"  HREF="003702.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[X2go-Commits] x2gobroker.git - master (branch) updated:	57030875e10c269c360ac2b1c1623b9f427d6714</H1>
    <B>X2Go dev team</B> 
    <A HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2go-Commits%5D%20x2gobroker.git%20-%20master%20%28branch%29%20updated%3A%0A%0957030875e10c269c360ac2b1c1623b9f427d6714&In-Reply-To=%3C20121121160458.0F6185DB1A%40ymir%3E"
       TITLE="[X2go-Commits] x2gobroker.git - master (branch) updated:	57030875e10c269c360ac2b1c1623b9f427d6714">git-admin at x2go.org
       </A><BR>
    <I>Wed Nov 21 17:04:57 CET 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="003700.html">[X2go-Commits] python-x2go.git - master (branch) updated:	0.2.0.10-86-gf7bffc7
</A></li>
        <LI>Next message: <A HREF="003702.html">[X2go-Commits] python-x2go.git - master (branch) updated:	0.2.0.10-87-g1d46f7b
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3701">[ date ]</a>
              <a href="thread.html#3701">[ thread ]</a>
              <a href="subject.html#3701">[ subject ]</a>
              <a href="author.html#3701">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch, master has been updated
       via  57030875e10c269c360ac2b1c1623b9f427d6714 (commit)
       via  00034ba69ecca2523dc6ad1b5b16f9952508683c (commit)
       via  14f559e001506c6aefb74a8c8c74470ab2dc3963 (commit)
       via  3acbb6d354fe3421197a568004bb135c7b6612bf (commit)
       via  241a6ba9de4baaa0fda547636ce29578c24ff5bd (commit)
      from  1f3029121c54e02b5db037f448dfa79435702b6b (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 57030875e10c269c360ac2b1c1623b9f427d6714
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Wed Nov 21 17:02:54 2012 +0100

    start serious work on the zeroconf broker

commit 00034ba69ecca2523dc6ad1b5b16f9952508683c
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Wed Nov 21 17:02:38 2012 +0100

    Make sure libx2go-broker-perl of the same version gets installed with x2gobroker-common. Add dependencies: libauthen-pam-perl, libauthen-simple-pam-perl.

commit 14f559e001506c6aefb74a8c8c74470ab2dc3963
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Tue Nov 13 19:55:22 2012 +0100

    fix x2gobroker-common.install

commit 3acbb6d354fe3421197a568004bb135c7b6612bf
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Tue Nov 13 19:53:27 2012 +0100

    Using our own PAM service ,,x2gobroker''.

commit 241a6ba9de4baaa0fda547636ce29578c24ff5bd
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Tue Nov 13 19:51:33 2012 +0100

    fix project name

-----------------------------------------------------------------------

Summary of changes:
 X2Go/Broker/ZeroConf.pm          |   50 ++++++++++++++++++++++----------------
 cgi/x2gobroker.cgi               |   14 +++++------
 debian/changelog                 |    6 ++++-
 debian/control                   |    3 +++
 debian/x2gobroker-common.install |    2 +-
 debian/x2gobroker.pam            |    2 ++
 lib/x2gobroker-agent.pl          |    6 ++---
 7 files changed, 49 insertions(+), 34 deletions(-)
 create mode 100644 debian/x2gobroker.pam

The diff of changes is:
diff --git a/X2Go/Broker/ZeroConf.pm b/X2Go/Broker/ZeroConf.pm
index 0655191..da4eb98 100644
--- a/X2Go/Broker/ZeroConf.pm
+++ b/X2Go/Broker/ZeroConf.pm
@@ -21,7 +21,7 @@
 package X2Go::Broker::ZeroConf;
 
 use strict;
-use Sys:Hostname;
+use Sys::Hostname;
 use Authen::PAM;
 use Authen::Simple::PAM;
 use X2Go::Broker::Common;
@@ -38,13 +38,16 @@ my $hostname = hostname;
 ### public functions, available to broker cgi
 ###
 
+my $username;
+my $password;
+
 ### exported function ###
 sub CheckAccess
 {
 	# zeroconf broker: use PAM to perform authentication against
 	#                  the local PAM login module
-	my ($user,$pass)=@_;
-	my $pam = Authen::Simple::PAM-&gt;new(service =&gt; 'login');
+	($username, $password)=@_;
+	my $pam = Authen::Simple::PAM-&gt;new(service =&gt; 'x2gobroker');
 	if ( $pam-&gt;authenticate( $username, $password ) ) {
 		# successfull authentication
 		return 0 
@@ -63,11 +66,11 @@ sub SetPass
 	my ($username, $oldpassword, $newpassword)=@_;
 
 	# zeroconf broker: use PAM to initiate a local passwd change
-	my $service = &quot;passwd&quot;;
-	ref($pamh = new Authen::PAM($service, $username, \&amp;passwd_conv_func)) ||
-	    die &quot;Error code $pamh during PAM init!&quot;;
-	$state = 0;
-	$res = $pamh-&gt;pam_chauthtok;
+	my $service = &quot;x2gobroker&quot;;
+	my $pamh = new Authen::PAM($service, $username, \&amp;passwd_conv_func) ||
+	    die &quot;Error code \$pamh during PAM init!&quot;;
+	my $state = 0;
+	my $res = $pamh-&gt;pam_chauthtok;
 	die $pamh-&gt;pam_strerror($res) unless $res == PAM_SUCCESS();
 
 	print &quot;\n&lt;br&gt;CHANGING PASS OK&lt;br&gt;\n&quot;;
@@ -76,16 +79,16 @@ sub SetPass
 ### exported function ###
 sub SelectSession
 {
-	my ($user, $sid)=@_;
-	my @words=split(&quot;\@&quot;,$sid);
+	my ($user, $session_id)=@_;
+	my @words=split(&quot;\@&quot;,$session_id);
 	###
-	### FIXME: why the heck is the $sid format &lt;host&gt;@&lt;session&gt;,
+	### FIXME: why the heck is the $session_id format &lt;host&gt;@&lt;session&gt;,
 	###        &lt;session&gt;@&lt;host&gt; would make much more sense!!! (for
 	###        the human eye...)
 	###
-	my $sess_id=@words[1];
+	my $session_id=@words[1];
 	my $host=@words[0];
-	check_and_start_session($user, $host, $sess_id);
+	check_and_start_session($user, $host, $session_id);
 }
 
 ### exported function ###
@@ -93,15 +96,15 @@ sub ListSessions
 {
 	# print Dumper($message-&gt;entries);
 	print &quot;START_USER_SESSIONS&lt;br&gt;&quot;;
-	my($status,$sessions)=CallBrokerAgent($hostname, $user, 'listsessions');
+	my($status,$sessions)=CallBrokerAgent($hostname, $username, 'listsessions');
 	if ( $status )
 	{
 		if($sessions)
 		{
 			my @sinfo = split(&quot;\\|&quot;,$sessions);
 			my $session_status = @sinfo[4];
-			my $sid = @sinfo[1];
-			print &quot;&lt;br&gt;[$hostname\@$sid]&lt;br&gt;&quot;;
+			my $session_id = @sinfo[1];
+			print &quot;&lt;br&gt;[$hostname\@$session_id]&lt;br&gt;&quot;;
 			print &quot;status=$session_status&lt;br&gt;&quot;;
 		} else {
 			print &quot;&lt;br&gt;[$hostname]&lt;br&gt;&quot;;
@@ -121,6 +124,10 @@ sub passwd_conv_func {
 		my $code = shift;
 		my $msg = shift;
 		my $ans = &quot;&quot;;
+		my $state;
+
+		my $oldpassword;
+		my $newpassword;
 
 		$ans = $username if ( $code == PAM_PROMPT_ECHO_ON() );
 		if ( $code == PAM_PROMPT_ECHO_OFF() ) {
@@ -137,8 +144,9 @@ sub passwd_conv_func {
 
 sub check_and_start_session
 {
-	my ($uid, $host, $sid) = @_;
-	my ($status, $sessions)=ExecRemoteBroker($user, $hostname, 'listsessions');
+	my ($username, $hostname, $session_id) = @_;
+	my $running;
+	my ($status, $sessions)=ExecRemoteBroker($username, $hostname, 'listsessions');
 	if ( ! $status )
 	{
 		print &quot;ERROR: X2Go server not available\n&quot;;
@@ -151,12 +159,12 @@ sub check_and_start_session
 		my @sinfo = split(&quot;\\|&quot;,$sessions);
 		my $session_status = @sinfo[4];
 		my $session_server = @sinfo[3];
-		$sid=@sinfo[1];
+		$session_id=@sinfo[1];
 		if( $session_status eq 'R' )
 		{
 			$running = 1;
 			my $str;
-			($status, $str) = ExecRemoteBroker($uid, $hostname, &quot;suspend $sid&quot;);
+			($status, $str) = ExecRemoteBroker($username, $hostname, &quot;suspend $session_id&quot;);
 			$sessions =~ s/\|R\|/\|S\|/;
 		}
 		if( $session_status eq 'S' )
@@ -165,7 +173,7 @@ sub check_and_start_session
 		}
 	}
 
-	print &quot;SERVER:$hostname:$port\n&quot;;
+	print &quot;SERVER:$hostname\n&quot;;
 	if($running)
 	{
 		# use first session in session list...
diff --git a/cgi/x2gobroker.cgi b/cgi/x2gobroker.cgi
index 06ed66b..3d44d52 100755
--- a/cgi/x2gobroker.cgi
+++ b/cgi/x2gobroker.cgi
@@ -24,15 +24,13 @@ use strict;
 use File::Basename qw(basename);
 
 my $cgi_name = basename($0);
-my $broker_backend ~= s/x2gobroker-(.*)\.cgi/\1/
+my $broker_backend = $cgi_name;
+$broker_backend =~ s/x2gobroker-(.*)\.cgi/\1/;
 
-use lib &quot;/usr/lib/x2go/&quot;;
-use lib &quot;/usr/lib/x2go/broker/&quot;;
-
-switch ( $broker_backend ) {
-	case 'zeroconf' { use X2Go::Broker::ZeroConf qw(CheckAccess SetPass SelectSession ListSessions) }
-	case 'simple' { use X2Go::Broker::Simple qw(CheckAccess SetPass SelectSession ListSessions) }
-	case 'ldap' { use X2Go::Broker::LDAP qw(CheckAccess SetPass SelectSession ListSessions) }
+SWITCH: {
+  $broker_backend == &quot;zeroconf&quot; &amp;&amp; do { use X2Go::Broker::ZeroConf qw(CheckAccess SetPass SelectSession ListSessions); last SWITCH; };
+#  $broker_backend == &quot;simple&quot; &amp;&amp; do { use X2Go::Broker::Simple qw(CheckAccess SetPass SelectSession ListSessions); last SWITCH; };
+#  $broker_backend == &quot;ldap&quot; &amp;&amp; do { use X2Go::Broker::LDAP qw(CheckAccess SetPass SelectSession ListSessions); last SWITCH; };
 }
 
 use CGI;
diff --git a/debian/changelog b/debian/changelog
index ce356c8..42e3641 100644
--- a/debian/changelog
+++ b/debian/changelog
@@ -1,9 +1,13 @@
 x2gobroker (0.0.0.1-0~x2go1) UNRELEASED; urgency=low
 
   [ Mike Gabriel ]
-  * Setting up new public X2Go project: x2gohttpbroker.
+  * Setting up new public X2Go project: x2gobroker.
+    - Using our own PAM service ,,x2gobroker''.
   * /debian/control:
     + Add an initial dependency selection to the various Depends fields.
+    + Make sure libx2go-broker-perl of the same version gets installed
+      with x2gobroker-common.
+    + Add dependencies: libauthen-pam-perl, libauthen-simple-pam-perl.
   * Fix code indentations (spaces replaced by tabs, use proper indentation
     levels).
 
diff --git a/debian/control b/debian/control
index c58792f..3381442 100644
--- a/debian/control
+++ b/debian/control
@@ -43,6 +43,7 @@ Package: x2gobroker-common
 Architecture: all
 Depends:
  ${misc:Depends},
+ libx2go-broker-perl (&gt;= ${source:Version}), libx2go-broker-perl (&lt;&lt; ${source:Version}.1~),
 Description: X2Go http(s) based session broker (common files)
  X2Go is a serverbased computing environment with
     - session resuming
@@ -133,6 +134,8 @@ Depends:
  apache2 | httpd,
  perl,
  x2gobroker-common (&gt;= ${source:Version}), x2gobroker-common (&lt;&lt; ${source:Version}.1~),
+ libauthen-pam-perl,
+ libauthen-simple-pam-perl,
 Description: X2Go http(s) session broker (for demo purposes only)
  X2Go is a serverbased computing environment with
     - session resuming
diff --git a/debian/x2gobroker-common.install b/debian/x2gobroker-common.install
index 59f3588..e9793a9 100644
--- a/debian/x2gobroker-common.install
+++ b/debian/x2gobroker-common.install
@@ -1 +1 @@
-cgi/x2gobroker.cgi usr/lib/cgi-bin/
\ No newline at end of file
+cgi/x2gobroker.cgi usr/lib/cgi-bin/
diff --git a/debian/x2gobroker.pam b/debian/x2gobroker.pam
new file mode 100644
index 0000000..1eaad76
--- /dev/null
+++ b/debian/x2gobroker.pam
@@ -0,0 +1,2 @@
<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">+ at include</A> common-auth
<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">+ at include</A> common-passwd
diff --git a/lib/x2gobroker-agent.pl b/lib/x2gobroker-agent.pl
index 02b6b04..0d5b559 100755
--- a/lib/x2gobroker-agent.pl
+++ b/lib/x2gobroker-agent.pl
@@ -95,7 +95,7 @@ if($mode eq 'listsessions')
 {
 	InitX2GoUser($name, $uid, $gid, $home);
 	print &quot;OK\n&quot;;
-	system &quot;/bin/su&quot;, $name, &quot;-c&quot;, &quot;x2golistsessions --all-servers&quot;;
+	system &quot;/bin/su - &quot;, $name, &quot;-c&quot;, &quot;x2golistsessions --all-servers&quot;;
 }
 
 
@@ -103,7 +103,7 @@ if($mode eq 'getservers')
 {
 	InitX2GoUser($name, $uid, $gid, $home);
 	print &quot;OK\n&quot;;
-	system &quot;/bin/su&quot;, $name, &quot;-c&quot;, &quot;x2gogetservers&quot;;
+	system &quot;/bin/su - &quot;, $name, &quot;-c&quot;, &quot;x2gogetservers&quot;;
 }
 
 if($mode eq 'key')
@@ -118,7 +118,7 @@ if($mode eq 'suspend')
 	InitX2GoUser($name, $uid, $gid, $home);
 	print &quot;OK\n&quot;;
 	my $sid=shift;
-	system &quot;/bin/su&quot;, $name, &quot;-c&quot;, &quot;x2gosuspend-session $sid&quot;;
+	system &quot;/bin/su - &quot;, $name, &quot;-c&quot;, &quot;x2gosuspend-session $sid&quot;;
 }
 
 if($mode eq 'ping')


hooks/post-receive
-- 
x2gobroker.git (HTTP(S) Session broker for X2Go)

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;x2gobroker.git&quot; (HTTP(S) Session broker for X2Go).

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003700.html">[X2go-Commits] python-x2go.git - master (branch) updated:	0.2.0.10-86-gf7bffc7
</A></li>
	<LI>Next message: <A HREF="003702.html">[X2go-Commits] python-x2go.git - master (branch) updated:	0.2.0.10-87-g1d46f7b
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3701">[ date ]</a>
              <a href="thread.html#3701">[ thread ]</a>
              <a href="subject.html#3701">[ subject ]</a>
              <a href="author.html#3701">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/x2go-commits">More information about the X2go-commits
mailing list</a><br>
</body></html>
