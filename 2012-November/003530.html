<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [X2go-Commits] x2goserver.git - backport-lenny (branch) updated:	3.1.1.6-19-gfe1ca49
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/x2go-commits/2012-November/index.html" >
   <LINK REL="made" HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2go-Commits%5D%20x2goserver.git%20-%20backport-lenny%20%28branch%29%20updated%3A%0A%093.1.1.6-19-gfe1ca49&In-Reply-To=%3C20121109103724.063D05DB19%40ymir%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003529.html">
   <LINK REL="Next"  HREF="003531.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[X2go-Commits] x2goserver.git - backport-lenny (branch) updated:	3.1.1.6-19-gfe1ca49</H1>
    <B>X2Go dev team</B> 
    <A HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2go-Commits%5D%20x2goserver.git%20-%20backport-lenny%20%28branch%29%20updated%3A%0A%093.1.1.6-19-gfe1ca49&In-Reply-To=%3C20121109103724.063D05DB19%40ymir%3E"
       TITLE="[X2go-Commits] x2goserver.git - backport-lenny (branch) updated:	3.1.1.6-19-gfe1ca49">git-admin at x2go.org
       </A><BR>
    <I>Fri Nov  9 11:37:23 CET 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="003529.html">[X2go-Commits] nx-libs.git - backport-lenny (branch) updated:	redist-client/3.5.0.16-12-g6955064
</A></li>
        <LI>Next message: <A HREF="003531.html">[X2go-Commits] libpam-x2go.git - master (branch) updated:	edd14a06a92de3b1275f4aeb377d8fa3852f823e
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3530">[ date ]</a>
              <a href="thread.html#3530">[ thread ]</a>
              <a href="subject.html#3530">[ subject ]</a>
              <a href="author.html#3530">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch, backport-lenny has been updated
       via  fe1ca4911889c8da22c50184293e1f4635718a21 (commit)
       via  623a4649daca7f1489b3441f44f24f5f58db2cfa (commit)
       via  3328841f3bd32a01c722fa87bc2fa46e69366de4 (commit)
       via  66574504720a2b2b4c3e096ef92945a676515e23 (commit)
       via  66f150790fc68cc50eade2e070876d04adf2e851 (commit)
       via  07524db03a6c42a54941a03be6637b0ded80a448 (commit)
       via  de0ef239a7408fd7299f2ea599da91f975f3ffad (commit)
       via  ec11165bab6086fa649109a0814eba328a47d69a (commit)
       via  3e7f787ba06ffd6a90e48816cd1789b76ada4d64 (commit)
       via  fe8874ec148a015f0bff75407e00aa1b9ee9a99a (commit)
       via  abf5ce667307f34bfb034c4ff19dee74665c37e8 (commit)
       via  e8c4fc15d16b315d4471243f8dbb33d2eda2f900 (commit)
       via  c7d7bc79b50bd7c5691793218f11ec7375f2dcc8 (commit)
       via  3a9f412b1710c1b20a9e9b233c92532611dda001 (commit)
       via  cb4796d026014e9e07ec9ea3e80106bc03697f2f (commit)
       via  5cc4d72358fd7f99aeec74ce346f526315f33999 (commit)
       via  f8015d5c95b5d376bdf02b2fc7096c21ed368ce0 (commit)
       via  8da7d3082b406641fa2d4f363b51300b1c639bfa (commit)
       via  97ae712cc1fbfab753c0a0a1634550e97cc9aac7 (commit)
       via  7dced6158846f4cd2a7f1c9f2f94eef8225ff387 (commit)
       via  504167bac89b55b9f21047676ddde3a5deeceb95 (commit)
       via  973db626cf5d84e7c62bb6dc58c094f86512db1a (commit)
       via  3b891b928323f52e8a539e2f165fc06712e2124f (commit)
       via  a41afc38aa2e342dfb8c592a674ff3a9f52c54d4 (commit)
       via  0b3c71ca7b6e3681a2ade80346621b22ffa7f255 (commit)
       via  98512000e2b0208849d93b97f0e9a216f0c18c28 (commit)
       via  1590476de31766028725fa1272dfcc50b7d1305e (commit)
       via  22ede8d3f939d849856feeaad0e777738fbeea9b (commit)
       via  df4c17c9ef5337a453323b0f933039a4b8cac9a5 (commit)
       via  0c3542c4b6710d97ad11f182e0ec8c0f5198b9e4 (commit)
       via  452498574b305425ec8a2e81b82ea86e4c5f67d4 (commit)
       via  2b68ff4432efb0f7058da0e4c8c3f2dfb446d459 (commit)
       via  df13257d3fe83b4e12f9117f39e82b05276c44a1 (commit)
       via  48ccfe5706cb5192fc0a4a83938db827b5565ee0 (commit)
       via  6b41cef9e10da4dee9f16c36f273c3d723208953 (commit)
       via  96046134086d5c2fc2fdb1345df32cc2af37e773 (commit)
       via  a35b196a82b523f24430b6977c61bc8d702f9d93 (commit)
       via  ead0462ea08a768e361aad48ebc0fb913c5c826d (commit)
       via  d70b136ab99623678f34c12f2175570a856eaa77 (commit)
       via  15f93bffe63a7d9eea3a7cb1fe12d531e92c113f (commit)
      from  0f06cbd2d9ac63f2067fd733495f80e28cfdb9e4 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit fe1ca4911889c8da22c50184293e1f4635718a21
Merge: 0f06cbd 623a464
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Fri Nov 9 11:34:01 2012 +0100

    Merge branch 'build-main' into backport-lenny
    
    Conflicts (resolved by Mike Gabriel):
    	debian/changelog
    	debian/control

-----------------------------------------------------------------------

Summary of changes:
 debian/changelog                                   |   75 +++++++++++++++++---
 debian/control                                     |   28 ++++----
 x2goserver-compat/VERSION.x2goserver-compat        |    2 +-
 .../VERSION.x2goserver-extensions                  |    2 +-
 .../VERSION.x2goserver-fmbindings                  |    2 +-
 x2goserver-printing/VERSION.x2goserver-printing    |    2 +-
 x2goserver-pyhoca/VERSION.x2goserver-pyhoca        |    2 +-
 x2goserver-xsession/VERSION.x2goserver-xsession    |    2 +-
 x2goserver/Makefile                                |    2 +-
 x2goserver/VERSION.x2goserver                      |    2 +-
 x2goserver/bin/x2gogetapps                         |   18 ++++-
 x2goserver/bin/x2gomountdirs                       |   32 ++++++++-
 x2goserver/bin/x2goruncommand                      |   24 ++++++-
 x2goserver/bin/x2gostartagent                      |    6 +-
 x2goserver/bin/x2goumount-session                  |   35 ++++++++-
 x2goserver/lib/x2gogetagent                        |    4 +-
 x2goserver/sbin/x2gocleansessions                  |    1 +
 17 files changed, 196 insertions(+), 43 deletions(-)

The diff of changes is:
diff --git a/debian/changelog b/debian/changelog
index d51f833..78c1e88 100644
--- a/debian/changelog
+++ b/debian/changelog
@@ -1,20 +1,73 @@
-x2goserver (3.1.1.3-0~x2go+bpo+lenny2) unstable; urgency=low
+x2goserver (3.1.1.6-0~x2go+bpo+lenny1) unstable; urgency=low
 
-  * Cherry-picks from upcoming version 3.1.1.4:
-    - Fix x2gosessionlimit script.
-  * /debian/control:
-    + Fix x2goagent dependency.
-
- -- Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;  Thu, 19 Jul 2012 16:35:22 +0200
-
-x2goserver (3.1.1.3-0~x2go+bpo+lenny1) unstable; urgency=low
-
-  * Backport current status of x2goserver (unreleased 3.1.1.3) to
+  * Backport current status of x2goserver (unreleased 3.1.1.6) to
     Debian lenny.
   * No DBI method sqlite_busy_timeout available on Debian lenny.
   
  -- Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;  Thu, 05 Apr 2012 15:37:39 +0200
 
+x2goserver (3.1.1.6-0~x2go1) unstable; urgency=low
+
+  * Bugfix release (3.1.1.6):
+    - Fix for non-well-tested x2gomountdirs script.
+
+ -- Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;  Wed, 07 Nov 2012 20:57:54 +0100
+
+x2goserver (3.1.1.5-0~x2go1) unstable; urgency=low
+
+  [ St&#233;phane Graber ]
+  * New upstream version (3.1.1.5):
+    - Add a very basic SIGCHLD handler to x2gocleansessions. on SIGCHLD
+      let the script wait for cleaning up after its children. (Closes
+      upstream issue #38).
+
+  [ Mike Gabriel ]
+  * New upstream version (3.1.1.5):
+    - Fix x2gogetapps when rendering multi-section .desktop files. (Closes
+      upstream issue #43).
+    - Remove redundant setting of loglevel in x2gogetapps.
+    - Fix ,,Only extend LD_LIBRARY_PATH by Xrandr extension for KDE. Breaks
+      GNOME.'' from last release.
+    - Detect i18n name of Desktop folder via XDG_DESKTOP_DIR environment
+      variable.
+    - Put option of database call in x2gogetagent into parantheses.
+  * /debian/control:
+    + Depend on libfile-basedir-perl.
+
+ -- Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;  Wed, 07 Nov 2012 16:36:36 +0100
+
+x2goserver (3.1.1.4-0~x2go1) unstable; urgency=low
+
+  [ Jan Engelhardt ]
+  * New upstream version (3.1.1.4):
+    - Add -pie as linker flag. Fixes non-position-independent-executable
+      (x2gosqlitewrapper.c). The executable is now completely position
+      independent.
+
+  [ Mike Gabriel ]
+  * New upstream version (3.1.1.4):
+    - Fix x2gosessionlimit script.
+    - Wrap padsp around rdesktop calls if pulse is used as audio protocol.
+    - Add option ,,-r sound:local'' to rdesktop calls if pulse is enabled.
+    - Proxy X2Go client-side shares into remote desktop session.
+    - For applications inside of a session, use NX's Xrandr library instead
+      of Xorg's Xrandr library (partially closes #28).
+    - Make sure when launching desktop session through the Xsession mechanism
+      that the LD_LIBRARY_PATH variable stays intact. Closes #29.
+    - Only extend LD_LIBRARY_PATH by Xrandr extension for KDE. Breaks GNOME.
+  * /debian/control:
+    + Maintainer change in package: X2Go Developers &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">x2go-dev at lists.berlios.de</A>&gt;.
+    + Depend on nx-libs (&gt;=3.5.0.15-0~) which has the Xrandr symlinks folder.
+    + Add rdesktop and pulseaudio-utils to Suggests.
+    + Priority: optional.
+
+  [ Oleksandr Shneyder ]
+  * New upstream version (3.1.1.4):
+    - Remove &quot;-nolisten tcp&quot; option with XDMCP sessions.
+
+ -- Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;  Tue, 25 Sep 2012 13:15:11 +0200
+&gt;&gt;&gt;&gt;&gt;&gt;&gt; build-main
+
 x2goserver (3.1.1.3-0~x2go1) unstable; urgency=low
 
   [ Jan Engelhardt ]
diff --git a/debian/control b/debian/control
index 6d75646..6b6d933 100644
--- a/debian/control
+++ b/debian/control
@@ -1,9 +1,10 @@
 Source: x2goserver
 Section: x11
-Priority: extra
-Maintainer: Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
+Priority: optional 
+Maintainer: X2Go Developers &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">x2go-dev at lists.berlios.de</A>&gt;
 Uploaders:
- Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
+ Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;,
+ Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;,
 Build-Depends: 
  debhelper,
  man2html-base | man2html
@@ -17,7 +18,7 @@ Architecture: any
 Depends:
  ${shlibs:Depends},
  ${misc:Depends},
- x2goagent (&gt;= 2:3.5.0.12-0~),
+ x2goagent (&gt;= 2:3.5.0.16-0~),
  lsof,
  openssh-client,
  openssh-server,
@@ -25,6 +26,7 @@ Depends:
  makepasswd,
  libdbd-pg-perl,
  libdbd-sqlite3-perl,
+ libfile-basedir-perl,
  adduser,
  xauth,
  psmisc,
@@ -44,7 +46,9 @@ Suggests:
  x2goserver-compat (= ${source:Version}),
  x2goserver-xsession (= ${source:Version}),
  x2goserver-fmbindings (= ${source:Version}),
- x2goserver-pyhoca (= ${source:Version})
+ x2goserver-pyhoca (= ${source:Version}),
+ rdesktop,
+ pulseaudio-utils
 Breaks:
  x2goserver-one,
  x2goserver-home,
@@ -54,7 +58,7 @@ Replaces:
 Description: X2Go server daemon scripts
  X2Go is a server based computing environment with
     - session resuming
-    - low bandwith support
+    - low bandwidth support
     - LDAP support
     - client side mass storage mounting support
     - audio support
@@ -86,7 +90,7 @@ Suggests:
 Description: X2Go server daemon scripts (printing)
  X2Go is a server based computing environment with
     - session resuming
-    - low bandwith support
+    - low bandwidth support
     - LDAP support
     - client side mass storage mounting support
     - audio support
@@ -113,7 +117,7 @@ Depends:
 Description: X2Go server daemon scripts (backwards compatitbity to old client versions)
  X2Go is a server based computing environment with
     - session resuming
-    - low bandwith support
+    - low bandwidth support
     - LDAP support
     - client side mass storage mounting support
     - audio support
@@ -131,7 +135,7 @@ Depends:
 Description: X2Go server daemon scripts (extensions)
  X2Go is a server based computing environment with
     - session resuming
-    - low bandwith support
+    - low bandwidth support
     - LDAP support
     - client side mass storage mounting support
     - audio support
@@ -154,7 +158,7 @@ Depends:
 Description: X2Go server daemon scripts (Xsession runner)
  X2Go is a server based computing environment with
     - session resuming
-    - low bandwith support
+    - low bandwidth support
     - LDAP support
     - client side mass storage mounting support
     - audio support
@@ -178,7 +182,7 @@ Depends:
 Description: Generic (freedesktop-based) file manager bindings for X2Go
  X2Go is a server based computing environment with
     - session resuming
-    - low bandwith support
+    - low bandwidth support
     - LDAP support
     - client side mass storage mounting support
     - audio support
@@ -203,7 +207,7 @@ Depends:
 Description: X2Go server daemon scripts (add-ons for pyhoca client)
  X2Go is a server based computing environment with
     - session resuming
-    - low bandwith support
+    - low bandwidth support
     - LDAP support
     - client side mass storage mounting support
     - audio support
diff --git a/x2goserver-compat/VERSION.x2goserver-compat b/x2goserver-compat/VERSION.x2goserver-compat
index c7271d2..861a59a 100644
--- a/x2goserver-compat/VERSION.x2goserver-compat
+++ b/x2goserver-compat/VERSION.x2goserver-compat
@@ -1 +1 @@
-3.1.1.3
\ No newline at end of file
+3.1.1.6
\ No newline at end of file
diff --git a/x2goserver-extensions/VERSION.x2goserver-extensions b/x2goserver-extensions/VERSION.x2goserver-extensions
index c7271d2..861a59a 100644
--- a/x2goserver-extensions/VERSION.x2goserver-extensions
+++ b/x2goserver-extensions/VERSION.x2goserver-extensions
@@ -1 +1 @@
-3.1.1.3
\ No newline at end of file
+3.1.1.6
\ No newline at end of file
diff --git a/x2goserver-fmbindings/VERSION.x2goserver-fmbindings b/x2goserver-fmbindings/VERSION.x2goserver-fmbindings
index c7271d2..861a59a 100644
--- a/x2goserver-fmbindings/VERSION.x2goserver-fmbindings
+++ b/x2goserver-fmbindings/VERSION.x2goserver-fmbindings
@@ -1 +1 @@
-3.1.1.3
\ No newline at end of file
+3.1.1.6
\ No newline at end of file
diff --git a/x2goserver-printing/VERSION.x2goserver-printing b/x2goserver-printing/VERSION.x2goserver-printing
index c7271d2..861a59a 100644
--- a/x2goserver-printing/VERSION.x2goserver-printing
+++ b/x2goserver-printing/VERSION.x2goserver-printing
@@ -1 +1 @@
-3.1.1.3
\ No newline at end of file
+3.1.1.6
\ No newline at end of file
diff --git a/x2goserver-pyhoca/VERSION.x2goserver-pyhoca b/x2goserver-pyhoca/VERSION.x2goserver-pyhoca
index c7271d2..861a59a 100644
--- a/x2goserver-pyhoca/VERSION.x2goserver-pyhoca
+++ b/x2goserver-pyhoca/VERSION.x2goserver-pyhoca
@@ -1 +1 @@
-3.1.1.3
\ No newline at end of file
+3.1.1.6
\ No newline at end of file
diff --git a/x2goserver-xsession/VERSION.x2goserver-xsession b/x2goserver-xsession/VERSION.x2goserver-xsession
index c7271d2..861a59a 100644
--- a/x2goserver-xsession/VERSION.x2goserver-xsession
+++ b/x2goserver-xsession/VERSION.x2goserver-xsession
@@ -1 +1 @@
-3.1.1.3
\ No newline at end of file
+3.1.1.6
\ No newline at end of file
diff --git a/x2goserver/Makefile b/x2goserver/Makefile
index 115c929..979283b 100755
--- a/x2goserver/Makefile
+++ b/x2goserver/Makefile
@@ -37,7 +37,7 @@ build: build-arch build-indep
 build-arch: build_setgidwrappers
 
 build_setgidwrappers:
-	gcc -fPIE -o x2gosqlitewrapper x2gosqlitewrapper.c
+	gcc -fPIE -pie -o x2gosqlitewrapper x2gosqlitewrapper.c
 
 build-indep: build_man2html
 
diff --git a/x2goserver/VERSION.x2goserver b/x2goserver/VERSION.x2goserver
index c7271d2..861a59a 100644
--- a/x2goserver/VERSION.x2goserver
+++ b/x2goserver/VERSION.x2goserver
@@ -1 +1 @@
-3.1.1.3
\ No newline at end of file
+3.1.1.6
\ No newline at end of file
diff --git a/x2goserver/bin/x2gogetapps b/x2goserver/bin/x2gogetapps
index 9460cd3..dbcd8c1 100755
--- a/x2goserver/bin/x2gogetapps
+++ b/x2goserver/bin/x2gogetapps
@@ -117,9 +117,24 @@ sub proc_desktop_file
 	if (open(F,&quot;&lt;$file&quot;))
 	{
 		print(&quot;&lt;desktop&gt;\n&quot;);
+		my $is_desktop_entry = 0;
 		while(!eof(F))
 		{
 			my $line=&lt;F&gt;;
+			if ( $line=~m/^\[Desktop Entry\] */ )
+			{
+				$is_desktop_entry = 1;
+				next;
+			}
+			if ( ! $is_desktop_entry )
+			{
+				next;
+			}
+			if ( $line=~m/^\[.*\] */ )
+			{
+				$is_desktop_entry = 0;
+				next;
+			}
 			if( $line=~m/^Categories/i || $line=~m/^Name/i || $line=~m/^Terminal/i || $line=~m/^Comment/i ||  $line=~m/^Exec/i)
 			{
 				print $line;
@@ -155,9 +170,6 @@ sub proc_desktop_file
 	}
 }
 
-openlog($0,'cons,pid','user');
-setlogmask( LOG_UPTO(x2gologlevel()) );
-
 if ( @ARGV ) {
 	syslog('info', &quot;x2gogetapps has been called with options: @ARGV&quot;);
 } else {
diff --git a/x2goserver/bin/x2gomountdirs b/x2goserver/bin/x2gomountdirs
index d4249ad..457a1d3 100755
--- a/x2goserver/bin/x2gomountdirs
+++ b/x2goserver/bin/x2gomountdirs
@@ -22,6 +22,7 @@
 
 use strict;
 use Sys::Syslog qw( :standard :macros );
+use File::BaseDir qw( xdg_config_home );
 
 use lib `echo -n \$(x2gobasepath)/lib/x2go`;
 use x2godbwrapper;
@@ -33,6 +34,27 @@ setlogmask( LOG_UPTO(x2gologlevel()) );
 
 syslog('info', &quot;x2gomountdirs has been called with options: @ARGV&quot;);
 
+sub source_environment {
+    my $name = shift;
+
+    open my $fh, &quot;&lt;&quot;, $name
+        or die &quot;could not open $name: $!&quot;;
+
+    while (&lt;$fh&gt;) {
+        chomp;
+        my $line = $_;
+        if ( $line =~ m/^#.*/ )
+        {
+            next;
+        }
+        my ($k, $v) = split /=/, $line, 2;
+        $v =~ s/^(['&quot;])(.*)\1/$2/; #' fix highlighter
+        $v =~ s/\$([a-zA-Z]\w*)/$ENV{$1}/g;
+        $v =~ s/`(.*?)`/`$1`/ge; #dangerous
+        $ENV{$k} = $v;
+    }
+}
+
 my $tmp_dir = '/tmp';
 
 my $type=shift;
@@ -107,6 +129,8 @@ my $spooldir=&quot;$tmp_dir/.x2go-$ENV{'USER'}/spool&quot;;
 my $mimeboxdir_lnk=&quot;$ENV{'HOME'}/.x2go/C-$session/mimebox&quot;;
 my $mimeboxdir=&quot;$tmp_dir/.x2go-$ENV{'USER'}/mimebox&quot;;
 
+source_environment(xdg_config_home() . &quot;/user-dirs.dirs&quot;);
+
 if (! -e $mdir)
 {
 	mkdir($mdir);
@@ -268,7 +292,13 @@ for (my $i=0;$i&lt;@dirs;$i++)
 			if (! $printspool &amp;&amp; ! $mimeboxspool &amp;&amp; ! $useplasmoid )
 			{
 
-				my $fname=&quot;$ENV{'HOME'}/Desktop&quot;;
+				my $fname;
+				if ( $ENV{'XDG_DESKTOP_DIR'} )
+				{
+					$fname=&quot;$ENV{'XDG_DESKTOP_DIR'}&quot;;
+				} else {
+					$fname=&quot;$ENV{'HOME'}/Desktop&quot;;
+				}
 				my $current_desktop = &quot;NONE&quot;;
 				if (($session =~ m/_stDGNOME_dp/) &amp;&amp; system(&quot;x2gofeature X2GO_GNOMEBINDINGS &gt;/dev/null&quot;) == 0)
 				{
diff --git a/x2goserver/bin/x2goruncommand b/x2goserver/bin/x2goruncommand
index 6e62709..d26fa82 100755
--- a/x2goserver/bin/x2goruncommand
+++ b/x2goserver/bin/x2goruncommand
@@ -54,7 +54,9 @@ IMEXIT=&quot;false&quot;
 
 NX_XINERAMA_LIBS=/usr/lib/nx/X11/Xinerama
 NX_LIBS=/usr/lib/nx/X11
-test -n &quot;$LD_LIBRARY_PATH&quot; &amp;&amp; LD_LIBRARY_PATH=$NX_XINERAMA_LIBS:$NX_LIBS:$LD_LIBRARY_PATH || LD_LIBRARY_PATH=&quot;$NX_XINERAMA_LIBS:$NX_LIBS&quot;
+test -n &quot;$LD_LIBRARY_PATH&quot; &amp;&amp; \
+  LD_LIBRARY_PATH=&quot;$NX_XINERAMA_LIBS:$NX_LIBS:$LD_LIBRARY_PATH&quot; || \
+  LD_LIBRARY_PATH=&quot;$NX_XINERAMA_LIBS:$NX_LIBS&quot;
 $X2GO_LIB_PATH/x2gosyslog &quot;$0&quot; &quot;debug&quot; &quot;exporting LD_LIBRARY_PATH=$LD_LIBRARY_PATH&quot;
 export LD_LIBRARY_PATH
 
@@ -179,11 +181,19 @@ if [ &quot;$cmd&quot; == &quot;TERMINAL&quot; ]; then
 fi
 
 EXEC=`which $cmd`
+EXEC_WRAPPER=&quot;&quot;
 
 BNAME=`basename &quot;$EXEC&quot;`
 if [ &quot;$BNAME&quot; == &quot;rdesktop&quot; ]
 then
 	IMEXIT=&quot;true&quot;
+	if which padsp &gt;/dev/null; then
+		EXEC_WRAPPER=&quot;padsp&quot;
+		args=&quot; -r sound:local&quot;
+	fi
+	if [ -d &quot;$HOME/media&quot; ]; then
+		args+=&quot; -r disk:X2GoMedia=$HOME/media&quot;
+	fi
 fi
 
 if [ &quot;$X2GO_SESS_TYPE&quot; == &quot;P&quot; ]
@@ -193,6 +203,14 @@ then
 	X2GO_SESS_TYPE=&quot;R&quot;
 fi
 
+if [ &quot;$cmd&quot; == &quot;startkde&quot; ]; then
+	NX_XRANDR_LIBS=/usr/lib/nx/X11/Xrandr
+	LD_LIBRARY_PATH=&quot;$NX_XRANDR_LIBS:$LD_LIBRARY_PATH&quot;
+	$X2GO_LIB_PATH/x2gosyslog &quot;$0&quot; &quot;debug&quot; &quot;extending LD_LIBRARY_PATH=$LD_LIBRARY_PATH by Xrandr extension&quot;
+	export LD_LIBRARY_PATH
+fi
+
+
 # run x2goserver-extensions for pre-runcommand
 x2gofeature X2GO_RUN_EXTENSIONS &amp;&gt;/dev/null &amp;&amp; x2goserver-run-extensions &quot;$X2GO_SESSION&quot; pre-runcommand || true
 
@@ -205,10 +223,10 @@ if [ &quot;$EXEC&quot; != &quot;&quot; ] &amp;&amp; [ -x $EXEC ]; then
 	x2gofeature X2GO_XSESSION &amp;&gt;/dev/null &amp;&amp; [ &quot;x$X2GO_SESS_TYPE&quot; = &quot;xD&quot; ] &amp;&amp; {
 		STARTUP=&quot;$cmd$args&quot;
 		$X2GO_LIB_PATH/x2gosyslog &quot;$0&quot; &quot;notice&quot; &quot;launching session with Xsession-x2go mechanism, using STARTUP=\&quot;$STARTUP\&quot;&quot;
-		STARTUP=&quot;$STARTUP&quot; /etc/x2go/Xsession
+		STARTUP=&quot;/usr/bin/env LD_LIBRARY_PATH=${LD_LIBRARY_PATH} ${STARTUP}&quot; /etc/x2go/Xsession
 	} || {
 		$X2GO_LIB_PATH/x2gosyslog &quot;$0&quot; &quot;debug&quot; &quot;executing command \&quot;$cmd$args\&quot;...&quot;
-		$cmd$args
+		$EXEC_WRAPPER $cmd$args
 	}
 
 	#### some applications can quit immediately, we will wait here as long as x2goagent exists
diff --git a/x2goserver/bin/x2gostartagent b/x2goserver/bin/x2gostartagent
index abf1422..c049566 100755
--- a/x2goserver/bin/x2gostartagent
+++ b/x2goserver/bin/x2gostartagent
@@ -247,8 +247,10 @@ else
 	X2GODPIOPTION_=&quot;-dpi $X2GODPI&quot;
 fi
 
+NOLISTOPT=&quot;&quot;
 if [ &quot;$X2GOXDMCP&quot; == &quot;&quot; ] ;then
 	XDMCPOPT=&quot;&quot;
+	NOLISTOPT=&quot;-nolisten tcp&quot;
 else
 	XDMCPOPT=&quot;-query $X2GOXDMCP&quot;
 fi
@@ -260,10 +262,10 @@ SESSION_WINDOW_TITLE=&quot;X2GO-${SESSION_NAME}&quot;
 
 if  [ &quot;$X2GO_STYPE&quot; == &quot;S&quot; ]; then
 	# set NX_TEMP to /tmp, make sure x2goagent starts when pam_tmpdir.so is in use
-	NX_TEMP=/tmp x2goagent -nolisten tcp $X2GODPIOPTION_ -$SESSION_TYPE -auth &quot;$XAUTHORITY&quot; -shadow $SHADOW_DESKTOP -shadowmode $SHADOW_MODE -geometry ${X2GO_GEOMETRY} -name &quot;${SESSION_WINDOW_TITLE}&quot;  &quot;${NX_AGENT}&quot; 2&gt;&quot;${SESSION_LOG}&quot; &amp;
+	NX_TEMP=/tmp x2goagent $NOLISTOPT $X2GODPIOPTION_ -$SESSION_TYPE -auth &quot;$XAUTHORITY&quot; -shadow $SHADOW_DESKTOP -shadowmode $SHADOW_MODE -geometry ${X2GO_GEOMETRY} -name &quot;${SESSION_WINDOW_TITLE}&quot;  &quot;${NX_AGENT}&quot; 2&gt;&quot;${SESSION_LOG}&quot; &amp;
 else
 	# set NX_TEMP to /tmp, make sure x2goagent starts when pam_tmpdir.so is in use
-	NX_TEMP=/tmp x2goagent -nolisten tcp $X2GODPIOPTION_ $XDMCPOPT -$SESSION_TYPE $NOEXITPARAM -auth &quot;$XAUTHORITY&quot; -geometry ${X2GO_GEOMETRY} -name &quot;${SESSION_WINDOW_TITLE}&quot;  &quot;${NX_AGENT}&quot; 2&gt;&quot;${SESSION_LOG}&quot; &amp;
+	NX_TEMP=/tmp x2goagent $NOLISTOPT $X2GODPIOPTION_ $XDMCPOPT -$SESSION_TYPE $NOEXITPARAM -auth &quot;$XAUTHORITY&quot; -geometry ${X2GO_GEOMETRY} -name &quot;${SESSION_WINDOW_TITLE}&quot;  &quot;${NX_AGENT}&quot; 2&gt;&quot;${SESSION_LOG}&quot; &amp;
 fi
 
 X2GO_AGENT_PID=$!
diff --git a/x2goserver/bin/x2goumount-session b/x2goserver/bin/x2goumount-session
index 22cfefb..df39e49 100755
--- a/x2goserver/bin/x2goumount-session
+++ b/x2goserver/bin/x2goumount-session
@@ -23,6 +23,7 @@
 use strict;
 use Sys::Hostname;
 use Sys::Syslog qw( :standard :macros );
+use File::BaseDir qw( xdg_config_home );
 
 use lib `echo -n \$(x2gobasepath)/lib/x2go`;
 use x2godbwrapper; 
@@ -34,6 +35,29 @@ setlogmask( LOG_UPTO(x2gologlevel()) );
 
 syslog('info', &quot;x2goumount-session has been called with options: @ARGV&quot;);
 
+# this function is a code duplication from x2gomountdirs and it will go away with
+# X2Go Server 3.2.0.0 (as the code has been moved into X2Go::Utils already in Vcs).
+sub source_environment {
+    my $name = shift;
+
+    open my $fh, &quot;&lt;&quot;, $name
+        or die &quot;could not open $name: $!&quot;;
+
+    while (&lt;$fh&gt;) {
+        chomp;
+        my $line = $_;
+        if ( $line =~ m/^#.*/ )
+        {
+            next;
+        }
+        my ($k, $v) = split /=/, $line, 2;
+        $v =~ s/^(['&quot;])(.*)\1/$2/; #' fix highlighter
+        $v =~ s/\$([a-zA-Z]\w*)/$ENV{$1}/g;
+        $v =~ s/`(.*?)`/`$1`/ge; #dangerous
+        $ENV{$k} = $v;
+    }
+}
+
 my $tmp_dir = '/tmp';
 
 my $session=shift;
@@ -45,6 +69,8 @@ my $mdir=&quot;$tmp_dir/.x2go-$ENV{'USER'}/media&quot;;
 my $spooldir=&quot;$tmp_dir/.x2go-$ENV{'USER'}/spool&quot;;
 my $mimeboxdir=&quot;$tmp_dir/.x2go-$ENV{'USER'}/mimebox&quot;;
 
+source_environment(xdg_config_home() . &quot;/user-dirs.dirs&quot;);
+
 if ($only_path)
 {
 	$only_path=~s/\/ramdrive\/mnt\///;
@@ -155,7 +181,14 @@ break:
 		$remote=~s/ /_/g;
 		$remote=~s/\\040/_/g;
 		$remote=(split(&quot;:&quot;,&quot;$remote&quot;))[1];
-		$remote=&quot;$ENV{'HOME'}/Desktop/$remote&quot;;
+		my $desktopdir;
+		if ( $ENV{'XDG_DESKTOP_DIR'} )
+		{
+			$desktopdir=&quot;$ENV{'XDG_DESKTOP_DIR'}&quot;;
+		} else {
+			$desktopdir=&quot;$ENV{'HOME'}/Desktop&quot;;
+		}
+		$remote=&quot;$desktopdir/$remote&quot;;
 
 		my $current_desktop = 'NONE';
 		if (($session =~ m/_stDGNOME_dp/) &amp;&amp; system(&quot;x2gofeature X2GO_GNOMEBINDINGS &gt;/dev/null&quot;) == 0)
diff --git a/x2goserver/lib/x2gogetagent b/x2goserver/lib/x2gogetagent
index 7462550..897d75e 100755
--- a/x2goserver/lib/x2gogetagent
+++ b/x2goserver/lib/x2gogetagent
@@ -31,8 +31,8 @@ openlog($0,'cons,pid','user');
 setlogmask( LOG_UPTO(x2gologlevel()) );
 
 my $sid=shift or die;
-my $agent = db_getagent $sid;
+my $agent = db_getagent($sid);
 print $agent;
 
 # closing syslog 
-closelog;
\ No newline at end of file
+closelog;
diff --git a/x2goserver/sbin/x2gocleansessions b/x2goserver/sbin/x2gocleansessions
index aaed31d..8d52d85 100755
--- a/x2goserver/sbin/x2gocleansessions
+++ b/x2goserver/sbin/x2gocleansessions
@@ -90,6 +90,7 @@ elsif ($pid == 0 )
 	for (glob &quot;/proc/$$/fd/*&quot;) { POSIX::close($1) if m{/(\d+)$}; }
 
 	$SIG{TERM}=\&amp;catch_term;
+	$SIG{CHLD} = sub { wait };
 
 	while(sleep 5)
 	{


hooks/post-receive
-- 
x2goserver.git (X2Go Server)

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;x2goserver.git&quot; (X2Go Server).

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003529.html">[X2go-Commits] nx-libs.git - backport-lenny (branch) updated:	redist-client/3.5.0.16-12-g6955064
</A></li>
	<LI>Next message: <A HREF="003531.html">[X2go-Commits] libpam-x2go.git - master (branch) updated:	edd14a06a92de3b1275f4aeb377d8fa3852f823e
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3530">[ date ]</a>
              <a href="thread.html#3530">[ thread ]</a>
              <a href="subject.html#3530">[ subject ]</a>
              <a href="author.html#3530">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/x2go-commits">More information about the X2go-commits
mailing list</a><br>
</body></html>
