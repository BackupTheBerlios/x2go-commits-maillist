<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [X2Go-Commits] nx-libs.git - build-main (branch) updated:	nxagent/3.5.0-5
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/x2go-commits/2013-August/index.html" >
   <LINK REL="made" HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2Go-Commits%5D%20nx-libs.git%20-%20build-main%20%28branch%29%20updated%3A%0A%09nxagent/3.5.0-5&In-Reply-To=%3C20130830142203.E3D9C5DB24%40ymir%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011339.html">
   <LINK REL="Next"  HREF="011344.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[X2Go-Commits] nx-libs.git - build-main (branch) updated:	nxagent/3.5.0-5</H1>
    <B>X2Go dev team</B> 
    <A HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2Go-Commits%5D%20nx-libs.git%20-%20build-main%20%28branch%29%20updated%3A%0A%09nxagent/3.5.0-5&In-Reply-To=%3C20130830142203.E3D9C5DB24%40ymir%3E"
       TITLE="[X2Go-Commits] nx-libs.git - build-main (branch) updated:	nxagent/3.5.0-5">git-admin at x2go.org
       </A><BR>
    <I>Fri Aug 30 16:22:03 CEST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="011339.html">[X2Go-Commits] nx-libs.git - build-main (branch) updated:	nxagent/3.4.0-8
</A></li>
        <LI>Next message: <A HREF="011344.html">[X2Go-Commits] nx-libs.git - build-main (branch) updated:	nxagent/3.5.0-2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11343">[ date ]</a>
              <a href="thread.html#11343">[ thread ]</a>
              <a href="subject.html#11343">[ subject ]</a>
              <a href="author.html#11343">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch, build-main has been updated
       via  e01b9177b41f7d27a934d41fa38d550fa0026b45 (commit)
      from  39b738a67a14dde67b2a811d56ac84934fcef52d (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
-----------------------------------------------------------------------

Summary of changes:
 nx-X11/programs/Xserver/hw/nxagent/Args.c          |    4 +
 nx-X11/programs/Xserver/hw/nxagent/Args.h          |    2 +
 nx-X11/programs/Xserver/hw/nxagent/CHANGELOG       |   19 +
 nx-X11/programs/Xserver/hw/nxagent/Cursor.c        |   26 +-
 nx-X11/programs/Xserver/hw/nxagent/Display.c       |    2 +
 nx-X11/programs/Xserver/hw/nxagent/Events.c        |    8 +-
 nx-X11/programs/Xserver/hw/nxagent/Extensions.c    |  142 ++-
 nx-X11/programs/Xserver/hw/nxagent/Imakefile       |    8 +-
 nx-X11/programs/Xserver/hw/nxagent/Init.c          |   20 +
 nx-X11/programs/Xserver/hw/nxagent/Init.h          |    2 +
 nx-X11/programs/Xserver/hw/nxagent/NXrandr.c       | 1229 ------------------
 .../Xserver/hw/nxagent/NXrandr.c.NX.original       | 1229 ------------------
 .../Xserver/hw/nxagent/NXrandr.c.XF86.original     | 1197 -----------------
 nx-X11/programs/Xserver/hw/nxagent/Reconnect.c     |    3 +-
 nx-X11/programs/Xserver/hw/nxagent/Screen.c        |  230 ++--
 nx-X11/programs/Xserver/hw/nxagent/Screen.h        |    2 +-
 nx-X11/programs/Xserver/hw/nxagent/Window.c        |    7 +-
 nx-X11/programs/Xserver/hw/nxagent/X/NXdixfonts.c  |    3 +-
 nx-X11/programs/Xserver/hw/nxagent/X/NXrandr.c     | 1344 --------------------
 .../Xserver/hw/nxagent/X/NXrandr.c.NX.original     | 1344 --------------------
 .../Xserver/hw/nxagent/X/NXrandr.c.X.original      | 1319 -------------------
 21 files changed, 342 insertions(+), 7798 deletions(-)
 delete mode 100644 nx-X11/programs/Xserver/hw/nxagent/NXrandr.c
 delete mode 100644 nx-X11/programs/Xserver/hw/nxagent/NXrandr.c.NX.original
 delete mode 100644 nx-X11/programs/Xserver/hw/nxagent/NXrandr.c.XF86.original
 delete mode 100644 nx-X11/programs/Xserver/hw/nxagent/X/NXrandr.c
 delete mode 100644 nx-X11/programs/Xserver/hw/nxagent/X/NXrandr.c.NX.original
 delete mode 100644 nx-X11/programs/Xserver/hw/nxagent/X/NXrandr.c.X.original

The diff of changes is:
diff --git a/nx-X11/programs/Xserver/hw/nxagent/Args.c b/nx-X11/programs/Xserver/hw/nxagent/Args.c
index 8fbb275..ecf0a21 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/Args.c
+++ b/nx-X11/programs/Xserver/hw/nxagent/Args.c
@@ -135,6 +135,8 @@ char *nxagentKeyboard = NULL;
 
 Bool nxagentOnce = True;
 
+int nxagentRemoteMajor = -1;
+
 static void nxagentParseOptionString(char*);
 
 /*
@@ -1578,6 +1580,8 @@ N/A
         nxagentAlphaCompat = 0;
       }
 
+      nxagentRemoteMajor = remoteMajor;
+
       if (nxagentPackMethod == -1)
       {
         nxagentPackMethod = packMethod;
diff --git a/nx-X11/programs/Xserver/hw/nxagent/Args.h b/nx-X11/programs/Xserver/hw/nxagent/Args.h
index 9cb97ca..8f4d05d 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/Args.h
+++ b/nx-X11/programs/Xserver/hw/nxagent/Args.h
@@ -81,4 +81,6 @@ void nxagentSetCoalescence(void);
 
 extern int nxagentUserDefinedFontPath;
 
+extern int nxagentRemoteMajor;
+
 #endif /* __Args_H__ */
diff --git a/nx-X11/programs/Xserver/hw/nxagent/CHANGELOG b/nx-X11/programs/Xserver/hw/nxagent/CHANGELOG
index 5f4b561..0f20b79 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/CHANGELOG
+++ b/nx-X11/programs/Xserver/hw/nxagent/CHANGELOG
@@ -1,5 +1,24 @@
 ChangeLog:
 
+nxagent-3.5.0-5
+
+- The NX agent failed to resize its own window to fit the desktop size
+  in shadow sessions. TR07I02561 is now fixed also in shadow mode.
+
+nxagent-3.5.0-4
+
+- Fixed TR07I02530. Solved a buffer overflow occurring when the '-fp'
+  option value exceeds 1024 characters.
+
+- Extended list of the available screen geometries.
+
+nxagent-3.5.0-3
+
+- Fixed TR08I02572. Upgraded RandR extension to version 1.2.
+
+- Fixed TR07I02561. The NX agent failed to resize its own window to
+  fit the desktop size.
+
 nxagent-3.5.0-2
 
 - Fixed TR0502449. Initialized font server path even if font server
diff --git a/nx-X11/programs/Xserver/hw/nxagent/Cursor.c b/nx-X11/programs/Xserver/hw/nxagent/Cursor.c
index 9ed7c23..e27415b 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/Cursor.c
+++ b/nx-X11/programs/Xserver/hw/nxagent/Cursor.c
@@ -293,31 +293,7 @@ void nxagentRecolorCursor(ScreenPtr pScreen, CursorPtr pCursor,
 Bool nxagentSetCursorPosition(ScreenPtr pScreen, int x, int y,
                                   Bool generateEvent)
 {
-  /*
-   * Don't warp the cursor if the requesting client
-   * is the server client itself or a shadow agent.
-   */
-
-  if (requestingClient != NULL &amp;&amp;
-          requestingClient != serverClient &amp;&amp;
-              nxagentClientHint(requestingClient) != NXAGENT_SHADOW)
-  {
-    int i;
-
-    #ifdef TEST
-    fprintf(stderr, &quot;nxagentSetCursorPosition: Moving the cursor at position [%d,%d].\n&quot;,
-                x, y);
-    #endif
-
-    for (i = 0; i &lt; nxagentNumScreens; i++)
-    {
-      XWarpPointer(nxagentDisplay, nxagentDefaultWindows[i],
-                   nxagentDefaultWindows[pScreen-&gt;myNum],
-                   0, 0, 0, 0, x, y);
-    }
-  }
-
-  return True;
+  return 1;
 }
 
 void nxagentReconnectCursor(pointer p0, XID x1, pointer p2)
diff --git a/nx-X11/programs/Xserver/hw/nxagent/Display.c b/nx-X11/programs/Xserver/hw/nxagent/Display.c
index 87be981..db70434 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/Display.c
+++ b/nx-X11/programs/Xserver/hw/nxagent/Display.c
@@ -2406,6 +2406,8 @@ Bool nxagentReconnectDisplay(void *p0)
   nxagentPackQuality    = -1;
   nxagentSplitThreshold = -1;
 
+  nxagentRemoteMajor = -1;
+
   nxagentInstallSignalHandlers();
 
   nxagentInstallDisplayHandlers();
diff --git a/nx-X11/programs/Xserver/hw/nxagent/Events.c b/nx-X11/programs/Xserver/hw/nxagent/Events.c
index b9da934..ce84c1b 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/Events.c
+++ b/nx-X11/programs/Xserver/hw/nxagent/Events.c
@@ -591,8 +591,8 @@ void nxagentSwitchResizeMode(ScreenPtr pScreen)
 
     nxagentLaunchDialog(DIALOG_ENABLE_DESKTOP_RESIZE_MODE);
 
-    nxagentRRSetScreenConfig(pScreen, nxagentOption(Width),
-                                 nxagentOption(Height));
+    nxagentChangeScreenConfig(0, nxagentOption(Width), nxagentOption(Height),
+                                  0, 0);
 
     if (nxagentOption(ClientOs) == ClientOsWinnt)
     {
@@ -3461,8 +3461,8 @@ int nxagentHandleConfigureNotify(XEvent* X)
                       nxagentOption(Width), nxagentOption(Height));
           #endif
 
-          nxagentRRSetScreenConfig(screenInfo.screens[DefaultScreen(nxagentDisplay)],
-                                     nxagentOption(Width), nxagentOption(Height));
+          nxagentChangeScreenConfig(0, nxagentOption(Width),
+                                        nxagentOption(Height), 0, 0);
         }
       }
 
diff --git a/nx-X11/programs/Xserver/hw/nxagent/Extensions.c b/nx-X11/programs/Xserver/hw/nxagent/Extensions.c
index aced24f..6dce644 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/Extensions.c
+++ b/nx-X11/programs/Xserver/hw/nxagent/Extensions.c
@@ -22,11 +22,19 @@
 #include &quot;Agent.h&quot;
 #include &quot;Display.h&quot;
 #include &quot;Screen.h&quot;
+#include &quot;Options.h&quot;
 #include &quot;Extensions.h&quot;
+#include &quot;Windows.h&quot;
 
 void GlxExtensionInit(void);
 void GlxWrapInitVisuals(void *procPtr);
 
+static int nxagentRandRScreenSetSize(ScreenPtr pScreen, CARD16 width,
+                                         CARD16 height, CARD32 mmWidth,
+                                             CARD32 mmHeight);
+
+static int nxagentRandRInitSizes(ScreenPtr pScreen);
+
 #ifdef __DARWIN__
 
 void DarwinHandleGUI(int argc, char *argv[])
@@ -75,6 +83,8 @@ void nxagentInitRandRExtension(ScreenPtr pScreen)
     fprintf(stderr, &quot;Warning: Failed to initialize the RandR extension.\n&quot;);
   }
 
+  nxagentRandRInitSizes(pScreen);
+
   /*
    * RRScreenInit sets these pointers to NULL,
    * so requiring the server to set up its own
@@ -84,12 +94,31 @@ void nxagentInitRandRExtension(ScreenPtr pScreen)
   pRandRScrPriv = rrGetScrPriv(pScreen);
 
   pRandRScrPriv -&gt; rrGetInfo   = nxagentRandRGetInfo;
+
+  #if RANDR_12_INTERFACE
+  pRandRScrPriv -&gt; rrScreenSetSize = nxagentRandRScreenSetSize;
+  #endif
+
+  #if RANDR_10_INTERFACE
   pRandRScrPriv -&gt; rrSetConfig = nxagentRandRSetConfig;
+  #endif
 }
 
 int nxagentRandRGetInfo(ScreenPtr pScreen, Rotation *pRotations)
 {
+  /*
+   * Rotation is not supported.
+   */
+
+  *pRotations = RR_Rotate_0;
+
+  return 1;
+}
+
+static int nxagentRandRInitSizes(ScreenPtr pScreen)
+{
   RRScreenSizePtr pSize;
+  rrScrPrivPtr pRandRScrPriv = rrGetScrPriv(pScreen);
 
   int width;
   int height;
@@ -97,8 +126,16 @@ int nxagentRandRGetInfo(ScreenPtr pScreen, Rotation *pRotations)
   int maxWidth;
   int maxHeight;
 
-  int w[] = {0, 160, 320, 640, 800, 1024, 0, 0};
-  int h[] = {0, 120, 240, 480, 600,  768, 0, 0};
+/*
+  int w[] = {0, 160, 320, 640, 800, 1024, 1152, 1280, 1280, 1280, 1280, 1280,
+                 1280, 1360, 1440, 1600, 1600, 1680, 1920, 1920, 0, 0};
+  int h[] = {0, 120, 240, 480, 600,  768,  864,  600,  720,  800,  854,  960,
+                 1024,  768,  900,  900, 1200, 1050, 1080, 1200, 0, 0};
+*/
+  int w[] = {0, 320, 640, 640, 800, 800, 1024, 1024, 1152, 1280, 1280, 1280, 1360,
+                 1440, 1600, 1600, 1680, 1920, 1920, 0, 0};
+  int h[] = {0, 240, 360, 480, 480, 600,  600,  768,  864,  720,  800, 1024,  768,
+                  900,  900, 1200, 1050, 1080, 1200, 0, 0};
 
   int i;
   int nSizes;
@@ -107,12 +144,6 @@ int nxagentRandRGetInfo(ScreenPtr pScreen, Rotation *pRotations)
   int mmHeight;
 
   /*
-   * Rotation is not supported.
-   */
-
-  *pRotations = RR_Rotate_0;
-
-  /*
    * Register all the supported sizes. The third
    * parameter is the refresh rate.
    */
@@ -185,13 +216,106 @@ int nxagentRandRGetInfo(ScreenPtr pScreen, Rotation *pRotations)
   return 1;
 }
 
+#if RANDR_10_INTERFACE
+
 int nxagentRandRSetConfig(ScreenPtr pScreen, Rotation rotation,
                               int rate, RRScreenSizePtr pSize)
 {
+  int r;
+  rrScrPrivPtr pRandRScrPriv;
+
+  UpdateCurrentTime();
+
   /*
    * Whatever size is OK for us.
    */
 
-  return nxagentResizeScreen(pScreen, pSize -&gt; width, pSize -&gt; height,
+  r = nxagentResizeScreen(pScreen, pSize -&gt; width, pSize -&gt; height,
                                  pSize -&gt; mmWidth, pSize -&gt; mmHeight);
+
+  nxagentMoveViewport(pScreen, 0, 0);
+
+  return r;
 }
+
+#endif
+
+#if RANDR_12_INTERFACE
+
+void nxagentRandRSetWindowsSize(int width, int height)
+{
+  if (width == 0)
+  {
+    if (nxagentOption(Fullscreen) == 1)
+    {
+      width = WidthOfScreen(DefaultScreenOfDisplay(nxagentDisplay));
+    }
+    else
+    {
+      width = nxagentOption(Width);
+    }
+  }
+
+  if (height == 0)
+  {
+    if (nxagentOption(Fullscreen) == 1)
+    {
+      height = HeightOfScreen(DefaultScreenOfDisplay(nxagentDisplay));
+    }
+    else
+    {
+      height = nxagentOption(Height);
+    }
+  }
+
+  XResizeWindow(nxagentDisplay, nxagentDefaultWindows[0], width, height);
+
+  if (nxagentOption(Rootless) == 0)
+  {
+    XMoveResizeWindow(nxagentDisplay, nxagentInputWindows[0], 0, 0, width,
+                          height);
+  }
+}
+
+int nxagentRandRScreenSetSize(ScreenPtr pScreen, CARD16 width, CARD16 height,
+                                   CARD32 mmWidth, CARD32 mmHeight)
+{
+  int result;
+  rrScrPrivPtr pRandRScrPriv;
+
+  UpdateCurrentTime();
+
+  if (nxagentOption(DesktopResize) == 1 &amp;&amp;
+          (nxagentOption(Fullscreen) == 1 ||
+               width &gt; WidthOfScreen(DefaultScreenOfDisplay(nxagentDisplay)) ||
+                   height &gt; HeightOfScreen(DefaultScreenOfDisplay(nxagentDisplay))))
+  {
+    if (nxagentOption(ClientOs) != ClientOsWinnt
+            /*&amp;&amp; nxagentOption(ClientOs) != ClientNXPlayer*/)
+    {
+      nxagentChangeOption(DesktopResize, 0);
+    }
+  }
+
+  if (nxagentOption(DesktopResize) == 1 &amp;&amp; nxagentOption(Fullscreen) == 0 &amp;&amp;
+          nxagentOption(AllScreens) == 0)
+  {
+    nxagentChangeOption(Width, width);
+    nxagentChangeOption(Height, height);
+  }
+
+  result = nxagentResizeScreen(pScreen, width, height, mmWidth, mmHeight);
+
+  if (result == 1 &amp;&amp; nxagentOption(DesktopResize) == 1 &amp;&amp;
+          nxagentOption(Fullscreen) == 0 &amp;&amp; nxagentOption(AllScreens) == 0)
+  {
+    nxagentRandRSetWindowsSize(width, height);
+    nxagentSetWMNormalHints(pScreen -&gt; myNum);
+  }
+
+  nxagentMoveViewport(pScreen, 0, 0);
+
+  return result;
+}
+
+#endif
diff --git a/nx-X11/programs/Xserver/hw/nxagent/Imakefile b/nx-X11/programs/Xserver/hw/nxagent/Imakefile
index 51173e4..9657958 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/Imakefile
+++ b/nx-X11/programs/Xserver/hw/nxagent/Imakefile
@@ -7,8 +7,7 @@ SRCS1 = os2Stub.c
 OBJS1 = os2Stub.o
 #endif
 
-SRCS =  NXrandr.c \
-        NXwindow.c \
+SRCS =  NXwindow.c \
 	NXevents.c \
 	NXproperty.c \
 	NXdixfonts.c \
@@ -70,8 +69,7 @@ SRCS =  NXrandr.c \
 	miinitext.c \
 	$(SRCS1)
 
-OBJS =  NXrandr.o \
-        NXwindow.o \
+OBJS =  NXwindow.o \
 	NXevents.o \
 	NXproperty.o \
 	NXdixfonts.o \
@@ -206,6 +204,8 @@ DEFINES = -g $(OS_DEFINES) $(EXT_DEFINES) $(UPG_DEFINES) \
           -DNXAGENT_SPLASH \
           -DNXAGENT_ARTSD \
           -UNX_DEBUG_INPUT \
+	  -DRANDR_10_INTERFACE \
+	  -DRANDR_12_INTERFACE \
           -UPANORAMIX \
           -UDEBUG_TREE
 
diff --git a/nx-X11/programs/Xserver/hw/nxagent/Init.c b/nx-X11/programs/Xserver/hw/nxagent/Init.c
index 4f675a6..f4fc3c7 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/Init.c
+++ b/nx-X11/programs/Xserver/hw/nxagent/Init.c
@@ -128,6 +128,10 @@ void OsVendorEndRedirectErrorFFunction();
  * new X server tree.
  */
 
+
+static void nxagentGrabServerCallback(CallbackListPtr *callbacks, pointer data,
+                                   pointer args);
+
 #ifdef NXAGENT_UPGRADE
 
 void ddxInitGlobals(void)
@@ -209,6 +213,11 @@ void InitOutput(ScreenInfo *screenInfo, int argc, char *argv[])
 
   NXUnsetLibraryPath(1);
 
+  if (serverGeneration == 1)
+  {
+    AddCallback(&amp;ServerGrabCallback, nxagentGrabServerCallback, NULL);
+  }
+
   if (nxagentUserDefinedFontPath == 0)
   {
     #ifdef TEST
@@ -479,6 +488,17 @@ void OsVendorEndRedirectErrorFFunction()
 int SelectWaitTime = 10000; /* usec */
 #endif
 
+ServerGrabInfoRec nxagentGrabServerInfo;
+
+static void nxagentGrabServerCallback(CallbackListPtr *callbacks, pointer data,
+                                   pointer args)
+{
+    ServerGrabInfoRec *grab = (ServerGrabInfoRec*)args;
+
+    nxagentGrabServerInfo.client = grab-&gt;client;
+    nxagentGrabServerInfo.grabstate = grab-&gt;grabstate;
+}
+
 #ifdef DPMSExtension
 
 void DPMSSet(int level)
diff --git a/nx-X11/programs/Xserver/hw/nxagent/Init.h b/nx-X11/programs/Xserver/hw/nxagent/Init.h
index cf154e8..2dc0f5c 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/Init.h
+++ b/nx-X11/programs/Xserver/hw/nxagent/Init.h
@@ -37,4 +37,6 @@ extern int nxagentDoFullGeneration;
 extern int nxagentBackingStore;
 extern int nxagentSaveUnder;
 
+extern ServerGrabInfoRec nxagentGrabServerInfo;
+
 #endif /* __Init_H__ */
diff --git a/nx-X11/programs/Xserver/hw/nxagent/NXrandr.c b/nx-X11/programs/Xserver/hw/nxagent/NXrandr.c
deleted file mode 100644
index d593fa6..0000000
--- a/nx-X11/programs/Xserver/hw/nxagent/NXrandr.c
+++ /dev/null
@@ -1,1229 +0,0 @@
-#ifdef NXAGENT_UPGRADE
-
-#include &quot;X/NXrandr.c&quot;
-
-#else
-
-/**************************************************************************/
-/*                                                                        */
-/* Copyright (c) 2001, 2011 NoMachine, <A HREF="http://www.nomachine.com/.">http://www.nomachine.com/.</A>         */
-/*                                                                        */
-/* NXAGENT, NX protocol compression and NX extensions to this software    */
-/* are copyright of NoMachine. Redistribution and use of the present      */
-/* software is allowed according to terms specified in the file LICENSE   */
-/* which comes in the source distribution.                                */
-/*                                                                        */
-/* Check <A HREF="http://www.nomachine.com/licensing.html">http://www.nomachine.com/licensing.html</A> for applicability.       */
-/*                                                                        */
-/* NX and NoMachine are trademarks of Medialogic S.p.A.                   */
-/*                                                                        */
-/* All rights reserved.                                                   */
-/*                                                                        */
-/**************************************************************************/
-
-/*
- * $XFree86: xc/programs/Xserver/randr/randr.c,v 1.19 2003/02/08 03:52:30 dawes Exp $
- *
- * Copyright &#169; 2000, Compaq Computer Corporation, 
- * Copyright &#169; 2002, Hewlett Packard, Inc.
- *
- * Permission to use, copy, modify, distribute, and sell this software and its
- * documentation for any purpose is hereby granted without fee, provided that
- * the above copyright notice appear in all copies and that both that
- * copyright notice and this permission notice appear in supporting
- * documentation, and that the name of Compaq or HP not be used in advertising
- * or publicity pertaining to distribution of the software without specific,
- * written prior permission.  HP makes no representations about the
- * suitability of this software for any purpose.  It is provided &quot;as is&quot;
- * without express or implied warranty.
- *
- * HP DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL HP
- * BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
- * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
- * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN 
- * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
- *
- * Author:  Jim Gettys, HP Labs, Hewlett-Packard, Inc.
- */
-
-
-#define NEED_REPLIES
-#define NEED_EVENTS
-#include &quot;X.h&quot;
-#include &quot;Xproto.h&quot;
-#include &quot;misc.h&quot;
-#include &quot;os.h&quot;
-#include &quot;dixstruct.h&quot;
-#include &quot;resource.h&quot;
-#include &quot;scrnintstr.h&quot;
-#include &quot;windowstr.h&quot;
-#include &quot;pixmapstr.h&quot;
-#include &quot;extnsionst.h&quot;
-#include &quot;servermd.h&quot;
-#include &quot;randr.h&quot;
-#include &quot;randrproto.h&quot;
-#include &quot;../../randr/randrstr.h&quot;
-#include &quot;render.h&quot; 	/* we share subpixel order information */
-#include &quot;picturestr.h&quot;
-#include &quot;Xfuncproto.h&quot;
-#ifdef EXTMODULE
-#include &quot;xf86_ansic.h&quot;
-#endif
-
-#define RR_VALIDATE
-int	RRGeneration;
-int	RRNScreens;
-
-static int ProcRRQueryVersion (ClientPtr pClient);
-static int ProcRRDispatch (ClientPtr pClient);
-static int SProcRRDispatch (ClientPtr pClient);
-static int SProcRRQueryVersion (ClientPtr pClient);
-
-#define wrap(priv,real,mem,func) {\
-    priv-&gt;mem = real-&gt;mem; \
-    real-&gt;mem = func; \
-}
-
-#define unwrap(priv,real,mem) {\
-    real-&gt;mem = priv-&gt;mem; \
-}
-
-static CARD8	RRReqCode;
-static int	RRErrBase;
-static int	RREventBase;
-static RESTYPE ClientType, EventType; /* resource types for event masks */
-static int	RRClientPrivateIndex;
-
-typedef struct _RRTimes {
-    TimeStamp	setTime;
-    TimeStamp	configTime;
-} RRTimesRec, *RRTimesPtr;
-
-typedef struct _RRClient {
-    int		major_version;
-    int		minor_version;
-/*  RRTimesRec	times[0]; */
-} RRClientRec, *RRClientPtr;
-
-/*
- * each window has a list of clients requesting
- * RRNotify events.  Each client has a resource
- * for each window it selects RRNotify input for,
- * this resource is used to delete the RRNotifyRec
- * entry from the per-window queue.
- */
-
-typedef struct _RREvent *RREventPtr;
-
-typedef struct _RREvent {
-    RREventPtr  next;
-    ClientPtr	client;
-    WindowPtr	window;
-    XID		clientResource;
-    int		mask;
-} RREventRec;
-
-int	rrPrivIndex = -1;
-
-#define GetRRClient(pClient)    ((RRClientPtr) (pClient)-&gt;devPrivates[RRClientPrivateIndex].ptr)
-#define rrClientPriv(pClient)	RRClientPtr pRRClient = GetRRClient(pClient)
-
-static Bool
-RRClientKnowsRates (ClientPtr	pClient)
-{
-    rrClientPriv(pClient);
-
-    return (pRRClient-&gt;major_version &gt; 1 ||
-	    (pRRClient-&gt;major_version == 1 &amp;&amp; pRRClient-&gt;minor_version &gt;= 1));
-}
-
-static void
-RRClientCallback (CallbackListPtr	*list,
-		  pointer		closure,
-		  pointer		data)
-{
-    NewClientInfoRec	*clientinfo = (NewClientInfoRec *) data;
-    ClientPtr		pClient = clientinfo-&gt;client;
-    rrClientPriv(pClient);
-    RRTimesPtr		pTimes = (RRTimesPtr) (pRRClient + 1);
-    int			i;
-
-    pRRClient-&gt;major_version = 0;
-    pRRClient-&gt;minor_version = 0;
-    for (i = 0; i &lt; screenInfo.numScreens; i++)
-    {
-	ScreenPtr   pScreen = screenInfo.screens[i];
-	rrScrPriv(pScreen);
-
-	if (pScrPriv)
-	{
-	    pTimes[i].setTime = pScrPriv-&gt;lastSetTime;
-	    pTimes[i].configTime = pScrPriv-&gt;lastConfigTime;
-	}
-    }
-}
-
-static void
-RRResetProc (ExtensionEntry *extEntry)
-{
-}
-    
-static Bool
-RRCloseScreen (int i, ScreenPtr pScreen)
-{
-    rrScrPriv(pScreen);
-
-    unwrap (pScrPriv, pScreen, CloseScreen);
-    if (pScrPriv-&gt;pSizes)
-	xfree (pScrPriv-&gt;pSizes);
-    xfree (pScrPriv);
-    RRNScreens -= 1;	/* ok, one fewer screen with RandR running */
-    return (*pScreen-&gt;CloseScreen) (i, pScreen);    
-}
-
-static void
-SRRScreenChangeNotifyEvent(xRRScreenChangeNotifyEvent *from,
-			   xRRScreenChangeNotifyEvent *to)
-{
-    to-&gt;type = from-&gt;type;
-    to-&gt;rotation = from-&gt;rotation;
-    cpswaps(from-&gt;sequenceNumber, to-&gt;sequenceNumber);
-    cpswapl(from-&gt;timestamp, to-&gt;timestamp);
-    cpswapl(from-&gt;configTimestamp, to-&gt;configTimestamp);
-    cpswapl(from-&gt;root, to-&gt;root);
-    cpswapl(from-&gt;window, to-&gt;window);
-    cpswaps(from-&gt;sizeID, to-&gt;sizeID);
-    cpswaps(from-&gt;widthInPixels, to-&gt;widthInPixels);
-    cpswaps(from-&gt;heightInPixels, to-&gt;heightInPixels);
-    cpswaps(from-&gt;widthInMillimeters, to-&gt;widthInMillimeters);
-    cpswaps(from-&gt;heightInMillimeters, to-&gt;heightInMillimeters);
-    cpswaps(from-&gt;subpixelOrder, to-&gt;subpixelOrder);
-}
-
-Bool RRScreenInit(ScreenPtr pScreen)
-{
-    rrScrPrivPtr   pScrPriv;
-
-    if (RRGeneration != serverGeneration)
-    {
-	if ((rrPrivIndex = AllocateScreenPrivateIndex()) &lt; 0)
-	    return FALSE;
-	RRGeneration = serverGeneration;
-    }
-
-    pScrPriv = (rrScrPrivPtr) xalloc (sizeof (rrScrPrivRec));
-    if (!pScrPriv)
-	return FALSE;
-
-    SetRRScreen(pScreen, pScrPriv);
-
-    /*
-     * Calling function best set these function vectors
-     */
-    pScrPriv-&gt;rrSetConfig = 0;
-    pScrPriv-&gt;rrGetInfo = 0;
-    /*
-     * This value doesn't really matter -- any client must call
-     * GetScreenInfo before reading it which will automatically update
-     * the time
-     */
-    pScrPriv-&gt;lastSetTime = currentTime;
-    pScrPriv-&gt;lastConfigTime = currentTime;
-    
-    wrap (pScrPriv, pScreen, CloseScreen, RRCloseScreen);
-
-    pScrPriv-&gt;rotations = RR_Rotate_0;
-    
-    pScrPriv-&gt;nSizes = 0;
-    pScrPriv-&gt;nSizesInUse = 0;
-    pScrPriv-&gt;pSizes = 0;
-    
-    pScrPriv-&gt;rotation = RR_Rotate_0;
-    pScrPriv-&gt;size = -1;
-    
-    RRNScreens += 1;	/* keep count of screens that implement randr */
-    return TRUE;
-}
-
-/*ARGSUSED*/
-static int
-RRFreeClient (pointer data, XID id)
-{
-    RREventPtr   pRREvent;
-    WindowPtr	    pWin;
-    RREventPtr   *pHead, pCur, pPrev;
-
-    pRREvent = (RREventPtr) data;
-    pWin = pRREvent-&gt;window;
-    pHead = (RREventPtr *) LookupIDByType(pWin-&gt;drawable.id, EventType);
-    if (pHead) {
-	pPrev = 0;
-	for (pCur = *pHead; pCur &amp;&amp; pCur != pRREvent; pCur=pCur-&gt;next)
-	    pPrev = pCur;
-	if (pCur)
-	{
-	    if (pPrev)
-	    	pPrev-&gt;next = pRREvent-&gt;next;
-	    else
-	    	*pHead = pRREvent-&gt;next;
-	}
-    }
-    xfree ((pointer) pRREvent);
-    return 1;
-}
-
-/*ARGSUSED*/
-static int
-RRFreeEvents (pointer data, XID id)
-{
-    RREventPtr   *pHead, pCur, pNext;
-
-    pHead = (RREventPtr *) data;
-    for (pCur = *pHead; pCur; pCur = pNext) {
-	pNext = pCur-&gt;next;
-	FreeResource (pCur-&gt;clientResource, ClientType);
-	xfree ((pointer) pCur);
-    }
-    xfree ((pointer) pHead);
-    return 1;
-}
-
-void
-RRExtensionInit (void)
-{
-    ExtensionEntry *extEntry;
-
-    if (RRNScreens == 0) return;
-
-    RRClientPrivateIndex = AllocateClientPrivateIndex ();
-    if (!AllocateClientPrivate (RRClientPrivateIndex,
-				sizeof (RRClientRec) +
-				screenInfo.numScreens * sizeof (RRTimesRec)))
-	return;
-    if (!AddCallback (&amp;ClientStateCallback, RRClientCallback, 0))
-	return;
-
-    ClientType = CreateNewResourceType(RRFreeClient);
-    if (!ClientType)
-	return;
-    EventType = CreateNewResourceType(RRFreeEvents);
-    if (!EventType)
-	return;
-    extEntry = AddExtension (RANDR_NAME, RRNumberEvents, RRNumberErrors,
-			     ProcRRDispatch, SProcRRDispatch,
-			     RRResetProc, StandardMinorOpcode);
-    if (!extEntry)
-	return;
-    RRReqCode = (CARD8) extEntry-&gt;base;
-    RRErrBase = extEntry-&gt;errorBase;
-    RREventBase = extEntry-&gt;eventBase;
-    EventSwapVector[RREventBase + RRScreenChangeNotify] = (EventSwapPtr) 
-      SRRScreenChangeNotifyEvent;
-
-    return;
-}
-		
-int
-TellChanged (WindowPtr pWin, pointer value)
-{
-    RREventPtr			*pHead, pRREvent;
-    ClientPtr			client;
-    xRRScreenChangeNotifyEvent	se;
-    ScreenPtr			pScreen = pWin-&gt;drawable.pScreen;
-    rrScrPriv(pScreen);
-    RRScreenSizePtr		pSize;
-    WindowPtr			pRoot = WindowTable[pScreen-&gt;myNum];
-
-    pHead = (RREventPtr *) LookupIDByType (pWin-&gt;drawable.id, EventType);
-    if (!pHead)
-	return WT_WALKCHILDREN;
-
-    se.type = RRScreenChangeNotify + RREventBase;
-    se.rotation = (CARD8) pScrPriv-&gt;rotation;
-    se.timestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-    se.configTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-    se.root =  pRoot-&gt;drawable.id;
-    se.window = pWin-&gt;drawable.id;
-    se.subpixelOrder = PictureGetSubpixelOrder (pScreen);
-    if (pScrPriv-&gt;size &gt;= 0)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[pScrPriv-&gt;size];
-	se.sizeID = pSize-&gt;id;
-	se.widthInPixels = pSize-&gt;width;
-	se.heightInPixels = pSize-&gt;height;
-	se.widthInMillimeters = pSize-&gt;mmWidth;
-	se.heightInMillimeters = pSize-&gt;mmHeight;
-    }
-    else
-    {
-	/*
-	 * This &quot;shouldn't happen&quot;, but a broken DDX can
-	 * forget to set the current configuration on GetInfo
-	 */
-	se.sizeID = 0xffff;
-	se.widthInPixels = 0;
-	se.heightInPixels = 0;
-	se.widthInMillimeters = 0;
-	se.heightInMillimeters = 0;
-    }    
-    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next) 
-    {
-	client = pRREvent-&gt;client;
-	if (client == serverClient || client-&gt;clientGone)
-	    continue;
-	se.sequenceNumber = client-&gt;sequence;
-	if(pRREvent-&gt;mask &amp; RRScreenChangeNotifyMask)
-	  WriteEventsToClient (client, 1, (xEvent *) &amp;se);
-    }
-    return WT_WALKCHILDREN;
-}
-
-Bool
-RRGetInfo (ScreenPtr pScreen)
-{
-    rrScrPriv (pScreen);
-    int		    i, j, k, l;
-    Bool	    changed;
-    Rotation	    rotations;
-    RRScreenSizePtr pSize;
-    RRScreenRatePtr pRate;
-
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	pSize-&gt;oldReferenced = pSize-&gt;referenced;
-	pSize-&gt;referenced = FALSE;
-	for (k = 0; k &lt; pSize-&gt;nRates; k++)
-	{
-	    pRate = &amp;pSize-&gt;pRates[k];
-	    pRate-&gt;oldReferenced = pRate-&gt;referenced;
-	    pRate-&gt;referenced = FALSE;
-	}
-    }
-    if (!(*pScrPriv-&gt;rrGetInfo) (pScreen, &amp;rotations))
-	return FALSE;
-
-    changed = FALSE;
-
-    /*
-     * Check whether anything changed and simultaneously generate
-     * the protocol id values for the objects
-     */
-    if (rotations != pScrPriv-&gt;rotations)
-    {
-	pScrPriv-&gt;rotations = rotations;
-	changed = TRUE;
-    }
-
-    j = 0;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	if (pSize-&gt;oldReferenced != pSize-&gt;referenced)
-	    changed = TRUE;
-	if (pSize-&gt;referenced)
-	    pSize-&gt;id = j++;
-	l = 0;
-	for (k = 0; k &lt; pSize-&gt;nRates; k++)
-	{
-	    pRate = &amp;pSize-&gt;pRates[k];
-	    if (pRate-&gt;oldReferenced != pRate-&gt;referenced)
-		changed = TRUE;
-	    if (pRate-&gt;referenced)
-		l++;
-	}
-	pSize-&gt;nRatesInUse = l;
-    }
-    pScrPriv-&gt;nSizesInUse = j;
-    if (changed)
-    {
-	UpdateCurrentTime ();
-	pScrPriv-&gt;lastConfigTime = currentTime;
-	WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    }
-    return TRUE;
-}
-
-void
-RRSendConfigNotify (ScreenPtr pScreen)
-{
-    WindowPtr	pWin = WindowTable[pScreen-&gt;myNum];
-    xEvent	event;
-
-    event.u.u.type = ConfigureNotify;
-    event.u.configureNotify.window = pWin-&gt;drawable.id;
-    event.u.configureNotify.aboveSibling = None;
-    event.u.configureNotify.x = 0;
-    event.u.configureNotify.y = 0;
-
-    /* XXX xinerama stuff ? */
-    
-    event.u.configureNotify.width = pWin-&gt;drawable.width;
-    event.u.configureNotify.height = pWin-&gt;drawable.height;
-    event.u.configureNotify.borderWidth = wBorderWidth (pWin);
-    event.u.configureNotify.override = pWin-&gt;overrideRedirect;
-    DeliverEvents(pWin, &amp;event, 1, NullWindow);
-}
-
-static int
-ProcRRQueryVersion (ClientPtr client)
-{
-    xRRQueryVersionReply rep;
-    register int n;
-    REQUEST(xRRQueryVersionReq);
-    rrClientPriv(client);
-
-    REQUEST_SIZE_MATCH(xRRQueryVersionReq);
-    pRRClient-&gt;major_version = stuff-&gt;majorVersion;
-    pRRClient-&gt;minor_version = stuff-&gt;minorVersion;
-    rep.type = X_Reply;
-    rep.length = 0;
-    rep.sequenceNumber = client-&gt;sequence;
-    rep.majorVersion = RANDR_MAJOR;
-    rep.minorVersion = RANDR_MINOR;
-    if (client-&gt;swapped) {
-    	swaps(&amp;rep.sequenceNumber, n);
-    	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.majorVersion, n);
-	swapl(&amp;rep.minorVersion, n);
-    }
-    WriteToClient(client, sizeof(xRRQueryVersionReply), (char *)&amp;rep);
-    return (client-&gt;noClientException);
-}
-
-
-extern char	*ConnectionInfo;
-
-static int padlength[4] = {0, 3, 2, 1};
-
-void
-RREditConnectionInfo (ScreenPtr pScreen)
-{
-    xConnSetup	    *connSetup;
-    char	    *vendor;
-    xPixmapFormat   *formats;
-    xWindowRoot	    *root;
-    xDepth	    *depth;
-    xVisualType	    *visual;
-    int		    screen = 0;
-    int		    d;
-
-    connSetup = (xConnSetup *) ConnectionInfo;
-    vendor = (char *) connSetup + sizeof (xConnSetup);
-    formats = (xPixmapFormat *) ((char *) vendor +
-				 connSetup-&gt;nbytesVendor +
-				 padlength[connSetup-&gt;nbytesVendor &amp; 3]);
-    root = (xWindowRoot *) ((char *) formats +
-			    sizeof (xPixmapFormat) * screenInfo.numPixmapFormats);
-    while (screen != pScreen-&gt;myNum)
-    {
-	depth = (xDepth *) ((char *) root + 
-			    sizeof (xWindowRoot));
-	for (d = 0; d &lt; root-&gt;nDepths; d++)
-	{
-	    visual = (xVisualType *) ((char *) depth +
-				      sizeof (xDepth));
-	    depth = (xDepth *) ((char *) visual +
-				depth-&gt;nVisuals * sizeof (xVisualType));
-	}
-	root = (xWindowRoot *) ((char *) depth);
-	screen++;
-    }
-    root-&gt;pixWidth = pScreen-&gt;width;
-    root-&gt;pixHeight = pScreen-&gt;height;
-    root-&gt;mmWidth = pScreen-&gt;mmWidth;
-    root-&gt;mmHeight = pScreen-&gt;mmHeight;
-}
-
-static int
-ProcRRGetScreenInfo (ClientPtr client)
-{
-    REQUEST(xRRGetScreenInfoReq);
-    xRRGetScreenInfoReply   rep;
-    WindowPtr	    	    pWin;
-    int			    n;
-    ScreenPtr		    pScreen;
-    rrScrPrivPtr	    pScrPriv;
-    CARD8		    *extra;
-    int			    extraLen;
-
-    REQUEST_SIZE_MATCH(xRRGetScreenInfoReq);
-    pWin = (WindowPtr)SecurityLookupWindow(stuff-&gt;window, client,
-					   SecurityReadAccess);
-
-    if (!pWin)
-	return BadWindow;
-
-    pScreen = pWin-&gt;drawable.pScreen;
-    pScrPriv = rrGetScrPriv(pScreen);
-    rep.pad = 0;
-    if (!pScrPriv)
-    {
-	rep.type = X_Reply;
-	rep.setOfRotations = RR_Rotate_0;;
-	rep.sequenceNumber = client-&gt;sequence;
-	rep.length = 0;
-	rep.root = WindowTable[pWin-&gt;drawable.pScreen-&gt;myNum]-&gt;drawable.id;
-	rep.timestamp = currentTime.milliseconds;
-	rep.configTimestamp = currentTime.milliseconds;
-	rep.nSizes = 0;
-	rep.sizeID = 0;
-	rep.rotation = RR_Rotate_0;
-	rep.rate = 0;
-	rep.nrateEnts = 0;
-	extra = 0;
-	extraLen = 0;
-    }
-    else
-    {
-	int			i, j;
-	xScreenSizes		*size;
-	CARD16			*rates;
-	CARD8			*data8;
-	Bool			has_rate = RRClientKnowsRates (client);
-    
-	RRGetInfo (pScreen);
-
-	rep.type = X_Reply;
-	rep.setOfRotations = pScrPriv-&gt;rotations;
-	rep.sequenceNumber = client-&gt;sequence;
-	rep.length = 0;
-	rep.root = WindowTable[pWin-&gt;drawable.pScreen-&gt;myNum]-&gt;drawable.id;
-	rep.timestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-	rep.configTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-	rep.rotation = pScrPriv-&gt;rotation;
-	rep.nSizes = pScrPriv-&gt;nSizesInUse;
-	rep.rate = pScrPriv-&gt;rate;
-        rep.nrateEnts = 0;
-	if (has_rate)
-	{
-	    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	    {
-		RRScreenSizePtr pSize = &amp;pScrPriv-&gt;pSizes[i];
-		if (pSize-&gt;referenced)
-		{
-		    rep.nrateEnts += (1 + pSize-&gt;nRatesInUse);
-		}
-	    }
-	}
-
-	if (pScrPriv-&gt;size &gt;= 0)
-	    rep.sizeID = pScrPriv-&gt;pSizes[pScrPriv-&gt;size].id;
-	else
-	    return BadImplementation;
-
-	extraLen = (rep.nSizes * sizeof (xScreenSizes) +
-		    rep.nrateEnts * sizeof (CARD16));
-
-	extra = (CARD8 *) xalloc (extraLen);
-	if (!extra)
-	    return BadAlloc;
-	/*
-	 * First comes the size information
-	 */
-	size = (xScreenSizes *) extra;
-	rates = (CARD16 *) (size + rep.nSizes);
-	for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	{
-	    RRScreenSizePtr pSize = &amp;pScrPriv-&gt;pSizes[i];
-	    if (pSize-&gt;referenced)
-	    {
-		size-&gt;widthInPixels = pSize-&gt;width;
-		size-&gt;heightInPixels = pSize-&gt;height;
-		size-&gt;widthInMillimeters = pSize-&gt;mmWidth;
-		size-&gt;heightInMillimeters = pSize-&gt;mmHeight;
-		if (client-&gt;swapped)
-		{
-		    swaps (&amp;size-&gt;widthInPixels, n);
-		    swaps (&amp;size-&gt;heightInPixels, n);
-		    swaps (&amp;size-&gt;widthInMillimeters, n);
-		    swaps (&amp;size-&gt;heightInMillimeters, n);
-		}
-		size++;
-		if (has_rate)
-		{
-		    *rates = pSize-&gt;nRatesInUse;
-		    if (client-&gt;swapped)
-		    {
-			swaps (rates, n);
-		    }
-		    rates++;
-		    for (j = 0; j &lt; pSize-&gt;nRates; j++)
-		    {
-			RRScreenRatePtr	pRate = &amp;pSize-&gt;pRates[j];
-			if (pRate-&gt;referenced)
-			{
-			    *rates = pRate-&gt;rate;
-			    if (client-&gt;swapped)
-			    {
-				swaps (rates, n);
-			    }
-			    rates++;
-			}
-		    }
-		}
-	    }
-	}
-	data8 = (CARD8 *) rates;
-
-	if (data8 - (CARD8 *) extra != extraLen)
-	    FatalError (&quot;RRGetScreenInfo bad extra len %d != %d\n&quot;,
-			data8 - (CARD8 *) extra, extraLen);
-	rep.length =  (extraLen + 3) &gt;&gt; 2;
-    }
-    if (client-&gt;swapped) {
-	swaps(&amp;rep.sequenceNumber, n);
-	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.timestamp, n);
-	swaps(&amp;rep.rotation, n);
-	swaps(&amp;rep.nSizes, n);
-	swaps(&amp;rep.sizeID, n);
-	swaps(&amp;rep.rate, n);
-	swaps(&amp;rep.nrateEnts, n);
-    }
-    WriteToClient(client, sizeof(xRRGetScreenInfoReply), (char *)&amp;rep);
-    if (extraLen)
-    {
-	WriteToClient (client, extraLen, (char *) extra);
-	xfree (extra);
-    }
-    return (client-&gt;noClientException);
-}
-
-static int
-ProcRRSetScreenConfig (ClientPtr client)
-{
-    REQUEST(xRRSetScreenConfigReq);
-    xRRSetScreenConfigReply rep;
-    DrawablePtr		    pDraw;
-    int			    n;
-    ScreenPtr		    pScreen;
-    rrScrPrivPtr	    pScrPriv;
-    TimeStamp		    configTime;
-    TimeStamp		    time;
-    RRScreenSizePtr	    pSize;
-    int			    i;
-    Rotation		    rotation;
-    int			    rate;
-    short		    oldWidth, oldHeight;
-    Bool		    has_rate;
-
-    UpdateCurrentTime ();
-
-    if (RRClientKnowsRates (client))
-    {
-	REQUEST_SIZE_MATCH (xRRSetScreenConfigReq);
-	has_rate = TRUE;
-    }
-    else
-    {
-	REQUEST_SIZE_MATCH (xRR1_0SetScreenConfigReq);
-	has_rate = FALSE;
-    }
-    
-    SECURITY_VERIFY_DRAWABLE(pDraw, stuff-&gt;drawable, client,
-			     SecurityWriteAccess);
-
-    pScreen = pDraw-&gt;pScreen;
-
-    pScrPriv= rrGetScrPriv(pScreen);
-    
-    time = ClientTimeToServerTime(stuff-&gt;timestamp);
-    configTime = ClientTimeToServerTime(stuff-&gt;configTimestamp);
-    
-    oldWidth = pScreen-&gt;width;
-    oldHeight = pScreen-&gt;height;
-    
-    if (!pScrPriv)
-    {
-	time = currentTime;
-	rep.status = RRSetConfigFailed;
-	goto sendReply;
-    }
-    if (!RRGetInfo (pScreen))
-	return BadAlloc;
-    
-    /*
-     * if the client's config timestamp is not the same as the last config
-     * timestamp, then the config information isn't up-to-date and
-     * can't even be validated
-     */
-    if (CompareTimeStamps (configTime, pScrPriv-&gt;lastConfigTime) != 0)
-    {
-	rep.status = RRSetConfigInvalidConfigTime;
-	goto sendReply;
-    }
-    
-    /*
-     * Search for the requested size
-     */
-    pSize = 0;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	if (pSize-&gt;referenced &amp;&amp; pSize-&gt;id == stuff-&gt;sizeID)
-	{
-	    break;
-	}
-    }
-    if (i == pScrPriv-&gt;nSizes)
-    {
-	/*
-	 * Invalid size ID
-	 */
-	client-&gt;errorValue = stuff-&gt;sizeID;
-	return BadValue;
-    }
-    
-    /*
-     * Validate requested rotation
-     */
-    rotation = (Rotation) stuff-&gt;rotation;
-
-    /* test the rotation bits only! */
-    switch (rotation &amp; 0xf) {
-    case RR_Rotate_0:
-    case RR_Rotate_90:
-    case RR_Rotate_180:
-    case RR_Rotate_270:
-	break;
-    default:
-	/*
-	 * Invalid rotation
-	 */
-	client-&gt;errorValue = stuff-&gt;rotation;
-	return BadValue;
-    }
-
-    if ((~pScrPriv-&gt;rotations) &amp; rotation)
-    {
-	/*
-	 * requested rotation or reflection not supported by screen
-	 */
-	client-&gt;errorValue = stuff-&gt;rotation;
-	return BadMatch;
-    }
-
-    /*
-     * Validate requested refresh
-     */
-    if (has_rate)
-	rate = (int) stuff-&gt;rate;
-    else
-	rate = 0;
-
-    if (rate)
-    {
-	for (i = 0; i &lt; pSize-&gt;nRates; i++)
-	{
-	    RRScreenRatePtr pRate = &amp;pSize-&gt;pRates[i];
-	    if (pRate-&gt;referenced &amp;&amp; pRate-&gt;rate == rate)
-		break;
-	}
-	if (i == pSize-&gt;nRates)
-	{
-	    /*
-	     * Invalid rate
-	     */
-	    client-&gt;errorValue = rate;
-	    return BadValue;
-	}
-    }
-    
-    /*
-     * Make sure the requested set-time is not older than
-     * the last set-time
-     */
-    if (CompareTimeStamps (time, pScrPriv-&gt;lastSetTime) &lt; 0)
-    {
-	rep.status = RRSetConfigInvalidTime;
-	goto sendReply;
-    }
-
-    /*
-     * call out to ddx routine to effect the change
-     */
-    if (!(*pScrPriv-&gt;rrSetConfig) (pScreen, rotation, rate,
-				   pSize))
-    {
-	/*
-	 * unknown DDX failure, report to client
-	 */
-	rep.status = RRSetConfigFailed;
-	goto sendReply;
-    }
-    
-    /*
-     * set current extension configuration pointers
-     */
-    RRSetCurrentConfig (pScreen, rotation, rate, pSize);
-    
-    /*
-     * Deliver ScreenChangeNotify events whenever
-     * the configuration is updated
-     */
-    WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    
-    /*
-     * Deliver ConfigureNotify events when root changes
-     * pixel size
-     */
-    if (oldWidth != pScreen-&gt;width || oldHeight != pScreen-&gt;height)
-	RRSendConfigNotify (pScreen);
-    RREditConnectionInfo (pScreen);
-    
-    /*
-     * Fix pointer bounds and location
-     */
-    ScreenRestructured (pScreen);
-    pScrPriv-&gt;lastSetTime = time;
-    
-    /*
-     * Report Success
-     */
-    rep.status = RRSetConfigSuccess;
-    
-sendReply:
-    
-    rep.type = X_Reply;
-    /* rep.status has already been filled in */
-    rep.length = 0;
-    rep.sequenceNumber = client-&gt;sequence;
-
-    rep.newTimestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-    rep.newConfigTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-    rep.root = WindowTable[pDraw-&gt;pScreen-&gt;myNum]-&gt;drawable.id;
-
-    if (client-&gt;swapped) 
-    {
-    	swaps(&amp;rep.sequenceNumber, n);
-    	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.newTimestamp, n);
-	swapl(&amp;rep.newConfigTimestamp, n);
-	swapl(&amp;rep.root, n);
-    }
-    WriteToClient(client, sizeof(xRRSetScreenConfigReply), (char *)&amp;rep);
-
-    return (client-&gt;noClientException);
-}
-
-static int
-ProcRRSelectInput (ClientPtr client)
-{
-    REQUEST(xRRSelectInputReq);
-    rrClientPriv(client);
-    RRTimesPtr	pTimes;
-    WindowPtr	pWin;
-    RREventPtr	pRREvent, pNewRREvent, *pHead;
-    XID		clientResource;
-
-    REQUEST_SIZE_MATCH(xRRSelectInputReq);
-    pWin = SecurityLookupWindow (stuff-&gt;window, client, SecurityWriteAccess);
-    if (!pWin)
-	return BadWindow;
-    pHead = (RREventPtr *)SecurityLookupIDByType(client,
-						 pWin-&gt;drawable.id, EventType,
-						 SecurityWriteAccess);
-
-    if (stuff-&gt;enable &amp; (RRScreenChangeNotifyMask)) 
-    {
-	ScreenPtr	pScreen = pWin-&gt;drawable.pScreen;
-	rrScrPriv	(pScreen);
-
-	if (pHead) 
-	{
-	    /* check for existing entry. */
-	    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next)
-		if (pRREvent-&gt;client == client)
-		    return Success;
-	}
-
-	/* build the entry */
-	pNewRREvent = (RREventPtr) xalloc (sizeof (RREventRec));
-	if (!pNewRREvent)
-	    return BadAlloc;
-	pNewRREvent-&gt;next = 0;
-	pNewRREvent-&gt;client = client;
-	pNewRREvent-&gt;window = pWin;
-	pNewRREvent-&gt;mask = stuff-&gt;enable;
-	/*
-	 * add a resource that will be deleted when
-	 * the client goes away
-	 */
-	clientResource = FakeClientID (client-&gt;index);
-	pNewRREvent-&gt;clientResource = clientResource;
-	if (!AddResource (clientResource, ClientType, (pointer)pNewRREvent))
-	    return BadAlloc;
-	/*
-	 * create a resource to contain a pointer to the list
-	 * of clients selecting input.  This must be indirect as
-	 * the list may be arbitrarily rearranged which cannot be
-	 * done through the resource database.
-	 */
-	if (!pHead)
-	{
-	    pHead = (RREventPtr *) xalloc (sizeof (RREventPtr));
-	    if (!pHead ||
-		!AddResource (pWin-&gt;drawable.id, EventType, (pointer)pHead))
-	    {
-		FreeResource (clientResource, RT_NONE);
-		return BadAlloc;
-	    }
-	    *pHead = 0;
-	}
-	pNewRREvent-&gt;next = *pHead;
-	*pHead = pNewRREvent;
-	/*
-	 * Now see if the client needs an event
-	 */
-	if (pScrPriv)
-	{
-	    pTimes = &amp;((RRTimesPtr) (pRRClient + 1))[pScreen-&gt;myNum];
-	    if (CompareTimeStamps (pTimes-&gt;setTime, 
-				   pScrPriv-&gt;lastSetTime) != 0 ||
-		CompareTimeStamps (pTimes-&gt;configTime, 
-				   pScrPriv-&gt;lastConfigTime) != 0)
-	    {
-		TellChanged (pWin, (pointer) pScreen);
-	    }
-	}
-    }
-    else if (stuff-&gt;enable == xFalse) 
-    {
-	/* delete the interest */
-	if (pHead) {
-	    pNewRREvent = 0;
-	    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next) {
-		if (pRREvent-&gt;client == client)
-		    break;
-		pNewRREvent = pRREvent;
-	    }
-	    if (pRREvent) {
-		FreeResource (pRREvent-&gt;clientResource, ClientType);
-		if (pNewRREvent)
-		    pNewRREvent-&gt;next = pRREvent-&gt;next;
-		else
-		    *pHead = pRREvent-&gt;next;
-		xfree (pRREvent);
-	    }
-	}
-    }
-    else 
-    {
-	client-&gt;errorValue = stuff-&gt;enable;
-	return BadValue;
-    }
-    return Success;
-}
-
-
-static int
-ProcRRDispatch (ClientPtr client)
-{
-    REQUEST(xReq);
-    switch (stuff-&gt;data)
-    {
-    case X_RRQueryVersion:
-	return ProcRRQueryVersion(client);
-    case X_RRSetScreenConfig:
-        return ProcRRSetScreenConfig(client);
-    case X_RRSelectInput:
-        return ProcRRSelectInput(client);
-    case X_RRGetScreenInfo:
-        return ProcRRGetScreenInfo(client);
-    default:
-	return BadRequest;
-    }
-}
-
-static int
-SProcRRQueryVersion (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRQueryVersionReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;majorVersion, n);
-    swapl(&amp;stuff-&gt;minorVersion, n);
-    return ProcRRQueryVersion(client);
-}
-
-static int
-SProcRRGetScreenInfo (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRGetScreenInfoReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;window, n);
-    return ProcRRGetScreenInfo(client);
-}
-
-static int
-SProcRRSetScreenConfig (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRSetScreenConfigReq);
-
-    if (RRClientKnowsRates (client))
-    {
-	REQUEST_SIZE_MATCH (xRRSetScreenConfigReq);
-	swaps (&amp;stuff-&gt;rate, n);
-    }
-    else
-    {
-	REQUEST_SIZE_MATCH (xRR1_0SetScreenConfigReq);
-    }
-    
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;drawable, n);
-    swapl(&amp;stuff-&gt;timestamp, n);
-    swaps(&amp;stuff-&gt;sizeID, n);
-    swaps(&amp;stuff-&gt;rotation, n);
-    return ProcRRSetScreenConfig(client);
-}
-
-static int
-SProcRRSelectInput (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRSelectInputReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;window, n);
-    return ProcRRSelectInput(client);
-}
-
-
-static int
-SProcRRDispatch (ClientPtr client)
-{
-    REQUEST(xReq);
-    switch (stuff-&gt;data)
-    {
-    case X_RRQueryVersion:
-	return SProcRRQueryVersion(client);
-    case X_RRSetScreenConfig:
-        return SProcRRSetScreenConfig(client);
-    case X_RRSelectInput:
-        return SProcRRSelectInput(client);
-    case X_RRGetScreenInfo:
-        return SProcRRGetScreenInfo(client);
-    default:
-	return BadRequest;
-    }
-}
-
-
-static Bool
-RRScreenSizeMatches (RRScreenSizePtr  a,
-		   RRScreenSizePtr  b)
-{
-    if (a-&gt;width != b-&gt;width)
-	return FALSE;
-    if (a-&gt;height != b-&gt;height)
-	return FALSE;
-    if (a-&gt;mmWidth != b-&gt;mmWidth)
-	return FALSE;
-    if (a-&gt;mmHeight != b-&gt;mmHeight)
-	return FALSE;
-    return TRUE;
-}
-
-RRScreenSizePtr
-RRRegisterSize (ScreenPtr	    pScreen,
-		short		    width, 
-		short		    height,
-		short		    mmWidth,
-		short		    mmHeight)
-{
-    rrScrPriv (pScreen);
-    int		    i;
-    RRScreenSize    tmp;
-    RRScreenSizePtr pNew;
-
-    if (!pScrPriv)
-	return 0;
-
-    /*
-     * FIXME: The compiler reports that field
-     * id is used uninitialized here.
-     */
-
-    tmp.id = 0;
-    
-    tmp.width = width;
-    tmp.height= height;
-    tmp.mmWidth = mmWidth;
-    tmp.mmHeight = mmHeight;
-    tmp.pRates = 0;
-    tmp.nRates = 0;
-    tmp.nRatesInUse = 0;
-    tmp.referenced = TRUE;
-    tmp.oldReferenced = FALSE;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	if (RRScreenSizeMatches (&amp;tmp, &amp;pScrPriv-&gt;pSizes[i]))
-	{
-	    pScrPriv-&gt;pSizes[i].referenced = TRUE;
-	    return &amp;pScrPriv-&gt;pSizes[i];
-	}
-    pNew = xrealloc (pScrPriv-&gt;pSizes,
-		     (pScrPriv-&gt;nSizes + 1) * sizeof (RRScreenSize));
-    if (!pNew)
-	return 0;
-    pNew[pScrPriv-&gt;nSizes++] = tmp;
-    pScrPriv-&gt;pSizes = pNew;
-    return &amp;pNew[pScrPriv-&gt;nSizes-1];
-}
-
-Bool RRRegisterRate (ScreenPtr		pScreen,
-		     RRScreenSizePtr	pSize,
-		     int		rate)
-{
-    rrScrPriv(pScreen);
-    int		    i;
-    RRScreenRatePtr pNew, pRate;
-
-    if (!pScrPriv)
-	return FALSE;
-    
-    for (i = 0; i &lt; pSize-&gt;nRates; i++)
-    {
-	pRate = &amp;pSize-&gt;pRates[i];
-	if (pRate-&gt;rate == rate)
-	{
-	    pRate-&gt;referenced = TRUE;
-	    return TRUE;
-	}
-    }
-
-    pNew = xrealloc (pSize-&gt;pRates,
-		     (pSize-&gt;nRates + 1) * sizeof (RRScreenRate));
-    if (!pNew)
-	return FALSE;
-    pRate = &amp;pNew[pSize-&gt;nRates++];
-    pRate-&gt;rate = rate;
-    pRate-&gt;referenced = TRUE;
-    pRate-&gt;oldReferenced = FALSE;
-    pSize-&gt;pRates = pNew;
-    return TRUE;
-}
-
-void
-RRSetCurrentConfig (ScreenPtr		pScreen,
-		    Rotation		rotation,
-		    int			rate,
-		    RRScreenSizePtr	pSize)
-{
-    rrScrPriv (pScreen);
-
-    if (!pScrPriv)
-	return;
-
-    pScrPriv-&gt;rotation = rotation;
-    pScrPriv-&gt;size = pSize - pScrPriv-&gt;pSizes;
-    pScrPriv-&gt;rate = rate;
-}
-
-#endif /* #ifdef NXAGENT_UPGRADE */
diff --git a/nx-X11/programs/Xserver/hw/nxagent/NXrandr.c.NX.original b/nx-X11/programs/Xserver/hw/nxagent/NXrandr.c.NX.original
deleted file mode 100644
index d593fa6..0000000
--- a/nx-X11/programs/Xserver/hw/nxagent/NXrandr.c.NX.original
+++ /dev/null
@@ -1,1229 +0,0 @@
-#ifdef NXAGENT_UPGRADE
-
-#include &quot;X/NXrandr.c&quot;
-
-#else
-
-/**************************************************************************/
-/*                                                                        */
-/* Copyright (c) 2001, 2011 NoMachine, <A HREF="http://www.nomachine.com/.">http://www.nomachine.com/.</A>         */
-/*                                                                        */
-/* NXAGENT, NX protocol compression and NX extensions to this software    */
-/* are copyright of NoMachine. Redistribution and use of the present      */
-/* software is allowed according to terms specified in the file LICENSE   */
-/* which comes in the source distribution.                                */
-/*                                                                        */
-/* Check <A HREF="http://www.nomachine.com/licensing.html">http://www.nomachine.com/licensing.html</A> for applicability.       */
-/*                                                                        */
-/* NX and NoMachine are trademarks of Medialogic S.p.A.                   */
-/*                                                                        */
-/* All rights reserved.                                                   */
-/*                                                                        */
-/**************************************************************************/
-
-/*
- * $XFree86: xc/programs/Xserver/randr/randr.c,v 1.19 2003/02/08 03:52:30 dawes Exp $
- *
- * Copyright &#169; 2000, Compaq Computer Corporation, 
- * Copyright &#169; 2002, Hewlett Packard, Inc.
- *
- * Permission to use, copy, modify, distribute, and sell this software and its
- * documentation for any purpose is hereby granted without fee, provided that
- * the above copyright notice appear in all copies and that both that
- * copyright notice and this permission notice appear in supporting
- * documentation, and that the name of Compaq or HP not be used in advertising
- * or publicity pertaining to distribution of the software without specific,
- * written prior permission.  HP makes no representations about the
- * suitability of this software for any purpose.  It is provided &quot;as is&quot;
- * without express or implied warranty.
- *
- * HP DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL HP
- * BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
- * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
- * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN 
- * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
- *
- * Author:  Jim Gettys, HP Labs, Hewlett-Packard, Inc.
- */
-
-
-#define NEED_REPLIES
-#define NEED_EVENTS
-#include &quot;X.h&quot;
-#include &quot;Xproto.h&quot;
-#include &quot;misc.h&quot;
-#include &quot;os.h&quot;
-#include &quot;dixstruct.h&quot;
-#include &quot;resource.h&quot;
-#include &quot;scrnintstr.h&quot;
-#include &quot;windowstr.h&quot;
-#include &quot;pixmapstr.h&quot;
-#include &quot;extnsionst.h&quot;
-#include &quot;servermd.h&quot;
-#include &quot;randr.h&quot;
-#include &quot;randrproto.h&quot;
-#include &quot;../../randr/randrstr.h&quot;
-#include &quot;render.h&quot; 	/* we share subpixel order information */
-#include &quot;picturestr.h&quot;
-#include &quot;Xfuncproto.h&quot;
-#ifdef EXTMODULE
-#include &quot;xf86_ansic.h&quot;
-#endif
-
-#define RR_VALIDATE
-int	RRGeneration;
-int	RRNScreens;
-
-static int ProcRRQueryVersion (ClientPtr pClient);
-static int ProcRRDispatch (ClientPtr pClient);
-static int SProcRRDispatch (ClientPtr pClient);
-static int SProcRRQueryVersion (ClientPtr pClient);
-
-#define wrap(priv,real,mem,func) {\
-    priv-&gt;mem = real-&gt;mem; \
-    real-&gt;mem = func; \
-}
-
-#define unwrap(priv,real,mem) {\
-    real-&gt;mem = priv-&gt;mem; \
-}
-
-static CARD8	RRReqCode;
-static int	RRErrBase;
-static int	RREventBase;
-static RESTYPE ClientType, EventType; /* resource types for event masks */
-static int	RRClientPrivateIndex;
-
-typedef struct _RRTimes {
-    TimeStamp	setTime;
-    TimeStamp	configTime;
-} RRTimesRec, *RRTimesPtr;
-
-typedef struct _RRClient {
-    int		major_version;
-    int		minor_version;
-/*  RRTimesRec	times[0]; */
-} RRClientRec, *RRClientPtr;
-
-/*
- * each window has a list of clients requesting
- * RRNotify events.  Each client has a resource
- * for each window it selects RRNotify input for,
- * this resource is used to delete the RRNotifyRec
- * entry from the per-window queue.
- */
-
-typedef struct _RREvent *RREventPtr;
-
-typedef struct _RREvent {
-    RREventPtr  next;
-    ClientPtr	client;
-    WindowPtr	window;
-    XID		clientResource;
-    int		mask;
-} RREventRec;
-
-int	rrPrivIndex = -1;
-
-#define GetRRClient(pClient)    ((RRClientPtr) (pClient)-&gt;devPrivates[RRClientPrivateIndex].ptr)
-#define rrClientPriv(pClient)	RRClientPtr pRRClient = GetRRClient(pClient)
-
-static Bool
-RRClientKnowsRates (ClientPtr	pClient)
-{
-    rrClientPriv(pClient);
-
-    return (pRRClient-&gt;major_version &gt; 1 ||
-	    (pRRClient-&gt;major_version == 1 &amp;&amp; pRRClient-&gt;minor_version &gt;= 1));
-}
-
-static void
-RRClientCallback (CallbackListPtr	*list,
-		  pointer		closure,
-		  pointer		data)
-{
-    NewClientInfoRec	*clientinfo = (NewClientInfoRec *) data;
-    ClientPtr		pClient = clientinfo-&gt;client;
-    rrClientPriv(pClient);
-    RRTimesPtr		pTimes = (RRTimesPtr) (pRRClient + 1);
-    int			i;
-
-    pRRClient-&gt;major_version = 0;
-    pRRClient-&gt;minor_version = 0;
-    for (i = 0; i &lt; screenInfo.numScreens; i++)
-    {
-	ScreenPtr   pScreen = screenInfo.screens[i];
-	rrScrPriv(pScreen);
-
-	if (pScrPriv)
-	{
-	    pTimes[i].setTime = pScrPriv-&gt;lastSetTime;
-	    pTimes[i].configTime = pScrPriv-&gt;lastConfigTime;
-	}
-    }
-}
-
-static void
-RRResetProc (ExtensionEntry *extEntry)
-{
-}
-    
-static Bool
-RRCloseScreen (int i, ScreenPtr pScreen)
-{
-    rrScrPriv(pScreen);
-
-    unwrap (pScrPriv, pScreen, CloseScreen);
-    if (pScrPriv-&gt;pSizes)
-	xfree (pScrPriv-&gt;pSizes);
-    xfree (pScrPriv);
-    RRNScreens -= 1;	/* ok, one fewer screen with RandR running */
-    return (*pScreen-&gt;CloseScreen) (i, pScreen);    
-}
-
-static void
-SRRScreenChangeNotifyEvent(xRRScreenChangeNotifyEvent *from,
-			   xRRScreenChangeNotifyEvent *to)
-{
-    to-&gt;type = from-&gt;type;
-    to-&gt;rotation = from-&gt;rotation;
-    cpswaps(from-&gt;sequenceNumber, to-&gt;sequenceNumber);
-    cpswapl(from-&gt;timestamp, to-&gt;timestamp);
-    cpswapl(from-&gt;configTimestamp, to-&gt;configTimestamp);
-    cpswapl(from-&gt;root, to-&gt;root);
-    cpswapl(from-&gt;window, to-&gt;window);
-    cpswaps(from-&gt;sizeID, to-&gt;sizeID);
-    cpswaps(from-&gt;widthInPixels, to-&gt;widthInPixels);
-    cpswaps(from-&gt;heightInPixels, to-&gt;heightInPixels);
-    cpswaps(from-&gt;widthInMillimeters, to-&gt;widthInMillimeters);
-    cpswaps(from-&gt;heightInMillimeters, to-&gt;heightInMillimeters);
-    cpswaps(from-&gt;subpixelOrder, to-&gt;subpixelOrder);
-}
-
-Bool RRScreenInit(ScreenPtr pScreen)
-{
-    rrScrPrivPtr   pScrPriv;
-
-    if (RRGeneration != serverGeneration)
-    {
-	if ((rrPrivIndex = AllocateScreenPrivateIndex()) &lt; 0)
-	    return FALSE;
-	RRGeneration = serverGeneration;
-    }
-
-    pScrPriv = (rrScrPrivPtr) xalloc (sizeof (rrScrPrivRec));
-    if (!pScrPriv)
-	return FALSE;
-
-    SetRRScreen(pScreen, pScrPriv);
-
-    /*
-     * Calling function best set these function vectors
-     */
-    pScrPriv-&gt;rrSetConfig = 0;
-    pScrPriv-&gt;rrGetInfo = 0;
-    /*
-     * This value doesn't really matter -- any client must call
-     * GetScreenInfo before reading it which will automatically update
-     * the time
-     */
-    pScrPriv-&gt;lastSetTime = currentTime;
-    pScrPriv-&gt;lastConfigTime = currentTime;
-    
-    wrap (pScrPriv, pScreen, CloseScreen, RRCloseScreen);
-
-    pScrPriv-&gt;rotations = RR_Rotate_0;
-    
-    pScrPriv-&gt;nSizes = 0;
-    pScrPriv-&gt;nSizesInUse = 0;
-    pScrPriv-&gt;pSizes = 0;
-    
-    pScrPriv-&gt;rotation = RR_Rotate_0;
-    pScrPriv-&gt;size = -1;
-    
-    RRNScreens += 1;	/* keep count of screens that implement randr */
-    return TRUE;
-}
-
-/*ARGSUSED*/
-static int
-RRFreeClient (pointer data, XID id)
-{
-    RREventPtr   pRREvent;
-    WindowPtr	    pWin;
-    RREventPtr   *pHead, pCur, pPrev;
-
-    pRREvent = (RREventPtr) data;
-    pWin = pRREvent-&gt;window;
-    pHead = (RREventPtr *) LookupIDByType(pWin-&gt;drawable.id, EventType);
-    if (pHead) {
-	pPrev = 0;
-	for (pCur = *pHead; pCur &amp;&amp; pCur != pRREvent; pCur=pCur-&gt;next)
-	    pPrev = pCur;
-	if (pCur)
-	{
-	    if (pPrev)
-	    	pPrev-&gt;next = pRREvent-&gt;next;
-	    else
-	    	*pHead = pRREvent-&gt;next;
-	}
-    }
-    xfree ((pointer) pRREvent);
-    return 1;
-}
-
-/*ARGSUSED*/
-static int
-RRFreeEvents (pointer data, XID id)
-{
-    RREventPtr   *pHead, pCur, pNext;
-
-    pHead = (RREventPtr *) data;
-    for (pCur = *pHead; pCur; pCur = pNext) {
-	pNext = pCur-&gt;next;
-	FreeResource (pCur-&gt;clientResource, ClientType);
-	xfree ((pointer) pCur);
-    }
-    xfree ((pointer) pHead);
-    return 1;
-}
-
-void
-RRExtensionInit (void)
-{
-    ExtensionEntry *extEntry;
-
-    if (RRNScreens == 0) return;
-
-    RRClientPrivateIndex = AllocateClientPrivateIndex ();
-    if (!AllocateClientPrivate (RRClientPrivateIndex,
-				sizeof (RRClientRec) +
-				screenInfo.numScreens * sizeof (RRTimesRec)))
-	return;
-    if (!AddCallback (&amp;ClientStateCallback, RRClientCallback, 0))
-	return;
-
-    ClientType = CreateNewResourceType(RRFreeClient);
-    if (!ClientType)
-	return;
-    EventType = CreateNewResourceType(RRFreeEvents);
-    if (!EventType)
-	return;
-    extEntry = AddExtension (RANDR_NAME, RRNumberEvents, RRNumberErrors,
-			     ProcRRDispatch, SProcRRDispatch,
-			     RRResetProc, StandardMinorOpcode);
-    if (!extEntry)
-	return;
-    RRReqCode = (CARD8) extEntry-&gt;base;
-    RRErrBase = extEntry-&gt;errorBase;
-    RREventBase = extEntry-&gt;eventBase;
-    EventSwapVector[RREventBase + RRScreenChangeNotify] = (EventSwapPtr) 
-      SRRScreenChangeNotifyEvent;
-
-    return;
-}
-		
-int
-TellChanged (WindowPtr pWin, pointer value)
-{
-    RREventPtr			*pHead, pRREvent;
-    ClientPtr			client;
-    xRRScreenChangeNotifyEvent	se;
-    ScreenPtr			pScreen = pWin-&gt;drawable.pScreen;
-    rrScrPriv(pScreen);
-    RRScreenSizePtr		pSize;
-    WindowPtr			pRoot = WindowTable[pScreen-&gt;myNum];
-
-    pHead = (RREventPtr *) LookupIDByType (pWin-&gt;drawable.id, EventType);
-    if (!pHead)
-	return WT_WALKCHILDREN;
-
-    se.type = RRScreenChangeNotify + RREventBase;
-    se.rotation = (CARD8) pScrPriv-&gt;rotation;
-    se.timestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-    se.configTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-    se.root =  pRoot-&gt;drawable.id;
-    se.window = pWin-&gt;drawable.id;
-    se.subpixelOrder = PictureGetSubpixelOrder (pScreen);
-    if (pScrPriv-&gt;size &gt;= 0)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[pScrPriv-&gt;size];
-	se.sizeID = pSize-&gt;id;
-	se.widthInPixels = pSize-&gt;width;
-	se.heightInPixels = pSize-&gt;height;
-	se.widthInMillimeters = pSize-&gt;mmWidth;
-	se.heightInMillimeters = pSize-&gt;mmHeight;
-    }
-    else
-    {
-	/*
-	 * This &quot;shouldn't happen&quot;, but a broken DDX can
-	 * forget to set the current configuration on GetInfo
-	 */
-	se.sizeID = 0xffff;
-	se.widthInPixels = 0;
-	se.heightInPixels = 0;
-	se.widthInMillimeters = 0;
-	se.heightInMillimeters = 0;
-    }    
-    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next) 
-    {
-	client = pRREvent-&gt;client;
-	if (client == serverClient || client-&gt;clientGone)
-	    continue;
-	se.sequenceNumber = client-&gt;sequence;
-	if(pRREvent-&gt;mask &amp; RRScreenChangeNotifyMask)
-	  WriteEventsToClient (client, 1, (xEvent *) &amp;se);
-    }
-    return WT_WALKCHILDREN;
-}
-
-Bool
-RRGetInfo (ScreenPtr pScreen)
-{
-    rrScrPriv (pScreen);
-    int		    i, j, k, l;
-    Bool	    changed;
-    Rotation	    rotations;
-    RRScreenSizePtr pSize;
-    RRScreenRatePtr pRate;
-
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	pSize-&gt;oldReferenced = pSize-&gt;referenced;
-	pSize-&gt;referenced = FALSE;
-	for (k = 0; k &lt; pSize-&gt;nRates; k++)
-	{
-	    pRate = &amp;pSize-&gt;pRates[k];
-	    pRate-&gt;oldReferenced = pRate-&gt;referenced;
-	    pRate-&gt;referenced = FALSE;
-	}
-    }
-    if (!(*pScrPriv-&gt;rrGetInfo) (pScreen, &amp;rotations))
-	return FALSE;
-
-    changed = FALSE;
-
-    /*
-     * Check whether anything changed and simultaneously generate
-     * the protocol id values for the objects
-     */
-    if (rotations != pScrPriv-&gt;rotations)
-    {
-	pScrPriv-&gt;rotations = rotations;
-	changed = TRUE;
-    }
-
-    j = 0;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	if (pSize-&gt;oldReferenced != pSize-&gt;referenced)
-	    changed = TRUE;
-	if (pSize-&gt;referenced)
-	    pSize-&gt;id = j++;
-	l = 0;
-	for (k = 0; k &lt; pSize-&gt;nRates; k++)
-	{
-	    pRate = &amp;pSize-&gt;pRates[k];
-	    if (pRate-&gt;oldReferenced != pRate-&gt;referenced)
-		changed = TRUE;
-	    if (pRate-&gt;referenced)
-		l++;
-	}
-	pSize-&gt;nRatesInUse = l;
-    }
-    pScrPriv-&gt;nSizesInUse = j;
-    if (changed)
-    {
-	UpdateCurrentTime ();
-	pScrPriv-&gt;lastConfigTime = currentTime;
-	WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    }
-    return TRUE;
-}
-
-void
-RRSendConfigNotify (ScreenPtr pScreen)
-{
-    WindowPtr	pWin = WindowTable[pScreen-&gt;myNum];
-    xEvent	event;
-
-    event.u.u.type = ConfigureNotify;
-    event.u.configureNotify.window = pWin-&gt;drawable.id;
-    event.u.configureNotify.aboveSibling = None;
-    event.u.configureNotify.x = 0;
-    event.u.configureNotify.y = 0;
-
-    /* XXX xinerama stuff ? */
-    
-    event.u.configureNotify.width = pWin-&gt;drawable.width;
-    event.u.configureNotify.height = pWin-&gt;drawable.height;
-    event.u.configureNotify.borderWidth = wBorderWidth (pWin);
-    event.u.configureNotify.override = pWin-&gt;overrideRedirect;
-    DeliverEvents(pWin, &amp;event, 1, NullWindow);
-}
-
-static int
-ProcRRQueryVersion (ClientPtr client)
-{
-    xRRQueryVersionReply rep;
-    register int n;
-    REQUEST(xRRQueryVersionReq);
-    rrClientPriv(client);
-
-    REQUEST_SIZE_MATCH(xRRQueryVersionReq);
-    pRRClient-&gt;major_version = stuff-&gt;majorVersion;
-    pRRClient-&gt;minor_version = stuff-&gt;minorVersion;
-    rep.type = X_Reply;
-    rep.length = 0;
-    rep.sequenceNumber = client-&gt;sequence;
-    rep.majorVersion = RANDR_MAJOR;
-    rep.minorVersion = RANDR_MINOR;
-    if (client-&gt;swapped) {
-    	swaps(&amp;rep.sequenceNumber, n);
-    	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.majorVersion, n);
-	swapl(&amp;rep.minorVersion, n);
-    }
-    WriteToClient(client, sizeof(xRRQueryVersionReply), (char *)&amp;rep);
-    return (client-&gt;noClientException);
-}
-
-
-extern char	*ConnectionInfo;
-
-static int padlength[4] = {0, 3, 2, 1};
-
-void
-RREditConnectionInfo (ScreenPtr pScreen)
-{
-    xConnSetup	    *connSetup;
-    char	    *vendor;
-    xPixmapFormat   *formats;
-    xWindowRoot	    *root;
-    xDepth	    *depth;
-    xVisualType	    *visual;
-    int		    screen = 0;
-    int		    d;
-
-    connSetup = (xConnSetup *) ConnectionInfo;
-    vendor = (char *) connSetup + sizeof (xConnSetup);
-    formats = (xPixmapFormat *) ((char *) vendor +
-				 connSetup-&gt;nbytesVendor +
-				 padlength[connSetup-&gt;nbytesVendor &amp; 3]);
-    root = (xWindowRoot *) ((char *) formats +
-			    sizeof (xPixmapFormat) * screenInfo.numPixmapFormats);
-    while (screen != pScreen-&gt;myNum)
-    {
-	depth = (xDepth *) ((char *) root + 
-			    sizeof (xWindowRoot));
-	for (d = 0; d &lt; root-&gt;nDepths; d++)
-	{
-	    visual = (xVisualType *) ((char *) depth +
-				      sizeof (xDepth));
-	    depth = (xDepth *) ((char *) visual +
-				depth-&gt;nVisuals * sizeof (xVisualType));
-	}
-	root = (xWindowRoot *) ((char *) depth);
-	screen++;
-    }
-    root-&gt;pixWidth = pScreen-&gt;width;
-    root-&gt;pixHeight = pScreen-&gt;height;
-    root-&gt;mmWidth = pScreen-&gt;mmWidth;
-    root-&gt;mmHeight = pScreen-&gt;mmHeight;
-}
-
-static int
-ProcRRGetScreenInfo (ClientPtr client)
-{
-    REQUEST(xRRGetScreenInfoReq);
-    xRRGetScreenInfoReply   rep;
-    WindowPtr	    	    pWin;
-    int			    n;
-    ScreenPtr		    pScreen;
-    rrScrPrivPtr	    pScrPriv;
-    CARD8		    *extra;
-    int			    extraLen;
-
-    REQUEST_SIZE_MATCH(xRRGetScreenInfoReq);
-    pWin = (WindowPtr)SecurityLookupWindow(stuff-&gt;window, client,
-					   SecurityReadAccess);
-
-    if (!pWin)
-	return BadWindow;
-
-    pScreen = pWin-&gt;drawable.pScreen;
-    pScrPriv = rrGetScrPriv(pScreen);
-    rep.pad = 0;
-    if (!pScrPriv)
-    {
-	rep.type = X_Reply;
-	rep.setOfRotations = RR_Rotate_0;;
-	rep.sequenceNumber = client-&gt;sequence;
-	rep.length = 0;
-	rep.root = WindowTable[pWin-&gt;drawable.pScreen-&gt;myNum]-&gt;drawable.id;
-	rep.timestamp = currentTime.milliseconds;
-	rep.configTimestamp = currentTime.milliseconds;
-	rep.nSizes = 0;
-	rep.sizeID = 0;
-	rep.rotation = RR_Rotate_0;
-	rep.rate = 0;
-	rep.nrateEnts = 0;
-	extra = 0;
-	extraLen = 0;
-    }
-    else
-    {
-	int			i, j;
-	xScreenSizes		*size;
-	CARD16			*rates;
-	CARD8			*data8;
-	Bool			has_rate = RRClientKnowsRates (client);
-    
-	RRGetInfo (pScreen);
-
-	rep.type = X_Reply;
-	rep.setOfRotations = pScrPriv-&gt;rotations;
-	rep.sequenceNumber = client-&gt;sequence;
-	rep.length = 0;
-	rep.root = WindowTable[pWin-&gt;drawable.pScreen-&gt;myNum]-&gt;drawable.id;
-	rep.timestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-	rep.configTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-	rep.rotation = pScrPriv-&gt;rotation;
-	rep.nSizes = pScrPriv-&gt;nSizesInUse;
-	rep.rate = pScrPriv-&gt;rate;
-        rep.nrateEnts = 0;
-	if (has_rate)
-	{
-	    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	    {
-		RRScreenSizePtr pSize = &amp;pScrPriv-&gt;pSizes[i];
-		if (pSize-&gt;referenced)
-		{
-		    rep.nrateEnts += (1 + pSize-&gt;nRatesInUse);
-		}
-	    }
-	}
-
-	if (pScrPriv-&gt;size &gt;= 0)
-	    rep.sizeID = pScrPriv-&gt;pSizes[pScrPriv-&gt;size].id;
-	else
-	    return BadImplementation;
-
-	extraLen = (rep.nSizes * sizeof (xScreenSizes) +
-		    rep.nrateEnts * sizeof (CARD16));
-
-	extra = (CARD8 *) xalloc (extraLen);
-	if (!extra)
-	    return BadAlloc;
-	/*
-	 * First comes the size information
-	 */
-	size = (xScreenSizes *) extra;
-	rates = (CARD16 *) (size + rep.nSizes);
-	for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	{
-	    RRScreenSizePtr pSize = &amp;pScrPriv-&gt;pSizes[i];
-	    if (pSize-&gt;referenced)
-	    {
-		size-&gt;widthInPixels = pSize-&gt;width;
-		size-&gt;heightInPixels = pSize-&gt;height;
-		size-&gt;widthInMillimeters = pSize-&gt;mmWidth;
-		size-&gt;heightInMillimeters = pSize-&gt;mmHeight;
-		if (client-&gt;swapped)
-		{
-		    swaps (&amp;size-&gt;widthInPixels, n);
-		    swaps (&amp;size-&gt;heightInPixels, n);
-		    swaps (&amp;size-&gt;widthInMillimeters, n);
-		    swaps (&amp;size-&gt;heightInMillimeters, n);
-		}
-		size++;
-		if (has_rate)
-		{
-		    *rates = pSize-&gt;nRatesInUse;
-		    if (client-&gt;swapped)
-		    {
-			swaps (rates, n);
-		    }
-		    rates++;
-		    for (j = 0; j &lt; pSize-&gt;nRates; j++)
-		    {
-			RRScreenRatePtr	pRate = &amp;pSize-&gt;pRates[j];
-			if (pRate-&gt;referenced)
-			{
-			    *rates = pRate-&gt;rate;
-			    if (client-&gt;swapped)
-			    {
-				swaps (rates, n);
-			    }
-			    rates++;
-			}
-		    }
-		}
-	    }
-	}
-	data8 = (CARD8 *) rates;
-
-	if (data8 - (CARD8 *) extra != extraLen)
-	    FatalError (&quot;RRGetScreenInfo bad extra len %d != %d\n&quot;,
-			data8 - (CARD8 *) extra, extraLen);
-	rep.length =  (extraLen + 3) &gt;&gt; 2;
-    }
-    if (client-&gt;swapped) {
-	swaps(&amp;rep.sequenceNumber, n);
-	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.timestamp, n);
-	swaps(&amp;rep.rotation, n);
-	swaps(&amp;rep.nSizes, n);
-	swaps(&amp;rep.sizeID, n);
-	swaps(&amp;rep.rate, n);
-	swaps(&amp;rep.nrateEnts, n);
-    }
-    WriteToClient(client, sizeof(xRRGetScreenInfoReply), (char *)&amp;rep);
-    if (extraLen)
-    {
-	WriteToClient (client, extraLen, (char *) extra);
-	xfree (extra);
-    }
-    return (client-&gt;noClientException);
-}
-
-static int
-ProcRRSetScreenConfig (ClientPtr client)
-{
-    REQUEST(xRRSetScreenConfigReq);
-    xRRSetScreenConfigReply rep;
-    DrawablePtr		    pDraw;
-    int			    n;
-    ScreenPtr		    pScreen;
-    rrScrPrivPtr	    pScrPriv;
-    TimeStamp		    configTime;
-    TimeStamp		    time;
-    RRScreenSizePtr	    pSize;
-    int			    i;
-    Rotation		    rotation;
-    int			    rate;
-    short		    oldWidth, oldHeight;
-    Bool		    has_rate;
-
-    UpdateCurrentTime ();
-
-    if (RRClientKnowsRates (client))
-    {
-	REQUEST_SIZE_MATCH (xRRSetScreenConfigReq);
-	has_rate = TRUE;
-    }
-    else
-    {
-	REQUEST_SIZE_MATCH (xRR1_0SetScreenConfigReq);
-	has_rate = FALSE;
-    }
-    
-    SECURITY_VERIFY_DRAWABLE(pDraw, stuff-&gt;drawable, client,
-			     SecurityWriteAccess);
-
-    pScreen = pDraw-&gt;pScreen;
-
-    pScrPriv= rrGetScrPriv(pScreen);
-    
-    time = ClientTimeToServerTime(stuff-&gt;timestamp);
-    configTime = ClientTimeToServerTime(stuff-&gt;configTimestamp);
-    
-    oldWidth = pScreen-&gt;width;
-    oldHeight = pScreen-&gt;height;
-    
-    if (!pScrPriv)
-    {
-	time = currentTime;
-	rep.status = RRSetConfigFailed;
-	goto sendReply;
-    }
-    if (!RRGetInfo (pScreen))
-	return BadAlloc;
-    
-    /*
-     * if the client's config timestamp is not the same as the last config
-     * timestamp, then the config information isn't up-to-date and
-     * can't even be validated
-     */
-    if (CompareTimeStamps (configTime, pScrPriv-&gt;lastConfigTime) != 0)
-    {
-	rep.status = RRSetConfigInvalidConfigTime;
-	goto sendReply;
-    }
-    
-    /*
-     * Search for the requested size
-     */
-    pSize = 0;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	if (pSize-&gt;referenced &amp;&amp; pSize-&gt;id == stuff-&gt;sizeID)
-	{
-	    break;
-	}
-    }
-    if (i == pScrPriv-&gt;nSizes)
-    {
-	/*
-	 * Invalid size ID
-	 */
-	client-&gt;errorValue = stuff-&gt;sizeID;
-	return BadValue;
-    }
-    
-    /*
-     * Validate requested rotation
-     */
-    rotation = (Rotation) stuff-&gt;rotation;
-
-    /* test the rotation bits only! */
-    switch (rotation &amp; 0xf) {
-    case RR_Rotate_0:
-    case RR_Rotate_90:
-    case RR_Rotate_180:
-    case RR_Rotate_270:
-	break;
-    default:
-	/*
-	 * Invalid rotation
-	 */
-	client-&gt;errorValue = stuff-&gt;rotation;
-	return BadValue;
-    }
-
-    if ((~pScrPriv-&gt;rotations) &amp; rotation)
-    {
-	/*
-	 * requested rotation or reflection not supported by screen
-	 */
-	client-&gt;errorValue = stuff-&gt;rotation;
-	return BadMatch;
-    }
-
-    /*
-     * Validate requested refresh
-     */
-    if (has_rate)
-	rate = (int) stuff-&gt;rate;
-    else
-	rate = 0;
-
-    if (rate)
-    {
-	for (i = 0; i &lt; pSize-&gt;nRates; i++)
-	{
-	    RRScreenRatePtr pRate = &amp;pSize-&gt;pRates[i];
-	    if (pRate-&gt;referenced &amp;&amp; pRate-&gt;rate == rate)
-		break;
-	}
-	if (i == pSize-&gt;nRates)
-	{
-	    /*
-	     * Invalid rate
-	     */
-	    client-&gt;errorValue = rate;
-	    return BadValue;
-	}
-    }
-    
-    /*
-     * Make sure the requested set-time is not older than
-     * the last set-time
-     */
-    if (CompareTimeStamps (time, pScrPriv-&gt;lastSetTime) &lt; 0)
-    {
-	rep.status = RRSetConfigInvalidTime;
-	goto sendReply;
-    }
-
-    /*
-     * call out to ddx routine to effect the change
-     */
-    if (!(*pScrPriv-&gt;rrSetConfig) (pScreen, rotation, rate,
-				   pSize))
-    {
-	/*
-	 * unknown DDX failure, report to client
-	 */
-	rep.status = RRSetConfigFailed;
-	goto sendReply;
-    }
-    
-    /*
-     * set current extension configuration pointers
-     */
-    RRSetCurrentConfig (pScreen, rotation, rate, pSize);
-    
-    /*
-     * Deliver ScreenChangeNotify events whenever
-     * the configuration is updated
-     */
-    WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    
-    /*
-     * Deliver ConfigureNotify events when root changes
-     * pixel size
-     */
-    if (oldWidth != pScreen-&gt;width || oldHeight != pScreen-&gt;height)
-	RRSendConfigNotify (pScreen);
-    RREditConnectionInfo (pScreen);
-    
-    /*
-     * Fix pointer bounds and location
-     */
-    ScreenRestructured (pScreen);
-    pScrPriv-&gt;lastSetTime = time;
-    
-    /*
-     * Report Success
-     */
-    rep.status = RRSetConfigSuccess;
-    
-sendReply:
-    
-    rep.type = X_Reply;
-    /* rep.status has already been filled in */
-    rep.length = 0;
-    rep.sequenceNumber = client-&gt;sequence;
-
-    rep.newTimestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-    rep.newConfigTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-    rep.root = WindowTable[pDraw-&gt;pScreen-&gt;myNum]-&gt;drawable.id;
-
-    if (client-&gt;swapped) 
-    {
-    	swaps(&amp;rep.sequenceNumber, n);
-    	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.newTimestamp, n);
-	swapl(&amp;rep.newConfigTimestamp, n);
-	swapl(&amp;rep.root, n);
-    }
-    WriteToClient(client, sizeof(xRRSetScreenConfigReply), (char *)&amp;rep);
-
-    return (client-&gt;noClientException);
-}
-
-static int
-ProcRRSelectInput (ClientPtr client)
-{
-    REQUEST(xRRSelectInputReq);
-    rrClientPriv(client);
-    RRTimesPtr	pTimes;
-    WindowPtr	pWin;
-    RREventPtr	pRREvent, pNewRREvent, *pHead;
-    XID		clientResource;
-
-    REQUEST_SIZE_MATCH(xRRSelectInputReq);
-    pWin = SecurityLookupWindow (stuff-&gt;window, client, SecurityWriteAccess);
-    if (!pWin)
-	return BadWindow;
-    pHead = (RREventPtr *)SecurityLookupIDByType(client,
-						 pWin-&gt;drawable.id, EventType,
-						 SecurityWriteAccess);
-
-    if (stuff-&gt;enable &amp; (RRScreenChangeNotifyMask)) 
-    {
-	ScreenPtr	pScreen = pWin-&gt;drawable.pScreen;
-	rrScrPriv	(pScreen);
-
-	if (pHead) 
-	{
-	    /* check for existing entry. */
-	    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next)
-		if (pRREvent-&gt;client == client)
-		    return Success;
-	}
-
-	/* build the entry */
-	pNewRREvent = (RREventPtr) xalloc (sizeof (RREventRec));
-	if (!pNewRREvent)
-	    return BadAlloc;
-	pNewRREvent-&gt;next = 0;
-	pNewRREvent-&gt;client = client;
-	pNewRREvent-&gt;window = pWin;
-	pNewRREvent-&gt;mask = stuff-&gt;enable;
-	/*
-	 * add a resource that will be deleted when
-	 * the client goes away
-	 */
-	clientResource = FakeClientID (client-&gt;index);
-	pNewRREvent-&gt;clientResource = clientResource;
-	if (!AddResource (clientResource, ClientType, (pointer)pNewRREvent))
-	    return BadAlloc;
-	/*
-	 * create a resource to contain a pointer to the list
-	 * of clients selecting input.  This must be indirect as
-	 * the list may be arbitrarily rearranged which cannot be
-	 * done through the resource database.
-	 */
-	if (!pHead)
-	{
-	    pHead = (RREventPtr *) xalloc (sizeof (RREventPtr));
-	    if (!pHead ||
-		!AddResource (pWin-&gt;drawable.id, EventType, (pointer)pHead))
-	    {
-		FreeResource (clientResource, RT_NONE);
-		return BadAlloc;
-	    }
-	    *pHead = 0;
-	}
-	pNewRREvent-&gt;next = *pHead;
-	*pHead = pNewRREvent;
-	/*
-	 * Now see if the client needs an event
-	 */
-	if (pScrPriv)
-	{
-	    pTimes = &amp;((RRTimesPtr) (pRRClient + 1))[pScreen-&gt;myNum];
-	    if (CompareTimeStamps (pTimes-&gt;setTime, 
-				   pScrPriv-&gt;lastSetTime) != 0 ||
-		CompareTimeStamps (pTimes-&gt;configTime, 
-				   pScrPriv-&gt;lastConfigTime) != 0)
-	    {
-		TellChanged (pWin, (pointer) pScreen);
-	    }
-	}
-    }
-    else if (stuff-&gt;enable == xFalse) 
-    {
-	/* delete the interest */
-	if (pHead) {
-	    pNewRREvent = 0;
-	    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next) {
-		if (pRREvent-&gt;client == client)
-		    break;
-		pNewRREvent = pRREvent;
-	    }
-	    if (pRREvent) {
-		FreeResource (pRREvent-&gt;clientResource, ClientType);
-		if (pNewRREvent)
-		    pNewRREvent-&gt;next = pRREvent-&gt;next;
-		else
-		    *pHead = pRREvent-&gt;next;
-		xfree (pRREvent);
-	    }
-	}
-    }
-    else 
-    {
-	client-&gt;errorValue = stuff-&gt;enable;
-	return BadValue;
-    }
-    return Success;
-}
-
-
-static int
-ProcRRDispatch (ClientPtr client)
-{
-    REQUEST(xReq);
-    switch (stuff-&gt;data)
-    {
-    case X_RRQueryVersion:
-	return ProcRRQueryVersion(client);
-    case X_RRSetScreenConfig:
-        return ProcRRSetScreenConfig(client);
-    case X_RRSelectInput:
-        return ProcRRSelectInput(client);
-    case X_RRGetScreenInfo:
-        return ProcRRGetScreenInfo(client);
-    default:
-	return BadRequest;
-    }
-}
-
-static int
-SProcRRQueryVersion (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRQueryVersionReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;majorVersion, n);
-    swapl(&amp;stuff-&gt;minorVersion, n);
-    return ProcRRQueryVersion(client);
-}
-
-static int
-SProcRRGetScreenInfo (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRGetScreenInfoReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;window, n);
-    return ProcRRGetScreenInfo(client);
-}
-
-static int
-SProcRRSetScreenConfig (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRSetScreenConfigReq);
-
-    if (RRClientKnowsRates (client))
-    {
-	REQUEST_SIZE_MATCH (xRRSetScreenConfigReq);
-	swaps (&amp;stuff-&gt;rate, n);
-    }
-    else
-    {
-	REQUEST_SIZE_MATCH (xRR1_0SetScreenConfigReq);
-    }
-    
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;drawable, n);
-    swapl(&amp;stuff-&gt;timestamp, n);
-    swaps(&amp;stuff-&gt;sizeID, n);
-    swaps(&amp;stuff-&gt;rotation, n);
-    return ProcRRSetScreenConfig(client);
-}
-
-static int
-SProcRRSelectInput (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRSelectInputReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;window, n);
-    return ProcRRSelectInput(client);
-}
-
-
-static int
-SProcRRDispatch (ClientPtr client)
-{
-    REQUEST(xReq);
-    switch (stuff-&gt;data)
-    {
-    case X_RRQueryVersion:
-	return SProcRRQueryVersion(client);
-    case X_RRSetScreenConfig:
-        return SProcRRSetScreenConfig(client);
-    case X_RRSelectInput:
-        return SProcRRSelectInput(client);
-    case X_RRGetScreenInfo:
-        return SProcRRGetScreenInfo(client);
-    default:
-	return BadRequest;
-    }
-}
-
-
-static Bool
-RRScreenSizeMatches (RRScreenSizePtr  a,
-		   RRScreenSizePtr  b)
-{
-    if (a-&gt;width != b-&gt;width)
-	return FALSE;
-    if (a-&gt;height != b-&gt;height)
-	return FALSE;
-    if (a-&gt;mmWidth != b-&gt;mmWidth)
-	return FALSE;
-    if (a-&gt;mmHeight != b-&gt;mmHeight)
-	return FALSE;
-    return TRUE;
-}
-
-RRScreenSizePtr
-RRRegisterSize (ScreenPtr	    pScreen,
-		short		    width, 
-		short		    height,
-		short		    mmWidth,
-		short		    mmHeight)
-{
-    rrScrPriv (pScreen);
-    int		    i;
-    RRScreenSize    tmp;
-    RRScreenSizePtr pNew;
-
-    if (!pScrPriv)
-	return 0;
-
-    /*
-     * FIXME: The compiler reports that field
-     * id is used uninitialized here.
-     */
-
-    tmp.id = 0;
-    
-    tmp.width = width;
-    tmp.height= height;
-    tmp.mmWidth = mmWidth;
-    tmp.mmHeight = mmHeight;
-    tmp.pRates = 0;
-    tmp.nRates = 0;
-    tmp.nRatesInUse = 0;
-    tmp.referenced = TRUE;
-    tmp.oldReferenced = FALSE;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	if (RRScreenSizeMatches (&amp;tmp, &amp;pScrPriv-&gt;pSizes[i]))
-	{
-	    pScrPriv-&gt;pSizes[i].referenced = TRUE;
-	    return &amp;pScrPriv-&gt;pSizes[i];
-	}
-    pNew = xrealloc (pScrPriv-&gt;pSizes,
-		     (pScrPriv-&gt;nSizes + 1) * sizeof (RRScreenSize));
-    if (!pNew)
-	return 0;
-    pNew[pScrPriv-&gt;nSizes++] = tmp;
-    pScrPriv-&gt;pSizes = pNew;
-    return &amp;pNew[pScrPriv-&gt;nSizes-1];
-}
-
-Bool RRRegisterRate (ScreenPtr		pScreen,
-		     RRScreenSizePtr	pSize,
-		     int		rate)
-{
-    rrScrPriv(pScreen);
-    int		    i;
-    RRScreenRatePtr pNew, pRate;
-
-    if (!pScrPriv)
-	return FALSE;
-    
-    for (i = 0; i &lt; pSize-&gt;nRates; i++)
-    {
-	pRate = &amp;pSize-&gt;pRates[i];
-	if (pRate-&gt;rate == rate)
-	{
-	    pRate-&gt;referenced = TRUE;
-	    return TRUE;
-	}
-    }
-
-    pNew = xrealloc (pSize-&gt;pRates,
-		     (pSize-&gt;nRates + 1) * sizeof (RRScreenRate));
-    if (!pNew)
-	return FALSE;
-    pRate = &amp;pNew[pSize-&gt;nRates++];
-    pRate-&gt;rate = rate;
-    pRate-&gt;referenced = TRUE;
-    pRate-&gt;oldReferenced = FALSE;
-    pSize-&gt;pRates = pNew;
-    return TRUE;
-}
-
-void
-RRSetCurrentConfig (ScreenPtr		pScreen,
-		    Rotation		rotation,
-		    int			rate,
-		    RRScreenSizePtr	pSize)
-{
-    rrScrPriv (pScreen);
-
-    if (!pScrPriv)
-	return;
-
-    pScrPriv-&gt;rotation = rotation;
-    pScrPriv-&gt;size = pSize - pScrPriv-&gt;pSizes;
-    pScrPriv-&gt;rate = rate;
-}
-
-#endif /* #ifdef NXAGENT_UPGRADE */
diff --git a/nx-X11/programs/Xserver/hw/nxagent/NXrandr.c.XF86.original b/nx-X11/programs/Xserver/hw/nxagent/NXrandr.c.XF86.original
deleted file mode 100644
index 666605e..0000000
--- a/nx-X11/programs/Xserver/hw/nxagent/NXrandr.c.XF86.original
+++ /dev/null
@@ -1,1197 +0,0 @@
-/*
- * $XFree86: xc/programs/Xserver/randr/randr.c,v 1.19 2003/02/08 03:52:30 dawes Exp $
- *
- * Copyright &#169; 2000, Compaq Computer Corporation, 
- * Copyright &#169; 2002, Hewlett Packard, Inc.
- *
- * Permission to use, copy, modify, distribute, and sell this software and its
- * documentation for any purpose is hereby granted without fee, provided that
- * the above copyright notice appear in all copies and that both that
- * copyright notice and this permission notice appear in supporting
- * documentation, and that the name of Compaq or HP not be used in advertising
- * or publicity pertaining to distribution of the software without specific,
- * written prior permission.  HP makes no representations about the
- * suitability of this software for any purpose.  It is provided &quot;as is&quot;
- * without express or implied warranty.
- *
- * HP DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL HP
- * BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
- * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
- * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN 
- * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
- *
- * Author:  Jim Gettys, HP Labs, Hewlett-Packard, Inc.
- */
-
-
-#define NEED_REPLIES
-#define NEED_EVENTS
-#include &quot;X.h&quot;
-#include &quot;Xproto.h&quot;
-#include &quot;misc.h&quot;
-#include &quot;os.h&quot;
-#include &quot;dixstruct.h&quot;
-#include &quot;resource.h&quot;
-#include &quot;scrnintstr.h&quot;
-#include &quot;windowstr.h&quot;
-#include &quot;pixmapstr.h&quot;
-#include &quot;extnsionst.h&quot;
-#include &quot;servermd.h&quot;
-#include &quot;randr.h&quot;
-#include &quot;randrproto.h&quot;
-#include &quot;randrstr.h&quot;
-#include &quot;render.h&quot; 	/* we share subpixel order information */
-#include &quot;picturestr.h&quot;
-#include &quot;Xfuncproto.h&quot;
-#ifdef EXTMODULE
-#include &quot;xf86_ansic.h&quot;
-#endif
-
-#define RR_VALIDATE
-int	RRGeneration;
-int	RRNScreens;
-
-static int ProcRRQueryVersion (ClientPtr pClient);
-static int ProcRRDispatch (ClientPtr pClient);
-static int SProcRRDispatch (ClientPtr pClient);
-static int SProcRRQueryVersion (ClientPtr pClient);
-
-#define wrap(priv,real,mem,func) {\
-    priv-&gt;mem = real-&gt;mem; \
-    real-&gt;mem = func; \
-}
-
-#define unwrap(priv,real,mem) {\
-    real-&gt;mem = priv-&gt;mem; \
-}
-
-static CARD8	RRReqCode;
-static int	RRErrBase;
-static int	RREventBase;
-static RESTYPE ClientType, EventType; /* resource types for event masks */
-static int	RRClientPrivateIndex;
-
-typedef struct _RRTimes {
-    TimeStamp	setTime;
-    TimeStamp	configTime;
-} RRTimesRec, *RRTimesPtr;
-
-typedef struct _RRClient {
-    int		major_version;
-    int		minor_version;
-/*  RRTimesRec	times[0]; */
-} RRClientRec, *RRClientPtr;
-
-/*
- * each window has a list of clients requesting
- * RRNotify events.  Each client has a resource
- * for each window it selects RRNotify input for,
- * this resource is used to delete the RRNotifyRec
- * entry from the per-window queue.
- */
-
-typedef struct _RREvent *RREventPtr;
-
-typedef struct _RREvent {
-    RREventPtr  next;
-    ClientPtr	client;
-    WindowPtr	window;
-    XID		clientResource;
-    int		mask;
-} RREventRec;
-
-int	rrPrivIndex = -1;
-
-#define GetRRClient(pClient)    ((RRClientPtr) (pClient)-&gt;devPrivates[RRClientPrivateIndex].ptr)
-#define rrClientPriv(pClient)	RRClientPtr pRRClient = GetRRClient(pClient)
-
-static Bool
-RRClientKnowsRates (ClientPtr	pClient)
-{
-    rrClientPriv(pClient);
-
-    return (pRRClient-&gt;major_version &gt; 1 ||
-	    (pRRClient-&gt;major_version == 1 &amp;&amp; pRRClient-&gt;minor_version &gt;= 1));
-}
-
-static void
-RRClientCallback (CallbackListPtr	*list,
-		  pointer		closure,
-		  pointer		data)
-{
-    NewClientInfoRec	*clientinfo = (NewClientInfoRec *) data;
-    ClientPtr		pClient = clientinfo-&gt;client;
-    rrClientPriv(pClient);
-    RRTimesPtr		pTimes = (RRTimesPtr) (pRRClient + 1);
-    int			i;
-
-    pRRClient-&gt;major_version = 0;
-    pRRClient-&gt;minor_version = 0;
-    for (i = 0; i &lt; screenInfo.numScreens; i++)
-    {
-	ScreenPtr   pScreen = screenInfo.screens[i];
-	rrScrPriv(pScreen);
-
-	if (pScrPriv)
-	{
-	    pTimes[i].setTime = pScrPriv-&gt;lastSetTime;
-	    pTimes[i].configTime = pScrPriv-&gt;lastConfigTime;
-	}
-    }
-}
-
-static void
-RRResetProc (ExtensionEntry *extEntry)
-{
-}
-    
-static Bool
-RRCloseScreen (int i, ScreenPtr pScreen)
-{
-    rrScrPriv(pScreen);
-
-    unwrap (pScrPriv, pScreen, CloseScreen);
-    if (pScrPriv-&gt;pSizes)
-	xfree (pScrPriv-&gt;pSizes);
-    xfree (pScrPriv);
-    RRNScreens -= 1;	/* ok, one fewer screen with RandR running */
-    return (*pScreen-&gt;CloseScreen) (i, pScreen);    
-}
-
-static void
-SRRScreenChangeNotifyEvent(xRRScreenChangeNotifyEvent *from,
-			   xRRScreenChangeNotifyEvent *to)
-{
-    to-&gt;type = from-&gt;type;
-    to-&gt;rotation = from-&gt;rotation;
-    cpswaps(from-&gt;sequenceNumber, to-&gt;sequenceNumber);
-    cpswapl(from-&gt;timestamp, to-&gt;timestamp);
-    cpswapl(from-&gt;configTimestamp, to-&gt;configTimestamp);
-    cpswapl(from-&gt;root, to-&gt;root);
-    cpswapl(from-&gt;window, to-&gt;window);
-    cpswaps(from-&gt;sizeID, to-&gt;sizeID);
-    cpswaps(from-&gt;widthInPixels, to-&gt;widthInPixels);
-    cpswaps(from-&gt;heightInPixels, to-&gt;heightInPixels);
-    cpswaps(from-&gt;widthInMillimeters, to-&gt;widthInMillimeters);
-    cpswaps(from-&gt;heightInMillimeters, to-&gt;heightInMillimeters);
-    cpswaps(from-&gt;subpixelOrder, to-&gt;subpixelOrder);
-}
-
-Bool RRScreenInit(ScreenPtr pScreen)
-{
-    rrScrPrivPtr   pScrPriv;
-
-    if (RRGeneration != serverGeneration)
-    {
-	if ((rrPrivIndex = AllocateScreenPrivateIndex()) &lt; 0)
-	    return FALSE;
-	RRGeneration = serverGeneration;
-    }
-
-    pScrPriv = (rrScrPrivPtr) xalloc (sizeof (rrScrPrivRec));
-    if (!pScrPriv)
-	return FALSE;
-
-    SetRRScreen(pScreen, pScrPriv);
-
-    /*
-     * Calling function best set these function vectors
-     */
-    pScrPriv-&gt;rrSetConfig = 0;
-    pScrPriv-&gt;rrGetInfo = 0;
-    /*
-     * This value doesn't really matter -- any client must call
-     * GetScreenInfo before reading it which will automatically update
-     * the time
-     */
-    pScrPriv-&gt;lastSetTime = currentTime;
-    pScrPriv-&gt;lastConfigTime = currentTime;
-    
-    wrap (pScrPriv, pScreen, CloseScreen, RRCloseScreen);
-
-    pScrPriv-&gt;rotations = RR_Rotate_0;
-    
-    pScrPriv-&gt;nSizes = 0;
-    pScrPriv-&gt;nSizesInUse = 0;
-    pScrPriv-&gt;pSizes = 0;
-    
-    pScrPriv-&gt;rotation = RR_Rotate_0;
-    pScrPriv-&gt;size = -1;
-    
-    RRNScreens += 1;	/* keep count of screens that implement randr */
-    return TRUE;
-}
-
-/*ARGSUSED*/
-static int
-RRFreeClient (pointer data, XID id)
-{
-    RREventPtr   pRREvent;
-    WindowPtr	    pWin;
-    RREventPtr   *pHead, pCur, pPrev;
-
-    pRREvent = (RREventPtr) data;
-    pWin = pRREvent-&gt;window;
-    pHead = (RREventPtr *) LookupIDByType(pWin-&gt;drawable.id, EventType);
-    if (pHead) {
-	pPrev = 0;
-	for (pCur = *pHead; pCur &amp;&amp; pCur != pRREvent; pCur=pCur-&gt;next)
-	    pPrev = pCur;
-	if (pCur)
-	{
-	    if (pPrev)
-	    	pPrev-&gt;next = pRREvent-&gt;next;
-	    else
-	    	*pHead = pRREvent-&gt;next;
-	}
-    }
-    xfree ((pointer) pRREvent);
-    return 1;
-}
-
-/*ARGSUSED*/
-static int
-RRFreeEvents (pointer data, XID id)
-{
-    RREventPtr   *pHead, pCur, pNext;
-
-    pHead = (RREventPtr *) data;
-    for (pCur = *pHead; pCur; pCur = pNext) {
-	pNext = pCur-&gt;next;
-	FreeResource (pCur-&gt;clientResource, ClientType);
-	xfree ((pointer) pCur);
-    }
-    xfree ((pointer) pHead);
-    return 1;
-}
-
-void
-RRExtensionInit (void)
-{
-    ExtensionEntry *extEntry;
-
-    if (RRNScreens == 0) return;
-
-    RRClientPrivateIndex = AllocateClientPrivateIndex ();
-    if (!AllocateClientPrivate (RRClientPrivateIndex,
-				sizeof (RRClientRec) +
-				screenInfo.numScreens * sizeof (RRTimesRec)))
-	return;
-    if (!AddCallback (&amp;ClientStateCallback, RRClientCallback, 0))
-	return;
-
-    ClientType = CreateNewResourceType(RRFreeClient);
-    if (!ClientType)
-	return;
-    EventType = CreateNewResourceType(RRFreeEvents);
-    if (!EventType)
-	return;
-    extEntry = AddExtension (RANDR_NAME, RRNumberEvents, RRNumberErrors,
-			     ProcRRDispatch, SProcRRDispatch,
-			     RRResetProc, StandardMinorOpcode);
-    if (!extEntry)
-	return;
-    RRReqCode = (CARD8) extEntry-&gt;base;
-    RRErrBase = extEntry-&gt;errorBase;
-    RREventBase = extEntry-&gt;eventBase;
-    EventSwapVector[RREventBase + RRScreenChangeNotify] = (EventSwapPtr) 
-      SRRScreenChangeNotifyEvent;
-
-    return;
-}
-		
-static int
-TellChanged (WindowPtr pWin, pointer value)
-{
-    RREventPtr			*pHead, pRREvent;
-    ClientPtr			client;
-    xRRScreenChangeNotifyEvent	se;
-    ScreenPtr			pScreen = pWin-&gt;drawable.pScreen;
-    rrScrPriv(pScreen);
-    RRScreenSizePtr		pSize;
-    WindowPtr			pRoot = WindowTable[pScreen-&gt;myNum];
-
-    pHead = (RREventPtr *) LookupIDByType (pWin-&gt;drawable.id, EventType);
-    if (!pHead)
-	return WT_WALKCHILDREN;
-
-    se.type = RRScreenChangeNotify + RREventBase;
-    se.rotation = (CARD8) pScrPriv-&gt;rotation;
-    se.timestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-    se.configTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-    se.root =  pRoot-&gt;drawable.id;
-    se.window = pWin-&gt;drawable.id;
-    se.subpixelOrder = PictureGetSubpixelOrder (pScreen);
-    if (pScrPriv-&gt;size &gt;= 0)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[pScrPriv-&gt;size];
-	se.sizeID = pSize-&gt;id;
-	se.widthInPixels = pSize-&gt;width;
-	se.heightInPixels = pSize-&gt;height;
-	se.widthInMillimeters = pSize-&gt;mmWidth;
-	se.heightInMillimeters = pSize-&gt;mmHeight;
-    }
-    else
-    {
-	/*
-	 * This &quot;shouldn't happen&quot;, but a broken DDX can
-	 * forget to set the current configuration on GetInfo
-	 */
-	se.sizeID = 0xffff;
-	se.widthInPixels = 0;
-	se.heightInPixels = 0;
-	se.widthInMillimeters = 0;
-	se.heightInMillimeters = 0;
-    }    
-    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next) 
-    {
-	client = pRREvent-&gt;client;
-	if (client == serverClient || client-&gt;clientGone)
-	    continue;
-	se.sequenceNumber = client-&gt;sequence;
-	if(pRREvent-&gt;mask &amp; RRScreenChangeNotifyMask)
-	  WriteEventsToClient (client, 1, (xEvent *) &amp;se);
-    }
-    return WT_WALKCHILDREN;
-}
-
-static Bool
-RRGetInfo (ScreenPtr pScreen)
-{
-    rrScrPriv (pScreen);
-    int		    i, j, k, l;
-    Bool	    changed;
-    Rotation	    rotations;
-    RRScreenSizePtr pSize;
-    RRScreenRatePtr pRate;
-
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	pSize-&gt;oldReferenced = pSize-&gt;referenced;
-	pSize-&gt;referenced = FALSE;
-	for (k = 0; k &lt; pSize-&gt;nRates; k++)
-	{
-	    pRate = &amp;pSize-&gt;pRates[k];
-	    pRate-&gt;oldReferenced = pRate-&gt;referenced;
-	    pRate-&gt;referenced = FALSE;
-	}
-    }
-    if (!(*pScrPriv-&gt;rrGetInfo) (pScreen, &amp;rotations))
-	return FALSE;
-
-    changed = FALSE;
-
-    /*
-     * Check whether anything changed and simultaneously generate
-     * the protocol id values for the objects
-     */
-    if (rotations != pScrPriv-&gt;rotations)
-    {
-	pScrPriv-&gt;rotations = rotations;
-	changed = TRUE;
-    }
-
-    j = 0;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	if (pSize-&gt;oldReferenced != pSize-&gt;referenced)
-	    changed = TRUE;
-	if (pSize-&gt;referenced)
-	    pSize-&gt;id = j++;
-	l = 0;
-	for (k = 0; k &lt; pSize-&gt;nRates; k++)
-	{
-	    pRate = &amp;pSize-&gt;pRates[k];
-	    if (pRate-&gt;oldReferenced != pRate-&gt;referenced)
-		changed = TRUE;
-	    if (pRate-&gt;referenced)
-		l++;
-	}
-	pSize-&gt;nRatesInUse = l;
-    }
-    pScrPriv-&gt;nSizesInUse = j;
-    if (changed)
-    {
-	UpdateCurrentTime ();
-	pScrPriv-&gt;lastConfigTime = currentTime;
-	WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    }
-    return TRUE;
-}
-
-static void
-RRSendConfigNotify (ScreenPtr pScreen)
-{
-    WindowPtr	pWin = WindowTable[pScreen-&gt;myNum];
-    xEvent	event;
-
-    event.u.u.type = ConfigureNotify;
-    event.u.configureNotify.window = pWin-&gt;drawable.id;
-    event.u.configureNotify.aboveSibling = None;
-    event.u.configureNotify.x = 0;
-    event.u.configureNotify.y = 0;
-
-    /* XXX xinerama stuff ? */
-    
-    event.u.configureNotify.width = pWin-&gt;drawable.width;
-    event.u.configureNotify.height = pWin-&gt;drawable.height;
-    event.u.configureNotify.borderWidth = wBorderWidth (pWin);
-    event.u.configureNotify.override = pWin-&gt;overrideRedirect;
-    DeliverEvents(pWin, &amp;event, 1, NullWindow);
-}
-
-static int
-ProcRRQueryVersion (ClientPtr client)
-{
-    xRRQueryVersionReply rep;
-    register int n;
-    REQUEST(xRRQueryVersionReq);
-    rrClientPriv(client);
-
-    REQUEST_SIZE_MATCH(xRRQueryVersionReq);
-    pRRClient-&gt;major_version = stuff-&gt;majorVersion;
-    pRRClient-&gt;minor_version = stuff-&gt;minorVersion;
-    rep.type = X_Reply;
-    rep.length = 0;
-    rep.sequenceNumber = client-&gt;sequence;
-    rep.majorVersion = RANDR_MAJOR;
-    rep.minorVersion = RANDR_MINOR;
-    if (client-&gt;swapped) {
-    	swaps(&amp;rep.sequenceNumber, n);
-    	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.majorVersion, n);
-	swapl(&amp;rep.minorVersion, n);
-    }
-    WriteToClient(client, sizeof(xRRQueryVersionReply), (char *)&amp;rep);
-    return (client-&gt;noClientException);
-}
-
-
-extern char	*ConnectionInfo;
-
-static int padlength[4] = {0, 3, 2, 1};
-
-static void
-RREditConnectionInfo (ScreenPtr pScreen)
-{
-    xConnSetup	    *connSetup;
-    char	    *vendor;
-    xPixmapFormat   *formats;
-    xWindowRoot	    *root;
-    xDepth	    *depth;
-    xVisualType	    *visual;
-    int		    screen = 0;
-    int		    d;
-
-    connSetup = (xConnSetup *) ConnectionInfo;
-    vendor = (char *) connSetup + sizeof (xConnSetup);
-    formats = (xPixmapFormat *) ((char *) vendor +
-				 connSetup-&gt;nbytesVendor +
-				 padlength[connSetup-&gt;nbytesVendor &amp; 3]);
-    root = (xWindowRoot *) ((char *) formats +
-			    sizeof (xPixmapFormat) * screenInfo.numPixmapFormats);
-    while (screen != pScreen-&gt;myNum)
-    {
-	depth = (xDepth *) ((char *) root + 
-			    sizeof (xWindowRoot));
-	for (d = 0; d &lt; root-&gt;nDepths; d++)
-	{
-	    visual = (xVisualType *) ((char *) depth +
-				      sizeof (xDepth));
-	    depth = (xDepth *) ((char *) visual +
-				depth-&gt;nVisuals * sizeof (xVisualType));
-	}
-	root = (xWindowRoot *) ((char *) depth);
-	screen++;
-    }
-    root-&gt;pixWidth = pScreen-&gt;width;
-    root-&gt;pixHeight = pScreen-&gt;height;
-    root-&gt;mmWidth = pScreen-&gt;mmWidth;
-    root-&gt;mmHeight = pScreen-&gt;mmHeight;
-}
-
-static int
-ProcRRGetScreenInfo (ClientPtr client)
-{
-    REQUEST(xRRGetScreenInfoReq);
-    xRRGetScreenInfoReply   rep;
-    WindowPtr	    	    pWin;
-    int			    n;
-    ScreenPtr		    pScreen;
-    rrScrPrivPtr	    pScrPriv;
-    CARD8		    *extra;
-    int			    extraLen;
-
-    REQUEST_SIZE_MATCH(xRRGetScreenInfoReq);
-    pWin = (WindowPtr)SecurityLookupWindow(stuff-&gt;window, client,
-					   SecurityReadAccess);
-
-    if (!pWin)
-	return BadWindow;
-
-    pScreen = pWin-&gt;drawable.pScreen;
-    pScrPriv = rrGetScrPriv(pScreen);
-    rep.pad = 0;
-    if (!pScrPriv)
-    {
-	rep.type = X_Reply;
-	rep.setOfRotations = RR_Rotate_0;;
-	rep.sequenceNumber = client-&gt;sequence;
-	rep.length = 0;
-	rep.root = WindowTable[pWin-&gt;drawable.pScreen-&gt;myNum]-&gt;drawable.id;
-	rep.timestamp = currentTime.milliseconds;
-	rep.configTimestamp = currentTime.milliseconds;
-	rep.nSizes = 0;
-	rep.sizeID = 0;
-	rep.rotation = RR_Rotate_0;
-	rep.rate = 0;
-	rep.nrateEnts = 0;
-	extra = 0;
-	extraLen = 0;
-    }
-    else
-    {
-	int			i, j;
-	xScreenSizes		*size;
-	CARD16			*rates;
-	CARD8			*data8;
-	Bool			has_rate = RRClientKnowsRates (client);
-    
-	RRGetInfo (pScreen);
-
-	rep.type = X_Reply;
-	rep.setOfRotations = pScrPriv-&gt;rotations;
-	rep.sequenceNumber = client-&gt;sequence;
-	rep.length = 0;
-	rep.root = WindowTable[pWin-&gt;drawable.pScreen-&gt;myNum]-&gt;drawable.id;
-	rep.timestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-	rep.configTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-	rep.rotation = pScrPriv-&gt;rotation;
-	rep.nSizes = pScrPriv-&gt;nSizesInUse;
-	rep.rate = pScrPriv-&gt;rate;
-        rep.nrateEnts = 0;
-	if (has_rate)
-	{
-	    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	    {
-		RRScreenSizePtr pSize = &amp;pScrPriv-&gt;pSizes[i];
-		if (pSize-&gt;referenced)
-		{
-		    rep.nrateEnts += (1 + pSize-&gt;nRatesInUse);
-		}
-	    }
-	}
-
-	if (pScrPriv-&gt;size &gt;= 0)
-	    rep.sizeID = pScrPriv-&gt;pSizes[pScrPriv-&gt;size].id;
-	else
-	    return BadImplementation;
-
-	extraLen = (rep.nSizes * sizeof (xScreenSizes) +
-		    rep.nrateEnts * sizeof (CARD16));
-
-	extra = (CARD8 *) xalloc (extraLen);
-	if (!extra)
-	    return BadAlloc;
-	/*
-	 * First comes the size information
-	 */
-	size = (xScreenSizes *) extra;
-	rates = (CARD16 *) (size + rep.nSizes);
-	for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	{
-	    RRScreenSizePtr pSize = &amp;pScrPriv-&gt;pSizes[i];
-	    if (pSize-&gt;referenced)
-	    {
-		size-&gt;widthInPixels = pSize-&gt;width;
-		size-&gt;heightInPixels = pSize-&gt;height;
-		size-&gt;widthInMillimeters = pSize-&gt;mmWidth;
-		size-&gt;heightInMillimeters = pSize-&gt;mmHeight;
-		if (client-&gt;swapped)
-		{
-		    swaps (&amp;size-&gt;widthInPixels, n);
-		    swaps (&amp;size-&gt;heightInPixels, n);
-		    swaps (&amp;size-&gt;widthInMillimeters, n);
-		    swaps (&amp;size-&gt;heightInMillimeters, n);
-		}
-		size++;
-		if (has_rate)
-		{
-		    *rates = pSize-&gt;nRatesInUse;
-		    if (client-&gt;swapped)
-		    {
-			swaps (rates, n);
-		    }
-		    rates++;
-		    for (j = 0; j &lt; pSize-&gt;nRates; j++)
-		    {
-			RRScreenRatePtr	pRate = &amp;pSize-&gt;pRates[j];
-			if (pRate-&gt;referenced)
-			{
-			    *rates = pRate-&gt;rate;
-			    if (client-&gt;swapped)
-			    {
-				swaps (rates, n);
-			    }
-			    rates++;
-			}
-		    }
-		}
-	    }
-	}
-	data8 = (CARD8 *) rates;
-
-	if (data8 - (CARD8 *) extra != extraLen)
-	    FatalError (&quot;RRGetScreenInfo bad extra len %d != %d\n&quot;,
-			data8 - (CARD8 *) extra, extraLen);
-	rep.length =  (extraLen + 3) &gt;&gt; 2;
-    }
-    if (client-&gt;swapped) {
-	swaps(&amp;rep.sequenceNumber, n);
-	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.timestamp, n);
-	swaps(&amp;rep.rotation, n);
-	swaps(&amp;rep.nSizes, n);
-	swaps(&amp;rep.sizeID, n);
-	swaps(&amp;rep.rate, n);
-	swaps(&amp;rep.nrateEnts, n);
-    }
-    WriteToClient(client, sizeof(xRRGetScreenInfoReply), (char *)&amp;rep);
-    if (extraLen)
-    {
-	WriteToClient (client, extraLen, (char *) extra);
-	xfree (extra);
-    }
-    return (client-&gt;noClientException);
-}
-
-static int
-ProcRRSetScreenConfig (ClientPtr client)
-{
-    REQUEST(xRRSetScreenConfigReq);
-    xRRSetScreenConfigReply rep;
-    DrawablePtr		    pDraw;
-    int			    n;
-    ScreenPtr		    pScreen;
-    rrScrPrivPtr	    pScrPriv;
-    TimeStamp		    configTime;
-    TimeStamp		    time;
-    RRScreenSizePtr	    pSize;
-    int			    i;
-    Rotation		    rotation;
-    int			    rate;
-    short		    oldWidth, oldHeight;
-    Bool		    has_rate;
-
-    UpdateCurrentTime ();
-
-    if (RRClientKnowsRates (client))
-    {
-	REQUEST_SIZE_MATCH (xRRSetScreenConfigReq);
-	has_rate = TRUE;
-    }
-    else
-    {
-	REQUEST_SIZE_MATCH (xRR1_0SetScreenConfigReq);
-	has_rate = FALSE;
-    }
-    
-    SECURITY_VERIFY_DRAWABLE(pDraw, stuff-&gt;drawable, client,
-			     SecurityWriteAccess);
-
-    pScreen = pDraw-&gt;pScreen;
-
-    pScrPriv= rrGetScrPriv(pScreen);
-    
-    time = ClientTimeToServerTime(stuff-&gt;timestamp);
-    configTime = ClientTimeToServerTime(stuff-&gt;configTimestamp);
-    
-    oldWidth = pScreen-&gt;width;
-    oldHeight = pScreen-&gt;height;
-    
-    if (!pScrPriv)
-    {
-	time = currentTime;
-	rep.status = RRSetConfigFailed;
-	goto sendReply;
-    }
-    if (!RRGetInfo (pScreen))
-	return BadAlloc;
-    
-    /*
-     * if the client's config timestamp is not the same as the last config
-     * timestamp, then the config information isn't up-to-date and
-     * can't even be validated
-     */
-    if (CompareTimeStamps (configTime, pScrPriv-&gt;lastConfigTime) != 0)
-    {
-	rep.status = RRSetConfigInvalidConfigTime;
-	goto sendReply;
-    }
-    
-    /*
-     * Search for the requested size
-     */
-    pSize = 0;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	if (pSize-&gt;referenced &amp;&amp; pSize-&gt;id == stuff-&gt;sizeID)
-	{
-	    break;
-	}
-    }
-    if (i == pScrPriv-&gt;nSizes)
-    {
-	/*
-	 * Invalid size ID
-	 */
-	client-&gt;errorValue = stuff-&gt;sizeID;
-	return BadValue;
-    }
-    
-    /*
-     * Validate requested rotation
-     */
-    rotation = (Rotation) stuff-&gt;rotation;
-
-    /* test the rotation bits only! */
-    switch (rotation &amp; 0xf) {
-    case RR_Rotate_0:
-    case RR_Rotate_90:
-    case RR_Rotate_180:
-    case RR_Rotate_270:
-	break;
-    default:
-	/*
-	 * Invalid rotation
-	 */
-	client-&gt;errorValue = stuff-&gt;rotation;
-	return BadValue;
-    }
-
-    if ((~pScrPriv-&gt;rotations) &amp; rotation)
-    {
-	/*
-	 * requested rotation or reflection not supported by screen
-	 */
-	client-&gt;errorValue = stuff-&gt;rotation;
-	return BadMatch;
-    }
-
-    /*
-     * Validate requested refresh
-     */
-    if (has_rate)
-	rate = (int) stuff-&gt;rate;
-    else
-	rate = 0;
-
-    if (rate)
-    {
-	for (i = 0; i &lt; pSize-&gt;nRates; i++)
-	{
-	    RRScreenRatePtr pRate = &amp;pSize-&gt;pRates[i];
-	    if (pRate-&gt;referenced &amp;&amp; pRate-&gt;rate == rate)
-		break;
-	}
-	if (i == pSize-&gt;nRates)
-	{
-	    /*
-	     * Invalid rate
-	     */
-	    client-&gt;errorValue = rate;
-	    return BadValue;
-	}
-    }
-    
-    /*
-     * Make sure the requested set-time is not older than
-     * the last set-time
-     */
-    if (CompareTimeStamps (time, pScrPriv-&gt;lastSetTime) &lt; 0)
-    {
-	rep.status = RRSetConfigInvalidTime;
-	goto sendReply;
-    }
-
-    /*
-     * call out to ddx routine to effect the change
-     */
-    if (!(*pScrPriv-&gt;rrSetConfig) (pScreen, rotation, rate,
-				   pSize))
-    {
-	/*
-	 * unknown DDX failure, report to client
-	 */
-	rep.status = RRSetConfigFailed;
-	goto sendReply;
-    }
-    
-    /*
-     * set current extension configuration pointers
-     */
-    RRSetCurrentConfig (pScreen, rotation, rate, pSize);
-    
-    /*
-     * Deliver ScreenChangeNotify events whenever
-     * the configuration is updated
-     */
-    WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    
-    /*
-     * Deliver ConfigureNotify events when root changes
-     * pixel size
-     */
-    if (oldWidth != pScreen-&gt;width || oldHeight != pScreen-&gt;height)
-	RRSendConfigNotify (pScreen);
-    RREditConnectionInfo (pScreen);
-    
-    /*
-     * Fix pointer bounds and location
-     */
-    ScreenRestructured (pScreen);
-    pScrPriv-&gt;lastSetTime = time;
-    
-    /*
-     * Report Success
-     */
-    rep.status = RRSetConfigSuccess;
-    
-sendReply:
-    
-    rep.type = X_Reply;
-    /* rep.status has already been filled in */
-    rep.length = 0;
-    rep.sequenceNumber = client-&gt;sequence;
-
-    rep.newTimestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-    rep.newConfigTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-    rep.root = WindowTable[pDraw-&gt;pScreen-&gt;myNum]-&gt;drawable.id;
-
-    if (client-&gt;swapped) 
-    {
-    	swaps(&amp;rep.sequenceNumber, n);
-    	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.newTimestamp, n);
-	swapl(&amp;rep.newConfigTimestamp, n);
-	swapl(&amp;rep.root, n);
-    }
-    WriteToClient(client, sizeof(xRRSetScreenConfigReply), (char *)&amp;rep);
-
-    return (client-&gt;noClientException);
-}
-
-static int
-ProcRRSelectInput (ClientPtr client)
-{
-    REQUEST(xRRSelectInputReq);
-    rrClientPriv(client);
-    RRTimesPtr	pTimes;
-    WindowPtr	pWin;
-    RREventPtr	pRREvent, pNewRREvent, *pHead;
-    XID		clientResource;
-
-    REQUEST_SIZE_MATCH(xRRSelectInputReq);
-    pWin = SecurityLookupWindow (stuff-&gt;window, client, SecurityWriteAccess);
-    if (!pWin)
-	return BadWindow;
-    pHead = (RREventPtr *)SecurityLookupIDByType(client,
-						 pWin-&gt;drawable.id, EventType,
-						 SecurityWriteAccess);
-
-    if (stuff-&gt;enable &amp; (RRScreenChangeNotifyMask)) 
-    {
-	ScreenPtr	pScreen = pWin-&gt;drawable.pScreen;
-	rrScrPriv	(pScreen);
-
-	if (pHead) 
-	{
-	    /* check for existing entry. */
-	    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next)
-		if (pRREvent-&gt;client == client)
-		    return Success;
-	}
-
-	/* build the entry */
-	pNewRREvent = (RREventPtr) xalloc (sizeof (RREventRec));
-	if (!pNewRREvent)
-	    return BadAlloc;
-	pNewRREvent-&gt;next = 0;
-	pNewRREvent-&gt;client = client;
-	pNewRREvent-&gt;window = pWin;
-	pNewRREvent-&gt;mask = stuff-&gt;enable;
-	/*
-	 * add a resource that will be deleted when
-	 * the client goes away
-	 */
-	clientResource = FakeClientID (client-&gt;index);
-	pNewRREvent-&gt;clientResource = clientResource;
-	if (!AddResource (clientResource, ClientType, (pointer)pNewRREvent))
-	    return BadAlloc;
-	/*
-	 * create a resource to contain a pointer to the list
-	 * of clients selecting input.  This must be indirect as
-	 * the list may be arbitrarily rearranged which cannot be
-	 * done through the resource database.
-	 */
-	if (!pHead)
-	{
-	    pHead = (RREventPtr *) xalloc (sizeof (RREventPtr));
-	    if (!pHead ||
-		!AddResource (pWin-&gt;drawable.id, EventType, (pointer)pHead))
-	    {
-		FreeResource (clientResource, RT_NONE);
-		return BadAlloc;
-	    }
-	    *pHead = 0;
-	}
-	pNewRREvent-&gt;next = *pHead;
-	*pHead = pNewRREvent;
-	/*
-	 * Now see if the client needs an event
-	 */
-	if (pScrPriv)
-	{
-	    pTimes = &amp;((RRTimesPtr) (pRRClient + 1))[pScreen-&gt;myNum];
-	    if (CompareTimeStamps (pTimes-&gt;setTime, 
-				   pScrPriv-&gt;lastSetTime) != 0 ||
-		CompareTimeStamps (pTimes-&gt;configTime, 
-				   pScrPriv-&gt;lastConfigTime) != 0)
-	    {
-		TellChanged (pWin, (pointer) pScreen);
-	    }
-	}
-    }
-    else if (stuff-&gt;enable == xFalse) 
-    {
-	/* delete the interest */
-	if (pHead) {
-	    pNewRREvent = 0;
-	    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next) {
-		if (pRREvent-&gt;client == client)
-		    break;
-		pNewRREvent = pRREvent;
-	    }
-	    if (pRREvent) {
-		FreeResource (pRREvent-&gt;clientResource, ClientType);
-		if (pNewRREvent)
-		    pNewRREvent-&gt;next = pRREvent-&gt;next;
-		else
-		    *pHead = pRREvent-&gt;next;
-		xfree (pRREvent);
-	    }
-	}
-    }
-    else 
-    {
-	client-&gt;errorValue = stuff-&gt;enable;
-	return BadValue;
-    }
-    return Success;
-}
-
-
-static int
-ProcRRDispatch (ClientPtr client)
-{
-    REQUEST(xReq);
-    switch (stuff-&gt;data)
-    {
-    case X_RRQueryVersion:
-	return ProcRRQueryVersion(client);
-    case X_RRSetScreenConfig:
-        return ProcRRSetScreenConfig(client);
-    case X_RRSelectInput:
-        return ProcRRSelectInput(client);
-    case X_RRGetScreenInfo:
-        return ProcRRGetScreenInfo(client);
-    default:
-	return BadRequest;
-    }
-}
-
-static int
-SProcRRQueryVersion (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRQueryVersionReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;majorVersion, n);
-    swapl(&amp;stuff-&gt;minorVersion, n);
-    return ProcRRQueryVersion(client);
-}
-
-static int
-SProcRRGetScreenInfo (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRGetScreenInfoReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;window, n);
-    return ProcRRGetScreenInfo(client);
-}
-
-static int
-SProcRRSetScreenConfig (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRSetScreenConfigReq);
-
-    if (RRClientKnowsRates (client))
-    {
-	REQUEST_SIZE_MATCH (xRRSetScreenConfigReq);
-	swaps (&amp;stuff-&gt;rate, n);
-    }
-    else
-    {
-	REQUEST_SIZE_MATCH (xRR1_0SetScreenConfigReq);
-    }
-    
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;drawable, n);
-    swapl(&amp;stuff-&gt;timestamp, n);
-    swaps(&amp;stuff-&gt;sizeID, n);
-    swaps(&amp;stuff-&gt;rotation, n);
-    return ProcRRSetScreenConfig(client);
-}
-
-static int
-SProcRRSelectInput (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRSelectInputReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;window, n);
-    return ProcRRSelectInput(client);
-}
-
-
-static int
-SProcRRDispatch (ClientPtr client)
-{
-    REQUEST(xReq);
-    switch (stuff-&gt;data)
-    {
-    case X_RRQueryVersion:
-	return SProcRRQueryVersion(client);
-    case X_RRSetScreenConfig:
-        return SProcRRSetScreenConfig(client);
-    case X_RRSelectInput:
-        return SProcRRSelectInput(client);
-    case X_RRGetScreenInfo:
-        return SProcRRGetScreenInfo(client);
-    default:
-	return BadRequest;
-    }
-}
-
-
-static Bool
-RRScreenSizeMatches (RRScreenSizePtr  a,
-		   RRScreenSizePtr  b)
-{
-    if (a-&gt;width != b-&gt;width)
-	return FALSE;
-    if (a-&gt;height != b-&gt;height)
-	return FALSE;
-    if (a-&gt;mmWidth != b-&gt;mmWidth)
-	return FALSE;
-    if (a-&gt;mmHeight != b-&gt;mmHeight)
-	return FALSE;
-    return TRUE;
-}
-
-RRScreenSizePtr
-RRRegisterSize (ScreenPtr	    pScreen,
-		short		    width, 
-		short		    height,
-		short		    mmWidth,
-		short		    mmHeight)
-{
-    rrScrPriv (pScreen);
-    int		    i;
-    RRScreenSize    tmp;
-    RRScreenSizePtr pNew;
-
-    if (!pScrPriv)
-	return 0;
-    
-    tmp.width = width;
-    tmp.height= height;
-    tmp.mmWidth = mmWidth;
-    tmp.mmHeight = mmHeight;
-    tmp.pRates = 0;
-    tmp.nRates = 0;
-    tmp.nRatesInUse = 0;
-    tmp.referenced = TRUE;
-    tmp.oldReferenced = FALSE;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	if (RRScreenSizeMatches (&amp;tmp, &amp;pScrPriv-&gt;pSizes[i]))
-	{
-	    pScrPriv-&gt;pSizes[i].referenced = TRUE;
-	    return &amp;pScrPriv-&gt;pSizes[i];
-	}
-    pNew = xrealloc (pScrPriv-&gt;pSizes,
-		     (pScrPriv-&gt;nSizes + 1) * sizeof (RRScreenSize));
-    if (!pNew)
-	return 0;
-    pNew[pScrPriv-&gt;nSizes++] = tmp;
-    pScrPriv-&gt;pSizes = pNew;
-    return &amp;pNew[pScrPriv-&gt;nSizes-1];
-}
-
-Bool RRRegisterRate (ScreenPtr		pScreen,
-		     RRScreenSizePtr	pSize,
-		     int		rate)
-{
-    rrScrPriv(pScreen);
-    int		    i;
-    RRScreenRatePtr pNew, pRate;
-
-    if (!pScrPriv)
-	return FALSE;
-    
-    for (i = 0; i &lt; pSize-&gt;nRates; i++)
-    {
-	pRate = &amp;pSize-&gt;pRates[i];
-	if (pRate-&gt;rate == rate)
-	{
-	    pRate-&gt;referenced = TRUE;
-	    return TRUE;
-	}
-    }
-
-    pNew = xrealloc (pSize-&gt;pRates,
-		     (pSize-&gt;nRates + 1) * sizeof (RRScreenRate));
-    if (!pNew)
-	return FALSE;
-    pRate = &amp;pNew[pSize-&gt;nRates++];
-    pRate-&gt;rate = rate;
-    pRate-&gt;referenced = TRUE;
-    pRate-&gt;oldReferenced = FALSE;
-    pSize-&gt;pRates = pNew;
-    return TRUE;
-}
-
-void
-RRSetCurrentConfig (ScreenPtr		pScreen,
-		    Rotation		rotation,
-		    int			rate,
-		    RRScreenSizePtr	pSize)
-{
-    rrScrPriv (pScreen);
-
-    if (!pScrPriv)
-	return;
-
-    pScrPriv-&gt;rotation = rotation;
-    pScrPriv-&gt;size = pSize - pScrPriv-&gt;pSizes;
-    pScrPriv-&gt;rate = rate;
-}
diff --git a/nx-X11/programs/Xserver/hw/nxagent/Reconnect.c b/nx-X11/programs/Xserver/hw/nxagent/Reconnect.c
index b786602..90b8079 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/Reconnect.c
+++ b/nx-X11/programs/Xserver/hw/nxagent/Reconnect.c
@@ -598,7 +598,8 @@ Bool nxagentReconnectSession(void)
 
   if (nxagentResizeDesktopAtStartup || nxagentOption(Rootless) == True)
   {
-    nxagentRRSetScreenConfig(nxagentDefaultScreen, nxagentOption(RootWidth), nxagentOption(RootHeight));
+    nxagentChangeScreenConfig(0, nxagentOption(RootWidth),
+                                  nxagentOption(RootHeight), 0, 0);
 
     nxagentResizeDesktopAtStartup = False;
   }
diff --git a/nx-X11/programs/Xserver/hw/nxagent/Screen.c b/nx-X11/programs/Xserver/hw/nxagent/Screen.c
index 0a0d409..b847b08 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/Screen.c
+++ b/nx-X11/programs/Xserver/hw/nxagent/Screen.c
@@ -2120,8 +2120,8 @@ static void nxagentSetRootClip (ScreenPtr pScreen, Bool enable)
         if (anyMarked)
             (*pScreen-&gt;ValidateTree)(pWin, NullWindow, VTOther);
     }
-    
-    if (pWin-&gt;backStorage &amp;&amp;
+
+    if (pWin-&gt;backStorage &amp;&amp; pOldClip &amp;&amp;
         ((pWin-&gt;backingStore == Always) || WasViewable))
     {
         if (!WasViewable)
@@ -2266,6 +2266,52 @@ FIXME: We should try to restore the previously
   nxagentChangeOption(ViewportYSpan, nxagentOption(Height) - nxagentOption(RootHeight));
 
   /*
+   * Change agent window size and size hints.
+   */
+
+  if ((nxagentOption(Fullscreen) == 0 &amp;&amp; nxagentOption(AllScreens) == 0))
+  {
+    sizeHints.flags = PPosition | PMinSize | PMaxSize;
+    sizeHints.x = nxagentOption(X);
+    sizeHints.y = nxagentOption(Y);
+
+    sizeHints.min_width = MIN_NXAGENT_WIDTH;
+    sizeHints.min_height = MIN_NXAGENT_HEIGHT;
+    sizeHints.width = width;
+    sizeHints.height = height;
+
+    if (nxagentOption(DesktopResize) == 1)
+    {
+      sizeHints.max_width = WidthOfScreen(DefaultScreenOfDisplay(nxagentDisplay));
+      sizeHints.max_height = HeightOfScreen(DefaultScreenOfDisplay(nxagentDisplay));
+    }
+    else
+    {
+      sizeHints.max_width = nxagentOption(RootWidth);
+      sizeHints.max_height = nxagentOption(RootHeight);
+    }
+
+    if (nxagentUserGeometry.flag &amp; XValue || nxagentUserGeometry.flag &amp; YValue)
+    {
+      sizeHints.flags |= USPosition;
+    }
+
+    if (nxagentUserGeometry.flag &amp; WidthValue || nxagentUserGeometry.flag &amp; HeightValue)
+    {
+      sizeHints.flags |= USSize;
+    }
+
+    XSetWMNormalHints(nxagentDisplay, nxagentDefaultWindows[pScreen-&gt;myNum], &amp;sizeHints);
+
+    XResizeWindow(nxagentDisplay, nxagentDefaultWindows[pScreen-&gt;myNum], width, height);
+
+    if (nxagentOption(Rootless) == 0)
+    {
+      XResizeWindow(nxagentDisplay, nxagentInputWindows[pScreen -&gt; myNum], width, height);
+    }
+  }
+
+  /*
    * Set properties for the agent root window.
    */
 
@@ -2654,9 +2700,12 @@ int nxagentShadowInit(ScreenPtr pScreen, WindowPtr pWin)
 
   nxagentShadowCreateMainWindow(pScreen, pWin, nxagentShadowWidth, nxagentShadowHeight);
 
-  nxagentShadowSetWindowsSize();
+  if (nxagentRemoteMajor &lt;= 3)
+  {
+    nxagentShadowSetWindowsSize();
 
-  nxagentSetWMNormalHints(0);
+    nxagentSetWMNormalHints(0);
+  }
 
   XMapWindow(nxagentDisplay, nxagentDefaultWindows[0]);
 
@@ -3453,118 +3502,123 @@ Bool nxagentReconnectScreen(void *p0)
   return True;  
 }
 
-int nxagentRRSetScreenConfig(ScreenPtr pScreen, int width, int height)
-{
-    rrScrPrivPtr pScrPriv;
-    RRScreenSizePtr pSize;
-    Rotation rotation;
-    int rate;
-    short oldWidth, oldHeight;
-    int  mmWidth, mmHeight;
-    int oldSize;
-    RRScreenSizePtr oldSizes;
+RRModePtr    nxagentRRCustomMode = NULL;
 
-    pScrPriv = rrGetScrPriv(pScreen);
+int nxagentChangeScreenConfig(int screen, int width, int height, int mmWidth, int mmHeight)
+{
+  ScreenPtr    pScreen;
+  rrScrPrivPtr pScrPriv;
+  RROutputPtr  output;
+  RRCrtcPtr    crtc;
+  RRModePtr    mode;
+  xRRModeInfo  modeInfo;
+  char         name[100];
+  int          r, c, m;
+  int          refresh = 60;
+  int          doNotify = 1;
+
+  if (WindowTable[screen] == NULL)
+  {
+    return 0;
+  }
 
-    oldWidth = pScreen-&gt;width;
-    oldHeight = pScreen-&gt;height;
+  UpdateCurrentTime();
 
-    if (!pScrPriv)
-    {
-      return 1;
-    }
+  if (nxagentGrabServerInfo.grabstate == SERVER_GRABBED)
+  {
+    /*
+     * If any client grabbed the server it won't expect that screen
+     * configuration changes until it releases the grab. That could
+     * get an X error because available modes are chanded meanwhile.
+     */
 
-    if (!RRGetInfo (pScreen))
-    {
-      return 1;
-    }
+    #ifdef TEST
+    fprintf(stderr, &quot;nxagentChangeScreenConfig: Cancel with grabbed server.\n&quot;);
+    #endif
 
-    rotation = RR_Rotate_0;
+    return 0;
+  }
 
-    rate = 0;
+  pScreen = WindowTable[screen] -&gt; drawable.pScreen;
 
-    mmWidth  = (width * 254 + monitorResolution * 5) / (monitorResolution * 10);
+  #ifdef TEST
+  fprintf(stderr, &quot;nxagentChangeScreenConfig: Changing config to %dx%d.\n&quot;, width, height);
+  #endif
 
-    if (mmWidth &lt; 1)
-    {
-      mmWidth = 1;
-    }
+  r = nxagentResizeScreen(pScreen, width, height, mmWidth, mmHeight);
 
-    mmHeight = (height * 254 + monitorResolution * 5) / (monitorResolution * 10);
+  if (r != 0)
+  {
+    pScrPriv = rrGetScrPriv(pScreen);
 
-    if (mmHeight &lt; 1)
+    if (pScrPriv)
     {
-      mmHeight = 1;
-    }
-
-    pSize = xalloc(sizeof(RRScreenSize));
-
-    pSize -&gt; width = width;
-    pSize -&gt; height = height;
-    pSize -&gt; mmWidth = mmWidth;
-    pSize -&gt; mmHeight = mmHeight;
+      output = RRFirstOutput(pScreen);
 
-    /*
-     * call out to ddx routine to effect the change
-     */
-
-    if (!(*pScrPriv-&gt;rrSetConfig) (pScreen, rotation, rate,
-                                       pSize))
-    {
-      /*
-       * unknown DDX failure.
-       */
+      if (output &amp;&amp; output -&gt; crtc)
+      {
+        crtc = output -&gt; crtc;
 
-      xfree(pSize);
+        for (c = 0; c &lt; pScrPriv -&gt; numCrtcs; c++)
+        {
+          RRCrtcSet(pScrPriv -&gt; crtcs[c], NULL, 0, 0, RR_Rotate_0, 0, NULL);
+        }
 
-      return 1;
-    }
+        memset(&amp;modeInfo, '\0', sizeof(modeInfo));
+        sprintf(name, &quot;%dx%d&quot;, width, height);
 
-    /*
-     * TellChanged uses this privates.
-     */
+        modeInfo.width  = width;
+        modeInfo.height = height;
+        modeInfo.hTotal = width;
+        modeInfo.vTotal = height;
+        modeInfo.dotClock = ((CARD32) width * (CARD32) height *
+                                (CARD32) refresh);
+        modeInfo.nameLength = strlen(name);
 
-    oldSize = pScrPriv-&gt;size;
-    oldSizes = pScrPriv-&gt;pSizes;
+        if (nxagentRRCustomMode != NULL)
+        {
+          RROutputDeleteUserMode(output, nxagentRRCustomMode);
+          FreeResource(nxagentRRCustomMode -&gt; mode.id, 0);
 
-    pScrPriv-&gt;size = 0;
-    pScrPriv-&gt;pSizes = pSize;
+          if (crtc != NULL &amp;&amp; crtc -&gt; mode == nxagentRRCustomMode)
+          {
+            RRCrtcSet(crtc, NULL, 0, 0, RR_Rotate_0, 0, NULL);
+          }
 
-    /*
-     * Deliver ScreenChangeNotify events whenever
-     * the configuration is updated
-     */
+          #ifdef TEST
+          fprintf(stderr, &quot;nxagentChangeScreenConfig: &quot;
+                      &quot;Going to destroy mode %p with refcnt %d.\n&quot;,
+                          nxagentRRCustomMode, nxagentRRCustomMode-&gt;refcnt);
+          #endif
 
-    WalkTree (pScreen, TellChanged, (pointer) pScreen);
+          RRModeDestroy(nxagentRRCustomMode);
+        }
 
-    /*
-     * Deliver ConfigureNotify events when root changes
-     * pixel size
-     */
+        nxagentRRCustomMode = RRModeGet(&amp;modeInfo, name);
 
-    if (oldWidth != pScreen-&gt;width || oldHeight != pScreen-&gt;height)
-    {
-      RRSendConfigNotify (pScreen);
-    }
+        RROutputAddUserMode(output, nxagentRRCustomMode);
 
-    RREditConnectionInfo (pScreen);
+        RRCrtcSet(crtc, nxagentRRCustomMode, 0, 0, RR_Rotate_0, 1, &amp;output);
 
-    /*
-     * Fix pointer bounds and location
-     */
+        RROutputChanged(output, 1);
 
-    ScreenRestructured (pScreen);
+        doNotify = 0;
+      }
 
-    /*
-     * Restore old privates.
-     */
+      pScrPriv -&gt; lastSetTime = currentTime;
 
-    pScrPriv-&gt;pSizes = oldSizes;
-    pScrPriv-&gt;size = oldSize;
+      pScrPriv-&gt;changed = 1;
+      pScrPriv-&gt;configChanged = 1;
+    }
 
-    xfree(pSize);
+    if (doNotify
+)
+    {
+      RRScreenSizeNotify(pScreen);
+    }
+  }
 
-    return 0;
+  return r;
 }
 
 void nxagentSaveAreas(PixmapPtr pPixmap, RegionPtr prgnSave, int xorg, int yorg, WindowPtr pWin)
diff --git a/nx-X11/programs/Xserver/hw/nxagent/Screen.h b/nx-X11/programs/Xserver/hw/nxagent/Screen.h
index 5b19577..aab3ba1 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/Screen.h
+++ b/nx-X11/programs/Xserver/hw/nxagent/Screen.h
@@ -100,7 +100,7 @@ Bool nxagentMagicPixelZone(int x, int y);
 Bool nxagentResizeScreen(ScreenPtr pScreen, int width, int height,
                              int mmWidth, int mmHeight);
 
-int nxagentRRSetScreenConfig(ScreenPtr pScreen, int width, int height);
+int nxagentChangeScreenConfig(int screen, int width, int height, int mmWidth, int mmHeight);
 
 extern Bool nxagentReconnectScreen(void *p0);
 
diff --git a/nx-X11/programs/Xserver/hw/nxagent/Window.c b/nx-X11/programs/Xserver/hw/nxagent/Window.c
index 3e6d41d..9881936 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/Window.c
+++ b/nx-X11/programs/Xserver/hw/nxagent/Window.c
@@ -899,8 +899,8 @@ void nxagentSwitchAllScreens(ScreenPtr pScreen, Bool switchOn)
       {
         if (nxagentOption(Shadow) == 0)
         {
-          nxagentRRSetScreenConfig(pScreen, WidthOfScreen(DefaultScreenOfDisplay(nxagentDisplay)),
-                                       HeightOfScreen(DefaultScreenOfDisplay(nxagentDisplay)));
+          nxagentChangeScreenConfig(0, WidthOfScreen(DefaultScreenOfDisplay(nxagentDisplay)),
+                                        HeightOfScreen(DefaultScreenOfDisplay(nxagentDisplay)), 0, 0);
         }
         else
         {
@@ -953,7 +953,8 @@ void nxagentSwitchAllScreens(ScreenPtr pScreen, Bool switchOn)
 
       if (nxagentOption(Shadow) == 0)
       {
-        nxagentRRSetScreenConfig(pScreen, nxagentOption(RootWidth), nxagentOption(RootHeight));
+        nxagentChangeScreenConfig(0, nxagentOption(RootWidth),
+                                      nxagentOption(RootHeight), 0, 0);
       }
     }
 
diff --git a/nx-X11/programs/Xserver/hw/nxagent/X/NXdixfonts.c b/nx-X11/programs/Xserver/hw/nxagent/X/NXdixfonts.c
index 04fc047..3234c99 100644
--- a/nx-X11/programs/Xserver/hw/nxagent/X/NXdixfonts.c
+++ b/nx-X11/programs/Xserver/hw/nxagent/X/NXdixfonts.c
@@ -148,7 +148,8 @@ static const char *_NXGetFontPath(const char *path)
 
 _NXGetFontPathError:
 
-    strcpy(_NXFontPath, path);
+    strncpy(_NXFontPath, path, 1023);
+    _NXFontPath[1023] = '\0';
 
 #ifdef NX_TRANS_TEST
     fprintf(stderr, &quot;_NXGetFontPath: Using default font path [%s].\n&quot;, _NXFontPath);
diff --git a/nx-X11/programs/Xserver/hw/nxagent/X/NXrandr.c b/nx-X11/programs/Xserver/hw/nxagent/X/NXrandr.c
deleted file mode 100644
index 5f460f2..0000000
--- a/nx-X11/programs/Xserver/hw/nxagent/X/NXrandr.c
+++ /dev/null
@@ -1,1344 +0,0 @@
-/**************************************************************************/
-/*                                                                        */
-/* Copyright (c) 2001, 2011 NoMachine, <A HREF="http://www.nomachine.com/.">http://www.nomachine.com/.</A>         */
-/*                                                                        */
-/* NXAGENT, NX protocol compression and NX extensions to this software    */
-/* are copyright of NoMachine. Redistribution and use of the present      */
-/* software is allowed according to terms specified in the file LICENSE   */
-/* which comes in the source distribution.                                */
-/*                                                                        */
-/* Check <A HREF="http://www.nomachine.com/licensing.html">http://www.nomachine.com/licensing.html</A> for applicability.       */
-/*                                                                        */
-/* NX and NoMachine are trademarks of Medialogic S.p.A.                   */
-/*                                                                        */
-/* All rights reserved.                                                   */
-/*                                                                        */
-/**************************************************************************/
-
-/*
- * $XFree86: xc/programs/Xserver/randr/randr.c,v 1.21tsi Exp $
- *
- * Copyright &#194;&#169; 2000, Compaq Computer Corporation, 
- * Copyright &#194;&#169; 2002, Hewlett Packard, Inc.
- *
- * Permission to use, copy, modify, distribute, and sell this software and its
- * documentation for any purpose is hereby granted without fee, provided that
- * the above copyright notice appear in all copies and that both that
- * copyright notice and this permission notice appear in supporting
- * documentation, and that the name of Compaq or HP not be used in advertising
- * or publicity pertaining to distribution of the software without specific,
- * written prior permission.  HP makes no representations about the
- * suitability of this software for any purpose.  It is provided &quot;as is&quot;
- * without express or implied warranty.
- *
- * HP DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL HP
- * BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
- * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
- * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN 
- * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
- *
- * Author:  Jim Gettys, HP Labs, Hewlett-Packard, Inc.
- */
-
-
-#define NEED_REPLIES
-#define NEED_EVENTS
-#ifdef HAVE_DIX_CONFIG_H
-#include &lt;dix-config.h&gt;
-#endif
-
-#include &lt;X11/X.h&gt;
-#include &lt;X11/Xproto.h&gt;
-#include &quot;misc.h&quot;
-#include &quot;os.h&quot;
-#include &quot;dixstruct.h&quot;
-#include &quot;resource.h&quot;
-#include &quot;scrnintstr.h&quot;
-#include &quot;windowstr.h&quot;
-#include &quot;pixmapstr.h&quot;
-#include &quot;extnsionst.h&quot;
-#include &quot;servermd.h&quot;
-#include &lt;X11/extensions/randr.h&gt;
-#include &lt;X11/extensions/randrproto.h&gt;
-#include &quot;../../randr/randrstr.h&quot;
-#ifdef RENDER
-#include &lt;X11/extensions/render.h&gt; 	/* we share subpixel order information */
-#include &quot;picturestr.h&quot;
-#endif
-#include &lt;X11/Xfuncproto.h&gt;
-#ifdef EXTMODULE
-#include &quot;xf86_ansic.h&quot;
-#endif
-
-/* From render.h */
-#ifndef SubPixelUnknown
-#define SubPixelUnknown 0
-#endif
-
-#define RR_VALIDATE
-int	RRGeneration;
-int	RRNScreens;
-
-static int ProcRRQueryVersion (ClientPtr pClient);
-static int ProcRRDispatch (ClientPtr pClient);
-static int SProcRRDispatch (ClientPtr pClient);
-static int SProcRRQueryVersion (ClientPtr pClient);
-
-#define wrap(priv,real,mem,func) {\
-    priv-&gt;mem = real-&gt;mem; \
-    real-&gt;mem = func; \
-}
-
-#define unwrap(priv,real,mem) {\
-    real-&gt;mem = priv-&gt;mem; \
-}
-
-#if 0
-static CARD8	RRReqCode;
-static int	RRErrBase;
-#endif
-static int	RREventBase;
-static RESTYPE ClientType, EventType; /* resource types for event masks */
-static int	RRClientPrivateIndex;
-
-typedef struct _RRTimes {
-    TimeStamp	setTime;
-    TimeStamp	configTime;
-} RRTimesRec, *RRTimesPtr;
-
-typedef struct _RRClient {
-    int		major_version;
-    int		minor_version;
-/*  RRTimesRec	times[0]; */
-} RRClientRec, *RRClientPtr;
-
-/*
- * each window has a list of clients requesting
- * RRNotify events.  Each client has a resource
- * for each window it selects RRNotify input for,
- * this resource is used to delete the RRNotifyRec
- * entry from the per-window queue.
- */
-
-typedef struct _RREvent *RREventPtr;
-
-typedef struct _RREvent {
-    RREventPtr  next;
-    ClientPtr	client;
-    WindowPtr	window;
-    XID		clientResource;
-    int		mask;
-} RREventRec;
-
-int	rrPrivIndex = -1;
-
-#define GetRRClient(pClient)    ((RRClientPtr) (pClient)-&gt;devPrivates[RRClientPrivateIndex].ptr)
-#define rrClientPriv(pClient)	RRClientPtr pRRClient = GetRRClient(pClient)
-
-static Bool
-RRClientKnowsRates (ClientPtr	pClient)
-{
-    rrClientPriv(pClient);
-
-    return (pRRClient-&gt;major_version &gt; 1 ||
-	    (pRRClient-&gt;major_version == 1 &amp;&amp; pRRClient-&gt;minor_version &gt;= 1));
-}
-
-static void
-RRClientCallback (CallbackListPtr	*list,
-		  pointer		closure,
-		  pointer		data)
-{
-    NewClientInfoRec	*clientinfo = (NewClientInfoRec *) data;
-    ClientPtr		pClient = clientinfo-&gt;client;
-    rrClientPriv(pClient);
-    RRTimesPtr		pTimes = (RRTimesPtr) (pRRClient + 1);
-    int			i;
-
-    pRRClient-&gt;major_version = 0;
-    pRRClient-&gt;minor_version = 0;
-    for (i = 0; i &lt; screenInfo.numScreens; i++)
-    {
-	ScreenPtr   pScreen = screenInfo.screens[i];
-	rrScrPriv(pScreen);
-
-	if (pScrPriv)
-	{
-	    pTimes[i].setTime = pScrPriv-&gt;lastSetTime;
-	    pTimes[i].configTime = pScrPriv-&gt;lastConfigTime;
-	}
-    }
-}
-
-static void
-RRResetProc (ExtensionEntry *extEntry)
-{
-}
-    
-static Bool
-RRCloseScreen (int i, ScreenPtr pScreen)
-{
-    rrScrPriv(pScreen);
-
-    unwrap (pScrPriv, pScreen, CloseScreen);
-    if (pScrPriv-&gt;pSizes)
-	xfree (pScrPriv-&gt;pSizes);
-    xfree (pScrPriv);
-    RRNScreens -= 1;	/* ok, one fewer screen with RandR running */
-    return (*pScreen-&gt;CloseScreen) (i, pScreen);    
-}
-
-static void
-SRRScreenChangeNotifyEvent(xRRScreenChangeNotifyEvent *from,
-			   xRRScreenChangeNotifyEvent *to)
-{
-    to-&gt;type = from-&gt;type;
-    to-&gt;rotation = from-&gt;rotation;
-    cpswaps(from-&gt;sequenceNumber, to-&gt;sequenceNumber);
-    cpswapl(from-&gt;timestamp, to-&gt;timestamp);
-    cpswapl(from-&gt;configTimestamp, to-&gt;configTimestamp);
-    cpswapl(from-&gt;root, to-&gt;root);
-    cpswapl(from-&gt;window, to-&gt;window);
-    cpswaps(from-&gt;sizeID, to-&gt;sizeID);
-    cpswaps(from-&gt;widthInPixels, to-&gt;widthInPixels);
-    cpswaps(from-&gt;heightInPixels, to-&gt;heightInPixels);
-    cpswaps(from-&gt;widthInMillimeters, to-&gt;widthInMillimeters);
-    cpswaps(from-&gt;heightInMillimeters, to-&gt;heightInMillimeters);
-    cpswaps(from-&gt;subpixelOrder, to-&gt;subpixelOrder);
-}
-
-Bool RRScreenInit(ScreenPtr pScreen)
-{
-    rrScrPrivPtr   pScrPriv;
-
-    if (RRGeneration != serverGeneration)
-    {
-	if ((rrPrivIndex = AllocateScreenPrivateIndex()) &lt; 0)
-	    return FALSE;
-	RRGeneration = serverGeneration;
-    }
-
-    pScrPriv = (rrScrPrivPtr) xalloc (sizeof (rrScrPrivRec));
-    if (!pScrPriv)
-	return FALSE;
-
-    SetRRScreen(pScreen, pScrPriv);
-
-    /*
-     * Calling function best set these function vectors
-     */
-    pScrPriv-&gt;rrSetConfig = 0;
-    pScrPriv-&gt;rrGetInfo = 0;
-    /*
-     * This value doesn't really matter -- any client must call
-     * GetScreenInfo before reading it which will automatically update
-     * the time
-     */
-    pScrPriv-&gt;lastSetTime = currentTime;
-    pScrPriv-&gt;lastConfigTime = currentTime;
-    
-    wrap (pScrPriv, pScreen, CloseScreen, RRCloseScreen);
-
-    pScrPriv-&gt;rotations = RR_Rotate_0;
-    
-    pScrPriv-&gt;nSizes = 0;
-    pScrPriv-&gt;nSizesInUse = 0;
-    pScrPriv-&gt;pSizes = 0;
-    
-    pScrPriv-&gt;rotation = RR_Rotate_0;
-    pScrPriv-&gt;size = -1;
-    
-    RRNScreens += 1;	/* keep count of screens that implement randr */
-    return TRUE;
-}
-
-/*ARGSUSED*/
-static int
-RRFreeClient (pointer data, XID id)
-{
-    RREventPtr   pRREvent;
-    WindowPtr	    pWin;
-    RREventPtr   *pHead, pCur, pPrev;
-
-    pRREvent = (RREventPtr) data;
-    pWin = pRREvent-&gt;window;
-    pHead = (RREventPtr *) LookupIDByType(pWin-&gt;drawable.id, EventType);
-    if (pHead) {
-	pPrev = 0;
-	for (pCur = *pHead; pCur &amp;&amp; pCur != pRREvent; pCur=pCur-&gt;next)
-	    pPrev = pCur;
-	if (pCur)
-	{
-	    if (pPrev)
-	    	pPrev-&gt;next = pRREvent-&gt;next;
-	    else
-	    	*pHead = pRREvent-&gt;next;
-	}
-    }
-    xfree ((pointer) pRREvent);
-    return 1;
-}
-
-/*ARGSUSED*/
-static int
-RRFreeEvents (pointer data, XID id)
-{
-    RREventPtr   *pHead, pCur, pNext;
-
-    pHead = (RREventPtr *) data;
-    for (pCur = *pHead; pCur; pCur = pNext) {
-	pNext = pCur-&gt;next;
-	FreeResource (pCur-&gt;clientResource, ClientType);
-	xfree ((pointer) pCur);
-    }
-    xfree ((pointer) pHead);
-    return 1;
-}
-
-void
-RRExtensionInit (void)
-{
-    ExtensionEntry *extEntry;
-
-    if (RRNScreens == 0) return;
-
-    RRClientPrivateIndex = AllocateClientPrivateIndex ();
-    if (!AllocateClientPrivate (RRClientPrivateIndex,
-				sizeof (RRClientRec) +
-				screenInfo.numScreens * sizeof (RRTimesRec)))
-	return;
-    if (!AddCallback (&amp;ClientStateCallback, RRClientCallback, 0))
-	return;
-
-    ClientType = CreateNewResourceType(RRFreeClient);
-    if (!ClientType)
-	return;
-    EventType = CreateNewResourceType(RRFreeEvents);
-    if (!EventType)
-	return;
-    extEntry = AddExtension (RANDR_NAME, RRNumberEvents, RRNumberErrors,
-			     ProcRRDispatch, SProcRRDispatch,
-			     RRResetProc, StandardMinorOpcode);
-    if (!extEntry)
-	return;
-#if 0
-    RRReqCode = (CARD8) extEntry-&gt;base;
-    RRErrBase = extEntry-&gt;errorBase;
-#endif
-    RREventBase = extEntry-&gt;eventBase;
-    EventSwapVector[RREventBase + RRScreenChangeNotify] = (EventSwapPtr) 
-      SRRScreenChangeNotifyEvent;
-
-    return;
-}
-		
-int
-TellChanged (WindowPtr pWin, pointer value)
-{
-    RREventPtr			*pHead, pRREvent;
-    ClientPtr			client;
-    xRRScreenChangeNotifyEvent	se;
-    ScreenPtr			pScreen = pWin-&gt;drawable.pScreen;
-    rrScrPriv(pScreen);
-    RRScreenSizePtr		pSize;
-    WindowPtr			pRoot = WindowTable[pScreen-&gt;myNum];
-
-    pHead = (RREventPtr *) LookupIDByType (pWin-&gt;drawable.id, EventType);
-    if (!pHead)
-	return WT_WALKCHILDREN;
-
-    se.type = RRScreenChangeNotify + RREventBase;
-    se.rotation = (CARD8) pScrPriv-&gt;rotation;
-    se.timestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-    se.configTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-    se.root =  pRoot-&gt;drawable.id;
-    se.window = pWin-&gt;drawable.id;
-#ifdef RENDER
-    se.subpixelOrder = PictureGetSubpixelOrder (pScreen);
-#else
-    se.subpixelOrder = SubPixelUnknown;
-#endif
-    if (pScrPriv-&gt;size &gt;= 0)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[pScrPriv-&gt;size];
-	se.sizeID = pSize-&gt;id;
-	se.widthInPixels = pSize-&gt;width;
-	se.heightInPixels = pSize-&gt;height;
-	se.widthInMillimeters = pSize-&gt;mmWidth;
-	se.heightInMillimeters = pSize-&gt;mmHeight;
-    }
-    else
-    {
-	/*
-	 * This &quot;shouldn't happen&quot;, but a broken DDX can
-	 * forget to set the current configuration on GetInfo
-	 */
-	se.sizeID = 0xffff;
-	se.widthInPixels = 0;
-	se.heightInPixels = 0;
-	se.widthInMillimeters = 0;
-	se.heightInMillimeters = 0;
-    }    
-    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next) 
-    {
-	client = pRREvent-&gt;client;
-	if (client == serverClient || client-&gt;clientGone)
-	    continue;
-	se.sequenceNumber = client-&gt;sequence;
-	if(pRREvent-&gt;mask &amp; RRScreenChangeNotifyMask)
-	  WriteEventsToClient (client, 1, (xEvent *) &amp;se);
-    }
-    return WT_WALKCHILDREN;
-}
-
-Bool
-RRGetInfo (ScreenPtr pScreen)
-{
-    rrScrPriv (pScreen);
-    int		    i, j, k, l;
-    Bool	    changed;
-    Rotation	    rotations;
-    RRScreenSizePtr pSize;
-    RRScreenRatePtr pRate;
-
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	pSize-&gt;oldReferenced = pSize-&gt;referenced;
-	pSize-&gt;referenced = FALSE;
-	for (k = 0; k &lt; pSize-&gt;nRates; k++)
-	{
-	    pRate = &amp;pSize-&gt;pRates[k];
-	    pRate-&gt;oldReferenced = pRate-&gt;referenced;
-	    pRate-&gt;referenced = FALSE;
-	}
-    }
-    if (!(*pScrPriv-&gt;rrGetInfo) (pScreen, &amp;rotations))
-	return FALSE;
-
-    changed = FALSE;
-
-    /*
-     * Check whether anything changed and simultaneously generate
-     * the protocol id values for the objects
-     */
-    if (rotations != pScrPriv-&gt;rotations)
-    {
-	pScrPriv-&gt;rotations = rotations;
-	changed = TRUE;
-    }
-
-    j = 0;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	if (pSize-&gt;oldReferenced != pSize-&gt;referenced)
-	    changed = TRUE;
-	if (pSize-&gt;referenced)
-	    pSize-&gt;id = j++;
-	l = 0;
-	for (k = 0; k &lt; pSize-&gt;nRates; k++)
-	{
-	    pRate = &amp;pSize-&gt;pRates[k];
-	    if (pRate-&gt;oldReferenced != pRate-&gt;referenced)
-		changed = TRUE;
-	    if (pRate-&gt;referenced)
-		l++;
-	}
-	pSize-&gt;nRatesInUse = l;
-    }
-    pScrPriv-&gt;nSizesInUse = j;
-    if (changed)
-    {
-	UpdateCurrentTime ();
-	pScrPriv-&gt;lastConfigTime = currentTime;
-	WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    }
-    return TRUE;
-}
-
-void
-RRSendConfigNotify (ScreenPtr pScreen)
-{
-    WindowPtr	pWin = WindowTable[pScreen-&gt;myNum];
-    xEvent	event;
-
-    event.u.u.type = ConfigureNotify;
-    event.u.configureNotify.window = pWin-&gt;drawable.id;
-    event.u.configureNotify.aboveSibling = None;
-    event.u.configureNotify.x = 0;
-    event.u.configureNotify.y = 0;
-
-    /* XXX xinerama stuff ? */
-    
-    event.u.configureNotify.width = pWin-&gt;drawable.width;
-    event.u.configureNotify.height = pWin-&gt;drawable.height;
-    event.u.configureNotify.borderWidth = wBorderWidth (pWin);
-    event.u.configureNotify.override = pWin-&gt;overrideRedirect;
-    DeliverEvents(pWin, &amp;event, 1, NullWindow);
-}
-
-static int
-ProcRRQueryVersion (ClientPtr client)
-{
-    xRRQueryVersionReply rep;
-    register int n;
-    REQUEST(xRRQueryVersionReq);
-    rrClientPriv(client);
-
-    REQUEST_SIZE_MATCH(xRRQueryVersionReq);
-    pRRClient-&gt;major_version = stuff-&gt;majorVersion;
-    pRRClient-&gt;minor_version = stuff-&gt;minorVersion;
-    rep.type = X_Reply;
-    rep.length = 0;
-    rep.sequenceNumber = client-&gt;sequence;
-    rep.majorVersion = RANDR_MAJOR;
-    rep.minorVersion = RANDR_MINOR;
-    if (client-&gt;swapped) {
-    	swaps(&amp;rep.sequenceNumber, n);
-    	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.majorVersion, n);
-	swapl(&amp;rep.minorVersion, n);
-    }
-    WriteToClient(client, sizeof(xRRQueryVersionReply), (char *)&amp;rep);
-    return (client-&gt;noClientException);
-}
-
-
-extern char	*ConnectionInfo;
-
-static int padlength[4] = {0, 3, 2, 1};
-
-void
-RREditConnectionInfo (ScreenPtr pScreen)
-{
-    xConnSetup	    *connSetup;
-    char	    *vendor;
-    xPixmapFormat   *formats;
-    xWindowRoot	    *root;
-    xDepth	    *depth;
-    xVisualType	    *visual;
-    int		    screen = 0;
-    int		    d;
-
-    connSetup = (xConnSetup *) ConnectionInfo;
-    vendor = (char *) connSetup + sizeof (xConnSetup);
-    formats = (xPixmapFormat *) ((char *) vendor +
-				 connSetup-&gt;nbytesVendor +
-				 padlength[connSetup-&gt;nbytesVendor &amp; 3]);
-    root = (xWindowRoot *) ((char *) formats +
-			    sizeof (xPixmapFormat) * screenInfo.numPixmapFormats);
-    while (screen != pScreen-&gt;myNum)
-    {
-	depth = (xDepth *) ((char *) root + 
-			    sizeof (xWindowRoot));
-	for (d = 0; d &lt; root-&gt;nDepths; d++)
-	{
-	    visual = (xVisualType *) ((char *) depth +
-				      sizeof (xDepth));
-	    depth = (xDepth *) ((char *) visual +
-				depth-&gt;nVisuals * sizeof (xVisualType));
-	}
-	root = (xWindowRoot *) ((char *) depth);
-	screen++;
-    }
-    root-&gt;pixWidth = pScreen-&gt;width;
-    root-&gt;pixHeight = pScreen-&gt;height;
-    root-&gt;mmWidth = pScreen-&gt;mmWidth;
-    root-&gt;mmHeight = pScreen-&gt;mmHeight;
-}
-
-static int
-ProcRRGetScreenInfo (ClientPtr client)
-{
-    REQUEST(xRRGetScreenInfoReq);
-    xRRGetScreenInfoReply   rep;
-    WindowPtr	    	    pWin;
-    int			    n;
-    ScreenPtr		    pScreen;
-    rrScrPrivPtr	    pScrPriv;
-    CARD8		    *extra;
-    unsigned long	    extraLen;
-
-    REQUEST_SIZE_MATCH(xRRGetScreenInfoReq);
-    pWin = (WindowPtr)SecurityLookupWindow(stuff-&gt;window, client,
-					   SecurityReadAccess);
-
-    if (!pWin)
-	return BadWindow;
-
-    pScreen = pWin-&gt;drawable.pScreen;
-    pScrPriv = rrGetScrPriv(pScreen);
-    rep.pad = 0;
-    if (!pScrPriv)
-    {
-	rep.type = X_Reply;
-	rep.setOfRotations = RR_Rotate_0;;
-	rep.sequenceNumber = client-&gt;sequence;
-	rep.length = 0;
-	rep.root = WindowTable[pWin-&gt;drawable.pScreen-&gt;myNum]-&gt;drawable.id;
-	rep.timestamp = currentTime.milliseconds;
-	rep.configTimestamp = currentTime.milliseconds;
-	rep.nSizes = 0;
-	rep.sizeID = 0;
-	rep.rotation = RR_Rotate_0;
-	rep.rate = 0;
-	rep.nrateEnts = 0;
-	extra = 0;
-	extraLen = 0;
-    }
-    else
-    {
-	int			i, j;
-	xScreenSizes		*size;
-	CARD16			*rates;
-	CARD8			*data8;
-	Bool			has_rate = RRClientKnowsRates (client);
-    
-	RRGetInfo (pScreen);
-
-	rep.type = X_Reply;
-	rep.setOfRotations = pScrPriv-&gt;rotations;
-	rep.sequenceNumber = client-&gt;sequence;
-	rep.length = 0;
-	rep.root = WindowTable[pWin-&gt;drawable.pScreen-&gt;myNum]-&gt;drawable.id;
-	rep.timestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-	rep.configTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-	rep.rotation = pScrPriv-&gt;rotation;
-	rep.nSizes = pScrPriv-&gt;nSizesInUse;
-	rep.rate = pScrPriv-&gt;rate;
-        rep.nrateEnts = 0;
-	if (has_rate)
-	{
-	    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	    {
-		RRScreenSizePtr pSize = &amp;pScrPriv-&gt;pSizes[i];
-		if (pSize-&gt;referenced)
-		{
-		    rep.nrateEnts += (1 + pSize-&gt;nRatesInUse);
-		}
-	    }
-	}
-
-	if (pScrPriv-&gt;size &gt;= 0)
-	    rep.sizeID = pScrPriv-&gt;pSizes[pScrPriv-&gt;size].id;
-	else
-	    return BadImplementation;
-
-	extraLen = (rep.nSizes * sizeof (xScreenSizes) +
-		    rep.nrateEnts * sizeof (CARD16));
-
-	extra = (CARD8 *) xalloc (extraLen);
-	if (!extra)
-	    return BadAlloc;
-	/*
-	 * First comes the size information
-	 */
-	size = (xScreenSizes *) extra;
-	rates = (CARD16 *) (size + rep.nSizes);
-	for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	{
-	    RRScreenSizePtr pSize = &amp;pScrPriv-&gt;pSizes[i];
-	    if (pSize-&gt;referenced)
-	    {
-		size-&gt;widthInPixels = pSize-&gt;width;
-		size-&gt;heightInPixels = pSize-&gt;height;
-		size-&gt;widthInMillimeters = pSize-&gt;mmWidth;
-		size-&gt;heightInMillimeters = pSize-&gt;mmHeight;
-		if (client-&gt;swapped)
-		{
-		    swaps (&amp;size-&gt;widthInPixels, n);
-		    swaps (&amp;size-&gt;heightInPixels, n);
-		    swaps (&amp;size-&gt;widthInMillimeters, n);
-		    swaps (&amp;size-&gt;heightInMillimeters, n);
-		}
-		size++;
-		if (has_rate)
-		{
-		    *rates = pSize-&gt;nRatesInUse;
-		    if (client-&gt;swapped)
-		    {
-			swaps (rates, n);
-		    }
-		    rates++;
-		    for (j = 0; j &lt; pSize-&gt;nRates; j++)
-		    {
-			RRScreenRatePtr	pRate = &amp;pSize-&gt;pRates[j];
-			if (pRate-&gt;referenced)
-			{
-			    *rates = pRate-&gt;rate;
-			    if (client-&gt;swapped)
-			    {
-				swaps (rates, n);
-			    }
-			    rates++;
-			}
-		    }
-		}
-	    }
-	}
-	data8 = (CARD8 *) rates;
-
-	if (data8 - (CARD8 *) extra != extraLen)
-	    FatalError (&quot;RRGetScreenInfo bad extra len %ld != %ld\n&quot;,
-			(unsigned long)(data8 - (CARD8 *) extra), extraLen);
-	rep.length =  (extraLen + 3) &gt;&gt; 2;
-    }
-    if (client-&gt;swapped) {
-	swaps(&amp;rep.sequenceNumber, n);
-	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.timestamp, n);
-	swaps(&amp;rep.rotation, n);
-	swaps(&amp;rep.nSizes, n);
-	swaps(&amp;rep.sizeID, n);
-	swaps(&amp;rep.rate, n);
-	swaps(&amp;rep.nrateEnts, n);
-    }
-    WriteToClient(client, sizeof(xRRGetScreenInfoReply), (char *)&amp;rep);
-    if (extraLen)
-    {
-	WriteToClient (client, extraLen, (char *) extra);
-	xfree (extra);
-    }
-    return (client-&gt;noClientException);
-}
-
-static int
-ProcRRSetScreenConfig (ClientPtr client)
-{
-    REQUEST(xRRSetScreenConfigReq);
-    xRRSetScreenConfigReply rep;
-    DrawablePtr		    pDraw;
-    int			    n;
-    ScreenPtr		    pScreen;
-    rrScrPrivPtr	    pScrPriv;
-    TimeStamp		    configTime;
-    TimeStamp		    time;
-    RRScreenSizePtr	    pSize;
-    int			    i;
-    Rotation		    rotation;
-    int			    rate;
-    short		    oldWidth, oldHeight;
-    Bool		    has_rate;
-
-    UpdateCurrentTime ();
-
-    if (RRClientKnowsRates (client))
-    {
-	REQUEST_SIZE_MATCH (xRRSetScreenConfigReq);
-	has_rate = TRUE;
-    }
-    else
-    {
-	REQUEST_SIZE_MATCH (xRR1_0SetScreenConfigReq);
-	has_rate = FALSE;
-    }
-    
-    SECURITY_VERIFY_DRAWABLE(pDraw, stuff-&gt;drawable, client,
-			     SecurityWriteAccess);
-
-    pScreen = pDraw-&gt;pScreen;
-
-    pScrPriv = rrGetScrPriv(pScreen);
-    
-    time = ClientTimeToServerTime(stuff-&gt;timestamp);
-    configTime = ClientTimeToServerTime(stuff-&gt;configTimestamp);
-    
-    oldWidth = pScreen-&gt;width;
-    oldHeight = pScreen-&gt;height;
-    
-    if (!pScrPriv)
-    {
-	time = currentTime;
-	rep.status = RRSetConfigFailed;
-	goto sendReply;
-    }
-    if (!RRGetInfo (pScreen))
-	return BadAlloc;
-    
-    /*
-     * if the client's config timestamp is not the same as the last config
-     * timestamp, then the config information isn't up-to-date and
-     * can't even be validated
-     */
-    if (CompareTimeStamps (configTime, pScrPriv-&gt;lastConfigTime) != 0)
-    {
-	rep.status = RRSetConfigInvalidConfigTime;
-	goto sendReply;
-    }
-    
-    /*
-     * Search for the requested size
-     */
-    pSize = 0;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	if (pSize-&gt;referenced &amp;&amp; pSize-&gt;id == stuff-&gt;sizeID)
-	{
-	    break;
-	}
-    }
-    if (i == pScrPriv-&gt;nSizes)
-    {
-	/*
-	 * Invalid size ID
-	 */
-	client-&gt;errorValue = stuff-&gt;sizeID;
-	return BadValue;
-    }
-    
-    /*
-     * Validate requested rotation
-     */
-    rotation = (Rotation) stuff-&gt;rotation;
-
-    /* test the rotation bits only! */
-    switch (rotation &amp; 0xf) {
-    case RR_Rotate_0:
-    case RR_Rotate_90:
-    case RR_Rotate_180:
-    case RR_Rotate_270:
-	break;
-    default:
-	/*
-	 * Invalid rotation
-	 */
-	client-&gt;errorValue = stuff-&gt;rotation;
-	return BadValue;
-    }
-
-    if ((~pScrPriv-&gt;rotations) &amp; rotation)
-    {
-	/*
-	 * requested rotation or reflection not supported by screen
-	 */
-	client-&gt;errorValue = stuff-&gt;rotation;
-	return BadMatch;
-    }
-
-    /*
-     * Validate requested refresh
-     */
-    if (has_rate)
-	rate = (int) stuff-&gt;rate;
-    else
-	rate = 0;
-
-    if (rate)
-    {
-	for (i = 0; i &lt; pSize-&gt;nRates; i++)
-	{
-	    RRScreenRatePtr pRate = &amp;pSize-&gt;pRates[i];
-	    if (pRate-&gt;referenced &amp;&amp; pRate-&gt;rate == rate)
-		break;
-	}
-	if (i == pSize-&gt;nRates)
-	{
-	    /*
-	     * Invalid rate
-	     */
-	    client-&gt;errorValue = rate;
-	    return BadValue;
-	}
-    }
-    
-    /*
-     * Make sure the requested set-time is not older than
-     * the last set-time
-     */
-    if (CompareTimeStamps (time, pScrPriv-&gt;lastSetTime) &lt; 0)
-    {
-	rep.status = RRSetConfigInvalidTime;
-	goto sendReply;
-    }
-
-    /*
-     * call out to ddx routine to effect the change
-     */
-    if (!(*pScrPriv-&gt;rrSetConfig) (pScreen, rotation, rate,
-				   pSize))
-    {
-	/*
-	 * unknown DDX failure, report to client
-	 */
-	rep.status = RRSetConfigFailed;
-	goto sendReply;
-    }
-    
-    /*
-     * set current extension configuration pointers
-     */
-    RRSetCurrentConfig (pScreen, rotation, rate, pSize);
-    
-    /*
-     * Deliver ScreenChangeNotify events whenever
-     * the configuration is updated
-     */
-    WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    
-    /*
-     * Deliver ConfigureNotify events when root changes
-     * pixel size
-     */
-    if (oldWidth != pScreen-&gt;width || oldHeight != pScreen-&gt;height)
-	RRSendConfigNotify (pScreen);
-    RREditConnectionInfo (pScreen);
-    
-    /*
-     * Fix pointer bounds and location
-     */
-    ScreenRestructured (pScreen);
-    pScrPriv-&gt;lastSetTime = time;
-    
-    /*
-     * Report Success
-     */
-    rep.status = RRSetConfigSuccess;
-    
-sendReply:
-    
-    rep.type = X_Reply;
-    /* rep.status has already been filled in */
-    rep.length = 0;
-    rep.sequenceNumber = client-&gt;sequence;
-
-    rep.newTimestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-    rep.newConfigTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-    rep.root = WindowTable[pDraw-&gt;pScreen-&gt;myNum]-&gt;drawable.id;
-
-    if (client-&gt;swapped) 
-    {
-    	swaps(&amp;rep.sequenceNumber, n);
-    	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.newTimestamp, n);
-	swapl(&amp;rep.newConfigTimestamp, n);
-	swapl(&amp;rep.root, n);
-    }
-    WriteToClient(client, sizeof(xRRSetScreenConfigReply), (char *)&amp;rep);
-
-    return (client-&gt;noClientException);
-}
-
-int
-RRSetScreenConfig (ScreenPtr		pScreen,
-		   Rotation		rotation,
-		   int			rate,
-		   RRScreenSizePtr	pSize)
-{
-    rrScrPrivPtr	    pScrPriv;
-    int			    i;
-    short		    oldWidth, oldHeight;
-
-    pScrPriv = rrGetScrPriv(pScreen);
-    
-    oldWidth = pScreen-&gt;width;
-    oldHeight = pScreen-&gt;height;
-    
-    if (!RRGetInfo (pScreen))
-	return BadAlloc;
-    
-    /*
-     * Validate requested rotation
-     */
-
-    /* test the rotation bits only! */
-    switch (rotation &amp; 0xf) {
-    case RR_Rotate_0:
-    case RR_Rotate_90:
-    case RR_Rotate_180:
-    case RR_Rotate_270:
-	break;
-    default:
-	/*
-	 * Invalid rotation
-	 */
-	return BadValue;
-    }
-
-    if ((~pScrPriv-&gt;rotations) &amp; rotation)
-    {
-	/*
-	 * requested rotation or reflection not supported by screen
-	 */
-	return BadMatch;
-    }
-
-    /*
-     * Validate requested refresh
-     */
-    if (rate)
-    {
-	for (i = 0; i &lt; pSize-&gt;nRates; i++)
-	{
-	    RRScreenRatePtr pRate = &amp;pSize-&gt;pRates[i];
-	    if (pRate-&gt;referenced &amp;&amp; pRate-&gt;rate == rate)
-		break;
-	}
-	if (i == pSize-&gt;nRates)
-	{
-	    /*
-	     * Invalid rate
-	     */
-	    return BadValue;
-	}
-    }
-
-    /*
-     * call out to ddx routine to effect the change
-     */
-    if (!(*pScrPriv-&gt;rrSetConfig) (pScreen, rotation, rate,
-				   pSize))
-    {
-	/*
-	 * unknown DDX failure, report to client
-	 */
-        return BadImplementation;
-    }
-    
-    /*
-     * set current extension configuration pointers
-     */
-    RRSetCurrentConfig (pScreen, rotation, rate, pSize);
-    
-    /*
-     * Deliver ScreenChangeNotify events whenever
-     * the configuration is updated
-     */
-    WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    
-    /*
-     * Deliver ConfigureNotify events when root changes
-     * pixel size
-     */
-    if (oldWidth != pScreen-&gt;width || oldHeight != pScreen-&gt;height)
-	RRSendConfigNotify (pScreen);
-    RREditConnectionInfo (pScreen);
-    
-    /*
-     * Fix pointer bounds and location
-     */
-    ScreenRestructured (pScreen);
-    
-    return Success;
-}
-
-static int
-ProcRRSelectInput (ClientPtr client)
-{
-    REQUEST(xRRSelectInputReq);
-    rrClientPriv(client);
-    RRTimesPtr	pTimes;
-    WindowPtr	pWin;
-    RREventPtr	pRREvent, pNewRREvent, *pHead;
-    XID		clientResource;
-
-    REQUEST_SIZE_MATCH(xRRSelectInputReq);
-    pWin = SecurityLookupWindow (stuff-&gt;window, client, SecurityWriteAccess);
-    if (!pWin)
-	return BadWindow;
-    pHead = (RREventPtr *)SecurityLookupIDByType(client,
-						 pWin-&gt;drawable.id, EventType,
-						 SecurityWriteAccess);
-
-    if (stuff-&gt;enable &amp; (RRScreenChangeNotifyMask)) 
-    {
-	ScreenPtr	pScreen = pWin-&gt;drawable.pScreen;
-	rrScrPriv	(pScreen);
-
-	if (pHead) 
-	{
-	    /* check for existing entry. */
-	    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next)
-		if (pRREvent-&gt;client == client)
-		    return Success;
-	}
-
-	/* build the entry */
-	pNewRREvent = (RREventPtr) xalloc (sizeof (RREventRec));
-	if (!pNewRREvent)
-	    return BadAlloc;
-	pNewRREvent-&gt;next = 0;
-	pNewRREvent-&gt;client = client;
-	pNewRREvent-&gt;window = pWin;
-	pNewRREvent-&gt;mask = stuff-&gt;enable;
-	/*
-	 * add a resource that will be deleted when
-	 * the client goes away
-	 */
-	clientResource = FakeClientID (client-&gt;index);
-	pNewRREvent-&gt;clientResource = clientResource;
-	if (!AddResource (clientResource, ClientType, (pointer)pNewRREvent))
-	    return BadAlloc;
-	/*
-	 * create a resource to contain a pointer to the list
-	 * of clients selecting input.  This must be indirect as
-	 * the list may be arbitrarily rearranged which cannot be
-	 * done through the resource database.
-	 */
-	if (!pHead)
-	{
-	    pHead = (RREventPtr *) xalloc (sizeof (RREventPtr));
-	    if (!pHead ||
-		!AddResource (pWin-&gt;drawable.id, EventType, (pointer)pHead))
-	    {
-		FreeResource (clientResource, RT_NONE);
-		return BadAlloc;
-	    }
-	    *pHead = 0;
-	}
-	pNewRREvent-&gt;next = *pHead;
-	*pHead = pNewRREvent;
-	/*
-	 * Now see if the client needs an event
-	 */
-	if (pScrPriv)
-	{
-	    pTimes = &amp;((RRTimesPtr) (pRRClient + 1))[pScreen-&gt;myNum];
-	    if (CompareTimeStamps (pTimes-&gt;setTime, 
-				   pScrPriv-&gt;lastSetTime) != 0 ||
-		CompareTimeStamps (pTimes-&gt;configTime, 
-				   pScrPriv-&gt;lastConfigTime) != 0)
-	    {
-		TellChanged (pWin, (pointer) pScreen);
-	    }
-	}
-    }
-    else if (stuff-&gt;enable == xFalse) 
-    {
-	/* delete the interest */
-	if (pHead) {
-	    pNewRREvent = 0;
-	    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next) {
-		if (pRREvent-&gt;client == client)
-		    break;
-		pNewRREvent = pRREvent;
-	    }
-	    if (pRREvent) {
-		FreeResource (pRREvent-&gt;clientResource, ClientType);
-		if (pNewRREvent)
-		    pNewRREvent-&gt;next = pRREvent-&gt;next;
-		else
-		    *pHead = pRREvent-&gt;next;
-		xfree (pRREvent);
-	    }
-	}
-    }
-    else 
-    {
-	client-&gt;errorValue = stuff-&gt;enable;
-	return BadValue;
-    }
-    return Success;
-}
-
-
-static int
-ProcRRDispatch (ClientPtr client)
-{
-    REQUEST(xReq);
-    switch (stuff-&gt;data)
-    {
-    case X_RRQueryVersion:
-	return ProcRRQueryVersion(client);
-    case X_RRSetScreenConfig:
-        return ProcRRSetScreenConfig(client);
-    case X_RRSelectInput:
-        return ProcRRSelectInput(client);
-    case X_RRGetScreenInfo:
-        return ProcRRGetScreenInfo(client);
-    default:
-	return BadRequest;
-    }
-}
-
-static int
-SProcRRQueryVersion (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRQueryVersionReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;majorVersion, n);
-    swapl(&amp;stuff-&gt;minorVersion, n);
-    return ProcRRQueryVersion(client);
-}
-
-static int
-SProcRRGetScreenInfo (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRGetScreenInfoReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;window, n);
-    return ProcRRGetScreenInfo(client);
-}
-
-static int
-SProcRRSetScreenConfig (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRSetScreenConfigReq);
-
-    if (RRClientKnowsRates (client))
-    {
-	REQUEST_SIZE_MATCH (xRRSetScreenConfigReq);
-	swaps (&amp;stuff-&gt;rate, n);
-    }
-    else
-    {
-	REQUEST_SIZE_MATCH (xRR1_0SetScreenConfigReq);
-    }
-    
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;drawable, n);
-    swapl(&amp;stuff-&gt;timestamp, n);
-    swaps(&amp;stuff-&gt;sizeID, n);
-    swaps(&amp;stuff-&gt;rotation, n);
-    return ProcRRSetScreenConfig(client);
-}
-
-static int
-SProcRRSelectInput (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRSelectInputReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;window, n);
-    return ProcRRSelectInput(client);
-}
-
-
-static int
-SProcRRDispatch (ClientPtr client)
-{
-    REQUEST(xReq);
-    switch (stuff-&gt;data)
-    {
-    case X_RRQueryVersion:
-	return SProcRRQueryVersion(client);
-    case X_RRSetScreenConfig:
-        return SProcRRSetScreenConfig(client);
-    case X_RRSelectInput:
-        return SProcRRSelectInput(client);
-    case X_RRGetScreenInfo:
-        return SProcRRGetScreenInfo(client);
-    default:
-	return BadRequest;
-    }
-}
-
-
-static Bool
-RRScreenSizeMatches (RRScreenSizePtr  a,
-		   RRScreenSizePtr  b)
-{
-    if (a-&gt;width != b-&gt;width)
-	return FALSE;
-    if (a-&gt;height != b-&gt;height)
-	return FALSE;
-    if (a-&gt;mmWidth != b-&gt;mmWidth)
-	return FALSE;
-    if (a-&gt;mmHeight != b-&gt;mmHeight)
-	return FALSE;
-    return TRUE;
-}
-
-RRScreenSizePtr
-RRRegisterSize (ScreenPtr	    pScreen,
-		short		    width, 
-		short		    height,
-		short		    mmWidth,
-		short		    mmHeight)
-{
-    rrScrPriv (pScreen);
-    int		    i;
-    RRScreenSize    tmp;
-    RRScreenSizePtr pNew;
-
-    if (!pScrPriv)
-	return 0;
-
-    /*
-     * FIXME: The compiler reports that field
-     * id is used uninitialized here.
-     */
-
-    tmp.id = 0;
-    
-    tmp.width = width;
-    tmp.height= height;
-    tmp.mmWidth = mmWidth;
-    tmp.mmHeight = mmHeight;
-    tmp.pRates = 0;
-    tmp.nRates = 0;
-    tmp.nRatesInUse = 0;
-    tmp.referenced = TRUE;
-    tmp.oldReferenced = FALSE;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	if (RRScreenSizeMatches (&amp;tmp, &amp;pScrPriv-&gt;pSizes[i]))
-	{
-	    pScrPriv-&gt;pSizes[i].referenced = TRUE;
-	    return &amp;pScrPriv-&gt;pSizes[i];
-	}
-    pNew = xrealloc (pScrPriv-&gt;pSizes,
-		     (pScrPriv-&gt;nSizes + 1) * sizeof (RRScreenSize));
-    if (!pNew)
-	return 0;
-    pNew[pScrPriv-&gt;nSizes++] = tmp;
-    pScrPriv-&gt;pSizes = pNew;
-    return &amp;pNew[pScrPriv-&gt;nSizes-1];
-}
-
-Bool RRRegisterRate (ScreenPtr		pScreen,
-		     RRScreenSizePtr	pSize,
-		     int		rate)
-{
-    rrScrPriv(pScreen);
-    int		    i;
-    RRScreenRatePtr pNew, pRate;
-
-    if (!pScrPriv)
-	return FALSE;
-    
-    for (i = 0; i &lt; pSize-&gt;nRates; i++)
-    {
-	pRate = &amp;pSize-&gt;pRates[i];
-	if (pRate-&gt;rate == rate)
-	{
-	    pRate-&gt;referenced = TRUE;
-	    return TRUE;
-	}
-    }
-
-    pNew = xrealloc (pSize-&gt;pRates,
-		     (pSize-&gt;nRates + 1) * sizeof (RRScreenRate));
-    if (!pNew)
-	return FALSE;
-    pRate = &amp;pNew[pSize-&gt;nRates++];
-    pRate-&gt;rate = rate;
-    pRate-&gt;referenced = TRUE;
-    pRate-&gt;oldReferenced = FALSE;
-    pSize-&gt;pRates = pNew;
-    return TRUE;
-}
-
-void
-RRSetCurrentConfig (ScreenPtr		pScreen,
-		    Rotation		rotation,
-		    int			rate,
-		    RRScreenSizePtr	pSize)
-{
-    rrScrPriv (pScreen);
-
-    if (!pScrPriv)
-	return;
-
-    pScrPriv-&gt;rotation = rotation;
-    pScrPriv-&gt;size = pSize - pScrPriv-&gt;pSizes;
-    pScrPriv-&gt;rate = rate;
-}
-
diff --git a/nx-X11/programs/Xserver/hw/nxagent/X/NXrandr.c.NX.original b/nx-X11/programs/Xserver/hw/nxagent/X/NXrandr.c.NX.original
deleted file mode 100644
index 5f460f2..0000000
--- a/nx-X11/programs/Xserver/hw/nxagent/X/NXrandr.c.NX.original
+++ /dev/null
@@ -1,1344 +0,0 @@
-/**************************************************************************/
-/*                                                                        */
-/* Copyright (c) 2001, 2011 NoMachine, <A HREF="http://www.nomachine.com/.">http://www.nomachine.com/.</A>         */
-/*                                                                        */
-/* NXAGENT, NX protocol compression and NX extensions to this software    */
-/* are copyright of NoMachine. Redistribution and use of the present      */
-/* software is allowed according to terms specified in the file LICENSE   */
-/* which comes in the source distribution.                                */
-/*                                                                        */
-/* Check <A HREF="http://www.nomachine.com/licensing.html">http://www.nomachine.com/licensing.html</A> for applicability.       */
-/*                                                                        */
-/* NX and NoMachine are trademarks of Medialogic S.p.A.                   */
-/*                                                                        */
-/* All rights reserved.                                                   */
-/*                                                                        */
-/**************************************************************************/
-
-/*
- * $XFree86: xc/programs/Xserver/randr/randr.c,v 1.21tsi Exp $
- *
- * Copyright &#194;&#169; 2000, Compaq Computer Corporation, 
- * Copyright &#194;&#169; 2002, Hewlett Packard, Inc.
- *
- * Permission to use, copy, modify, distribute, and sell this software and its
- * documentation for any purpose is hereby granted without fee, provided that
- * the above copyright notice appear in all copies and that both that
- * copyright notice and this permission notice appear in supporting
- * documentation, and that the name of Compaq or HP not be used in advertising
- * or publicity pertaining to distribution of the software without specific,
- * written prior permission.  HP makes no representations about the
- * suitability of this software for any purpose.  It is provided &quot;as is&quot;
- * without express or implied warranty.
- *
- * HP DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL HP
- * BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
- * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
- * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN 
- * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
- *
- * Author:  Jim Gettys, HP Labs, Hewlett-Packard, Inc.
- */
-
-
-#define NEED_REPLIES
-#define NEED_EVENTS
-#ifdef HAVE_DIX_CONFIG_H
-#include &lt;dix-config.h&gt;
-#endif
-
-#include &lt;X11/X.h&gt;
-#include &lt;X11/Xproto.h&gt;
-#include &quot;misc.h&quot;
-#include &quot;os.h&quot;
-#include &quot;dixstruct.h&quot;
-#include &quot;resource.h&quot;
-#include &quot;scrnintstr.h&quot;
-#include &quot;windowstr.h&quot;
-#include &quot;pixmapstr.h&quot;
-#include &quot;extnsionst.h&quot;
-#include &quot;servermd.h&quot;
-#include &lt;X11/extensions/randr.h&gt;
-#include &lt;X11/extensions/randrproto.h&gt;
-#include &quot;../../randr/randrstr.h&quot;
-#ifdef RENDER
-#include &lt;X11/extensions/render.h&gt; 	/* we share subpixel order information */
-#include &quot;picturestr.h&quot;
-#endif
-#include &lt;X11/Xfuncproto.h&gt;
-#ifdef EXTMODULE
-#include &quot;xf86_ansic.h&quot;
-#endif
-
-/* From render.h */
-#ifndef SubPixelUnknown
-#define SubPixelUnknown 0
-#endif
-
-#define RR_VALIDATE
-int	RRGeneration;
-int	RRNScreens;
-
-static int ProcRRQueryVersion (ClientPtr pClient);
-static int ProcRRDispatch (ClientPtr pClient);
-static int SProcRRDispatch (ClientPtr pClient);
-static int SProcRRQueryVersion (ClientPtr pClient);
-
-#define wrap(priv,real,mem,func) {\
-    priv-&gt;mem = real-&gt;mem; \
-    real-&gt;mem = func; \
-}
-
-#define unwrap(priv,real,mem) {\
-    real-&gt;mem = priv-&gt;mem; \
-}
-
-#if 0
-static CARD8	RRReqCode;
-static int	RRErrBase;
-#endif
-static int	RREventBase;
-static RESTYPE ClientType, EventType; /* resource types for event masks */
-static int	RRClientPrivateIndex;
-
-typedef struct _RRTimes {
-    TimeStamp	setTime;
-    TimeStamp	configTime;
-} RRTimesRec, *RRTimesPtr;
-
-typedef struct _RRClient {
-    int		major_version;
-    int		minor_version;
-/*  RRTimesRec	times[0]; */
-} RRClientRec, *RRClientPtr;
-
-/*
- * each window has a list of clients requesting
- * RRNotify events.  Each client has a resource
- * for each window it selects RRNotify input for,
- * this resource is used to delete the RRNotifyRec
- * entry from the per-window queue.
- */
-
-typedef struct _RREvent *RREventPtr;
-
-typedef struct _RREvent {
-    RREventPtr  next;
-    ClientPtr	client;
-    WindowPtr	window;
-    XID		clientResource;
-    int		mask;
-} RREventRec;
-
-int	rrPrivIndex = -1;
-
-#define GetRRClient(pClient)    ((RRClientPtr) (pClient)-&gt;devPrivates[RRClientPrivateIndex].ptr)
-#define rrClientPriv(pClient)	RRClientPtr pRRClient = GetRRClient(pClient)
-
-static Bool
-RRClientKnowsRates (ClientPtr	pClient)
-{
-    rrClientPriv(pClient);
-
-    return (pRRClient-&gt;major_version &gt; 1 ||
-	    (pRRClient-&gt;major_version == 1 &amp;&amp; pRRClient-&gt;minor_version &gt;= 1));
-}
-
-static void
-RRClientCallback (CallbackListPtr	*list,
-		  pointer		closure,
-		  pointer		data)
-{
-    NewClientInfoRec	*clientinfo = (NewClientInfoRec *) data;
-    ClientPtr		pClient = clientinfo-&gt;client;
-    rrClientPriv(pClient);
-    RRTimesPtr		pTimes = (RRTimesPtr) (pRRClient + 1);
-    int			i;
-
-    pRRClient-&gt;major_version = 0;
-    pRRClient-&gt;minor_version = 0;
-    for (i = 0; i &lt; screenInfo.numScreens; i++)
-    {
-	ScreenPtr   pScreen = screenInfo.screens[i];
-	rrScrPriv(pScreen);
-
-	if (pScrPriv)
-	{
-	    pTimes[i].setTime = pScrPriv-&gt;lastSetTime;
-	    pTimes[i].configTime = pScrPriv-&gt;lastConfigTime;
-	}
-    }
-}
-
-static void
-RRResetProc (ExtensionEntry *extEntry)
-{
-}
-    
-static Bool
-RRCloseScreen (int i, ScreenPtr pScreen)
-{
-    rrScrPriv(pScreen);
-
-    unwrap (pScrPriv, pScreen, CloseScreen);
-    if (pScrPriv-&gt;pSizes)
-	xfree (pScrPriv-&gt;pSizes);
-    xfree (pScrPriv);
-    RRNScreens -= 1;	/* ok, one fewer screen with RandR running */
-    return (*pScreen-&gt;CloseScreen) (i, pScreen);    
-}
-
-static void
-SRRScreenChangeNotifyEvent(xRRScreenChangeNotifyEvent *from,
-			   xRRScreenChangeNotifyEvent *to)
-{
-    to-&gt;type = from-&gt;type;
-    to-&gt;rotation = from-&gt;rotation;
-    cpswaps(from-&gt;sequenceNumber, to-&gt;sequenceNumber);
-    cpswapl(from-&gt;timestamp, to-&gt;timestamp);
-    cpswapl(from-&gt;configTimestamp, to-&gt;configTimestamp);
-    cpswapl(from-&gt;root, to-&gt;root);
-    cpswapl(from-&gt;window, to-&gt;window);
-    cpswaps(from-&gt;sizeID, to-&gt;sizeID);
-    cpswaps(from-&gt;widthInPixels, to-&gt;widthInPixels);
-    cpswaps(from-&gt;heightInPixels, to-&gt;heightInPixels);
-    cpswaps(from-&gt;widthInMillimeters, to-&gt;widthInMillimeters);
-    cpswaps(from-&gt;heightInMillimeters, to-&gt;heightInMillimeters);
-    cpswaps(from-&gt;subpixelOrder, to-&gt;subpixelOrder);
-}
-
-Bool RRScreenInit(ScreenPtr pScreen)
-{
-    rrScrPrivPtr   pScrPriv;
-
-    if (RRGeneration != serverGeneration)
-    {
-	if ((rrPrivIndex = AllocateScreenPrivateIndex()) &lt; 0)
-	    return FALSE;
-	RRGeneration = serverGeneration;
-    }
-
-    pScrPriv = (rrScrPrivPtr) xalloc (sizeof (rrScrPrivRec));
-    if (!pScrPriv)
-	return FALSE;
-
-    SetRRScreen(pScreen, pScrPriv);
-
-    /*
-     * Calling function best set these function vectors
-     */
-    pScrPriv-&gt;rrSetConfig = 0;
-    pScrPriv-&gt;rrGetInfo = 0;
-    /*
-     * This value doesn't really matter -- any client must call
-     * GetScreenInfo before reading it which will automatically update
-     * the time
-     */
-    pScrPriv-&gt;lastSetTime = currentTime;
-    pScrPriv-&gt;lastConfigTime = currentTime;
-    
-    wrap (pScrPriv, pScreen, CloseScreen, RRCloseScreen);
-
-    pScrPriv-&gt;rotations = RR_Rotate_0;
-    
-    pScrPriv-&gt;nSizes = 0;
-    pScrPriv-&gt;nSizesInUse = 0;
-    pScrPriv-&gt;pSizes = 0;
-    
-    pScrPriv-&gt;rotation = RR_Rotate_0;
-    pScrPriv-&gt;size = -1;
-    
-    RRNScreens += 1;	/* keep count of screens that implement randr */
-    return TRUE;
-}
-
-/*ARGSUSED*/
-static int
-RRFreeClient (pointer data, XID id)
-{
-    RREventPtr   pRREvent;
-    WindowPtr	    pWin;
-    RREventPtr   *pHead, pCur, pPrev;
-
-    pRREvent = (RREventPtr) data;
-    pWin = pRREvent-&gt;window;
-    pHead = (RREventPtr *) LookupIDByType(pWin-&gt;drawable.id, EventType);
-    if (pHead) {
-	pPrev = 0;
-	for (pCur = *pHead; pCur &amp;&amp; pCur != pRREvent; pCur=pCur-&gt;next)
-	    pPrev = pCur;
-	if (pCur)
-	{
-	    if (pPrev)
-	    	pPrev-&gt;next = pRREvent-&gt;next;
-	    else
-	    	*pHead = pRREvent-&gt;next;
-	}
-    }
-    xfree ((pointer) pRREvent);
-    return 1;
-}
-
-/*ARGSUSED*/
-static int
-RRFreeEvents (pointer data, XID id)
-{
-    RREventPtr   *pHead, pCur, pNext;
-
-    pHead = (RREventPtr *) data;
-    for (pCur = *pHead; pCur; pCur = pNext) {
-	pNext = pCur-&gt;next;
-	FreeResource (pCur-&gt;clientResource, ClientType);
-	xfree ((pointer) pCur);
-    }
-    xfree ((pointer) pHead);
-    return 1;
-}
-
-void
-RRExtensionInit (void)
-{
-    ExtensionEntry *extEntry;
-
-    if (RRNScreens == 0) return;
-
-    RRClientPrivateIndex = AllocateClientPrivateIndex ();
-    if (!AllocateClientPrivate (RRClientPrivateIndex,
-				sizeof (RRClientRec) +
-				screenInfo.numScreens * sizeof (RRTimesRec)))
-	return;
-    if (!AddCallback (&amp;ClientStateCallback, RRClientCallback, 0))
-	return;
-
-    ClientType = CreateNewResourceType(RRFreeClient);
-    if (!ClientType)
-	return;
-    EventType = CreateNewResourceType(RRFreeEvents);
-    if (!EventType)
-	return;
-    extEntry = AddExtension (RANDR_NAME, RRNumberEvents, RRNumberErrors,
-			     ProcRRDispatch, SProcRRDispatch,
-			     RRResetProc, StandardMinorOpcode);
-    if (!extEntry)
-	return;
-#if 0
-    RRReqCode = (CARD8) extEntry-&gt;base;
-    RRErrBase = extEntry-&gt;errorBase;
-#endif
-    RREventBase = extEntry-&gt;eventBase;
-    EventSwapVector[RREventBase + RRScreenChangeNotify] = (EventSwapPtr) 
-      SRRScreenChangeNotifyEvent;
-
-    return;
-}
-		
-int
-TellChanged (WindowPtr pWin, pointer value)
-{
-    RREventPtr			*pHead, pRREvent;
-    ClientPtr			client;
-    xRRScreenChangeNotifyEvent	se;
-    ScreenPtr			pScreen = pWin-&gt;drawable.pScreen;
-    rrScrPriv(pScreen);
-    RRScreenSizePtr		pSize;
-    WindowPtr			pRoot = WindowTable[pScreen-&gt;myNum];
-
-    pHead = (RREventPtr *) LookupIDByType (pWin-&gt;drawable.id, EventType);
-    if (!pHead)
-	return WT_WALKCHILDREN;
-
-    se.type = RRScreenChangeNotify + RREventBase;
-    se.rotation = (CARD8) pScrPriv-&gt;rotation;
-    se.timestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-    se.configTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-    se.root =  pRoot-&gt;drawable.id;
-    se.window = pWin-&gt;drawable.id;
-#ifdef RENDER
-    se.subpixelOrder = PictureGetSubpixelOrder (pScreen);
-#else
-    se.subpixelOrder = SubPixelUnknown;
-#endif
-    if (pScrPriv-&gt;size &gt;= 0)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[pScrPriv-&gt;size];
-	se.sizeID = pSize-&gt;id;
-	se.widthInPixels = pSize-&gt;width;
-	se.heightInPixels = pSize-&gt;height;
-	se.widthInMillimeters = pSize-&gt;mmWidth;
-	se.heightInMillimeters = pSize-&gt;mmHeight;
-    }
-    else
-    {
-	/*
-	 * This &quot;shouldn't happen&quot;, but a broken DDX can
-	 * forget to set the current configuration on GetInfo
-	 */
-	se.sizeID = 0xffff;
-	se.widthInPixels = 0;
-	se.heightInPixels = 0;
-	se.widthInMillimeters = 0;
-	se.heightInMillimeters = 0;
-    }    
-    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next) 
-    {
-	client = pRREvent-&gt;client;
-	if (client == serverClient || client-&gt;clientGone)
-	    continue;
-	se.sequenceNumber = client-&gt;sequence;
-	if(pRREvent-&gt;mask &amp; RRScreenChangeNotifyMask)
-	  WriteEventsToClient (client, 1, (xEvent *) &amp;se);
-    }
-    return WT_WALKCHILDREN;
-}
-
-Bool
-RRGetInfo (ScreenPtr pScreen)
-{
-    rrScrPriv (pScreen);
-    int		    i, j, k, l;
-    Bool	    changed;
-    Rotation	    rotations;
-    RRScreenSizePtr pSize;
-    RRScreenRatePtr pRate;
-
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	pSize-&gt;oldReferenced = pSize-&gt;referenced;
-	pSize-&gt;referenced = FALSE;
-	for (k = 0; k &lt; pSize-&gt;nRates; k++)
-	{
-	    pRate = &amp;pSize-&gt;pRates[k];
-	    pRate-&gt;oldReferenced = pRate-&gt;referenced;
-	    pRate-&gt;referenced = FALSE;
-	}
-    }
-    if (!(*pScrPriv-&gt;rrGetInfo) (pScreen, &amp;rotations))
-	return FALSE;
-
-    changed = FALSE;
-
-    /*
-     * Check whether anything changed and simultaneously generate
-     * the protocol id values for the objects
-     */
-    if (rotations != pScrPriv-&gt;rotations)
-    {
-	pScrPriv-&gt;rotations = rotations;
-	changed = TRUE;
-    }
-
-    j = 0;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	if (pSize-&gt;oldReferenced != pSize-&gt;referenced)
-	    changed = TRUE;
-	if (pSize-&gt;referenced)
-	    pSize-&gt;id = j++;
-	l = 0;
-	for (k = 0; k &lt; pSize-&gt;nRates; k++)
-	{
-	    pRate = &amp;pSize-&gt;pRates[k];
-	    if (pRate-&gt;oldReferenced != pRate-&gt;referenced)
-		changed = TRUE;
-	    if (pRate-&gt;referenced)
-		l++;
-	}
-	pSize-&gt;nRatesInUse = l;
-    }
-    pScrPriv-&gt;nSizesInUse = j;
-    if (changed)
-    {
-	UpdateCurrentTime ();
-	pScrPriv-&gt;lastConfigTime = currentTime;
-	WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    }
-    return TRUE;
-}
-
-void
-RRSendConfigNotify (ScreenPtr pScreen)
-{
-    WindowPtr	pWin = WindowTable[pScreen-&gt;myNum];
-    xEvent	event;
-
-    event.u.u.type = ConfigureNotify;
-    event.u.configureNotify.window = pWin-&gt;drawable.id;
-    event.u.configureNotify.aboveSibling = None;
-    event.u.configureNotify.x = 0;
-    event.u.configureNotify.y = 0;
-
-    /* XXX xinerama stuff ? */
-    
-    event.u.configureNotify.width = pWin-&gt;drawable.width;
-    event.u.configureNotify.height = pWin-&gt;drawable.height;
-    event.u.configureNotify.borderWidth = wBorderWidth (pWin);
-    event.u.configureNotify.override = pWin-&gt;overrideRedirect;
-    DeliverEvents(pWin, &amp;event, 1, NullWindow);
-}
-
-static int
-ProcRRQueryVersion (ClientPtr client)
-{
-    xRRQueryVersionReply rep;
-    register int n;
-    REQUEST(xRRQueryVersionReq);
-    rrClientPriv(client);
-
-    REQUEST_SIZE_MATCH(xRRQueryVersionReq);
-    pRRClient-&gt;major_version = stuff-&gt;majorVersion;
-    pRRClient-&gt;minor_version = stuff-&gt;minorVersion;
-    rep.type = X_Reply;
-    rep.length = 0;
-    rep.sequenceNumber = client-&gt;sequence;
-    rep.majorVersion = RANDR_MAJOR;
-    rep.minorVersion = RANDR_MINOR;
-    if (client-&gt;swapped) {
-    	swaps(&amp;rep.sequenceNumber, n);
-    	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.majorVersion, n);
-	swapl(&amp;rep.minorVersion, n);
-    }
-    WriteToClient(client, sizeof(xRRQueryVersionReply), (char *)&amp;rep);
-    return (client-&gt;noClientException);
-}
-
-
-extern char	*ConnectionInfo;
-
-static int padlength[4] = {0, 3, 2, 1};
-
-void
-RREditConnectionInfo (ScreenPtr pScreen)
-{
-    xConnSetup	    *connSetup;
-    char	    *vendor;
-    xPixmapFormat   *formats;
-    xWindowRoot	    *root;
-    xDepth	    *depth;
-    xVisualType	    *visual;
-    int		    screen = 0;
-    int		    d;
-
-    connSetup = (xConnSetup *) ConnectionInfo;
-    vendor = (char *) connSetup + sizeof (xConnSetup);
-    formats = (xPixmapFormat *) ((char *) vendor +
-				 connSetup-&gt;nbytesVendor +
-				 padlength[connSetup-&gt;nbytesVendor &amp; 3]);
-    root = (xWindowRoot *) ((char *) formats +
-			    sizeof (xPixmapFormat) * screenInfo.numPixmapFormats);
-    while (screen != pScreen-&gt;myNum)
-    {
-	depth = (xDepth *) ((char *) root + 
-			    sizeof (xWindowRoot));
-	for (d = 0; d &lt; root-&gt;nDepths; d++)
-	{
-	    visual = (xVisualType *) ((char *) depth +
-				      sizeof (xDepth));
-	    depth = (xDepth *) ((char *) visual +
-				depth-&gt;nVisuals * sizeof (xVisualType));
-	}
-	root = (xWindowRoot *) ((char *) depth);
-	screen++;
-    }
-    root-&gt;pixWidth = pScreen-&gt;width;
-    root-&gt;pixHeight = pScreen-&gt;height;
-    root-&gt;mmWidth = pScreen-&gt;mmWidth;
-    root-&gt;mmHeight = pScreen-&gt;mmHeight;
-}
-
-static int
-ProcRRGetScreenInfo (ClientPtr client)
-{
-    REQUEST(xRRGetScreenInfoReq);
-    xRRGetScreenInfoReply   rep;
-    WindowPtr	    	    pWin;
-    int			    n;
-    ScreenPtr		    pScreen;
-    rrScrPrivPtr	    pScrPriv;
-    CARD8		    *extra;
-    unsigned long	    extraLen;
-
-    REQUEST_SIZE_MATCH(xRRGetScreenInfoReq);
-    pWin = (WindowPtr)SecurityLookupWindow(stuff-&gt;window, client,
-					   SecurityReadAccess);
-
-    if (!pWin)
-	return BadWindow;
-
-    pScreen = pWin-&gt;drawable.pScreen;
-    pScrPriv = rrGetScrPriv(pScreen);
-    rep.pad = 0;
-    if (!pScrPriv)
-    {
-	rep.type = X_Reply;
-	rep.setOfRotations = RR_Rotate_0;;
-	rep.sequenceNumber = client-&gt;sequence;
-	rep.length = 0;
-	rep.root = WindowTable[pWin-&gt;drawable.pScreen-&gt;myNum]-&gt;drawable.id;
-	rep.timestamp = currentTime.milliseconds;
-	rep.configTimestamp = currentTime.milliseconds;
-	rep.nSizes = 0;
-	rep.sizeID = 0;
-	rep.rotation = RR_Rotate_0;
-	rep.rate = 0;
-	rep.nrateEnts = 0;
-	extra = 0;
-	extraLen = 0;
-    }
-    else
-    {
-	int			i, j;
-	xScreenSizes		*size;
-	CARD16			*rates;
-	CARD8			*data8;
-	Bool			has_rate = RRClientKnowsRates (client);
-    
-	RRGetInfo (pScreen);
-
-	rep.type = X_Reply;
-	rep.setOfRotations = pScrPriv-&gt;rotations;
-	rep.sequenceNumber = client-&gt;sequence;
-	rep.length = 0;
-	rep.root = WindowTable[pWin-&gt;drawable.pScreen-&gt;myNum]-&gt;drawable.id;
-	rep.timestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-	rep.configTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-	rep.rotation = pScrPriv-&gt;rotation;
-	rep.nSizes = pScrPriv-&gt;nSizesInUse;
-	rep.rate = pScrPriv-&gt;rate;
-        rep.nrateEnts = 0;
-	if (has_rate)
-	{
-	    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	    {
-		RRScreenSizePtr pSize = &amp;pScrPriv-&gt;pSizes[i];
-		if (pSize-&gt;referenced)
-		{
-		    rep.nrateEnts += (1 + pSize-&gt;nRatesInUse);
-		}
-	    }
-	}
-
-	if (pScrPriv-&gt;size &gt;= 0)
-	    rep.sizeID = pScrPriv-&gt;pSizes[pScrPriv-&gt;size].id;
-	else
-	    return BadImplementation;
-
-	extraLen = (rep.nSizes * sizeof (xScreenSizes) +
-		    rep.nrateEnts * sizeof (CARD16));
-
-	extra = (CARD8 *) xalloc (extraLen);
-	if (!extra)
-	    return BadAlloc;
-	/*
-	 * First comes the size information
-	 */
-	size = (xScreenSizes *) extra;
-	rates = (CARD16 *) (size + rep.nSizes);
-	for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	{
-	    RRScreenSizePtr pSize = &amp;pScrPriv-&gt;pSizes[i];
-	    if (pSize-&gt;referenced)
-	    {
-		size-&gt;widthInPixels = pSize-&gt;width;
-		size-&gt;heightInPixels = pSize-&gt;height;
-		size-&gt;widthInMillimeters = pSize-&gt;mmWidth;
-		size-&gt;heightInMillimeters = pSize-&gt;mmHeight;
-		if (client-&gt;swapped)
-		{
-		    swaps (&amp;size-&gt;widthInPixels, n);
-		    swaps (&amp;size-&gt;heightInPixels, n);
-		    swaps (&amp;size-&gt;widthInMillimeters, n);
-		    swaps (&amp;size-&gt;heightInMillimeters, n);
-		}
-		size++;
-		if (has_rate)
-		{
-		    *rates = pSize-&gt;nRatesInUse;
-		    if (client-&gt;swapped)
-		    {
-			swaps (rates, n);
-		    }
-		    rates++;
-		    for (j = 0; j &lt; pSize-&gt;nRates; j++)
-		    {
-			RRScreenRatePtr	pRate = &amp;pSize-&gt;pRates[j];
-			if (pRate-&gt;referenced)
-			{
-			    *rates = pRate-&gt;rate;
-			    if (client-&gt;swapped)
-			    {
-				swaps (rates, n);
-			    }
-			    rates++;
-			}
-		    }
-		}
-	    }
-	}
-	data8 = (CARD8 *) rates;
-
-	if (data8 - (CARD8 *) extra != extraLen)
-	    FatalError (&quot;RRGetScreenInfo bad extra len %ld != %ld\n&quot;,
-			(unsigned long)(data8 - (CARD8 *) extra), extraLen);
-	rep.length =  (extraLen + 3) &gt;&gt; 2;
-    }
-    if (client-&gt;swapped) {
-	swaps(&amp;rep.sequenceNumber, n);
-	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.timestamp, n);
-	swaps(&amp;rep.rotation, n);
-	swaps(&amp;rep.nSizes, n);
-	swaps(&amp;rep.sizeID, n);
-	swaps(&amp;rep.rate, n);
-	swaps(&amp;rep.nrateEnts, n);
-    }
-    WriteToClient(client, sizeof(xRRGetScreenInfoReply), (char *)&amp;rep);
-    if (extraLen)
-    {
-	WriteToClient (client, extraLen, (char *) extra);
-	xfree (extra);
-    }
-    return (client-&gt;noClientException);
-}
-
-static int
-ProcRRSetScreenConfig (ClientPtr client)
-{
-    REQUEST(xRRSetScreenConfigReq);
-    xRRSetScreenConfigReply rep;
-    DrawablePtr		    pDraw;
-    int			    n;
-    ScreenPtr		    pScreen;
-    rrScrPrivPtr	    pScrPriv;
-    TimeStamp		    configTime;
-    TimeStamp		    time;
-    RRScreenSizePtr	    pSize;
-    int			    i;
-    Rotation		    rotation;
-    int			    rate;
-    short		    oldWidth, oldHeight;
-    Bool		    has_rate;
-
-    UpdateCurrentTime ();
-
-    if (RRClientKnowsRates (client))
-    {
-	REQUEST_SIZE_MATCH (xRRSetScreenConfigReq);
-	has_rate = TRUE;
-    }
-    else
-    {
-	REQUEST_SIZE_MATCH (xRR1_0SetScreenConfigReq);
-	has_rate = FALSE;
-    }
-    
-    SECURITY_VERIFY_DRAWABLE(pDraw, stuff-&gt;drawable, client,
-			     SecurityWriteAccess);
-
-    pScreen = pDraw-&gt;pScreen;
-
-    pScrPriv = rrGetScrPriv(pScreen);
-    
-    time = ClientTimeToServerTime(stuff-&gt;timestamp);
-    configTime = ClientTimeToServerTime(stuff-&gt;configTimestamp);
-    
-    oldWidth = pScreen-&gt;width;
-    oldHeight = pScreen-&gt;height;
-    
-    if (!pScrPriv)
-    {
-	time = currentTime;
-	rep.status = RRSetConfigFailed;
-	goto sendReply;
-    }
-    if (!RRGetInfo (pScreen))
-	return BadAlloc;
-    
-    /*
-     * if the client's config timestamp is not the same as the last config
-     * timestamp, then the config information isn't up-to-date and
-     * can't even be validated
-     */
-    if (CompareTimeStamps (configTime, pScrPriv-&gt;lastConfigTime) != 0)
-    {
-	rep.status = RRSetConfigInvalidConfigTime;
-	goto sendReply;
-    }
-    
-    /*
-     * Search for the requested size
-     */
-    pSize = 0;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	if (pSize-&gt;referenced &amp;&amp; pSize-&gt;id == stuff-&gt;sizeID)
-	{
-	    break;
-	}
-    }
-    if (i == pScrPriv-&gt;nSizes)
-    {
-	/*
-	 * Invalid size ID
-	 */
-	client-&gt;errorValue = stuff-&gt;sizeID;
-	return BadValue;
-    }
-    
-    /*
-     * Validate requested rotation
-     */
-    rotation = (Rotation) stuff-&gt;rotation;
-
-    /* test the rotation bits only! */
-    switch (rotation &amp; 0xf) {
-    case RR_Rotate_0:
-    case RR_Rotate_90:
-    case RR_Rotate_180:
-    case RR_Rotate_270:
-	break;
-    default:
-	/*
-	 * Invalid rotation
-	 */
-	client-&gt;errorValue = stuff-&gt;rotation;
-	return BadValue;
-    }
-
-    if ((~pScrPriv-&gt;rotations) &amp; rotation)
-    {
-	/*
-	 * requested rotation or reflection not supported by screen
-	 */
-	client-&gt;errorValue = stuff-&gt;rotation;
-	return BadMatch;
-    }
-
-    /*
-     * Validate requested refresh
-     */
-    if (has_rate)
-	rate = (int) stuff-&gt;rate;
-    else
-	rate = 0;
-
-    if (rate)
-    {
-	for (i = 0; i &lt; pSize-&gt;nRates; i++)
-	{
-	    RRScreenRatePtr pRate = &amp;pSize-&gt;pRates[i];
-	    if (pRate-&gt;referenced &amp;&amp; pRate-&gt;rate == rate)
-		break;
-	}
-	if (i == pSize-&gt;nRates)
-	{
-	    /*
-	     * Invalid rate
-	     */
-	    client-&gt;errorValue = rate;
-	    return BadValue;
-	}
-    }
-    
-    /*
-     * Make sure the requested set-time is not older than
-     * the last set-time
-     */
-    if (CompareTimeStamps (time, pScrPriv-&gt;lastSetTime) &lt; 0)
-    {
-	rep.status = RRSetConfigInvalidTime;
-	goto sendReply;
-    }
-
-    /*
-     * call out to ddx routine to effect the change
-     */
-    if (!(*pScrPriv-&gt;rrSetConfig) (pScreen, rotation, rate,
-				   pSize))
-    {
-	/*
-	 * unknown DDX failure, report to client
-	 */
-	rep.status = RRSetConfigFailed;
-	goto sendReply;
-    }
-    
-    /*
-     * set current extension configuration pointers
-     */
-    RRSetCurrentConfig (pScreen, rotation, rate, pSize);
-    
-    /*
-     * Deliver ScreenChangeNotify events whenever
-     * the configuration is updated
-     */
-    WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    
-    /*
-     * Deliver ConfigureNotify events when root changes
-     * pixel size
-     */
-    if (oldWidth != pScreen-&gt;width || oldHeight != pScreen-&gt;height)
-	RRSendConfigNotify (pScreen);
-    RREditConnectionInfo (pScreen);
-    
-    /*
-     * Fix pointer bounds and location
-     */
-    ScreenRestructured (pScreen);
-    pScrPriv-&gt;lastSetTime = time;
-    
-    /*
-     * Report Success
-     */
-    rep.status = RRSetConfigSuccess;
-    
-sendReply:
-    
-    rep.type = X_Reply;
-    /* rep.status has already been filled in */
-    rep.length = 0;
-    rep.sequenceNumber = client-&gt;sequence;
-
-    rep.newTimestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-    rep.newConfigTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-    rep.root = WindowTable[pDraw-&gt;pScreen-&gt;myNum]-&gt;drawable.id;
-
-    if (client-&gt;swapped) 
-    {
-    	swaps(&amp;rep.sequenceNumber, n);
-    	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.newTimestamp, n);
-	swapl(&amp;rep.newConfigTimestamp, n);
-	swapl(&amp;rep.root, n);
-    }
-    WriteToClient(client, sizeof(xRRSetScreenConfigReply), (char *)&amp;rep);
-
-    return (client-&gt;noClientException);
-}
-
-int
-RRSetScreenConfig (ScreenPtr		pScreen,
-		   Rotation		rotation,
-		   int			rate,
-		   RRScreenSizePtr	pSize)
-{
-    rrScrPrivPtr	    pScrPriv;
-    int			    i;
-    short		    oldWidth, oldHeight;
-
-    pScrPriv = rrGetScrPriv(pScreen);
-    
-    oldWidth = pScreen-&gt;width;
-    oldHeight = pScreen-&gt;height;
-    
-    if (!RRGetInfo (pScreen))
-	return BadAlloc;
-    
-    /*
-     * Validate requested rotation
-     */
-
-    /* test the rotation bits only! */
-    switch (rotation &amp; 0xf) {
-    case RR_Rotate_0:
-    case RR_Rotate_90:
-    case RR_Rotate_180:
-    case RR_Rotate_270:
-	break;
-    default:
-	/*
-	 * Invalid rotation
-	 */
-	return BadValue;
-    }
-
-    if ((~pScrPriv-&gt;rotations) &amp; rotation)
-    {
-	/*
-	 * requested rotation or reflection not supported by screen
-	 */
-	return BadMatch;
-    }
-
-    /*
-     * Validate requested refresh
-     */
-    if (rate)
-    {
-	for (i = 0; i &lt; pSize-&gt;nRates; i++)
-	{
-	    RRScreenRatePtr pRate = &amp;pSize-&gt;pRates[i];
-	    if (pRate-&gt;referenced &amp;&amp; pRate-&gt;rate == rate)
-		break;
-	}
-	if (i == pSize-&gt;nRates)
-	{
-	    /*
-	     * Invalid rate
-	     */
-	    return BadValue;
-	}
-    }
-
-    /*
-     * call out to ddx routine to effect the change
-     */
-    if (!(*pScrPriv-&gt;rrSetConfig) (pScreen, rotation, rate,
-				   pSize))
-    {
-	/*
-	 * unknown DDX failure, report to client
-	 */
-        return BadImplementation;
-    }
-    
-    /*
-     * set current extension configuration pointers
-     */
-    RRSetCurrentConfig (pScreen, rotation, rate, pSize);
-    
-    /*
-     * Deliver ScreenChangeNotify events whenever
-     * the configuration is updated
-     */
-    WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    
-    /*
-     * Deliver ConfigureNotify events when root changes
-     * pixel size
-     */
-    if (oldWidth != pScreen-&gt;width || oldHeight != pScreen-&gt;height)
-	RRSendConfigNotify (pScreen);
-    RREditConnectionInfo (pScreen);
-    
-    /*
-     * Fix pointer bounds and location
-     */
-    ScreenRestructured (pScreen);
-    
-    return Success;
-}
-
-static int
-ProcRRSelectInput (ClientPtr client)
-{
-    REQUEST(xRRSelectInputReq);
-    rrClientPriv(client);
-    RRTimesPtr	pTimes;
-    WindowPtr	pWin;
-    RREventPtr	pRREvent, pNewRREvent, *pHead;
-    XID		clientResource;
-
-    REQUEST_SIZE_MATCH(xRRSelectInputReq);
-    pWin = SecurityLookupWindow (stuff-&gt;window, client, SecurityWriteAccess);
-    if (!pWin)
-	return BadWindow;
-    pHead = (RREventPtr *)SecurityLookupIDByType(client,
-						 pWin-&gt;drawable.id, EventType,
-						 SecurityWriteAccess);
-
-    if (stuff-&gt;enable &amp; (RRScreenChangeNotifyMask)) 
-    {
-	ScreenPtr	pScreen = pWin-&gt;drawable.pScreen;
-	rrScrPriv	(pScreen);
-
-	if (pHead) 
-	{
-	    /* check for existing entry. */
-	    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next)
-		if (pRREvent-&gt;client == client)
-		    return Success;
-	}
-
-	/* build the entry */
-	pNewRREvent = (RREventPtr) xalloc (sizeof (RREventRec));
-	if (!pNewRREvent)
-	    return BadAlloc;
-	pNewRREvent-&gt;next = 0;
-	pNewRREvent-&gt;client = client;
-	pNewRREvent-&gt;window = pWin;
-	pNewRREvent-&gt;mask = stuff-&gt;enable;
-	/*
-	 * add a resource that will be deleted when
-	 * the client goes away
-	 */
-	clientResource = FakeClientID (client-&gt;index);
-	pNewRREvent-&gt;clientResource = clientResource;
-	if (!AddResource (clientResource, ClientType, (pointer)pNewRREvent))
-	    return BadAlloc;
-	/*
-	 * create a resource to contain a pointer to the list
-	 * of clients selecting input.  This must be indirect as
-	 * the list may be arbitrarily rearranged which cannot be
-	 * done through the resource database.
-	 */
-	if (!pHead)
-	{
-	    pHead = (RREventPtr *) xalloc (sizeof (RREventPtr));
-	    if (!pHead ||
-		!AddResource (pWin-&gt;drawable.id, EventType, (pointer)pHead))
-	    {
-		FreeResource (clientResource, RT_NONE);
-		return BadAlloc;
-	    }
-	    *pHead = 0;
-	}
-	pNewRREvent-&gt;next = *pHead;
-	*pHead = pNewRREvent;
-	/*
-	 * Now see if the client needs an event
-	 */
-	if (pScrPriv)
-	{
-	    pTimes = &amp;((RRTimesPtr) (pRRClient + 1))[pScreen-&gt;myNum];
-	    if (CompareTimeStamps (pTimes-&gt;setTime, 
-				   pScrPriv-&gt;lastSetTime) != 0 ||
-		CompareTimeStamps (pTimes-&gt;configTime, 
-				   pScrPriv-&gt;lastConfigTime) != 0)
-	    {
-		TellChanged (pWin, (pointer) pScreen);
-	    }
-	}
-    }
-    else if (stuff-&gt;enable == xFalse) 
-    {
-	/* delete the interest */
-	if (pHead) {
-	    pNewRREvent = 0;
-	    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next) {
-		if (pRREvent-&gt;client == client)
-		    break;
-		pNewRREvent = pRREvent;
-	    }
-	    if (pRREvent) {
-		FreeResource (pRREvent-&gt;clientResource, ClientType);
-		if (pNewRREvent)
-		    pNewRREvent-&gt;next = pRREvent-&gt;next;
-		else
-		    *pHead = pRREvent-&gt;next;
-		xfree (pRREvent);
-	    }
-	}
-    }
-    else 
-    {
-	client-&gt;errorValue = stuff-&gt;enable;
-	return BadValue;
-    }
-    return Success;
-}
-
-
-static int
-ProcRRDispatch (ClientPtr client)
-{
-    REQUEST(xReq);
-    switch (stuff-&gt;data)
-    {
-    case X_RRQueryVersion:
-	return ProcRRQueryVersion(client);
-    case X_RRSetScreenConfig:
-        return ProcRRSetScreenConfig(client);
-    case X_RRSelectInput:
-        return ProcRRSelectInput(client);
-    case X_RRGetScreenInfo:
-        return ProcRRGetScreenInfo(client);
-    default:
-	return BadRequest;
-    }
-}
-
-static int
-SProcRRQueryVersion (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRQueryVersionReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;majorVersion, n);
-    swapl(&amp;stuff-&gt;minorVersion, n);
-    return ProcRRQueryVersion(client);
-}
-
-static int
-SProcRRGetScreenInfo (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRGetScreenInfoReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;window, n);
-    return ProcRRGetScreenInfo(client);
-}
-
-static int
-SProcRRSetScreenConfig (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRSetScreenConfigReq);
-
-    if (RRClientKnowsRates (client))
-    {
-	REQUEST_SIZE_MATCH (xRRSetScreenConfigReq);
-	swaps (&amp;stuff-&gt;rate, n);
-    }
-    else
-    {
-	REQUEST_SIZE_MATCH (xRR1_0SetScreenConfigReq);
-    }
-    
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;drawable, n);
-    swapl(&amp;stuff-&gt;timestamp, n);
-    swaps(&amp;stuff-&gt;sizeID, n);
-    swaps(&amp;stuff-&gt;rotation, n);
-    return ProcRRSetScreenConfig(client);
-}
-
-static int
-SProcRRSelectInput (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRSelectInputReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;window, n);
-    return ProcRRSelectInput(client);
-}
-
-
-static int
-SProcRRDispatch (ClientPtr client)
-{
-    REQUEST(xReq);
-    switch (stuff-&gt;data)
-    {
-    case X_RRQueryVersion:
-	return SProcRRQueryVersion(client);
-    case X_RRSetScreenConfig:
-        return SProcRRSetScreenConfig(client);
-    case X_RRSelectInput:
-        return SProcRRSelectInput(client);
-    case X_RRGetScreenInfo:
-        return SProcRRGetScreenInfo(client);
-    default:
-	return BadRequest;
-    }
-}
-
-
-static Bool
-RRScreenSizeMatches (RRScreenSizePtr  a,
-		   RRScreenSizePtr  b)
-{
-    if (a-&gt;width != b-&gt;width)
-	return FALSE;
-    if (a-&gt;height != b-&gt;height)
-	return FALSE;
-    if (a-&gt;mmWidth != b-&gt;mmWidth)
-	return FALSE;
-    if (a-&gt;mmHeight != b-&gt;mmHeight)
-	return FALSE;
-    return TRUE;
-}
-
-RRScreenSizePtr
-RRRegisterSize (ScreenPtr	    pScreen,
-		short		    width, 
-		short		    height,
-		short		    mmWidth,
-		short		    mmHeight)
-{
-    rrScrPriv (pScreen);
-    int		    i;
-    RRScreenSize    tmp;
-    RRScreenSizePtr pNew;
-
-    if (!pScrPriv)
-	return 0;
-
-    /*
-     * FIXME: The compiler reports that field
-     * id is used uninitialized here.
-     */
-
-    tmp.id = 0;
-    
-    tmp.width = width;
-    tmp.height= height;
-    tmp.mmWidth = mmWidth;
-    tmp.mmHeight = mmHeight;
-    tmp.pRates = 0;
-    tmp.nRates = 0;
-    tmp.nRatesInUse = 0;
-    tmp.referenced = TRUE;
-    tmp.oldReferenced = FALSE;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	if (RRScreenSizeMatches (&amp;tmp, &amp;pScrPriv-&gt;pSizes[i]))
-	{
-	    pScrPriv-&gt;pSizes[i].referenced = TRUE;
-	    return &amp;pScrPriv-&gt;pSizes[i];
-	}
-    pNew = xrealloc (pScrPriv-&gt;pSizes,
-		     (pScrPriv-&gt;nSizes + 1) * sizeof (RRScreenSize));
-    if (!pNew)
-	return 0;
-    pNew[pScrPriv-&gt;nSizes++] = tmp;
-    pScrPriv-&gt;pSizes = pNew;
-    return &amp;pNew[pScrPriv-&gt;nSizes-1];
-}
-
-Bool RRRegisterRate (ScreenPtr		pScreen,
-		     RRScreenSizePtr	pSize,
-		     int		rate)
-{
-    rrScrPriv(pScreen);
-    int		    i;
-    RRScreenRatePtr pNew, pRate;
-
-    if (!pScrPriv)
-	return FALSE;
-    
-    for (i = 0; i &lt; pSize-&gt;nRates; i++)
-    {
-	pRate = &amp;pSize-&gt;pRates[i];
-	if (pRate-&gt;rate == rate)
-	{
-	    pRate-&gt;referenced = TRUE;
-	    return TRUE;
-	}
-    }
-
-    pNew = xrealloc (pSize-&gt;pRates,
-		     (pSize-&gt;nRates + 1) * sizeof (RRScreenRate));
-    if (!pNew)
-	return FALSE;
-    pRate = &amp;pNew[pSize-&gt;nRates++];
-    pRate-&gt;rate = rate;
-    pRate-&gt;referenced = TRUE;
-    pRate-&gt;oldReferenced = FALSE;
-    pSize-&gt;pRates = pNew;
-    return TRUE;
-}
-
-void
-RRSetCurrentConfig (ScreenPtr		pScreen,
-		    Rotation		rotation,
-		    int			rate,
-		    RRScreenSizePtr	pSize)
-{
-    rrScrPriv (pScreen);
-
-    if (!pScrPriv)
-	return;
-
-    pScrPriv-&gt;rotation = rotation;
-    pScrPriv-&gt;size = pSize - pScrPriv-&gt;pSizes;
-    pScrPriv-&gt;rate = rate;
-}
-
diff --git a/nx-X11/programs/Xserver/hw/nxagent/X/NXrandr.c.X.original b/nx-X11/programs/Xserver/hw/nxagent/X/NXrandr.c.X.original
deleted file mode 100644
index 3911a34..0000000
--- a/nx-X11/programs/Xserver/hw/nxagent/X/NXrandr.c.X.original
+++ /dev/null
@@ -1,1319 +0,0 @@
-/*
- * $XFree86: xc/programs/Xserver/randr/randr.c,v 1.21tsi Exp $
- *
- * Copyright &#194;&#169; 2000, Compaq Computer Corporation, 
- * Copyright &#194;&#169; 2002, Hewlett Packard, Inc.
- *
- * Permission to use, copy, modify, distribute, and sell this software and its
- * documentation for any purpose is hereby granted without fee, provided that
- * the above copyright notice appear in all copies and that both that
- * copyright notice and this permission notice appear in supporting
- * documentation, and that the name of Compaq or HP not be used in advertising
- * or publicity pertaining to distribution of the software without specific,
- * written prior permission.  HP makes no representations about the
- * suitability of this software for any purpose.  It is provided &quot;as is&quot;
- * without express or implied warranty.
- *
- * HP DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL
- * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL HP
- * BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
- * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
- * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN 
- * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
- *
- * Author:  Jim Gettys, HP Labs, Hewlett-Packard, Inc.
- */
-
-
-#define NEED_REPLIES
-#define NEED_EVENTS
-#ifdef HAVE_DIX_CONFIG_H
-#include &lt;dix-config.h&gt;
-#endif
-
-#include &lt;X11/X.h&gt;
-#include &lt;X11/Xproto.h&gt;
-#include &quot;misc.h&quot;
-#include &quot;os.h&quot;
-#include &quot;dixstruct.h&quot;
-#include &quot;resource.h&quot;
-#include &quot;scrnintstr.h&quot;
-#include &quot;windowstr.h&quot;
-#include &quot;pixmapstr.h&quot;
-#include &quot;extnsionst.h&quot;
-#include &quot;servermd.h&quot;
-#include &lt;X11/extensions/randr.h&gt;
-#include &lt;X11/extensions/randrproto.h&gt;
-#include &quot;randrstr.h&quot;
-#ifdef RENDER
-#include &lt;X11/extensions/render.h&gt; 	/* we share subpixel order information */
-#include &quot;picturestr.h&quot;
-#endif
-#include &lt;X11/Xfuncproto.h&gt;
-#ifdef EXTMODULE
-#include &quot;xf86_ansic.h&quot;
-#endif
-
-/* From render.h */
-#ifndef SubPixelUnknown
-#define SubPixelUnknown 0
-#endif
-
-#define RR_VALIDATE
-int	RRGeneration;
-int	RRNScreens;
-
-static int ProcRRQueryVersion (ClientPtr pClient);
-static int ProcRRDispatch (ClientPtr pClient);
-static int SProcRRDispatch (ClientPtr pClient);
-static int SProcRRQueryVersion (ClientPtr pClient);
-
-#define wrap(priv,real,mem,func) {\
-    priv-&gt;mem = real-&gt;mem; \
-    real-&gt;mem = func; \
-}
-
-#define unwrap(priv,real,mem) {\
-    real-&gt;mem = priv-&gt;mem; \
-}
-
-#if 0
-static CARD8	RRReqCode;
-static int	RRErrBase;
-#endif
-static int	RREventBase;
-static RESTYPE ClientType, EventType; /* resource types for event masks */
-static int	RRClientPrivateIndex;
-
-typedef struct _RRTimes {
-    TimeStamp	setTime;
-    TimeStamp	configTime;
-} RRTimesRec, *RRTimesPtr;
-
-typedef struct _RRClient {
-    int		major_version;
-    int		minor_version;
-/*  RRTimesRec	times[0]; */
-} RRClientRec, *RRClientPtr;
-
-/*
- * each window has a list of clients requesting
- * RRNotify events.  Each client has a resource
- * for each window it selects RRNotify input for,
- * this resource is used to delete the RRNotifyRec
- * entry from the per-window queue.
- */
-
-typedef struct _RREvent *RREventPtr;
-
-typedef struct _RREvent {
-    RREventPtr  next;
-    ClientPtr	client;
-    WindowPtr	window;
-    XID		clientResource;
-    int		mask;
-} RREventRec;
-
-int	rrPrivIndex = -1;
-
-#define GetRRClient(pClient)    ((RRClientPtr) (pClient)-&gt;devPrivates[RRClientPrivateIndex].ptr)
-#define rrClientPriv(pClient)	RRClientPtr pRRClient = GetRRClient(pClient)
-
-static Bool
-RRClientKnowsRates (ClientPtr	pClient)
-{
-    rrClientPriv(pClient);
-
-    return (pRRClient-&gt;major_version &gt; 1 ||
-	    (pRRClient-&gt;major_version == 1 &amp;&amp; pRRClient-&gt;minor_version &gt;= 1));
-}
-
-static void
-RRClientCallback (CallbackListPtr	*list,
-		  pointer		closure,
-		  pointer		data)
-{
-    NewClientInfoRec	*clientinfo = (NewClientInfoRec *) data;
-    ClientPtr		pClient = clientinfo-&gt;client;
-    rrClientPriv(pClient);
-    RRTimesPtr		pTimes = (RRTimesPtr) (pRRClient + 1);
-    int			i;
-
-    pRRClient-&gt;major_version = 0;
-    pRRClient-&gt;minor_version = 0;
-    for (i = 0; i &lt; screenInfo.numScreens; i++)
-    {
-	ScreenPtr   pScreen = screenInfo.screens[i];
-	rrScrPriv(pScreen);
-
-	if (pScrPriv)
-	{
-	    pTimes[i].setTime = pScrPriv-&gt;lastSetTime;
-	    pTimes[i].configTime = pScrPriv-&gt;lastConfigTime;
-	}
-    }
-}
-
-static void
-RRResetProc (ExtensionEntry *extEntry)
-{
-}
-    
-static Bool
-RRCloseScreen (int i, ScreenPtr pScreen)
-{
-    rrScrPriv(pScreen);
-
-    unwrap (pScrPriv, pScreen, CloseScreen);
-    if (pScrPriv-&gt;pSizes)
-	xfree (pScrPriv-&gt;pSizes);
-    xfree (pScrPriv);
-    RRNScreens -= 1;	/* ok, one fewer screen with RandR running */
-    return (*pScreen-&gt;CloseScreen) (i, pScreen);    
-}
-
-static void
-SRRScreenChangeNotifyEvent(xRRScreenChangeNotifyEvent *from,
-			   xRRScreenChangeNotifyEvent *to)
-{
-    to-&gt;type = from-&gt;type;
-    to-&gt;rotation = from-&gt;rotation;
-    cpswaps(from-&gt;sequenceNumber, to-&gt;sequenceNumber);
-    cpswapl(from-&gt;timestamp, to-&gt;timestamp);
-    cpswapl(from-&gt;configTimestamp, to-&gt;configTimestamp);
-    cpswapl(from-&gt;root, to-&gt;root);
-    cpswapl(from-&gt;window, to-&gt;window);
-    cpswaps(from-&gt;sizeID, to-&gt;sizeID);
-    cpswaps(from-&gt;widthInPixels, to-&gt;widthInPixels);
-    cpswaps(from-&gt;heightInPixels, to-&gt;heightInPixels);
-    cpswaps(from-&gt;widthInMillimeters, to-&gt;widthInMillimeters);
-    cpswaps(from-&gt;heightInMillimeters, to-&gt;heightInMillimeters);
-    cpswaps(from-&gt;subpixelOrder, to-&gt;subpixelOrder);
-}
-
-Bool RRScreenInit(ScreenPtr pScreen)
-{
-    rrScrPrivPtr   pScrPriv;
-
-    if (RRGeneration != serverGeneration)
-    {
-	if ((rrPrivIndex = AllocateScreenPrivateIndex()) &lt; 0)
-	    return FALSE;
-	RRGeneration = serverGeneration;
-    }
-
-    pScrPriv = (rrScrPrivPtr) xalloc (sizeof (rrScrPrivRec));
-    if (!pScrPriv)
-	return FALSE;
-
-    SetRRScreen(pScreen, pScrPriv);
-
-    /*
-     * Calling function best set these function vectors
-     */
-    pScrPriv-&gt;rrSetConfig = 0;
-    pScrPriv-&gt;rrGetInfo = 0;
-    /*
-     * This value doesn't really matter -- any client must call
-     * GetScreenInfo before reading it which will automatically update
-     * the time
-     */
-    pScrPriv-&gt;lastSetTime = currentTime;
-    pScrPriv-&gt;lastConfigTime = currentTime;
-    
-    wrap (pScrPriv, pScreen, CloseScreen, RRCloseScreen);
-
-    pScrPriv-&gt;rotations = RR_Rotate_0;
-    
-    pScrPriv-&gt;nSizes = 0;
-    pScrPriv-&gt;nSizesInUse = 0;
-    pScrPriv-&gt;pSizes = 0;
-    
-    pScrPriv-&gt;rotation = RR_Rotate_0;
-    pScrPriv-&gt;size = -1;
-    
-    RRNScreens += 1;	/* keep count of screens that implement randr */
-    return TRUE;
-}
-
-/*ARGSUSED*/
-static int
-RRFreeClient (pointer data, XID id)
-{
-    RREventPtr   pRREvent;
-    WindowPtr	    pWin;
-    RREventPtr   *pHead, pCur, pPrev;
-
-    pRREvent = (RREventPtr) data;
-    pWin = pRREvent-&gt;window;
-    pHead = (RREventPtr *) LookupIDByType(pWin-&gt;drawable.id, EventType);
-    if (pHead) {
-	pPrev = 0;
-	for (pCur = *pHead; pCur &amp;&amp; pCur != pRREvent; pCur=pCur-&gt;next)
-	    pPrev = pCur;
-	if (pCur)
-	{
-	    if (pPrev)
-	    	pPrev-&gt;next = pRREvent-&gt;next;
-	    else
-	    	*pHead = pRREvent-&gt;next;
-	}
-    }
-    xfree ((pointer) pRREvent);
-    return 1;
-}
-
-/*ARGSUSED*/
-static int
-RRFreeEvents (pointer data, XID id)
-{
-    RREventPtr   *pHead, pCur, pNext;
-
-    pHead = (RREventPtr *) data;
-    for (pCur = *pHead; pCur; pCur = pNext) {
-	pNext = pCur-&gt;next;
-	FreeResource (pCur-&gt;clientResource, ClientType);
-	xfree ((pointer) pCur);
-    }
-    xfree ((pointer) pHead);
-    return 1;
-}
-
-void
-RRExtensionInit (void)
-{
-    ExtensionEntry *extEntry;
-
-    if (RRNScreens == 0) return;
-
-    RRClientPrivateIndex = AllocateClientPrivateIndex ();
-    if (!AllocateClientPrivate (RRClientPrivateIndex,
-				sizeof (RRClientRec) +
-				screenInfo.numScreens * sizeof (RRTimesRec)))
-	return;
-    if (!AddCallback (&amp;ClientStateCallback, RRClientCallback, 0))
-	return;
-
-    ClientType = CreateNewResourceType(RRFreeClient);
-    if (!ClientType)
-	return;
-    EventType = CreateNewResourceType(RRFreeEvents);
-    if (!EventType)
-	return;
-    extEntry = AddExtension (RANDR_NAME, RRNumberEvents, RRNumberErrors,
-			     ProcRRDispatch, SProcRRDispatch,
-			     RRResetProc, StandardMinorOpcode);
-    if (!extEntry)
-	return;
-#if 0
-    RRReqCode = (CARD8) extEntry-&gt;base;
-    RRErrBase = extEntry-&gt;errorBase;
-#endif
-    RREventBase = extEntry-&gt;eventBase;
-    EventSwapVector[RREventBase + RRScreenChangeNotify] = (EventSwapPtr) 
-      SRRScreenChangeNotifyEvent;
-
-    return;
-}
-		
-static int
-TellChanged (WindowPtr pWin, pointer value)
-{
-    RREventPtr			*pHead, pRREvent;
-    ClientPtr			client;
-    xRRScreenChangeNotifyEvent	se;
-    ScreenPtr			pScreen = pWin-&gt;drawable.pScreen;
-    rrScrPriv(pScreen);
-    RRScreenSizePtr		pSize;
-    WindowPtr			pRoot = WindowTable[pScreen-&gt;myNum];
-
-    pHead = (RREventPtr *) LookupIDByType (pWin-&gt;drawable.id, EventType);
-    if (!pHead)
-	return WT_WALKCHILDREN;
-
-    se.type = RRScreenChangeNotify + RREventBase;
-    se.rotation = (CARD8) pScrPriv-&gt;rotation;
-    se.timestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-    se.configTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-    se.root =  pRoot-&gt;drawable.id;
-    se.window = pWin-&gt;drawable.id;
-#ifdef RENDER
-    se.subpixelOrder = PictureGetSubpixelOrder (pScreen);
-#else
-    se.subpixelOrder = SubPixelUnknown;
-#endif
-    if (pScrPriv-&gt;size &gt;= 0)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[pScrPriv-&gt;size];
-	se.sizeID = pSize-&gt;id;
-	se.widthInPixels = pSize-&gt;width;
-	se.heightInPixels = pSize-&gt;height;
-	se.widthInMillimeters = pSize-&gt;mmWidth;
-	se.heightInMillimeters = pSize-&gt;mmHeight;
-    }
-    else
-    {
-	/*
-	 * This &quot;shouldn't happen&quot;, but a broken DDX can
-	 * forget to set the current configuration on GetInfo
-	 */
-	se.sizeID = 0xffff;
-	se.widthInPixels = 0;
-	se.heightInPixels = 0;
-	se.widthInMillimeters = 0;
-	se.heightInMillimeters = 0;
-    }    
-    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next) 
-    {
-	client = pRREvent-&gt;client;
-	if (client == serverClient || client-&gt;clientGone)
-	    continue;
-	se.sequenceNumber = client-&gt;sequence;
-	if(pRREvent-&gt;mask &amp; RRScreenChangeNotifyMask)
-	  WriteEventsToClient (client, 1, (xEvent *) &amp;se);
-    }
-    return WT_WALKCHILDREN;
-}
-
-static Bool
-RRGetInfo (ScreenPtr pScreen)
-{
-    rrScrPriv (pScreen);
-    int		    i, j, k, l;
-    Bool	    changed;
-    Rotation	    rotations;
-    RRScreenSizePtr pSize;
-    RRScreenRatePtr pRate;
-
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	pSize-&gt;oldReferenced = pSize-&gt;referenced;
-	pSize-&gt;referenced = FALSE;
-	for (k = 0; k &lt; pSize-&gt;nRates; k++)
-	{
-	    pRate = &amp;pSize-&gt;pRates[k];
-	    pRate-&gt;oldReferenced = pRate-&gt;referenced;
-	    pRate-&gt;referenced = FALSE;
-	}
-    }
-    if (!(*pScrPriv-&gt;rrGetInfo) (pScreen, &amp;rotations))
-	return FALSE;
-
-    changed = FALSE;
-
-    /*
-     * Check whether anything changed and simultaneously generate
-     * the protocol id values for the objects
-     */
-    if (rotations != pScrPriv-&gt;rotations)
-    {
-	pScrPriv-&gt;rotations = rotations;
-	changed = TRUE;
-    }
-
-    j = 0;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	if (pSize-&gt;oldReferenced != pSize-&gt;referenced)
-	    changed = TRUE;
-	if (pSize-&gt;referenced)
-	    pSize-&gt;id = j++;
-	l = 0;
-	for (k = 0; k &lt; pSize-&gt;nRates; k++)
-	{
-	    pRate = &amp;pSize-&gt;pRates[k];
-	    if (pRate-&gt;oldReferenced != pRate-&gt;referenced)
-		changed = TRUE;
-	    if (pRate-&gt;referenced)
-		l++;
-	}
-	pSize-&gt;nRatesInUse = l;
-    }
-    pScrPriv-&gt;nSizesInUse = j;
-    if (changed)
-    {
-	UpdateCurrentTime ();
-	pScrPriv-&gt;lastConfigTime = currentTime;
-	WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    }
-    return TRUE;
-}
-
-static void
-RRSendConfigNotify (ScreenPtr pScreen)
-{
-    WindowPtr	pWin = WindowTable[pScreen-&gt;myNum];
-    xEvent	event;
-
-    event.u.u.type = ConfigureNotify;
-    event.u.configureNotify.window = pWin-&gt;drawable.id;
-    event.u.configureNotify.aboveSibling = None;
-    event.u.configureNotify.x = 0;
-    event.u.configureNotify.y = 0;
-
-    /* XXX xinerama stuff ? */
-    
-    event.u.configureNotify.width = pWin-&gt;drawable.width;
-    event.u.configureNotify.height = pWin-&gt;drawable.height;
-    event.u.configureNotify.borderWidth = wBorderWidth (pWin);
-    event.u.configureNotify.override = pWin-&gt;overrideRedirect;
-    DeliverEvents(pWin, &amp;event, 1, NullWindow);
-}
-
-static int
-ProcRRQueryVersion (ClientPtr client)
-{
-    xRRQueryVersionReply rep;
-    register int n;
-    REQUEST(xRRQueryVersionReq);
-    rrClientPriv(client);
-
-    REQUEST_SIZE_MATCH(xRRQueryVersionReq);
-    pRRClient-&gt;major_version = stuff-&gt;majorVersion;
-    pRRClient-&gt;minor_version = stuff-&gt;minorVersion;
-    rep.type = X_Reply;
-    rep.length = 0;
-    rep.sequenceNumber = client-&gt;sequence;
-    rep.majorVersion = RANDR_MAJOR;
-    rep.minorVersion = RANDR_MINOR;
-    if (client-&gt;swapped) {
-    	swaps(&amp;rep.sequenceNumber, n);
-    	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.majorVersion, n);
-	swapl(&amp;rep.minorVersion, n);
-    }
-    WriteToClient(client, sizeof(xRRQueryVersionReply), (char *)&amp;rep);
-    return (client-&gt;noClientException);
-}
-
-
-extern char	*ConnectionInfo;
-
-static int padlength[4] = {0, 3, 2, 1};
-
-static void
-RREditConnectionInfo (ScreenPtr pScreen)
-{
-    xConnSetup	    *connSetup;
-    char	    *vendor;
-    xPixmapFormat   *formats;
-    xWindowRoot	    *root;
-    xDepth	    *depth;
-    xVisualType	    *visual;
-    int		    screen = 0;
-    int		    d;
-
-    connSetup = (xConnSetup *) ConnectionInfo;
-    vendor = (char *) connSetup + sizeof (xConnSetup);
-    formats = (xPixmapFormat *) ((char *) vendor +
-				 connSetup-&gt;nbytesVendor +
-				 padlength[connSetup-&gt;nbytesVendor &amp; 3]);
-    root = (xWindowRoot *) ((char *) formats +
-			    sizeof (xPixmapFormat) * screenInfo.numPixmapFormats);
-    while (screen != pScreen-&gt;myNum)
-    {
-	depth = (xDepth *) ((char *) root + 
-			    sizeof (xWindowRoot));
-	for (d = 0; d &lt; root-&gt;nDepths; d++)
-	{
-	    visual = (xVisualType *) ((char *) depth +
-				      sizeof (xDepth));
-	    depth = (xDepth *) ((char *) visual +
-				depth-&gt;nVisuals * sizeof (xVisualType));
-	}
-	root = (xWindowRoot *) ((char *) depth);
-	screen++;
-    }
-    root-&gt;pixWidth = pScreen-&gt;width;
-    root-&gt;pixHeight = pScreen-&gt;height;
-    root-&gt;mmWidth = pScreen-&gt;mmWidth;
-    root-&gt;mmHeight = pScreen-&gt;mmHeight;
-}
-
-static int
-ProcRRGetScreenInfo (ClientPtr client)
-{
-    REQUEST(xRRGetScreenInfoReq);
-    xRRGetScreenInfoReply   rep;
-    WindowPtr	    	    pWin;
-    int			    n;
-    ScreenPtr		    pScreen;
-    rrScrPrivPtr	    pScrPriv;
-    CARD8		    *extra;
-    unsigned long	    extraLen;
-
-    REQUEST_SIZE_MATCH(xRRGetScreenInfoReq);
-    pWin = (WindowPtr)SecurityLookupWindow(stuff-&gt;window, client,
-					   SecurityReadAccess);
-
-    if (!pWin)
-	return BadWindow;
-
-    pScreen = pWin-&gt;drawable.pScreen;
-    pScrPriv = rrGetScrPriv(pScreen);
-    rep.pad = 0;
-    if (!pScrPriv)
-    {
-	rep.type = X_Reply;
-	rep.setOfRotations = RR_Rotate_0;;
-	rep.sequenceNumber = client-&gt;sequence;
-	rep.length = 0;
-	rep.root = WindowTable[pWin-&gt;drawable.pScreen-&gt;myNum]-&gt;drawable.id;
-	rep.timestamp = currentTime.milliseconds;
-	rep.configTimestamp = currentTime.milliseconds;
-	rep.nSizes = 0;
-	rep.sizeID = 0;
-	rep.rotation = RR_Rotate_0;
-	rep.rate = 0;
-	rep.nrateEnts = 0;
-	extra = 0;
-	extraLen = 0;
-    }
-    else
-    {
-	int			i, j;
-	xScreenSizes		*size;
-	CARD16			*rates;
-	CARD8			*data8;
-	Bool			has_rate = RRClientKnowsRates (client);
-    
-	RRGetInfo (pScreen);
-
-	rep.type = X_Reply;
-	rep.setOfRotations = pScrPriv-&gt;rotations;
-	rep.sequenceNumber = client-&gt;sequence;
-	rep.length = 0;
-	rep.root = WindowTable[pWin-&gt;drawable.pScreen-&gt;myNum]-&gt;drawable.id;
-	rep.timestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-	rep.configTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-	rep.rotation = pScrPriv-&gt;rotation;
-	rep.nSizes = pScrPriv-&gt;nSizesInUse;
-	rep.rate = pScrPriv-&gt;rate;
-        rep.nrateEnts = 0;
-	if (has_rate)
-	{
-	    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	    {
-		RRScreenSizePtr pSize = &amp;pScrPriv-&gt;pSizes[i];
-		if (pSize-&gt;referenced)
-		{
-		    rep.nrateEnts += (1 + pSize-&gt;nRatesInUse);
-		}
-	    }
-	}
-
-	if (pScrPriv-&gt;size &gt;= 0)
-	    rep.sizeID = pScrPriv-&gt;pSizes[pScrPriv-&gt;size].id;
-	else
-	    return BadImplementation;
-
-	extraLen = (rep.nSizes * sizeof (xScreenSizes) +
-		    rep.nrateEnts * sizeof (CARD16));
-
-	extra = (CARD8 *) xalloc (extraLen);
-	if (!extra)
-	    return BadAlloc;
-	/*
-	 * First comes the size information
-	 */
-	size = (xScreenSizes *) extra;
-	rates = (CARD16 *) (size + rep.nSizes);
-	for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	{
-	    RRScreenSizePtr pSize = &amp;pScrPriv-&gt;pSizes[i];
-	    if (pSize-&gt;referenced)
-	    {
-		size-&gt;widthInPixels = pSize-&gt;width;
-		size-&gt;heightInPixels = pSize-&gt;height;
-		size-&gt;widthInMillimeters = pSize-&gt;mmWidth;
-		size-&gt;heightInMillimeters = pSize-&gt;mmHeight;
-		if (client-&gt;swapped)
-		{
-		    swaps (&amp;size-&gt;widthInPixels, n);
-		    swaps (&amp;size-&gt;heightInPixels, n);
-		    swaps (&amp;size-&gt;widthInMillimeters, n);
-		    swaps (&amp;size-&gt;heightInMillimeters, n);
-		}
-		size++;
-		if (has_rate)
-		{
-		    *rates = pSize-&gt;nRatesInUse;
-		    if (client-&gt;swapped)
-		    {
-			swaps (rates, n);
-		    }
-		    rates++;
-		    for (j = 0; j &lt; pSize-&gt;nRates; j++)
-		    {
-			RRScreenRatePtr	pRate = &amp;pSize-&gt;pRates[j];
-			if (pRate-&gt;referenced)
-			{
-			    *rates = pRate-&gt;rate;
-			    if (client-&gt;swapped)
-			    {
-				swaps (rates, n);
-			    }
-			    rates++;
-			}
-		    }
-		}
-	    }
-	}
-	data8 = (CARD8 *) rates;
-
-	if (data8 - (CARD8 *) extra != extraLen)
-	    FatalError (&quot;RRGetScreenInfo bad extra len %ld != %ld\n&quot;,
-			(unsigned long)(data8 - (CARD8 *) extra), extraLen);
-	rep.length =  (extraLen + 3) &gt;&gt; 2;
-    }
-    if (client-&gt;swapped) {
-	swaps(&amp;rep.sequenceNumber, n);
-	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.timestamp, n);
-	swaps(&amp;rep.rotation, n);
-	swaps(&amp;rep.nSizes, n);
-	swaps(&amp;rep.sizeID, n);
-	swaps(&amp;rep.rate, n);
-	swaps(&amp;rep.nrateEnts, n);
-    }
-    WriteToClient(client, sizeof(xRRGetScreenInfoReply), (char *)&amp;rep);
-    if (extraLen)
-    {
-	WriteToClient (client, extraLen, (char *) extra);
-	xfree (extra);
-    }
-    return (client-&gt;noClientException);
-}
-
-static int
-ProcRRSetScreenConfig (ClientPtr client)
-{
-    REQUEST(xRRSetScreenConfigReq);
-    xRRSetScreenConfigReply rep;
-    DrawablePtr		    pDraw;
-    int			    n;
-    ScreenPtr		    pScreen;
-    rrScrPrivPtr	    pScrPriv;
-    TimeStamp		    configTime;
-    TimeStamp		    time;
-    RRScreenSizePtr	    pSize;
-    int			    i;
-    Rotation		    rotation;
-    int			    rate;
-    short		    oldWidth, oldHeight;
-    Bool		    has_rate;
-
-    UpdateCurrentTime ();
-
-    if (RRClientKnowsRates (client))
-    {
-	REQUEST_SIZE_MATCH (xRRSetScreenConfigReq);
-	has_rate = TRUE;
-    }
-    else
-    {
-	REQUEST_SIZE_MATCH (xRR1_0SetScreenConfigReq);
-	has_rate = FALSE;
-    }
-    
-    SECURITY_VERIFY_DRAWABLE(pDraw, stuff-&gt;drawable, client,
-			     SecurityWriteAccess);
-
-    pScreen = pDraw-&gt;pScreen;
-
-    pScrPriv = rrGetScrPriv(pScreen);
-    
-    time = ClientTimeToServerTime(stuff-&gt;timestamp);
-    configTime = ClientTimeToServerTime(stuff-&gt;configTimestamp);
-    
-    oldWidth = pScreen-&gt;width;
-    oldHeight = pScreen-&gt;height;
-    
-    if (!pScrPriv)
-    {
-	time = currentTime;
-	rep.status = RRSetConfigFailed;
-	goto sendReply;
-    }
-    if (!RRGetInfo (pScreen))
-	return BadAlloc;
-    
-    /*
-     * if the client's config timestamp is not the same as the last config
-     * timestamp, then the config information isn't up-to-date and
-     * can't even be validated
-     */
-    if (CompareTimeStamps (configTime, pScrPriv-&gt;lastConfigTime) != 0)
-    {
-	rep.status = RRSetConfigInvalidConfigTime;
-	goto sendReply;
-    }
-    
-    /*
-     * Search for the requested size
-     */
-    pSize = 0;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-    {
-	pSize = &amp;pScrPriv-&gt;pSizes[i];
-	if (pSize-&gt;referenced &amp;&amp; pSize-&gt;id == stuff-&gt;sizeID)
-	{
-	    break;
-	}
-    }
-    if (i == pScrPriv-&gt;nSizes)
-    {
-	/*
-	 * Invalid size ID
-	 */
-	client-&gt;errorValue = stuff-&gt;sizeID;
-	return BadValue;
-    }
-    
-    /*
-     * Validate requested rotation
-     */
-    rotation = (Rotation) stuff-&gt;rotation;
-
-    /* test the rotation bits only! */
-    switch (rotation &amp; 0xf) {
-    case RR_Rotate_0:
-    case RR_Rotate_90:
-    case RR_Rotate_180:
-    case RR_Rotate_270:
-	break;
-    default:
-	/*
-	 * Invalid rotation
-	 */
-	client-&gt;errorValue = stuff-&gt;rotation;
-	return BadValue;
-    }
-
-    if ((~pScrPriv-&gt;rotations) &amp; rotation)
-    {
-	/*
-	 * requested rotation or reflection not supported by screen
-	 */
-	client-&gt;errorValue = stuff-&gt;rotation;
-	return BadMatch;
-    }
-
-    /*
-     * Validate requested refresh
-     */
-    if (has_rate)
-	rate = (int) stuff-&gt;rate;
-    else
-	rate = 0;
-
-    if (rate)
-    {
-	for (i = 0; i &lt; pSize-&gt;nRates; i++)
-	{
-	    RRScreenRatePtr pRate = &amp;pSize-&gt;pRates[i];
-	    if (pRate-&gt;referenced &amp;&amp; pRate-&gt;rate == rate)
-		break;
-	}
-	if (i == pSize-&gt;nRates)
-	{
-	    /*
-	     * Invalid rate
-	     */
-	    client-&gt;errorValue = rate;
-	    return BadValue;
-	}
-    }
-    
-    /*
-     * Make sure the requested set-time is not older than
-     * the last set-time
-     */
-    if (CompareTimeStamps (time, pScrPriv-&gt;lastSetTime) &lt; 0)
-    {
-	rep.status = RRSetConfigInvalidTime;
-	goto sendReply;
-    }
-
-    /*
-     * call out to ddx routine to effect the change
-     */
-    if (!(*pScrPriv-&gt;rrSetConfig) (pScreen, rotation, rate,
-				   pSize))
-    {
-	/*
-	 * unknown DDX failure, report to client
-	 */
-	rep.status = RRSetConfigFailed;
-	goto sendReply;
-    }
-    
-    /*
-     * set current extension configuration pointers
-     */
-    RRSetCurrentConfig (pScreen, rotation, rate, pSize);
-    
-    /*
-     * Deliver ScreenChangeNotify events whenever
-     * the configuration is updated
-     */
-    WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    
-    /*
-     * Deliver ConfigureNotify events when root changes
-     * pixel size
-     */
-    if (oldWidth != pScreen-&gt;width || oldHeight != pScreen-&gt;height)
-	RRSendConfigNotify (pScreen);
-    RREditConnectionInfo (pScreen);
-    
-    /*
-     * Fix pointer bounds and location
-     */
-    ScreenRestructured (pScreen);
-    pScrPriv-&gt;lastSetTime = time;
-    
-    /*
-     * Report Success
-     */
-    rep.status = RRSetConfigSuccess;
-    
-sendReply:
-    
-    rep.type = X_Reply;
-    /* rep.status has already been filled in */
-    rep.length = 0;
-    rep.sequenceNumber = client-&gt;sequence;
-
-    rep.newTimestamp = pScrPriv-&gt;lastSetTime.milliseconds;
-    rep.newConfigTimestamp = pScrPriv-&gt;lastConfigTime.milliseconds;
-    rep.root = WindowTable[pDraw-&gt;pScreen-&gt;myNum]-&gt;drawable.id;
-
-    if (client-&gt;swapped) 
-    {
-    	swaps(&amp;rep.sequenceNumber, n);
-    	swapl(&amp;rep.length, n);
-	swapl(&amp;rep.newTimestamp, n);
-	swapl(&amp;rep.newConfigTimestamp, n);
-	swapl(&amp;rep.root, n);
-    }
-    WriteToClient(client, sizeof(xRRSetScreenConfigReply), (char *)&amp;rep);
-
-    return (client-&gt;noClientException);
-}
-
-int
-RRSetScreenConfig (ScreenPtr		pScreen,
-		   Rotation		rotation,
-		   int			rate,
-		   RRScreenSizePtr	pSize)
-{
-    rrScrPrivPtr	    pScrPriv;
-    int			    i;
-    short		    oldWidth, oldHeight;
-
-    pScrPriv = rrGetScrPriv(pScreen);
-    
-    oldWidth = pScreen-&gt;width;
-    oldHeight = pScreen-&gt;height;
-    
-    if (!RRGetInfo (pScreen))
-	return BadAlloc;
-    
-    /*
-     * Validate requested rotation
-     */
-
-    /* test the rotation bits only! */
-    switch (rotation &amp; 0xf) {
-    case RR_Rotate_0:
-    case RR_Rotate_90:
-    case RR_Rotate_180:
-    case RR_Rotate_270:
-	break;
-    default:
-	/*
-	 * Invalid rotation
-	 */
-	return BadValue;
-    }
-
-    if ((~pScrPriv-&gt;rotations) &amp; rotation)
-    {
-	/*
-	 * requested rotation or reflection not supported by screen
-	 */
-	return BadMatch;
-    }
-
-    /*
-     * Validate requested refresh
-     */
-    if (rate)
-    {
-	for (i = 0; i &lt; pSize-&gt;nRates; i++)
-	{
-	    RRScreenRatePtr pRate = &amp;pSize-&gt;pRates[i];
-	    if (pRate-&gt;referenced &amp;&amp; pRate-&gt;rate == rate)
-		break;
-	}
-	if (i == pSize-&gt;nRates)
-	{
-	    /*
-	     * Invalid rate
-	     */
-	    return BadValue;
-	}
-    }
-
-    /*
-     * call out to ddx routine to effect the change
-     */
-    if (!(*pScrPriv-&gt;rrSetConfig) (pScreen, rotation, rate,
-				   pSize))
-    {
-	/*
-	 * unknown DDX failure, report to client
-	 */
-        return BadImplementation;
-    }
-    
-    /*
-     * set current extension configuration pointers
-     */
-    RRSetCurrentConfig (pScreen, rotation, rate, pSize);
-    
-    /*
-     * Deliver ScreenChangeNotify events whenever
-     * the configuration is updated
-     */
-    WalkTree (pScreen, TellChanged, (pointer) pScreen);
-    
-    /*
-     * Deliver ConfigureNotify events when root changes
-     * pixel size
-     */
-    if (oldWidth != pScreen-&gt;width || oldHeight != pScreen-&gt;height)
-	RRSendConfigNotify (pScreen);
-    RREditConnectionInfo (pScreen);
-    
-    /*
-     * Fix pointer bounds and location
-     */
-    ScreenRestructured (pScreen);
-    
-    return Success;
-}
-
-static int
-ProcRRSelectInput (ClientPtr client)
-{
-    REQUEST(xRRSelectInputReq);
-    rrClientPriv(client);
-    RRTimesPtr	pTimes;
-    WindowPtr	pWin;
-    RREventPtr	pRREvent, pNewRREvent, *pHead;
-    XID		clientResource;
-
-    REQUEST_SIZE_MATCH(xRRSelectInputReq);
-    pWin = SecurityLookupWindow (stuff-&gt;window, client, SecurityWriteAccess);
-    if (!pWin)
-	return BadWindow;
-    pHead = (RREventPtr *)SecurityLookupIDByType(client,
-						 pWin-&gt;drawable.id, EventType,
-						 SecurityWriteAccess);
-
-    if (stuff-&gt;enable &amp; (RRScreenChangeNotifyMask)) 
-    {
-	ScreenPtr	pScreen = pWin-&gt;drawable.pScreen;
-	rrScrPriv	(pScreen);
-
-	if (pHead) 
-	{
-	    /* check for existing entry. */
-	    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next)
-		if (pRREvent-&gt;client == client)
-		    return Success;
-	}
-
-	/* build the entry */
-	pNewRREvent = (RREventPtr) xalloc (sizeof (RREventRec));
-	if (!pNewRREvent)
-	    return BadAlloc;
-	pNewRREvent-&gt;next = 0;
-	pNewRREvent-&gt;client = client;
-	pNewRREvent-&gt;window = pWin;
-	pNewRREvent-&gt;mask = stuff-&gt;enable;
-	/*
-	 * add a resource that will be deleted when
-	 * the client goes away
-	 */
-	clientResource = FakeClientID (client-&gt;index);
-	pNewRREvent-&gt;clientResource = clientResource;
-	if (!AddResource (clientResource, ClientType, (pointer)pNewRREvent))
-	    return BadAlloc;
-	/*
-	 * create a resource to contain a pointer to the list
-	 * of clients selecting input.  This must be indirect as
-	 * the list may be arbitrarily rearranged which cannot be
-	 * done through the resource database.
-	 */
-	if (!pHead)
-	{
-	    pHead = (RREventPtr *) xalloc (sizeof (RREventPtr));
-	    if (!pHead ||
-		!AddResource (pWin-&gt;drawable.id, EventType, (pointer)pHead))
-	    {
-		FreeResource (clientResource, RT_NONE);
-		return BadAlloc;
-	    }
-	    *pHead = 0;
-	}
-	pNewRREvent-&gt;next = *pHead;
-	*pHead = pNewRREvent;
-	/*
-	 * Now see if the client needs an event
-	 */
-	if (pScrPriv)
-	{
-	    pTimes = &amp;((RRTimesPtr) (pRRClient + 1))[pScreen-&gt;myNum];
-	    if (CompareTimeStamps (pTimes-&gt;setTime, 
-				   pScrPriv-&gt;lastSetTime) != 0 ||
-		CompareTimeStamps (pTimes-&gt;configTime, 
-				   pScrPriv-&gt;lastConfigTime) != 0)
-	    {
-		TellChanged (pWin, (pointer) pScreen);
-	    }
-	}
-    }
-    else if (stuff-&gt;enable == xFalse) 
-    {
-	/* delete the interest */
-	if (pHead) {
-	    pNewRREvent = 0;
-	    for (pRREvent = *pHead; pRREvent; pRREvent = pRREvent-&gt;next) {
-		if (pRREvent-&gt;client == client)
-		    break;
-		pNewRREvent = pRREvent;
-	    }
-	    if (pRREvent) {
-		FreeResource (pRREvent-&gt;clientResource, ClientType);
-		if (pNewRREvent)
-		    pNewRREvent-&gt;next = pRREvent-&gt;next;
-		else
-		    *pHead = pRREvent-&gt;next;
-		xfree (pRREvent);
-	    }
-	}
-    }
-    else 
-    {
-	client-&gt;errorValue = stuff-&gt;enable;
-	return BadValue;
-    }
-    return Success;
-}
-
-
-static int
-ProcRRDispatch (ClientPtr client)
-{
-    REQUEST(xReq);
-    switch (stuff-&gt;data)
-    {
-    case X_RRQueryVersion:
-	return ProcRRQueryVersion(client);
-    case X_RRSetScreenConfig:
-        return ProcRRSetScreenConfig(client);
-    case X_RRSelectInput:
-        return ProcRRSelectInput(client);
-    case X_RRGetScreenInfo:
-        return ProcRRGetScreenInfo(client);
-    default:
-	return BadRequest;
-    }
-}
-
-static int
-SProcRRQueryVersion (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRQueryVersionReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;majorVersion, n);
-    swapl(&amp;stuff-&gt;minorVersion, n);
-    return ProcRRQueryVersion(client);
-}
-
-static int
-SProcRRGetScreenInfo (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRGetScreenInfoReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;window, n);
-    return ProcRRGetScreenInfo(client);
-}
-
-static int
-SProcRRSetScreenConfig (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRSetScreenConfigReq);
-
-    if (RRClientKnowsRates (client))
-    {
-	REQUEST_SIZE_MATCH (xRRSetScreenConfigReq);
-	swaps (&amp;stuff-&gt;rate, n);
-    }
-    else
-    {
-	REQUEST_SIZE_MATCH (xRR1_0SetScreenConfigReq);
-    }
-    
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;drawable, n);
-    swapl(&amp;stuff-&gt;timestamp, n);
-    swaps(&amp;stuff-&gt;sizeID, n);
-    swaps(&amp;stuff-&gt;rotation, n);
-    return ProcRRSetScreenConfig(client);
-}
-
-static int
-SProcRRSelectInput (ClientPtr client)
-{
-    register int n;
-    REQUEST(xRRSelectInputReq);
-
-    swaps(&amp;stuff-&gt;length, n);
-    swapl(&amp;stuff-&gt;window, n);
-    return ProcRRSelectInput(client);
-}
-
-
-static int
-SProcRRDispatch (ClientPtr client)
-{
-    REQUEST(xReq);
-    switch (stuff-&gt;data)
-    {
-    case X_RRQueryVersion:
-	return SProcRRQueryVersion(client);
-    case X_RRSetScreenConfig:
-        return SProcRRSetScreenConfig(client);
-    case X_RRSelectInput:
-        return SProcRRSelectInput(client);
-    case X_RRGetScreenInfo:
-        return SProcRRGetScreenInfo(client);
-    default:
-	return BadRequest;
-    }
-}
-
-
-static Bool
-RRScreenSizeMatches (RRScreenSizePtr  a,
-		   RRScreenSizePtr  b)
-{
-    if (a-&gt;width != b-&gt;width)
-	return FALSE;
-    if (a-&gt;height != b-&gt;height)
-	return FALSE;
-    if (a-&gt;mmWidth != b-&gt;mmWidth)
-	return FALSE;
-    if (a-&gt;mmHeight != b-&gt;mmHeight)
-	return FALSE;
-    return TRUE;
-}
-
-RRScreenSizePtr
-RRRegisterSize (ScreenPtr	    pScreen,
-		short		    width, 
-		short		    height,
-		short		    mmWidth,
-		short		    mmHeight)
-{
-    rrScrPriv (pScreen);
-    int		    i;
-    RRScreenSize    tmp;
-    RRScreenSizePtr pNew;
-
-    if (!pScrPriv)
-	return 0;
-    
-    tmp.width = width;
-    tmp.height= height;
-    tmp.mmWidth = mmWidth;
-    tmp.mmHeight = mmHeight;
-    tmp.pRates = 0;
-    tmp.nRates = 0;
-    tmp.nRatesInUse = 0;
-    tmp.referenced = TRUE;
-    tmp.oldReferenced = FALSE;
-    for (i = 0; i &lt; pScrPriv-&gt;nSizes; i++)
-	if (RRScreenSizeMatches (&amp;tmp, &amp;pScrPriv-&gt;pSizes[i]))
-	{
-	    pScrPriv-&gt;pSizes[i].referenced = TRUE;
-	    return &amp;pScrPriv-&gt;pSizes[i];
-	}
-    pNew = xrealloc (pScrPriv-&gt;pSizes,
-		     (pScrPriv-&gt;nSizes + 1) * sizeof (RRScreenSize));
-    if (!pNew)
-	return 0;
-    pNew[pScrPriv-&gt;nSizes++] = tmp;
-    pScrPriv-&gt;pSizes = pNew;
-    return &amp;pNew[pScrPriv-&gt;nSizes-1];
-}
-
-Bool RRRegisterRate (ScreenPtr		pScreen,
-		     RRScreenSizePtr	pSize,
-		     int		rate)
-{
-    rrScrPriv(pScreen);
-    int		    i;
-    RRScreenRatePtr pNew, pRate;
-
-    if (!pScrPriv)
-	return FALSE;
-    
-    for (i = 0; i &lt; pSize-&gt;nRates; i++)
-    {
-	pRate = &amp;pSize-&gt;pRates[i];
-	if (pRate-&gt;rate == rate)
-	{
-	    pRate-&gt;referenced = TRUE;
-	    return TRUE;
-	}
-    }
-
-    pNew = xrealloc (pSize-&gt;pRates,
-		     (pSize-&gt;nRates + 1) * sizeof (RRScreenRate));
-    if (!pNew)
-	return FALSE;
-    pRate = &amp;pNew[pSize-&gt;nRates++];
-    pRate-&gt;rate = rate;
-    pRate-&gt;referenced = TRUE;
-    pRate-&gt;oldReferenced = FALSE;
-    pSize-&gt;pRates = pNew;
-    return TRUE;
-}
-
-void
-RRSetCurrentConfig (ScreenPtr		pScreen,
-		    Rotation		rotation,
-		    int			rate,
-		    RRScreenSizePtr	pSize)
-{
-    rrScrPriv (pScreen);
-
-    if (!pScrPriv)
-	return;
-
-    pScrPriv-&gt;rotation = rotation;
-    pScrPriv-&gt;size = pSize - pScrPriv-&gt;pSizes;
-    pScrPriv-&gt;rate = rate;
-}


hooks/post-receive
-- 
nx-libs.git (NX (redistributed))

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;nx-libs.git&quot; (NX (redistributed)).

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011339.html">[X2Go-Commits] nx-libs.git - build-main (branch) updated:	nxagent/3.4.0-8
</A></li>
	<LI>Next message: <A HREF="011344.html">[X2Go-Commits] nx-libs.git - build-main (branch) updated:	nxagent/3.5.0-2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11343">[ date ]</a>
              <a href="thread.html#11343">[ thread ]</a>
              <a href="subject.html#11343">[ subject ]</a>
              <a href="author.html#11343">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/x2go-commits">More information about the X2Go-commits
mailing list</a><br>
</body></html>
