<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [X2go-Commits] x2goclient.git - master (branch) updated:	3.99.2.2-58-gdd0bb5c
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/x2go-commits/2012-September/index.html" >
   <LINK REL="made" HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2go-Commits%5D%20x2goclient.git%20-%20master%20%28branch%29%20updated%3A%0A%093.99.2.2-58-gdd0bb5c&In-Reply-To=%3C20120927151210.A296E5DA6C%40ymir%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003315.html">
   <LINK REL="Next"  HREF="003317.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[X2go-Commits] x2goclient.git - master (branch) updated:	3.99.2.2-58-gdd0bb5c</H1>
    <B>X2Go dev team</B> 
    <A HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2go-Commits%5D%20x2goclient.git%20-%20master%20%28branch%29%20updated%3A%0A%093.99.2.2-58-gdd0bb5c&In-Reply-To=%3C20120927151210.A296E5DA6C%40ymir%3E"
       TITLE="[X2go-Commits] x2goclient.git - master (branch) updated:	3.99.2.2-58-gdd0bb5c">git-admin at x2go.org
       </A><BR>
    <I>Thu Sep 27 17:12:10 CEST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="003315.html">[X2go-Commits] pyhoca-gui.git - master (branch) updated:	0.2.0.4-23-g2f79725
</A></li>
        <LI>Next message: <A HREF="003317.html">[X2go-Commits] pyhoca-gui.git - master (branch) updated:	0.2.0.4-24-g965079d
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3316">[ date ]</a>
              <a href="thread.html#3316">[ thread ]</a>
              <a href="subject.html#3316">[ subject ]</a>
              <a href="author.html#3316">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch, master has been updated
       via  dd0bb5c56aab629a2476e7d3890382da462f25d7 (commit)
       via  7fb1879eb1e103522a5c5696e126d81ee4181594 (commit)
       via  5e08c788d5003464b5f576eac1398748bdffc448 (commit)
       via  53a6371c0d98e5735abdbb9971b4aef933524e37 (commit)
      from  6607e91be09fbbf18972e14fa65fef2a71e54833 (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit dd0bb5c56aab629a2476e7d3890382da462f25d7
Author: Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
Date:   Thu Sep 27 17:12:02 2012 +0200

    commandline options --broker-user and --broker-noauth

commit 7fb1879eb1e103522a5c5696e126d81ee4181594
Author: Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
Date:   Thu Sep 27 16:18:11 2012 +0200

    improve brocker code add support for &quot;usebrockerpass&quot; config variable to use brocker pass for ssh auth on X2Go server

commit 5e08c788d5003464b5f576eac1398748bdffc448
Author: Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
Date:   Thu Sep 27 13:23:48 2012 +0200

    it is possible to add several ssh keys from commandline in form: --ssh-key=[user@][server:][port:]&lt;path to key&gt; it can be usefull for TCE or login over broker

commit 53a6371c0d98e5735abdbb9971b4aef933524e37
Author: Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
Date:   Thu Sep 27 12:30:55 2012 +0200

    clean some broker code

-----------------------------------------------------------------------

Summary of changes:
 debian/changelog     |    7 +
 httpbrokerclient.cpp |  372 ++++++++++----------------------------------------
 httpbrokerclient.h   |   11 +-
 onmainwindow.cpp     |  285 ++++++++++++++++++++++++--------------
 onmainwindow.h       |   16 ++-
 5 files changed, 275 insertions(+), 416 deletions(-)

The diff of changes is:
diff --git a/debian/changelog b/debian/changelog
index 682eb7c..3193042 100644
--- a/debian/changelog
+++ b/debian/changelog
@@ -60,6 +60,13 @@ x2goclient (3.99.3.0-0~x2go1) UNRELEASED; urgency=low
     - SshMasterConnection emit signal to GUI thread if it need a passphrase to decrypt a ssh key.
       GUI thread use input dialog to read a passphrase from user
     - Add support for SSH proxy (HTTP and SSH) to X2Go Client Gui
+    - clean some broker code 
+    - it is possible to add several ssh keys from commandline in form:
+      --ssh-key=[user@][server:][port:]&lt;path to key&gt;
+      it can be usefull for TCE or login over broker   
+    - improve brocker code
+      add support for &quot;usebrockerpass&quot; config variable to use brocker pass for ssh auth on X2Go server 
+    - commandline options --broker-user and --broker-noauth
 
   [ Ricardo Diaz ]
   * New upstream version (3.99.3.0):
diff --git a/httpbrokerclient.cpp b/httpbrokerclient.cpp
index 8402e0c..36d3e1b 100644
--- a/httpbrokerclient.cpp
+++ b/httpbrokerclient.cpp
@@ -30,7 +30,6 @@ HttpBrokerClient::HttpBrokerClient ( ONMainWindow* wnd, ConfigFile* cfg )
 {
     config=cfg;
     mainWindow=wnd;
-    cmdRequest=sinfoKeyRequest=sinfoRequest=-1;
     QUrl lurl ( config-&gt;brokerurl );
     http=new QHttp ( this );
 
@@ -45,24 +44,21 @@ HttpBrokerClient::HttpBrokerClient ( ONMainWindow* wnd, ConfigFile* cfg )
               SLOT ( slotRequestFinished ( int,bool ) ) );
     connect ( http,SIGNAL ( sslErrors ( const QList&lt;QSslError&gt;&amp; ) ),this,
               SLOT ( slotSslErrors ( const QList&lt;QSslError&gt;&amp; ) ) );
-    if (!wnd-&gt;brokerMode)
-        getSInfoFromBroker ( true );
 }
 
 
 HttpBrokerClient::~HttpBrokerClient()
 {
-
 }
 
 void HttpBrokerClient::getUserSessions()
 {
     QString req;
     QTextStream ( &amp;req ) &lt;&lt;
-    &quot;task=listsessions&amp;&quot;&lt;&lt;
-    &quot;user=&quot;&lt;&lt;config-&gt;brokerUser&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-    &quot;password=&quot;&lt;&lt;config-&gt;brokerPass&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-    &quot;authid=&quot;&lt;&lt;config-&gt;brokerUserId;
+                         &quot;task=listsessions&amp;&quot;&lt;&lt;
+                         &quot;user=&quot;&lt;&lt;config-&gt;brokerUser&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+                         &quot;password=&quot;&lt;&lt;config-&gt;brokerPass&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+                         &quot;authid=&quot;&lt;&lt;config-&gt;brokerUserId;
     QUrl lurl ( config-&gt;brokerurl );
     httpSessionAnswer.close();
     httpSessionAnswer.setData ( 0,0 );
@@ -76,11 +72,11 @@ void HttpBrokerClient::selectUserSession(const QString&amp; session)
 //     x2goDebug&lt;&lt;&quot;selected sid: &quot;&lt;&lt;session;
     QString req;
     QTextStream ( &amp;req ) &lt;&lt;
-    &quot;task=selectsession&amp;&quot;&lt;&lt;
-    &quot;sid=&quot;&lt;&lt;session&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-    &quot;user=&quot;&lt;&lt;config-&gt;brokerUser&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-    &quot;password=&quot;&lt;&lt;config-&gt;brokerPass&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-    &quot;authid=&quot;&lt;&lt;config-&gt;brokerUserId;
+                         &quot;task=selectsession&amp;&quot;&lt;&lt;
+                         &quot;sid=&quot;&lt;&lt;session&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+                         &quot;user=&quot;&lt;&lt;config-&gt;brokerUser&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+                         &quot;password=&quot;&lt;&lt;config-&gt;brokerPass&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+                         &quot;authid=&quot;&lt;&lt;config-&gt;brokerUserId;
     QUrl lurl ( config-&gt;brokerurl );
     httpSessionAnswer.close();
     httpSessionAnswer.setData ( 0,0 );
@@ -93,11 +89,11 @@ void HttpBrokerClient::changePassword(QString newPass)
     newBrokerPass=newPass;
     QString req;
     QTextStream ( &amp;req ) &lt;&lt;
-    &quot;task=setpass&amp;&quot;&lt;&lt;
-    &quot;newpass=&quot;&lt;&lt;newPass&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-    &quot;user=&quot;&lt;&lt;config-&gt;brokerUser&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-    &quot;password=&quot;&lt;&lt;config-&gt;brokerPass&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-    &quot;authid=&quot;&lt;&lt;config-&gt;brokerUserId;
+                         &quot;task=setpass&amp;&quot;&lt;&lt;
+                         &quot;newpass=&quot;&lt;&lt;newPass&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+                         &quot;user=&quot;&lt;&lt;config-&gt;brokerUser&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+                         &quot;password=&quot;&lt;&lt;config-&gt;brokerPass&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+                         &quot;authid=&quot;&lt;&lt;config-&gt;brokerUserId;
     QUrl lurl ( config-&gt;brokerurl );
     httpSessionAnswer.close();
     httpSessionAnswer.setData ( 0,0 );
@@ -109,14 +105,13 @@ void HttpBrokerClient::testConnection()
 {
     QString req;
     QTextStream ( &amp;req ) &lt;&lt;
-    &quot;task=testcon&quot;;
-    
+                         &quot;task=testcon&quot;;
+
     QUrl lurl ( config-&gt;brokerurl );
     httpSessionAnswer.close();
     httpSessionAnswer.setData ( 0,0 );
     requestTime.start();
     testConRequest=http-&gt;post ( lurl.path(),req.toUtf8(),&amp;httpSessionAnswer );
-
 }
 
 
@@ -134,169 +129,6 @@ void HttpBrokerClient::createIniFile(const QString&amp; content)
     mainWindow-&gt;config.iniFile=cont;
 }
 
-QString HttpBrokerClient::getSInfoFromBroker ( bool getKey )
-{
-
-    QString pack;
-    bool fullscreen;
-    int height;
-    int width;
-    int quality;
-    int speed;
-    bool usekbd;
-    bool setDPI=false;
-    uint dpi=96;
-    QString layout;
-    QString type;
-    QString homeDir=mainWindow-&gt;getHomeDirectory();
-    X2goSettings st( &quot;sessions&quot; );
-
-    QString sid;
-    sid=&quot;embedded&quot;;
-    pack=st.setting()-&gt;value ( sid+&quot;/pack&quot;,
-                               ( QVariant ) &quot;16m-jpeg&quot; ).toString();
-    fullscreen=st.setting()-&gt;value ( sid+&quot;/fullscreen&quot;,
-                                     ( QVariant )
-                                     false ).toBool();
-    height=st.setting()-&gt;value ( sid+&quot;/height&quot;,
-                                 ( QVariant ) 600 ).toInt();
-    width=st.setting()-&gt;value ( sid+&quot;/width&quot;,
-                                ( QVariant ) 800 ).toInt();
-    setDPI=st.setting()-&gt;value ( sid+&quot;/setdpi&quot;,
-                                 ( QVariant ) false ).toBool();
-    dpi=st.setting()-&gt;value ( sid+&quot;/dpi&quot;,
-                              ( QVariant ) 96 ).toUInt();
-    quality=st.setting()-&gt;value (
-                sid+&quot;/quality&quot;,
-                ( QVariant ) 9 ).toInt();
-    speed=st.setting()-&gt;value ( sid+&quot;/speed&quot;,
-                                ( QVariant ) 2 ).toInt();
-    usekbd=st.setting()-&gt;value ( sid+&quot;/usekbd&quot;,
-                                 ( QVariant ) true ).toBool();
-    layout=st.setting()-&gt;value ( sid+&quot;/layout&quot;,
-                                 ( QVariant )
-                                 tr ( &quot;us&quot; ) ).toString();
-    type=st.setting()-&gt;value ( sid+&quot;/type&quot;,
-                               ( QVariant )
-                               tr ( &quot;pc105/us&quot; ) ).toString();
-    bool startEmbedded=false;
-    if ( st.setting()-&gt;value ( sid+&quot;/startembed&quot;,
-                               ( QVariant ) true ).toBool() )
-    {
-        startEmbedded=true;
-        fullscreen=false;
-        QSize sz=mainWindow-&gt;getEmbedAreaSize();
-        height=sz.height();
-        width=sz.width();
-
-    }
-
-    QString geometry;
-    if ( fullscreen )
-    {
-        geometry=&quot;fullscreen&quot;;
-#ifdef Q_OS_WIN
-        fullscreen=false;
-#endif
-    }
-    if ( ! fullscreen )
-    {
-        geometry=QString::number ( width ) +&quot;x&quot;+
-                 QString::number ( height );
-
-    }
-    QString link;
-    switch ( speed )
-    {
-    case 0:
-        link=&quot;modem&quot;;
-        break;
-    case 1:
-        link=&quot;isdn&quot;;
-        break;
-    case 2:
-        link=&quot;adsl&quot;;
-        break;
-    case 3:
-        link=&quot;wan&quot;;
-        break;
-    case 4:
-        link=&quot;lan&quot;;
-        break;
-    }
-
-    QFile file ( &quot;:/txt/packs&quot; );
-    file.open ( QIODevice::ReadOnly | QIODevice::Text );
-    QTextStream in ( &amp;file );
-    while ( !in.atEnd() )
-    {
-        QString pc=in.readLine();
-        if ( pc.indexOf ( &quot;-%&quot; ) !=-1 )
-        {
-            pc=pc.left ( pc.indexOf ( &quot;-%&quot; ) );
-            if ( pc==pack )
-            {
-                pack+=&quot;-&quot;+QString::number ( quality );
-                break;
-            }
-        }
-    }
-    file.close();
-
-    QDesktopWidget wd;
-    QString depth=QString::number ( wd.depth() );
-#ifdef Q_OS_DARWIN
-    usekbd=0;
-    type=&quot;query&quot;;
-#endif
-    QString dpiS;
-    if ( setDPI )
-    {
-        dpiS=QString::number ( dpi );
-    }
-    else
-        dpiS=&quot;noset&quot;;
-    QString useKbdS;
-    if ( usekbd )
-        useKbdS=&quot;1&quot;;
-    else
-        useKbdS=&quot;0&quot;;
-
-
-    QString req;
-    QTextStream ( &amp;req ) &lt;&lt;
-    &quot;mode=getsinfo&amp;&quot;&lt;&lt;
-    &quot;geometry=&quot;&lt;&lt;geometry&lt;&lt;&quot;&amp;&quot;
-    &quot;link=&quot;&lt;&lt;link&lt;&lt;&quot;&amp;&quot;
-    &quot;pack=&quot;&lt;&lt;pack&lt;&lt;&quot;&amp;&quot;
-    &quot;depth=&quot;&lt;&lt;depth&lt;&lt;&quot;&amp;&quot;
-    &quot;layout=&quot;&lt;&lt;layout&lt;&lt;&quot;&amp;&quot;
-    &quot;type=&quot;&lt;&lt;type&lt;&lt;&quot;&amp;&quot;
-    &quot;usekbd=&quot;&lt;&lt;useKbdS&lt;&lt;&quot;&amp;&quot;
-    &quot;dpi=&quot;&lt;&lt;dpiS&lt;&lt;&quot;&amp;&quot;
-    &quot;user=&quot;&lt;&lt;config-&gt;user&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-    &quot;connectionts=&quot;&lt;&lt;config-&gt;connectionts&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-    &quot;cookie=&quot;&lt;&lt;config-&gt;cookie;
-    QUrl lurl ( config-&gt;brokerurl );
-    httpSIAnswer.close();
-    httpSIAnswer.setData ( 0,0 );
-    if ( getKey )
-    {
-        QTextStream ( &amp;req ) &lt;&lt;&quot;&amp;&quot;
-        &quot;getkey=true&quot;;
-        sinfoKeyRequest=http-&gt;post ( lurl.path(),
-                                     req.toUtf8(),&amp;httpSIAnswer );
-        x2goDebug&lt;&lt;&quot;requested key :&quot;&lt;&lt;sinfoKeyRequest;
-    }
-    else
-    {
-        sinfoRequest=http-&gt;post ( lurl.path(),
-                                  req.toUtf8(),&amp;httpSIAnswer );
-        x2goDebug&lt;&lt;&quot;requested session :&quot;&lt;&lt;sinfoRequest;
-    }
-    return QString::null;
-}
-
 
 void HttpBrokerClient::slotRequestFinished ( int id, bool error )
 {
@@ -312,10 +144,10 @@ void HttpBrokerClient::slotRequestFinished ( int id, bool error )
 
     if (id==testConRequest)
     {
-        
+
         //x2goDebug&lt;&lt;&quot;cmd request answer: &quot;&lt;&lt;answer;
-	x2goDebug&lt;&lt;&quot;elapsed: &quot;&lt;&lt;requestTime.elapsed()&lt;&lt;&quot;received:&quot;&lt;&lt;httpSessionAnswer.size()&lt;&lt;endl;
-	emit connectionTime(requestTime.elapsed(),httpSessionAnswer.size());
+        x2goDebug&lt;&lt;&quot;elapsed: &quot;&lt;&lt;requestTime.elapsed()&lt;&lt;&quot;received:&quot;&lt;&lt;httpSessionAnswer.size()&lt;&lt;endl;
+        emit connectionTime(requestTime.elapsed(),httpSessionAnswer.size());
         return;
     }
     if ( id== sessionsRequest || id == selSessRequest || id==chPassRequest)
@@ -339,7 +171,8 @@ void HttpBrokerClient::slotRequestFinished ( int id, bool error )
         }
         if (id == selSessRequest)
         {
-            emit getSession(answer);
+            parseSession(answer);
+
         }
         if ( id == chPassRequest)
         {
@@ -354,67 +187,27 @@ void HttpBrokerClient::slotRequestFinished ( int id, bool error )
 
         }
     }
+}
 
-    if ( id==sinfoKeyRequest || id==sinfoRequest )
-    {
-// 		x2goDebug&lt;&lt;&quot;Answer:&quot;&lt;&lt;httpSIAnswer.data();
-        QString key ( httpSIAnswer.data() );
-        if ( key.indexOf ( &quot;X2GO_BROKER_ERRORR-ACESS DENIED&quot; ) !=-1 )
-        {
-            QMessageBox::critical (
-                0,tr ( &quot;Error&quot; ),
-                tr ( &quot;Your session was disconnected. &quot;
-                     &quot;To get access to your running &quot;
-                     &quot;session, please return to the login page &quot;
-                     &quot;or use the \&quot;reload\&quot; function of &quot;
-                     &quot;your browser.&quot; ) );
-            emit fatalHttpError();
-            return;
-        }
-        QStringList strings=key.split ( &quot;\n&quot; );
-        for ( int i=0;i&lt;strings.count();++i )
-        {
-            if ( strings[i].indexOf ( &quot;x2gosession=&quot; ) !=-1 )
-            {
-                QStringList vals=strings[i].split ( &quot;=&quot; );
-                config-&gt;sessiondata=vals[1];
-            }
-            if ( strings[i]==&quot;rootless=false&quot; )
-            {
-                config-&gt;rootless=false;
-            }
-            if ( strings[i]==&quot;rootless=true&quot; )
-            {
-                config-&gt;rootless=true;
-            }
-        }
-        if ( id==sinfoKeyRequest )
-        {
-            emit haveSshKey ( key );
-            QTimer::singleShot ( 5000, this,
-                                 SLOT ( slotGetConnectionCmd() ) );
-        }
-        else
-            emit haveAgentInfo();
-    }
-    if ( id==cmdRequest )
+void HttpBrokerClient::parseSession(QString sinfo)
+{
+    QStringList lst=sinfo.split(&quot;SERVER:&quot;,QString::SkipEmptyParts);
+    int keyStartPos=sinfo.indexOf(&quot;-----BEGIN DSA PRIVATE KEY-----&quot;);
+    QString endStr=&quot;-----END DSA PRIVATE KEY-----&quot;;
+    int keyEndPos=sinfo.indexOf(endStr);
+    if (! (keyEndPos == -1 || keyStartPos == -1 || lst.size()==0))
+        config-&gt;key=sinfo.mid(keyStartPos, keyEndPos+endStr.length()-keyStartPos);
+    QString serverLine=(lst[1].split(&quot;\n&quot;))[0];
+    QStringList words=serverLine.split(&quot;:&quot;,QString::SkipEmptyParts);
+    config-&gt;serverIp=words[0];
+    if (words.count()&gt;1)
+        config-&gt;sshport=words[1];
+    if (sinfo.indexOf(&quot;SESSION_INFO&quot;)!=-1)
     {
-        QString answer ( httpCmdAnswer.data() );
-//  		x2goDebug&lt;&lt;&quot;cmd request answer: &quot;&lt;&lt;answer;
-        if ( !error )
-        {
-            answer=answer.split (
-                       &quot;&lt;body onload=\&quot;checkPlugin()\&quot;&gt;&quot; ) [1];
-            answer=answer.split ( &quot;&lt;/body&gt;&quot; ) [0];
-            if ( answer.indexOf ( &quot;CMD:0:&quot; ) !=-1 )
-            {
-                x2goDebug&lt;&lt;&quot;brocker sent reconnect cmd&quot;;
-                emit cmdReconnect();
-            }
-        }
-        QTimer::singleShot ( 3000, this,
-                             SLOT ( slotGetConnectionCmd() ) );
+        QStringList lst=sinfo.split(&quot;SESSION_INFO:&quot;,QString::SkipEmptyParts);
+        config-&gt;sessiondata=(lst[1].split(&quot;\n&quot;))[0];
     }
+    emit sessionSelected();
 }
 
 
@@ -422,7 +215,7 @@ void HttpBrokerClient::slotSslErrors ( const QList&lt;QSslError&gt; &amp; errors )
 {
     QStringList err;
     QSslCertificate cert;
-    for ( int i=0;i&lt;errors.count();++i )
+    for ( int i=0; i&lt;errors.count(); ++i )
     {
         x2goDebug&lt;&lt;&quot;sslError ,code:&quot;&lt;&lt;errors[i].error() &lt;&lt;&quot;:&quot;;
         err&lt;&lt;errors[i].errorString();
@@ -463,37 +256,37 @@ void HttpBrokerClient::slotSslErrors ( const QList&lt;QSslError&gt; &amp; errors )
                      text );
     text=QString::null;
     QTextStream ( &amp;text ) &lt;&lt;err.join ( &quot;\n&quot; ) &lt;&lt;&quot;\n&quot;&lt;&lt;
-    &quot;------------\n&quot;&lt;&lt;
-    tr ( &quot;Issued to:\n&quot; ) &lt;&lt;
-    tr ( &quot;Common Name(CN)\t&quot; ) &lt;&lt;
-    cert.issuerInfo ( QSslCertificate::CommonName )
-    &lt;&lt;endl&lt;&lt;
-    tr ( &quot;Organization(O)\t&quot; ) &lt;&lt;
-    cert.issuerInfo ( QSslCertificate::Organization )
-    &lt;&lt;endl&lt;&lt;
-    tr ( &quot;Organizational Unit(OU)\t&quot; ) &lt;&lt;
-    cert.issuerInfo ( QSslCertificate::OrganizationalUnitName )
-    &lt;&lt;endl&lt;&lt;
-    tr ( &quot;Serial Number\t&quot; ) &lt;&lt;getHexVal ( cert.serialNumber() )
-    &lt;&lt;endl&lt;&lt;endl&lt;&lt;
-    tr ( &quot;Issued by:\n&quot; ) &lt;&lt;
-    tr ( &quot;Common Name(CN)\t&quot; ) &lt;&lt;
-    cert.subjectInfo ( QSslCertificate::CommonName )
-    &lt;&lt;endl&lt;&lt;
-    tr ( &quot;Organization(O)\t&quot; ) &lt;&lt;
-    cert.subjectInfo ( QSslCertificate::Organization )
-    &lt;&lt;endl&lt;&lt;
-    tr ( &quot;Organizational Unit(OU)\t&quot; ) &lt;&lt;
-    cert.subjectInfo ( QSslCertificate::OrganizationalUnitName )
-    &lt;&lt;endl&lt;&lt;endl&lt;&lt;
-
-    tr ( &quot;Validity:\n&quot; ) &lt;&lt;
-    tr ( &quot;Issued on\t&quot; ) &lt;&lt;cert.effectiveDate().toString() &lt;&lt;endl&lt;&lt;
-    tr ( &quot;expires on\t&quot; ) &lt;&lt;cert.expiryDate().toString() &lt;&lt;endl&lt;&lt;endl&lt;&lt;
-    tr ( &quot;Fingerprints:\n&quot; ) &lt;&lt;
-    tr ( &quot;SHA1\t&quot; ) &lt;&lt;
-    getHexVal ( cert.digest ( QCryptographicHash::Sha1 ) ) &lt;&lt;endl&lt;&lt;
-    tr ( &quot;MD5\t&quot; ) &lt;&lt;md5;
+                          &quot;------------\n&quot;&lt;&lt;
+                          tr ( &quot;Issued to:\n&quot; ) &lt;&lt;
+                          tr ( &quot;Common Name(CN)\t&quot; ) &lt;&lt;
+                          cert.issuerInfo ( QSslCertificate::CommonName )
+                          &lt;&lt;endl&lt;&lt;
+                          tr ( &quot;Organization(O)\t&quot; ) &lt;&lt;
+                          cert.issuerInfo ( QSslCertificate::Organization )
+                          &lt;&lt;endl&lt;&lt;
+                          tr ( &quot;Organizational Unit(OU)\t&quot; ) &lt;&lt;
+                          cert.issuerInfo ( QSslCertificate::OrganizationalUnitName )
+                          &lt;&lt;endl&lt;&lt;
+                          tr ( &quot;Serial Number\t&quot; ) &lt;&lt;getHexVal ( cert.serialNumber() )
+                          &lt;&lt;endl&lt;&lt;endl&lt;&lt;
+                          tr ( &quot;Issued by:\n&quot; ) &lt;&lt;
+                          tr ( &quot;Common Name(CN)\t&quot; ) &lt;&lt;
+                          cert.subjectInfo ( QSslCertificate::CommonName )
+                          &lt;&lt;endl&lt;&lt;
+                          tr ( &quot;Organization(O)\t&quot; ) &lt;&lt;
+                          cert.subjectInfo ( QSslCertificate::Organization )
+                          &lt;&lt;endl&lt;&lt;
+                          tr ( &quot;Organizational Unit(OU)\t&quot; ) &lt;&lt;
+                          cert.subjectInfo ( QSslCertificate::OrganizationalUnitName )
+                          &lt;&lt;endl&lt;&lt;endl&lt;&lt;
+
+                          tr ( &quot;Validity:\n&quot; ) &lt;&lt;
+                          tr ( &quot;Issued on\t&quot; ) &lt;&lt;cert.effectiveDate().toString() &lt;&lt;endl&lt;&lt;
+                          tr ( &quot;expires on\t&quot; ) &lt;&lt;cert.expiryDate().toString() &lt;&lt;endl&lt;&lt;endl&lt;&lt;
+                          tr ( &quot;Fingerprints:\n&quot; ) &lt;&lt;
+                          tr ( &quot;SHA1\t&quot; ) &lt;&lt;
+                          getHexVal ( cert.digest ( QCryptographicHash::Sha1 ) ) &lt;&lt;endl&lt;&lt;
+                          tr ( &quot;MD5\t&quot; ) &lt;&lt;md5;
 
 
 
@@ -518,7 +311,7 @@ void HttpBrokerClient::slotSslErrors ( const QList&lt;QSslError&gt; &amp; errors )
         fl.close();
         http-&gt;ignoreSslErrors();
         x2goDebug&lt;&lt;&quot;store certificate in  &quot;&lt;&lt;homeDir+&quot;/ssl/exceptions/&quot;+
-        lurl.host() +&quot;/&quot;+fname;
+                 lurl.host() +&quot;/&quot;+fname;
         requestTime.restart();
     }
     else
@@ -529,7 +322,7 @@ void HttpBrokerClient::slotSslErrors ( const QList&lt;QSslError&gt; &amp; errors )
 QString HttpBrokerClient::getHexVal ( const QByteArray&amp; ba )
 {
     QStringList val;
-    for ( int i=0;i&lt;ba.size();++i )
+    for ( int i=0; i&lt;ba.size(); ++i )
     {
         QString bt;
         bt.sprintf ( &quot;%02X&quot;, ( unsigned char ) ba[i] );
@@ -537,22 +330,3 @@ QString HttpBrokerClient::getHexVal ( const QByteArray&amp; ba )
     }
     return val.join ( &quot;:&quot; );
 }
-
-
-void HttpBrokerClient::slotGetConnectionCmd()
-{
-    QString req;
-    QTextStream ( &amp;req ) &lt;&lt;
-    &quot;mode=getcmd&amp;&quot;&lt;&lt;
-    &quot;user=&quot;&lt;&lt;config-&gt;user&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-    &quot;connectionts=&quot;&lt;&lt;config-&gt;connectionts&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-    &quot;cookie=&quot;&lt;&lt;config-&gt;cookie;
-
-    QUrl lurl ( config-&gt;brokerurl );
-    httpCmdAnswer.close();
-    httpCmdAnswer.setData ( 0,0 );
-
-    cmdRequest=http-&gt;post ( lurl.path(),
-                            req.toUtf8(),&amp;httpCmdAnswer );
-// 	x2goDebug&lt;&lt;&quot;requested brocker cmd :&quot;&lt;&lt;cmdRequest;
-}
diff --git a/httpbrokerclient.h b/httpbrokerclient.h
index 02d519c..e7b3b57 100644
--- a/httpbrokerclient.h
+++ b/httpbrokerclient.h
@@ -29,44 +29,37 @@ class HttpBrokerClient: public QObject
 public:
     HttpBrokerClient ( ONMainWindow* wnd, ConfigFile* cfg );
     ~HttpBrokerClient();
-    QString getSInfoFromBroker ( bool getKey=false );
     void selectUserSession(const QString&amp; session );
     void changePassword(QString newPass);
     void testConnection();
 private:
-    QBuffer httpSIAnswer;
     QBuffer httpCmdAnswer;
     QBuffer httpSessionAnswer;
     QHttp* http;
-    int sinfoRequest;
-    int sinfoKeyRequest;
     int sessionsRequest;
     int selSessRequest;
-    int cmdRequest;
     int chPassRequest;
     int testConRequest;
     QString newBrokerPass;
     ConfigFile* config;
     ONMainWindow* mainWindow;
     void createIniFile(const QString&amp; content);
+    void parseSession(QString sInfo);
     QTime requestTime;
 
 private slots:
     void slotRequestFinished ( int id, bool error );
     void slotSslErrors ( const QList&lt;QSslError&gt; &amp; errors ) ;
     QString getHexVal ( const QByteArray&amp; ba );
-    void slotGetConnectionCmd();
 public slots:
     void getUserSessions();
 
 signals:
     void haveSshKey ( QString );
     void fatalHttpError();
-    void haveAgentInfo ();
-    void cmdReconnect ();
     void authFailed();
     void sessionsLoaded();
-    void getSession( QString );
+    void sessionSelected( );
     void passwordChanged( QString );
     void connectionTime(int, int);
 };
diff --git a/onmainwindow.cpp b/onmainwindow.cpp
index 1ffd02c..2825e38 100644
--- a/onmainwindow.cpp
+++ b/onmainwindow.cpp
@@ -432,17 +432,11 @@ ONMainWindow::ONMainWindow ( QWidget *parent ) :QMainWindow ( parent )
     if (brokerMode)
     {
         broker=new HttpBrokerClient ( this, &amp;config );
-        connect ( broker,SIGNAL ( haveSshKey ( QString ) ),this,
-                  SLOT ( slotStartSshAgent ( QString ) ) );
-        connect ( broker,SIGNAL ( haveAgentInfo () ),this,
-                  SLOT ( slotStartNewBrokerSession () ) );
         connect ( broker,SIGNAL ( fatalHttpError() ),this,
                   SLOT ( close() ) );
-        connect ( broker,SIGNAL ( cmdReconnect() ),this,
-                  SLOT ( slotReconnectSession() ) );
         connect ( broker, SIGNAL ( authFailed()), this ,SLOT ( slotGetBrokerAuth()));
         connect ( broker, SIGNAL( sessionsLoaded()), this, SLOT (slotReadSessions()));
-        connect ( broker, SIGNAL ( getSession(QString)), this, SLOT (slotGetBrokerSession(QString)));
+        connect ( broker, SIGNAL ( sessionSelected()), this, SLOT (slotGetBrokerSession()));
         connect ( broker, SIGNAL ( passwordChanged(QString)), this, SLOT ( slotPassChanged(QString)));
     }
 
@@ -975,6 +969,13 @@ void ONMainWindow::slotGetBrokerAuth()
     nameLabel-&gt;setText ( text );
     slotShowPassForm();
     config.brokerAuthenticated=false;
+    if(config.brokerUser.length()&gt;=0)
+    {
+        login-&gt;setText(config.brokerUser);
+        pass-&gt;setFocus();
+    }
+    if(config.brokerNoAuth)
+        slotSessEnter();
 }
 
 
@@ -2552,6 +2553,7 @@ void ONMainWindow::slotSelectedFromList ( SessionButton* session )
     QString userName;
     bool autologin=false;
     bool krblogin=false;
+    bool usebrokerpass=false;
     QString sessIcon;
     QPalette pal;
     QString sessionName;
@@ -2563,50 +2565,56 @@ void ONMainWindow::slotSelectedFromList ( SessionButton* session )
         sessionName=session-&gt;name();
 
         QString sid=session-&gt;id();
+        X2goSettings* st;
         if (brokerMode)
         {
-            broker-&gt;selectUserSession(session-&gt;id());
-            setStatStatus ( tr ( &quot;Connecting to broker&quot; ) );
-            stInfo-&gt;insertPlainText ( &quot;broker url: &quot;+config.brokerurl );
-            setEnabled ( false );
-            uname-&gt;hide();
-            u-&gt;hide();
-            return;
+            st=new X2goSettings( config.iniFile, QSettings::IniFormat );
+        }
+        else
+        {
+            st = new X2goSettings( &quot;sessions&quot; );
         }
 
-        X2goSettings st ( &quot;sessions&quot; );
 
-        sessIcon=st.setting()-&gt;value (
+
+        sessIcon=st-&gt;setting()-&gt;value (
                      sid+&quot;/icon&quot;,
                      ( QVariant ) &quot;:icons/128x128/x2gosession.png&quot;
                  ).toString();
 
 
-        command=st.setting()-&gt;value (
+        command=st-&gt;setting()-&gt;value (
                     sid+&quot;/command&quot;,
                     ( QVariant ) tr ( &quot;KDE&quot; ) ).toString();
 
-        server=st.setting()-&gt;value ( sid+&quot;/host&quot;,
-                                     ( QVariant ) QString::null
-                                   ).toString();
-        userName=st.setting()-&gt;value (
+        server=st-&gt;setting()-&gt;value ( sid+&quot;/host&quot;,
+                                      ( QVariant ) QString::null
+                                    ).toString();
+        userName=st-&gt;setting()-&gt;value (
                      sid+&quot;/user&quot;,
                      ( QVariant ) QString::null ).toString();
         if (defaultUser &amp;&amp; userName.length()&lt;1)
             userName=defaultUserName;
 
-        sshPort=st.setting()-&gt;value (
+        if(brokerMode)
+            usebrokerpass=st-&gt;setting()-&gt;value (
+                              sid+&quot;/usebrokerpass&quot;,
+                              false ).toBool();
+
+
+        sshPort=st-&gt;setting()-&gt;value (
                     sid+&quot;/sshport&quot;,
                     ( QVariant ) defaultSshPort ).toString();
-        currentKey=st.setting()-&gt;value (
+        currentKey=st-&gt;setting()-&gt;value (
                        sid+&quot;/key&quot;,
                        ( QVariant ) QString::null ).toString();
-        autologin=st.setting()-&gt;value (
+        autologin=st-&gt;setting()-&gt;value (
                       sid+&quot;/autologin&quot;,
                       ( QVariant ) false ).toBool();
-        krblogin=st.setting()-&gt;value (
+        krblogin=st-&gt;setting()-&gt;value (
                      sid+&quot;/krblogin&quot;,
                      ( QVariant ) false ).toBool();
+        delete st;
 #ifdef Q_OS_WIN
         if ( portable &amp;&amp;
                 u3Device.length() &gt;0 )
@@ -2625,6 +2633,7 @@ void ONMainWindow::slotSelectedFromList ( SessionButton* session )
         sessionName=config.session;
         currentKey=config.key;
     }
+
     selectedCommand=command;
     command=transAppName ( command );
     login-&gt;setText ( userName );
@@ -2646,6 +2655,11 @@ void ONMainWindow::slotSelectedFromList ( SessionButton* session )
         fotoLabel-&gt;setFixedSize ( 48,48 );
     }
 
+    if(currentKey.length()&lt;=0)
+    {
+        currentKey=findSshKeyForServer(userName, server, sshPort);
+    }
+
 
     if ( command==&quot;RDP&quot; )
     {
@@ -2673,6 +2687,12 @@ void ONMainWindow::slotSelectedFromList ( SessionButton* session )
 
 ///////////////////////////////////////////////////
 
+    if(brokerMode &amp;&amp;usebrokerpass)
+    {
+        pass-&gt;setText(config.brokerPass);
+        slotSessEnter();
+    }
+
     if ( currentKey.length() &gt;0 )
     {
         nopass=true;
@@ -2682,7 +2702,7 @@ void ONMainWindow::slotSelectedFromList ( SessionButton* session )
         x2goDebug&lt;&lt;&quot;Have key, starting session&quot;&lt;&lt;endl;
         slotSessEnter();
     }
-    if ( cardReady || autologin || krblogin )
+    if ( cardReady || autologin || krblogin  )
     {
         nopass=true;
         if ( cardReady )
@@ -2738,10 +2758,6 @@ SshMasterConnection* ONMainWindow::startSshConnection ( QString host, QString po
     /////key/sshagent/env/
 
     passForm-&gt;setEnabled ( false );
-    if(cmdSshKey.length()&gt;0)
-    {
-        currentKey=cmdSshKey;
-    }
     if(cmdAutologin)
     {
         autologin=true;
@@ -2779,7 +2795,6 @@ void ONMainWindow::slotSshConnectionError ( QString message, QString lastSession
     QMessageBox::critical ( 0l,message,lastSessionError,
                             QMessageBox::Ok,
                             QMessageBox::NoButton );
-// 	currentKey=QString::null;
     setEnabled ( true );
     passForm-&gt;setEnabled ( true );
     slotShowPassForm();
@@ -2955,7 +2970,6 @@ void ONMainWindow::slotSshUserAuthError ( QString error )
     QMessageBox::critical ( 0l,tr ( &quot;Authentication failed&quot; ),error,
                             QMessageBox::Ok,
                             QMessageBox::NoButton );
-// 	currentKey=QString::null;
     setEnabled ( true );
     passForm-&gt;setEnabled ( true );
     slotShowPassForm();
@@ -2993,11 +3007,25 @@ void ONMainWindow::slotSessEnter()
         }
     }
 
+
+
     resumingSession.sessionId=QString::null;
     resumingSession.server=QString::null;
     resumingSession.display=QString::null;
     setStatStatus ( tr ( &quot;connecting&quot; ) );
 
+    if(brokerMode)
+    {
+        broker-&gt;selectUserSession(lastSession-&gt;id());
+        config.session=lastSession-&gt;id();
+        setStatStatus ( tr ( &quot;Connecting to broker&quot; ) );
+        stInfo-&gt;insertPlainText ( &quot;broker url: &quot;+config.brokerurl );
+        setEnabled ( false );
+        uname-&gt;hide();
+        u-&gt;hide();
+        return;
+    }
+
     QString sid=&quot;&quot;;
     if ( !embedMode )
         sid=lastSession-&gt;id();
@@ -3124,6 +3152,38 @@ void ONMainWindow::startDirectRDP()
 #endif
 
 
+QString ONMainWindow::findSshKeyForServer(QString user, QString server, QString port)
+{
+    foreach (sshKey key, cmdSshKeys)
+    {
+        if(key.server == server &amp;&amp; key.user == user &amp;&amp; key.port == port)
+            return key.key;
+    }
+    foreach (sshKey key, cmdSshKeys)
+    {
+        if(key.server == server &amp;&amp; key.user == user &amp;&amp; key.port.length()&lt;=0)
+            return key.key;
+    }
+
+    foreach (sshKey key, cmdSshKeys)
+    {
+        if(key.server == server &amp;&amp; key.user.length()&lt;=0 &amp;&amp; key.port==port)
+            return key.key;
+    }
+
+    foreach (sshKey key, cmdSshKeys)
+    {
+        if(key.server == server &amp;&amp; key.user.length()&lt;=0 &amp;&amp; key.port.length()&lt;=0)
+            return key.key;
+    }
+
+    foreach (sshKey key, cmdSshKeys)
+    {
+        if(key.server.length()&lt;=0 &amp;&amp; key.user.length()&lt;=0 &amp;&amp; key.port.length()&lt;=0)
+            return key.key;
+    }
+    return QString::null;
+}
 
 
 bool ONMainWindow::startSession ( const QString&amp; sid )
@@ -3159,65 +3219,51 @@ bool ONMainWindow::startSession ( const QString&amp; sid )
         return true;
     }
 
-    if ( !embedMode &amp;&amp; !brokerMode )
-    {
+    X2goSettings* st;
+    if(!brokerMode)
+        st=new  X2goSettings( &quot;sessions&quot; );
+    else
+        st=new X2goSettings(config.iniFile, QSettings::IniFormat);
 
-        X2goSettings st ( &quot;sessions&quot; );
+    passForm-&gt;setEnabled ( false );
+    host=st-&gt;setting()-&gt;value ( sid+&quot;/host&quot;,
+                                ( QVariant ) QString::null ).toString();
+    if(brokerMode)
+    {
+        sshPort=config.sshport;
+        x2goDebug&lt;&lt;&quot;server: &quot;&lt;&lt;host;
+    }
 
-        passForm-&gt;setEnabled ( false );
-        host=st.setting()-&gt;value ( sid+&quot;/host&quot;,
-                                   ( QVariant ) QString::null ).toString();
-        QString cmd=st.setting()-&gt;value ( sid+&quot;/command&quot;,
-                                          ( QVariant ) QString::null ).toString();
-        autologin=st.setting()-&gt;value ( sid+&quot;/autologin&quot;,
-                                        ( QVariant ) false ).toBool();
-        krblogin=st.setting()-&gt;value ( sid+&quot;/krblogin&quot;,
-                                       ( QVariant ) false ).toBool();
+    QString cmd=st-&gt;setting()-&gt;value ( sid+&quot;/command&quot;,
+                                       ( QVariant ) QString::null ).toString();
+    autologin=st-&gt;setting()-&gt;value ( sid+&quot;/autologin&quot;,
+                                     ( QVariant ) false ).toBool();
+    krblogin=st-&gt;setting()-&gt;value ( sid+&quot;/krblogin&quot;,
+                                    ( QVariant ) false ).toBool();
 #ifdef Q_OS_LINUX
-        directRDP=st.setting()-&gt;value ( sid+&quot;/directrdp&quot;,
-                                        ( QVariant ) false ).toBool();
-        if (cmd ==&quot;RDP&quot; &amp;&amp; directRDP)
-        {
-            startDirectRDP();
-            return true;
-        }
-#endif
-        if ( cmd==&quot;SHADOW&quot; )
-            shadowSession=true;
-    }
-    else
+    directRDP=st-&gt;setting()-&gt;value ( sid+&quot;/directrdp&quot;,
+                                     ( QVariant ) false ).toBool();
+    if (cmd ==&quot;RDP&quot; &amp;&amp; directRDP)
     {
-        host=config.server;
-        sshPort=config.sshport;
-        selectedCommand=config.command;
+        startDirectRDP();
+        return true;
     }
-    if (!brokerMode)
-        passwd=getCurrentPass();
-    else
+#endif
+    if ( cmd==&quot;SHADOW&quot; )
+        shadowSession=true;
+    passwd=getCurrentPass();
+    if(brokerMode)
     {
         currentKey=config.key;
-        host=config.server;
-        X2goSettings st ( config.iniFile, QSettings::IniFormat );
-        passForm-&gt;setEnabled ( false );
-        user=st.setting()-&gt;value ( sid+&quot;/user&quot;,
-                                   ( QVariant ) QString::null ).toString();
-        login-&gt;setText(user);
         sshPort=config.sshport;
-        /*        sshPort=st.setting()-&gt;value ( sid+&quot;/sshport&quot;,
-                                              ( QVariant ) &quot;22&quot; ).toString();*/
     }
     if (sshConnection)
         sshConnection-&gt;disconnectSession();
 
-
-    X2goSettings* st;
-    if(!brokerMode)
-        st=new  X2goSettings( &quot;sessions&quot; );
-    else
-        st=new X2goSettings(config.iniFile, QSettings::IniFormat);
-
-
-
+    if(currentKey.length()&lt;=0)
+    {
+        currentKey=findSshKeyForServer(user, host, sshPort);
+    }
 
     useproxy=(st-&gt;setting()-&gt;value (
                   sid+&quot;/usesshproxy&quot;,
@@ -3277,6 +3323,11 @@ bool ONMainWindow::startSession ( const QString&amp; sid )
                         false
                     ).toBool() );
 
+    if(proxyKey.length()&lt;=0 &amp;&amp; proxyType==SshMasterConnection::PROXYSSH)
+    {
+        proxyKey=findSshKeyForServer(proxylogin, proxyserver, QString::number(proxyport));
+    }
+
     if(proxySameUser)
         proxylogin=user;
     if(proxySamePass)
@@ -3287,12 +3338,18 @@ bool ONMainWindow::startSession ( const QString&amp; sid )
         {
             bool ok;
             proxypassword=QInputDialog::getText(0,proxylogin+&quot;@&quot;+proxyserver+&quot;:&quot;+QString::number(proxyport),
-                                                tr(&quot;Enter passwort for SSH proxy&quot;),QLineEdit::Password,QString::null, &amp;ok);
+                                                tr(&quot;Enter password for SSH proxy&quot;),QLineEdit::Password,QString::null, &amp;ok);
         }
     }
 
     delete st;
 
+    if(brokerMode)
+    {
+        host=config.serverIp;
+    }
+
+
     sshConnection=startSshConnection ( host,sshPort,acceptRsa,user,passwd,autologin, krblogin, false, useproxy,proxyType,proxyserver,
                                        proxyport, proxylogin, proxypassword, proxyKey,proxyAutologin);
     return true;
@@ -6153,6 +6210,11 @@ bool ONMainWindow::parseParameter ( QString param )
         return true;
     }
 
+    if ( param == &quot;--broker-noauth&quot;)
+    {
+        config.brokerNoAuth=true;
+        return true;
+    }
 
 
     QString setting,value;
@@ -6277,9 +6339,42 @@ bool ONMainWindow::parseParameter ( QString param )
         config.brokerurl=value;
         return true;
     }
+    if ( setting == &quot;--broker-user&quot;)
+    {
+        config.brokerUser=value;
+        return true;
+    }
     if ( setting == &quot;--ssh-key&quot;)
     {
-        cmdSshKey=value;
+        sshKey key;
+        QStringList parts=value.split(&quot;:&quot;);
+        QString authPart;
+        switch(parts.length())
+        {
+        case 1:
+            key.key=parts[0];
+            break;
+        case 2:
+            key.key=parts[1];
+            authPart=parts[0];
+            break;
+        case 3:
+            authPart=parts[0];
+            key.key=parts[2];
+            key.port=parts[1];
+            break;
+        }
+        if(authPart.length()&gt;0)
+        {
+            if(authPart.indexOf(&quot;@&quot;)!=-1)
+            {
+                key.user=authPart.split(&quot;@&quot;)[0];
+                key.server=authPart.split(&quot;@&quot;)[1];
+            }
+            else
+                key.server=authPart;
+        }
+        cmdSshKeys&lt;&lt;key;
         return true;
     }
     if ( setting == &quot;--broker-name&quot;)
@@ -6670,7 +6765,6 @@ void ONMainWindow::slotGetServers ( bool result, QString output,
         QMessageBox::critical ( 0l,tr ( &quot;Error&quot; ),message,
                                 QMessageBox::Ok,
                                 QMessageBox::NoButton );
-// 		currentKey=QString::null;
         setEnabled ( true );
         passForm-&gt;setEnabled ( true );
         pass-&gt;setFocus();
@@ -8234,7 +8328,6 @@ void ONMainWindow::slotCmdMessage ( bool result,QString output,
         QMessageBox::critical ( 0l,tr ( &quot;Error&quot; ),message,
                                 QMessageBox::Ok,
                                 QMessageBox::NoButton );
-// 		currentKey=QString::null;
         setEnabled ( true );
         passForm-&gt;setEnabled ( true );
         pass-&gt;setFocus();
@@ -10805,7 +10898,6 @@ void ONMainWindow::slotReconnectSession()
         slotSelectedFromList ( ( SessionButton* ) 0 );
     else
     {
-        broker-&gt;getSInfoFromBroker();
         setEnabled ( false );
     }
 }
@@ -10832,28 +10924,9 @@ void ONMainWindow::slotStartBroker()
     broker-&gt;getUserSessions();
 }
 
-void ONMainWindow::slotGetBrokerSession(const QString&amp; sinfo)
-{
-    //x2goDebug&lt;&lt;&quot;broker session: &quot;&lt;&lt;sinfo;
-    QStringList lst=sinfo.split(&quot;SERVER:&quot;,QString::SkipEmptyParts);
-    int keyStartPos=sinfo.indexOf(&quot;-----BEGIN DSA PRIVATE KEY-----&quot;);
-    QString endStr=&quot;-----END DSA PRIVATE KEY-----&quot;;
-    int keyEndPos=sinfo.indexOf(endStr);
-    if (! (keyEndPos == -1 || keyStartPos == -1 || lst.size()==0))
-        config.key=sinfo.mid(keyStartPos, keyEndPos+endStr.length()-keyStartPos);
-    QString serverLine=(lst[1].split(&quot;\n&quot;))[0];
-    QStringList words=serverLine.split(&quot;:&quot;,QString::SkipEmptyParts);
-    config.server=words[0];
-    if (words.count()&gt;1)
-        config.sshport=words[1];
-//    x2goDebug&lt;&lt;&quot;server: &quot;&lt;&lt;config.server&lt;&lt;endl&lt;&lt;&quot; key: &quot;&lt;&lt;config.key;
-    if (sinfo.indexOf(&quot;SESSION_INFO&quot;)!=-1)
-    {
-        QStringList lst=sinfo.split(&quot;SESSION_INFO:&quot;,QString::SkipEmptyParts);
-        config.sessiondata=(lst[1].split(&quot;\n&quot;))[0];
-// 	x2goDebug&lt;&lt;&quot;data: &quot;&lt;&lt;config.sessiondata;
-    }
-    slotSessEnter();
+void ONMainWindow::slotGetBrokerSession()
+{
+    startSession ( config.session);
 }
 
 void ONMainWindow::slotStartNewBrokerSession ( )
diff --git a/onmainwindow.h b/onmainwindow.h
index de15136..831599a 100644
--- a/onmainwindow.h
+++ b/onmainwindow.h
@@ -166,8 +166,10 @@ struct ConfigFile
     QString brokerUserId;
     QString brokerName;
     bool brokerAuthenticated;
+    bool brokerNoAuth;
     QString iniFile;
     QString server;
+    QString serverIp;//Can be different from server (use for loadballancing)
     QString sshport;
     QString command;
     QString key;
@@ -214,6 +216,15 @@ struct ConfigFile
 };
 
 
+struct sshKey
+{
+    QString server;
+    QString port;
+    QString user;
+    QString key;
+};
+
+
 //wrapper to send mouse events under windows in embedded mode
 #ifdef Q_OS_WIN
 class WWrapper : public QPushButton
@@ -510,7 +521,6 @@ private:
     QString statusString;
     QString autostartApp;
     bool cmdAutologin;
-    QString cmdSshKey;
     int defaultLink;
     int defaultQuality;
     int defaultWidth;
@@ -549,6 +559,7 @@ private:
     int retSessions;
     QList&lt;serv&gt; x2goServers;
     QList&lt;Application&gt; applications;
+    QList&lt;sshKey&gt; cmdSshKeys;
 
     QPushButton* bSusp;
     QPushButton* bTerm;
@@ -800,6 +811,7 @@ private:
     bool trayMaxDiscon;
     bool trayAutoHidden;
 
+    QString findSshKeyForServer(QString user, QString server, QString port);
     void installTranslator();
     void loadSettings();
     void showPass ( UserButton* user );
@@ -925,7 +937,7 @@ private slots:
     void slotTermSess();
     void slotNewSess();
     void slotGetBrokerAuth();
-    void slotGetBrokerSession(const QString&amp; sinfo);
+    void slotGetBrokerSession();
     void slotCmdMessage ( bool result,QString output,
                           SshProcess* );
     void slotListSessions ( bool result,QString output,


hooks/post-receive
-- 
x2goclient.git (X2Go Client)

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;x2goclient.git&quot; (X2Go Client).

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003315.html">[X2go-Commits] pyhoca-gui.git - master (branch) updated:	0.2.0.4-23-g2f79725
</A></li>
	<LI>Next message: <A HREF="003317.html">[X2go-Commits] pyhoca-gui.git - master (branch) updated:	0.2.0.4-24-g965079d
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3316">[ date ]</a>
              <a href="thread.html#3316">[ thread ]</a>
              <a href="subject.html#3316">[ subject ]</a>
              <a href="author.html#3316">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/x2go-commits">More information about the X2go-commits
mailing list</a><br>
</body></html>
