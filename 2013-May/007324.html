<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [X2Go-Commits] x2gobroker.git - build-main (branch) updated:	e1c3ba9271e5c7cb8223c698b14f90469906c157
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/x2go-commits/2013-May/index.html" >
   <LINK REL="made" HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2Go-Commits%5D%20x2gobroker.git%20-%20build-main%20%28branch%29%20updated%3A%0A%09e1c3ba9271e5c7cb8223c698b14f90469906c157&In-Reply-To=%3C20130519110427.56B965DB37%40ymir%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007322.html">
   <LINK REL="Next"  HREF="007325.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[X2Go-Commits] x2gobroker.git - build-main (branch) updated:	e1c3ba9271e5c7cb8223c698b14f90469906c157</H1>
    <B>X2Go dev team</B> 
    <A HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2Go-Commits%5D%20x2gobroker.git%20-%20build-main%20%28branch%29%20updated%3A%0A%09e1c3ba9271e5c7cb8223c698b14f90469906c157&In-Reply-To=%3C20130519110427.56B965DB37%40ymir%3E"
       TITLE="[X2Go-Commits] x2gobroker.git - build-main (branch) updated:	e1c3ba9271e5c7cb8223c698b14f90469906c157">git-admin at x2go.org
       </A><BR>
    <I>Sun May 19 13:04:27 CEST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="007322.html">[X2Go-Commits] x2gobroker.git - build-main (branch) updated:	fbde70cbb12c5687ee3e4597a782fc25a86d8011
</A></li>
        <LI>Next message: <A HREF="007325.html">[X2Go-Commits] x2gobroker.git - build-main (branch) updated:	70d45f5895ec8ca79f3b6703d9e1e30997d39c51
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7324">[ date ]</a>
              <a href="thread.html#7324">[ thread ]</a>
              <a href="subject.html#7324">[ subject ]</a>
              <a href="author.html#7324">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch, build-main has been updated
       via  e1c3ba9271e5c7cb8223c698b14f90469906c157 (commit)
      from  2ce2d27c90a930f4c61690a07726c718d52def5e (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
-----------------------------------------------------------------------

Summary of changes:
 cgi/x2gobroker-simple.cgi |   55 +--
 debian/changelog          |    1 +
 lib/x2gobroker-command.pl |   99 +++--
 lib/x2gobroker-simple.pm  |  979 +++++++++++++++++++++++----------------------
 4 files changed, 571 insertions(+), 563 deletions(-)

The diff of changes is:
diff --git a/cgi/x2gobroker-simple.cgi b/cgi/x2gobroker-simple.cgi
index 8f6fe88..8ac7213 100755
--- a/cgi/x2gobroker-simple.cgi
+++ b/cgi/x2gobroker-simple.cgi
@@ -31,13 +31,17 @@ my $cgi = new CGI;
 
 my @formValues = $cgi-&gt;param();
 
-print $cgi-&gt;header(-type    =&gt;'text/html',
-                         -expires =&gt;'+1h'),
-      $cgi-&gt;start_html(  -title   =&gt;'X2Go Broker',
-                         -author  =&gt;'X2Go Developers &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">x2go-dev at lists.berlios.de</A>&gt;',
-                         -base    =&gt;'true',
-                         -meta    =&gt;{'keywords'   =&gt;'X2Go',
-                         'description'=&gt;'X2Go Broker'});
+print $cgi-&gt;header(
+        -type    =&gt;'text/html',
+        -expires =&gt;'+1h'
+      ),
+      $cgi-&gt;start_html(
+        -title   =&gt;'X2Go Broker',
+        -author  =&gt;'X2Go Developers &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">x2go-dev at lists.berlios.de</A>&gt;',
+        -base    =&gt;'true',
+        -meta    =&gt;{'keywords'   =&gt;'X2Go', 'description'=&gt;'X2Go Broker'}
+      );
+
 #open (FL, &quot;&gt;&gt;/tmp/x2gobroker.log&quot;);
 #print FL `date`;
 #print FL &quot;called method &quot;.$cgi-&gt;param('task').&quot; from &quot;.$ENV{REMOTE_ADDR}.&quot;\n&quot;;
@@ -45,19 +49,19 @@ print $cgi-&gt;header(-type    =&gt;'text/html',
 
 if($cgi-&gt;param('task') eq 'testcon')
 {
-  for ( my $i=0;$i&lt;2*1024*1024;$i++ )
-  {
-     print int(rand(9));
-  }
-  print $cgi-&gt;end_html();
+	for ( my $i=0;$i&lt;2*1024*1024;$i++ )
+	{
+		print int(rand(9));
+	}
+	print $cgi-&gt;end_html();
 }
 
 
-if (!checkAccess($cgi-&gt;param('user'), $cgi-&gt;param('password'), $cgi-&gt;param('authid')) == 1)
+if ( ! checkAccess($cgi-&gt;param('user'), $cgi-&gt;param('password'), $cgi-&gt;param('authid')) == 1 )
 {
-  printNoAccess();
-  print $cgi-&gt;end_html();
-  exit (0);
+	printNoAccess();
+	print $cgi-&gt;end_html();
+	exit (0);
 }
 
 print $cgi-&gt;start_form(),
@@ -65,28 +69,27 @@ $cgi-&gt;strong('Access granted');
 
 if ($cgi-&gt;param('task') eq 'listsessions')
 {
-   listSessions($cgi-&gt;param('user'));
+	listSessions($cgi-&gt;param('user'));
 }
 
 if ($cgi-&gt;param('task') eq 'selectsession')
 {
-   selectSession($cgi-&gt;param('user'), $cgi-&gt;param('sid'));
+	selectSession($cgi-&gt;param('user'), $cgi-&gt;param('sid'));
 }
 
 if ($cgi-&gt;param('task') eq 'setpass')
 {
-   setPass($cgi-&gt;param('user'), $cgi-&gt;param('newpass'));
+	setPass($cgi-&gt;param('user'), $cgi-&gt;param('newpass'));
 }
 
- $cgi-&gt;hr(),
- $cgi-&gt;end_form();
+$cgi-&gt;hr(),
+$cgi-&gt;end_form();
 print $cgi-&gt;end_html();
 
-
 sub printNoAccess 
 {
-      print $cgi-&gt;start_form(),
-            $cgi-&gt;hr(),
-            $cgi-&gt;strong('Access denied'),
-            $cgi-&gt;end_form();
+	print $cgi-&gt;start_form(),
+	$cgi-&gt;hr(),
+	$cgi-&gt;strong('Access denied'),
+	$cgi-&gt;end_form();
 }
diff --git a/debian/changelog b/debian/changelog
index 22bd8c2..832aa39 100644
--- a/debian/changelog
+++ b/debian/changelog
@@ -4,5 +4,6 @@ x2gobroker (0.0.0.1-0~x2go1) UNRELEASED; urgency=low
   * Setting up new public X2Go project: x2gohttpbroker.
   * /debian/control:
     + Add an initial dependency selection to the various Depends fields.
+  * Fix code indentations (spaces replaced by tabs, use proper indentation levels).
 
  -- Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;  Wed, 15 Sep 2012 17:30:24 +0200
diff --git a/lib/x2gobroker-command.pl b/lib/x2gobroker-command.pl
index e39094d..0bac8de 100755
--- a/lib/x2gobroker-command.pl
+++ b/lib/x2gobroker-command.pl
@@ -24,45 +24,44 @@ use strict;
 
 sub initUser
 {
-    my ($user, $uid, $gid, $home)=@_;
-    if (! -d &quot;$home&quot;)
-    {
-         mkdir (&quot;$home&quot;, 0700);
-         chown ($uid, $gid, $home);
-    }
-    if (! -e &quot;$home/.x2go/sqlpass&quot;)
-    {
-         open my $save_out, &quot;&gt;&amp;STDOUT&quot;;
-         close (STDOUT);
-         system &quot;/usr/lib/x2go/script/x2godbadmin&quot;, &quot;--adduser&quot;, $user;
-         open STDOUT, &quot;&gt;&amp;&quot;, $save_out;
-    }
+	my ($user, $uid, $gid, $home)=@_;
+	if (! -d &quot;$home&quot;)
+	{
+		mkdir (&quot;$home&quot;, 0700);
+		chown ($uid, $gid, $home);
+	}
+	if (! -e &quot;$home/.x2go/sqlpass&quot;)
+	{
+		open my $save_out, &quot;&gt;&amp;STDOUT&quot;;
+		close (STDOUT);
+		system &quot;/usr/lib/x2go/script/x2godbadmin&quot;, &quot;--adduser&quot;, $user;
+		open STDOUT, &quot;&gt;&amp;&quot;, $save_out;
+	}
 }
 
 sub createKey
 {
-    my ($uid, $gid, $home)=@_;
-    if (! -d &quot;$home/.ssh&quot;)
-    {
-         mkdir (&quot;$home/.ssh&quot;, 0700);
-         chown ($uid, $gid, &quot;$home/.ssh&quot;);
-    }
-    if( -e &quot;$home/.ssh/authorized_keys&quot;)
-    {
-         unlink(&quot;$home/.ssh/authorized_keys&quot;);
-    }   
-    open my $save_out, &quot;&gt;&amp;STDOUT&quot;;
-    close (STDOUT);
-    system &quot;/usr/bin/ssh-keygen&quot;, &quot;-t&quot;, &quot;dsa&quot;, &quot;-N&quot;,&quot;&quot;,&quot;-f&quot;,&quot;$home/.ssh/authorized_keys&quot;;
-    open STDOUT, &quot;&gt;&amp;&quot;, $save_out;
-    open (F,&quot;&lt;$home/.ssh/authorized_keys&quot;);
-    print &lt;F&gt;;
-    close (F);
-    unlink(&quot;$home/.ssh/authorized_keys&quot;);
-    rename(&quot;$home/.ssh/authorized_keys.pub&quot;, &quot;$home/.ssh/authorized_keys&quot;);
+	my ($uid, $gid, $home)=@_;
+	if (! -d &quot;$home/.ssh&quot;)
+	{
+		mkdir (&quot;$home/.ssh&quot;, 0700);
+		chown ($uid, $gid, &quot;$home/.ssh&quot;);
+	}
+	if( -e &quot;$home/.ssh/authorized_keys&quot;)
+	{
+		unlink(&quot;$home/.ssh/authorized_keys&quot;);
+	}
+	open my $save_out, &quot;&gt;&amp;STDOUT&quot;;
+	close (STDOUT);
+	system &quot;/usr/bin/ssh-keygen&quot;, &quot;-t&quot;, &quot;dsa&quot;, &quot;-N&quot;,&quot;&quot;,&quot;-f&quot;,&quot;$home/.ssh/authorized_keys&quot;;
+	open STDOUT, &quot;&gt;&amp;&quot;, $save_out;
+	open (F,&quot;&lt;$home/.ssh/authorized_keys&quot;);
+	print &lt;F&gt;;
+	close (F);
+	unlink(&quot;$home/.ssh/authorized_keys&quot;);
+	rename(&quot;$home/.ssh/authorized_keys.pub&quot;, &quot;$home/.ssh/authorized_keys&quot;);
 }
 
-
 $&lt; = $&gt;;
 delete @ENV{qw(IFS CDPATH ENV BASH_ENV)};
 $ENV{'PATH'} = '/bin:/usr/bin';
@@ -70,48 +69,46 @@ $ENV{'PATH'} = '/bin:/usr/bin';
 my $username=shift or die;
 my $mode=shift or die;
 
-
-my  ($name,$passwd,$uid,$gid,
-     $quota,$comment,$gcos,$home,$shell,$expire) = getpwnam($username);
+my  ($name,$passwd,$uid,$gid, $quota,$comment,$gcos,$home,$shell,$expire) = getpwnam($username);
 
 if($uid &lt; 1000)
 {
-    die 'operation on system user';
+	die 'operation on system user';
 }
 
 if($mode eq 'listsessions')
 {
-   initUser($name, $uid, $gid, $home);
-   print &quot;OK\n&quot;;
-   system &quot;/bin/su&quot;, $name, &quot;-c&quot;, &quot;/usr/bin/x2golistsessions --all-servers&quot;;
+	initUser($name, $uid, $gid, $home);
+	print &quot;OK\n&quot;;
+	system &quot;/bin/su&quot;, $name, &quot;-c&quot;, &quot;/usr/bin/x2golistsessions --all-servers&quot;;
 }
 
 
 if($mode eq 'getservers')
 {
-   initUser($name, $uid, $gid, $home);
-   print &quot;OK\n&quot;;
-   system &quot;/bin/su&quot;, $name, &quot;-c&quot;, &quot;/usr/bin/x2gogetservers&quot;;
+	initUser($name, $uid, $gid, $home);
+	print &quot;OK\n&quot;;
+	system &quot;/bin/su&quot;, $name, &quot;-c&quot;, &quot;/usr/bin/x2gogetservers&quot;;
 }
 
 if($mode eq 'key')
 {
-   initUser($name, $uid, $gid, $home);
-   print &quot;OK\n&quot;;
-   createKey($uid, $gid, $home);
+	initUser($name, $uid, $gid, $home);
+	print &quot;OK\n&quot;;
+	createKey($uid, $gid, $home);
 }
 
 if($mode eq 'suspend')
 {
-   initUser($name, $uid, $gid, $home);
-   print &quot;OK\n&quot;;
-   my $sid=shift;
-   system &quot;/bin/su&quot;, $name, &quot;-c&quot;, &quot;/usr/bin/x2gosuspend-session $sid&quot;;
+	initUser($name, $uid, $gid, $home);
+	print &quot;OK\n&quot;;
+	my $sid=shift;
+	system &quot;/bin/su&quot;, $name, &quot;-c&quot;, &quot;/usr/bin/x2gosuspend-session $sid&quot;;
 }
 
 if($mode eq 'ping')
 {
-   print &quot;OK\n&quot;;
+	print &quot;OK\n&quot;;
 }
 
 
diff --git a/lib/x2gobroker-simple.pm b/lib/x2gobroker-simple.pm
index f27eb47..5e56c28 100644
--- a/lib/x2gobroker-simple.pm
+++ b/lib/x2gobroker-simple.pm
@@ -39,588 +39,595 @@ use base 'Exporter';
 our @EXPORT = ('checkAccess', 'listSessions', 'selectSession', 'setPass');
 
 sub getBase
+###
+### FIXME: provide that in /etc/x2go/x2gobroker-simple.cfg
+### FIXME: put the pid of this process in the lock files
 {
-  my $login=shift;
-  $login=~s/cn=ldapadmin//;
-  return $login;
+	my $login=shift;
+	$login=~s/cn=ldapadmin,//;
+	return $login;
 }
 
 sub initLdap
+###
+### FIXME: lock files have to be in /run or /var/run...
+###
 {
-  my $masterlocked=0;
-  my $replicalocked=0;
-  if((-e &quot;/etc/x2go/x2gobroker/masterldap.lock&quot;) &amp;&amp;(-e &quot;/etc/x2go/x2gobroker/replicaldap.lock&quot;))
-  {
-    die &quot;Can't connect to LDAP server&quot;;
-  }
-  if(-e &quot;/etc/x2go/x2gobroker/replicaldap.lock&quot;)
-  {
-    $masterlocked=1;
-    my ($ldap,$error)=initLDAPServer( $ldapuri );
-    if(!$ldap)
-    {
-      `touch /etc/x2go/x2gobroker/masterldap.lock`;
-       die &quot;Can't connect to LDAP server&quot;;
-    }
-    return $ldap;
-  }
-  if(-e &quot;/etc/x2go/x2gobroker/masterldap.lock&quot;)
-  {
-    $replicalocked=1;
-    my ($ldap,$error)=initLDAPServer( $replica ); 
-    if(!$ldap)
-    {
-      `touch /etc/x2go/x2gobroker/replicaldap.lock`;
-      die &quot;Can't connect to LDAP server&quot;;
-    }
-    return $ldap;
-  }  
-  if(!int(rand(2)))
-  {
-    my ($ldap,$error)=initLDAPServer( $ldapuri ); 
-    if(!$ldap)
-    {
-      `touch /etc/x2go/x2gobroker/masterldap.lock`;
-       return initLdap();
-    }
-    return $ldap;
-  }
-  else
-  {
-    my ($ldap,$error)=initLDAPServer( $replica );
-    if(!$ldap)
-    {
-      `touch /etc/x2go/x2gobroker/replicaldap.lock`;
-       return initLdap();
-    }
-    return $ldap;
-  }
+	my $masterlocked=0;
+	my $replicalocked=0;
+	if ( ( -e &quot;/etc/x2go/x2gobroker/masterldap.lock&quot;) &amp;&amp; ( -e &quot;/etc/x2go/x2gobroker/replicaldap.lock&quot; ) )
+	{
+		die &quot;Can't connect to LDAP server&quot;;
+	}
+	if ( -e &quot;/etc/x2go/x2gobroker/replicaldap.lock&quot; )
+	{
+	$masterlocked=1;
+		my ($ldap,$error)=initLDAPServer( $ldapuri );
+		if( ! $ldap )
+		{
+			`touch /etc/x2go/x2gobroker/masterldap.lock`;
+			die &quot;Can't connect to LDAP server&quot;;
+		}
+		return $ldap;
+	}
+	if( -e &quot;/etc/x2go/x2gobroker/masterldap.lock&quot; )
+	{
+		$replicalocked=1;
+		my ($ldap,$error)=initLDAPServer( $replica ); 
+		if ( ! $ldap )
+		{
+			`touch /etc/x2go/x2gobroker/replicaldap.lock`;
+			die &quot;Can't connect to LDAP server&quot;;
+		}
+		return $ldap;
+	}
+	if( ! int(rand(2)) )
+	{
+		my ($ldap,$error)=initLDAPServer( $ldapuri ); 
+		if( ! $ldap )
+		{
+			`touch /etc/x2go/x2gobroker/masterldap.lock`;
+			return initLdap();
+		}
+		return $ldap;
+	} else {
+		my ($ldap,$error)=initLDAPServer( $replica );
+		if(!$ldap)
+		{
+			`touch /etc/x2go/x2gobroker/replicaldap.lock`;
+			return initLdap();
+		}
+		return $ldap;
+	}
 }
 
 sub initMasterLdap
 {
-  if(-e &quot;/etc/x2go/x2gobroker/masterldap.lock&quot;)
-  {
-    die &quot;Master LDAP server is down\n&quot;;
-  }
-  my ($ldap,$error)=initLDAPServer( $ldapuri );
-  if(!$ldap)
-  {
-    `touch /etc/x2go/x2gobroker/masterldap.lock`;
-    die $error;
-  }
-  return $ldap;
+	if(-e &quot;/etc/x2go/x2gobroker/masterldap.lock&quot;)
+	{
+		die &quot;Master LDAP server is down\n&quot;;
+	}
+	my ($ldap,$error)=initLDAPServer( $ldapuri );
+	if( ! $ldap )
+	{
+		`touch /etc/x2go/x2gobroker/masterldap.lock`;
+		die $error;
+	}
+	return $ldap;
 }
 
 sub initLDAPServer
 {
-  my $url=shift;
-  my $ldap=Net::LDAP-&gt;new( $url );
-  if(! $ldap)
-  {
-    notify(&quot;LDAP server $url is down ($@). Please, repair it and remove lock file in /etc/x2go/x2gobroker\n&quot;);
-    return (0,&quot;$@&quot;);
-  }
-  my $message = $ldap-&gt;bind($binddn,password=&gt;$bindpw);
-  if(!$message)
-  {
-     notify(&quot;LDAP server $url is down ($@). Please, repair it and remove lock file in /etc/x2go/x2gobroker\n&quot;);
-     return (0,&quot;$@&quot;);
-  }
-  return ($ldap,0);  
+	my $url=shift;
+	my $ldap=Net::LDAP-&gt;new( $url );
+	if( ! $ldap )
+	{
+		notify(&quot;LDAP server $url is down ($@). Please, repair it and remove lock file in /etc/x2go/x2gobroker\n&quot;);
+		return (0,&quot;$@&quot;);
+	}
+	my $message = $ldap-&gt;bind($binddn,password=&gt;$bindpw);
+	if(!$message)
+	{
+		notify(&quot;LDAP server $url is down ($@). Please, repair it and remove lock file in /etc/x2go/x2gobroker\n&quot;);
+		return (0,&quot;$@&quot;);
+	}
+	return ($ldap,0);  
 }
 
 sub setPass
 {
-  my ($user, $newpass)=@_;
-#check if we have master ldap here
-
-  my $attr;
-  
-  my $csh=Crypt::SaltedHash-&gt;new(algorithm =&gt; 'SHA-1');
-  $csh-&gt;add($newpass);
-  $newpass=$csh-&gt;generate;
-  
-  push(@$attr,'userPassword'=&gt;$newpass);
-  my $changes;
-  push(@$changes,'replace'=&gt;$attr);
-  
-  my $ldap = initMasterLdap();
-  
-       
-  my $dn=&quot;cn=$user,ou=BrokerUsers&quot;.getBase($binddn);
-  my $message=$ldap-&gt;modify($dn, changes =&gt; $changes);
-
-  if($message-&gt;code)    
-  {
-        die $message-&gt;error.&quot;: &quot;.$message-&gt;error_desc;
-  }
-  print &quot;\n&lt;br&gt;CHANGING PASS OK&lt;br&gt;\n&quot;;
+	my ($user, $newpass)=@_;
+	# check if we have master ldap here
+
+	my $attr;
+
+	my $csh=Crypt::SaltedHash-&gt;new(algorithm =&gt; 'SHA-1');
+	$csh-&gt;add($newpass);
+	$newpass=$csh-&gt;generate;
+
+	push(@$attr,'userPassword'=&gt;$newpass);
+	my $changes;
+	push(@$changes,'replace'=&gt;$attr);
+
+	my $ldap = initMasterLdap();
+
+	my $dn=&quot;cn=$user,ou=BrokerUsers&quot;.getBase($binddn);
+	my $message=$ldap-&gt;modify($dn, changes =&gt; $changes);
+
+	if($message-&gt;code)    
+	{
+		die $message-&gt;error.&quot;: &quot;.$message-&gt;error_desc;
+	}
+	print &quot;\n&lt;br&gt;CHANGING PASS OK&lt;br&gt;\n&quot;;
 }
 
 sub selectSession
 {
-  my ($user, $sid)=@_;
-  my @words=split(&quot;\@&quot;,$sid);
-  my $sess_id=@words[1];
-  my $host=@words[0];
-  checkAndStartSession($user, $host, $sess_id);
+	my ($user, $sid)=@_;
+	my @words=split(&quot;\@&quot;,$sid);
+	my $sess_id=@words[1];
+	my $host=@words[0];
+	checkAndStartSession($user, $host, $sess_id);
 }
 
 sub getExtCon
 {
-  my $host=shift;
-  
-  my $ldap = initLdap();
-       
-  my $dn=&quot;cn=$host,ou=Servers,ou=ON&quot;.getBase($binddn);
-  my $message=$ldap-&gt;search(base =&gt; $dn, 
-		    scope =&gt; 'base', filter =&gt; '(objectClass=ipHost)');
-
-  if($message-&gt;code)
-  {
-        die $message-&gt;error.&quot;: &quot;.$message-&gt;error_desc;
-  }
-  foreach ($message-&gt;entries)
-  {
-    my $asn=$_-&gt;{'asn'};
-    my $attr=$asn-&gt;{'attributes'};
-    foreach (@$attr)
-    {
-      my $type=$_-&gt;{'type'};
-      my $value=$_-&gt;{'vals'}[0];
-      if($type eq 'description')
-      {
-	    my @words=split(&quot;:&quot;,$value);
-	    return (@words[0], @words[1]);
-      }
-    }
-  }
+	my $host=shift;
+
+	my $ldap = initLdap();
+
+	my $dn=&quot;cn=$host,ou=Servers,ou=ON&quot;.getBase($binddn);
+	####
+	#### FIXME: get scope from config file in /etc/x2go/x2gobroker-*.conf
+	####
+	my $message=$ldap-&gt;search(base =&gt; $dn, 
+	                          scope =&gt; 'base',
+	                          filter =&gt; '(objectClass=ipHost)'
+	            );
+
+	if($message-&gt;code)
+	{
+		die $message-&gt;error.&quot;: &quot;.$message-&gt;error_desc;
+	}
+	foreach ($message-&gt;entries)
+	{
+		my $asn=$_-&gt;{'asn'};
+		my $attr=$asn-&gt;{'attributes'};
+		foreach (@$attr)
+		{
+			my $type=$_-&gt;{'type'};
+			my $value=$_-&gt;{'vals'}[0];
+			if( $type eq 'description' )
+			{
+				my @words=split(&quot;:&quot;,$value);
+				return (@words[0], @words[1]);
+			}
+		}
+	}
 }
 
 sub checkAndStartSession
 {
-  my ($uid,$host,$sid)=@_;
-  my ($status,$sessions)=check_ts($host,$uid);
-  if(!$status)
-  {
-    print &quot;ERROR check TS\n&quot;;
-    return;
-  }
-  my $running=0;
-  if($sessions)
-  {
-    my @sinfo=split(&quot;\\|&quot;,$sessions);
-    my $sess_stat=@sinfo[4];
-    my $sess_srv=@sinfo[3];
-    $sid=@sinfo[1];
-    if($sess_stat eq 'R')
-    {
-        $running=1;
-        my $str;
-	($status,$str)=remoteBroker($host,$uid,&quot;suspend $sid&quot;);
-	$sessions=~s/\|R\|/\|S\|/;
-    }
-    if($sess_stat eq 'S')
-    {
-        $running=1;
-    }
-  }
-
-  my($ip,$port)=getExtCon($host);
-  print &quot;SERVER:$ip:$port\n&quot;;
-  if($running)
-  {
-    print &quot;SESSION_INFO:&quot;.(split(&quot;\n&quot;,$sessions))[0].&quot;\n&quot;;
-  }
+	my ($uid,$host,$sid)=@_;
+	my ($status,$sessions)=check_ts($host,$uid);
+	if(!$status)
+	{
+		print &quot;ERROR check TS\n&quot;;
+		return;
+	}
+	my $running=0;
+	if( $sessions )
+	{
+		my @sinfo=split(&quot;\\|&quot;,$sessions);
+		my $sess_stat=@sinfo[4];
+		my $sess_srv=@sinfo[3];
+		$sid=@sinfo[1];
+		if( $sess_stat eq 'R' )
+		{
+			$running=1;
+			my $str;
+			($status,$str)=remoteBroker($host,$uid,&quot;suspend $sid&quot;);
+			$sessions=~s/\|R\|/\|S\|/;
+		}
+		if( $sess_stat eq 'S' )
+		{
+			$running=1;
+		}
+	}
+
+	my($ip,$port)=getExtCon($host);
+	print &quot;SERVER:$ip:$port\n&quot;;
+	if($running)
+	{
+		print &quot;SESSION_INFO:&quot;.(split(&quot;\n&quot;,$sessions))[0].&quot;\n&quot;;
+	}
 }
 
 sub checkRunningSession
 {
-  my ($sess_srv, $sess_stat, $server_dn, $uid, $sid, $ldap)=@_;
-  my @dn_el=split(',',$server_dn);
-  shift(@dn_el);
-  shift(@dn_el);
-  my $node_dn=&quot;cn=&quot;.$sess_srv.&quot;,ou=Hosts,&quot;.join(','<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at dn_el</A>);
-  my $mesg=$ldap-&gt;search(base =&gt; $node_dn, 
-            scope =&gt; 'base', filter =&gt; '(objectClass=X2GoServerNode)');
-  if(!$mesg-&gt;code)
-  {
-      my @entries=$mesg-&gt;entries();
-      if(@entries[0]-&gt;get_value('serverStatus') eq 'TRUE')
-      {
-	my $node_ref={};
-	$node_ref-&gt;{'ip'}=@entries[0]-&gt;get_value('ipHostNumber');
-	$node_ref-&gt;{'dn'}=$node_dn;
-	my $status;
-	my $str;
-	if($sess_stat eq 'R')
+	my ($sess_srv, $sess_stat, $server_dn, $uid, $sid, $ldap)=@_;
+	my @dn_el=split(',',$server_dn);
+	shift(@dn_el);
+	shift(@dn_el);
+	my $node_dn=&quot;cn=&quot;.$sess_srv.&quot;,ou=Hosts,&quot;.join(','<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at dn_el</A>);
+	####
+	#### FIXME: get scope from config file in /etc/x2go/x2gobroker-*.conf
+	####
+	my $mesg=$ldap-&gt;search(base =&gt; $node_dn, 
+	                       scope =&gt; 'base',
+	                       filter =&gt; '(objectClass=X2GoServerNode)'
+	         );
+	if(!$mesg-&gt;code)
 	{
-	     print &quot;session running, suspend session $sid\n&quot;;
-	    ($status,$str)=remoteBroker($node_ref-&gt;{'ip'},$uid,&quot;suspend $sid&quot;,$node_ref-&gt;{'dn'}, $ldap);
+		my @entries=$mesg-&gt;entries();
+		if(@entries[0]-&gt;get_value('serverStatus') eq 'TRUE')
+		{
+			my $node_ref={};
+			$node_ref-&gt;{'ip'}=@entries[0]-&gt;get_value('ipHostNumber');
+			$node_ref-&gt;{'dn'}=$node_dn;
+			my $status;
+			my $str;
+			if( $sess_stat eq 'R' )
+			{
+				print &quot;session running, suspend session $sid\n&quot;;
+				($status,$str)=remoteBroker($node_ref-&gt;{'ip'},$uid,&quot;suspend $sid&quot;,$node_ref-&gt;{'dn'}, $ldap);
+			} else {
+				print &quot;session not running, ping node\n&quot;;
+				($status,$str)=remoteBroker($node_ref-&gt;{'ip'},$uid,'ping',$node_ref-&gt;{'dn'}, $ldap);
+			}
+			if($status)
+			{
+				return $node_ref;
+			}
+			print &quot;error executing remote broker \n&quot;;
+		}
+		print &quot;node is down \n&quot;;
+		return 0;
 	}
-	else
-	{
-	     print &quot;session not running, ping node\n&quot;;
-	    ($status,$str)=remoteBroker($node_ref-&gt;{'ip'},$uid,'ping',$node_ref-&gt;{'dn'}, $ldap);
-	}
-	if($status)
-	{
-	  return $node_ref;
-	}	
-        print &quot;error executing remote broker \n&quot;;
-      }
-      print &quot;node is down \n&quot;;
-      return 0;
-  }
-  print &quot;error searching $node_dn: &quot;.$mesg-&gt;error.&quot;\n&quot;;
-  return 0;
+	print &quot;error searching $node_dn: &quot;.$mesg-&gt;error.&quot;\n&quot;;
+	return 0;
 }
 
 sub startNewSession
 {
-  my ($dn, $ldap, $uid)=@_;
-  my $mesg=$ldap-&gt;search(base =&gt; $dn, 
-    scope =&gt; 'base', filter =&gt; '(objectClass=X2GoServer)');
-       
-  if($mesg-&gt;code)
-  {
-	  return 0;
-  }
-
-  my @entries=$mesg-&gt;entries();
-  my $ref = @entries[0]-&gt;get_value ( 'serverNode', asref =&gt; 1 );
-  my $nodes;
-  foreach(@$ref)
-  {
-    my $server=$_;
-    my @sdn=split(&quot;,&quot;,$dn);
-    shift(@sdn);
-    shift(@sdn);
-    my $server_dn=&quot;cn=$server,ou=Hosts,&quot;.join(&quot;,&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at sdn</A>);
-    
-    my $mesg=$ldap-&gt;search(base =&gt; $server_dn, 
-            scope =&gt; 'base', filter =&gt; '(objectClass=X2GoServerNode)');
-    if(!$mesg-&gt;code)
-    {
-      my @entries=$mesg-&gt;entries();
-      if(@entries[0]-&gt;get_value('serverStatus') eq 'TRUE')
-      {
-	my $node_ref={};
-	$node_ref-&gt;{'ip'}=@entries[0]-&gt;get_value('ipHostNumber');
-	$node_ref-&gt;{'sessions'}=0;
-	$node_ref-&gt;{'dn'}=$server_dn;
-	$nodes-&gt;{$server}=$node_ref;
-      }
-    }
-  }
-  return findBestServer($nodes,$ldap, $uid);
+	my ($dn, $ldap, $uid)=@_;
+	####
+	#### FIXME: get scope from config file in /etc/x2go/x2gobroker-*.conf
+	####
+	my $mesg=$ldap-&gt;search(base =&gt; $dn,
+	                       scope =&gt; 'base',
+	                       filter =&gt; '(objectClass=X2GoServer)'
+	         );
+
+	if($mesg-&gt;code)
+	{
+		return 0;
+	}
+
+	my @entries=$mesg-&gt;entries();
+	my $ref = @entries[0]-&gt;get_value ( 'serverNode', asref =&gt; 1 );
+	my $nodes;
+	foreach(@$ref)
+	{
+		my $server=$_;
+		my @sdn=split(&quot;,&quot;,$dn);
+		shift(@sdn);
+		shift(@sdn);
+		my $server_dn=&quot;cn=$server,ou=Hosts,&quot;.join(&quot;,&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at sdn</A>);
+
+		my $mesg=$ldap-&gt;search(base =&gt; $server_dn,
+		                       scope =&gt; 'base',
+		                       filter =&gt; '(objectClass=X2GoServerNode)'
+		         );
+		if( ! $mesg-&gt;code )
+		{
+			my @entries=$mesg-&gt;entries();
+			if(@entries[0]-&gt;get_value('serverStatus') eq 'TRUE')
+			{
+				my $node_ref={};
+				$node_ref-&gt;{'ip'}=@entries[0]-&gt;get_value('ipHostNumber');
+				$node_ref-&gt;{'sessions'}=0;
+				$node_ref-&gt;{'dn'}=$server_dn;
+				$nodes-&gt;{$server}=$node_ref;
+			}
+		}
+	}
+	return findBestServer($nodes,$ldap, $uid);
 }
 
 sub findBestServer
 {
-  my ($nodes, $ldap, $user)=@_;
-  my $servers;
-  my $status;
-  while( my ($key,$value) = each(%$nodes))
-  {
-      if(!$status)
-      {
-	my $ip=$value-&gt;{'ip'};
-	my $dn=$value-&gt;{'dn'};
-	($status,$servers)=remoteBroker($ip,$user,'getservers',$dn, $ldap);
-	if(!$status)
+	my ($nodes, $ldap, $user)=@_;
+	my $servers;
+	my $status;
+	while( my ($key,$value) = each(%$nodes))
+	{
+		if( ! $status )
+		{
+			my $ip=$value-&gt;{'ip'};
+			my $dn=$value-&gt;{'dn'};
+			($status,$servers)=remoteBroker($ip,$user,'getservers',$dn, $ldap);
+			if(!$status)
+			{
+				delete $nodes-&gt;{$key};
+			}
+		}
+	}
+	if( ! $status )
+	{
+		return 0;
+	}
+	my @srvlines=split(&quot;\n&quot;,$servers);
+	foreach(@srvlines)
 	{
-	  delete $nodes-&gt;{$key};
+		my @words=split(' ',$_);
+		my $ref=$nodes-&gt;{@words[0]};
+		if( $ref )
+		{
+			$ref-&gt;{'sessions'}=1*@words[1];
+		}
 	}
-      }
-  }
-  if(!$status)
-  {
-    return 0;
-  }
-  my @srvlines=split(&quot;\n&quot;,$servers);
-  foreach(@srvlines)
-  {
-    my @words=split(' ',$_);
-    my $ref=$nodes-&gt;{@words[0]};
-    if($ref)
-    {
-      $ref-&gt;{'sessions'}=1*@words[1];
-    }
-  }	  
-  return checkServers($nodes, $ldap, $user);
+	return checkServers($nodes, $ldap, $user);
 }
 
 sub checkServers
-{  
-  my ($nodes, $ldap, $user)=@_;
-  my $bestnode=0;
-  my $bestnodekey;
-  my $key;
-  my $value;
-  while( ($key,$value) = each(%$nodes)) 
-  {
-      if(! $bestnode)
-      {
-	$bestnode=$value;
-	$bestnodekey=$key;
-      }
-      else
-      {
-	if($value-&gt;{'sessions'}&lt;$bestnode-&gt;{'sessions'})
+{
+	my ($nodes, $ldap, $user)=@_;
+	my $bestnode=0;
+	my $bestnodekey;
+	my $key;
+	my $value;
+	while( ($key,$value) = each(%$nodes)) 
+	{
+		if(! $bestnode)
+		{
+			$bestnode=$value;
+			$bestnodekey=$key;
+		} else {
+			if($value-&gt;{'sessions'}&lt;$bestnode-&gt;{'sessions'})
+			{
+				$bestnode=$value;
+				$bestnodekey=$key;
+			}
+		}
+	}
+	if( ! $bestnode )
 	{
-	  $bestnode=$value;
-	  $bestnodekey=$key;
+		print &quot;bestnode is null: \n&quot;;
+		return 0;
+	} else {
+		my $ip=$bestnode-&gt;{'ip'};
+		my $dn=$bestnode-&gt;{'dn'};
+		my ($status,$fakearr)=remoteBroker($ip,$user,'ping',$dn, $ldap);
+		if( ! $status )
+		{
+			delete $nodes-&gt;{$bestnodekey};
+			return checkServers($nodes, $ldap, $user);
+		} else {
+			return $bestnode;
+		}
 	}
-      }
-  }
-  if(!$bestnode)
-  {
-    print &quot;bestnode is null: \n&quot;;
-    return 0;
-  }
-  else
-  {
-    my $ip=$bestnode-&gt;{'ip'};
-    my $dn=$bestnode-&gt;{'dn'};
-    my ($status,$fakearr)=remoteBroker($ip,$user,'ping',$dn, $ldap);
-    if(!$status)
-    {
-      delete $nodes-&gt;{$bestnodekey};      
-      return checkServers($nodes, $ldap, $user);
-    }
-    else
-    {
-      return $bestnode;
-    }
-  }
 }
 
 
 sub check_ts
 {
-  my ($host, $user)=@_;
-  my $server_dn;
-  my $ldap;
-  my($status,$sessions)=getSessionRunning($server_dn, 
-				$host,
-				$user, $ldap);
-  if($status)
-  {
-    return (1,$sessions);
-  }
-  return (0,0);
+	my ($host, $user)=@_;
+	my $server_dn;
+	my $ldap;
+	my($status,$sessions)=getSessionRunning($server_dn, $host, $user, $ldap);
+	if( $status )
+	{
+		return (1,$sessions);
+	}
+	return (0,0);
 }
 
 sub getSessionRunning
 {
-  my ($dn,$ip,$user, $ldap)=@_;
-  my ($status,$sessions)=remoteBroker($ip,$user,'listsessions', $dn, $ldap);
-  if(!$status)
-  {
-    return (0,0);
-  }
-  else
-  {
-    return (1,$sessions);
-  }
+	my ($dn,$ip,$user, $ldap)=@_;
+	my ($status,$sessions)=remoteBroker($ip,$user,'listsessions', $dn, $ldap);
+	if( ! $status )
+	{
+		return (0,0);
+	} else {
+		return (1,$sessions);
+	}
 }
 
 sub remoteBroker
 {
-  my ($ip, $user, $cmd, $dn, $ldap)=@_;
-  my $res=`ssh -o ConnectTimeout=15 -o UserKnownHostsFile=/etc/x2go/x2gobroker/ts_known_hosts x2gobroker\@$ip -i /etc/x2go/x2gobroker/id_x2gobroker_dsa \&quot;/usr/lib/x2go/broker/x2gobroker-command $user $cmd 2&gt;/dev/null\&quot;`;
-  my @rarr=split(&quot;\n&quot;,$res);
-  my $stat;
-  if(@rarr[0] eq 'OK')
-  {
-    $stat=1;
-  }
-  else
-  {
-    $stat=0;
-#    setNodeDown($dn, $ldap, $cmd, $user);
-  }
-  shift(@rarr);
-  return($stat,join(&quot;\n&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at rarr</A>));
+	my ($ip, $user, $cmd, $dn, $ldap)=@_;
+	my $res=`ssh -o ConnectTimeout=15 -o UserKnownHostsFile=/etc/x2go/x2gobroker/ts_known_hosts x2gobroker\@$ip -i /etc/x2go/x2gobroker/id_x2gobroker_dsa \&quot;/usr/lib/x2go/broker/x2gobroker-command $user $cmd 2&gt;/dev/null\&quot;`;
+	my @rarr=split(&quot;\n&quot;,$res);
+	my $stat;
+	if(@rarr[0] eq 'OK')
+	{
+		$stat=1;
+	} else {
+		$stat=0;
+		# setNodeDown($dn, $ldap, $cmd, $user);
+	}
+	shift(@rarr);
+	return($stat,join(&quot;\n&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">, at rarr</A>));
 }
 
 sub notify
 {
-  my $message=shift;
-  open (F,&quot;&gt;&gt;/tmp/x2gobroker.log&quot;);
-  print F `date`.$message.&quot;\n&quot;;
-  close(F);
+	my $message=shift;
+	open (F,&quot;&gt;&gt;/tmp/x2gobroker.log&quot;);
+	print F `date`.$message.&quot;\n&quot;;
+	close(F);
 }
 
 sub setNodeDown
 {
-  my($dn, $ldap, $cmd, $user)=@_;
-  my $attr;
-  push(@$attr,'serverStatus' =&gt; 'FALSE');
-  my $changes;
-  push (@$changes, 'replace' =&gt; $attr);
-  $ldap-&gt;modify($dn,changes =&gt; $changes);  
-  notify (&quot;set status of $dn to \&quot;down\&quot;, failed command: \&quot;$cmd\&quot;, user: \&quot;$user\&quot;\n&quot;);
+	my($dn, $ldap, $cmd, $user)=@_;
+	my $attr;
+	push(@$attr,'serverStatus' =&gt; 'FALSE');
+	my $changes;
+	push (@$changes, 'replace' =&gt; $attr);
+	$ldap-&gt;modify($dn,changes =&gt; $changes);  
+	notify (&quot;set status of $dn to \&quot;down\&quot;, failed command: \&quot;$cmd\&quot;, user: \&quot;$user\&quot;\n&quot;);
 }
 
 sub setServerDown
 {
-  my($dn, $ldap)=@_;
-  my $attr;
-  push(@$attr,'serverStatus' =&gt; 'FALSE');
-  my $changes;
-  push (@$changes, 'replace' =&gt; $attr);
-  $ldap-&gt;modify($dn,changes =&gt; $changes);  
-  notify (&quot;set status of $dn to \&quot;down\&quot;, all nodes are down\n&quot;);
+	my($dn, $ldap)=@_;
+	my $attr;
+	push(@$attr,'serverStatus' =&gt; 'FALSE');
+	my $changes;
+	push (@$changes, 'replace' =&gt; $attr);
+	$ldap-&gt;modify($dn,changes =&gt; $changes);  
+	notify (&quot;set status of $dn to \&quot;down\&quot;, all nodes are down\n&quot;);
 }
 
 sub checkAccess 
 {
-        my ($user,$pass)=@_;
-       
-        my $ldap = initLdap();
-       
-       
-        my $dn=&quot;uid=$user,ou=People&quot;.getBase($binddn);
-        my $mesg=$ldap-&gt;search(base =&gt; $dn, 
-		    scope =&gt; 'base', filter =&gt; '(objectClass=posixAccount)');
-       
-	if($mesg-&gt;code)
+	my ($user,$pass)=@_;
+
+	my $ldap = initLdap();
+
+	my $dn=&quot;uid=$user,ou=People&quot;.getBase($binddn);
+	my $mesg=$ldap-&gt;search(base =&gt; $dn,
+	                       scope =&gt; 'base',
+	                       filter =&gt; '(objectClass=posixAccount)'
+	         );
+
+	if( $mesg-&gt;code )
 	{
-	  return 0;
+		return 0;
 	}
 
 	my @entries=$mesg-&gt;entries();
 	my $crypted=@entries[0]-&gt;get_value('userPassword');
 	$mesg = $ldap-&gt;unbind;
-	if(Crypt::SaltedHash-&gt;validate($crypted, $pass))
+	if ( Crypt::SaltedHash-&gt;validate($crypted, $pass) )
 	{
-	  return 1;
+		return 1;
 	}
 	return 0;
 }
 
 sub listSessions
 {
-  my $user=shift;
-  
-  my $ldap = initLdap();
-       
-  my $dn=&quot;ou=Servers,ou=ON&quot;.getBase($binddn);
-  my $message=$ldap-&gt;search(base =&gt; $dn, 
-		    scope =&gt; 'sub', filter =&gt; '(objectClass=ipHost)');
-
-  if($message-&gt;code)
-  {
-        die $message-&gt;error.&quot;: &quot;.$message-&gt;error_desc;
-  }
-#  print Dumper($message-&gt;entries);
-  print &quot;START_USER_SESSIONS&lt;br&gt;&quot;;
-  foreach ($message-&gt;entries)
-  {
-    my $asn=$_-&gt;{'asn'};
-    my $attr=$asn-&gt;{'attributes'};
-    my $host;
-    my $int_ip;
-    my $ext_ip;
-    my $ext_port;    
-    foreach (@$attr)
-    {
-      my $type=$_-&gt;{'type'};
-      my $value=$_-&gt;{'vals'}[0];
-      if($type eq 'cn')
-      {
-	    $host=$value;
-      }
-    }
-    my($status,$sessions)=getSessionRunning($dn,$host,$user, $ldap);
-    if($status)
-    {
-      my $sess_srv;
-      if($sessions)
-      {
-          my @sinfo=split(&quot;\\|&quot;,$sessions);
-          my $sess_stat=@sinfo[4];
-          $sess_srv=@sinfo[3];
-          my $sid=@sinfo[1];
-          print &quot;&lt;br&gt;[$host\@$sid]&lt;br&gt;&quot;;
-          print &quot;status=$sess_stat&lt;br&gt;&quot;;
-          #get ip
-          #get port
-      }
-      else
-      {
-          my $sessions;
-          ($sess_srv,$ext_ip,$ext_port, $sessions)=getBestNode($dn, $ldap, $user, $host, $message);
-          print &quot;&lt;br&gt;[$host]&lt;br&gt;&quot;;
-      }
-      #print &quot;host=$ext_ip&lt;br&gt;&quot;;
-      print &quot;user=$user&lt;br&gt;&quot;;
-      #print &quot;sshport=$ext_port&lt;br&gt;&quot;;
-      print &quot;name=Stadt Treuchtlingen&lt;br&gt;&quot;;
-      goto loop_end;
-    }
-  }
-loop_end:
-  print &quot;END_USER_SESSIONS&lt;br&gt;&quot;;
-  $ldap-&gt;unbind();
+	my $user=shift;
+
+	my $ldap = initLdap();
+
+	my $dn=&quot;ou=Servers,ou=ON&quot;.getBase($binddn);
+	my $message=$ldap-&gt;search(base =&gt; $dn,
+	                          scope =&gt; 'sub',
+	                          filter =&gt; '(objectClass=ipHost)'
+	);
+
+	if($message-&gt;code)
+	{
+		die $message-&gt;error.&quot;: &quot;.$message-&gt;error_desc;
+	}
+	# print Dumper($message-&gt;entries);
+	print &quot;START_USER_SESSIONS&lt;br&gt;&quot;;
+	foreach ($message-&gt;entries)
+	{
+		my $asn=$_-&gt;{'asn'};
+		my $attr=$asn-&gt;{'attributes'};
+		my $host;
+		my $int_ip;
+		my $ext_ip;
+		my $ext_port;
+		foreach (@$attr)
+		{
+			my $type=$_-&gt;{'type'};
+			my $value=$_-&gt;{'vals'}[0];
+			if( $type eq 'cn' )
+			{
+				$host=$value;
+			}
+		}
+		my($status,$sessions)=getSessionRunning($dn,$host,$user, $ldap);
+		if($status)
+		{
+			my $sess_srv;
+			if($sessions)
+			{
+				my @sinfo=split(&quot;\\|&quot;,$sessions);
+				my $sess_stat=@sinfo[4];
+				$sess_srv=@sinfo[3];
+				my $sid=@sinfo[1];
+				print &quot;&lt;br&gt;[$host\@$sid]&lt;br&gt;&quot;;
+				print &quot;status=$sess_stat&lt;br&gt;&quot;;
+				#get ip
+				#get port
+			} else {
+				my $sessions;
+				($sess_srv,$ext_ip,$ext_port, $sessions)=getBestNode($dn, $ldap, $user, $host, $message);
+				print &quot;&lt;br&gt;[$host]&lt;br&gt;&quot;;
+			}
+			#print &quot;host=$ext_ip&lt;br&gt;&quot;;
+			print &quot;user=$user&lt;br&gt;&quot;;
+			#print &quot;sshport=$ext_port&lt;br&gt;&quot;;
+			print &quot;name=Stadt Treuchtlingen&lt;br&gt;&quot;;
+			goto loop_end;
+		}
+	}
+	loop_end:
+	print &quot;END_USER_SESSIONS&lt;br&gt;&quot;;
+	$ldap-&gt;unbind();
 }
 
 sub getBestNode
 {
-  my ($dn, $ldap, $user, $ip, $message)=@_;
-  my $servers;
-  my $status;
-  ($status,$servers)=remoteBroker($ip,$user,'getservers',$dn, $ldap);
-  my $srvref={};
-  my @srvlines=split(&quot;\n&quot;,$servers);
-  foreach(@srvlines)
-  {
-    my @words=split(' ',$_);
-    $srvref-&gt;{@words[0]}=1*@words[1];
-  }
-  my $bestval=-1;
-  my $bestsrv;
-  my $bestext_ip;
-  my $bestext_port;
-  foreach ($message-&gt;entries)
-  {
-    my $asn=$_-&gt;{'asn'};
-    my $attr=$asn-&gt;{'attributes'};
-    my $host;
-    my $ext_ip;
-    my $ext_port;
-    foreach (@$attr)
-    {
-      my $type=$_-&gt;{'type'};
-      my $value=$_-&gt;{'vals'}[0];
-      if($type eq 'cn')
-      {
-	    $host=$value;
-      }
-      if($type eq 'description')
-      {
-	    my @words=split(&quot;:&quot;,$value);
-	    $ext_ip=@words[0];
-	    $ext_port=@words[1];
-      }
-    }
-    my $sess=$srvref-&gt;{$host};
-    if(! $sess)
-    {
-	return($host, $ext_ip, $ext_port,0);
-    }
-    if($sess &lt; $bestval || $bestval == -1)
-    {
-	$bestval=$sess;
-	$bestsrv=$host;
-	$bestext_ip=$ext_ip;
-	$bestext_port=$ext_port;
-    }
-  }
-  return($bestsrv, $bestext_ip, $bestext_port, $bestval);
+	my ($dn, $ldap, $user, $ip, $message)=@_;
+	my $servers;
+	my $status;
+	($status,$servers)=remoteBroker($ip,$user,'getservers',$dn, $ldap);
+	my $srvref={};
+	my @srvlines=split(&quot;\n&quot;,$servers);
+	foreach(@srvlines)
+	{
+		my @words=split(' ',$_);
+		$srvref-&gt;{@words[0]}=1*@words[1];
+	}
+	my $bestval=-1;
+	my $bestsrv;
+	my $bestext_ip;
+	my $bestext_port;
+	foreach ($message-&gt;entries)
+	{
+		my $asn=$_-&gt;{'asn'};
+		my $attr=$asn-&gt;{'attributes'};
+		my $host;
+		my $ext_ip;
+		my $ext_port;
+		foreach (@$attr)
+		{
+			my $type=$_-&gt;{'type'};
+			my $value=$_-&gt;{'vals'}[0];
+			if( $type eq 'cn' )
+			{
+				$host=$value;
+			}
+			if($type eq 'description')
+			{
+				my @words=split(&quot;:&quot;,$value);
+				$ext_ip=@words[0];
+				$ext_port=@words[1];
+			}
+		}
+		my $sess=$srvref-&gt;{$host};
+		if( ! $sess )
+		{
+			return($host, $ext_ip, $ext_port,0);
+		}
+		if($sess &lt; $bestval || $bestval == -1)
+		{
+			$bestval=$sess;
+			$bestsrv=$host;
+			$bestext_ip=$ext_ip;
+			$bestext_port=$ext_port;
+		}
+	}
+	return($bestsrv, $bestext_ip, $bestext_port, $bestval);
 }
 
 1;


hooks/post-receive
-- 
x2gobroker.git (HTTP(S) Session broker for X2Go)

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;x2gobroker.git&quot; (HTTP(S) Session broker for X2Go).

</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007322.html">[X2Go-Commits] x2gobroker.git - build-main (branch) updated:	fbde70cbb12c5687ee3e4597a782fc25a86d8011
</A></li>
	<LI>Next message: <A HREF="007325.html">[X2Go-Commits] x2gobroker.git - build-main (branch) updated:	70d45f5895ec8ca79f3b6703d9e1e30997d39c51
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7324">[ date ]</a>
              <a href="thread.html#7324">[ thread ]</a>
              <a href="subject.html#7324">[ subject ]</a>
              <a href="author.html#7324">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/x2go-commits">More information about the X2Go-commits
mailing list</a><br>
</body></html>
