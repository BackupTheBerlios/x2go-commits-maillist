<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [X2go-Commits] x2goclient.git - master (branch) updated:	3.0.1.18-47-g34f3989
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/x2go-commits/2011-July/index.html" >
   <LINK REL="made" HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2go-Commits%5D%20x2goclient.git%20-%20master%20%28branch%29%20updated%3A%0A%093.0.1.18-47-g34f3989&In-Reply-To=%3C20110714074641.177705DB38%40ymir.das-netzwerkteam.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001193.html">
   <LINK REL="Next"  HREF="001195.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[X2go-Commits] x2goclient.git - master (branch) updated:	3.0.1.18-47-g34f3989</H1>
    <B>X2go dev team</B> 
    <A HREF="mailto:x2go-commits%40lists.berlios.de?Subject=Re%3A%20%5BX2go-Commits%5D%20x2goclient.git%20-%20master%20%28branch%29%20updated%3A%0A%093.0.1.18-47-g34f3989&In-Reply-To=%3C20110714074641.177705DB38%40ymir.das-netzwerkteam.de%3E"
       TITLE="[X2go-Commits] x2goclient.git - master (branch) updated:	3.0.1.18-47-g34f3989">git-admin at x2go.org
       </A><BR>
    <I>Thu Jul 14 09:46:40 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="001193.html">[X2go-Commits] pyhoca-gui.git - master (branch) updated:	0.1.0.6-3-g45bd114
</A></li>
        <LI>Next message: <A HREF="001195.html">[X2go-Commits] python-x2go.git - build-main (branch) updated:	0.1.1.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1194">[ date ]</a>
              <a href="thread.html#1194">[ thread ]</a>
              <a href="subject.html#1194">[ subject ]</a>
              <a href="author.html#1194">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The branch, master has been updated
       via  34f39898b958bc37bd93c24f5605e0c90c0ac78e (commit)
       via  e73a88d9f7f53e102ddac38122b52c4a089514e6 (commit)
       via  7377e0ea98f56cdf97fff63d3ea69d7a20c8eb1f (commit)
      from  23cc0c462239bc27076a475fb541bf5c3c6767ec (commit)

Those revisions listed above that are new to this repository have
not appeared on any other notification email; so we list those
revisions in full, below.

- Log -----------------------------------------------------------------
commit 34f39898b958bc37bd93c24f5605e0c90c0ac78e
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Thu Jul 14 09:46:07 2011 +0200

    bundle commit, worked in unreleased non-Git versions 3.01-19, 3.01-20, 3.01-21, bumping towards version 3.0.99.0.

commit e73a88d9f7f53e102ddac38122b52c4a089514e6
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Thu Jul 14 09:17:04 2011 +0200

    re-refer to NoMachine as NXv3 source (as they became active again...)

commit 7377e0ea98f56cdf97fff63d3ea69d7a20c8eb1f
Author: Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;
Date:   Thu Jul 14 09:16:51 2011 +0200

    remove build files

-----------------------------------------------------------------------

Summary of changes:
 .DS_Store                            |  Bin 6148 -&gt; 0 bytes
 .kdev4/x2goclient-3.01-libssh.kdev4  |   20 -
 INSTALL                              |    2 +-
 VERSION                              |    2 +-
 brokerpassdialog.ui                  |  182 ++++++++
 brokerpassdlg.cpp                    |   71 +++
 xsettingswidget.h =&gt; brokerpassdlg.h |   26 +-
 build_win_plugin.bat                 |    7 +
 config_linux_static.sh               |    2 +-
 config_linux_static_plugin.sh        |    1 +
 debian/changelog                     |   31 ++-
 desktop/x2goclient.desktop           |    2 +-
 httpbrokerclient.cpp                 |  824 +++++++++++++++++++---------------
 httpbrokerclient.h                   |   63 ++-
 icons/32x32/auth.png                 |  Bin 0 -&gt; 1686 bytes
 object_script.x2goclient.Debug       |    2 +
 object_script.x2goclient.Release     |    2 +
 onmainwindow.cpp                     |  252 ++++++++++-
 onmainwindow.h                       |   33 ++-
 onmainwindow_part2.cpp               |  143 ++++--
 onmainwindow_part3.cpp               |  130 +++++-
 onmainwindow_part4.cpp               |  152 +++++--
 onmainwindow_privat.h                |    1 +
 resources.rcc                        |    1 +
 sessionbutton.cpp                    |  111 ++++--
 sessionbutton.h                      |    1 +
 sshmasterconnection.cpp              |   26 +-
 sshmasterconnection.h                |    7 +-
 sshprocess.cpp                       |    2 +-
 version.h                            |    2 +-
 wapi.cpp                             |   32 ++
 wapi.h                               |    2 +
 x2goclient.pro                       |   17 +-
 x2goclientconfig.h                   |    2 +-
 x2goplugin.rc                        |   10 +-
 x2gosettings.cpp                     |   50 ++-
 x2gosettings.h                       |    4 +-
 xsettingsui.ui                       |   29 +--
 xsettingswidget.cpp                  |   14 +-
 39 files changed, 1626 insertions(+), 632 deletions(-)
 delete mode 100644 .DS_Store
 delete mode 100644 .kdev4/x2goclient-3.01-libssh.kdev4
 create mode 100644 brokerpassdialog.ui
 create mode 100644 brokerpassdlg.cpp
 copy xsettingswidget.h =&gt; brokerpassdlg.h (63%)
 create mode 100755 build_win_plugin.bat
 create mode 100644 icons/32x32/auth.png

The diff of changes is:
diff --git a/.DS_Store b/.DS_Store
deleted file mode 100644
index 5008ddf..0000000
Binary files a/.DS_Store and /dev/null differ
diff --git a/.kdev4/x2goclient-3.01-libssh.kdev4 b/.kdev4/x2goclient-3.01-libssh.kdev4
deleted file mode 100644
index 4e0da72..0000000
--- a/.kdev4/x2goclient-3.01-libssh.kdev4
+++ /dev/null
@@ -1,20 +0,0 @@
-[Buildset]
-BuildItems=@Variant(\x00\x00\x00\t\x00\x00\x00\x00\x01\x00\x00\x00\x0b\x00\x00\x00\x00\x01\x00\x00\x00,\x00x\x002\x00g\x00o\x00c\x00l\x00i\x00e\x00n\x00t\x00-\x003\x00.\x000\x001\x00-\x00l\x00i\x00b\x00s\x00s\x00h)
-
-[Launch]
-Launch Configurations=Launch Configuration 0
-
-[Launch][Launch Configuration 0]
-Configured Launch Modes=execute
-Configured Launchers=nativeAppLauncher
-Name=New Native Application Configuration
-Type=Native Application
-
-[Launch][Launch Configuration 0][Data]
-Arguments=
-Dependencies=@Variant(\x00\x00\x00\t\x00\x00\x00\x00\x00)
-Dependency Action=Nothing
-EnvironmentGroup=default
-Executable=<A HREF="file:///usr/src.cur/db-builds/x2goclient/x2goclient-3.01/x2goclient">file:///usr/src.cur/db-builds/x2goclient/x2goclient-3.01/x2goclient</A>
-Working Directory=
-isExecutable=true
diff --git a/INSTALL b/INSTALL
index 6bef37b..05d9730 100644
--- a/INSTALL
+++ b/INSTALL
@@ -7,7 +7,7 @@ Qt4:
 <A HREF="http://www.trolltech.com">http://www.trolltech.com</A>
 
 nxcomp+nxproxy:
-<A HREF="http://code.x2go.org/releases">http://code.x2go.org/releases</A>
+<A HREF="http://www.nomachine.com/sources.php">http://www.nomachine.com/sources.php</A>
 
 You may want also install pulseaudio sound server to enable sound support 
 <A HREF="http://www.pulseaudio.org/wiki/DownloadPulseAudio">http://www.pulseaudio.org/wiki/DownloadPulseAudio</A>
diff --git a/VERSION b/VERSION
index df46582..14e681e 100644
--- a/VERSION
+++ b/VERSION
@@ -1 +1 @@
-3.0.1.18
+3.0.99.0
diff --git a/brokerpassdialog.ui b/brokerpassdialog.ui
new file mode 100644
index 0000000..333a577
--- /dev/null
+++ b/brokerpassdialog.ui
@@ -0,0 +1,182 @@
+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
+&lt;ui version=&quot;4.0&quot;&gt;
+ &lt;class&gt;BrokerPassDialogUi&lt;/class&gt;
+ &lt;widget class=&quot;QDialog&quot; name=&quot;BrokerPassDialogUi&quot;&gt;
+  &lt;property name=&quot;geometry&quot;&gt;
+   &lt;rect&gt;
+    &lt;x&gt;0&lt;/x&gt;
+    &lt;y&gt;0&lt;/y&gt;
+    &lt;width&gt;311&lt;/width&gt;
+    &lt;height&gt;160&lt;/height&gt;
+   &lt;/rect&gt;
+  &lt;/property&gt;
+  &lt;property name=&quot;windowTitle&quot;&gt;
+   &lt;string&gt;Dialog&lt;/string&gt;
+  &lt;/property&gt;
+  &lt;layout class=&quot;QVBoxLayout&quot; name=&quot;verticalLayout&quot;&gt;
+   &lt;item&gt;
+    &lt;layout class=&quot;QGridLayout&quot; name=&quot;gridLayout&quot;&gt;
+     &lt;item row=&quot;0&quot; column=&quot;0&quot;&gt;
+      &lt;widget class=&quot;QLabel&quot; name=&quot;label&quot;&gt;
+       &lt;property name=&quot;text&quot;&gt;
+        &lt;string&gt;Old password:&lt;/string&gt;
+       &lt;/property&gt;
+      &lt;/widget&gt;
+     &lt;/item&gt;
+     &lt;item row=&quot;0&quot; column=&quot;1&quot;&gt;
+      &lt;widget class=&quot;QLineEdit&quot; name=&quot;leOldPas&quot;&gt;
+       &lt;property name=&quot;echoMode&quot;&gt;
+        &lt;enum&gt;QLineEdit::Password&lt;/enum&gt;
+       &lt;/property&gt;
+      &lt;/widget&gt;
+     &lt;/item&gt;
+     &lt;item row=&quot;1&quot; column=&quot;0&quot;&gt;
+      &lt;widget class=&quot;QLabel&quot; name=&quot;label_2&quot;&gt;
+       &lt;property name=&quot;text&quot;&gt;
+        &lt;string&gt;New password:&lt;/string&gt;
+       &lt;/property&gt;
+      &lt;/widget&gt;
+     &lt;/item&gt;
+     &lt;item row=&quot;1&quot; column=&quot;1&quot;&gt;
+      &lt;widget class=&quot;QLineEdit&quot; name=&quot;lePass1&quot;&gt;
+       &lt;property name=&quot;echoMode&quot;&gt;
+        &lt;enum&gt;QLineEdit::Password&lt;/enum&gt;
+       &lt;/property&gt;
+      &lt;/widget&gt;
+     &lt;/item&gt;
+     &lt;item row=&quot;2&quot; column=&quot;0&quot;&gt;
+      &lt;widget class=&quot;QLabel&quot; name=&quot;label_3&quot;&gt;
+       &lt;property name=&quot;text&quot;&gt;
+        &lt;string&gt;Confirm password:&lt;/string&gt;
+       &lt;/property&gt;
+      &lt;/widget&gt;
+     &lt;/item&gt;
+     &lt;item row=&quot;2&quot; column=&quot;1&quot;&gt;
+      &lt;widget class=&quot;QLineEdit&quot; name=&quot;lePass2&quot;&gt;
+       &lt;property name=&quot;echoMode&quot;&gt;
+        &lt;enum&gt;QLineEdit::Password&lt;/enum&gt;
+       &lt;/property&gt;
+      &lt;/widget&gt;
+     &lt;/item&gt;
+    &lt;/layout&gt;
+   &lt;/item&gt;
+   &lt;item&gt;
+    &lt;spacer name=&quot;verticalSpacer&quot;&gt;
+     &lt;property name=&quot;orientation&quot;&gt;
+      &lt;enum&gt;Qt::Vertical&lt;/enum&gt;
+     &lt;/property&gt;
+     &lt;property name=&quot;sizeHint&quot; stdset=&quot;0&quot;&gt;
+      &lt;size&gt;
+       &lt;width&gt;20&lt;/width&gt;
+       &lt;height&gt;40&lt;/height&gt;
+      &lt;/size&gt;
+     &lt;/property&gt;
+    &lt;/spacer&gt;
+   &lt;/item&gt;
+   &lt;item&gt;
+    &lt;widget class=&quot;QLabel&quot; name=&quot;statusLabel&quot;&gt;
+     &lt;property name=&quot;text&quot;&gt;
+      &lt;string&gt;TextLabel&lt;/string&gt;
+     &lt;/property&gt;
+    &lt;/widget&gt;
+   &lt;/item&gt;
+   &lt;item&gt;
+    &lt;layout class=&quot;QHBoxLayout&quot; name=&quot;horizontalLayout&quot;&gt;
+     &lt;item&gt;
+      &lt;spacer name=&quot;horizontalSpacer&quot;&gt;
+       &lt;property name=&quot;orientation&quot;&gt;
+        &lt;enum&gt;Qt::Horizontal&lt;/enum&gt;
+       &lt;/property&gt;
+       &lt;property name=&quot;sizeHint&quot; stdset=&quot;0&quot;&gt;
+        &lt;size&gt;
+         &lt;width&gt;40&lt;/width&gt;
+         &lt;height&gt;20&lt;/height&gt;
+        &lt;/size&gt;
+       &lt;/property&gt;
+      &lt;/spacer&gt;
+     &lt;/item&gt;
+     &lt;item&gt;
+      &lt;widget class=&quot;QDialogButtonBox&quot; name=&quot;buttonBox&quot;&gt;
+       &lt;property name=&quot;orientation&quot;&gt;
+        &lt;enum&gt;Qt::Horizontal&lt;/enum&gt;
+       &lt;/property&gt;
+       &lt;property name=&quot;standardButtons&quot;&gt;
+        &lt;set&gt;QDialogButtonBox::Cancel|QDialogButtonBox::Ok&lt;/set&gt;
+       &lt;/property&gt;
+      &lt;/widget&gt;
+     &lt;/item&gt;
+    &lt;/layout&gt;
+   &lt;/item&gt;
+  &lt;/layout&gt;
+ &lt;/widget&gt;
+ &lt;resources/&gt;
+ &lt;connections&gt;
+  &lt;connection&gt;
+   &lt;sender&gt;buttonBox&lt;/sender&gt;
+   &lt;signal&gt;accepted()&lt;/signal&gt;
+   &lt;receiver&gt;BrokerPassDialogUi&lt;/receiver&gt;
+   &lt;slot&gt;accept()&lt;/slot&gt;
+   &lt;hints&gt;
+    &lt;hint type=&quot;sourcelabel&quot;&gt;
+     &lt;x&gt;292&lt;/x&gt;
+     &lt;y&gt;143&lt;/y&gt;
+    &lt;/hint&gt;
+    &lt;hint type=&quot;destinationlabel&quot;&gt;
+     &lt;x&gt;157&lt;/x&gt;
+     &lt;y&gt;153&lt;/y&gt;
+    &lt;/hint&gt;
+   &lt;/hints&gt;
+  &lt;/connection&gt;
+  &lt;connection&gt;
+   &lt;sender&gt;buttonBox&lt;/sender&gt;
+   &lt;signal&gt;rejected()&lt;/signal&gt;
+   &lt;receiver&gt;BrokerPassDialogUi&lt;/receiver&gt;
+   &lt;slot&gt;reject()&lt;/slot&gt;
+   &lt;hints&gt;
+    &lt;hint type=&quot;sourcelabel&quot;&gt;
+     &lt;x&gt;286&lt;/x&gt;
+     &lt;y&gt;143&lt;/y&gt;
+    &lt;/hint&gt;
+    &lt;hint type=&quot;destinationlabel&quot;&gt;
+     &lt;x&gt;286&lt;/x&gt;
+     &lt;y&gt;153&lt;/y&gt;
+    &lt;/hint&gt;
+   &lt;/hints&gt;
+  &lt;/connection&gt;
+  &lt;connection&gt;
+   &lt;sender&gt;lePass1&lt;/sender&gt;
+   &lt;signal&gt;textChanged(QString)&lt;/signal&gt;
+   &lt;receiver&gt;BrokerPassDialogUi&lt;/receiver&gt;
+   &lt;slot&gt;slotPassChanged()&lt;/slot&gt;
+   &lt;hints&gt;
+    &lt;hint type=&quot;sourcelabel&quot;&gt;
+     &lt;x&gt;167&lt;/x&gt;
+     &lt;y&gt;46&lt;/y&gt;
+    &lt;/hint&gt;
+    &lt;hint type=&quot;destinationlabel&quot;&gt;
+     &lt;x&gt;103&lt;/x&gt;
+     &lt;y&gt;113&lt;/y&gt;
+    &lt;/hint&gt;
+   &lt;/hints&gt;
+  &lt;/connection&gt;
+  &lt;connection&gt;
+   &lt;sender&gt;lePass2&lt;/sender&gt;
+   &lt;signal&gt;textChanged(QString)&lt;/signal&gt;
+   &lt;receiver&gt;BrokerPassDialogUi&lt;/receiver&gt;
+   &lt;slot&gt;slotPassChanged()&lt;/slot&gt;
+   &lt;hints&gt;
+    &lt;hint type=&quot;sourcelabel&quot;&gt;
+     &lt;x&gt;215&lt;/x&gt;
+     &lt;y&gt;79&lt;/y&gt;
+    &lt;/hint&gt;
+    &lt;hint type=&quot;destinationlabel&quot;&gt;
+     &lt;x&gt;208&lt;/x&gt;
+     &lt;y&gt;105&lt;/y&gt;
+    &lt;/hint&gt;
+   &lt;/hints&gt;
+  &lt;/connection&gt;
+ &lt;/connections&gt;
+ &lt;slots&gt;
+  &lt;slot&gt;slotPassChanged()&lt;/slot&gt;
+ &lt;/slots&gt;
+&lt;/ui&gt;
diff --git a/brokerpassdlg.cpp b/brokerpassdlg.cpp
new file mode 100644
index 0000000..b3a7571
--- /dev/null
+++ b/brokerpassdlg.cpp
@@ -0,0 +1,71 @@
+/*
+    &lt;one line to give the program's name and a brief idea of what it does.&gt;
+    Copyright (C) 2011  Oleksandr Shneyder
+
+    This program is free software: you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
+
+*/
+
+#include &quot;brokerpassdlg.h&quot;
+#include &lt;QPushButton&gt;
+
+BrokerPassDlg::BrokerPassDlg(QWidget* parent, Qt::WindowFlags f): QDialog(parent, f)
+{
+    setupUi(this);
+    statusLabel-&gt;setText(QString::null);
+    buttonBox-&gt;button(QDialogButtonBox::Ok)-&gt;setEnabled(false);
+}
+
+BrokerPassDlg::~BrokerPassDlg()
+{
+
+}
+
+void BrokerPassDlg::slotPassChanged()
+{
+    bool passEq=false;
+    if (lePass1-&gt;text()!=lePass2-&gt;text())
+    {
+        passEq=false;
+        statusLabel-&gt;setText(tr(&quot;Passwords do not match&quot;));
+    }
+    else
+    {
+        passEq=true;
+        statusLabel-&gt;setText(QString::null);
+    }
+    buttonBox-&gt;button(QDialogButtonBox::Ok)-&gt;setEnabled(passEq &amp;&amp;
+            lePass1-&gt;text().size()&gt;0 &amp;&amp;
+            leOldPas-&gt;text().size()&gt;0);
+}
+
+void BrokerPassDlg::accept()
+{
+    QDialog::accept();
+}
+
+void BrokerPassDlg::reject()
+{
+    QDialog::reject();
+}
+
+QString BrokerPassDlg::newPass()
+{
+    return lePass1-&gt;text();
+}
+
+QString BrokerPassDlg::oldPass()
+{
+    return leOldPas-&gt;text();
+}
diff --git a/xsettingswidget.h b/brokerpassdlg.h
similarity index 63%
copy from xsettingswidget.h
copy to brokerpassdlg.h
index 0a441cf..90b3ba2 100644
--- a/xsettingswidget.h
+++ b/brokerpassdlg.h
@@ -1,6 +1,6 @@
 /*
     &lt;one line to give the program's name and a brief idea of what it does.&gt;
-    Copyright (C) 2011  Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
+    Copyright (C) 2011 Oleksandr Shneyder
 
     This program is free software: you can redistribute it and/or modify
     it under the terms of the GNU General Public License as published by
@@ -17,23 +17,25 @@
 
 */
 
-#ifndef XSETTINGSWIDGET_H
-#define XSETTINGSWIDGET_H
+#ifndef BROKERPASSDLG_H
+#define BROKERPASSDLG_H
 
-#include &lt;QWidget&gt;
 
-#include &quot;ui_xsettingsui.h&quot;
+#include &lt;QDialog&gt;
+#include &quot;ui_brokerpassdialog.h&quot;
 
-class XSettingsWidget : public QWidget, private Ui_XSettingsWidgetUI
+class BrokerPassDlg: public QDialog, private Ui_BrokerPassDialogUi
 {
     Q_OBJECT
 public:
-    XSettingsWidget(QWidget* parent = 0);
-    virtual ~XSettingsWidget();
-    void setDefaults();
-    void saveSettings();
+    BrokerPassDlg(QWidget* parent = 0, Qt::WindowFlags f = 0);
+    virtual ~BrokerPassDlg();
+    virtual void accept();
+    virtual void reject();
+    QString oldPass();
+    QString newPass();
 private slots:
-    void slotSetExecutable();
+    void slotPassChanged();
 };
 
-#endif // XSETTINGSWIDGET_H
+#endif // BROKERPASSDLG_H
diff --git a/build_win_plugin.bat b/build_win_plugin.bat
new file mode 100755
index 0000000..61989d0
--- /dev/null
+++ b/build_win_plugin.bat
@@ -0,0 +1,7 @@
+mingw32-make
+copy release\npx2goplugin.dll d:\share\plugin\x2goplugin\
+d:
+cd  \share\plugin\x2goplugin\
+idc.exe npx2goplugin.dll /idl npx2goplugin.idl -version 1.0
+midl npx2goplugin.idl /nologo /tlb npx2goplugin.tlb
+idc.exe npx2goplugin.dll /tlb npx2goplugin.tlb
diff --git a/config_linux_static.sh b/config_linux_static.sh
index 294b1d3..a51bac9 100755
--- a/config_linux_static.sh
+++ b/config_linux_static.sh
@@ -1,5 +1,5 @@
 #!/bin/bash
 
 make distclean
-/usr/local/Trolltech/Qt-4.7.1/bin/qmake -config release -spec linux-g++
+X2GO_LINUX_STATIC=x2go_linux_static /usr/local/Trolltech/Qt-4.7.1/bin/qmake -config release -spec linux-g++
 
diff --git a/config_linux_static_plugin.sh b/config_linux_static_plugin.sh
index b3ad0d9..4776a3c 100755
--- a/config_linux_static_plugin.sh
+++ b/config_linux_static_plugin.sh
@@ -2,4 +2,5 @@
 
 make distclean
 
+export X2GO_LINUX_STATIC=x2go_linux_static
 X2GO_CLIENT_TARGET=plugin /usr/local/Trolltech/Qt-4.7.1/bin/qmake -config release -spec linux-g++
diff --git a/debian/changelog b/debian/changelog
index 16cf113..ac2dd58 100644
--- a/debian/changelog
+++ b/debian/changelog
@@ -1,10 +1,37 @@
-x2goclient (3.0.1.18-0~x2go3) UNRELEASED; urgency=low
+x2goclient (3.0.99.0-0~x2go1) UNRELEASED; urgency=low
+
+  * nothing yet.
+
+ -- Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;  Thu, 14 Jul 2011 09:08:10 +0200
+
+x2goclient (3.0.1.21-0~x2go1) unstable; urgency=low
+
+  * changes in windows plugin
+
+ -- Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;  Thu, 30 Jun 2011 18:45:25 +0200
+
+x2goclient (3.0.1.20-0~x2go1) unstable; urgency=low
+
+  * support menu
+  * custom background
+  * custom icon on broker auth dialog
+  * fixed creation of desktop icons on windows
+
+ -- Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;  Fri, 08 Apr 2011 19:18:30 +0200
+
+x2goclient (3.0.1.19-0~x2go1) unstable; urgency=low
+
+  * Support to get sessions from for web broker
+
+ -- Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;  Thu, 29 Mar 2011 18:34:08 +0200
+
+x2goclient (3.0.1.18-0~x2go3) unstable; urgency=low
 
   * Add ssh (server) as runtime dependency
   * React to bug #627990, prefer man2html-base over man2html.
   * Use x2goumount-session instead of old x2goumount_session command.
 
- -- Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;  Thu, 16 Jun 2011 17:13:57 +0200
+ -- Mike Gabriel &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">mike.gabriel at das-netzwerkteam.de</A>&gt;  Thu, 14 Jul 2011 09:07:59 +0200
 
 x2goclient (3.0.1.18-0~x2go2) unstable; urgency=low
 
diff --git a/desktop/x2goclient.desktop b/desktop/x2goclient.desktop
index 29283c1..58f2ce0 100644
--- a/desktop/x2goclient.desktop
+++ b/desktop/x2goclient.desktop
@@ -1,6 +1,6 @@
 [Desktop Entry]
 Encoding=UTF-8
-Version=3.0.1.18
+Version=3.0.99.0
 Type=Application
 Name=X2Go Client
 Exec=/usr/bin/x2goclient
diff --git a/httpbrokerclient.cpp b/httpbrokerclient.cpp
index 2d7fcc4..0e0a6ab 100644
--- a/httpbrokerclient.cpp
+++ b/httpbrokerclient.cpp
@@ -24,195 +24,263 @@
 #include &lt;QTimer&gt;
 #include &quot;SVGFrame.h&quot;
 #include &quot;onmainwindow.h&quot;
+#include &lt;QTemporaryFile&gt;
 
 HttpBrokerClient::HttpBrokerClient ( ONMainWindow* wnd, ConfigFile* cfg )
 {
-	config=cfg;
-	mainWindow=wnd;
-	cmdRequest=sinfoKeyRequest=sinfoRequest=-1;
-	QUrl lurl ( config-&gt;brokerurl );
-	http=new QHttp ( this );
-
-	if ( config-&gt;brokerurl.indexOf ( &quot;<A HREF="https://">https://</A>&quot; ) !=-1 )
-		http-&gt;setHost ( lurl.host(),QHttp::ConnectionModeHttps,
-		                lurl.port ( 443 ) );
-	else
-		http-&gt;setHost ( lurl.host(),QHttp::ConnectionModeHttp,
-		                lurl.port ( 80 ) );
-
-	connect ( http,SIGNAL ( requestFinished ( int,bool ) ),this,
-	          SLOT ( slotRequestFinished ( int,bool ) ) );
-	connect ( http,SIGNAL ( sslErrors ( const QList&lt;QSslError&gt;&amp; ) ),this,
-	          SLOT ( slotSslErrors ( const QList&lt;QSslError&gt;&amp; ) ) );
-	getSInfoFromBroker ( true );
+    config=cfg;
+    mainWindow=wnd;
+    cmdRequest=sinfoKeyRequest=sinfoRequest=-1;
+    QUrl lurl ( config-&gt;brokerurl );
+    http=new QHttp ( this );
+
+    if ( config-&gt;brokerurl.indexOf ( &quot;<A HREF="https://">https://</A>&quot; ) !=-1 )
+        http-&gt;setHost ( lurl.host(),QHttp::ConnectionModeHttps,
+                        lurl.port ( 443 ) );
+    else
+        http-&gt;setHost ( lurl.host(),QHttp::ConnectionModeHttp,
+                        lurl.port ( 80 ) );
+
+    connect ( http,SIGNAL ( requestFinished ( int,bool ) ),this,
+              SLOT ( slotRequestFinished ( int,bool ) ) );
+    connect ( http,SIGNAL ( sslErrors ( const QList&lt;QSslError&gt;&amp; ) ),this,
+              SLOT ( slotSslErrors ( const QList&lt;QSslError&gt;&amp; ) ) );
+    if (!wnd-&gt;brokerMode)
+        getSInfoFromBroker ( true );
 }
 
 
 HttpBrokerClient::~HttpBrokerClient()
 {
+
+}
+
+void HttpBrokerClient::getUserSessions()
+{
+    QString req;
+    QTextStream ( &amp;req ) &lt;&lt;
+    &quot;task=listsessions&amp;&quot;&lt;&lt;
+    &quot;user=&quot;&lt;&lt;config-&gt;brokerUser&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+    &quot;password=&quot;&lt;&lt;config-&gt;brokerPass&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+    &quot;authid=&quot;&lt;&lt;config-&gt;brokerUserId;
+    QUrl lurl ( config-&gt;brokerurl );
+    httpSessionAnswer.close();
+    httpSessionAnswer.setData ( 0,0 );
+    sessionsRequest=http-&gt;post ( lurl.path(),req.toUtf8(),&amp;httpSessionAnswer );
+    config-&gt;sessiondata=QString::null;
+
+}
+
+void HttpBrokerClient::selectUserSession(const QString&amp; session)
+{
+//     x2goDebug&lt;&lt;&quot;selected sid: &quot;&lt;&lt;session;
+    QString req;
+    QTextStream ( &amp;req ) &lt;&lt;
+    &quot;task=selectsession&amp;&quot;&lt;&lt;
+    &quot;sid=&quot;&lt;&lt;session&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+    &quot;user=&quot;&lt;&lt;config-&gt;brokerUser&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+    &quot;password=&quot;&lt;&lt;config-&gt;brokerPass&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+    &quot;authid=&quot;&lt;&lt;config-&gt;brokerUserId;
+    QUrl lurl ( config-&gt;brokerurl );
+    httpSessionAnswer.close();
+    httpSessionAnswer.setData ( 0,0 );
+    selSessRequest=http-&gt;post ( lurl.path(),req.toUtf8(),&amp;httpSessionAnswer );
+
+}
+
+void HttpBrokerClient::changePassword(QString newPass)
+{
+    newBrokerPass=newPass;
+    QString req;
+    QTextStream ( &amp;req ) &lt;&lt;
+    &quot;task=setpass&amp;&quot;&lt;&lt;
+    &quot;newpass=&quot;&lt;&lt;newPass&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+    &quot;user=&quot;&lt;&lt;config-&gt;brokerUser&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+    &quot;password=&quot;&lt;&lt;config-&gt;brokerPass&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+    &quot;authid=&quot;&lt;&lt;config-&gt;brokerUserId;
+    QUrl lurl ( config-&gt;brokerurl );
+    httpSessionAnswer.close();
+    httpSessionAnswer.setData ( 0,0 );
+    chPassRequest=http-&gt;post ( lurl.path(),req.toUtf8(),&amp;httpSessionAnswer );
+
+}
+
+
+void HttpBrokerClient::createIniFile(const QString&amp; content)
+{
+    QString cont;
+    QStringList lines=content.split(&quot;START_USER_SESSIONS&lt;br&gt;&quot;);
+    if (lines.count()&gt;1)
+    {
+        cont=lines[1];
+        cont=cont.split(&quot;END_USER_SESSIONS&quot;)[0];
+        cont.replace(&quot;\n&quot;,&quot;&quot;);
+        cont.replace(&quot;&lt;br&gt;&quot;,&quot;\n&quot;);
+    }
+    mainWindow-&gt;config.iniFile=cont;
 }
 
 QString HttpBrokerClient::getSInfoFromBroker ( bool getKey )
 {
 
-	QString pack;
-	bool fullscreen;
-	int height;
-	int width;
-	int quality;
-	int speed;
-	bool usekbd;
-	bool setDPI=false;
-	uint dpi=96;
-	QString layout;
-	QString type;
-	QString homeDir=QDir::homePath();
-	X2goSettings st( &quot;sessions&quot; );
-
-	QString sid;
-	sid=&quot;embedded&quot;;
-	pack=st.setting()-&gt;value ( sid+&quot;/pack&quot;,
-	                ( QVariant ) &quot;16m-jpeg&quot; ).toString();
-	fullscreen=st.setting()-&gt;value ( sid+&quot;/fullscreen&quot;,
-	                      ( QVariant )
-	                      false ).toBool();
-	height=st.setting()-&gt;value ( sid+&quot;/height&quot;,
-	                  ( QVariant ) 600 ).toInt();
-	width=st.setting()-&gt;value ( sid+&quot;/width&quot;,
-	                 ( QVariant ) 800 ).toInt();
-	setDPI=st.setting()-&gt;value ( sid+&quot;/setdpi&quot;,
-	                  ( QVariant ) false ).toBool();
-	dpi=st.setting()-&gt;value ( sid+&quot;/dpi&quot;,
-	               ( QVariant ) 96 ).toUInt();
-	quality=st.setting()-&gt;value (
-	            sid+&quot;/quality&quot;,
-	            ( QVariant ) 9 ).toInt();
-	speed=st.setting()-&gt;value ( sid+&quot;/speed&quot;,
-	                 ( QVariant ) 2 ).toInt();
-	usekbd=st.setting()-&gt;value ( sid+&quot;/usekbd&quot;,
-	                  ( QVariant ) true ).toBool();
-	layout=st.setting()-&gt;value ( sid+&quot;/layout&quot;,
-	                  ( QVariant )
-	                  tr ( &quot;us&quot; ) ).toString();
-	type=st.setting()-&gt;value ( sid+&quot;/type&quot;,
-	                ( QVariant )
-	                tr ( &quot;pc105/us&quot; ) ).toString();
-	bool startEmbedded=false;
-	if ( st.setting()-&gt;value ( sid+&quot;/startembed&quot;,
-	                ( QVariant ) true ).toBool() )
-	{
-		startEmbedded=true;
-		fullscreen=false;
-		QSize sz=mainWindow-&gt;getEmbedAreaSize();
-		height=sz.height();
-		width=sz.width();
-
-	}
-
-	QString geometry;
-	if ( fullscreen )
-	{
-		geometry=&quot;fullscreen&quot;;
+    QString pack;
+    bool fullscreen;
+    int height;
+    int width;
+    int quality;
+    int speed;
+    bool usekbd;
+    bool setDPI=false;
+    uint dpi=96;
+    QString layout;
+    QString type;
+    QString homeDir=mainWindow-&gt;getHomeDirectory();
+    X2goSettings st( &quot;sessions&quot; );
+
+    QString sid;
+    sid=&quot;embedded&quot;;
+    pack=st.setting()-&gt;value ( sid+&quot;/pack&quot;,
+                               ( QVariant ) &quot;16m-jpeg&quot; ).toString();
+    fullscreen=st.setting()-&gt;value ( sid+&quot;/fullscreen&quot;,
+                                     ( QVariant )
+                                     false ).toBool();
+    height=st.setting()-&gt;value ( sid+&quot;/height&quot;,
+                                 ( QVariant ) 600 ).toInt();
+    width=st.setting()-&gt;value ( sid+&quot;/width&quot;,
+                                ( QVariant ) 800 ).toInt();
+    setDPI=st.setting()-&gt;value ( sid+&quot;/setdpi&quot;,
+                                 ( QVariant ) false ).toBool();
+    dpi=st.setting()-&gt;value ( sid+&quot;/dpi&quot;,
+                              ( QVariant ) 96 ).toUInt();
+    quality=st.setting()-&gt;value (
+                sid+&quot;/quality&quot;,
+                ( QVariant ) 9 ).toInt();
+    speed=st.setting()-&gt;value ( sid+&quot;/speed&quot;,
+                                ( QVariant ) 2 ).toInt();
+    usekbd=st.setting()-&gt;value ( sid+&quot;/usekbd&quot;,
+                                 ( QVariant ) true ).toBool();
+    layout=st.setting()-&gt;value ( sid+&quot;/layout&quot;,
+                                 ( QVariant )
+                                 tr ( &quot;us&quot; ) ).toString();
+    type=st.setting()-&gt;value ( sid+&quot;/type&quot;,
+                               ( QVariant )
+                               tr ( &quot;pc105/us&quot; ) ).toString();
+    bool startEmbedded=false;
+    if ( st.setting()-&gt;value ( sid+&quot;/startembed&quot;,
+                               ( QVariant ) true ).toBool() )
+    {
+        startEmbedded=true;
+        fullscreen=false;
+        QSize sz=mainWindow-&gt;getEmbedAreaSize();
+        height=sz.height();
+        width=sz.width();
+
+    }
+
+    QString geometry;
+    if ( fullscreen )
+    {
+        geometry=&quot;fullscreen&quot;;
 #ifdef Q_OS_WIN
-		fullscreen=false;
+        fullscreen=false;
 #endif
-	}
-	if ( ! fullscreen )
-	{
-		geometry=QString::number ( width ) +&quot;x&quot;+
-		         QString::number ( height );
-
-	}
-	QString link;
-	switch ( speed )
-	{
-		case 0:
-			link=&quot;modem&quot;;
-			break;
-		case 1:
-			link=&quot;isdn&quot;;
-			break;
-		case 2:
-			link=&quot;adsl&quot;;
-			break;
-		case 3:
-			link=&quot;wan&quot;;
-			break;
-		case 4:
-			link=&quot;lan&quot;;
-			break;
-	}
-
-	QFile file ( &quot;:/txt/packs&quot; );
-	file.open ( QIODevice::ReadOnly | QIODevice::Text );
-	QTextStream in ( &amp;file );
-	while ( !in.atEnd() )
-	{
-		QString pc=in.readLine();
-		if ( pc.indexOf ( &quot;-%&quot; ) !=-1 )
-		{
-			pc=pc.left ( pc.indexOf ( &quot;-%&quot; ) );
-			if ( pc==pack )
-			{
-				pack+=&quot;-&quot;+QString::number ( quality );
-				break;
-			}
-		}
-	}
-	file.close();
-
-	QDesktopWidget wd;
-	QString depth=QString::number ( wd.depth() );
+    }
+    if ( ! fullscreen )
+    {
+        geometry=QString::number ( width ) +&quot;x&quot;+
+                 QString::number ( height );
+
+    }
+    QString link;
+    switch ( speed )
+    {
+    case 0:
+        link=&quot;modem&quot;;
+        break;
+    case 1:
+        link=&quot;isdn&quot;;
+        break;
+    case 2:
+        link=&quot;adsl&quot;;
+        break;
+    case 3:
+        link=&quot;wan&quot;;
+        break;
+    case 4:
+        link=&quot;lan&quot;;
+        break;
+    }
+
+    QFile file ( &quot;:/txt/packs&quot; );
+    file.open ( QIODevice::ReadOnly | QIODevice::Text );
+    QTextStream in ( &amp;file );
+    while ( !in.atEnd() )
+    {
+        QString pc=in.readLine();
+        if ( pc.indexOf ( &quot;-%&quot; ) !=-1 )
+        {
+            pc=pc.left ( pc.indexOf ( &quot;-%&quot; ) );
+            if ( pc==pack )
+            {
+                pack+=&quot;-&quot;+QString::number ( quality );
+                break;
+            }
+        }
+    }
+    file.close();
+
+    QDesktopWidget wd;
+    QString depth=QString::number ( wd.depth() );
 #ifdef Q_OS_DARWIN
-	usekbd=0;
-	type=&quot;query&quot;;
+    usekbd=0;
+    type=&quot;query&quot;;
 #endif
-	QString dpiS;
-	if ( setDPI )
-	{
-		dpiS=QString::number ( dpi );
-	}
-	else
-		dpiS=&quot;noset&quot;;
-	QString useKbdS;
-	if ( usekbd )
-		useKbdS=&quot;1&quot;;
-	else
-		useKbdS=&quot;0&quot;;
-
-
-	QString req;
-	QTextStream ( &amp;req ) &lt;&lt;
-	&quot;mode=getsinfo&amp;&quot;&lt;&lt;
-	&quot;geometry=&quot;&lt;&lt;geometry&lt;&lt;&quot;&amp;&quot;
-	&quot;link=&quot;&lt;&lt;link&lt;&lt;&quot;&amp;&quot;
-	&quot;pack=&quot;&lt;&lt;pack&lt;&lt;&quot;&amp;&quot;
-	&quot;depth=&quot;&lt;&lt;depth&lt;&lt;&quot;&amp;&quot;
-	&quot;layout=&quot;&lt;&lt;layout&lt;&lt;&quot;&amp;&quot;
-	&quot;type=&quot;&lt;&lt;type&lt;&lt;&quot;&amp;&quot;
-	&quot;usekbd=&quot;&lt;&lt;useKbdS&lt;&lt;&quot;&amp;&quot;
-	&quot;dpi=&quot;&lt;&lt;dpiS&lt;&lt;&quot;&amp;&quot;
-	&quot;user=&quot;&lt;&lt;config-&gt;user&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-	&quot;connectionts=&quot;&lt;&lt;config-&gt;connectionts&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-	&quot;cookie=&quot;&lt;&lt;config-&gt;cookie;
-	QUrl lurl ( config-&gt;brokerurl );
-	httpSIAnswer.close();
-	httpSIAnswer.setData ( 0,0 );
-	if ( getKey )
-	{
-		QTextStream ( &amp;req ) &lt;&lt;&quot;&amp;&quot;
-		&quot;getkey=true&quot;;
-		sinfoKeyRequest=http-&gt;post ( lurl.path(),
-		                             req.toUtf8(),&amp;httpSIAnswer );
-		x2goDebug&lt;&lt;&quot;requested key :&quot;&lt;&lt;sinfoKeyRequest;
-	}
-	else
-	{
-		sinfoRequest=http-&gt;post ( lurl.path(),
-		                          req.toUtf8(),&amp;httpSIAnswer );
-		x2goDebug&lt;&lt;&quot;requested session :&quot;&lt;&lt;sinfoRequest;
-	}
-	return QString::null;
+    QString dpiS;
+    if ( setDPI )
+    {
+        dpiS=QString::number ( dpi );
+    }
+    else
+        dpiS=&quot;noset&quot;;
+    QString useKbdS;
+    if ( usekbd )
+        useKbdS=&quot;1&quot;;
+    else
+        useKbdS=&quot;0&quot;;
+
+
+    QString req;
+    QTextStream ( &amp;req ) &lt;&lt;
+    &quot;mode=getsinfo&amp;&quot;&lt;&lt;
+    &quot;geometry=&quot;&lt;&lt;geometry&lt;&lt;&quot;&amp;&quot;
+    &quot;link=&quot;&lt;&lt;link&lt;&lt;&quot;&amp;&quot;
+    &quot;pack=&quot;&lt;&lt;pack&lt;&lt;&quot;&amp;&quot;
+    &quot;depth=&quot;&lt;&lt;depth&lt;&lt;&quot;&amp;&quot;
+    &quot;layout=&quot;&lt;&lt;layout&lt;&lt;&quot;&amp;&quot;
+    &quot;type=&quot;&lt;&lt;type&lt;&lt;&quot;&amp;&quot;
+    &quot;usekbd=&quot;&lt;&lt;useKbdS&lt;&lt;&quot;&amp;&quot;
+    &quot;dpi=&quot;&lt;&lt;dpiS&lt;&lt;&quot;&amp;&quot;
+    &quot;user=&quot;&lt;&lt;config-&gt;user&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+    &quot;connectionts=&quot;&lt;&lt;config-&gt;connectionts&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+    &quot;cookie=&quot;&lt;&lt;config-&gt;cookie;
+    QUrl lurl ( config-&gt;brokerurl );
+    httpSIAnswer.close();
+    httpSIAnswer.setData ( 0,0 );
+    if ( getKey )
+    {
+        QTextStream ( &amp;req ) &lt;&lt;&quot;&amp;&quot;
+        &quot;getkey=true&quot;;
+        sinfoKeyRequest=http-&gt;post ( lurl.path(),
+                                     req.toUtf8(),&amp;httpSIAnswer );
+        x2goDebug&lt;&lt;&quot;requested key :&quot;&lt;&lt;sinfoKeyRequest;
+    }
+    else
+    {
+        sinfoRequest=http-&gt;post ( lurl.path(),
+                                  req.toUtf8(),&amp;httpSIAnswer );
+        x2goDebug&lt;&lt;&quot;requested session :&quot;&lt;&lt;sinfoRequest;
+    }
+    return QString::null;
 }
 
 
@@ -220,206 +288,250 @@ void HttpBrokerClient::slotRequestFinished ( int id, bool error )
 {
 //   	x2goDebug&lt;&lt;&quot;http request &quot;&lt;&lt;id&lt;&lt;&quot;, finished with: &quot;&lt;&lt;error;
 
-	if ( error )
-		x2goDebug&lt;&lt;http-&gt;errorString();
-
-// 	QString answer ( httpCmdAnswer.data() );
-// 	x2goDebug&lt;&lt;&quot;cmd request answer: &quot;&lt;&lt;answer;
-
-	if ( id==sinfoKeyRequest || id==sinfoRequest )
-	{
+    if ( error )
+    {
+        x2goDebug&lt;&lt;http-&gt;errorString();
+        QMessageBox::critical(0,tr(&quot;Error&quot;),http-&gt;errorString());
+        emit fatalHttpError();
+        return;
+    }
+
+//  	QString answer ( httpSiAnswer.data() );
+//  	x2goDebug&lt;&lt;&quot;cmd request answer: &quot;&lt;&lt;answer;
+    if ( id== sessionsRequest || id == selSessRequest || id==chPassRequest)
+    {
+        QString answer ( httpSessionAnswer.data() );
+        x2goDebug&lt;&lt;&quot;cmd request answer: &quot;&lt;&lt;answer;
+        if (answer.indexOf(&quot;Access granted&quot;)==-1)
+        {
+            QMessageBox::critical (
+                0,tr ( &quot;Error&quot; ),
+                tr ( &quot;Login failed!&lt;br&gt;&quot;
+                     &quot;Please try again&quot; ) );
+            emit authFailed();
+            return;
+        }
+        config-&gt;brokerAuthenticated=true;
+        if (id == sessionsRequest)
+        {
+            createIniFile(answer);
+            emit sessionsLoaded();
+        }
+        if (id == selSessRequest)
+        {
+            emit getSession(answer);
+        }
+        if ( id == chPassRequest)
+        {
+            if (answer.indexOf(&quot;CHANGING PASS OK&quot;)!=-1)
+            {
+                emit passwordChanged(newBrokerPass);
+            }
+            else
+            {
+                emit passwordChanged(QString::null);
+            }
+
+        }
+    }
+
+    if ( id==sinfoKeyRequest || id==sinfoRequest )
+    {
 // 		x2goDebug&lt;&lt;&quot;Answer:&quot;&lt;&lt;httpSIAnswer.data();
-		QString key ( httpSIAnswer.data() );
-		if ( key.indexOf ( &quot;X2GO_BROKER_ERRORR-ACESS DENIED&quot; ) !=-1 )
-		{
-			QMessageBox::critical (
-			    0,tr ( &quot;Error&quot; ),
-			    tr ( &quot;Your session was disconnected. &quot;
-			         &quot;To get access to your running &quot;
-			         &quot;session, please return to the login page &quot;
-			         &quot;or use the \&quot;reload\&quot; function of &quot;
-			         &quot;your browser.&quot; ) );
-			emit fatalHttpError();
-			return;
-		}
-		QStringList strings=key.split ( &quot;\n&quot; );
-		for ( int i=0;i&lt;strings.count();++i )
-		{
-			if ( strings[i].indexOf ( &quot;x2gosession=&quot; ) !=-1 )
-			{
-				QStringList vals=strings[i].split ( &quot;=&quot; );
-				config-&gt;sessiondata=vals[1];
-			}
-			if ( strings[i]==&quot;rootless=false&quot; )
-			{
-				config-&gt;rootless=false;
-			}
-			if ( strings[i]==&quot;rootless=true&quot; )
-			{
-				config-&gt;rootless=true;
-			}
-		}
-		if ( id==sinfoKeyRequest )
-		{
-			emit haveSshKey ( key );
-			QTimer::singleShot ( 5000, this,
-			                     SLOT ( slotGetConnectionCmd() ) );
-		}
-		else
-			emit haveAgentInfo();
-	}
-	if ( id==cmdRequest )
-	{
-		QString answer ( httpCmdAnswer.data() );
+        QString key ( httpSIAnswer.data() );
+        if ( key.indexOf ( &quot;X2GO_BROKER_ERRORR-ACESS DENIED&quot; ) !=-1 )
+        {
+            QMessageBox::critical (
+                0,tr ( &quot;Error&quot; ),
+                tr ( &quot;Your session was disconnected. &quot;
+                     &quot;To get access to your running &quot;
+                     &quot;session, please return to the login page &quot;
+                     &quot;or use the \&quot;reload\&quot; function of &quot;
+                     &quot;your browser.&quot; ) );
+            emit fatalHttpError();
+            return;
+        }
+        QStringList strings=key.split ( &quot;\n&quot; );
+        for ( int i=0;i&lt;strings.count();++i )
+        {
+            if ( strings[i].indexOf ( &quot;x2gosession=&quot; ) !=-1 )
+            {
+                QStringList vals=strings[i].split ( &quot;=&quot; );
+                config-&gt;sessiondata=vals[1];
+            }
+            if ( strings[i]==&quot;rootless=false&quot; )
+            {
+                config-&gt;rootless=false;
+            }
+            if ( strings[i]==&quot;rootless=true&quot; )
+            {
+                config-&gt;rootless=true;
+            }
+        }
+        if ( id==sinfoKeyRequest )
+        {
+            emit haveSshKey ( key );
+            QTimer::singleShot ( 5000, this,
+                                 SLOT ( slotGetConnectionCmd() ) );
+        }
+        else
+            emit haveAgentInfo();
+    }
+    if ( id==cmdRequest )
+    {
+        QString answer ( httpCmdAnswer.data() );
 //  		x2goDebug&lt;&lt;&quot;cmd request answer: &quot;&lt;&lt;answer;
-		if ( !error )
-		{
-			answer=answer.split (
-			           &quot;&lt;body onload=\&quot;checkPlugin()\&quot;&gt;&quot; ) [1];
-			answer=answer.split ( &quot;&lt;/body&gt;&quot; ) [0];
-			if ( answer.indexOf ( &quot;CMD:0:&quot; ) !=-1 )
-			{
-				x2goDebug&lt;&lt;&quot;brocker sent reconnect cmd&quot;;
-				emit cmdReconnect();
-			}
-		}
-		QTimer::singleShot ( 3000, this,
-		                     SLOT ( slotGetConnectionCmd() ) );
-	}
+        if ( !error )
+        {
+            answer=answer.split (
+                       &quot;&lt;body onload=\&quot;checkPlugin()\&quot;&gt;&quot; ) [1];
+            answer=answer.split ( &quot;&lt;/body&gt;&quot; ) [0];
+            if ( answer.indexOf ( &quot;CMD:0:&quot; ) !=-1 )
+            {
+                x2goDebug&lt;&lt;&quot;brocker sent reconnect cmd&quot;;
+                emit cmdReconnect();
+            }
+        }
+        QTimer::singleShot ( 3000, this,
+                             SLOT ( slotGetConnectionCmd() ) );
+    }
 }
 
 
 void HttpBrokerClient::slotSslErrors ( const QList&lt;QSslError&gt; &amp; errors )
 {
-	QStringList err;
-	QSslCertificate cert;
-	for ( int i=0;i&lt;errors.count();++i )
-	{
-		x2goDebug&lt;&lt;&quot;sslError ,code:&quot;&lt;&lt;errors[i].error() &lt;&lt;&quot;:&quot;;
-		err&lt;&lt;errors[i].errorString();
-		if ( !errors[i].certificate().isNull() )
-			cert=errors[i].certificate();
-	}
-
-
-	QString md5=getHexVal ( cert.digest() );
-	QString fname=md5;
-	fname=fname.replace(&quot;:&quot;,&quot;_&quot;);
-	QUrl lurl ( config-&gt;brokerurl );
-	QString homeDir=QDir::homePath();
-	if ( QFile::exists ( homeDir+&quot;/.x2go/ssl/exceptions/&quot;+
-	                     lurl.host() +&quot;/&quot;+fname ) )
-	{
-		QFile fl ( homeDir+&quot;/.x2go/ssl/exceptions/&quot;+
-		           lurl.host() +&quot;/&quot;+fname );
-		fl.open ( QIODevice::ReadOnly | QIODevice::Text );
-		QSslCertificate mcert ( &amp;fl );
-		if ( mcert==cert )
-		{
-			http-&gt;ignoreSslErrors();
-			return;
-		}
-	}
-
-	QString text=tr ( &quot;&lt;br&gt;&lt;b&gt;Server uses an invalid &quot;
-	                  &quot;security certificate.&lt;/b&gt;&lt;br&gt;&lt;br&gt;&quot; );
-	text+=err.join ( &quot;&lt;br&gt;&quot; );
-	text+=tr ( &quot;&lt;p style='background:#FFFFDC;'&gt;&quot;
-	           &quot;You should not add an exception &quot;
-	           &quot;if you are using an internet connection &quot;
-	           &quot;that you do not trust completely or if you are &quot;
-	           &quot;not used to seeing a warning for this server.&lt;/p&gt;&quot; );
-	QMessageBox mb ( QMessageBox::Warning,tr ( &quot;Secure connection failed&quot; ),
-	                 text );
-	text=QString::null;
-	QTextStream ( &amp;text ) &lt;&lt;err.join ( &quot;\n&quot; ) &lt;&lt;&quot;\n&quot;&lt;&lt;
-	&quot;------------\n&quot;&lt;&lt;
-	tr ( &quot;Issued to:\n&quot; ) &lt;&lt;
-	tr ( &quot;Common Name(CN)\t&quot; ) &lt;&lt;
-	cert.issuerInfo ( QSslCertificate::CommonName )
-	&lt;&lt;endl&lt;&lt;
-	tr ( &quot;Organization(O)\t&quot; ) &lt;&lt;
-	cert.issuerInfo ( QSslCertificate::Organization )
-	&lt;&lt;endl&lt;&lt;
-	tr ( &quot;Organizational Unit(OU)\t&quot; ) &lt;&lt;
-	cert.issuerInfo ( QSslCertificate::OrganizationalUnitName )
-	&lt;&lt;endl&lt;&lt;
-	tr ( &quot;Serial Number\t&quot; ) &lt;&lt;getHexVal ( cert.serialNumber() )
-	&lt;&lt;endl&lt;&lt;endl&lt;&lt;
-	tr ( &quot;Issued by:\n&quot; ) &lt;&lt;
-	tr ( &quot;Common Name(CN)\t&quot; ) &lt;&lt;
-	cert.subjectInfo ( QSslCertificate::CommonName )
-	&lt;&lt;endl&lt;&lt;
-	tr ( &quot;Organization(O)\t&quot; ) &lt;&lt;
-	cert.subjectInfo ( QSslCertificate::Organization )
-	&lt;&lt;endl&lt;&lt;
-	tr ( &quot;Organizational Unit(OU)\t&quot; ) &lt;&lt;
-	cert.subjectInfo ( QSslCertificate::OrganizationalUnitName )
-	&lt;&lt;endl&lt;&lt;endl&lt;&lt;
-
-	tr ( &quot;Validity:\n&quot; ) &lt;&lt;
-	tr ( &quot;Issued on\t&quot; ) &lt;&lt;cert.effectiveDate().toString() &lt;&lt;endl&lt;&lt;
-	tr ( &quot;expires on\t&quot; ) &lt;&lt;cert.expiryDate().toString() &lt;&lt;endl&lt;&lt;endl&lt;&lt;
-	tr ( &quot;Fingerprints:\n&quot; ) &lt;&lt;
-	tr ( &quot;SHA1\t&quot; ) &lt;&lt;
-	getHexVal ( cert.digest ( QCryptographicHash::Sha1 ) ) &lt;&lt;endl&lt;&lt;
-	tr ( &quot;MD5\t&quot; ) &lt;&lt;md5;
-
-
-
-	mb.setDetailedText ( text );
-	mb.setEscapeButton (
-	    ( QAbstractButton* ) mb.addButton ( tr ( &quot;Exit X2Go Client&quot; ),
-	                                        QMessageBox::RejectRole ) );
-	QPushButton *okButton=mb.addButton ( tr ( &quot;Add exception&quot; ),
-	                                     QMessageBox::AcceptRole );
-	mb.setDefaultButton ( okButton );
-
-	mb.exec();
-	if ( mb.clickedButton() == ( QAbstractButton* ) okButton )
-	{
-		x2goDebug&lt;&lt;&quot;accept certificate&quot;;
-		QDir dr;
-		dr.mkpath ( homeDir+&quot;/.x2go/ssl/exceptions/&quot;+lurl.host() +&quot;/&quot; );
-		QFile fl ( homeDir+&quot;/.x2go/ssl/exceptions/&quot;+
-		           lurl.host() +&quot;/&quot;+fname );
-		fl.open ( QIODevice::WriteOnly | QIODevice::Text );
-		QTextStream ( &amp;fl ) &lt;&lt;cert.toPem();
-		fl.close();
-		http-&gt;ignoreSslErrors();
-	}
-	else
-		emit fatalHttpError();
+    QStringList err;
+    QSslCertificate cert;
+    for ( int i=0;i&lt;errors.count();++i )
+    {
+        x2goDebug&lt;&lt;&quot;sslError ,code:&quot;&lt;&lt;errors[i].error() &lt;&lt;&quot;:&quot;;
+        err&lt;&lt;errors[i].errorString();
+        if ( !errors[i].certificate().isNull() )
+            cert=errors[i].certificate();
+    }
+
+
+    QString md5=getHexVal ( cert.digest() );
+    QString fname=md5;
+    fname=fname.replace(&quot;:&quot;,&quot;_&quot;);
+    QUrl lurl ( config-&gt;brokerurl );
+    QString homeDir=mainWindow-&gt;getHomeDirectory();
+    if ( QFile::exists ( homeDir+&quot;/ssl/exceptions/&quot;+
+                         lurl.host() +&quot;/&quot;+fname ) )
+    {
+        QFile fl ( homeDir+&quot;/ssl/exceptions/&quot;+
+                   lurl.host() +&quot;/&quot;+fname );
+        fl.open ( QIODevice::ReadOnly | QIODevice::Text );
+        QSslCertificate mcert ( &amp;fl );
+        if ( mcert==cert )
+        {
+            http-&gt;ignoreSslErrors();
+            return;
+        }
+    }
+
+    QString text=tr ( &quot;&lt;br&gt;&lt;b&gt;Server uses an invalid &quot;
+                      &quot;security certificate.&lt;/b&gt;&lt;br&gt;&lt;br&gt;&quot; );
+    text+=err.join ( &quot;&lt;br&gt;&quot; );
+    text+=tr ( &quot;&lt;p style='background:#FFFFDC;'&gt;&quot;
+               &quot;You should not add an exception &quot;
+               &quot;if you are using an internet connection &quot;
+               &quot;that you do not trust completely or if you are &quot;
+               &quot;not used to seeing a warning for this server.&lt;/p&gt;&quot; );
+    QMessageBox mb ( QMessageBox::Warning,tr ( &quot;Secure connection failed&quot; ),
+                     text );
+    text=QString::null;
+    QTextStream ( &amp;text ) &lt;&lt;err.join ( &quot;\n&quot; ) &lt;&lt;&quot;\n&quot;&lt;&lt;
+    &quot;------------\n&quot;&lt;&lt;
+    tr ( &quot;Issued to:\n&quot; ) &lt;&lt;
+    tr ( &quot;Common Name(CN)\t&quot; ) &lt;&lt;
+    cert.issuerInfo ( QSslCertificate::CommonName )
+    &lt;&lt;endl&lt;&lt;
+    tr ( &quot;Organization(O)\t&quot; ) &lt;&lt;
+    cert.issuerInfo ( QSslCertificate::Organization )
+    &lt;&lt;endl&lt;&lt;
+    tr ( &quot;Organizational Unit(OU)\t&quot; ) &lt;&lt;
+    cert.issuerInfo ( QSslCertificate::OrganizationalUnitName )
+    &lt;&lt;endl&lt;&lt;
+    tr ( &quot;Serial Number\t&quot; ) &lt;&lt;getHexVal ( cert.serialNumber() )
+    &lt;&lt;endl&lt;&lt;endl&lt;&lt;
+    tr ( &quot;Issued by:\n&quot; ) &lt;&lt;
+    tr ( &quot;Common Name(CN)\t&quot; ) &lt;&lt;
+    cert.subjectInfo ( QSslCertificate::CommonName )
+    &lt;&lt;endl&lt;&lt;
+    tr ( &quot;Organization(O)\t&quot; ) &lt;&lt;
+    cert.subjectInfo ( QSslCertificate::Organization )
+    &lt;&lt;endl&lt;&lt;
+    tr ( &quot;Organizational Unit(OU)\t&quot; ) &lt;&lt;
+    cert.subjectInfo ( QSslCertificate::OrganizationalUnitName )
+    &lt;&lt;endl&lt;&lt;endl&lt;&lt;
+
+    tr ( &quot;Validity:\n&quot; ) &lt;&lt;
+    tr ( &quot;Issued on\t&quot; ) &lt;&lt;cert.effectiveDate().toString() &lt;&lt;endl&lt;&lt;
+    tr ( &quot;expires on\t&quot; ) &lt;&lt;cert.expiryDate().toString() &lt;&lt;endl&lt;&lt;endl&lt;&lt;
+    tr ( &quot;Fingerprints:\n&quot; ) &lt;&lt;
+    tr ( &quot;SHA1\t&quot; ) &lt;&lt;
+    getHexVal ( cert.digest ( QCryptographicHash::Sha1 ) ) &lt;&lt;endl&lt;&lt;
+    tr ( &quot;MD5\t&quot; ) &lt;&lt;md5;
+
+
+
+    mb.setDetailedText ( text );
+    mb.setEscapeButton (
+        ( QAbstractButton* ) mb.addButton ( tr ( &quot;Exit X2Go Client&quot; ),
+                                            QMessageBox::RejectRole ) );
+    QPushButton *okButton=mb.addButton ( tr ( &quot;Add exception&quot; ),
+                                         QMessageBox::AcceptRole );
+    mb.setDefaultButton ( okButton );
+
+    mb.exec();
+    if ( mb.clickedButton() == ( QAbstractButton* ) okButton )
+    {
+        x2goDebug&lt;&lt;&quot;accept certificate&quot;;
+        QDir dr;
+        dr.mkpath ( homeDir+&quot;/ssl/exceptions/&quot;+lurl.host() +&quot;/&quot; );
+        QFile fl ( homeDir+&quot;/ssl/exceptions/&quot;+
+                   lurl.host() +&quot;/&quot;+fname );
+        fl.open ( QIODevice::WriteOnly | QIODevice::Text );
+        QTextStream ( &amp;fl ) &lt;&lt;cert.toPem();
+        fl.close();
+        http-&gt;ignoreSslErrors();
+        x2goDebug&lt;&lt;&quot;store certificate in  &quot;&lt;&lt;homeDir+&quot;/ssl/exceptions/&quot;+
+                   lurl.host() +&quot;/&quot;+fname;
+
+    }
+    else
+        emit fatalHttpError();
 }
 
 
 QString HttpBrokerClient::getHexVal ( const QByteArray&amp; ba )
 {
-	QStringList val;
-	for ( int i=0;i&lt;ba.size();++i )
-	{
-		QString bt;
-		bt.sprintf ( &quot;%02X&quot;, ( unsigned char ) ba[i] );
-		val&lt;&lt;bt;
-	}
-	return val.join ( &quot;:&quot; );
+    QStringList val;
+    for ( int i=0;i&lt;ba.size();++i )
+    {
+        QString bt;
+        bt.sprintf ( &quot;%02X&quot;, ( unsigned char ) ba[i] );
+        val&lt;&lt;bt;
+    }
+    return val.join ( &quot;:&quot; );
 }
 
 
 void HttpBrokerClient::slotGetConnectionCmd()
 {
-	QString req;
-	QTextStream ( &amp;req ) &lt;&lt;
-	&quot;mode=getcmd&amp;&quot;&lt;&lt;
-	&quot;user=&quot;&lt;&lt;config-&gt;user&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-	&quot;connectionts=&quot;&lt;&lt;config-&gt;connectionts&lt;&lt;&quot;&amp;&quot;&lt;&lt;
-	&quot;cookie=&quot;&lt;&lt;config-&gt;cookie;
-
-	QUrl lurl ( config-&gt;brokerurl );
-	httpCmdAnswer.close();
-	httpCmdAnswer.setData ( 0,0 );
-
-	cmdRequest=http-&gt;post ( lurl.path(),
-	                        req.toUtf8(),&amp;httpCmdAnswer );
+    QString req;
+    QTextStream ( &amp;req ) &lt;&lt;
+    &quot;mode=getcmd&amp;&quot;&lt;&lt;
+    &quot;user=&quot;&lt;&lt;config-&gt;user&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+    &quot;connectionts=&quot;&lt;&lt;config-&gt;connectionts&lt;&lt;&quot;&amp;&quot;&lt;&lt;
+    &quot;cookie=&quot;&lt;&lt;config-&gt;cookie;
+
+    QUrl lurl ( config-&gt;brokerurl );
+    httpCmdAnswer.close();
+    httpCmdAnswer.setData ( 0,0 );
+
+    cmdRequest=http-&gt;post ( lurl.path(),
+                            req.toUtf8(),&amp;httpCmdAnswer );
 // 	x2goDebug&lt;&lt;&quot;requested brocker cmd :&quot;&lt;&lt;cmdRequest;
 }
diff --git a/httpbrokerclient.h b/httpbrokerclient.h
index 628817b..43d65e5 100644
--- a/httpbrokerclient.h
+++ b/httpbrokerclient.h
@@ -24,31 +24,46 @@ class ONMainWindow;
 
 class HttpBrokerClient: public QObject
 {
-		Q_OBJECT
-	public:
-		HttpBrokerClient ( ONMainWindow* wnd, ConfigFile* cfg );
-		~HttpBrokerClient();
-		QString getSInfoFromBroker ( bool getKey=false );
-	private:
-		QBuffer httpSIAnswer;
-		QBuffer httpCmdAnswer;
-		QHttp* http;
-		int sinfoRequest;
-		int sinfoKeyRequest;
-		int cmdRequest;
-		ConfigFile* config;
-		ONMainWindow* mainWindow;
+    Q_OBJECT
+public:
+    HttpBrokerClient ( ONMainWindow* wnd, ConfigFile* cfg );
+    ~HttpBrokerClient();
+    QString getSInfoFromBroker ( bool getKey=false );
+    void selectUserSession(const QString&amp; session );
+    void changePassword(QString newPass);
+private:
+    QBuffer httpSIAnswer;
+    QBuffer httpCmdAnswer;
+    QBuffer httpSessionAnswer;
+    QHttp* http;
+    int sinfoRequest;
+    int sinfoKeyRequest;
+    int sessionsRequest;
+    int selSessRequest;
+    int cmdRequest;
+    int chPassRequest;
+    QString newBrokerPass;
+    ConfigFile* config;
+    ONMainWindow* mainWindow;
+    void createIniFile(const QString&amp; content);
 
-	private slots:
-		void slotRequestFinished ( int id, bool error );
-		void slotSslErrors ( const QList&lt;QSslError&gt; &amp; errors ) ;
-		QString getHexVal ( const QByteArray&amp; ba );
-		void slotGetConnectionCmd();
-	signals:
-		void haveSshKey ( QString );
-		void fatalHttpError();
-		void haveAgentInfo ();
-		void cmdReconnect ();
+private slots:
+    void slotRequestFinished ( int id, bool error );
+    void slotSslErrors ( const QList&lt;QSslError&gt; &amp; errors ) ;
+    QString getHexVal ( const QByteArray&amp; ba );
+    void slotGetConnectionCmd();
+public slots:
+    void getUserSessions();
+
+signals:
+    void haveSshKey ( QString );
+    void fatalHttpError();
+    void haveAgentInfo ();
+    void cmdReconnect ();
+    void authFailed();
+    void sessionsLoaded();
+    void getSession( QString );
+    void passwordChanged( QString );
 };
 
 #endif
diff --git a/icons/32x32/auth.png b/icons/32x32/auth.png
new file mode 100644
index 0000000..e334fb6
Binary files /dev/null and b/icons/32x32/auth.png differ
diff --git a/object_script.x2goclient.Debug b/object_script.x2goclient.Debug
index 6a32207..8c972be 100644
--- a/object_script.x2goclient.Debug
+++ b/object_script.x2goclient.Debug
@@ -32,6 +32,7 @@ INPUT(
 ./debug\httpbrokerclient.o
 ./debug\ongetpass.o
 ./debug\x2gosettings.o
+./debug\brokerpassdlg.o
 ./debug\xsettingswidget.o
 ./debug\x2goclient.o
 ./debug\moc_configdialog.o
@@ -57,6 +58,7 @@ INPUT(
 ./debug\moc_sharewidget.o
 ./debug\moc_clicklineedit.o
 ./debug\moc_httpbrokerclient.o
+./debug\moc_brokerpassdlg.o
 ./debug\moc_xsettingswidget.o
 ./debug\qrc_resources.o
 );
diff --git a/object_script.x2goclient.Release b/object_script.x2goclient.Release
index 0b6487e..74e0753 100644
--- a/object_script.x2goclient.Release
+++ b/object_script.x2goclient.Release
@@ -32,6 +32,7 @@ INPUT(
 ./release\httpbrokerclient.o
 ./release\ongetpass.o
 ./release\x2gosettings.o
+./release\brokerpassdlg.o
 ./release\xsettingswidget.o
 ./release\x2goclient.o
 ./release\moc_configdialog.o
@@ -57,6 +58,7 @@ INPUT(
 ./release\moc_sharewidget.o
 ./release\moc_clicklineedit.o
 ./release\moc_httpbrokerclient.o
+./release\moc_brokerpassdlg.o
 ./release\moc_xsettingswidget.o
 ./release\qrc_resources.o
 );
diff --git a/onmainwindow.cpp b/onmainwindow.cpp
index 7b08939..033aacc 100644
--- a/onmainwindow.cpp
+++ b/onmainwindow.cpp
@@ -48,6 +48,7 @@ ONMainWindow::ONMainWindow ( QWidget *parent ) :QMainWindow ( parent )
     x2goDebug&lt;&lt;&quot;ONMainWindow constructor&quot;&lt;&lt;endl;
     setFocusPolicy ( Qt::StrongFocus );
     installTranslator();
+    cleanAllFiles=false;
     drawMenu=true;
     usePGPCard=false;
     extLogin=false;
@@ -82,11 +83,14 @@ ONMainWindow::ONMainWindow ( QWidget *parent ) :QMainWindow ( parent )
     defaultSshPort=sshPort=clientSshPort=&quot;22&quot;;
     LDAPPrintSupport=false;
     managedMode=false;
+    brokerMode=false;
     sshProxy.use=false;
     startEmbedded=false;
     sshConnection=0;
     sessionStatusDlg=0;
     noSessionEdit=false;
+    lastSession=0l;
+    changeBrokerPass=false;
 
 #ifdef Q_OS_WIN
     clientSshPort=&quot;7022&quot;;
@@ -183,11 +187,17 @@ ONMainWindow::ONMainWindow ( QWidget *parent ) :QMainWindow ( parent )
     embedMode=true;
 #endif
 
+
+
+//set homedir as portable,etc
+
+
 #ifdef Q_OS_WIN
-    portableDataPath=u3DataPath();
+    QString u3Path=u3DataPath();
 //we have U3 System
-    if ( portableDataPath.length() &gt;0 )
+    if ( u3Path.length() &gt;0 )
     {
+        portableDataPath=u3Path;
         ONMainWindow::portable=true;
         setWindowTitle ( &quot;X2Go client - U3&quot; );
     }
@@ -201,6 +211,9 @@ ONMainWindow::ONMainWindow ( QWidget *parent ) :QMainWindow ( parent )
         homeDir=portableDataPath;
         x2goDebug&lt;&lt;&quot;running in \&quot;portable\&quot; mode\n&quot;&lt;&lt;
         &quot;Data Dir is &quot;&lt;&lt;portableDataPath;
+	QTimer *timer = new QTimer(this);
+        connect(timer, SIGNAL(timeout()), this, SLOT(slotCheckPortableDir()));
+        timer-&gt;start(1000);
     }
 
     loadSettings();
@@ -252,7 +265,10 @@ ONMainWindow::ONMainWindow ( QWidget *parent ) :QMainWindow ( parent )
 
 
 #ifndef Q_WS_HILDON
-    bgFrame=new SVGFrame ( ( QString ) &quot;:/svg/bg.svg&quot;,true,fr );
+    if(BGFile.size())
+       bgFrame=new SVGFrame ( ( QString ) BGFile,true,fr );
+    else
+       bgFrame=new SVGFrame ( ( QString ) &quot;:/svg/bg.svg&quot;,true,fr );
 #else
     bgFrame=new SVGFrame ( ( QString ) &quot;:/svg/bg_hildon.svg&quot;,true,fr );
 #endif
@@ -291,7 +307,7 @@ ONMainWindow::ONMainWindow ( QWidget *parent ) :QMainWindow ( parent )
     x2golay-&gt;addWidget ( x2g );
 
 
-    QHBoxLayout* bgLay=new QHBoxLayout ( bgFrame );
+    bgLay=new QHBoxLayout ( bgFrame );
     bgLay-&gt;setSpacing ( 0 );
     bgLay-&gt;setMargin ( 0 );
     bgLay-&gt;addLayout ( onlay );
@@ -307,9 +323,19 @@ ONMainWindow::ONMainWindow ( QWidget *parent ) :QMainWindow ( parent )
     act_set=new QAction (
         QIcon ( iconsPath ( &quot;/32x32/edit_settings.png&quot; ) ),
         tr ( &quot;&amp;Settings ...&quot; ),this );
-
+	
+    if(supportMenuFile!=QString::null)
+    {
+        act_support=new QAction ( tr ( &quot;Support ...&quot; ),this );
+        connect ( act_support,SIGNAL ( triggered ( bool ) ),this,
+              SLOT ( slotSupport() ) );
+      
+    }
+    
     act_abclient=new QAction ( QIcon ( &quot;:icons/32x32/x2goclient.png&quot; ),
                                tr ( &quot;About X2GO client&quot; ),this );
+			       
+
 
 
 
@@ -324,7 +350,7 @@ ONMainWindow::ONMainWindow ( QWidget *parent ) :QMainWindow ( parent )
 #endif
 
 
-#if defined (Q_OS_WIN) &amp;&amp; defined (CFGCLIENT )
+#if defined (Q_OS_WIN) //&amp;&amp; defined (CFGCLIENT )
     xorgSettings();
 #endif
 
@@ -359,7 +385,27 @@ ONMainWindow::ONMainWindow ( QWidget *parent ) :QMainWindow ( parent )
     connect ( fr,SIGNAL ( resized ( const QSize ) ),this,
               SLOT ( slotResize ( const QSize ) ) );
     slotResize ( fr-&gt;size() );
-    x2goDebug&lt;&lt;&quot;ONMainWindows constructor finished&quot;&lt;&lt;endl;
+    
+    if(brokerMode)
+    {
+          broker=new HttpBrokerClient ( this, &amp;config );
+    connect ( broker,SIGNAL ( haveSshKey ( QString ) ),this,
+              SLOT ( slotStartSshAgent ( QString ) ) );
+    connect ( broker,SIGNAL ( haveAgentInfo () ),this,
+              SLOT ( slotStartNewBrokerSession () ) );
+    connect ( broker,SIGNAL ( fatalHttpError() ),this,
+              SLOT ( close() ) );
+    connect ( broker,SIGNAL ( cmdReconnect() ),this,
+              SLOT ( slotReconnectSession() ) );
+    connect ( broker, SIGNAL ( authFailed()), this ,SLOT ( slotGetBrokerAuth()));
+    connect ( broker, SIGNAL( sessionsLoaded()), this, SLOT (slotReadSessions()));
+    connect ( broker, SIGNAL ( getSession(QString)), this, SLOT (slotGetBrokerSession(QString))); 
+    connect ( broker, SIGNAL ( passwordChanged(QString)), this, SLOT ( slotPassChanged(QString)));
+    
+
+    }
+    
+    x2goDebug&lt;&lt;&quot;ONMainWindows constructor finished, home Directory is:&quot;&lt;&lt;homeDir&lt;&lt;endl;
 }
 
 
@@ -375,8 +421,6 @@ ONMainWindow::~ONMainWindow()
 
 
 
-
-
 void ONMainWindow::installTranslator()
 {
     QTranslator* x2goclientTranslator=new QTranslator();
@@ -630,6 +674,19 @@ void ONMainWindow::initWidgetsNormal()
         QIcon ( iconsPath ( &quot;/32x32/create_file.png&quot; ) ),
         tr ( &quot;&amp;Create session icon on desktop...&quot; ),
         this );
+    if(brokerMode)
+      act_sessicon-&gt;setEnabled(false);
+    
+    if(changeBrokerPass)
+    {
+      act_changeBrokerPass=new QAction (
+        QIcon ( iconsPath ( &quot;/32x32/auth.png&quot; ) ),
+        tr ( &quot;&amp;Set broker password...&quot; ),
+        this );
+      connect ( act_changeBrokerPass,SIGNAL ( triggered(bool)),this,
+              SLOT ( slotChangeBrokerPass()) );
+	      act_changeBrokerPass-&gt;setEnabled(false);
+    }
 
 
     QAction *act_tb=new QAction ( tr ( &quot;Show toolbar&quot; ),this );
@@ -652,6 +709,7 @@ void ONMainWindow::initWidgetsNormal()
               SLOT ( trayQuit()) ) ;
     connect ( act_tb,SIGNAL ( toggled ( bool ) ),this,
               SLOT ( displayToolBar ( bool ) ) );
+	      
     stb=addToolBar ( tr ( &quot;Show toolbar&quot; ) );
 
     QShortcut* ex=new QShortcut ( QKeySequence ( tr ( &quot;Ctrl+Q&quot;,&quot;exit&quot; ) ),
@@ -662,7 +720,8 @@ void ONMainWindow::initWidgetsNormal()
     {
         QMenu* menu_sess=menuBar()-&gt;addMenu ( tr ( &quot;&amp;Session&quot; ) );
         QMenu* menu_opts=menuBar()-&gt;addMenu ( tr ( &quot;&amp;Options&quot; ) );
-
+        if(!brokerMode)
+        {
         menu_sess-&gt;addAction ( act_new );
         menu_sess-&gt;addAction ( act_edit );
 #if (!defined Q_WS_HILDON) &amp;&amp; (!defined Q_OS_DARWIN)
@@ -670,14 +729,21 @@ void ONMainWindow::initWidgetsNormal()
             menu_sess-&gt;addAction ( act_sessicon );
 #endif
         menu_sess-&gt;addSeparator();
+	}
         menu_sess-&gt;addAction ( act_exit );
         menu_opts-&gt;addAction ( act_set );
         menu_opts-&gt;addAction ( act_tb );
+	if(changeBrokerPass)
+	  menu_opts-&gt;addAction(act_changeBrokerPass);
 
         QMenu* menu_help=menuBar()-&gt;addMenu ( tr ( &quot;&amp;Help&quot; ) );
+	if(supportMenuFile!=QString::null)
+	    menu_help-&gt;addAction ( act_support );
         menu_help-&gt;addAction ( act_abclient );
         menu_help-&gt;addAction ( act_abqt );
 
+        if(!brokerMode)
+	{
         stb-&gt;addAction ( act_new );
         stb-&gt;addAction ( act_edit );
 #if (!defined Q_WS_HILDON) &amp;&amp; (!defined Q_OS_DARWIN)
@@ -685,7 +751,10 @@ void ONMainWindow::initWidgetsNormal()
             stb-&gt;addAction ( act_sessicon );
 #endif
         stb-&gt;addSeparator();
+	}
         stb-&gt;addAction ( act_set );
+	if(changeBrokerPass)
+	  stb-&gt;addAction(act_changeBrokerPass);
 
         if ( !showToolBar )
             stb-&gt;hide();
@@ -708,7 +777,14 @@ void ONMainWindow::initWidgetsNormal()
         QTimer::singleShot ( 1500, this, SLOT ( readUsers() ) );
     }
     else
+    {
+      if(!brokerMode)
         QTimer::singleShot ( 1, this, SLOT ( slotReadSessions() ) );
+      else
+      {
+	QTimer::singleShot(1, this,SLOT(slotGetBrokerAuth()));
+      }
+    }
     QTimer* t=new QTimer ( this );
     connect ( t,SIGNAL ( timeout() ),this,SLOT ( slotRereadUsers() ) );
     t-&gt;start ( 20000 );
@@ -721,6 +797,95 @@ void ONMainWindow::initWidgetsNormal()
 }
 
 
+
+void ONMainWindow::slotPassChanged(const QString&amp; result)
+{
+  
+  if(result==QString::null)
+  {
+    QMessageBox::critical(this, tr(&quot;Error&quot;),tr(&quot;Operation failed&quot;));
+  }
+  else
+  {    
+    QMessageBox::information(this, tr(&quot;Password changed&quot;),tr(&quot;Password changed&quot;));
+    config.brokerPass=result;
+  }
+  setEnabled(true);
+  
+  slotClosePass();
+  sessionStatusDlg-&gt;hide();
+  
+}
+
+
+void ONMainWindow::slotChangeBrokerPass()
+{
+  x2goDebug&lt;&lt;&quot;change broker pass&quot;;
+  BrokerPassDlg passDlg;
+  if(passDlg.exec()!=QDialog::Accepted)
+    return;
+  if(passDlg.oldPass()!=config.brokerPass)
+  {
+    QMessageBox::critical(this,tr(&quot;Error&quot;),tr(&quot;Wrong password!&quot;));
+    return;
+  }
+  broker-&gt;changePassword(passDlg.newPass());
+  setStatStatus ( tr ( &quot;Connecting to broker&quot; ) );
+  stInfo-&gt;insertPlainText ( &quot;broker url: &quot;+config.brokerurl );
+  setEnabled ( false );
+  uname-&gt;hide();
+  u-&gt;hide();
+  return;  
+}
+
+
+void ONMainWindow::slotCheckPortableDir()
+{
+  if(!QFile::exists(homeDir))
+  {
+    x2goDebug&lt;&lt;&quot;portable dir not exists, close&quot;;
+    close();
+  }
+}
+
+void ONMainWindow::slotGetBrokerAuth()
+{
+        pass-&gt;clear();
+	login-&gt;clear();
+	QString pixFile=&quot;:icons/128x128/x2gosession.png&quot;;
+	if(SPixFile!=QString::null)
+	  pixFile=SPixFile;
+	QPixmap pix(pixFile);
+	if ( !miniMode )
+        {
+	  fotoLabel-&gt;setPixmap (
+          pix.scaled ( 64,64,
+                         Qt::IgnoreAspectRatio,
+                         Qt::SmoothTransformation ) );
+          fotoLabel-&gt;setFixedSize ( 64,64 );
+        }
+        else
+        {
+           fotoLabel-&gt;setPixmap (
+               pix.scaled ( 48,48,
+                         Qt::IgnoreAspectRatio,
+                         Qt::SmoothTransformation ) );
+           fotoLabel-&gt;setFixedSize ( 48,48 );
+         }
+         users-&gt;hide();
+	 ln-&gt;hide();
+	 bgLay-&gt;insertStretch(3);
+         QString text=tr(&quot;&lt;b&gt;Authentication&lt;/b&gt;&quot;);
+	/* if(config.brokerName.length()&gt;0)
+	   text+=config.brokerName;
+	 else
+	   text+=config.brokerurl;*/
+         nameLabel-&gt;setText ( text );
+	 slotShowPassForm();
+	 config.brokerAuthenticated=false;
+}
+
+
 void ONMainWindow::trayIconInit()
 {
 
@@ -1241,6 +1406,11 @@ void ONMainWindow::slotSelectedFromList ( UserButton* user )
 
 void ONMainWindow::slotClosePass()
 {
+    if(brokerMode)
+    {
+      if(!config.brokerAuthenticated)
+	close();
+    }
     passForm-&gt;hide();
     if ( !embedMode )
     {
@@ -1256,8 +1426,11 @@ void ONMainWindow::slotClosePass()
         }
         else
         {
+	  if(lastSession)
+	  {
             lastSession-&gt;show();
             uname-&gt;setText ( lastSession-&gt;name() );
+	  }
         }
         uname-&gt;setEnabled ( true );
         u-&gt;setEnabled ( true );
@@ -1270,6 +1443,7 @@ void ONMainWindow::slotClosePass()
 
 void ONMainWindow::slotPassEnter()
 {
+      
     shadowSession=false;
 #if defined ( Q_OS_WIN ) || defined (Q_OS_DARWIN )
     QString disp=getXDisplay();
@@ -1664,7 +1838,6 @@ void ONMainWindow::slotCreateDesktopIcon ( SessionButton* bt )
     QSettings xst ( &quot;HKEY_LOCAL_MACHINE\\SOFTWARE\\x2goclient&quot;,
                     QSettings::NativeFormat );
     QString workDir=xst.value ( &quot;Default&quot; ).toString();
-    workDir+=&quot;\\bin&quot;;
     QString progname=workDir+&quot;\\x2goclient.exe&quot;;
     QString args=&quot;--sessionid=&quot;+bt-&gt;id();
     if ( crHidden )
@@ -1691,11 +1864,45 @@ void ONMainWindow::slotCreateDesktopIcon ( SessionButton* bt )
 
 void ONMainWindow::slotReadSessions()
 {
-    X2goSettings st ( &quot;sessions&quot; );
+  
+    users-&gt;show();
+    ln-&gt;show();
 
-    QStringList slst=st.setting()-&gt;childGroups();
-    for ( int i=0;i&lt;slst.size();++i )
+    X2goSettings *st;
+    lastSession=0;
+    
+    if(brokerMode)
+    {
+      if(changeBrokerPass)
+	act_changeBrokerPass-&gt;setEnabled(true);
+      config.key=QString::null;
+      config.user=QString::null;
+      config.sessiondata=QString::null;
+      for (int i=sessions.count()-1;i&gt;=0;--i)
+      {
+        SessionButton* but=sessions.takeAt(i);
+	if(but)
+	   delete but;
+      }
+      
+      st=new X2goSettings(config.iniFile,QSettings::IniFormat);
+          sessionStatusDlg-&gt;hide();
+          selectSessionDlg-&gt;hide();
+          setEnabled ( true );
+	  slotClosePass();
+    }
+    else
+      st= new X2goSettings( &quot;sessions&quot; );
+
+    QStringList slst=st-&gt;setting()-&gt;childGroups();
+    x2goDebug&lt;&lt;&quot;read &quot;&lt;&lt;slst.size()&lt;&lt;&quot; sessions from config file&quot;;
+    if(brokerMode &amp;&amp; (slst.size()==0))
     {
+      QMessageBox::critical(this,tr(&quot;Error&quot;),tr(&quot;X2Go sessions not found&quot;));
+      close();
+    }
+    for ( int i=0;i&lt;slst.size();++i )
+    {      
         if ( slst[i]!=&quot;embedded&quot; )
             createBut ( slst[i] );
     }
@@ -1757,6 +1964,7 @@ void ONMainWindow::slotReadSessions()
             raise();
         }
     }
+    delete st;
 }
 
 
@@ -1814,6 +2022,9 @@ void ONMainWindow::placeButtons()
         else
             sessions[i]-&gt;move ( ( users-&gt;width()-260 ) /2,
                                 i*155+i*20+5 );
+	if(brokerMode)
+            sessions[i]-&gt;move ( ( users-&gt;width()-360 ) /2,
+                                i*150+i*25+5 );
         sessions[i]-&gt;show();
     }
     if ( sessions.size() )
@@ -1824,6 +2035,9 @@ void ONMainWindow::placeButtons()
         else
             uframe-&gt;setFixedHeight (
                 sessions.size() *155+ ( sessions.size()-1 ) *20 );
+	if(brokerMode)
+            uframe-&gt;setFixedHeight (
+                sessions.size() *150+ ( sessions.size()-1 ) *25 );
     }
 
 }
@@ -2118,6 +2332,16 @@ void ONMainWindow::slotSelectedFromList ( SessionButton* session )
         sessionName=session-&gt;name();
 
         QString sid=session-&gt;id();
+        if(brokerMode)
+        {
+           broker-&gt;selectUserSession(session-&gt;id());
+           setStatStatus ( tr ( &quot;Connecting to broker&quot; ) );
+           stInfo-&gt;insertPlainText ( &quot;broker url: &quot;+config.brokerurl );
+           setEnabled ( false );
+	   uname-&gt;hide();
+	   u-&gt;hide();
+           return;
+        }
 
         X2goSettings st ( &quot;sessions&quot; );
 
diff --git a/onmainwindow.h b/onmainwindow.h
index a1ea247..0f7d892 100644
--- a/onmainwindow.h
+++ b/onmainwindow.h
@@ -1,3 +1,4 @@
+
 /***************************************************************************
  *   Copyright (C) 2005-2011 by Oleksandr Shneyder   *
  *   <A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>   *
@@ -54,6 +55,7 @@
 #if defined(CFGPLUGIN) &amp;&amp; defined(Q_OS_LINUX)
 class QX11EmbedContainer;
 #endif
+class QTemporaryFile;
 class QLineEdit;
 class QFrame;
 class QVBoxLayout;
@@ -138,6 +140,12 @@ struct ConfigFile
 {
     QString session;
     QString user;
+    QString brokerUser;
+    QString brokerPass;
+    QString brokerUserId;
+    QString brokerName;
+    bool brokerAuthenticated;
+    QString iniFile; 
     QString server;
     QString sshport;
     QString proxy;
@@ -215,6 +223,7 @@ class ONMainWindow : public QMainWindow
 #endif
 {
     friend class HttpBrokerClient;
+    friend class SessionButton;
 #ifdef CFGPLUGIN
     Q_PROPERTY ( QString x2goconfig READ x2goconfig WRITE setX2goconfig )
     Q_CLASSINFO ( &quot;ClassID&quot;, &quot;{5a20006d-118f-4185-9653-9f98958a0008}&quot; )
@@ -455,6 +464,8 @@ private:
     bool usePGPCard;
     bool miniMode;
     bool managedMode;
+    bool brokerMode;
+    bool changeBrokerPass;
     bool embedMode;
     QString statusString;
     int defaultLink;
@@ -468,6 +479,7 @@ private:
     bool printSupport;
     bool showTbTooltip;
     bool noSessionEdit;
+    bool cleanAllFiles;
     struct SshProxy sshProxy;
     QString sshPort;
     QString clientSshPort;
@@ -542,6 +554,7 @@ private:
     QScrollArea* users;
     QVBoxLayout* userl;
     QHBoxLayout* mainL;
+    QHBoxLayout* bgLay;
     QList&lt;UserButton*&gt; names;
     QList&lt;SessionButton*&gt; sessions;
     UserButton* lastUser;
@@ -569,12 +582,14 @@ private:
 
     QAction *act_set;
     QAction *act_abclient;
+    QAction *act_support;
     QAction *act_shareFolder;
     QAction *act_suspend;
     QAction *act_terminate;
     QAction *act_reconnect;
     QAction *act_embedContol;
     QAction *act_embedToolBar;
+    QAction *act_changeBrokerPass;
 
     QToolBar *stb;
 
@@ -620,6 +635,10 @@ private:
     int ldapPort2;
     QString ldapDn;
     QString sessionCmd;
+    
+    QString supportMenuFile;
+    QString BGFile;
+    QString SPixFile;
 
     QString LDAPSndSys;
     QString LDAPSndPort;
@@ -684,11 +703,11 @@ private:
     HttpBrokerClient* broker;
 
 
-#if defined ( Q_OS_WIN) &amp;&amp; defined (CFGCLIENT )
+#if defined ( Q_OS_WIN) //&amp;&amp; defined (CFGCLIENT )
     void xorgSettings();
     bool startXorgOnStart;
-    bool useXming;
-    int xorgDelay;
+    bool useInternalX;
+    enum {VCXSRV, XMING} internalX;
     QString xorgExe;
     QString xorgOptions;
     QString xorgWinOptions;
@@ -697,6 +716,7 @@ private:
     enum {WIN,FS,SAPP} xorgMode;
     QString xorgWidth;
     QString xorgHeight;
+    int waitingForX;
 #endif
 
     // Tray icon stuff based on patch from Joachim Langenbach &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">joachim at falaba.de</A>&gt;
@@ -764,13 +784,17 @@ private slots:
     void slotSetWinServersReady();
     void startWinServers();
     void slotCheckXOrgLog();
+    void slotCheckXOrgConnection();
 #endif
 private slots:
     void slotShowPassForm();
     void displayUsers();
+    void slotPassChanged(const QString&amp; result);
     void slotResize ( const QSize sz );
     void slotUnameChanged ( const QString&amp; text );
     void slotPassEnter();
+    void slotChangeBrokerPass();
+    void slotCheckPortableDir();
 
     void readUsers();
     void slotSelectedFromList ( UserButton* user );
@@ -809,6 +833,8 @@ private slots:
     void slotSuspendSessFromSt();
     void slotTermSess();
     void slotNewSess();
+    void slotGetBrokerAuth();
+    void slotGetBrokerSession(const QString&amp; sinfo);
     void slotCmdMessage ( bool result,QString output,
                           SshProcess* );
     void slotListSessions ( bool result,QString output,
@@ -849,6 +875,7 @@ private slots:
     void slotExportTimer();
     void slotAboutQt();
     void slotAbout();
+    void slotSupport();
 
     //trayIcon stuff
     void trayIconActivated(QSystemTrayIcon::ActivationReason reason);
diff --git a/onmainwindow_part2.cpp b/onmainwindow_part2.cpp
index d45bd6f..2826f87 100644
--- a/onmainwindow_part2.cpp
+++ b/onmainwindow_part2.cpp
@@ -136,6 +136,16 @@ void ONMainWindow::slotSessEnter()
         slotPassEnter();
         return;
     }
+    if(brokerMode)
+    {
+      if(!config.brokerAuthenticated)
+      {
+	x2goDebug&lt;&lt;&quot;starting broker request&quot;;
+	slotStartBroker();
+	return;
+      }
+    }
+
     resumingSession.sessionId=QString::null;
     resumingSession.server=QString::null;
     resumingSession.display=QString::null;
@@ -150,11 +160,16 @@ void ONMainWindow::slotSessEnter()
 void ONMainWindow::continueNormalSession()
 {
     x2goDebug&lt;&lt;&quot;continue normal x2go session&quot;&lt;&lt;endl;
+    if(brokerMode)
+    {
+      slotListSessions(true,QString::null,0);
+      return;
+    }
     SshProcess* proc=new SshProcess ( sshConnection, this );
     connect ( proc,SIGNAL ( sshFinished ( bool,QString,SshProcess* ) ),
               this,SLOT ( slotListSessions ( bool, QString,
                                              SshProcess* ) ) );
-    if ( !shadowSession )
+    if ( !shadowSession )      
         proc-&gt;startNormal ( &quot;export HOSTNAME &amp;&amp; x2golistsessions&quot; );
     else
         proc-&gt;startNormal ( &quot;export HOSTNAME &amp;&amp; x2golistdesktops&quot; );
@@ -189,7 +204,7 @@ bool ONMainWindow::startSession ( const QString&amp; sid )
         return true;
     }
 
-    if ( !embedMode )
+    if ( !embedMode &amp;&amp; !brokerMode )
     {
 
         X2goSettings st ( &quot;sessions&quot; );
@@ -210,8 +225,20 @@ bool ONMainWindow::startSession ( const QString&amp; sid )
         sshPort=config.sshport;
         selectedCommand=config.command;
     }
-
-    passwd=getCurrentPass();
+    if(!brokerMode)
+       passwd=getCurrentPass();
+    else
+    {
+      currentKey=config.key;
+      host=config.server;
+      X2goSettings st ( config.iniFile, QSettings::IniFormat );
+      passForm-&gt;setEnabled ( false );
+      user=st.setting()-&gt;value ( sid+&quot;/user&quot;,
+                                   ( QVariant ) QString::null ).toString();
+      login-&gt;setText(user);
+      sshPort=st.setting()-&gt;value ( sid+&quot;/sshport&quot;,
+                                   ( QVariant ) &quot;22&quot; ).toString();
+    }
     startSshConnection ( host,sshPort,acceptRsa,user,passwd,autologin );
 
     return true;
@@ -253,7 +280,7 @@ void ONMainWindow::slotListSessions ( bool result,QString output,
         uname-&gt;setEnabled ( false );
         u-&gt;setEnabled ( false );
     }
-    if ( managedMode )
+    if ( managedMode || brokerMode )
     {
         x2goDebug&lt;&lt;&quot;sess data:&quot;&lt;&lt;config.sessiondata;
         if ( config.sessiondata.indexOf ( &quot;|S|&quot; ) ==-1 )
@@ -419,51 +446,57 @@ void ONMainWindow::startNewSession()
     }
     else
     {
-        X2goSettings st ( &quot;sessions&quot; );
-        QString sid;
+        X2goSettings* st;
+	
+	if(!brokerMode)
+	  st=new X2goSettings( &quot;sessions&quot; );
+	else
+	  st= new X2goSettings(config.iniFile,QSettings::IniFormat);
+        
+	QString sid;
         if ( !embedMode )
             sid=lastSession-&gt;id();
         else
             sid=&quot;embedded&quot;;
-        pack=st.setting()-&gt;value ( sid+&quot;/pack&quot;,
+        pack=st-&gt;setting()-&gt;value ( sid+&quot;/pack&quot;,
                                    ( QVariant ) defaultPack ).toString();
-        fullscreen=st.setting()-&gt;value ( sid+&quot;/fullscreen&quot;,
+        fullscreen=st-&gt;setting()-&gt;value ( sid+&quot;/fullscreen&quot;,
                                          ( QVariant )
                                          defaultFullscreen ).toBool();
-        height=st.setting()-&gt;value ( sid+&quot;/height&quot;,
+        height=st-&gt;setting()-&gt;value ( sid+&quot;/height&quot;,
                                      ( QVariant ) defaultHeight ).toInt();
-        width=st.setting()-&gt;value ( sid+&quot;/width&quot;,
+        width=st-&gt;setting()-&gt;value ( sid+&quot;/width&quot;,
                                     ( QVariant ) defaultWidth ).toInt();
-        setDPI=st.setting()-&gt;value ( sid+&quot;/setdpi&quot;,
+        setDPI=st-&gt;setting()-&gt;value ( sid+&quot;/setdpi&quot;,
                                      ( QVariant ) defaultSetDPI ).toBool();
-        dpi=st.setting()-&gt;value ( sid+&quot;/dpi&quot;,
+        dpi=st-&gt;setting()-&gt;value ( sid+&quot;/dpi&quot;,
                                   ( QVariant ) defaultDPI ).toUInt();
-        quality=st.setting()-&gt;value (
+        quality=st-&gt;setting()-&gt;value (
                     sid+&quot;/quality&quot;,
                     ( QVariant ) defaultQuality ).toInt();
-        speed=st.setting()-&gt;value ( sid+&quot;/speed&quot;,
+        speed=st-&gt;setting()-&gt;value ( sid+&quot;/speed&quot;,
                                     ( QVariant ) defaultLink ).toInt();
 
-        usekbd=st.setting()-&gt;value ( sid+&quot;/usekbd&quot;,
+        usekbd=st-&gt;setting()-&gt;value ( sid+&quot;/usekbd&quot;,
                                      ( QVariant ) defaultSetKbd ).toBool();
-        layout=st.setting()-&gt;value ( sid+&quot;/layout&quot;,
+        layout=st-&gt;setting()-&gt;value ( sid+&quot;/layout&quot;,
                                      ( QVariant )
                                      defaultLayout[0] ).toString();
-        type=st.setting()-&gt;value ( sid+&quot;/type&quot;,
+        type=st-&gt;setting()-&gt;value ( sid+&quot;/type&quot;,
                                    ( QVariant )
                                    defaultKbdType ).toString();
         if ( !embedMode )
         {
-            command=st.setting()-&gt;value ( sid+&quot;/command&quot;,
+            command=st-&gt;setting()-&gt;value ( sid+&quot;/command&quot;,
                                           ( QVariant ) defaultCmd ).toString();
-            host=st.setting()-&gt;value (
+            host=st-&gt;setting()-&gt;value (
                      sid+&quot;/host&quot;,
                      ( QVariant )
                      ( QString ) &quot;localhost&quot; ).toString();
 
-            rootless=st.setting()-&gt;value ( sid+&quot;/rootless&quot;,
+            rootless=st-&gt;setting()-&gt;value ( sid+&quot;/rootless&quot;,
                                            ( QVariant ) false ).toBool();
-            xdmcpServer=st.setting()-&gt;value ( sid+&quot;/xdmcpserver&quot;,
+            xdmcpServer=st-&gt;setting()-&gt;value ( sid+&quot;/xdmcpserver&quot;,
                                               ( QVariant )
                                               &quot;localhost&quot; ).toString();
         }
@@ -473,7 +506,7 @@ void ONMainWindow::startNewSession()
             rootless= config.rootless;
             host=config.server;
             startEmbedded=false;
-            if ( st.setting()-&gt;value ( sid+&quot;/startembed&quot;,
+            if ( st-&gt;setting()-&gt;value ( sid+&quot;/startembed&quot;,
                                        ( QVariant ) true ).toBool() )
             {
                 startEmbedded=true;
@@ -511,6 +544,7 @@ void ONMainWindow::startNewSession()
         {
             runRemoteCommand=false;
         }
+        delete st;
     }
 
 
@@ -531,7 +565,7 @@ void ONMainWindow::startNewSession()
     maximizeProxyWin=false;
     proxyWinWidth=width;
     proxyWinHeight=height;
-#ifdef CFGCLIENT
+//#ifdef CFGCLIENT
     xorgMode=WIN;
     if(fullscreen)
       xorgMode=FS;
@@ -539,9 +573,9 @@ void ONMainWindow::startNewSession()
       xorgMode=SAPP;
     xorgWidth=QString::number(width);
     xorgHeight=QString::number(height);
-    if(!useXming &amp;&amp; ! startXorgOnStart)
+    if(! startXorgOnStart)
       startXOrg();
-#endif
+//#endif
 #endif
     if ( fullscreen )
     {
@@ -709,43 +743,47 @@ void ONMainWindow::resumeSession ( const x2goSession&amp; s )
             sid=lastSession-&gt;id();
         else
             sid=&quot;embedded&quot;;
-        X2goSettings st ( &quot;sessions&quot; );
+        X2goSettings* st;
+	if(!brokerMode)
+	  st=new X2goSettings( &quot;sessions&quot; );
+	else
+	  st=new X2goSettings(config.iniFile,QSettings::IniFormat);
 
-        pack=st.setting()-&gt;value ( sid+&quot;/pack&quot;,
+        pack=st-&gt;setting()-&gt;value ( sid+&quot;/pack&quot;,
                                    ( QVariant ) defaultPack ).toString();
 
-        fullscreen=st.setting()-&gt;value ( sid+&quot;/fullscreen&quot;,
+        fullscreen=st-&gt;setting()-&gt;value ( sid+&quot;/fullscreen&quot;,
                                          ( QVariant )
                                          defaultFullscreen ).toBool();
-        height=st.setting()-&gt;value ( sid+&quot;/height&quot;,
+        height=st-&gt;setting()-&gt;value ( sid+&quot;/height&quot;,
                                      ( QVariant ) defaultHeight ).toInt();
-        width=st.setting()-&gt;value ( sid+&quot;/width&quot;,
+        width=st-&gt;setting()-&gt;value ( sid+&quot;/width&quot;,
                                     ( QVariant ) defaultWidth ).toInt();
-        quality=st.setting()-&gt;value ( sid+&quot;/quality&quot;,
+        quality=st-&gt;setting()-&gt;value ( sid+&quot;/quality&quot;,
                                       ( QVariant )
                                       defaultQuality ).toInt();
-        speed=st.setting()-&gt;value ( sid+&quot;/speed&quot;,
+        speed=st-&gt;setting()-&gt;value ( sid+&quot;/speed&quot;,
                                     ( QVariant ) defaultLink ).toInt();
-        usekbd=st.setting()-&gt;value ( sid+&quot;/usekbd&quot;,
+        usekbd=st-&gt;setting()-&gt;value ( sid+&quot;/usekbd&quot;,
                                      ( QVariant ) defaultSetKbd ).toBool();
-        layout=st.setting()-&gt;value ( sid+&quot;/layout&quot;,
+        layout=st-&gt;setting()-&gt;value ( sid+&quot;/layout&quot;,
                                      ( QVariant )
                                      defaultLayout[0] ).toString();
-        type=st.setting()-&gt;value ( sid+&quot;/type&quot;,
+        type=st-&gt;setting()-&gt;value ( sid+&quot;/type&quot;,
                                    ( QVariant )
                                    defaultKbdType ).toString();
-        rootless=st.setting()-&gt;value ( sid+&quot;/rootless&quot;,
+        rootless=st-&gt;setting()-&gt;value ( sid+&quot;/rootless&quot;,
                                      ( QVariant ) false ).toBool();
 
         if ( !embedMode )
         {
-            host=st.setting()-&gt;value ( sid+&quot;/host&quot;,
+            host=st-&gt;setting()-&gt;value ( sid+&quot;/host&quot;,
                                        ( QVariant ) s.server ).toString();
         }
         else
         {
             startEmbedded=false;
-            if ( st.setting()-&gt;value ( sid+&quot;/startembed&quot;,
+            if ( st-&gt;setting()-&gt;value ( sid+&quot;/startembed&quot;,
                                        ( QVariant ) true ).toBool() )
             {
                 fullscreen=false;
@@ -773,6 +811,7 @@ void ONMainWindow::resumeSession ( const x2goSession&amp; s )
                 usekbd=true;
             }
         }
+        delete st;
     }
     
     if(defaultLayout.size()&gt;0)
@@ -783,7 +822,7 @@ void ONMainWindow::resumeSession ( const x2goSession&amp; s )
     maximizeProxyWin=false;
     proxyWinWidth=width;
     proxyWinHeight=height;
-#ifdef CFGCLIENT
+// #ifdef CFGCLIENT
     xorgMode=WIN;
     if(fullscreen)
       xorgMode=FS;
@@ -791,9 +830,9 @@ void ONMainWindow::resumeSession ( const x2goSession&amp; s )
       xorgMode=SAPP;
     xorgWidth=QString::number(width);
     xorgHeight=QString::number(height);
-    if(!useXming &amp;&amp; ! startXorgOnStart)
+    if(! startXorgOnStart)
       startXOrg();
-#endif
+// #endif
     
 #endif
     if ( fullscreen )
@@ -1815,9 +1854,10 @@ void ONMainWindow::slotTunnelOk()
 #ifdef Q_OS_WIN
     else
     {
-#ifdef CFGCLIENT
-        if(useXming)
-#endif
+// #ifdef CFGCLIENT
+        // if using XMing, we must find proxy win for case, that we should make it fullscreen
+        if(useInternalX&amp;&amp; (internalX==XMING))
+// #endif
         proxyWinTimer-&gt;start ( 300 );
     }
 #endif
@@ -1899,8 +1939,8 @@ void ONMainWindow::slotProxyFinished ( int,QProcess::ExitStatus )
 #ifdef Q_OS_WIN
     else
         proxyWinTimer-&gt;stop();
-#ifdef CFGCLIENT
-    if(!useXming &amp;&amp; ! startXorgOnStart)
+// #ifdef CFGCLIENT
+    if(! startXorgOnStart)
     {
       if(xorg)
       {
@@ -1912,7 +1952,7 @@ void ONMainWindow::slotProxyFinished ( int,QProcess::ExitStatus )
 	}
       }
     }
-#endif
+// #endif
 #endif
     if ( closeEventSent )
         return;
@@ -1993,9 +2033,16 @@ void ONMainWindow::slotProxyFinished ( int,QProcess::ExitStatus )
     {
         if ( !embedMode )
         {
+	  if(!brokerMode)
+	  {
             pass-&gt;setText ( &quot;&quot; );
             QTimer::singleShot ( 2000,this,
                                  SLOT ( slotShowPassForm() ) );
+	  }
+	  else
+	                QTimer::singleShot ( 2000,broker,
+                                 SLOT ( getUserSessions() ) );
+	    
         }
     }
     else
diff --git a/onmainwindow_part3.cpp b/onmainwindow_part3.cpp
index acb533e..a2d10b8 100644
--- a/onmainwindow_part3.cpp
+++ b/onmainwindow_part3.cpp
@@ -51,7 +51,11 @@ void ONMainWindow::runCommand()
     bool rootless=false;
     if ( !embedMode )
     {
-        X2goSettings st ( &quot;sessions&quot; );
+        X2goSettings* st;
+	if(!brokerMode)
+	  st=new X2goSettings( &quot;sessions&quot; );
+	else
+	  st=new X2goSettings(config.iniFile, QSettings::IniFormat);
 
 
         if ( useLdap )
@@ -59,29 +63,30 @@ void ONMainWindow::runCommand()
         else
         {
             QString sid=lastSession-&gt;id();
-            command=st.setting()-&gt;value (
+            command=st-&gt;setting()-&gt;value (
                         sid+&quot;/command&quot;,
                         ( QVariant ) tr ( &quot;KDE&quot; ) ).toString();
-            rdpOpts=st.setting()-&gt;value (
+            rdpOpts=st-&gt;setting()-&gt;value (
                         sid+&quot;/rdpoptions&quot;,
                         ( QVariant ) &quot;&quot; ).toString();
-            rdpServer=st.setting()-&gt;value (
+            rdpServer=st-&gt;setting()-&gt;value (
                           sid+&quot;/rdpserver&quot;,
                           ( QVariant ) &quot;&quot; ).toString();
-            rootless=st.setting()-&gt;value ( sid+&quot;/rootless&quot;,
+            rootless=st-&gt;setting()-&gt;value ( sid+&quot;/rootless&quot;,
                                            ( QVariant ) false ).toBool();
 
-            rdpFS=st.setting()-&gt;value (
+            rdpFS=st-&gt;setting()-&gt;value (
                       sid+&quot;/fullscreen&quot;,
                       ( QVariant ) defaultFullscreen ).toBool();
-            rdpHeight=st.setting()-&gt;value (
+            rdpHeight=st-&gt;setting()-&gt;value (
                           sid+&quot;/height&quot;,
                           ( QVariant ) defaultHeight ).toString();
-            rdpWidth=st.setting()-&gt;value (
+            rdpWidth=st-&gt;setting()-&gt;value (
                          sid+&quot;/width&quot;,
                          ( QVariant ) defaultWidth ).toString();
 
         }
+        delete st;
     }
     else
     {
@@ -220,6 +225,11 @@ bool ONMainWindow::parseParameter ( QString param )
         ONMainWindow::portable=true;
         return true;
     }
+    if ( param == &quot;--clean-all-files&quot; )
+    {
+        cleanAllFiles=true;
+        return true;
+    }
 
     if ( param==&quot;--no-menu&quot; )
     {
@@ -257,6 +267,12 @@ bool ONMainWindow::parseParameter ( QString param )
         noSessionEdit=true;
         return true;
     }
+    if( param==&quot;--change-broker-pass&quot;)
+    {
+      changeBrokerPass=true;
+      return true;
+    }
+    
 
     QString setting,value;
     QStringList vals=param.split ( &quot;=&quot; );
@@ -368,6 +384,86 @@ bool ONMainWindow::parseParameter ( QString param )
         embedParent=value.toLong();
         return true;
     }
+    if( setting == &quot;--broker-url&quot;)
+    {
+      brokerMode=true;
+      noSessionEdit=true;
+      config.brokerurl=value;
+      return true;
+    }
+    if( setting == &quot;--broker-name&quot;)
+    {
+      config.brokerName=value;
+      return true;
+    }
+    if( setting == &quot;--auth-id&quot;)
+    {
+      QFile file(value);
+     if (!file.open(QIODevice::ReadOnly | QIODevice::Text))
+     {
+         printError ( param + tr(&quot; (can't open file)&quot;));
+         return false;
+     }
+         QTextStream in(&amp;file);
+         config.brokerUserId = in.readLine();
+	 return true;
+    }
+    if(setting == &quot;--support-menu&quot;)
+    {
+      if(! QFile::exists(value))
+      {
+	printError( param + tr(&quot; (file not exists)&quot;));
+	return false;
+      }
+      supportMenuFile=value;
+      return true;
+    }
+    if(setting == &quot;--background&quot;)
+    {
+      if(! QFile::exists(value))
+      {
+	printError( param + tr(&quot; (file not exists)&quot;));
+	return false;
+      }
+      BGFile=value;
+      return true;
+    }
+    if(setting == &quot;--session-icon&quot;)
+    {
+      if(! QFile::exists(value))
+      {
+	printError( param + tr(&quot; (file not exists)&quot;));
+	return false;
+      }
+      SPixFile=value;
+      return true;
+    }
+    if(setting == &quot;--home&quot;)
+    {
+      QDir dr;
+      
+#ifdef Q_OS_WIN
+      int find=value.indexOf(&quot;(&quot;);
+      int lind=value.indexOf(&quot;)&quot;);
+      if(find!=-1 &amp;&amp; lind !=-1)
+      {	
+	QString label=value.mid(find+1,lind-find-1);
+	x2goDebug&lt;&lt; &quot;searching for drive with label: &quot;&lt;&lt;label;
+	QString drive=wapiGetDriveByLabel(label);
+	value.replace(&quot;(&quot;+label+&quot;)&quot;,drive);
+	x2goDebug&lt;&lt;&quot;new path: &quot;&lt;&lt;value;
+      }
+#endif
+      if(! dr.exists(value))
+      {
+	printError( param + tr(&quot; (directory not exists)&quot;));
+	return false;
+      }
+      homeDir=value;
+      portableDataPath=value;
+      return true;
+    }
+
     printError ( param );
     return false;
 }
@@ -617,6 +713,7 @@ void ONMainWindow::showHelp()
         &quot;--kbd-layout=&lt;layout&gt;\t\t set default keyboard layout or layouts\n&quot;
         &quot;comma separated\n&quot;
         &quot;--kbd-type=&lt;typed&gt;\t\t set default keyboard type\n&quot;
+        &quot;--home=&lt;dir&gt;\t\t set users home directory\n&quot;
         &quot;--set-kbd=&lt;0|1&gt;\t\t\t overwrite current keyboard settings\n&quot; ;
     qCritical ( &quot;%s&quot;,helpMsg.toLocal8Bit().data() );
     QMessageBox::information ( this,tr ( &quot;Options&quot; ),helpMsg );
@@ -1388,7 +1485,7 @@ void ONMainWindow::slotExportTimer()
     {
         SshProcess* sproc=new SshProcess (
             sshConnection, this );
-        sproc-&gt;startNormal ( &quot;export HOSTNAME &amp;&amp; x2goumount-session &quot;+
+        sproc-&gt;startNormal ( &quot;export HOSTNAME &amp;&amp; x2goumount_session &quot;+
                              sessionId+&quot; &quot;+args[i] );
     }
 }
@@ -1398,6 +1495,21 @@ void ONMainWindow::slotAboutQt()
     QMessageBox::aboutQt ( this );
 }
 
+void ONMainWindow::slotSupport()
+{
+    QFile file(supportMenuFile);
+     if (!file.open(QIODevice::ReadOnly | QIODevice::Text))
+         return;
+
+     QTextStream in(&amp;file);
+     QString sup;
+     while (!in.atEnd()) 
+     {
+         sup+=in.readLine();
+     }     
+     QMessageBox::information (this,tr ( &quot;Support&quot; ),sup);
+}
+
 void ONMainWindow::slotAbout()
 {
     QString aboutStr=tr (
diff --git a/onmainwindow_part4.cpp b/onmainwindow_part4.cpp
index 451c421..a6102d6 100644
--- a/onmainwindow_part4.cpp
+++ b/onmainwindow_part4.cpp
@@ -282,14 +282,18 @@ void ONMainWindow::startXOrg ()
     QTextStream ( &amp;dispString ) &lt;&lt;&quot;:&quot;&lt;&lt;xDisplay;
 
     QStringList args;
-    QString exec=appDir+&quot;\\xming\\Xming.exe&quot;;
-    bool xming=true;
+    QString exec;
+    if(internalX==XMING)
+       exec=appDir+&quot;\\xming\\Xming.exe&quot;;
+    if(internalX==VCXSRV)
+       exec=appDir+&quot;\\vcxsrv\\vcxsrv.exe&quot;;
     winServersReady=false;
-#ifdef CFGCLIENT
-    xming=useXming;
-    if (!xming)
+    x2goDebug&lt;&lt;&quot;using internal X: &quot;&lt;&lt;useInternalX;
+//#ifdef CFGCLIENT
+    if (!useInternalX || internalX!=XMING)
     {
-        exec=xorgExe;
+        if(!useInternalX)
+            exec=xorgExe;
         QString cmdLine;
         if (startXorgOnStart)
             cmdLine=xorgOptions;
@@ -320,9 +324,9 @@ void ONMainWindow::startXOrg ()
         }
         args&lt;&lt;dispString;
     }
-#endif
+//#endif
     xorg=new QProcess ( 0 );
-    if (xming)
+    if (useInternalX &amp;&amp; (internalX==XMING))
     {
       
         QString workingDir=appDir+&quot;\\xming&quot;;
@@ -344,7 +348,7 @@ void ONMainWindow::startXOrg ()
         xorg-&gt; setWorkingDirectory ( workingDir);
     }
     
-    x2goDebug&lt;&lt;&quot;running&quot;&lt;&lt;exec;
+    x2goDebug&lt;&lt;&quot;running&quot;&lt;&lt;exec&lt;&lt;&quot; &quot;&lt;&lt;args.join(&quot; &quot;);
     xorg-&gt;start ( exec, args );
 
 
@@ -356,15 +360,41 @@ void ONMainWindow::startXOrg ()
                  &quot;Please check your installation&quot; ) );
         close();
     }
-#ifdef CFGCLIENT
-    if (!xming)
+// #ifdef CFGCLIENT
+    if ( !useInternalX || internalX!= XMING)
     {
-        x2goDebug&lt;&lt;&quot;servers ready after&quot;&lt;&lt;xorgDelay&lt;&lt;endl;
-        QTimer::singleShot(xorgDelay*1000, this, SLOT(slotSetWinServersReady()));
+	 //check connection in slot and launch setWinServerReady
+	 waitingForX=0;
+         QTimer::singleShot(1000, this, SLOT(slotCheckXOrgConnection()));
     }
-#endif
+// #endif
 }
 
+void ONMainWindow::slotCheckXOrgConnection()
+{
+    ++waitingForX;
+    if(isServerRunning(6000+xDisplay))
+    {
+      x2goDebug&lt;&lt;&quot;X is started&quot;;
+      slotSetWinServersReady();
+    }
+    else
+    {
+      if(waitingForX &gt; 10)
+      {
+         QMessageBox::critical (
+            0,QString::null,
+            tr ( &quot;Can't start X Server\n&quot;
+                 &quot;Please check your installation&quot; ) );
+         close();
+      }
+      else
+      {
+        x2goDebug&lt;&lt;&quot;waiting for X&quot;;
+	QTimer::singleShot(1000, this, SLOT(slotCheckXOrgConnection()));	
+      }
+    }
+}
 
 WinServerStarter::WinServerStarter ( daemon server, ONMainWindow * par ) :
 QThread ( 0 )
@@ -421,17 +451,17 @@ void ONMainWindow::startWinServers()
     {
         pulseStarter-&gt;start();
     }
-#ifdef CFGCLIENT
-        x2goDebug&lt;&lt;&quot;xorg settings: &quot;&lt;&lt;startXorgOnStart &lt;&lt;&quot; &quot;&lt;&lt; useXming&lt;&lt;endl;
-    if (useXming)
+// #ifdef CFGCLIENT
+//     x2goDebug&lt;&lt;&quot;xorg settings: &quot;&lt;&lt;startXorgOnStart &lt;&lt;&quot; &quot;&lt;&lt; useXming&lt;&lt;endl;
+    if ( useInternalX &amp;&amp; (internalX== XMING))
     {
-#endif
+// #endif
         xStarter-&gt;start();
         xorgLogTimer=new QTimer ( this );
         connect ( xorgLogTimer,SIGNAL ( timeout() ),this,
                   SLOT ( slotCheckXOrgLog() ) );
         xorgLogTimer-&gt;start ( 500 );
-#ifdef CFGCLIENT
+// #ifdef CFGCLIENT
     }
     else
     {
@@ -440,7 +470,7 @@ void ONMainWindow::startWinServers()
             startXOrg();
         }
     }
-#endif
+// #endif
 }
 
 
@@ -678,26 +708,45 @@ void ONMainWindow::startPulsed()
 }
 
 
-#ifdef CFGCLIENT
+// #ifdef CFGCLIENT
 void ONMainWindow::xorgSettings()
 {
     x2goDebug&lt;&lt;&quot;getting xorg settings&quot;&lt;&lt;endl;
 
     X2goSettings st ( &quot;settings&quot; );
-    useXming=(st.setting()-&gt;value(&quot;usexming&quot;,true).toBool());
+    
+    useInternalX=(st.setting()-&gt;value(&quot;useintx&quot;,true).toBool());
+    
     xorgExe=(st.setting()-&gt;value(&quot;xexec&quot;,&quot;C:\\program files\\vcxsrv\\vcxsrv.exe&quot;).toString());
     xorgOptions=(st.setting()-&gt;value(&quot;options&quot;,&quot;-multiwindow -notrayicon -clipboard&quot;).toString());
     startXorgOnStart=(st.setting()-&gt;value(&quot;onstart&quot;,true).toBool());
     xorgWinOptions=(st.setting()-&gt;value(&quot;optionswin&quot;,&quot;-screen 0 %wx%h -notrayicon -clipboard&quot;).toString());
     xorgFSOptions=(st.setting()-&gt;value(&quot;optionsfs&quot;,&quot;-fullscreen -notrayicon -clipboard&quot;).toString());
     xorgSAppOptions=(st.setting()-&gt;value(&quot;optionssingle&quot;,&quot;-multiwindow -notrayicon -clipboard&quot;).toString());
-    xorgDelay=(st.setting()-&gt;value(&quot;delay&quot;,3).toInt());
+    
+    if(QFile::exists(appDir+&quot;\\vcxsrv&quot;))
+      internalX=VCXSRV;
+    if(QFile::exists(appDir+&quot;\\xming&quot;))
+      internalX=XMING;
+    if(useInternalX)
+    {
+      startXorgOnStart=(internalX==XMING);
+      xorgOptions=&quot;-multiwindow -notrayicon -clipboard&quot;;
+      if(internalX==VCXSRV)
+      {
+// 	xorgWinOptions=&quot;-screen 0 %wx%h -notrayicon -clipboard&quot;;
+	xorgWinOptions=&quot;-multiwindow -notrayicon -clipboard&quot;;
+        xorgFSOptions=&quot;-fullscreen -notrayicon -clipboard&quot;;
+        xorgSAppOptions=&quot;-multiwindow -notrayicon -clipboard&quot;;
+      }
+    }
 
 }
-#endif
+// #endif
 
 void ONMainWindow::slotSetWinServersReady()
 {
+    x2goDebug&lt;&lt;&quot;all winservers are started\n&quot;;
     winServersReady=true;
     restoreCygnusSettings();
 }
@@ -906,7 +955,7 @@ QString ONMainWindow::getCurrentUname()
 
 QString ONMainWindow::getCurrentPass()
 {
-    return pass-&gt;text();
+    return pass-&gt;text();   
 }
 
 void ONMainWindow::slotDetachProxyWindow()
@@ -2117,22 +2166,43 @@ QSize ONMainWindow::getEmbedAreaSize()
 
 void ONMainWindow::slotStartBroker()
 {
-    broker=new HttpBrokerClient ( this, &amp;config );
-    connect ( broker,SIGNAL ( haveSshKey ( QString ) ),this,
-              SLOT ( slotStartSshAgent ( QString ) ) );
-    connect ( broker,SIGNAL ( haveAgentInfo () ),this,
-              SLOT ( slotStartNewBrokerSession () ) );
-    connect ( broker,SIGNAL ( fatalHttpError() ),this,
-              SLOT ( close() ) );
-    connect ( broker,SIGNAL ( cmdReconnect() ),this,
-              SLOT ( slotReconnectSession() ) );
+    config.brokerPass=pass-&gt;text();
+    config.brokerUser=login-&gt;text();
     setStatStatus ( tr ( &quot;Connecting to broker&quot; ) );
     stInfo-&gt;insertPlainText ( &quot;broker url: &quot;+config.brokerurl );
     setEnabled ( false );
-
+    broker-&gt;getUserSessions();
+}
+
+void ONMainWindow::slotGetBrokerSession(const QString&amp; sinfo)
+{
+   //x2goDebug&lt;&lt;&quot;broker session: &quot;&lt;&lt;sinfo;
+   QStringList lst=sinfo.split(&quot;SERVER:&quot;,QString::SkipEmptyParts);
+   int keyStartPos=sinfo.indexOf(&quot;-----BEGIN DSA PRIVATE KEY-----&quot;);
+   QString endStr=&quot;-----END DSA PRIVATE KEY-----&quot;;
+   int keyEndPos=sinfo.indexOf(endStr);
+   if(keyEndPos == -1 || keyStartPos == -1 || lst.size()==0)
+   {
+     //throw error
+      QMessageBox::critical (
+                0,tr ( &quot;Error&quot; ),
+                tr (&quot;Invalid reply from broker&quot;) +&quot;&lt;br&gt;&quot;+sinfo);
+
+     close();
+     return;
+   }
+   config.server=(lst[1].split(&quot;\n&quot;))[0];
+   config.key=sinfo.mid(keyStartPos, keyEndPos+endStr.length()-keyStartPos);
+//    x2goDebug&lt;&lt;&quot;server: &quot;&lt;&lt;config.server&lt;&lt;endl&lt;&lt;&quot; key: &quot;&lt;&lt;config.key;
+   if(sinfo.indexOf(&quot;SESSION_INFO&quot;)!=-1)
+   {
+        QStringList lst=sinfo.split(&quot;SESSION_INFO:&quot;,QString::SkipEmptyParts);
+	config.sessiondata=(lst[1].split(&quot;\n&quot;))[0];
+// 	x2goDebug&lt;&lt;&quot;data: &quot;&lt;&lt;config.sessiondata;
+   }
+   slotSessEnter();
 }
 
-
 void ONMainWindow::slotStartNewBrokerSession ( )
 {
     if ( managedMode )
@@ -2176,19 +2246,21 @@ QString ONMainWindow::u3DataPath()
 
 void ONMainWindow::cleanPortable()
 {
-    QDir dr;
-    dr.rmdir ( QDir::homePath() +&quot;/.ssh&quot; );
-    removeDir ( homeDir+&quot;/.x2go/&quot; );
+    removeDir ( homeDir +&quot;/.ssh&quot; );
+    removeDir ( homeDir +&quot;/ssh&quot; );
+    removeDir ( homeDir+&quot;/.x2go&quot; );
+    if(cleanAllFiles)
+      removeDir(homeDir+&quot;/.x2goclient&quot;);
 }
 
 void ONMainWindow::removeDir ( QString path )
 {
-    x2goDebug&lt;&lt;&quot;entering path&quot;;
+    x2goDebug&lt;&lt;&quot;entering &quot; &lt;&lt;path;
     QDir dr ( path );
     QStringList files=dr.entryList ( QDir::Files );
     for ( int i=0;i&lt;files.size();++i )
     {
-        if ( files[i]!=&quot;known_hosts&quot; )
+        if ( files[i]!=&quot;known_hosts&quot; || cleanAllFiles)
         {
             x2goDebug&lt;&lt;&quot;cleaning file:&quot;&lt;&lt;path+&quot;/&quot;+files[i];
             dr.remove ( path+&quot;/&quot;+files[i] );
diff --git a/onmainwindow_privat.h b/onmainwindow_privat.h
index 60d623e..a2d54aa 100644
--- a/onmainwindow_privat.h
+++ b/onmainwindow_privat.h
@@ -74,6 +74,7 @@
 #include &quot;clicklineedit.h&quot;
 #include &lt;QThread&gt;
 
+#include &quot;brokerpassdlg.h&quot;
 
 #include &quot;sshmasterconnection.h&quot;
 
diff --git a/resources.rcc b/resources.rcc
index 931afc1..a22aaa9 100644
--- a/resources.rcc
+++ b/resources.rcc
@@ -40,6 +40,7 @@
        &lt;file&gt;icons/32x32/detach.png&lt;/file&gt;
        &lt;file&gt;icons/32x32/suspend.png&lt;/file&gt;
        &lt;file&gt;icons/32x32/stop.png&lt;/file&gt;
+       &lt;file&gt;icons/32x32/auth.png&lt;/file&gt;
        &lt;file&gt;icons/32x32/x2goclient.png&lt;/file&gt;
        &lt;file&gt;icons/32x32/resolution.png&lt;/file&gt;
        &lt;file&gt;icons/16x16/audio.png&lt;/file&gt;
diff --git a/sessionbutton.cpp b/sessionbutton.cpp
index 197ad11..c5ec122 100644
--- a/sessionbutton.cpp
+++ b/sessionbutton.cpp
@@ -30,7 +30,7 @@ SessionButton::SessionButton ( ONMainWindow* mw,QWidget *parent, QString id )
         : SVGFrame ( &quot;:/svg/sessionbut.svg&quot;,false,parent )
 {
     editable=mw-&gt;sessionEditEnabled();
-    
+
     QFont fnt=font();
     if ( mw-&gt;retMiniMode() )
 #ifdef Q_WS_HILDON
@@ -71,6 +71,7 @@ SessionButton::SessionButton ( ONMainWindow* mw,QWidget *parent, QString id )
     geomBox-&gt;setPalette ( cpal );
 
     sessName=new QLabel ( this );
+    sessStatus=new QLabel ( this );
     fnt=sessName-&gt;font();
     fnt.setBold ( true );
     sessName-&gt;setFont ( fnt );
@@ -142,6 +143,7 @@ SessionButton::SessionButton ( ONMainWindow* mw,QWidget *parent, QString id )
     if ( !miniMode )
     {
         sessName-&gt;move ( 80,34 );
+	sessStatus-&gt;move(80,50);
         editBut-&gt;move ( 307,156 );
         serverIcon-&gt;move ( 58,84 );
         server-&gt;move ( 80,84 );
@@ -158,6 +160,7 @@ SessionButton::SessionButton ( ONMainWindow* mw,QWidget *parent, QString id )
     {
         editBut-&gt;move ( 218,113 );
         sessName-&gt;move ( 64,11 );
+	sessStatus-&gt;hide();
         serverIcon-&gt;move ( 66,44 );
         server-&gt;move ( 88,44 );
         cmdIcon-&gt;move ( 66,68 );
@@ -169,6 +172,14 @@ SessionButton::SessionButton ( ONMainWindow* mw,QWidget *parent, QString id )
         soundIcon-&gt;move ( 66,116 );
         sound-&gt;move ( 86,116 );
     }
+    
+    if(mw-&gt;brokerMode)
+    {
+      icon-&gt;move(10,30);
+      sessName-&gt;move(90,50);
+      sessStatus-&gt;move(90,70);
+      setFixedHeight(120);
+    }
 
 
     cmdBox-&gt;hide();
@@ -206,7 +217,18 @@ SessionButton::SessionButton ( ONMainWindow* mw,QWidget *parent, QString id )
         cmdBox-&gt;hide();
         geomBox-&gt;hide();
         sessMenu-&gt;hide();
-	sound-&gt;setEnabled(false);
+        sound-&gt;setEnabled(false);
+    }
+    if(mw-&gt;brokerMode)
+    {
+      cmd-&gt;hide();
+      cmdIcon-&gt;hide();
+      server-&gt;hide();
+      serverIcon-&gt;hide();
+      geom-&gt;hide();
+      geomIcon-&gt;hide();
+      sound-&gt;hide();
+      soundIcon-&gt;hide();
     }
 }
 
@@ -232,36 +254,66 @@ void SessionButton::slotRemove()
 void SessionButton::redraw()
 {
     bool snd;
-    X2goSettings st ( &quot;sessions&quot; );
+
+
+    X2goSettings *st;
+
+    if (par-&gt;brokerMode)
+        st=new X2goSettings(par-&gt;config.iniFile,QSettings::IniFormat);
+    else
+        st= new X2goSettings( &quot;sessions&quot; );
+
+
+
     sessName-&gt;setText (
-        st.setting()-&gt;value ( sid+&quot;/name&quot;,
-                              ( QVariant ) tr ( &quot;New Session&quot; ) ).toString() );
-    QString sessIcon=st.setting()-&gt;value (
+        st-&gt;setting()-&gt;value ( sid+&quot;/name&quot;,
+                               ( QVariant ) tr ( &quot;New Session&quot; ) ).toString());
+    QString status=st-&gt;setting()-&gt;value ( sid+&quot;/status&quot;,
+                                          ( QVariant ) QString::null ).toString();
+    if (status == &quot;R&quot;)
+    {
+        sessStatus-&gt;setText(&quot;(&quot;+tr(&quot;running&quot;)+&quot;)&quot;);
+    }
+    if (status == &quot;S&quot;)
+    {
+        sessStatus-&gt;setText(&quot;(&quot;+tr(&quot;suspended&quot;)+&quot;)&quot;);
+    }
+
+    QString sessIcon=st-&gt;setting()-&gt;value (
                          sid+&quot;/icon&quot;,
                          ( QVariant )
                          &quot;:icons/128x128/x2gosession.png&quot;
                      ).toString();
-    QPixmap pix ( sessIcon );
+    QPixmap* pix;
+
+    if (!par-&gt;brokerMode || sessIcon == &quot;:icons/128x128/x2gosession.png&quot;)
+        pix=new QPixmap( sessIcon );
+    else
+    {
+        pix=new QPixmap;
+        pix-&gt;loadFromData(QByteArray::fromBase64(sessIcon.toAscii()));
+    }
     if ( !par-&gt;retMiniMode() )
-        icon-&gt;setPixmap ( pix.scaled ( 64,64,Qt::IgnoreAspectRatio,
-                                       Qt::SmoothTransformation ) );
+        icon-&gt;setPixmap ( pix-&gt;scaled ( 64,64,Qt::IgnoreAspectRatio,
+                                        Qt::SmoothTransformation ) );
     else
-        icon-&gt;setPixmap ( pix.scaled ( 48,48,Qt::IgnoreAspectRatio,
-                                       Qt::SmoothTransformation ) );
-
-    QString sv=st.setting()-&gt;value ( sid+&quot;/host&quot;, ( QVariant )
-                                     QString::null ).toString();
-    QString uname=st.setting()-&gt;value ( sid+&quot;/user&quot;, ( QVariant )
-                                        QString::null ).toString();
+        icon-&gt;setPixmap ( pix-&gt;scaled ( 48,48,Qt::IgnoreAspectRatio,
+                                        Qt::SmoothTransformation ) );
+
+    delete pix;
+    QString sv=st-&gt;setting()-&gt;value ( sid+&quot;/host&quot;, ( QVariant )
+                                      QString::null ).toString();
+    QString uname=st-&gt;setting()-&gt;value ( sid+&quot;/user&quot;, ( QVariant )
+                                         QString::null ).toString();
     server-&gt;setText ( uname+&quot;@&quot;+sv );
 
-    QString command=st.setting()-&gt;value ( sid+&quot;/command&quot;,
-                                          ( QVariant )
-                                          tr (
-                                              &quot;KDE&quot; ) ).
+    QString command=st-&gt;setting()-&gt;value ( sid+&quot;/command&quot;,
+                                           ( QVariant )
+                                           tr (
+                                               &quot;KDE&quot; ) ).
                     toString();
-    rootless=st.setting()-&gt;value ( sid+&quot;/rootless&quot;,
-                                   false ).toBool();
+    rootless=st-&gt;setting()-&gt;value ( sid+&quot;/rootless&quot;,
+                                    false ).toBool();
 
 
     cmdBox-&gt;clear();
@@ -337,17 +389,17 @@ void SessionButton::redraw()
 #else
     geomBox-&gt;addItem ( tr ( &quot;window&quot; ) );
 #endif
-    if ( st.setting()-&gt;value ( sid+&quot;/fullscreen&quot;,
-                               ( QVariant ) false ).toBool() )
+    if ( st-&gt;setting()-&gt;value ( sid+&quot;/fullscreen&quot;,
+                                ( QVariant ) false ).toBool() )
     {
         geom-&gt;setText ( tr ( &quot;fullscreen&quot; ) );
     }
     else
     {
 #ifndef	Q_WS_HILDON
-        QString g=QString::number ( st.setting()-&gt;value (
+        QString g=QString::number ( st-&gt;setting()-&gt;value (
                                         sid+&quot;/width&quot; ).toInt() );
-        g+=&quot;x&quot;+QString::number ( st.setting()-&gt;value (
+        g+=&quot;x&quot;+QString::number ( st-&gt;setting()-&gt;value (
                                      sid+&quot;/height&quot; ).toInt() );
         geom-&gt;setText ( g );
         if ( geomBox-&gt;findText ( g ) ==-1 )
@@ -360,7 +412,7 @@ void SessionButton::redraw()
     }
 
 
-    snd=st.setting()-&gt;value ( sid+&quot;/sound&quot;, ( QVariant ) true ).toBool();
+    snd=st-&gt;setting()-&gt;value ( sid+&quot;/sound&quot;, ( QVariant ) true ).toBool();
     if ( snd )
         sound-&gt;setText ( tr ( &quot;Enabled&quot; ) );
     else
@@ -374,6 +426,7 @@ void SessionButton::redraw()
     geom-&gt;setMinimumSize ( geom-&gt;sizeHint() );
     cmd-&gt;setMinimumSize ( cmd-&gt;sizeHint() );
     server-&gt;setMinimumSize ( server-&gt;sizeHint() );
+    delete st;
 }
 
 void SessionButton::mousePressEvent ( QMouseEvent * event )
@@ -396,8 +449,8 @@ void SessionButton::mouseMoveEvent ( QMouseEvent * event )
 {
 
     SVGFrame::mouseMoveEvent ( event );
-    if(!editable)
-      return;
+    if (!editable)
+        return;
     if ( cmd-&gt;isVisible() )
         if ( event-&gt;x() &gt; cmd-&gt;x() &amp;&amp; event-&gt;x() &lt; cmd-&gt;x() +
                 cmd-&gt;width() &amp;&amp;
diff --git a/sessionbutton.h b/sessionbutton.h
index 8efaad4..b39bdb5 100644
--- a/sessionbutton.h
+++ b/sessionbutton.h
@@ -36,6 +36,7 @@ class SessionButton : public SVGFrame
 	private:
 		QString sid;
 		QLabel* sessName;
+		QLabel* sessStatus;
 		QLabel* icon;
 		QComboBox* cmdBox;
 		QLabel* cmd;
diff --git a/sshmasterconnection.cpp b/sshmasterconnection.cpp
index d36d675..224b7bf 100644
--- a/sshmasterconnection.cpp
+++ b/sshmasterconnection.cpp
@@ -28,8 +28,10 @@
 #include &lt;arpa/inet.h&gt;
 #endif
 
+#include &quot;onmainwindow.h&quot;
+
 #undef DEBUG
-#define DEBUG
+// #define DEBUG
 
 static bool isLibSshInited=false;
 
@@ -44,11 +46,13 @@ SshMasterConnection::SshMasterConnection ( QString host, int port, bool acceptUn
     this-&gt;autologin=autologin;
     this-&gt;acceptUnknownServers=acceptUnknownServers;
     reverseTunnel=false;
+    mainWnd=(ONMainWindow*) parent;
 }
 
 SshMasterConnection::SshMasterConnection ( QString host, int port, bool acceptUnknownServers, QString user,
         QString pass, QString key, bool autologin,
-        int remotePort, QString localHost, int localPort, SshProcess* creator, QObject* parent ) : QThread ( parent )
+        int remotePort, QString localHost, int localPort, SshProcess* creator, 
+					   QObject* parent, ONMainWindow* mwd ) : QThread ( parent )
 {
 
     this-&gt;host=host;
@@ -63,6 +67,7 @@ SshMasterConnection::SshMasterConnection ( QString host, int port, bool acceptUn
     reverseTunnelCreator=creator;
     reverseTunnel=true;
     reverseTunnelRemotePort=remotePort;
+    mainWnd=mwd;
 }
 
 SshMasterConnection* SshMasterConnection::reverseTunnelConnection ( SshProcess* creator,
@@ -70,7 +75,7 @@ SshMasterConnection* SshMasterConnection::reverseTunnelConnection ( SshProcess*
 {
     SshMasterConnection* con=new SshMasterConnection ( host,port,acceptUnknownServers,user,pass,
             key,autologin, remotePort,localHost,
-            localPort,creator,this );
+            localPort,creator,this, mainWnd);
 
     connect ( con,SIGNAL ( ioErr ( SshProcess*,QString,QString ) ),this,SIGNAL ( ioErr ( SshProcess*,QString,QString ) ) );
     connect ( con,SIGNAL ( stdErr ( SshProcess*,QByteArray ) ),this,SIGNAL ( stdErr ( SshProcess*,QByteArray ) ) );
@@ -120,7 +125,9 @@ void SshMasterConnection::run()
         quit();
         return;
     }
-
+#ifdef Q_OS_WIN    
+    ssh_options_set ( my_ssh_session, SSH_OPTIONS_SSH_DIR, (mainWnd-&gt;getHomeDirectory()+&quot;/ssh&quot;).toAscii());
+#endif
 //     ssh_options_set(my_ssh_session, SSH_OPTIONS_LOG_VERBOSITY, &amp;verbosity);
     if ( !sshConnect() )
     {
@@ -146,9 +153,18 @@ void SshMasterConnection::run()
     }
 
     ssh_options_set ( my_ssh_session, SSH_OPTIONS_USER, user.toAscii() );
+#ifdef Q_OS_WIN    
+    ssh_options_set ( my_ssh_session, SSH_OPTIONS_SSH_DIR, (mainWnd-&gt;getHomeDirectory()+&quot;/ssh&quot;).toAscii());
+#endif    
+    x2goDebug&lt;&lt;&quot;setting SSH DIR to &quot;&lt;&lt;mainWnd-&gt;getHomeDirectory()+&quot;/ssh&quot;;
 
     if ( userAuth() )
+    {
+      #ifdef DEBUG
+        x2goDebug&lt;&lt;&quot;user auth OK\n&quot;;
+      #endif
         emit connectionOk();
+    }
     else
     {
         QString err=ssh_get_error ( my_ssh_session );
@@ -317,7 +333,7 @@ bool SshMasterConnection::userAuthWithKey()
     if ( key.indexOf ( &quot;PRIVATE KEY&quot; ) !=-1 )
     {
         QDir dr;
-        QString keyPath=QDir::homePath() +&quot;/.x2go/ssh/gen&quot;;
+        QString keyPath=mainWnd-&gt;getHomeDirectory() +&quot;/.x2go/ssh/gen&quot;;
         dr.mkpath ( keyPath );
         QTemporaryFile fl ( keyPath+&quot;/key&quot; );
         fl.open();
diff --git a/sshmasterconnection.h b/sshmasterconnection.h
index a68c0b4..15d9235 100644
--- a/sshmasterconnection.h
+++ b/sshmasterconnection.h
@@ -24,6 +24,7 @@
 #include &lt;QThread&gt;
 #include &lt;QStringList&gt;
 
+class ONMainWindow;
 class SshProcess;
 struct ChannelConnection
 {
@@ -72,7 +73,8 @@ public:
 private:
     SshMasterConnection(QString host, int port, bool acceptUnknownServers, QString user, QString pass, QString key,
                         bool autologin,
-                        int remotePort, QString localHost, int localPort, SshProcess* creator, QObject* parent = 0);
+                        int remotePort, QString localHost, int localPort, SshProcess* creator, 
+			QObject* parent, ONMainWindow* parWnd);
     bool sshConnect();
     bool userAuthWithPass();
     bool userAuthAuto();
@@ -105,7 +107,8 @@ private:
     int reverseTunnelLocalPort;
     bool acceptUnknownServers;
     QString reverseTunnelLocalHost;
-    SshProcess* reverseTunnelCreator;    
+    SshProcess* reverseTunnelCreator;   
+    ONMainWindow* mainWnd;
 
 signals:
     void stdErr(SshProcess* caller, QByteArray data);
diff --git a/sshprocess.cpp b/sshprocess.cpp
index 83d1ce4..9e72e8f 100644
--- a/sshprocess.cpp
+++ b/sshprocess.cpp
@@ -25,7 +25,7 @@
 #endif
 
 #undef DEBUG
-#define DEBUG
+// #define DEBUG
 
 SshProcess::SshProcess(SshMasterConnection* master, QObject* parent): QObject(parent)
 {
diff --git a/version.h b/version.h
index 119983c..b49a660 100644
--- a/version.h
+++ b/version.h
@@ -1 +1 @@
-#define VERSION &quot;3.0.1.18&quot;
+#define VERSION &quot;3.0.99.0&quot;
diff --git a/wapi.cpp b/wapi.cpp
index 297ead3..e565cc6 100644
--- a/wapi.cpp
+++ b/wapi.cpp
@@ -177,6 +177,38 @@ QString wapiShortFileName ( const QString&amp; longName )
 }
 
 
+QString wapiGetDriveByLabel(const QString&amp; label)
+{
+  int len=GetLogicalDriveStrings(0,0);
+  if(len&gt;0)
+  {
+    TCHAR* buf=new TCHAR[len+1];
+    len=GetLogicalDriveStrings(len,buf);
+    for(int i=0;i&lt;len;i+=4)
+    {      
+       QString drive=QString::fromUtf16 ( ( const ushort* ) buf+i );
+       x2goDebug&lt;&lt;&quot;drive:&quot;&lt;&lt;drive;
+       TCHAR vol[MAX_PATH+1];
+       TCHAR fs[MAX_PATH+1];
+       GetVolumeInformation(buf+i,vol,MAX_PATH,0,0,0,fs,MAX_PATH);       
+       QString volume=QString::fromUtf16 ( ( const ushort* ) vol );
+       x2goDebug&lt;&lt;&quot;vol:&quot;&lt;&lt;volume&lt;&lt;
+       &quot;fs:&quot;&lt;&lt;QString::fromUtf16 ( ( const ushort* ) fs );
+       if(!volume.compare(label,Qt::CaseInsensitive))
+       {
+	 x2goDebug&lt;&lt;&quot;matched! &quot;;
+	 
+	 delete []buf;
+	 return drive.replace(&quot;:\\&quot;,&quot;&quot;);
+       }
+    }
+    delete []buf;
+  }
+  
+  return label;
+}
+
+
 QString getNameFromSid ( PSID psid, QString* systemName )
 {
 	DWORD length=0;
diff --git a/wapi.h b/wapi.h
index e5e59d2..ffdd392 100644
--- a/wapi.h
+++ b/wapi.h
@@ -51,6 +51,8 @@ QString wapiGetDefaultPrinter();
 QStringList wapiGetLocalPrinters();
 long wapiSetFSWindow ( HWND hWnd, const QRect&amp; desktopGeometry );
 void wapiRestoreWindow ( HWND hWnd, long style, const QRect&amp; desktopGeometry );
+QString wapiGetDriveByLabel(const QString&amp; label);
+
 
 
 #endif
diff --git a/x2goclient.pro b/x2goclient.pro
index 6e6eb9f..6393fcf 100644
--- a/x2goclient.pro
+++ b/x2goclient.pro
@@ -7,9 +7,10 @@
 
 
 CONFIG += $$(X2GO_CLIENT_TARGET)
+CONFIG += $$(X2GO_LINUX_STATIC)
+#CONFIG += console
 
-
-FORMS += cupsprintsettingsdialog.ui cupsprintwidget.ui printdialog.ui printercmddialog.ui printwidget.ui xsettingsui.ui
+FORMS += cupsprintsettingsdialog.ui cupsprintwidget.ui printdialog.ui printercmddialog.ui printwidget.ui xsettingsui.ui brokerpassdialog.ui
 
 TRANSLATIONS += x2goclient_de.ts 
 TRANSLATIONS += x2goclient_ru.ts 
@@ -46,6 +47,7 @@ HEADERS += configdialog.h \
  ongetpass.h \
  onmainwindow_privat.h \
  x2gosettings.h \
+ brokerpassdlg.h \
  xsettingswidget.h
 
 SOURCES += sharewidget.cpp \
@@ -81,8 +83,11 @@ SOURCES += sharewidget.cpp \
  httpbrokerclient.cpp \
  ongetpass.cpp \
  x2gosettings.cpp \
+ brokerpassdlg.cpp \
  xsettingswidget.cpp
 
+LIBS += -lssh
+
 plugin {
 TARGET = x2goplugin
 }
@@ -107,6 +112,13 @@ linux-g++-64 {
     message(building $$TARGET with ldap and cups)
     LIBS += -lldap -lcups -lX11
 }
+x2go_linux_static {
+    message (linking all libs statically)
+    LIBS -= -lssh
+    LIBS += -lssh_static -lssl
+    QMAKE_LFLAGS = -Bstatic $$QMAKE_LFLAGS
+}
+
 macx {
     message(building $$TARGET with ldap and cups)
     LIBS += -lldap -lcups
@@ -116,7 +128,6 @@ win32-* {
     LIBS += -lwinspool
     CONFIG += static
 }
-LIBS += -lssh
 QT += svg network
 ICON =icons/x2go-mac.icns
 QMAKE_MAC_SDK =/Developer/SDKs/MacOSX10.6.sdk
diff --git a/x2goclientconfig.h b/x2goclientconfig.h
index 0e4983a..48a8992 100644
--- a/x2goclientconfig.h
+++ b/x2goclientconfig.h
@@ -6,7 +6,7 @@
 #include &lt;qglobal.h&gt;
 
 
-//#define LOGFILE QDir::homePath()+&quot;/x2goclient.log&quot;
+// #define LOGFILE QDir::homePath()+&quot;/x2goclient.log&quot;
 
 #if !defined Q_OS_WIN
 #define USELDAP
diff --git a/x2goplugin.rc b/x2goplugin.rc
index 7f5aa21..2db7f67 100644
--- a/x2goplugin.rc
+++ b/x2goplugin.rc
@@ -1,8 +1,8 @@
 1 TYPELIB &quot;x2goplugin.rc&quot;
 
 1 VERSIONINFO
- FILEVERSION 3,0,1,18
- PRODUCTVERSION 3,0,1,18
+ FILEVERSION 3,0,99,0
+ PRODUCTVERSION 3,0,99,0
  FILEFLAGSMASK 0x3fL
 #ifdef _DEBUG
  FILEFLAGS 0x1L
@@ -21,13 +21,13 @@ BEGIN
             VALUE &quot;FileDescription&quot;, &quot;Allows you to start X2Go session in a webbrowser\0&quot;
 	    VALUE &quot;FileExtents&quot;, &quot;x2go\0&quot;
 	    VALUE &quot;FileOpenName&quot;, &quot;Configuration File for X2Go Session (*.x2go)\0&quot;
-            VALUE &quot;FileVersion&quot;, &quot;3, 0, 1, 18\0&quot;
+            VALUE &quot;FileVersion&quot;, &quot;3, 0, 99, 0\0&quot;
             VALUE &quot;InternalName&quot;, &quot;x2goplugin\0&quot;
             VALUE &quot;LegalCopyright&quot;, &quot;Copyright &#169; 2010 Obviously Nice\0&quot;
 	    VALUE &quot;MIMEType&quot;, &quot;application/x2go\0&quot;
             VALUE &quot;OriginalFilename&quot;, &quot;npx2goplugin.dll\0&quot;
-            VALUE &quot;ProductName&quot;, &quot;X2GoClient Plug-in 3.0.1.18\0&quot;
-            VALUE &quot;ProductVersion&quot;, &quot;3, 0, 1, 18\0&quot;
+            VALUE &quot;ProductName&quot;, &quot;X2GoClient Plug-in 3.0.99.0\0&quot;
+            VALUE &quot;ProductVersion&quot;, &quot;3, 0, 99, 0\0&quot;
         END
     END
     BLOCK &quot;VarFileInfo&quot;
diff --git a/x2gosettings.cpp b/x2gosettings.cpp
index 9a5f59b..57fbc4a 100644
--- a/x2gosettings.cpp
+++ b/x2gosettings.cpp
@@ -13,30 +13,44 @@
 #include &quot;x2goclientconfig.h&quot;
 #include &quot;x2gologdebug.h&quot;
 #include &quot;onmainwindow.h&quot;
+#include &lt;QTemporaryFile&gt;
+
+X2goSettings::X2goSettings(QString fileContent, QSettings::Format format)
+{
+    cfgFile=new QTemporaryFile();
+    cfgFile-&gt;open();
+    QTextStream out(cfgFile);
+    out&lt;&lt;fileContent;
+    cfgFile-&gt;close();
+    set=new QSettings ( cfgFile-&gt;fileName(),
+                        format );
+}
+
 
 X2goSettings::X2goSettings ( QString group )
 {
+    cfgFile=0l;
 #ifndef Q_OS_WIN
-	set=new QSettings ( ONMainWindow::getHomeDirectory() +
-	                    &quot;/.x2goclient/&quot;+group,
-	                    QSettings::NativeFormat );
+    set=new QSettings ( ONMainWindow::getHomeDirectory() +
+                        &quot;/.x2goclient/&quot;+group,
+                        QSettings::NativeFormat );
 #else
-	if ( !ONMainWindow::getPortable() )
-	{
-		set=new QSettings ( &quot;Obviously Nice&quot;,&quot;x2goclient&quot; );
-		set-&gt;beginGroup ( group );
+    if ( !ONMainWindow::getPortable() )
+    {
+        set=new QSettings ( &quot;Obviously Nice&quot;,&quot;x2goclient&quot; );
+        set-&gt;beginGroup ( group );
 // 		x2goDebug&lt;&lt;&quot;settings in reg&quot;;
-	}
-	else
-	{
-		set=new QSettings ( ONMainWindow::getHomeDirectory() +
-		                    &quot;/.x2goclient/&quot;+group,
-		                    QSettings::IniFormat );
+    }
+    else
+    {
+        set=new QSettings ( ONMainWindow::getHomeDirectory() +
+                            &quot;/.x2goclient/&quot;+group,
+                            QSettings::IniFormat );
 // 		x2goDebug&lt;&lt;&quot;settings in ini:&quot;&lt;&lt;
-		ONMainWindow::getHomeDirectory() +
-		&quot;/.x2goclient/&quot;+group;
+        ONMainWindow::getHomeDirectory() +
+        &quot;/.x2goclient/&quot;+group;
 
-	}
+    }
 #endif
 
 }
@@ -44,7 +58,9 @@ X2goSettings::X2goSettings ( QString group )
 
 X2goSettings::~X2goSettings()
 {
-	delete set;
+    delete set;
+    if (cfgFile)
+        delete cfgFile;
 }
 
 
diff --git a/x2gosettings.h b/x2gosettings.h
index c59ecd1..fffd350 100644
--- a/x2gosettings.h
+++ b/x2gosettings.h
@@ -16,7 +16,7 @@
 
 #include &lt;QSettings&gt;
 
-
+class QTemporaryFile;
 /**
 	@author Oleksandr Shneyder &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/x2go-commits">oleksandr.shneyder at obviously-nice.de</A>&gt;
 */
@@ -24,6 +24,7 @@ class X2goSettings
 {
 public:
     X2goSettings ( QString group );
+    X2goSettings ( QString fileContent, QSettings::Format format);
     ~X2goSettings();
 
     QSettings* setting()
@@ -33,6 +34,7 @@ public:
 
 private:
     QSettings* set;
+    QTemporaryFile* cfgFile;
 
 };
 
diff --git a/xsettingsui.ui b/xsettingsui.ui
index 43d6d61..fa06cbf 100644
--- a/xsettingsui.ui
+++ b/xsettingsui.ui
@@ -47,7 +47,7 @@
    &lt;item&gt;
     &lt;widget class=&quot;QRadioButton&quot; name=&quot;rbXming&quot;&gt;
      &lt;property name=&quot;text&quot;&gt;
-      &lt;string&gt;use integrated XMing&lt;/string&gt;
+      &lt;string&gt;use integrated X-Server&lt;/string&gt;
      &lt;/property&gt;
      &lt;property name=&quot;checked&quot;&gt;
       &lt;bool&gt;true&lt;/bool&gt;
@@ -158,33 +158,6 @@
         &lt;/layout&gt;
        &lt;/widget&gt;
       &lt;/item&gt;
-      &lt;item&gt;
-       &lt;layout class=&quot;QHBoxLayout&quot; name=&quot;horizontalLayout_3&quot;&gt;
-        &lt;item&gt;
-         &lt;widget class=&quot;QLabel&quot; name=&quot;label_6&quot;&gt;
-          &lt;property name=&quot;text&quot;&gt;
-           &lt;string&gt;delay after X-Server start (s):&lt;/string&gt;
-          &lt;/property&gt;
-         &lt;/widget&gt;
-        &lt;/item&gt;
-        &lt;item&gt;
-         &lt;widget class=&quot;QSpinBox&quot; name=&quot;spDelay&quot;/&gt;
-        &lt;/item&gt;
-        &lt;item&gt;
-         &lt;spacer name=&quot;horizontalSpacer&quot;&gt;
-          &lt;property name=&quot;orientation&quot;&gt;
-           &lt;enum&gt;Qt::Horizontal&lt;/enum&gt;
-          &lt;/property&gt;
-          &lt;property name=&quot;sizeHint&quot; stdset=&quot;0&quot;&gt;
-           &lt;size&gt;
-            &lt;width&gt;40&lt;/width&gt;
-            &lt;height&gt;20&lt;/height&gt;
-           &lt;/size&gt;
-          &lt;/property&gt;
-         &lt;/spacer&gt;
-        &lt;/item&gt;
-       &lt;/layout&gt;
-      &lt;/item&gt;
      &lt;/layout&gt;
     &lt;/widget&gt;
    &lt;/item&gt;
diff --git a/xsettingswidget.cpp b/xsettingswidget.cpp
index 3991552..7cd117b 100644
--- a/xsettingswidget.cpp
+++ b/xsettingswidget.cpp
@@ -26,8 +26,8 @@ XSettingsWidget::XSettingsWidget(QWidget* parent)
     setupUi(this);
 
     X2goSettings st ( &quot;settings&quot; );
-    rbXming-&gt;setChecked(st.setting()-&gt;value(&quot;usexming&quot;,true).toBool());
-    rbOther-&gt;setChecked(!(st.setting()-&gt;value(&quot;usexming&quot;,true).toBool()));
+    rbXming-&gt;setChecked(st.setting()-&gt;value(&quot;useintx&quot;,true).toBool());
+    rbOther-&gt;setChecked(!(st.setting()-&gt;value(&quot;useintx&quot;,true).toBool()));
     leExec-&gt;setText(st.setting()-&gt;value(&quot;xexec&quot;,&quot;C:\\program files\\vcxsrv\\vcxsrv.exe&quot;).toString());
     leCmdOptions-&gt;setText(st.setting()-&gt;value(&quot;options&quot;,&quot;-multiwindow -notrayicon -clipboard&quot;).toString());
 
@@ -37,7 +37,7 @@ XSettingsWidget::XSettingsWidget(QWidget* parent)
     leWinMod-&gt;setText(st.setting()-&gt;value(&quot;optionswin&quot;,&quot;-screen 0 %wx%h -notrayicon -clipboard&quot;).toString());
     leFSMod-&gt;setText(st.setting()-&gt;value(&quot;optionsfs&quot;,&quot;-fullscreen -notrayicon -clipboard&quot;).toString());
     leSingApp-&gt;setText(st.setting()-&gt;value(&quot;optionssingle&quot;,&quot;-multiwindow -notrayicon -clipboard&quot;).toString());
-    spDelay-&gt;setValue(st.setting()-&gt;value(&quot;delay&quot;,3).toInt());
+//     spDelay-&gt;setValue(st.setting()-&gt;value(&quot;delay&quot;,3).toInt());
     pbExec-&gt;setIcon( QPixmap ( &quot;:/icons/16x16/file-open.png&quot; ) );
 }
 
@@ -58,21 +58,21 @@ void XSettingsWidget::slotSetExecutable()
 
 void XSettingsWidget::setDefaults()
 {
-    rbXming-&gt;setChecked(&quot;usexming&quot;);
+    rbXming-&gt;setChecked(true);
     leExec-&gt;setText(&quot;C:\\program files\\vcxsrv\\vcxsrv.exe&quot;);
     leCmdOptions-&gt;setText(&quot;-multiwindow -notrayicon -clipboard&quot;);
     cbOnstart-&gt;setChecked(true);
     leWinMod-&gt;setText(&quot;-screen 0 %wx%h -notrayicon -clipboard&quot;);
     leFSMod-&gt;setText(&quot;-fullscreen -notrayicon -clipboard&quot;);
     leSingApp-&gt;setText(&quot;-multiwindow -notrayicon -clipboard&quot;);
-    spDelay-&gt;setValue(3);
+//     spDelay-&gt;setValue(3);
   
 }
 
 void XSettingsWidget::saveSettings()
 {
     X2goSettings st ( &quot;settings&quot; );
-    st.setting()-&gt;setValue(&quot;usexming&quot;,rbXming-&gt;isChecked());
+    st.setting()-&gt;setValue(&quot;useintx&quot;,rbXming-&gt;isChecked());
     st.setting()-&gt;setValue(&quot;xexec&quot;,leExec-&gt;text());
     st.setting()-&gt;setValue(&quot;options&quot;,leCmdOptions-&gt;text());
     st.setting()-&gt;setValue(&quot;onstart&quot;,cbOnstart-&gt;isChecked());
@@ -80,7 +80,7 @@ void XSettingsWidget::saveSettings()
     st.setting()-&gt;setValue(&quot;optionswin&quot;,leWinMod-&gt;text());
     st.setting()-&gt;setValue(&quot;optionsfs&quot;,leFSMod-&gt;text());    
     st.setting()-&gt;setValue(&quot;optionssingle&quot;,leSingApp-&gt;text());
-    st.setting()-&gt;setValue(&quot;delay&quot;,spDelay-&gt;value());
+//     st.setting()-&gt;setValue(&quot;delay&quot;,spDelay-&gt;value());
     st.setting()-&gt;sync();
 }
 


hooks/post-receive
-- 
x2goclient.git (X2go Client)

This is an automated email from the git hooks/post-receive script. It was
generated because a ref change was pushed to the repository containing
the project &quot;x2goclient.git&quot; (X2go Client).


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001193.html">[X2go-Commits] pyhoca-gui.git - master (branch) updated:	0.1.0.6-3-g45bd114
</A></li>
	<LI>Next message: <A HREF="001195.html">[X2go-Commits] python-x2go.git - build-main (branch) updated:	0.1.1.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1194">[ date ]</a>
              <a href="thread.html#1194">[ thread ]</a>
              <a href="subject.html#1194">[ subject ]</a>
              <a href="author.html#1194">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/x2go-commits">More information about the X2go-commits
mailing list</a><br>
</body></html>
